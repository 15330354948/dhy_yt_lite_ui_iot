define(["./AttributeCompression","./Cartesian2","./Cartesian3","./ComponentDatatype","./defaultValue","./defined","./Math","./Matrix4","./TerrainQuantization"],function(t,e,r,i,o,n,a,s,m){"use strict";var c=new r,u=new r,h=new e,d=new s,p=new s,l=Math.pow(2,12);function f(t,e,i,a,h,f){var x,y,T,N=m.NONE;if(n(t)&&n(e)&&n(i)&&n(a)){var g=t.minimum,v=t.maximum,S=r.subtract(v,g,u),B=i-e;N=Math.max(r.maximumComponent(S),B)<l-1?m.BITS12:m.NONE,x=t.center,y=s.inverseTransformation(a,new s);var E=r.negate(g,c);s.multiply(s.fromTranslation(E,d),y,y);var b=c;b.x=1/S.x,b.y=1/S.y,b.z=1/S.z,s.multiply(s.fromScale(b,d),y,y),T=s.clone(a),s.setTranslation(T,r.ZERO,T),a=s.clone(a,new s);var z=s.fromTranslation(g,d),C=s.fromScale(S,p),I=s.multiply(z,C,d);s.multiply(a,I,a),s.multiply(T,I,T)}this.quantization=N,this.minimumHeight=e,this.maximumHeight=i,this.center=x,this.toScaledENU=y,this.fromScaledENU=a,this.matrix=T,this.hasVertexNormals=h,this.hasWebMercatorT=o(f,!1)}f.prototype.encode=function(i,o,n,u,d,p,l){var f=u.x,x=u.y;if(this.quantization===m.BITS12){(n=s.multiplyByPoint(this.toScaledENU,n,c)).x=a.clamp(n.x,0,1),n.y=a.clamp(n.y,0,1),n.z=a.clamp(n.z,0,1);var y=this.maximumHeight-this.minimumHeight,T=a.clamp((d-this.minimumHeight)/y,0,1);e.fromElements(n.x,n.y,h);var N=t.compressTextureCoordinates(h);e.fromElements(n.z,T,h);var g=t.compressTextureCoordinates(h);e.fromElements(f,x,h);var v=t.compressTextureCoordinates(h);if(i[o++]=N,i[o++]=g,i[o++]=v,this.hasWebMercatorT){e.fromElements(l,0,h);var S=t.compressTextureCoordinates(h);i[o++]=S}}else r.subtract(n,this.center,c),i[o++]=c.x,i[o++]=c.y,i[o++]=c.z,i[o++]=d,i[o++]=f,i[o++]=x,this.hasWebMercatorT&&(i[o++]=l);return this.hasVertexNormals&&(i[o++]=t.octPackFloat(p)),o},f.prototype.decodePosition=function(e,i,o){if(n(o)||(o=new r),i*=this.getStride(),this.quantization===m.BITS12){var a=t.decompressTextureCoordinates(e[i],h);o.x=a.x,o.y=a.y;var c=t.decompressTextureCoordinates(e[i+1],h);return o.z=c.x,s.multiplyByPoint(this.fromScaledENU,o,o)}return o.x=e[i],o.y=e[i+1],o.z=e[i+2],r.add(o,this.center,o)},f.prototype.decodeTextureCoordinates=function(r,i,o){return n(o)||(o=new e),i*=this.getStride(),this.quantization===m.BITS12?t.decompressTextureCoordinates(r[i+2],o):e.fromElements(r[i+4],r[i+5],o)},f.prototype.decodeHeight=function(e,r){return r*=this.getStride(),this.quantization===m.BITS12?t.decompressTextureCoordinates(e[r+1],h).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:e[r+3]},f.prototype.decodeWebMercatorT=function(e,r){return r*=this.getStride(),this.quantization===m.BITS12?t.decompressTextureCoordinates(e[r+3],h).x:e[r+6]},f.prototype.getOctEncodedNormal=function(t,r,i){var o=t[r=(r+1)*this.getStride()-1]/256,n=Math.floor(o),a=256*(o-n);return e.fromElements(n,a,i)},f.prototype.getStride=function(){var t;switch(this.quantization){case m.BITS12:t=3;break;default:t=6}return this.hasWebMercatorT&&++t,this.hasVertexNormals&&++t,t};var x={position3DAndHeight:0,textureCoordAndEncodedNormals:1},y={compressed0:0,compressed1:1};return f.prototype.getAttributes=function(t){var e,r=i.FLOAT,o=i.getSizeInBytes(r);if(this.quantization===m.NONE){var n=2;return this.hasWebMercatorT&&++n,this.hasVertexNormals&&++n,[{index:x.position3DAndHeight,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:4,offsetInBytes:0,strideInBytes:e=(4+n)*o},{index:x.textureCoordAndEncodedNormals,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:n,offsetInBytes:4*o,strideInBytes:e}]}var a=3,s=0;return(this.hasWebMercatorT||this.hasVertexNormals)&&++a,this.hasWebMercatorT&&this.hasVertexNormals?[{index:y.compressed0,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:a,offsetInBytes:0,strideInBytes:e=(a+ ++s)*o},{index:y.compressed1,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:s,offsetInBytes:a*o,strideInBytes:e}]:[{index:y.compressed0,vertexBuffer:t,componentDatatype:r,componentsPerAttribute:a}]},f.prototype.getAttributeLocations=function(){return this.quantization===m.NONE?x:y},f.clone=function(t,e){return n(e)||(e=new f),e.quantization=t.quantization,e.minimumHeight=t.minimumHeight,e.maximumHeight=t.maximumHeight,e.center=r.clone(t.center),e.toScaledENU=s.clone(t.toScaledENU),e.fromScaledENU=s.clone(t.fromScaledENU),e.matrix=s.clone(t.matrix),e.hasVertexNormals=t.hasVertexNormals,e.hasWebMercatorT=t.hasWebMercatorT,e},f});