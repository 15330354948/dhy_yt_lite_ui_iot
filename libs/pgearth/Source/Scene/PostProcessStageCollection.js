define(["../Core/arraySlice","../Core/Check","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/PixelFormat","../Renderer/PixelDatatype","../Renderer/Sampler","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","../Shaders/PostProcessStages/PassThrough","./PostProcessStageLibrary","./PostProcessStageTextureCache","./Tonemapper"],function(e,t,a,r,i,o,n,s,h,u,p,d,_,l,g,c,f,m){"use strict";var v=[];function x(){var e=c.createFXAAStage(),t=c.createAmbientOcclusionStage(),a=c.createBloomStage();this._autoExposureEnabled=!1,this._autoExposure=c.createAutoExposureStage(),this._tonemapping=void 0,this._tonemapper=void 0,this.tonemapper=m.ACES;var i=this._tonemapping;t.enabled=!1,a.enabled=!1,i.enabled=!1;var o=new f(this),n={},s=v;for(s.push(e,t,a,i);s.length>0;){var h=s.pop();n[h.name]=h,h._textureCache=o;var u=h.length;if(r(u))for(var p=0;p<u;++p)s.push(h.get(p))}this._stages=[],this._activeStages=[],this._previousActiveStages=[],this._randomTexture=void 0;var d=this;t.uniforms.randomTexture=function(){return d._randomTexture},this._ao=t,this._bloom=a,this._fxaa=e,this._lastLength=void 0,this._aoEnabled=void 0,this._bloomEnabled=void 0,this._tonemappingEnabled=void 0,this._fxaaEnabled=void 0,this._stagesRemoved=!1,this._textureCacheDirty=!1,this._stageNames=n,this._textureCache=o}function y(e){if(e._stagesRemoved){e._stagesRemoved=!1;for(var t=[],a=e._stages,r=a.length,i=0,o=0;i<r;++i){var n=a[i];n&&(n._index=o++,t.push(n))}e._stages=t}}function b(e){for(;r(e.length);)e=e.get(e.length-1);return e.outputTexture}function E(e,t,a,i,o){if(r(e.execute))e.execute(t,a,i,o);else{var n,s=e.length;if(e.inputPreviousStageTexture)for(E(e.get(0),t,a,i,o),n=1;n<s;++n)E(e.get(n),t,b(e.get(n-1)),i,o);else for(n=0;n<s;++n)E(e.get(n),t,a,i,o)}}return i(x.prototype,{ready:{get:function(){for(var e=!1,t=this._stages,a=t.length-1;a>=0;--a){var r=t[a];e=e||r.ready&&r.enabled}var i=this._fxaa,o=this._ao,n=this._bloom,s=this._tonemapping;return e=(e=(e=(e=e||i.ready&&i.enabled)||o.ready&&o.enabled)||n.ready&&n.enabled)||s.ready&&s.enabled}},fxaa:{get:function(){return this._fxaa}},ambientOcclusion:{get:function(){return this._ao}},bloom:{get:function(){return this._bloom}},length:{get:function(){return y(this),this._stages.length}},outputTexture:{get:function(){var e=this._fxaa;if(e.enabled&&e.ready)return this.getOutputTexture(e.name);for(var t=this._stages,a=t.length-1;a>=0;--a){var i=t[a];if(r(i)&&i.ready&&i.enabled)return this.getOutputTexture(i.name)}var o=this._tonemapping;if(o.enabled&&o.ready)return this.getOutputTexture(o.name);var n=this._bloom;if(n.enabled&&n.ready)return this.getOutputTexture(n.name);var s=this._ao;return s.enabled&&s.ready?this.getOutputTexture(s.name):void 0}},hasSelected:{get:function(){for(var t=e(this._stages);t.length>0;){var a=t.pop();if(r(a)){if(r(a.selected))return!0;var i=a.length;if(r(i))for(var o=0;o<i;++o)t.push(a.get(o))}}return!1}},tonemapper:{get:function(){return this._tonemapper},set:function(e){if(this._tonemapper!==e){if(!m.validate(e))throw new n("tonemapper was set to an invalid value.");r(this._tonemapping)&&(delete this._stageNames[this._tonemapping.name],this._tonemapping.destroy());var t,a=this._autoExposureEnabled;switch(e){case m.REINHARD:t=c.createReinhardTonemappingStage(a);break;case m.MODIFIED_REINHARD:t=c.createModifiedReinhardTonemappingStage(a);break;case m.FILMIC:t=c.createFilmicTonemappingStage(a);break;default:t=c.createAcesTonemappingStage(a)}if(a){var i=this._autoExposure;t.uniforms.autoExposure=function(){return i.outputTexture}}this._tonemapper=e,this._tonemapping=t,r(this._stageNames)&&(this._stageNames[t.name]=t,t._textureCache=this._textureCache),this._textureCacheDirty=!0}}}}),x.prototype.add=function(e){t.typeOf.object("stage",e);var a=this._stageNames,i=v;for(i.push(e);i.length>0;){var o=i.pop();if(r(a[o.name]))throw new n(o.name+" has already been added to the collection or does not have a unique name.");a[o.name]=o,o._textureCache=this._textureCache;var s=o.length;if(r(s))for(var h=0;h<s;++h)i.push(o.get(h))}var u=this._stages;return e._index=u.length,u.push(e),this._textureCacheDirty=!0,e},x.prototype.remove=function(e){if(!this.contains(e))return!1;var t=this._stageNames,a=v;for(a.push(e);a.length>0;){var i=a.pop();delete t[i.name];var o=i.length;if(r(o))for(var n=0;n<o;++n)a.push(i.get(n))}return this._stages[e._index]=void 0,this._stagesRemoved=!0,this._textureCacheDirty=!0,e._index=void 0,e._textureCache=void 0,e.destroy(),!0},x.prototype.contains=function(e){return r(e)&&r(e._index)&&e._textureCache===this._textureCache},x.prototype.get=function(e){y(this);var a=this._stages,r=a.length;return t.typeOf.number.greaterThanOrEquals("stages length",r,0),t.typeOf.number.greaterThanOrEquals("index",e,0),t.typeOf.number.lessThan("index",e,r),a[e]},x.prototype.removeAll=function(){for(var e=this._stages,t=e.length,a=0;a<t;++a)this.remove(e[a]);e.length=0},x.prototype.getStageByName=function(e){return this._stageNames[e]},x.prototype.update=function(e,t,a){y(this);var i=this._activeStages,o=this._activeStages=this._previousActiveStages;this._previousActiveStages=i;var n,g,c=this._stages,f=o.length=c.length,m=0;for(n=0;n<f;++n)(g=c[n]).ready&&g.enabled&&g._isSupported(e)&&(o[m++]=g);o.length=m;var v=m!==i.length;if(!v)for(n=0;n<m;++n)if(o[n]!==i[n]){v=!0;break}var x=this._ao,b=this._bloom,E=this._autoExposure,C=this._tonemapping,T=this._fxaa;C.enabled=a;var S=x.enabled&&x._isSupported(e),R=b.enabled&&b._isSupported(e),A=C.enabled&&C._isSupported(e),w=T.enabled&&T._isSupported(e);if((v||this._textureCacheDirty||m!==this._lastLength||S!==this._aoEnabled||R!==this._bloomEnabled||A!==this._tonemappingEnabled||w!==this._fxaaEnabled)&&(this._textureCache.updateDependencies(),this._lastLength=m,this._aoEnabled=S,this._bloomEnabled=R,this._tonemappingEnabled=A,this._fxaaEnabled=w,this._textureCacheDirty=!1),r(this._randomTexture)&&!S&&(this._randomTexture.destroy(),this._randomTexture=void 0),!r(this._randomTexture)&&S){f=196608;var D=new Uint8Array(f);for(n=0;n<f;n+=3)D[n]=Math.floor(255*Math.random());this._randomTexture=new p({context:e,pixelFormat:s.RGB,pixelDatatype:h.UNSIGNED_BYTE,source:{arrayBufferView:D,width:256,height:256},sampler:new u({wrapS:l.REPEAT,wrapT:l.REPEAT,minificationFilter:_.NEAREST,magnificationFilter:d.NEAREST})})}for(this._textureCache.update(e),T.update(e,t),x.update(e,t),b.update(e,t),C.update(e,t),this._autoExposureEnabled&&E.update(e,t),f=c.length,n=0;n<f;++n)c[n].update(e,t)},x.prototype.clear=function(e){this._textureCache.clear(e),this._autoExposureEnabled&&this._autoExposure.clear(e)},x.prototype.getOutputTexture=function(e){var t=this.getStageByName(e);if(r(t))return b(t)},x.prototype.execute=function(e,t,a,r){var i=this._activeStages,o=i.length,n=this._fxaa,s=this._ao,h=this._bloom,u=this._autoExposure,p=this._tonemapping,d=s.enabled&&s._isSupported(e),_=h.enabled&&h._isSupported(e),l=this._autoExposureEnabled,g=p.enabled&&p._isSupported(e),c=n.enabled&&n._isSupported(e);if(c||d||_||g||0!==o){var f=t;d&&s.ready&&(E(s,e,f,a,r),f=b(s)),_&&h.ready&&(E(h,e,f,a,r),f=b(h)),l&&u.ready&&E(u,e,f,a,r),g&&p.ready&&(E(p,e,f,a,r),f=b(p));var m=f;if(o>0){E(i[0],e,f,a,r);for(var v=1;v<o;++v)E(i[v],e,b(i[v-1]),a,r);m=b(i[o-1])}c&&n.ready&&E(n,e,m,a,r)}},x.prototype.copy=function(e,t){if(!r(this._copyColorCommand)){var a=this;this._copyColorCommand=e.createViewportQuadCommand(g,{uniformMap:{colorTexture:function(){return a.outputTexture}},owner:this})}this._copyColorCommand.framebuffer=t,this._copyColorCommand.execute(e)},x.prototype.isDestroyed=function(){return!1},x.prototype.destroy=function(){return this._fxaa.destroy(),this._ao.destroy(),this._bloom.destroy(),this._autoExposure.destroy(),this._tonemapping.destroy(),this.removeAll(),this._textureCache=this._textureCache&&this._textureCache.destroy(),o(this)},x});