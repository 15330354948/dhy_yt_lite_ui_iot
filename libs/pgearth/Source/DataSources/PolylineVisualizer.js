define(["../Core/AssociativeArray","../Core/BoundingSphere","../Core/Check","../Core/defaultValue","../Core/defined","../Core/destroyObject","../Scene/ClassificationType","../Scene/PolylineColorAppearance","../Scene/PolylineMaterialAppearance","../Scene/ShadowMode","./BoundingSphereState","./ColorMaterialProperty","./DynamicGeometryBatch","./PolylineGeometryUpdater","./StaticGeometryColorBatch","./StaticGeometryPerMaterialBatch","./StaticGroundPolylinePerMaterialBatch"],function(e,t,i,r,s,o,n,a,h,c,l,d,_,u,p,v,y){"use strict";var g=[];function m(e,t){for(var i=e._batches,r=i.length,s=0;s<r;s++)i[s].remove(t)}function f(e,t,i){if(i.isDynamic)e._dynamicBatch.add(t,i);else if(i.clampToGround&&i.fillEnabled){var r=i.classificationTypeProperty.getValue(t);e._groundBatches[r].add(t,i)}else{var o;i.fillEnabled&&(o=i.shadowsProperty.getValue(t));var n,a=0;s(i.depthFailMaterialProperty)&&(a=i.depthFailMaterialProperty instanceof d?1:2),s(o)&&(n=o+a*c.NUMBER_OF_SHADOW_MODES),i.fillEnabled&&(i.fillMaterialProperty instanceof d?e._colorBatches[n].add(t,i):e._materialBatches[n].add(t,i))}}function B(t,s,o,l){var d;i.defined("scene",t),i.defined("entityCollection",s),l=r(l,t.groundPrimitives),o=r(o,t.primitives),this._scene=t,this._primitives=o,this._entityCollection=void 0,this._addedObjects=new e,this._removedObjects=new e,this._changedObjects=new e;var u=c.NUMBER_OF_SHADOW_MODES;for(this._colorBatches=new Array(3*u),this._materialBatches=new Array(3*u),d=0;d<u;++d)this._colorBatches[d]=new p(o,a,void 0,!1,d),this._materialBatches[d]=new v(o,h,void 0,!1,d),this._colorBatches[d+u]=new p(o,a,a,!1,d),this._materialBatches[d+u]=new v(o,h,a,!1,d),this._colorBatches[d+2*u]=new p(o,a,h,!1,d),this._materialBatches[d+2*u]=new v(o,h,h,!1,d);this._dynamicBatch=new _(o,l);var m=n.NUMBER_OF_CLASSIFICATION_TYPES;for(this._groundBatches=new Array(m),d=0;d<m;++d)this._groundBatches[d]=new y(l,d);this._batches=this._colorBatches.concat(this._materialBatches,this._dynamicBatch,this._groundBatches),this._subscriptions=new e,this._updaters=new e,this._entityCollection=s,s.collectionChanged.addEventListener(B.prototype._onCollectionChanged,this),this._onCollectionChanged(s,s.values,g)}B.prototype.update=function(e){i.defined("time",e);var t,r,s,o,n=this._addedObjects,a=n.values,h=this._removedObjects,c=h.values,l=this._changedObjects,d=l.values;for(t=d.length-1;t>-1;t--)s=(r=d[t]).id,(o=this._updaters.get(s)).entity===r?(m(this,o),f(this,e,o)):(c.push(r),a.push(r));for(t=c.length-1;t>-1;t--)s=(r=c[t]).id,m(this,o=this._updaters.get(s)),o.destroy(),this._updaters.remove(s),this._subscriptions.get(s)(),this._subscriptions.remove(s);for(t=a.length-1;t>-1;t--)s=(r=a[t]).id,o=new u(r,this._scene),this._updaters.set(s,o),f(this,e,o),this._subscriptions.set(s,o.geometryChanged.addEventListener(B._onGeometryChanged,this));n.removeAll(),h.removeAll(),l.removeAll();var _=!0,p=this._batches,v=p.length;for(t=0;t<v;t++)_=p[t].update(e)&&_;return _};var C=[],b=new t;return B.prototype.getBoundingSphere=function(e,r){i.defined("entity",e),i.defined("result",r);for(var s=C,o=b,n=0,a=l.DONE,h=this._batches,c=h.length,d=this._updaters.get(e.id),_=0;_<c;_++){if((a=h[_].getBoundingSphere(d,o))===l.PENDING)return l.PENDING;a===l.DONE&&(s[n]=t.clone(o,s[n]),n++)}return 0===n?l.FAILED:(s.length=n,t.fromBoundingSpheres(s,r),l.DONE)},B.prototype.isDestroyed=function(){return!1},B.prototype.destroy=function(){var e;this._entityCollection.collectionChanged.removeEventListener(B.prototype._onCollectionChanged,this),this._addedObjects.removeAll(),this._removedObjects.removeAll();var t=this._batches,i=t.length;for(e=0;e<i;e++)t[e].removeAllPrimitives();var r=this._subscriptions.values;for(i=r.length,e=0;e<i;e++)r[e]();return this._subscriptions.removeAll(),o(this)},B._onGeometryChanged=function(e){var t=this._removedObjects,i=this._changedObjects,r=e.entity,o=r.id;s(t.get(o))||s(i.get(o))||i.set(o,r)},B.prototype._onCollectionChanged=function(e,t,i){var r,s,o,n=this._addedObjects,a=this._removedObjects,h=this._changedObjects;for(r=i.length-1;r>-1;r--)s=(o=i[r]).id,n.remove(s)||(a.set(s,o),h.remove(s));for(r=t.length-1;r>-1;r--)s=(o=t[r]).id,a.remove(s)?h.set(s,o):n.set(s,o)},B});