define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/Color","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Matrix4","../Core/writeTextToCanvas","./BillboardCollection","./BlendOption","./HeightReference","./HorizontalOrigin","./Label","./LabelStyle","./TextureAtlas","./VerticalOrigin"],function(e,t,i,l,o,n,a,r,s,h,d,c,_,b,u,g,f,p){"use strict";function x(){this.textureInfo=void 0,this.dimensions=void 0,this.billboard=void 0}function y(e,t,i){this.labelCollection=e,this.index=t,this.dimensions=i}var v=1.2,C="ID_WHITE_PIXEL",T=new t(4,4),m=new e(1,1,1,1);var B={};function O(e,t,i,l,o,n,a){return B.font=t,B.fillColor=i,B.strokeColor=l,B.strokeWidth=o,a===p.CENTER?B.textBaseline="middle":a===p.TOP?B.textBaseline="top":B.textBaseline="bottom",B.fill=n===g.FILL||n===g.FILL_AND_OUTLINE,B.stroke=n===g.OUTLINE||n===g.FILL_AND_OUTLINE,h(e,B)}function A(e,t){t.textureInfo=void 0,t.dimensions=void 0;var i=t.billboard;o(i)&&(i.show=!1,i.image=void 0,o(i._removeCallbackFunc)&&(i._removeCallbackFunc(),i._removeCallbackFunc=void 0),e._spareBillboards.push(i),t.billboard=void 0)}function w(e,t,i,l){e.addImage(t,i).then(function(e){l.index=e})}function D(e,i){var l,n,a,r=i._renderedText,s=r.length,h=i._glyphs,d=h.length;if(s<d)for(n=s;n<d;++n)A(e,h[n]);h.length=s;var c=i._showBackground&&r.split("\n").join("").length>0,_=i._backgroundBillboard,u=e._backgroundBillboardCollection;c?(o(_)||(_=u.add({collection:e,image:C,imageSubRegion:m}),i._backgroundBillboard=_),_.color=i._backgroundColor,_.show=i._show,_.position=i._position,_.eyeOffset=i._eyeOffset,_.pixelOffset=i._pixelOffset,_.horizontalOrigin=b.LEFT,_.verticalOrigin=i._verticalOrigin,_.heightReference=i._heightReference,_.scale=i._scale,_.pickPrimitive=i,_.id=i._id,_.translucencyByDistance=i._translucencyByDistance,_.pixelOffsetScaleByDistance=i._pixelOffsetScaleByDistance,_.scaleByDistance=i._scaleByDistance,_.distanceDisplayCondition=i._distanceDisplayCondition,_.disableDepthTestDistance=i._disableDepthTestDistance):o(_)&&(u.remove(_),i._backgroundBillboard=_=void 0);var g=e._glyphTextureCache;for(a=0;a<s;++a){var f=r.charAt(a),p=i._font,v=i._fillColor,T=i._outlineColor,B=i._outlineWidth,D=i._style,k=i._verticalOrigin,E=JSON.stringify([f,p,v.toRgba(),T.toRgba(),B,+D,+k]),I=g[E];if(!o(I)){var N=O(f,p,v,T,B,D,k);I=new y(e,-1,N.dimensions),g[E]=I,N.width>0&&N.height>0&&w(e._textureAtlas,E,N,I)}if(l=h[a],o(l)?-1===I.index?A(e,l):o(l.textureInfo)&&(l.textureInfo=void 0):(l=new x,h[a]=l),l.textureInfo=I,l.dimensions=I.dimensions,-1!==I.index){var S=l.billboard,R=e._spareBillboards;o(S)||(R.length>0?S=R.pop():((S=e._billboardCollection.add({collection:e}))._labelDimensions=new t,S._labelTranslate=new t),l.billboard=S),S.show=i._show,S.position=i._position,S.eyeOffset=i._eyeOffset,S.pixelOffset=i._pixelOffset,S.horizontalOrigin=b.LEFT,S.verticalOrigin=i._verticalOrigin,S.heightReference=i._heightReference,S.scale=i._scale,S.pickPrimitive=i,S.id=i._id,S.image=E,S.translucencyByDistance=i._translucencyByDistance,S.pixelOffsetScaleByDistance=i._pixelOffsetScaleByDistance,S.scaleByDistance=i._scaleByDistance,S.distanceDisplayCondition=i._distanceDisplayCondition,S.disableDepthTestDistance=i._disableDepthTestDistance,S._batchIndex=i._batchIndex}}i._repositionAllGlyphs=!0}function k(e,t,i){return t===b.CENTER?-e/2:t===b.RIGHT?-(e+i.x):i.x}var E=new t,I=new t;function N(e,i){var l,n,a,r=e._glyphs,s=e._renderedText,h=0,d=0,c=[],u=Number.NEGATIVE_INFINITY,g=0,f=1,x=r.length,y=e._backgroundBillboard,C=t.clone(o(y)?e._backgroundPadding:t.ZERO,I);for(a=0;a<x;++a)"\n"===s.charAt(a)?(c.push(h),++f,h=0):(n=(l=r[a]).dimensions,g=Math.max(g,n.height-n.descent),u=Math.max(u,n.descent),h+=n.width-n.bounds.minx,a<x-1&&(h+=r[a+1].dimensions.bounds.minx),d=Math.max(d,h));c.push(h);var T=g+u,m=e._scale,B=e._horizontalOrigin,O=e._verticalOrigin,A=0,w=c[A],D=k(w,B,C),N=v*T,S=N*(f-1),R=d,L=T+S;o(y)&&(R+=2*C.x,L+=2*C.y,y._labelHorizontalOrigin=B),E.x=D*m*i,E.y=0;var P=0;for(a=0;a<x;++a)if("\n"===s.charAt(a))P+=N,D=k(w=c[++A],B,C),E.x=D*m*i;else if(n=(l=r[a]).dimensions,O===p.TOP?E.y=n.height-g-C.y:O===p.CENTER?E.y=(S+n.height-g)/2:O===p.BASELINE?E.y=S:E.y=S+u+C.y,E.y=(E.y-n.descent-P)*m*i,o(l.billboard)&&(l.billboard._setTranslate(E),l.billboard._labelDimensions.x=R,l.billboard._labelDimensions.y=L,l.billboard._labelHorizontalOrigin=B),a<x-1){var M=r[a+1];E.x+=(n.width-n.bounds.minx+M.dimensions.bounds.minx)*m*i}if(o(y)&&s.split("\n").join("").length>0&&(D=B===b.CENTER?-d/2-C.x:B===b.RIGHT?-(d+2*C.x):0,E.x=D*m*i,O===p.TOP?E.y=T-g-u:O===p.CENTER?E.y=(T-g)/2-u:O===p.BASELINE?E.y=-C.y-u:E.y=0,E.y=E.y*m*i,y.width=R,y.height=L,y._setTranslate(E),y._labelTranslate=t.clone(E,y._labelTranslate)),e.heightReference===_.CLAMP_TO_GROUND)for(a=0;a<x;++a){var F=(l=r[a]).billboard;o(F)&&(F._labelTranslate=t.clone(E,F._labelTranslate))}}function S(e,t){for(var i=t._glyphs,l=0,n=i.length;l<n;++l)A(e,i[l]);o(t._backgroundBillboard)&&(e._backgroundBillboardCollection.remove(t._backgroundBillboard),t._backgroundBillboard=void 0),t._labelCollection=void 0,o(t._removeCallbackFunc)&&t._removeCallbackFunc(),a(t)}function R(e){e=l(e,l.EMPTY_OBJECT),this._scene=e.scene,this._batchTable=e.batchTable,this._textureAtlas=void 0,this._backgroundTextureAtlas=void 0,this._whitePixelIndex=void 0,this._backgroundBillboardCollection=new d({scene:this._scene}),this._backgroundBillboardCollection.destroyTextureAtlas=!1,this._billboardCollection=new d({scene:this._scene,batchTable:this._batchTable}),this._billboardCollection.destroyTextureAtlas=!1,this._spareBillboards=[],this._glyphTextureCache={},this._labels=[],this._labelsToUpdate=[],this._totalGlyphCount=0,this._resolutionScale=void 0,this._highlightColor=i.clone(i.WHITE),this.modelMatrix=s.clone(l(e.modelMatrix,s.IDENTITY)),this.debugShowBoundingVolume=l(e.debugShowBoundingVolume,!1),this.blendOption=l(e.blendOption,c.OPAQUE_AND_TRANSLUCENT)}return n(R.prototype,{length:{get:function(){return this._labels.length}}}),R.prototype.add=function(e){var t=new u(e,this);return this._labels.push(t),this._labelsToUpdate.push(t),t},R.prototype.remove=function(e){if(o(e)&&e._labelCollection===this){var t=this._labels.indexOf(e);if(-1!==t)return this._labels.splice(t,1),S(this,e),!0}return!1},R.prototype.removeAll=function(){for(var e=this._labels,t=0,i=e.length;t<i;++t)S(this,e[t]);e.length=0},R.prototype.contains=function(e){return o(e)&&e._labelCollection===this},R.prototype.get=function(e){if(!o(e))throw new r("index is required.");return this._labels[e]},R.prototype.update=function(e){var t=this._billboardCollection,i=this._backgroundBillboardCollection;t.modelMatrix=this.modelMatrix,t.debugShowBoundingVolume=this.debugShowBoundingVolume,i.modelMatrix=this.modelMatrix,i.debugShowBoundingVolume=this.debugShowBoundingVolume;var l=e.context;o(this._textureAtlas)||(this._textureAtlas=new f({context:l}),t.textureAtlas=this._textureAtlas),o(this._backgroundTextureAtlas)||(this._backgroundTextureAtlas=new f({context:l,initialSize:T}),i.textureAtlas=this._backgroundTextureAtlas,function(e,t){var i=document.createElement("canvas");i.width=T.x,i.height=T.y;var l=i.getContext("2d");l.fillStyle="#fff",l.fillRect(0,0,i.width,i.height),e.addImage(C,i).then(function(e){t._whitePixelIndex=e})}(this._backgroundTextureAtlas,this));var n,a=l.uniformState.resolutionScale,r=this._resolutionScale!==a;this._resolutionScale=a;for(var s=(n=r?this._labels:this._labelsToUpdate).length,h=0;h<s;++h){var d=n[h];if(!d.isDestroyed()){var _=d._glyphs.length;d._rebindAllGlyphs&&(D(this,d),d._rebindAllGlyphs=!1),(r||d._repositionAllGlyphs)&&(N(d,a),d._repositionAllGlyphs=!1);var b=d._glyphs.length-_;this._totalGlyphCount+=b}}var u=i.length>0?c.TRANSLUCENT:this.blendOption;t.blendOption=u,i.blendOption=u,t._highlightColor=this._highlightColor,i._highlightColor=this._highlightColor,this._labelsToUpdate.length=0,i.update(e),t.update(e)},R.prototype.isDestroyed=function(){return!1},R.prototype.destroy=function(){return this.removeAll(),this._billboardCollection=this._billboardCollection.destroy(),this._textureAtlas=this._textureAtlas&&this._textureAtlas.destroy(),this._backgroundBillboardCollection=this._backgroundBillboardCollection.destroy(),this._backgroundTextureAtlas=this._backgroundTextureAtlas&&this._backgroundTextureAtlas.destroy(),a(this)},R});