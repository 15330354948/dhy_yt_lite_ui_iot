define(["../Core/Check","../Core/clone","../Core/Color","../Core/ComponentDatatype","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Geometry","../Core/GeometryAttribute","../Core/Matrix4","../Core/PixelFormat","../Core/PrimitiveType","../Core/RuntimeError","../Core/WebGLConstants","../Shaders/ViewportQuadVS","./BufferUsage","./ClearCommand","./ContextLimits","./CubeMap","./DrawCommand","./PassState","./PixelDatatype","./RenderState","./ShaderCache","./ShaderProgram","./Texture","./TextureCache","./UniformState","./VertexArray"],function(e,t,r,a,i,n,o,s,u,_,h,f,c,d,l,m,g,p,x,E,b,T,A,w,v,C,y,F,S,I,B,O){"use strict";function R(e,t,r){var a=e.getError();if(a!==e.NO_ERROR)throw new m(function(e,t,r,a){for(var i=function(e,t){var r="WebGL Error:  ";switch(t){case e.INVALID_ENUM:r+="INVALID_ENUM";break;case e.INVALID_VALUE:r+="INVALID_VALUE";break;case e.INVALID_OPERATION:r+="INVALID_OPERATION";break;case e.OUT_OF_MEMORY:r+="OUT_OF_MEMORY";break;case e.CONTEXT_LOST_WEBGL:r+="CONTEXT_LOST_WEBGL lost";break;default:r+="Unknown ("+t+")"}return r}(e,a)+": "+t.name+"(",n=0;n<r.length;++n)0!==n&&(i+=", "),i+=r[n];return i+=");"}(e,t,r,a))}function M(e,t,r){return{get:function(){var a=e[t];return r(e,"get: "+t,a),e[t]},set:function(a){e[t]=a,r(e,"set: "+t,a)}}}function L(e,t){for(var r=t.length,a=0;a<r;++a){var i=e.getExtension(t[a]);if(i)return i}}function P(a,s){if("undefined"==typeof WebGLRenderingContext)throw new m("The browser does not support WebGL.  Visit http://get.webgl.org.");e.defined("canvas",a),this._canvas=a,s=t(s,!0),(s=n(s,{})).allowTextureFilterAnisotropic=n(s.allowTextureFilterAnisotropic,!0);var u=n(s.webgl,{});u.alpha=n(u.alpha,!1),u.stencil=n(u.stencil,!0);var _,h=n(s.requestWebgl2,!1)&&"undefined"!=typeof WebGL2RenderingContext,f=!1,c=s.getWebGLStub;if(o(c))_=c(a,u);else if(h&&(_=a.getContext("webgl2",u)||a.getContext("experimental-webgl2",u)||void 0,o(_)&&(f=!0)),o(_)||(_=a.getContext("webgl",u)||a.getContext("experimental-webgl",u)||void 0),!o(_))throw new m("The browser supports WebGL, but initialization failed.");this._originalGLContext=_,this._gl=_,this._webgl2=f,this._id=i(),this.validateFramebuffer=!1,this.validateShaderProgram=!1,this.logShaderCompilation=!1,this._throwOnWebGLError=!1,this._shaderCache=new y(this),this._textureCache=new I;var d=_;this._stencilBits=d.getParameter(d.STENCIL_BITS),b._maximumCombinedTextureImageUnits=d.getParameter(d.MAX_COMBINED_TEXTURE_IMAGE_UNITS),b._maximumCubeMapSize=d.getParameter(d.MAX_CUBE_MAP_TEXTURE_SIZE),b._maximumFragmentUniformVectors=d.getParameter(d.MAX_FRAGMENT_UNIFORM_VECTORS),b._maximumTextureImageUnits=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS),b._maximumRenderbufferSize=d.getParameter(d.MAX_RENDERBUFFER_SIZE),b._maximumTextureSize=d.getParameter(d.MAX_TEXTURE_SIZE),b._maximumVaryingVectors=d.getParameter(d.MAX_VARYING_VECTORS),b._maximumVertexAttributes=d.getParameter(d.MAX_VERTEX_ATTRIBS),b._maximumVertexTextureImageUnits=d.getParameter(d.MAX_VERTEX_TEXTURE_IMAGE_UNITS),b._maximumVertexUniformVectors=d.getParameter(d.MAX_VERTEX_UNIFORM_VECTORS);var l=d.getParameter(d.ALIASED_LINE_WIDTH_RANGE);b._minimumAliasedLineWidth=l[0],b._maximumAliasedLineWidth=l[1];var p=d.getParameter(d.ALIASED_POINT_SIZE_RANGE);b._minimumAliasedPointSize=p[0],b._maximumAliasedPointSize=p[1];var x=d.getParameter(d.MAX_VIEWPORT_DIMS);b._maximumViewportWidth=x[0],b._maximumViewportHeight=x[1];var E=d.getShaderPrecisionFormat(d.FRAGMENT_SHADER,d.HIGH_FLOAT);b._highpFloatSupported=0!==E.precision;var T=d.getShaderPrecisionFormat(d.FRAGMENT_SHADER,d.HIGH_INT);b._highpIntSupported=0!==T.rangeMax,this._antialias=d.getContextAttributes().antialias,this._standardDerivatives=!!L(d,["OES_standard_derivatives"]),this._blendMinmax=!!L(d,["EXT_blend_minmax"]),this._elementIndexUint=!!L(d,["OES_element_index_uint"]),this._depthTexture=!!L(d,["WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"]),this._fragDepth=!!L(d,["EXT_frag_depth"]),this._debugShaders=L(d,["WEBGL_debug_shaders"]),this._textureFloat=!!L(d,["OES_texture_float"]),this._textureHalfFloat=!!L(d,["OES_texture_half_float"]),this._textureFloatLinear=!!L(d,["OES_texture_float_linear"]),this._textureHalfFloatLinear=!!L(d,["OES_texture_half_float_linear"]),this._colorBufferFloat=!!L(d,["EXT_color_buffer_float","WEBGL_color_buffer_float"]),this._colorBufferHalfFloat=!!L(d,["EXT_color_buffer_half_float"]),this._s3tc=!!L(d,["WEBGL_compressed_texture_s3tc","MOZ_WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"]),this._pvrtc=!!L(d,["WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"]),this._etc1=!!L(d,["WEBGL_compressed_texture_etc1"]);var A,v,F,S,O,R,M,P,U,D,G=s.allowTextureFilterAnisotropic?L(d,["EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"]):void 0;if(this._textureFilterAnisotropic=G,b._maximumTextureFilterAnisotropy=o(G)?d.getParameter(G.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,f){var N=this;A=function(){return N._gl.createVertexArray()},v=function(e){N._gl.bindVertexArray(e)},F=function(e){N._gl.deleteVertexArray(e)},S=function(e,t,r,a,i){d.drawElementsInstanced(e,t,r,a,i)},O=function(e,t,r,a){d.drawArraysInstanced(e,t,r,a)},R=function(e,t){d.vertexAttribDivisor(e,t)},M=function(e){d.drawBuffers(e)}}else P=L(d,["OES_vertex_array_object"]),o(P)&&(A=function(){return P.createVertexArrayOES()},v=function(e){P.bindVertexArrayOES(e)},F=function(e){P.deleteVertexArrayOES(e)}),U=L(d,["ANGLE_instanced_arrays"]),o(U)&&(S=function(e,t,r,a,i){U.drawElementsInstancedANGLE(e,t,r,a,i)},O=function(e,t,r,a){U.drawArraysInstancedANGLE(e,t,r,a)},R=function(e,t){U.vertexAttribDivisorANGLE(e,t)}),D=L(d,["WEBGL_draw_buffers"]),o(D)&&(M=function(e){D.drawBuffersWEBGL(e)});this.glCreateVertexArray=A,this.glBindVertexArray=v,this.glDeleteVertexArray=F,this.glDrawElementsInstanced=S,this.glDrawArraysInstanced=O,this.glVertexAttribDivisor=R,this.glDrawBuffers=M,this._vertexArrayObject=!!P,this._instancedArrays=!!U,this._drawBuffers=!!D,b._maximumDrawBuffers=this.drawBuffers?d.getParameter(g.MAX_DRAW_BUFFERS):1,b._maximumColorAttachments=this.drawBuffers?d.getParameter(g.MAX_COLOR_ATTACHMENTS):1,this._clearColor=new r(0,0,0,0),this._clearDepth=1,this._clearStencil=0;var V=new B,W=new w(this),X=C.fromCache();this._defaultPassState=W,this._defaultRenderState=X,this._defaultTexture=void 0,this._defaultCubeMap=void 0,this._us=V,this._currentRenderState=X,this._currentPassState=W,this._currentFramebuffer=void 0,this._maxFrameTextureUnitIndex=0,this._vertexAttribDivisors=[],this._previousDrawInstanced=!1;for(var k=0;k<b._maximumVertexAttributes;k++)this._vertexAttribDivisors.push(0);this._pickObjects={},this._nextPickColor=new Uint32Array(1),this.options=s,this.cache={},C.apply(d,X,W)}var U,D={};function G(e,t,r,a){var i=e._currentRenderState,n=e._currentPassState;e._currentRenderState=t,e._currentPassState=r,C.partialApply(e._gl,i,t,n,r,a)}function N(e,t){if(t!==e._currentFramebuffer){e._currentFramebuffer=t;var r=U;if(o(t))t._bind(),function(e){if(e.validateFramebuffer){var t=e._gl,r=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r!==t.FRAMEBUFFER_COMPLETE){var a;switch(r){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:a="Framebuffer is not complete.  Incomplete attachment: at least one attachment point with a renderbuffer or texture attached has its attached object no longer in existence or has an attached image with a width or height of zero, or the color attachment point has a non-color-renderable image attached, or the depth attachment point has a non-depth-renderable image attached, or the stencil attachment point has a non-stencil-renderable image attached.  Color-renderable formats include GL_RGBA4, GL_RGB5_A1, and GL_RGB565. GL_DEPTH_COMPONENT16 is the only depth-renderable format. GL_STENCIL_INDEX8 is the only stencil-renderable format.";break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:a="Framebuffer is not complete.  Incomplete dimensions: not all attached images have the same width and height.";break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:a="Framebuffer is not complete.  Missing attachment: no images are attached to the framebuffer.";break;case t.FRAMEBUFFER_UNSUPPORTED:a="Framebuffer is not complete.  Unsupported: the combination of internal formats of the attached images violates an implementation-dependent set of restrictions."}throw new _(a)}}}(e),r=t._getActiveColorAttachments();else{var a=e._gl;a.bindFramebuffer(a.FRAMEBUFFER,null)}e.drawBuffers&&e.glDrawBuffers(r)}}s(P.prototype,{id:{get:function(){return this._id}},webgl2:{get:function(){return this._webgl2}},canvas:{get:function(){return this._canvas}},shaderCache:{get:function(){return this._shaderCache}},textureCache:{get:function(){return this._textureCache}},uniformState:{get:function(){return this._us}},stencilBits:{get:function(){return this._stencilBits}},stencilBuffer:{get:function(){return this._stencilBits>=8}},antialias:{get:function(){return this._antialias}},standardDerivatives:{get:function(){return this._standardDerivatives||this._webgl2}},blendMinmax:{get:function(){return this._blendMinmax||this._webgl2}},elementIndexUint:{get:function(){return this._elementIndexUint||this._webgl2}},depthTexture:{get:function(){return this._depthTexture||this._webgl2}},floatingPointTexture:{get:function(){return this._webgl2||this._textureFloat}},halfFloatingPointTexture:{get:function(){return this._webgl2||this._textureHalfFloat}},textureFloatLinear:{get:function(){return this._textureFloatLinear}},textureHalfFloatLinear:{get:function(){return this._webgl2&&this._textureFloatLinear||!this._webgl2&&this._textureHalfFloatLinear}},textureFilterAnisotropic:{get:function(){return!!this._textureFilterAnisotropic}},s3tc:{get:function(){return this._s3tc}},pvrtc:{get:function(){return this._pvrtc}},etc1:{get:function(){return this._etc1}},vertexArrayObject:{get:function(){return this._vertexArrayObject||this._webgl2}},fragmentDepth:{get:function(){return this._fragDepth||this._webgl2}},instancedArrays:{get:function(){return this._instancedArrays||this._webgl2}},colorBufferFloat:{get:function(){return this._colorBufferFloat}},colorBufferHalfFloat:{get:function(){return this._webgl2&&this._colorBufferFloat||!this._webgl2&&this._colorBufferHalfFloat}},drawBuffers:{get:function(){return this._drawBuffers||this._webgl2}},debugShaders:{get:function(){return this._debugShaders}},throwOnWebGLError:{get:function(){return this._throwOnWebGLError},set:function(e){this._throwOnWebGLError=e,this._gl=function(e,t){if(!o(t))return e;function r(r){return function(){var a=r.apply(e,arguments);return t(e,r,arguments),a}}var a={};for(var i in e){var n=e[i];n instanceof Function?a[i]=r(n):Object.defineProperty(a,i,M(e,i,t))}return a}(this._originalGLContext,e?R:void 0)}},defaultTexture:{get:function(){return void 0===this._defaultTexture&&(this._defaultTexture=new S({context:this,source:{width:1,height:1,arrayBufferView:new Uint8Array([255,255,255,255])},flipY:!1})),this._defaultTexture}},defaultCubeMap:{get:function(){if(void 0===this._defaultCubeMap){var e={width:1,height:1,arrayBufferView:new Uint8Array([255,255,255,255])};this._defaultCubeMap=new T({context:this,source:{positiveX:e,negativeX:e,positiveY:e,negativeY:e,positiveZ:e,negativeZ:e},flipY:!1})}return this._defaultCubeMap}},drawingBufferHeight:{get:function(){return this._gl.drawingBufferHeight}},drawingBufferWidth:{get:function(){return this._gl.drawingBufferWidth}},defaultFramebuffer:{get:function(){return D}}}),"undefined"!=typeof WebGLRenderingContext&&(U=[g.BACK]);var V=new E;P.prototype.clear=function(e,t){e=n(e,V),t=n(t,this._defaultPassState);var a=this._gl,i=0,s=e.color,u=e.depth,_=e.stencil;o(s)&&(r.equals(this._clearColor,s)||(r.clone(s,this._clearColor),a.clearColor(s.red,s.green,s.blue,s.alpha)),i|=a.COLOR_BUFFER_BIT),o(u)&&(u!==this._clearDepth&&(this._clearDepth=u,a.clearDepth(u)),i|=a.DEPTH_BUFFER_BIT),o(_)&&(_!==this._clearStencil&&(this._clearStencil=_,a.clearStencil(_)),i|=a.STENCIL_BUFFER_BIT),G(this,n(e.renderState,this._defaultRenderState),t,!0),N(this,n(e.framebuffer,t.framebuffer)),a.clear(i)},P.prototype.draw=function(t,r,a,i){e.defined("drawCommand",t),e.defined("drawCommand.shaderProgram",t._shaderProgram),r=n(r,this._defaultPassState);var s=n(t._framebuffer,r.framebuffer),u=n(t._renderState,this._defaultRenderState);a=n(a,t._shaderProgram),i=n(i,t._uniformMap),function(e,t,r,a,i){if(o(t)&&i.depthTest&&i.depthTest.enabled&&!t.hasDepthAttachment)throw new _("The depth test can not be enabled (drawCommand.renderState.depthTest.enabled) because the framebuffer (drawCommand.framebuffer) does not have a depth or depth-stencil renderbuffer.");N(e,t),G(e,i,r,!1),a._bind(),e._maxFrameTextureUnitIndex=Math.max(e._maxFrameTextureUnitIndex,a.maximumTextureUnitIndex)}(this,s,r,a,u),function(t,r,a,i){var s=r._primitiveType,u=r._vertexArray,h=r._offset,f=r._count,d=r.instanceCount;if(!l.validate(s))throw new _("drawCommand.primitiveType is required and must be valid.");if(e.defined("drawCommand.vertexArray",u),e.typeOf.number.greaterThanOrEquals("drawCommand.offset",h,0),o(f)&&e.typeOf.number.greaterThanOrEquals("drawCommand.count",f,0),e.typeOf.number.greaterThanOrEquals("drawCommand.instanceCount",d,0),d>0&&!t.instancedArrays)throw new _("Instanced arrays extension is not supported");t._us.model=n(r._modelMatrix,c.IDENTITY),a._setUniforms(i,t._us,t.validateShaderProgram),u._bind();var m=u.indexBuffer;o(m)?(h*=m.bytesPerIndex,f=n(f,m.numberOfIndices),0===d?t._gl.drawElements(s,f,m.indexDatatype,h):t.glDrawElementsInstanced(s,f,m.indexDatatype,h,d)):(f=n(f,u.numberOfVertices),0===d?t._gl.drawArrays(s,h,f):t.glDrawArraysInstanced(s,h,f,d)),u._unBind()}(this,t,a,i)},P.prototype.endFrame=function(){var e=this._gl;e.useProgram(null),this._currentFramebuffer=void 0,e.bindFramebuffer(e.FRAMEBUFFER,null);var t=U;this.drawBuffers&&this.glDrawBuffers(t);var r=this._maxFrameTextureUnitIndex;this._maxFrameTextureUnitIndex=0;for(var a=0;a<r;++a)e.activeTexture(e.TEXTURE0+a),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_CUBE_MAP,null)},P.prototype.readPixels=function(t){var r=this._gl;t=n(t,n.EMPTY_OBJECT);var a=Math.max(n(t.x,0),0),i=Math.max(n(t.y,0),0),s=n(t.width,r.drawingBufferWidth),u=n(t.height,r.drawingBufferHeight),_=t.framebuffer;e.typeOf.number.greaterThan("readState.width",s,0),e.typeOf.number.greaterThan("readState.height",u,0);var h=v.UNSIGNED_BYTE;o(_)&&_.numberOfColorAttachments>0&&(h=_.getColorTexture(0).pixelDatatype);var f=d.createTypedArray(d.RGBA,h,s,u);return N(this,_),r.readPixels(a,i,s,u,d.RGBA,h,f),f};var W={position:0,textureCoordinates:1};function X(e,t,r){this._pickObjects=e,this.key=t,this.color=r}return P.prototype.getViewportQuadVertexArray=function(){var e=this.cache.viewportQuad_vertexArray;if(!o(e)){var t=new h({attributes:{position:new f({componentDatatype:a.FLOAT,componentsPerAttribute:2,values:[-1,-1,1,-1,1,1,-1,1]}),textureCoordinates:new f({componentDatatype:a.FLOAT,componentsPerAttribute:2,values:[0,0,1,0,1,1,0,1]})},indices:new Uint16Array([0,1,2,0,2,3]),primitiveType:l.TRIANGLES});e=O.fromGeometry({context:this,geometry:t,attributeLocations:W,bufferUsage:x.STATIC_DRAW,interleave:!0}),this.cache.viewportQuad_vertexArray=e}return e},P.prototype.createViewportQuadCommand=function(e,t){return t=n(t,n.EMPTY_OBJECT),new A({vertexArray:this.getViewportQuadVertexArray(),primitiveType:l.TRIANGLES,renderState:t.renderState,shaderProgram:F.fromCache({context:this,vertexShaderSource:p,fragmentShaderSource:e,attributeLocations:W}),uniformMap:t.uniformMap,owner:t.owner,framebuffer:t.framebuffer,pass:t.pass})},P.prototype.getObjectByPickColor=function(t){return e.defined("pickColor",t),this._pickObjects[t.toRgba()]},s(X.prototype,{object:{get:function(){return this._pickObjects[this.key]},set:function(e){this._pickObjects[this.key]=e}}}),X.prototype.destroy=function(){delete this._pickObjects[this.key]},P.prototype.createPickId=function(t){e.defined("object",t),++this._nextPickColor[0];var a=this._nextPickColor[0];if(0===a)throw new m("Out of unique Pick IDs.");return this._pickObjects[a]=t,new X(this._pickObjects,a,r.fromRgba(a))},P.prototype.isDestroyed=function(){return!1},P.prototype.destroy=function(){var e=this.cache;for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];o(r.destroy)&&r.destroy()}return this._shaderCache=this._shaderCache.destroy(),this._textureCache=this._textureCache.destroy(),this._defaultTexture=this._defaultTexture&&this._defaultTexture.destroy(),this._defaultCubeMap=this._defaultCubeMap&&this._defaultCubeMap.destroy(),u(this)},P});