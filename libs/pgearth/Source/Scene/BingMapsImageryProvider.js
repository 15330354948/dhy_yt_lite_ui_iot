define(["../Core/BingMapsApi","../Core/buildModuleUrl","../Core/Check","../Core/Credit","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Event","../Core/Math","../Core/Rectangle","../Core/Resource","../Core/RuntimeError","../Core/TileProviderError","../Core/WebMercatorTilingScheme","../ThirdParty/when","./BingMapsStyle","./DiscardEmptyTileImagePolicy","./ImageryProvider"],function(e,r,t,i,o,a,n,l,s,u,h,c,d,m,g,y,_,f,v){"use strict";function p(r){if(r=o(r,{}),!a(r.url))throw new l("options.url is required.");this._key=e.getKey(r.key),this._resource=c.createIfNeeded(r.url),this._resource.appendForwardSlash(),this._tileProtocol=r.tileProtocol,this._mapStyle=o(r.mapStyle,_.AERIAL),this._culture=o(r.culture,""),this._tileDiscardPolicy=r.tileDiscardPolicy,a(this._tileDiscardPolicy)||(this._tileDiscardPolicy=new f),this._proxy=r.proxy,this._credit=new i('<a href="http://www.bing.com"><img src="'+p.logoUrl+'" title="Bing Imagery"/></a>'),this.defaultGamma=1,this._tilingScheme=new g({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:2,ellipsoid:r.ellipsoid}),this._tileWidth=void 0,this._tileHeight=void 0,this._maximumLevel=void 0,this._imageUrlTemplate=void 0,this._imageUrlSubdomains=void 0,this._errorEvent=new s,this._ready=!1,this._readyPromise=y.defer();var t=this._tileProtocol;a(t)?t.length>0&&":"===t[t.length-1]&&(t=t.substr(0,t.length-1)):t="http:"===document.location.protocol?"http":"https";var n,v=this._resource.getDerivedResource({url:"REST/v1/Imagery/Metadata/"+this._mapStyle,queryParameters:{incl:"ImageryProviders",key:this._key,uriScheme:t}}),b=this;function w(e){if(1===e.resourceSets.length){var r=e.resourceSets[0].resources[0];b._tileWidth=r.imageWidth,b._tileHeight=r.imageHeight,b._maximumLevel=r.zoomMax-1,b._imageUrlSubdomains=r.imageUrlSubdomains,b._imageUrlTemplate=r.imageUrl;var t=b._attributionList=r.imageryProviders;t||(t=b._attributionList=[]);for(var o=0,a=t.length;o<a;++o){var l=t[o];if(l.credit instanceof i)break;l.credit=new i(l.attribution);for(var s=l.coverageAreas,c=0,d=l.coverageAreas.length;c<d;++c){var g=s[c],y=g.bbox;g.bbox=new h(u.toRadians(y[1]),u.toRadians(y[0]),u.toRadians(y[3]),u.toRadians(y[2]))}}b._ready=!0,b._readyPromise.resolve(!0),m.handleSuccess(n)}else P()}function P(e){var r="An error occurred while accessing "+v.url+".";n=m.handleError(n,b,b._errorEvent,r,void 0,void 0,void 0,S),b._readyPromise.reject(new d(r))}var C=v.url;function S(){var e=v.fetchJsonp("jsonp");p._metadataCache[C]=e,e.then(w).otherwise(P)}var T=p._metadataCache[C];a(T)?T.then(w).otherwise(P):S()}n(p.prototype,{url:{get:function(){return this._resource.url}},proxy:{get:function(){return this._resource.proxy}},key:{get:function(){return this._key}},mapStyle:{get:function(){return this._mapStyle}},culture:{get:function(){return this._culture}},tileWidth:{get:function(){if(!this._ready)throw new l("tileWidth must not be called before the imagery provider is ready.");return this._tileWidth}},tileHeight:{get:function(){if(!this._ready)throw new l("tileHeight must not be called before the imagery provider is ready.");return this._tileHeight}},maximumLevel:{get:function(){if(!this._ready)throw new l("maximumLevel must not be called before the imagery provider is ready.");return this._maximumLevel}},minimumLevel:{get:function(){if(!this._ready)throw new l("minimumLevel must not be called before the imagery provider is ready.");return 0}},tilingScheme:{get:function(){if(!this._ready)throw new l("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme}},rectangle:{get:function(){if(!this._ready)throw new l("rectangle must not be called before the imagery provider is ready.");return this._tilingScheme.rectangle}},tileDiscardPolicy:{get:function(){if(!this._ready)throw new l("tileDiscardPolicy must not be called before the imagery provider is ready.");return this._tileDiscardPolicy}},errorEvent:{get:function(){return this._errorEvent}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},credit:{get:function(){return this._credit}},hasAlphaChannel:{get:function(){return!1}}});var b=new h;p.prototype.getTileCredits=function(e,r,t){if(!this._ready)throw new l("getTileCredits must not be called before the imagery provider is ready.");var i=this._tilingScheme.tileXYToRectangle(e,r,t,b);return function(e,r,t){++r;for(var i=[],o=0,n=e.length;o<n;++o){for(var l=e[o],s=l.coverageAreas,u=!1,c=0,d=l.coverageAreas.length;!u&&c<d;++c){var m=s[c];if(r>=m.zoomMin&&r<=m.zoomMax){var g=h.intersection(t,m.bbox,w);a(g)&&(u=!0)}}u&&i.push(l.credit)}return i}(this._attributionList,t,i)},p.prototype.requestImage=function(e,r,t,i){if(!this._ready)throw new l("requestImage must not be called before the imagery provider is ready.");var o=v.loadImage(this,function(e,r,t,i,o){var a=e._imageUrlTemplate,n=e._imageUrlSubdomains,l=(r+t+i)%n.length;return e._resource.getDerivedResource({url:a,request:o,templateValues:{quadkey:p.tileXYToQuadKey(r,t,i),subdomain:n[l],culture:e._culture},queryParameters:{n:"z"}})}(this,e,r,t,i));if(a(o))return o.otherwise(function(e){return a(e.blob)&&0===e.blob.size?f.EMPTY_IMAGE:y.reject(e)})},p.prototype.pickFeatures=function(e,r,t,i,o){},p.tileXYToQuadKey=function(e,r,t){for(var i="",o=t;o>=0;--o){var a=1<<o,n=0;0!=(e&a)&&(n|=1),0!=(r&a)&&(n|=2),i+=n}return i},p.quadKeyToTileXY=function(e){for(var r=0,t=0,i=e.length-1,o=i;o>=0;--o){var a=1<<o,n=+e[i-o];0!=(1&n)&&(r|=a),0!=(2&n)&&(t|=a)}return{x:r,y:t,level:i}},p._logoUrl=void 0,n(p,{logoUrl:{get:function(){return a(p._logoUrl)||(p._logoUrl=r("Assets/Images/bing_maps_credit.png")),p._logoUrl},set:function(e){t.defined("value",e),p._logoUrl=e}}});var w=new h;return p._metadataCache={},p});