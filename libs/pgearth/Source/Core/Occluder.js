define(["./BoundingSphere","./Cartesian3","./defaultValue","./defined","./defineProperties","./DeveloperError","./Ellipsoid","./Math","./Rectangle","./Visibility"],function(i,r,t,e,o,n,a,s,u,c){"use strict";function d(i,t){if(!e(i))throw new n("occluderBoundingSphere is required.");if(!e(t))throw new n("camera position is required.");this._occluderPosition=r.clone(i.center),this._occluderRadius=i.radius,this._horizonDistance=0,this._horizonPlaneNormal=void 0,this._horizonPlanePosition=void 0,this._cameraPosition=void 0,this.cameraPosition=t}var l=new r;o(d.prototype,{position:{get:function(){return this._occluderPosition}},radius:{get:function(){return this._occluderRadius}},cameraPosition:{set:function(i){if(!e(i))throw new n("cameraPosition is required.");i=r.clone(i,this._cameraPosition);var t,o,a,s=r.subtract(this._occluderPosition,i,l),u=r.magnitudeSquared(s),c=this._occluderRadius*this._occluderRadius;if(u>c){t=Math.sqrt(u-c),u=1/Math.sqrt(u),o=r.multiplyByScalar(s,u,l);var d=t*t*u;a=r.add(i,r.multiplyByScalar(o,d,l),l)}else t=Number.MAX_VALUE;this._horizonDistance=t,this._horizonPlaneNormal=o,this._horizonPlanePosition=a,this._cameraPosition=i}}}),d.fromBoundingSphere=function(i,t,o){if(!e(i))throw new n("occluderBoundingSphere is required.");if(!e(t))throw new n("camera position is required.");return e(o)?(r.clone(i.center,o._occluderPosition),o._occluderRadius=i.radius,o.cameraPosition=t,o):new d(i,t)};var h=new r;d.prototype.isPointVisible=function(i){if(this._horizonDistance!==Number.MAX_VALUE){var t=r.subtract(i,this._occluderPosition,h),e=this._occluderRadius;if((e=r.magnitudeSquared(t)-e*e)>0)return e=Math.sqrt(e)+this._horizonDistance,t=r.subtract(i,this._cameraPosition,t),e*e>r.magnitudeSquared(t)}return!1};var m=new r;d.prototype.isBoundingSphereVisible=function(i){var t=r.clone(i.center,m),e=i.radius;if(this._horizonDistance!==Number.MAX_VALUE){var o=r.subtract(t,this._occluderPosition,h),n=this._occluderRadius-e;if(n=r.magnitudeSquared(o)-n*n,e<this._occluderRadius)return n>0&&(n=Math.sqrt(n)+this._horizonDistance,o=r.subtract(t,this._cameraPosition,o),n*n+e*e>r.magnitudeSquared(o));if(n>0){o=r.subtract(t,this._cameraPosition,o);var a=r.magnitudeSquared(o),s=this._occluderRadius*this._occluderRadius,u=e*e;return(this._horizonDistance*this._horizonDistance+s)*u>a*s||(n=Math.sqrt(n)+this._horizonDistance)*n+u>a}return!0}return!1};var _=new r;d.prototype.computeVisibility=function(i){if(!e(i))throw new n("occludeeBS is required.");var t=r.clone(i.center),o=i.radius;if(o>this._occluderRadius)return c.FULL;if(this._horizonDistance!==Number.MAX_VALUE){var a=r.subtract(t,this._occluderPosition,_),s=this._occluderRadius-o,u=r.magnitudeSquared(a);if((s=u-s*s)>0){s=Math.sqrt(s)+this._horizonDistance,a=r.subtract(t,this._cameraPosition,a);var d=r.magnitudeSquared(a);return s*s+o*o<d?c.NONE:(s=u-(s=this._occluderRadius+o)*s)>0?d<(s=Math.sqrt(s)+this._horizonDistance)*s+o*o?c.FULL:c.PARTIAL:(a=r.subtract(t,this._horizonPlanePosition,a),r.dot(a,this._horizonPlaneNormal)>-o?c.PARTIAL:c.FULL)}}return c.NONE};var f=new r;d.computeOccludeePoint=function(i,t,o){if(!e(i))throw new n("occluderBoundingSphere is required.");if(!e(o))throw new n("positions is required.");if(0===o.length)throw new n("positions must contain at least one element");var a=r.clone(t),s=r.clone(i.center),u=i.radius,c=o.length;if(r.equals(s,t))throw new n("occludeePosition must be different than occluderBoundingSphere.center");var l=r.normalize(r.subtract(a,s,f),f),h=-r.dot(l,s),m=d._anyRotationVector(s,l,h),_=d._horizonToPlaneNormalDotProduct(i,l,h,m,o[0]);if(_){for(var z,P=1;P<c;++P){if(!(z=d._horizonToPlaneNormalDotProduct(i,l,h,m,o[P])))return;z<_&&(_=z)}if(!(_<.0017453283658983088)){var y=u/_;return r.add(s,r.multiplyByScalar(l,y,f),f)}}};var z=[];d.computeOccludeePointFromRectangle=function(o,s){if(!e(o))throw new n("rectangle is required.");s=t(s,a.WGS84);var c=u.subsample(o,s,0,z),l=i.fromPoints(c),h=r.ZERO;if(!r.equals(h,l.center))return d.computeOccludeePoint(new i(h,s.minimumRadius),l.center,c)};var P=new r;d._anyRotationVector=function(i,t,e){var o=r.abs(t,P),n=o.x>o.y?0:1;(0===n&&o.z>o.x||1===n&&o.z>o.y)&&(n=2);var a,s=new r;0===n?(o.x=i.x,o.y=i.y+1,o.z=i.z+1,a=r.UNIT_X):1===n?(o.x=i.x+1,o.y=i.y,o.z=i.z+1,a=r.UNIT_Y):(o.x=i.x+1,o.y=i.y+1,o.z=i.z,a=r.UNIT_Z);var u=(r.dot(t,o)+e)/-r.dot(t,a);return r.normalize(r.subtract(r.add(o,r.multiplyByScalar(a,u,s),o),i,o),o)};var y=new r;d._rotationVector=function(i,t,e,o,n){var a=r.subtract(o,i,y);if(a=r.normalize(a,a),r.dot(t,a)<.9999999847691291){var u=r.cross(t,a,a);if(r.magnitude(u)>s.EPSILON13)return r.normalize(u,new r)}return n};var v=new r,w=new r,p=new r,q=new r;return d._horizonToPlaneNormalDotProduct=function(i,t,e,o,n){var a=r.clone(n,v),s=r.clone(i.center,w),u=i.radius,c=r.subtract(s,a,p),d=r.magnitudeSquared(c),l=u*u;if(d<l)return!1;var h=d-l,m=Math.sqrt(h),_=m*(1/Math.sqrt(d))*m;c=r.normalize(c,c);var f=r.add(a,r.multiplyByScalar(c,_,q),q),z=Math.sqrt(h-_*_),P=this._rotationVector(s,t,e,a,o),y=r.fromElements(P.x*P.x*c.x+(P.x*P.y-P.z)*c.y+(P.x*P.z+P.y)*c.z,(P.x*P.y+P.z)*c.x+P.y*P.y*c.y+(P.y*P.z-P.x)*c.z,(P.x*P.z-P.y)*c.x+(P.y*P.z+P.x)*c.y+P.z*P.z*c.z,v);y=r.normalize(y,y);var b=r.multiplyByScalar(y,z,v);P=r.normalize(r.subtract(r.add(f,b,p),s,p),p);var S=r.dot(t,P);P=r.normalize(r.subtract(r.subtract(f,b,P),s,P),P);var g=r.dot(t,P);return S<g?S:g},d});