define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/PixelFormat","../Core/Resource","../Core/RuntimeError","../Renderer/Framebuffer","../Renderer/Texture","../ThirdParty/when"],function(t,e,i,r,o,n,h,d,u,s,x,a,f,w){"use strict";function _(t,i,o,n,h){this.bottomLeft=r(t,e.ZERO),this.topRight=r(i,e.ZERO),this.childNode1=o,this.childNode2=n,this.imageIndex=h}var g=new e(16,16);function c(t){t=r(t,r.EMPTY_OBJECT);var e=r(t.borderWidthInPixels,1),n=r(t.initialSize,g);if(!o(t.context))throw new d("context is required.");if(e<0)throw new d("borderWidthInPixels must be greater than or equal to zero.");if(n.x<1||n.y<1)throw new d("initialSize must be greater than zero.");this._context=t.context,this._pixelFormat=r(t.pixelFormat,u.RGBA),this._borderWidthInPixels=e,this._textureCoordinates=[],this._guid=i(),this._idHash={},this._initialSize=n,this._root=void 0}function m(r,n,h){var d=function t(i,r,n){if(o(r)){if(!o(r.childNode1)&&!o(r.childNode2)){if(o(r.imageIndex))return;var h=r.topRight.x-r.bottomLeft.x,d=r.topRight.y-r.bottomLeft.y,u=h-n.width,s=d-n.height;if(u<0||s<0)return;if(0===u&&0===s)return r;if(u>s){r.childNode1=new _(new e(r.bottomLeft.x,r.bottomLeft.y),new e(r.bottomLeft.x+n.width,r.topRight.y));var x=r.bottomLeft.x+n.width+i._borderWidthInPixels;x<r.topRight.x&&(r.childNode2=new _(new e(x,r.bottomLeft.y),new e(r.topRight.x,r.topRight.y)))}else{r.childNode1=new _(new e(r.bottomLeft.x,r.bottomLeft.y),new e(r.topRight.x,r.bottomLeft.y+n.height));var a=r.bottomLeft.y+n.height+i._borderWidthInPixels;a<r.topRight.y&&(r.childNode2=new _(new e(r.bottomLeft.x,a),new e(r.topRight.x,r.topRight.y)))}return t(i,r.childNode1,n)}return t(i,r.childNode1,n)||t(i,r.childNode2,n)}}(r,r._root,n);if(o(d)){d.imageIndex=h;var u=r._texture.width,s=r._texture.height,x=d.topRight.x-d.bottomLeft.x,w=d.topRight.y-d.bottomLeft.y,g=d.bottomLeft.x/u,c=d.bottomLeft.y/s,l=x/u,y=w/s;r._textureCoordinates[h]=new t(g,c,l,y),r._texture.copyFrom(n,d.bottomLeft.x,d.bottomLeft.y)}else!function(t,i){var r=t._context,n=t.numberOfImages,h=t._borderWidthInPixels;if(n>0){for(var d=t._texture.width,u=t._texture.height,s=2*(d+i.width+h),x=2*(u+i.height+h),w=d/s,g=u/x,c=new _(new e(d+h,h),new e(s,u)),m=new _(new e,new e(s,u),t._root,c),l=new _(new e(h,u+h),new e(s,x)),y=new _(new e,new e(s,x),m,l),b=0;b<t._textureCoordinates.length;b++){var p=t._textureCoordinates[b];o(p)&&(p.x*=w,p.y*=g,p.width*=w,p.height*=g)}var R=new f({context:t._context,width:s,height:x,pixelFormat:t._pixelFormat}),C=new a({context:r,colorTextures:[t._texture],destroyAttachments:!1});C._bind(),R.copyFromFramebuffer(0,0,0,0,s,x),C._unBind(),C.destroy(),t._texture=t._texture&&t._texture.destroy(),t._texture=R,t._root=y}else{var v=2*(i.width+2*h),L=2*(i.height+2*h);v<t._initialSize.x&&(v=t._initialSize.x),L<t._initialSize.y&&(L=t._initialSize.y),t._texture=t._texture&&t._texture.destroy(),t._texture=new f({context:t._context,width:v,height:L,pixelFormat:t._pixelFormat}),t._root=new _(new e(h,h),new e(v,L))}}(r,n),m(r,n,h);r._guid=i()}return n(c.prototype,{borderWidthInPixels:{get:function(){return this._borderWidthInPixels}},textureCoordinates:{get:function(){return this._textureCoordinates}},texture:{get:function(){return o(this._texture)||(this._texture=new f({context:this._context,width:this._initialSize.x,height:this._initialSize.y,pixelFormat:this._pixelFormat})),this._texture}},numberOfImages:{get:function(){return this._textureCoordinates.length}},guid:{get:function(){return this._guid}}}),c.prototype.addImage=function(t,e){if(!o(t))throw new d("id is required.");if(!o(e))throw new d("image is required.");var i=this._idHash[t];if(o(i))return i;if("function"==typeof e){if(e=e(t),!o(e))throw new d("image is required.")}else if("string"==typeof e||e instanceof s){e=s.createIfNeeded(e).fetchImage()}var r=this;return i=w(e,function(t){if(r.isDestroyed())return-1;var e=r.numberOfImages;return m(r,t,e),e}),this._idHash[t]=i,i},c.prototype.addSubRegion=function(e,r){if(!o(e))throw new d("id is required.");if(!o(r))throw new d("subRegion is required.");var n=this._idHash[e];if(!o(n))throw new x('image with id "'+e+'" not found in the atlas.');var h=this;return w(n,function(e){if(-1===e)return-1;var o=h._texture.width,n=h._texture.height,d=h.numberOfImages,u=h._textureCoordinates[e],s=u.x+r.x/o,x=u.y+r.y/n,a=r.width/o,f=r.height/n;return h._textureCoordinates.push(new t(s,x,a,f)),h._guid=i(),d})},c.prototype.isDestroyed=function(){return!1},c.prototype.destroy=function(){return this._texture=this._texture&&this._texture.destroy(),h(this)},c});