define(["../Core/BoundingRectangle","../Core/Cartesian3","../Core/CullingVolume","../Core/defined","../Core/getTimestamp","../Core/Interval","../Core/Math","../Core/Matrix4","../Core/OrthographicFrustum","../Core/OrthographicOffCenterFrustum","../Renderer/ClearCommand","../Renderer/Pass","../Renderer/PassState","./Camera","./FrustumCommands","./GlobeDepth","./OIT","./PickDepthFramebuffer","./PickFramebuffer","./SceneFramebuffer","./SceneMode","./ShadowMap"],function(t,e,a,r,s,i,o,u,m,n,h,f,l,p,c,d,M,b,g,F,v,S){"use strict";function C(e,a,r){var s,i,o=e.context,u=[],m=a.frustum.near,n=a.frustum.far,h=e.logarithmicDepthBuffer?e.logarithmicDepthFarToNearRatio:e.farToNearRatio;_(m,n,h,Math.ceil(Math.log(n/m)/Math.log(h)),e.logarithmicDepthBuffer,u,!1,void 0),o.depthTexture&&(s=new d),e._useOIT&&o.depthTexture&&(i=new M(o));var f=new l(o);f.viewport=t.clone(r),this.camera=a,this._cameraClone=p.clone(a),this._cameraStartFired=!1,this._cameraMovedTime=void 0,this.viewport=r,this.passState=f,this.pickFramebuffer=new g(o),this.pickDepthFramebuffer=new b,this.sceneFramebuffer=new F,this.globeDepth=s,this.oit=i,this.pickDepths=[],this.debugGlobeDepths=[],this.frustumCommandsList=u,this.debugFrustumStatistics=void 0,this.updateFrustums=!1}var E=new e,D=new e;function w(t,a,r){var s,i,o,m,n,h=1/Math.max(1,(s=t.position,i=a.position,o=Math.max(Math.abs(s.x),Math.abs(i.x)),m=Math.max(Math.abs(s.y),Math.abs(i.y)),n=Math.max(Math.abs(s.z),Math.abs(i.z)),Math.max(Math.max(o,m),n)));return e.multiplyByScalar(t.position,h,E),e.multiplyByScalar(a.position,h,D),e.equalsEpsilon(E,D,r)&&e.equalsEpsilon(t.direction,a.direction,r)&&e.equalsEpsilon(t.up,a.up,r)&&e.equalsEpsilon(t.right,a.right,r)&&u.equalsEpsilon(t.transform,a.transform,r)&&t.frustum.equalsEpsilon(a.frustum,r)}function _(t,e,a,s,i,o,u,m){o.length=s;for(var n=0;n<s;++n){var h,f;u?(h=Math.min(e-m,t+n*m),f=Math.min(e,h+m)):(f=a*(h=Math.max(t,Math.pow(a,n)*t)),i||(f=Math.min(e,f)));var l=o[n];r(l)?(l.near=h,l.far=f):l=o[n]=new c(h,f)}}function x(t,e,a,s){t.debugShowFrustums&&(a.debugOverlappingFrustums=0);for(var i=e.frustumCommandsList,o=i.length,u=0;u<o;++u){var m=i[u],n=m.near,h=m.far;if(!(s.start>h)){if(s.stop<n)break;var f=a.pass,l=m.indices[f]++;if(m.commands[f][l]=a,t.debugShowFrustums&&(a.debugOverlappingFrustums|=1<<u),a.executeInClosestFrustum)break}}if(t.debugShowFrustums){var p=e.debugFrustumStatistics.commandsInFrustums;p[a.debugOverlappingFrustums]=r(p[a.debugOverlappingFrustums])?p[a.debugOverlappingFrustums]+1:1,++e.debugFrustumStatistics.totalCommands}t.updateDerivedCommands(a)}C.prototype.checkForCameraUpdates=function(t){var e=this.camera,a=this._cameraClone;return w(e,a,o.EPSILON15)?(this._cameraStartFired&&s()-this._cameraMovedTime>t.cameraEventWaitTime&&(e.moveEnd.raiseEvent(),this._cameraStartFired=!1),!1):(this._cameraStartFired||(e.moveStart.raiseEvent(),this._cameraStartFired=!0),this._cameraMovedTime=s(),p.clone(e,a),!0)};var y=new a,L=new i;return C.prototype.createPotentiallyVisibleSet=function(t){var e=t.frameState,a=e.camera,s=a.directionWC,i=a.positionWC,u=t._computeCommandList,m=t._overlayCommandList,n=e.commandList;t.debugShowFrustums&&(this.debugFrustumStatistics={totalCommands:0,commandsInFrustums:{}});for(var l=this.frustumCommandsList,p=l.length,c=f.NUMBER_OF_PASSES,d=0;d<p;++d)for(var M=0;M<c;++M)l[d].indices[M]=0;u.length=0,m.length=0;for(var b=Number.MAX_VALUE,g=-Number.MAX_VALUE,F=!1,C=e.shadowState.shadowsEnabled,E=Number.MAX_VALUE,D=-Number.MAX_VALUE,w=Number.MAX_VALUE,A=e.mode===v.SCENE3D?e.occluder:void 0,O=e.cullingVolume,T=y.planes,N=0;N<5;++N)T[N]=O.planes[N];O=y;for(var k=n.length,V=0;V<k;++V){var P=n[V],U=P.pass;if(U===f.COMPUTE)u.push(P);else if(U===f.OVERLAY)m.push(P);else{var I=P.boundingVolume;if(r(I)){if(!t.isVisible(P,O,A))continue;if(L=I.computePlaneDistances(i,s,L),b=Math.min(b,L.start),g=Math.max(g,L.stop),C&&P.receiveShadows&&L.start<S.MAXIMUM_DISTANCE&&!(U===f.GLOBE&&L.start<-100&&L.stop>100)){var R=L.stop-L.start;U!==f.GLOBE&&L.start<100&&(w=Math.min(w,R)),E=Math.min(E,L.start),D=Math.max(D,L.stop)}}else L.start=a.frustum.near,L.stop=a.frustum.far,F=!(P instanceof h);x(t,this,P,L)}}F?(b=a.frustum.near,g=a.frustum.far):(b=Math.min(Math.max(b,a.frustum.near),a.frustum.far),g=Math.max(Math.min(g,a.frustum.far),b),C&&(E=Math.min(Math.max(E,a.frustum.near),a.frustum.far),D=Math.max(Math.min(D,a.frustum.far),E))),C&&(e.shadowState.nearPlane=E,e.shadowState.farPlane=D,e.shadowState.closestObjectSize=w);var B,X=t.mode===v.SCENE2D,q=e.useLogDepth,G=q?t.logarithmicDepthFarToNearRatio:t.farToNearRatio;t.useSingleFrustum&&(G=Number.MAX_VALUE),X?(g=Math.min(g,a.position.z+t.nearToFarDistance2D),b=Math.min(b,g),B=Math.ceil(Math.max(1,g-b)/t.nearToFarDistance2D)):B=Math.ceil(Math.log(g/b)/Math.log(G)),(this.updateFrustums||b!==Number.MAX_VALUE&&(B!==p||0!==l.length&&(b<l[0].near||g>l[p-1].far&&(q||!o.equalsEpsilon(g,l[p-1].far,o.EPSILON8)))))&&(this.updateFrustums=!1,_(b,g,G,B,q,l,X,t.nearToFarDistance2D),this.createPotentiallyVisibleSet(t));var z=e.frustumSplits;z.length=B+1;for(var W=0;W<B;++W)z[W]=l[W].near,W===B-1&&(z[W+1]=l[W].far)},C.prototype.destroy=function(){var t,e;this.pickFramebuffer=this.pickFramebuffer&&this.pickFramebuffer.destroy(),this.pickDepthFramebuffer=this.pickDepthFramebuffer&&this.pickDepthFramebuffer.destroy(),this.sceneFramebuffer=this.sceneFramebuffer&&this.sceneFramebuffer.destroy(),this.globeDepth=this.globeDepth&&this.globeDepth.destroy(),this.oit=this.oit&&this.oit.destroy();var a=this.pickDepths,r=this.debugGlobeDepths;for(e=a.length,t=0;t<e;++t)a[t].destroy();for(e=r.length,t=0;t<e;++t)r[t].destroy()},C});