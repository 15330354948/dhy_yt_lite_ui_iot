define(["../Core/AttributeCompression","../Core/Cartesian3","../Core/Color","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/deprecationWarning","../Core/destroyObject","../Core/DeveloperError","../Core/Ellipsoid","../Core/FeatureDetection","../Core/getBaseUri","../Core/getStringFromTypedArray","../Core/Matrix3","../Core/Matrix4","../Core/Quaternion","../Core/RequestType","../Core/RuntimeError","../Core/Transforms","../Core/TranslationRotationScale","../Renderer/Pass","./Axis","./PGEarth3DTileBatchTable","./PGEarth3DTileFeature","./PGEarth3DTileFeatureTable","./ModelInstanceCollection"],function(e,t,n,r,i,o,a,s,l,c,h,u,d,p,_,g,f,T,m,y,b,C,I,v,A,w,P){"use strict";if(!u.supportsTypedArrays())return{};function L(n,a,s,l,c){this._tileset=n,this._tile=a,this._resource=s,this._modelInstanceCollection=void 0,this._batchTable=void 0,this._features=void 0,this.featurePropertiesDirty=!1,function(n,a,s){var l=i(s,0);s=l;var c=new Uint8Array(a),u=new DataView(a);s+=E;var d=u.getUint32(s,!0);if(1!==d)throw new m("Only Instanced 3D Model version 1 is supported. Version "+d+" is not.");s+=E;var A=u.getUint32(s,!0);s+=E;var U=u.getUint32(s,!0);if(0===U)throw new m("featureTableJsonByteLength is zero, the feature table must be defined.");s+=E;var S=u.getUint32(s,!0);s+=E;var R=u.getUint32(s,!0);s+=E;var D=u.getUint32(s,!0);s+=E;var F=u.getUint32(s,!0);if(1!==F&&0!==F)throw new m("Only glTF format 0 (uri) or 1 (embedded) are supported. Format "+F+" is not.");var M=p(c,s+=E,U),G=JSON.parse(M);s+=U;var H=new Uint8Array(a,s,S);s+=S;var x,B,Z=new w(G,H),z=Z.getGlobalProperty("INSTANCES_LENGTH");if(Z.featuresLength=z,!o(z))throw new m("Feature table global property: INSTANCES_LENGTH must be defined");if(R>0){var k=p(c,s,R);x=JSON.parse(k),s+=R,D>0&&(B=new Uint8Array(a,s,D),B=new Uint8Array(B),s+=D)}n._batchTable=new v(n,z,x,B);var Q,V=l+A-s;if(0===V)throw new m("glTF byte length is zero, i3dm must have a glTF to instance.");s%4==0?Q=new Uint8Array(a,s,V):(L._deprecationWarning("i3dm-glb-unaligned","The embedded glb is not aligned to a 4-byte boundary."),Q=new Uint8Array(c.subarray(s,s+V)));var W=n._tileset,q={instances:new Array(z),batchTable:n._batchTable,cull:!1,url:void 0,requestType:T.TILES3D,gltf:void 0,basePath:void 0,incrementallyLoadTextures:!1,upAxis:W._gltfUpAxis,forwardAxis:I.X,opaquePass:C.PGEARTH_3D_TILE,pickIdLoaded:function(e){return function(){return e._batchTable.getPickId()}}(n),imageBasedLightingFactor:W.imageBasedLightingFactor,lightColor:W.lightColor,luminanceAtZenith:W.luminanceAtZenith,sphericalHarmonicCoefficients:W.sphericalHarmonicCoefficients,specularEnvironmentMaps:W.specularEnvironmentMaps};if(0===F){var J=p(Q);J=J.replace(/[\s\0]+$/,""),q.url=n._resource.getDerivedResource({url:J})}else q.gltf=Q,q.basePath=n._resource.clone();var Y,j=Z.getGlobalProperty("EAST_NORTH_UP"),X=Z.getGlobalProperty("RTC_CENTER",r.FLOAT,3);o(X)&&(Y=t.unpack(X));for(var $=q.instances,K=new t,ee=new Array(3),te=new t,ne=new t,re=new t,ie=new _,oe=new f,ae=new t,se=new b,le=new g,ce=0;ce<z;ce++){var he=Z.getProperty("POSITION",r.FLOAT,3,ce,O);if(!o(he)){he=ee;var ue=Z.getProperty("POSITION_QUANTIZED",r.UNSIGNED_SHORT,3,ce,O);if(!o(ue))throw new m("Either POSITION or POSITION_QUANTIZED must be defined for each instance.");var de=Z.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",r.FLOAT,3);if(!o(de))throw new m("Global property: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");var pe=Z.getGlobalProperty("QUANTIZED_VOLUME_SCALE",r.FLOAT,3);if(!o(pe))throw new m("Global property: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");for(var _e=0;_e<3;_e++)he[_e]=ue[_e]/65535*pe[_e]+de[_e]}t.unpack(he,0,K),o(Y)&&t.add(K,Y,K),se.translation=K;var ge=Z.getProperty("NORMAL_UP",r.FLOAT,3,ce,O),fe=Z.getProperty("NORMAL_RIGHT",r.FLOAT,3,ce,N),Te=!1;if(o(ge)){if(!o(fe))throw new m("To define a custom orientation, both NORMAL_UP and NORMAL_RIGHT must be defined.");t.unpack(ge,0,ne),t.unpack(fe,0,te),Te=!0}else{var me=Z.getProperty("NORMAL_UP_OCT32P",r.UNSIGNED_SHORT,2,ce,O),ye=Z.getProperty("NORMAL_RIGHT_OCT32P",r.UNSIGNED_SHORT,2,ce,N);if(o(me)){if(!o(ye))throw new m("To define a custom orientation with oct-encoded vectors, both NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P must be defined.");e.octDecodeInRange(me[0],me[1],65535,ne),e.octDecodeInRange(ye[0],ye[1],65535,te),Te=!0}else j?(y.eastNorthUpToFixedFrame(K,h.WGS84,le),g.getRotation(le,ie)):_.clone(_.IDENTITY,ie)}Te&&(t.cross(te,ne,re),t.normalize(re,re),_.setColumn(ie,0,te,ie),_.setColumn(ie,1,ne,ie),_.setColumn(ie,2,re,ie)),f.fromRotationMatrix(ie,oe),se.rotation=oe,ae=t.fromElements(1,1,1,ae);var be=Z.getProperty("SCALE",r.FLOAT,1,ce);o(be)&&t.multiplyByScalar(ae,be,ae);var Ce=Z.getProperty("SCALE_NON_UNIFORM",r.FLOAT,3,ce,O);o(Ce)&&(ae.x*=Ce[0],ae.y*=Ce[1],ae.z*=Ce[2]),se.scale=ae;var Ie=Z.getProperty("BATCH_ID",r.UNSIGNED_SHORT,1,ce);o(Ie)||(Ie=ce),g.fromTranslationRotationScale(se,le);var ve=le.clone();$[ce]={modelMatrix:ve,batchId:Ie}}n._modelInstanceCollection=new P(q)}(this,l,c)}L._deprecationWarning=s,a(L.prototype,{featuresLength:{get:function(){return this._batchTable.featuresLength}},pointsLength:{get:function(){return 0}},trianglesLength:{get:function(){var e=this._modelInstanceCollection._model;return o(e)?e.trianglesLength:0}},geometryByteLength:{get:function(){var e=this._modelInstanceCollection._model;return o(e)?e.geometryByteLength:0}},texturesByteLength:{get:function(){var e=this._modelInstanceCollection._model;return o(e)?e.texturesByteLength:0}},batchTableByteLength:{get:function(){return this._batchTable.memorySizeInBytes}},innerContents:{get:function(){}},readyPromise:{get:function(){return this._modelInstanceCollection.readyPromise}},tileset:{get:function(){return this._tileset}},tile:{get:function(){return this._tile}},url:{get:function(){return this._resource.getUrlComponent(!0)}},batchTable:{get:function(){return this._batchTable}}});var E=Uint32Array.BYTES_PER_ELEMENT,O=new Array(4),N=new Array(4);return L.prototype.hasProperty=function(e,t){return this._batchTable.hasProperty(e,t)},L.prototype.getFeature=function(e){var t=this.featuresLength;if(!o(e)||e<0||e>=t)throw new c("batchId is required and between zero and featuresLength - 1 ("+(t-1)+").");return function(e){var t=e.featuresLength;if(!o(e._features)&&t>0){for(var n=new Array(t),r=0;r<t;++r)n[r]=new A(e,r);e._features=n}}(this),this._features[e]},L.prototype.applyDebugSettings=function(e,t){t=e?t:n.WHITE,this._batchTable.setAllColor(t)},L.prototype.applyStyle=function(e){this._batchTable.applyStyle(e)},L.prototype.update=function(e,t){var n=t.commandList.length;this._batchTable.update(e,t),this._modelInstanceCollection.modelMatrix=this._tile.computedTransform,this._modelInstanceCollection.shadows=this._tileset.shadows,this._modelInstanceCollection.lightColor=this._tileset.lightColor,this._modelInstanceCollection.luminanceAtZenith=this._tileset.luminanceAtZenith,this._modelInstanceCollection.sphericalHarmonicCoefficients=this._tileset.sphericalHarmonicCoefficients,this._modelInstanceCollection.specularEnvironmentMaps=this._tileset.specularEnvironmentMaps,this._modelInstanceCollection.debugWireframe=this._tileset.debugWireframe;var r=this._modelInstanceCollection._model;if(o(r)){var i=this._tileset.clippingPlanes;r.clippingPlanesOriginMatrix=this._tileset.clippingPlanesOriginMatrix,o(i)&&this._tile.clippingPlanesDirty&&(r._clippingPlanes=i.enabled&&this._tile._isClipped?i:void 0),o(i)&&o(r._clippingPlanes)&&r._clippingPlanes!==i&&(r._clippingPlanes=i)}this._modelInstanceCollection.update(t),n<t.commandList.length&&(t.passes.render||t.passes.pick)&&this._batchTable.addDerivedCommands(t,n,!1)},L.prototype.isDestroyed=function(){return!1},L.prototype.destroy=function(){return this._modelInstanceCollection=this._modelInstanceCollection&&this._modelInstanceCollection.destroy(),this._batchTable=this._batchTable&&this._batchTable.destroy(),l(this)},L});