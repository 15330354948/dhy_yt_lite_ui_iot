define([],function(){Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){let r,t;for(r=0,t=0;r<this.length;r++)t+=this[r];return t/this.length},Array.prototype.rep=function(r){return Array.apply(null,new Array(r)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(r,t){let e,o,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>t!=this[o][1]>t&&r<(this[o][0]-this[e][0])*(t-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};let r={};var t=function(r,t){let e,o=[0].rep(t*t);for(e=0;e<t;e++)o[e*t+e]=r;return o},e=function(r,t,e,o){let n,i,l=Array(e*o);for(n=0;n<e;n++)for(i=0;i<o;i++)l[n*o+i]=r[n*o+i]+t[n*o+i];return l},o=function(r,t,e,o,n){let i,l,a,f=Array(e*n);for(i=0;i<e;i++)for(l=0;l<n;l++)for(f[i*n+l]=0,a=0;a<o;a++)f[i*n+l]+=r[i*o+a]*t[a*n+l];return f},n=function(r,t){let e,o,n,i=Array(t);for(e=0;e<t;e++)i[e]=r[e*t+e];for(e=0;e<t;e++){for(o=0;o<e;o++)i[e]-=r[e*t+o]*r[e*t+o];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),o=e+1;o<t;o++){for(n=0;n<e;n++)r[o*t+e]-=r[o*t+n]*r[e*t+n];r[o*t+e]/=i[e]}}for(e=0;e<t;e++)r[e*t+e]=i[e];return!0},i=function(r,t){let e,o,n,i;for(e=0;e<t;e++)for(r[e*t+e]=1/r[e*t+e],o=e+1;o<t;o++){for(i=0,n=e;n<o;n++)i-=r[o*t+n]*r[n*t+e];r[o*t+e]=i/r[o*t+o]}for(e=0;e<t;e++)for(o=e+1;o<t;o++)r[e*t+o]=0;for(e=0;e<t;e++){for(r[e*t+e]*=r[e*t+e],n=e+1;n<t;n++)r[e*t+e]+=r[n*t+e]*r[n*t+e];for(o=e+1;o<t;o++)for(n=o;n<t;n++)r[e*t+o]+=r[n*t+e]*r[n*t+o]}for(e=0;e<t;e++)for(o=0;o<e;o++)r[e*t+o]=r[o*t+e]},l=function(r,t){let e,o,n,i,l,a,f,h,u,c,g,p=t,s=Array(t*t),y=Array(t),M=Array(t),d=Array(t);for(e=0;e<t;e++)for(i=0;i<t;i++)s[e*t+i]=e==i?1:0;for(i=0;i<t;i++)d[i]=0;for(e=0;e<t;e++){for(h=0,i=0;i<t;i++)if(1!=d[i])for(l=0;l<t;l++)0==d[l]&&Math.abs(r[i*t+l])>=h&&(h=Math.abs(r[i*t+l]),n=i,o=l);if(++d[o],n!=o){for(a=0;a<t;a++)g=r[n*t+a],r[n*t+a]=r[o*t+a],r[o*t+a]=g;for(a=0;a<p;a++)g=s[n*t+a],s[n*t+a]=s[o*t+a],s[o*t+a]=g}if(M[e]=n,y[e]=o,0==r[o*t+o])return!1;for(c=1/r[o*t+o],r[o*t+o]=1,a=0;a<t;a++)r[o*t+a]*=c;for(a=0;a<p;a++)s[o*t+a]*=c;for(f=0;f<t;f++)if(f!=o){for(u=r[f*t+o],r[f*t+o]=0,a=0;a<t;a++)r[f*t+a]-=r[o*t+a]*u;for(a=0;a<p;a++)s[f*t+a]-=s[o*t+a]*u}}for(a=t-1;a>=0;a--)if(M[a]!=y[a])for(l=0;l<t;l++)g=r[l*t+M[a]],r[l*t+M[a]]=r[l*t+y[a]],r[l*t+y[a]]=g;return!0},a=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*Math.pow(r/e,2)))},f=function(r,t,e,o,n){return t+(o-t)/e*(1-Math.exp(-1/n*(r/e)))},h=function(r,t,e,o,n){return r>e?t+(o-t)/e:t+(o-t)/e*(r/e*1.5-.5*Math.pow(r/e,3))};return r.train=function(r,u,c,g,p,s){let y={t:r,x:u,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(g){case"gaussian":y.model=a;break;case"exponential":y.model=f;break;case"spherical":y.model=h}let M,d,w,A,m=r.length,x=Array((m*m-m)/2);for(M=0,w=0;M<m;M++)for(d=0;d<M;d++,w++)x[w]=Array(2),x[w][0]=Math.pow(Math.pow(u[M]-u[d],2)+Math.pow(c[M]-c[d],2),.5),x[w][1]=Math.abs(r[M]-r[d]);x.sort(function(r,t){return r[0]-t[0]}),y.range=x[(m*m-m)/2-1][0];let b=(m*m-m)/2>30?30:(m*m-m)/2,z=y.range/b,v=[0].rep(b),k=[0].rep(b);if(b<30)for(A=0;A<b;A++)v[A]=x[A][0],k[A]=x[A][1];else{for(M=0,d=0,w=0,A=0;M<b&&d<(m*m-m)/2;M++,w=0){for(;x[d][0]<=(M+1)*z&&(v[A]+=x[d][0],k[A]+=x[d][1],w++,!(++d>=(m*m-m)/2)););w>0&&(v[A]/=w,k[A]/=w,A++)}if(A<2)return y}m=A,y.range=v[m-1]-v[0];let R=[1].rep(2*m),C=Array(m),K=y.A;for(M=0;M<m;M++){switch(g){case"gaussian":R[2*M+1]=1-Math.exp(-1/K*Math.pow(v[M]/y.range,2));break;case"exponential":R[2*M+1]=1-Math.exp(-1/K*v[M]/y.range);break;case"spherical":R[2*M+1]=v[M]/y.range*1.5-.5*Math.pow(v[M]/y.range,3)}C[M]=k[M]}let S=function(r,t,e){let o,n,i=Array(e*t);for(o=0;o<t;o++)for(n=0;n<e;n++)i[n*t+o]=r[o*e+n];return i}(R,m,2),q=o(S,R,2,m,2),N=(q=e(q,t(1/s,2),2,2)).slice(0);n(q,2)?i(q,2):(l(N,2),q=N);let O=o(o(q,S,2,2,m),C,2,m,1);y.nugget=O[0],y.sill=O[1]*y.range+y.nugget,y.n=u.length,m=u.length;let _=Array(m*m);for(M=0;M<m;M++){for(d=0;d<M;d++)_[M*m+d]=y.model(Math.pow(Math.pow(u[M]-u[d],2)+Math.pow(c[M]-c[d],2),.5),y.nugget,y.range,y.sill,y.A),_[d*m+M]=_[M*m+d];_[M*m+M]=y.model(0,y.nugget,y.range,y.sill,y.A)}let j=e(_,t(p,m),m,m),B=j.slice(0);n(j,m)?i(j,m):(l(B,m),j=B);var D=j.slice(0);let E=o(j,r,m,m,1);return y.K=D,y.M=E,y},r.predict=function(r,t,e){let n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(r-e.x[n],2)+Math.pow(t-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return o(i,e.M,1,e.n,1)[0]},r.variance=function(r,t,e){let n,i=Array(e.n);for(n=0;n<e.n;n++)i[n]=e.model(Math.pow(Math.pow(r-e.x[n],2)+Math.pow(t-e.y[n],2),.5),e.nugget,e.range,e.sill,e.A);return e.model(0,e.nugget,e.range,e.sill,e.A)+o(o(i,e.K,1,e.n,e.n),i,1,e.n,1)[0]},r.grid=function(t,e,o){let n,i,l,a=t.length;if(0==a)return;let f,h,u=[t[0][0][0],t[0][0][0]],c=[t[0][0][1],t[0][0][1]];for(n=0;n<a;n++)for(i=0;i<t[n].length;i++)t[n][i][0]<u[0]&&(u[0]=t[n][i][0]),t[n][i][0]>u[1]&&(u[1]=t[n][i][0]),t[n][i][1]<c[0]&&(c[0]=t[n][i][1]),t[n][i][1]>c[1]&&(c[1]=t[n][i][1]);let g=Array(2),p=Array(2),s=Array(2),y=Array(2),M=Math.ceil((u[1]-u[0])/o),d=Math.ceil((c[1]-c[0])/o),w=Array(M+1);for(n=0;n<=M;n++)w[n]=Array(d+1);for(n=0;n<a;n++){for(s[0]=t[n][0][0],s[1]=s[0],y[0]=t[n][0][1],y[1]=y[0],i=1;i<t[n].length;i++)t[n][i][0]<s[0]&&(s[0]=t[n][i][0]),t[n][i][0]>s[1]&&(s[1]=t[n][i][0]),t[n][i][1]<y[0]&&(y[0]=t[n][i][1]),t[n][i][1]>y[1]&&(y[1]=t[n][i][1]);for(g[0]=Math.floor((s[0]-(s[0]-u[0])%o-u[0])/o),g[1]=Math.ceil((s[1]-(s[1]-u[1])%o-u[0])/o),p[0]=Math.floor((y[0]-(y[0]-c[0])%o-c[0])/o),p[1]=Math.ceil((y[1]-(y[1]-c[1])%o-c[0])/o),i=g[0];i<=g[1];i++)for(l=p[0];l<=p[1];l++)f=u[0]+i*o,h=c[0]+l*o,t[n].pip(f,h)&&(w[i][l]=r.predict(f,h,e))}return w.xlim=u,w.ylim=c,w.zlim=[e.t.min(),e.t.max()],w.width=o,w},r.contour=function(r,t,e){return null},r.plot=function(r,t,e,o,n){let i=r.getContext("2d");i.clearRect(0,0,r.width,r.height);let l,a,f,h,u,c=[e[1]-e[0],o[1]-o[0],t.zlim[1]-t.zlim[0]],g=t.length,p=t[0].length,s=Math.ceil(t.width*r.width/(e[1]-e[0])),y=Math.ceil(t.width*r.height/(o[1]-o[0]));for(l=0;l<g;l++)for(a=0;a<p;a++)void 0!=t[l][a]&&(f=r.width*(l*t.width+t.xlim[0]-e[0])/c[0],h=r.height*(1-(a*t.width+t.ylim[0]-o[0])/c[1]),(u=(t[l][a]-t.zlim[0])/c[2])<0&&(u=0),u>1&&(u=1),i.fillStyle=n[Math.floor((n.length-1)*u)],i.fillRect(Math.round(f-s/2),Math.round(h-y/2),s,y))},r.plot_rainbow=function(r,t,e,o,n){let i=r.getContext("2d");i.clearRect(0,0,r.width,r.height);let l,a,f,h,u,c=[e[1]-e[0],o[1]-o[0],t.zlim[1]-t.zlim[0]],g=t.length,p=t[0].length,s=Math.ceil(t.width*r.width/(e[1]-e[0])),y=Math.ceil(t.width*r.height/(o[1]-o[0]));for(l=0;l<g;l++)for(a=0;a<p;a++)void 0!=t[l][a]&&(f=r.width*(l*t.width+t.xlim[0]-e[0])/c[0],h=r.height*(1-(a*t.width+t.ylim[0]-o[0])/c[1]),(u=(t[l][a]-t.zlim[0])/c[2])<0&&(u=0),u>1&&(u=1),i.fillStyle="#"+n.colourAt(u),i.fillRect(Math.round(f-s/2),Math.round(h-y/2),s,y))},r});