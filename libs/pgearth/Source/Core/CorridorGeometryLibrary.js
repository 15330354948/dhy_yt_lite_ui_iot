define(["./Cartesian3","./CornerType","./defined","./Math","./Matrix3","./PolylinePipeline","./PolylineVolumeGeometryLibrary","./Quaternion"],function(e,r,a,n,t,i,o,l){"use strict";var s={},u=new e,y=new e,c=new e,d=new e,m=[new e,new e],p=new e,g=new e,h=new e,f=new e,w=new e,z=new e,v=new e,x=new e,A=new e,B=new e,E=new l,S=new t;function D(a,i,o,s,c){var d,m=e.angleBetween(e.subtract(i,a,u),e.subtract(o,a,y)),p=s===r.BEVELED?1:Math.ceil(m/n.toRadians(5))+1,g=3*p,h=new Array(g);h[g-3]=o.x,h[g-2]=o.y,h[g-1]=o.z,d=c?t.fromQuaternion(l.fromAxisAngle(e.negate(a,u),m/p,E),S):t.fromQuaternion(l.fromAxisAngle(a,m/p,E),S);var f=0;i=e.clone(i,u);for(var w=0;w<p;w++)i=t.multiplyByVector(d,i,i),h[f++]=i.x,h[f++]=i.y,h[f++]=i.z;return h}function P(r,a,n,t){var i=u;return t?i=e.add(r,a,i):(a=e.negate(a,a),i=e.add(r,a,i)),[i.x,i.y,i.z,n.x,n.y,n.z]}function b(r,a,n,t){for(var i=new Array(r.length),o=new Array(r.length),l=e.multiplyByScalar(a,n,u),s=e.negate(l,y),m=0,p=r.length-1,g=0;g<r.length;g+=3){var h=e.fromArray(r,g,c),f=e.add(h,s,d);i[m++]=f.x,i[m++]=f.y,i[m++]=f.z;var w=e.add(h,l,d);o[p--]=w.z,o[p--]=w.y,o[p--]=w.x}return t.push(i,o),t}s.addAttribute=function(e,r,n,t){var i=r.x,o=r.y,l=r.z;a(n)&&(e[n]=i,e[n+1]=o,e[n+2]=l),a(t)&&(e[t]=l,e[t-1]=o,e[t-2]=i)};var N=new e,O=new e;return s.computePositions=function(a){var t=a.granularity,l=a.positions,s=a.ellipsoid,y=a.width/2,c=a.cornerType,d=a.saveAttributes,E=p,S=g,R=h,L=f,M=w,U=z,V=v,Q=x,T=A,C=B,G=[],I=d?[]:void 0,q=d?[]:void 0,j=l[0],k=l[1];S=e.normalize(e.subtract(k,j,S),S),E=s.geodeticSurfaceNormal(j,E),L=e.normalize(e.cross(E,S,L),L),d&&(I.push(L.x,L.y,L.z),q.push(E.x,E.y,E.z)),V=e.clone(j,V),j=k,R=e.negate(S,R);var F,H,J=[],K=l.length;for(F=1;F<K-1;F++){E=s.geodeticSurfaceNormal(j,E),k=l[F+1],S=e.normalize(e.subtract(k,j,S),S),M=e.normalize(e.add(S,R,M),M);var W=e.multiplyByScalar(E,e.dot(S,E),N);e.subtract(S,W,W),e.normalize(W,W);var X=e.multiplyByScalar(E,e.dot(R,E),O);if(e.subtract(R,X,X),e.normalize(X,X),!n.equalsEpsilon(Math.abs(e.dot(W,X)),1,n.EPSILON7)){M=e.cross(M,E,M),M=e.cross(E,M,M),M=e.normalize(M,M);var Y=y/Math.max(.25,e.magnitude(e.cross(M,R,u))),Z=o.angleIsGreaterThanPi(S,R,j,s);M=e.multiplyByScalar(M,Y,M),Z?(Q=e.add(j,M,Q),C=e.add(Q,e.multiplyByScalar(L,y,C),C),T=e.add(Q,e.multiplyByScalar(L,2*y,T),T),m[0]=e.clone(V,m[0]),m[1]=e.clone(C,m[1]),G=b(i.generateArc({positions:m,granularity:t,ellipsoid:s}),L,y,G),d&&(I.push(L.x,L.y,L.z),q.push(E.x,E.y,E.z)),U=e.clone(T,U),L=e.normalize(e.cross(E,S,L),L),T=e.add(Q,e.multiplyByScalar(L,2*y,T),T),V=e.add(Q,e.multiplyByScalar(L,y,V),V),c===r.ROUNDED||c===r.BEVELED?J.push({leftPositions:D(Q,U,T,c,Z)}):J.push({leftPositions:P(j,e.negate(M,M),T,Z)})):(T=e.add(j,M,T),C=e.add(T,e.negate(e.multiplyByScalar(L,y,C),C),C),Q=e.add(T,e.negate(e.multiplyByScalar(L,2*y,Q),Q),Q),m[0]=e.clone(V,m[0]),m[1]=e.clone(C,m[1]),G=b(i.generateArc({positions:m,granularity:t,ellipsoid:s}),L,y,G),d&&(I.push(L.x,L.y,L.z),q.push(E.x,E.y,E.z)),U=e.clone(Q,U),L=e.normalize(e.cross(E,S,L),L),Q=e.add(T,e.negate(e.multiplyByScalar(L,2*y,Q),Q),Q),V=e.add(T,e.negate(e.multiplyByScalar(L,y,V),V),V),c===r.ROUNDED||c===r.BEVELED?J.push({rightPositions:D(T,U,Q,c,Z)}):J.push({rightPositions:P(j,M,Q,Z)})),R=e.negate(S,R)}j=k}return E=s.geodeticSurfaceNormal(j,E),m[0]=e.clone(V,m[0]),m[1]=e.clone(j,m[1]),G=b(i.generateArc({positions:m,granularity:t,ellipsoid:s}),L,y,G),d&&(I.push(L.x,L.y,L.z),q.push(E.x,E.y,E.z)),c===r.ROUNDED&&(H=function(a){var n=p,t=g,i=h,o=a[1];t=e.fromArray(a[1],o.length-3,t),i=e.fromArray(a[0],0,i);var l=D(n=e.midpoint(t,i,n),t,i,r.ROUNDED,!1),s=a.length-1,u=a[s-1];return o=a[s],t=e.fromArray(u,u.length-3,t),i=e.fromArray(o,0,i),[l,D(n=e.midpoint(t,i,n),t,i,r.ROUNDED,!1)]}(G)),{positions:G,corners:J,lefts:I,normals:q,endPositions:H}},s});