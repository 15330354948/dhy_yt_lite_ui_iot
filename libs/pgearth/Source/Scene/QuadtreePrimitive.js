define(["../Core/Cartesian3","../Core/Cartographic","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Event","../Core/getTimestamp","../Core/Math","../Core/Matrix4","../Core/OrthographicFrustum","../Core/OrthographicOffCenterFrustum","../Core/Ray","../Core/Rectangle","../Core/Visibility","./QuadtreeOccluders","./QuadtreeTile","./QuadtreeTileLoadState","./SceneMode","./TileReplacementQueue","./TileSelectionResult"],function(e,t,i,r,a,l,n,o,s,d,u,h,c,m,g,p,_,v,R,f,C){"use strict";function L(e){if(!r(e)||!r(e.tileProvider))throw new l("options.tileProvider is required.");if(r(e.tileProvider.quadtree))throw new l("A QuadtreeTileProvider can only be used with a single QuadtreePrimitive");this._tileProvider=e.tileProvider,this._tileProvider.quadtree=this,this._debug={enableDebugOutput:!1,maxDepth:0,maxDepthVisited:0,tilesVisited:0,tilesCulled:0,tilesRendered:0,tilesWaitingForChildren:0,lastMaxDepth:-1,lastMaxDepthVisited:-1,lastTilesVisited:-1,lastTilesCulled:-1,lastTilesRendered:-1,lastTilesWaitingForChildren:-1,suspendLodUpdate:!1};var t=this._tileProvider.tilingScheme.ellipsoid;this._tilesToRender=[],this._tileLoadQueueHigh=[],this._tileLoadQueueMedium=[],this._tileLoadQueueLow=[],this._tileReplacementQueue=new f,this._levelZeroTiles=void 0,this._loadQueueTimeSlice=5,this._tilesInvalidated=!1,this._addHeightCallbacks=[],this._removeHeightCallbacks=[],this._tileToUpdateHeights=[],this._lastTileIndex=0,this._updateHeightsTimeSlice=2,this._cameraPositionCartographic=void 0,this._cameraReferenceFrameOriginCartographic=void 0,this.maximumScreenSpaceError=i(e.maximumScreenSpaceError,2),this.tileCacheSize=i(e.tileCacheSize,100),this.loadingDescendantLimit=20,this.preloadAncestors=!0,this.preloadSiblings=!1,this._occluders=new p({ellipsoid:t}),this._tileLoadProgressEvent=new n,this._lastTileLoadQueueLength=0,this._lastSelectionFrameNumber=void 0}function b(e){var t=e._debug;t.maxDepth=0,t.maxDepthVisited=0,t.tilesVisited=0,t.tilesCulled=0,t.tilesRendered=0,t.tilesWaitingForChildren=0,e._tileLoadQueueHigh.length=0,e._tileLoadQueueMedium.length=0,e._tileLoadQueueLow.length=0}var T;a(L.prototype,{tileProvider:{get:function(){return this._tileProvider}},tileLoadProgressEvent:{get:function(){return this._tileLoadProgressEvent}},occluders:{get:function(){return this._occluders}}}),L.prototype.invalidateAllTiles=function(){this._tilesInvalidated=!0},L.prototype.forEachLoadedTile=function(e){for(var t=this._tileReplacementQueue.head;r(t);)t.state!==v.START&&e(t),t=t.replacementNext},L.prototype.forEachRenderedTile=function(e){for(var t=this._tilesToRender,i=0,r=t.length;i<r;++i)e(t[i])},L.prototype.updateHeight=function(e,t){var i=this,r={positionOnEllipsoidSurface:void 0,positionCartographic:e,level:-1,callback:t,removeFunc:function(){for(var e=i._addHeightCallbacks,t=e.length,a=0;a<t;++a)if(e[a]===r){e.splice(a,1);break}i._removeHeightCallbacks.push(r)}};return i._addHeightCallbacks.push(r),r.removeFunc},L.prototype.update=function(e){r(this._tileProvider.update)&&this._tileProvider.update(e)},L.prototype.beginFrame=function(e){e.passes.render&&(this._tilesInvalidated&&(!function(e){var t=e._tileReplacementQueue;t.head=void 0,t.tail=void 0,t.count=0,b(e);var i=e._levelZeroTiles;if(r(i))for(var a=0;a<i.length;++a){for(var l=i[a].customData,n=l.length,o=0;o<n;++o){var s=l[o];s.level=0,e._addHeightCallbacks.push(s)}i[a].freeResources()}e._levelZeroTiles=void 0,e._tileProvider.cancelReprojections()}(this),this._tilesInvalidated=!1),this._tileProvider.initialize(e),b(this),this._debug.suspendLodUpdate||this._tileReplacementQueue.markStartOfRenderFrame())},L.prototype.render=function(e){var t=e.passes,i=this._tileProvider;t.render&&(i.beginUpdate(e),function(e,t){var i,a=e._debug;if(a.suspendLodUpdate)return;e._tilesToRender.length=0;var l,n=e._tileProvider;if(!r(e._levelZeroTiles)){if(!n.ready)return;var o=n.tilingScheme;e._levelZeroTiles=_.createLevelZeroTiles(o);var s=e._levelZeroTiles.length;if(F.length<s)for(F=new Array(s),i=0;i<s;++i)void 0===F[i]&&(F[i]=new y)}e._occluders.ellipsoid.cameraPosition=t.camera.positionWC;var u=e._levelZeroTiles,h=u.length>1?e._occluders:void 0;T=t.camera.positionCartographic,u.sort(D);var c,m=e._addHeightCallbacks,g=e._removeHeightCallbacks,p=t.frameNumber;if(m.length>0||g.length>0){for(i=0,c=u.length;i<c;++i)(l=u[i])._updateCustomData(p,m,g);m.length=0,g.length=0}var v=t.camera;e._cameraPositionCartographic=v.positionCartographic;var R=d.getTranslation(v.transform,S);for(e._cameraReferenceFrameOriginCartographic=e.tileProvider.tilingScheme.ellipsoid.cartesianToCartographic(R,e._cameraReferenceFrameOriginCartographic),i=0,c=u.length;i<c;++i)l=u[i],e._tileReplacementQueue.markTileRendered(l),l.renderable?H(e,l,n,t,h,!1,F[i]):(P(e,e._tileLoadQueueHigh,l,t),++a.tilesWaitingForChildren);e._lastSelectionFrameNumber=p}(this,e),function(e,t){for(var i=e._tileProvider,r=e._tilesToRender,a=0,l=r.length;a<l;++a){var n=r[a];i.showTileThisFrame(n,t)}}(this,e),i.endUpdate(e)),t.pick&&this._tilesToRender.length>0&&i.updateForPick(e)},L.prototype.endFrame=function(a){a.passes.render&&a.mode!==R.MORPHING&&(function(e,t){var i=e._tileLoadQueueHigh,r=e._tileLoadQueueMedium,a=e._tileLoadQueueLow;if(0===i.length&&0===r.length&&0===a.length)return;e._tileReplacementQueue.trimTiles(e.tileCacheSize);var l=o()+e._loadQueueTimeSlice,n=e._tileProvider,s=k(e,t,n,l,i,!1);s=k(e,t,n,l,r,s),k(e,t,n,l,a,s)}(this,a),function(a,l){if(!a.tileProvider.ready)return;var n=A;n.length=0;var s,d=a._tileToUpdateHeights,u=a._tileProvider.terrainProvider,h=o(),c=a._updateHeightsTimeSlice,g=h+c,p=l.mode,_=l.mapProjection,v=a.tileProvider.tilingScheme.ellipsoid;for(;d.length>0;){var f=d[0];if(r(f.data)&&r(f.data.mesh)){var L=f.customData,b=L.length,T=!1;for(s=a._lastTileIndex;s<b;++s){var E=L[s];if(f.level>E.level){if(r(E.positionOnEllipsoidSurface)||(E.positionOnEllipsoidSurface=e.fromRadians(E.positionCartographic.longitude,E.positionCartographic.latitude,0,v)),p===R.SCENE3D){var D=v.geodeticSurfaceNormal(E.positionOnEllipsoidSurface,O.direction),S=v.getSurfaceNormalIntersectionWithZAxis(E.positionOnEllipsoidSurface,11500,O.origin);if(!r(S)){var F=Math.min(i(f.data.minimumHeight,0),-11500),P=e.multiplyByScalar(D,Math.abs(F)+1,V);e.subtract(E.positionOnEllipsoidSurface,P,O.origin)}}else t.clone(E.positionCartographic,U),U.height=-11500,_.project(U,V),e.fromElements(V.z,V.x,V.y,V),e.clone(V,O.origin),e.clone(e.UNIT_X,O.direction);var y=f.data.pick(O,p,_,!1,V);r(y)&&(E.callback(y),E.level=f.level)}else if(f.level===E.level){for(var Q,N=f.children,x=N.length,w=0;w<x&&(Q=N[w],!m.contains(Q.rectangle,E.positionCartographic));++w);var H=u.getTileDataAvailable(Q.x,Q.y,Q.level),W=f.parent;(r(H)&&!H||r(W)&&r(W.data)&&r(W.data.terrainData)&&!W.data.terrainData.isChildAvailable(W.x,W.y,Q.x,Q.y))&&E.removeFunc()}if(o()>=g){T=!0;break}}if(T){a._lastTileIndex=s;break}a._lastTileIndex=0,d.shift()}else{var M=f._lastSelectionResultFrame===a._lastSelectionFrameNumber?f._lastSelectionResult:C.NONE;M!==C.RENDERED&&M!==C.CULLED_BUT_NEEDED||n.push(f),d.shift(),a._lastTileIndex=0}}for(s=0;s<n.length;s++)d.push(n[s])}(this,a),function(e,t){var i=e._tileLoadQueueHigh.length+e._tileLoadQueueMedium.length+e._tileLoadQueueLow.length;(i!==e._lastTileLoadQueueLength||e._tilesInvalidated)&&(t.afterRender.push(n.prototype.raiseEvent.bind(e._tileLoadProgressEvent,i)),e._lastTileLoadQueueLength=i);var r=e._debug;r.enableDebugOutput&&!r.suspendLodUpdate&&(r.maxDepth=e._tilesToRender.reduce(function(e,t){return Math.max(e,t.level)},-1),r.tilesRendered=e._tilesToRender.length,r.tilesVisited===r.lastTilesVisited&&r.tilesRendered===r.lastTilesRendered&&r.tilesCulled===r.lastTilesCulled&&r.maxDepth===r.lastMaxDepth&&r.tilesWaitingForChildren===r.lastTilesWaitingForChildren&&r.maxDepthVisited===r.lastMaxDepthVisited||(console.log("Visited "+r.tilesVisited+", Rendered: "+r.tilesRendered+", Culled: "+r.tilesCulled+", Max Depth Rendered: "+r.maxDepth+", Max Depth Visited: "+r.maxDepthVisited+", Waiting for children: "+r.tilesWaitingForChildren),r.lastTilesVisited=r.tilesVisited,r.lastTilesRendered=r.tilesRendered,r.lastTilesCulled=r.tilesCulled,r.lastMaxDepth=r.maxDepth,r.lastTilesWaitingForChildren=r.tilesWaitingForChildren,r.lastMaxDepthVisited=r.maxDepthVisited))}(this,a))},L.prototype.isDestroyed=function(){return!1},L.prototype.destroy=function(){this._tileProvider=this._tileProvider&&this._tileProvider.destroy()};var E=new t;function D(e,t){var i=m.center(e.rectangle,E),r=i.longitude-T.longitude,a=i.latitude-T.latitude,l=(i=m.center(t.rectangle,E)).longitude-T.longitude,n=i.latitude-T.latitude;return r*r+a*a-(l*l+n*n)}var S=new e,F=[];function P(e,t,i,r){i.needsLoading&&(void 0!==e.tileProvider.computeTileLoadPriority&&(i._loadPriority=e.tileProvider.computeTileLoadPriority(i,r)),t.push(i))}function y(){this.allAreRenderable=!0,this.anyWereRenderedLastFrame=!1,this.notYetRenderableCount=0}function Q(){this.southwest=new y,this.southeast=new y,this.northwest=new y,this.northeast=new y}Q.prototype.combine=function(e){var t=this.southwest,i=this.southeast,r=this.northwest,a=this.northeast;e.allAreRenderable=t.allAreRenderable&&i.allAreRenderable&&r.allAreRenderable&&a.allAreRenderable,e.anyWereRenderedLastFrame=t.anyWereRenderedLastFrame||i.anyWereRenderedLastFrame||r.anyWereRenderedLastFrame||a.anyWereRenderedLastFrame,e.notYetRenderableCount=t.notYetRenderableCount+i.notYetRenderableCount+r.notYetRenderableCount+a.notYetRenderableCount};for(var N=new Array(30),x=0;x<N.length;++x)N[x]=new Q;function w(e,t,i,a,l){var n=e._debug;++n.tilesVisited,e._tileReplacementQueue.markTileRendered(i),i._updateCustomData(t.frameNumber),i.level>n.maxDepthVisited&&(n.maxDepthVisited=i.level);var o=function(e,t,i){if(t.mode===R.SCENE2D||t.camera.frustum instanceof u||t.camera.frustum instanceof h)return function(e,t,i){var a=t.camera.frustum;r(a._offCenterFrustum)&&(a=a._offCenterFrustum);var l=t.context,n=l.drawingBufferWidth,o=l.drawingBufferHeight,d=e._tileProvider.getLevelMaximumGeometricError(i.level),u=Math.max(a.top-a.bottom,a.right-a.left)/Math.max(n,o),h=d/u;t.fog.enabled&&t.mode!==R.SCENE2D&&(h-=s.fog(i._distance,t.fog.density)*t.fog.sse);return h}(e,t,i);var a=e._tileProvider.getLevelMaximumGeometricError(i.level),l=i._distance,n=t.context.drawingBufferHeight,o=t.camera.frustum.sseDenominator,d=a*n/(l*o);t.fog.enabled&&(d-=s.fog(l,t.fog.density)*t.fog.sse);return d}(e,t,i)<e.maximumScreenSpaceError,d=i.southwestChild,c=i.southeastChild,m=i.northwestChild,g=i.northeastChild,p=e._lastSelectionFrameNumber,_=i._lastSelectionResultFrame===p?i._lastSelectionResult:C.NONE,f=e.tileProvider;if(o||a){var L=C.originalResult(_)===C.RENDERED,b=C.originalResult(_)===C.CULLED||_===C.NONE,T=i.state===v.DONE,E=L||b||T;if(E||r(f.canRenderWithoutLosingDetail)&&(E=f.canRenderWithoutLosingDetail(i)),E)return o&&P(e,e._tileLoadQueueMedium,i,t),W(e,i),l.allAreRenderable=i.renderable,l.anyWereRenderedLastFrame=_===C.RENDERED,l.notYetRenderableCount=i.renderable?0:1,i._lastSelectionResultFrame=t.frameNumber,i._lastSelectionResult=C.RENDERED,void(l.anyWereRenderedLastFrame||e._tileToUpdateHeights.push(i));a=!0,o&&P(e,e._tileLoadQueueHigh,i,t)}if(f.canRefine(i)){if(d.upsampledFromParent&&c.upsampledFromParent&&m.upsampledFromParent&&g.upsampledFromParent)return W(e,i),P(e,e._tileLoadQueueMedium,i,t),e._tileReplacementQueue.markTileRendered(d),e._tileReplacementQueue.markTileRendered(c),e._tileReplacementQueue.markTileRendered(m),e._tileReplacementQueue.markTileRendered(g),l.allAreRenderable=i.renderable,l.anyWereRenderedLastFrame=_===C.RENDERED,l.notYetRenderableCount=i.renderable?0:1,i._lastSelectionResultFrame=t.frameNumber,i._lastSelectionResult=C.RENDERED,void(l.anyWereRenderedLastFrame||e._tileToUpdateHeights.push(i));i._lastSelectionResultFrame=t.frameNumber,i._lastSelectionResult=C.REFINED;var D=e._tilesToRender.length,S=e._tileLoadQueueLow.length,F=e._tileLoadQueueMedium.length,y=e._tileLoadQueueHigh.length,Q=e._tileToUpdateHeights.length;if(function(e,t,i,r,a,l,n,o){var s=l.camera.positionCartographic,d=e._tileProvider,u=e._occluders,h=N[t.level],c=h.southwest,m=h.southeast,g=h.northwest,p=h.northeast;s.longitude<t.rectangle.east?s.latitude<t.rectangle.north?(H(e,t,d,l,u,n,c),H(e,i,d,l,u,n,m),H(e,r,d,l,u,n,g),H(e,a,d,l,u,n,p)):(H(e,r,d,l,u,n,g),H(e,t,d,l,u,n,c),H(e,a,d,l,u,n,p),H(e,i,d,l,u,n,m)):s.latitude<t.rectangle.north?(H(e,i,d,l,u,n,m),H(e,t,d,l,u,n,c),H(e,a,d,l,u,n,p),H(e,r,d,l,u,n,g)):(H(e,a,d,l,u,n,p),H(e,r,d,l,u,n,g),H(e,i,d,l,u,n,m),H(e,t,d,l,u,n,c));h.combine(o)}(e,d,c,m,g,t,a,l),D!==e._tilesToRender.length){var x=l.allAreRenderable,w=l.anyWereRenderedLastFrame,M=l.notYetRenderableCount,k=!1;if(!x&&!w){for(var O=e._tilesToRender,U=D;U<O.length;++U)for(var V=O[U];void 0!==V&&V._lastSelectionResult!==C.KICKED&&V!==i;)V._lastSelectionResult=C.kick(V._lastSelectionResult),V=V.parent;e._tilesToRender.length=D,e._tileToUpdateHeights.length=Q,W(e,i),i._lastSelectionResult=C.RENDERED;var A=_===C.RENDERED;!A&&M>e.loadingDescendantLimit&&(e._tileLoadQueueLow.length=S,e._tileLoadQueueMedium.length=F,e._tileLoadQueueHigh.length=y,P(e,e._tileLoadQueueMedium,i,t),l.notYetRenderableCount=i.renderable?0:1,k=!0),l.allAreRenderable=i.renderable,l.anyWereRenderedLastFrame=A,A||e._tileToUpdateHeights.push(i),++n.tilesWaitingForChildren}e.preloadAncestors&&!k&&P(e,e._tileLoadQueueLow,i,t)}}else i._lastSelectionResultFrame=t.frameNumber,i._lastSelectionResult=C.RENDERED,W(e,i),P(e,e._tileLoadQueueHigh,i,t),l.allAreRenderable=i.renderable,l.anyWereRenderedLastFrame=_===C.RENDERED,l.notYetRenderableCount=i.renderable?0:1}function H(e,t,i,a,l,n,o){if(i.computeTileVisibility(t,a,l)!==g.NONE)return w(e,a,t,n,o);if(++e._debug.tilesCulled,e._tileReplacementQueue.markTileRendered(t),o.allAreRenderable=!0,o.anyWereRenderedLastFrame=!1,o.notYetRenderableCount=0,function(e,t){var i=t.rectangle;return r(e._cameraPositionCartographic)&&m.contains(i,e._cameraPositionCartographic)||r(e._cameraReferenceFrameOriginCartographic)&&m.contains(i,e._cameraReferenceFrameOriginCartographic)}(e,t)){r(t.data)&&r(t.data.vertexArray)||P(e,e._tileLoadQueueMedium,t,a);var s=e._lastSelectionFrameNumber,d=t._lastSelectionResultFrame===s?t._lastSelectionResult:C.NONE;d!==C.CULLED_BUT_NEEDED&&d!==C.RENDERED&&e._tileToUpdateHeights.push(t),t._lastSelectionResult=C.CULLED_BUT_NEEDED}else e.preloadSiblings||0===t.level?(P(e,e._tileLoadQueueLow,t,a),t._lastSelectionResult=C.CULLED):t._lastSelectionResult=C.CULLED;t._lastSelectionResultFrame=a.frameNumber}function W(e,t){e._tilesToRender.push(t)}function M(e,t){return e._loadPriority-t._loadPriority}function k(e,t,i,r,a,l){void 0!==i.computeTileLoadPriority&&a.sort(M);for(var n=0,s=a.length;n<s&&(o()<r||!l);++n){var d=a[n];e._tileReplacementQueue.markTileRendered(d),i.loadTile(t,d),l=!0}return l}var O=new c,U=new t,V=new e,A=[];return L});