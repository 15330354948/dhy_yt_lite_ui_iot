define(["../../../Core/Cartesian2","../../../Core/Cartesian3","../../../Core/Quaternion","../../../Core/defined","../../../Core/destroyObject","../../../Core/defineProperties","../../../Core/ScreenSpaceEventType","../../../Core/ScreenSpaceEventHandler","../../../Core/Ellipsoid","../../../Core/Math","../../../Core/Cartographic","../../../Core/Matrix4","../../../Core/Matrix3","../../../Core/BoundingSphere","../../../Core/PixelFormat","../../../Core/Color","../../../Core/Transforms","../../../Core/GeometryInstance","../../../Core/HeadingPitchRoll","../../../Core/BoxGeometry","../../../Core/CylinderGeometry","../../../Core/BoundingRectangle","../../../Renderer/Pass","../../../Renderer/RenderState","../../../Scene/Material","../../../Scene/Primitive","../../../Scene/MaterialAppearance","../../../Scene/DebugModelMatrixPrimitive","../../../DataSources/CallbackProperty","../../../ThirdParty/knockout","require","../../core/CommonUtil"],function(e,t,i,n,o,r,d,s,l,a,c,_,p,u,b,h,m,O,v,y,j,g,f,x,w,D,P,E,S,T,L,z){"use strict";var C={Edit_Model_Move:0,Edit_Model_Rotate:1,Edit_Model_Zoom:2,Edit_Model_EditAll:3,Edit_Model_NONE:4},B=[];function M(o,r){this._viewer=o;var u=this._viewer.scene.canvas;this._scene=o.scene,this._canvas=u,this._primitive=void 0,this._primitiveBoundingSpherePosition=void 0,this._pickObject=null,this._ellipsoid=null,this._editAction=C.Edit_Model_NONE,this.editObject=null,this._position=null,this._rotation=null,this._scale=null,this.showTooltip=!0,this.rotateLMZ=null,this._tooltip=r.tooltip,this._axisPrimitive=new E({length:length}),this._cylinderPrimitive=void 0,this._bigBoxPrimitive=void 0,this._bigBoxEntity={dimensions:t.ZERO,position:t.ZERO,orientation:i.IDENTITY},this._showAxis=!1,this._showCylinder=!1,this._showBigBox=!1,this._screenSpaceEventHandler,function(i){var o=i._scene,r=i._screenSpaceEventHandler=new s(o.canvas);r.setInputAction(function(e){if(n(i.editObject)){var t=i._scene.pick(e.position);if(n(t)){if(n(t.id)&&("mainBox"===t.id||"cylinder"===t.id||"littleBox"===t.id._name||"ring"===t.id._name))return;if(i._primitive=n(t.collection)?t.collection:t.primitive,n(t.primitive)&&n(t.primitive._boundingSphere))switch(i._editAction){case C.Edit_Model_Move:R(i),i._showCylinder=!0,i._showAxis=!0;break;case C.Edit_Model_Rotate:R(i),N(i),i._showAxis=!0,i._showCylinder=!1;break;case C.Edit_Model_Zoom:R(i),F(i),i._showAxis=!0,i._showCylinder=!1;break;case C.Edit_Model_EditAll:R(i),F(i),N(i),i._showCylinder=!0,i._showAxis=!0;break;case C.Edit_Model_NONE:R(i),i._showAxis=!1,i._showCylinder=!1}}else R(i),i._showAxis=!1,i._showCylinder=!1,i._editAction=C.Edit_Model_NONE}},d.LEFT_CLICK),r.setInputAction(function(e){if(i._pickObject=i._scene.pick(e.position),n(i.editObject)&&n(i._pickObject)&&n(i._pickObject.id))if("mainBox"===i._pickObject.id){o._screenSpaceCameraController.enableInputs=!1;var r=i._viewer.scene.pickPosition(e.position);!function(e,i){var n=t.magnitude(i),o=new t;o.x=o.y=o.z=n;var r=new l;e._ellipsoid=l.fromCartesian3(o,r)}(i,r)}else"cylinder"===i._pickObject.id?o._screenSpaceCameraController.enableInputs=!1:"littleBox"===i._pickObject.id._name?o._screenSpaceCameraController.enableInputs=!1:"ring"===i._pickObject.id._name&&(o._screenSpaceCameraController.enableInputs=!1)},d.LEFT_DOWN),r.setInputAction(function(e){if(n(i.editObject)){for(var t=0;t<B.length;t++)B[t].show=!0;i._pickObject=null,o._screenSpaceCameraController.enableInputs=!0}},d.LEFT_UP);var _=0;r.setInputAction(function(o){if(n(i._editObject)&&i._editAction!==C.Edit_Model_NONE){var r,d,s,l,p,u,b,h,O,y,j=i._scene.pick(o.endPosition);if(i.showTooltip&&void 0!==j?void 0!==j.id&&("cylinder"===j.id?i._tooltip.showAt(o.endPosition,"升降"):"mainBox"===j.id?i._tooltip.showAt(o.endPosition,"平移"):"ring"===j.id._name?i._tooltip.showAt(o.endPosition,"旋转"):"littleBox"===j.id._name&&i._tooltip.showAt(o.endPosition,"缩放")):i._tooltip.setVisible(!1),n(i._pickObject)&&n(i._pickObject.id))if("mainBox"===i._pickObject.id){var f=i._viewer.camera.pickEllipsoid(o.startPosition,i._ellipsoid),x=i._viewer.camera.pickEllipsoid(o.endPosition,i._ellipsoid);if(n(x)){var w=function(e,t,i){var n=e._ellipsoid.cartesianToCartographic(t),o=a.toDegrees(n.longitude),r=a.toDegrees(n.latitude),d=e._ellipsoid.cartesianToCartographic(i),s=a.toDegrees(d.longitude)-o,l=a.toDegrees(d.latitude)-r,c=[];return c.push(s),c.push(l),c}(i,f,x);if(null!==i.editObject&&"modelLOD"===i.editObject._type)r=parseFloat(i.editObject._position.x),d=parseFloat(i.editObject._position.y),s=parseFloat(i.editObject._position.z),r+=w[0],d+=w[1],i.position=new t(r,d,s),i._axisPrimitive.modelMatrix=i.editObject.getLocalViewMatrix(),i.showTooltip&&i._tooltip.showAt(o.endPosition,null,"经度:"+r.toFixed(10),"纬度:"+d.toFixed(10),"高度:"+s.toFixed(2));else if(null!==i.editObject&&"pageLOD"===i.editObject._type)r=parseFloat(i.editObject._position.x),d=parseFloat(i.editObject._position.y),s=parseFloat(i.editObject._position.z),r+=w[0],d+=w[1],i.position=new t(r,d,s),i.showTooltip&&i._tooltip.showAt(o.endPosition,null,"经度:"+r,"纬度:"+d,"高度:"+s);else if(null!==i.editObject&&"PGEarth3DTileset"===i.editObject._type)(l=i.position.clone()).x+=w[0],l.y+=w[1],i.position=l,i.showTooltip&&i._tooltip.showAt(o.endPosition,null,"经度:"+l.x.toFixed(10),"纬度:"+l.y.toFixed(10),"高度:"+l.z.toFixed(2));else{l=i._primitive.id.position._value;var D=c.fromCartesian(l),P=a.toDegrees(D.longitude),E=a.toDegrees(D.latitude);i._primitive.id.position._value=t.fromDegrees(P+w[0],E+w[1],D.height)}for(y=0;y<B.length;y++)B[y].show=!1}}else if("cylinder"===i._pickObject.id){for(y=0;y<B.length;y++)B[y].show=!1;var S,T;if(null===i.editObject||"modelLOD"!==i.editObject._type&&"pageLOD"!==i.editObject._type)if(null!==i.editObject&&"PGEarth3DTileset"===i.editObject._type){var L=i.editObject._root._boundingVolume.boundingVolume.center;if(l=i.position.clone(),T=A(i,L),l.z-=T*(o.endPosition.y-o.startPosition.y),l.z<-1e3&&(l.z=-1e3),!isFinite(l.z))return;console.log(l),i.position=l,i.showTooltip&&i._tooltip.showAt(o.endPosition,null,"经度:"+l.x.toFixed(10),"纬度:"+l.y.toFixed(10),"高度:"+l.z.toFixed(2))}else{l=i._primitive.id.position._value.clone();var M=c.fromCartesian(l);r=a.toDegrees(M.longitude),d=a.toDegrees(M.latitude),s=M.height,S=t.fromDegrees(r,d,s),T=A(i,S),i._primitive.id.position._value.z=i._primitive.id.position._value.z-T*(o.endPosition.y-o.startPosition.y)}else{if(r=parseFloat(i.editObject._position.x),d=parseFloat(i.editObject._position.y),s=parseFloat(i.editObject._position.z),"modelLOD"===i.editObject._type?S=t.fromDegrees(r,d,s):"pageLOD"===i.editObject._type&&(S=i.editObject.tileBoundingSphere.center.clone()),(s-=(T=A(i,S))*(o.endPosition.y-o.startPosition.y))<-1e3&&(s=-1e3),!isFinite(s))return;i.position=new t(r,d,s),i.showTooltip&&i._tooltip.showAt(o.endPosition,null,"经度:"+r.toFixed(10),"纬度:"+d.toFixed(10),"高度:"+s.toFixed(2))}}else if("ring"===i._pickObject.id._name){for(y=0;y<B.length;y++)"ring"!==B[y]._name&&(B[y].show=!1);if(null===i.editObject||"modelLOD"!==i.editObject._type&&"PGEarth3DTileset"!==i.editObject._type){o.startPosition.x<o.endPosition.x?_-=1:o.startPosition.x>o.endPosition.x&&(_+=1),360<=_?_-=360:_<0&&(_+=360);var G=m.headingPitchRollQuaternion(i._primitive.id.position._value,new v(a.toRadians(_),0,0));for(i._primitive.id.orientation._value=G,y=0;y<B.length;y++)B[y].orientation=G}else{var N=K(i._bigBoxEntity),F=Z(Y(H(-1,-1,-1,i,N)),Y(H(1,-1,-1,i,N)),Y(H(1,1,-1,i,N)),Y(H(-1,1,-1,i,N)),Y(H(-1,-1,1,i,N)),Y(H(1,-1,1,i,N)),Y(H(1,1,1,i,N)),Y(H(-1,1,1,i,N))),R=t.fromDegrees(F.x,F.y,F.z);(h=new g).x=0,h.y=0,h.width=i._scene._context.drawingBufferWidth,h.height=i._scene._context.drawingBufferHeight,b=z.project(R,i._scene.camera,h),(p=new t).x=o.endPosition.x-b.x,p.y=document.body.clientHeight-o.endPosition.y-b.y,p.z=0,(u=new t).x=o.startPosition.x-b.x,u.y=document.body.clientHeight-o.startPosition.y-b.y,u.z=0;var I,k=new t,W=t.cross(p,u,k),V=t.dot(p,u),q=180/Math.PI*Math.acos(V/Math.sqrt((p.x*p.x+p.y*p.y)*(u.x*u.x+u.y*u.y)));I=i.rotation.clone(),"modelLOD"===i.editObject._type?(W.z<0?I.z+=q:I.z-=q,I.z<0?I.z+=360:360<I.z&&(I.z-=360),i.rotation=I,i.showTooltip&&i._tooltip.showAt(o.endPosition,"正北夹角:"+(180*i.editObject.getRotate().z/Math.PI).toFixed(2))):"PGEarth3DTileset"===i.editObject._type&&(I=i.rotation.clone(),W.z<0?I.z+=q:I.z-=q,I.z<0?I.z+=360:360<I.z&&(I.z-=360),i.rotation=I,i.showTooltip&&i._tooltip.showAt(o.endPosition,"正北夹角:"+i._rotation.z.toFixed(2)))}}else if("littleBox"===i._pickObject.id._name){for(y=0;y<B.length;y++)"littleBox"!==B[y]._name&&(B[y].show=!1);var U=i._viewer.scene.globe.ellipsoid,Q=i._viewer.camera.pickEllipsoid(o.startPosition,U);if(void 0===Q)return;Q.z=0;var $=i._viewer.camera.pickEllipsoid(o.endPosition,U);if(void 0===$)return;if($.z=0,null===i.editObject||"modelLOD"!==i.editObject._type&&"PGEarth3DTileset"!==i.editObject._type){var J=i._primitive.id.position._value.clone();J.z=0;var X=t.distance(J,Q),ee=t.distance(J,$);X<ee?i._primitive.id._model.scale+=.1:ee<X&&(i._primitive.id._model.scale-=.1)}else if(o.endPosition.x!==o.startPosition.x||o.endPosition.y!==o.startPosition.y){var te;if("modelLOD"===i.editObject._type){var ie=i.editObject._position.x,ne=i.editObject._position.y,oe=i.editObject._position.z;te=t.fromDegrees(ie,ne,oe)}else"PGEarth3DTileset"===i.editObject._type&&(te=i.editObject._root._boundingVolume.boundingVolume.center);(h=new g).x=0,h.y=0,h.width=i._scene._context.drawingBufferWidth,h.height=i._scene._context.drawingBufferHeight,b=z.project(te,i._scene.camera,h);var re=i._pickObject.id.position._callback(),de=z.project(re,i._scene.camera,h),se=e.distance(new e(de.x,window.screen.height-de.y),new e(b.x,window.screen.height-b.y)),le=t.distance(te,re),ae=le/se;(p=new t).x=o.startPosition.x-b.x,p.y=o.startPosition.y-h.height+b.y,p.z=0;var ce=Math.sqrt(p.x*p.x+p.y*p.y);(u=new t).x=o.endPosition.x-b.x,u.y=o.endPosition.y-h.height+b.y,u.z=0;var _e=(le+ae*(Math.sqrt(u.x*u.x+u.y*u.y)-ce))/le;"modelLOD"===i.editObject._type?(O=i.editObject.getScale().clone(),0<_e&&(t.multiplyByScalar(O,_e,O),i.scale=O,i.showTooltip&&i._tooltip.showAt(o.endPosition,"缩放比:"+_e.toFixed(4)))):"PGEarth3DTileset"===i.editObject._type&&(O=i.scale.clone(),t.multiplyByScalar(O,_e,O),i.scale=O,i.showTooltip&&i._tooltip.showAt(o.endPosition,"缩放比:"+_e.toFixed(4)))}}}},d.MOUSE_MOVE)}(this),this._scene.globe.depthTestAgainstTerrain=!0,o.scene.primitives.add(this);var b=this;T.track(this,["editerVisible","editObject"]);var h=T.observable();T.defineProperty(this,"editerVisible",{get:function(){return h()},set:function(e){h(e)}}),this._editObject=T.getObservable(this,"editObject").subscribe(function(e){if(b._editAction=C.Edit_Model_NONE,R(b),b._showAxis=!1,b._showCylinder=!1,b._tooltip.setVisible(!1),n(e))if("modelLOD"===e._type)b._position=e._position,b._rotation=new t(0,0,e.getRotate().z),b._scale=new t(e.getScale().x,e.getScale().x,e.getScale().x),b.rotateLMZ=e.getRotate().z;else if("pageLOD"===e._type)b._position=e.origin,b._rotation=new t(0,0,0),b._scale=new t(1,1,1);else if("PGEarth3DTileset"===e._type){var o=new t,r=e._root.transform;_.getTranslation(r,o),o.equals({x:0,y:0,z:0})&&(o=e._root.boundingSphere.center);var d=c.fromCartesian(o),s=a.toDegrees(d.longitude),l=a.toDegrees(d.latitude),u=d.height;b._position=t.fromElements(s,l,u);var h=new _;if(_.equals(e.modelMatrix,_.IDENTITY))h=e.modelMatrix.clone();else o.x>=-180&&o.x<=180&&o.y>=-90&&o.y<=90?c.fromCartesian(t.fromDegrees(o.x,o.y,o.z)):c.fromCartesian(o);var m=new t;_.getScale(e.modelMatrix,m);var O=_.fromScale(m);_.inverse(O,O),_.multiply(O,h,h);var y=new p,j=new i,g=new v;_.getRotation(h,y),i.fromRotationMatrix(y,j),v.fromQuaternion(j,g);var f=-g.heading*(180/Math.PI);f=Math.abs(f)<1e-6?0:f;var x=g.roll*(180/Math.PI);x=Math.abs(x)<1e-6?0:x;var w=-g.pitch*(180/Math.PI);f<0&&(f+=360),x<0&&(x+=360),(w=Math.abs(w)<1e-6?0:w)<0&&(w+=360),b._rotation=new t(x,w,f),b._scale=m}}),T.defineProperty(this,"moveModelTooltip",function(){return"移动模型"}),T.defineProperty(this,"rotateModelTooltip",function(){return"旋转模型"}),T.defineProperty(this,"zoomModelTooltip",function(){return"缩放模型"}),T.defineProperty(this,"allModelTooltip",function(){return"编辑模型"})}function G(e,i,n,o){var r=new t;r=o.x>=-180&&o.x<=180&&o.y>=-90&&o.y<=90?t.fromDegrees(o.x,o.y,o.z):o;var d,s=e.editObject.boundingSphere;d=s.center.x>=-180&&s.center.x<=180&&s.center.y>=-90&&s.center.y<=90?c.fromCartesian(t.fromDegrees(s.center.x,s.center.y,s.center.z)):c.fromCartesian(s.center);var l=t.fromRadians(d.longitude,d.latitude,d.height),a=t.subtract(r,l,new t);e.editObject.modelMatrix=_.fromTranslation(a)}function A(e,t){if(t){var i=new g;i.x=0,i.y=0,i.width=e._scene._context.drawingBufferWidth,i.height=e._scene._context.drawingBufferHeight;var n=c.fromCartesian(t),o=c.fromRadians(n.longitude,n.latitude,n.height-1),r=z.project(t,e._scene.camera,i),d=z.project(c.toCartesian(o),e._scene.camera,i);return 1/(r.y-d.y)}}function N(e){var i;if("function"==typeof define&&define.amd&&!define.amd.toUrlUndefined&&"function"==typeof L.toUrl)i=L.toUrl("./");else for(var o=/((?:.*\/)|^)EditBoxGeometry[\w-]*\.js(?:\W|$)/i,r=document.getElementsByTagName("script"),d=0,s=r.length;d<s;++d){var l=r[d].getAttribute("src"),a=o.exec(l);if(null!==a){i=a[1];break}}var c=e._viewer.entities.add({name:"ring",position:new S(function(){if(null!=e.editObject&&"modelLOD"===e.editObject._type){var i=parseFloat(e.editObject._position.x),o=parseFloat(e.editObject._position.y),r=parseFloat(e.editObject._position.z),d=e.editObject.rootNode.children[0].boundingBox.center.z*e.editObject.scale.z;return t.fromDegrees(i,o,r+d)}if(null==e.editObject||"pageLOD"!==e.editObject._type){if(null!=e.editObject&&"PGEarth3DTileset"===e.editObject._type)return e.editObject.boundingSphere.center;if(n(e._primitive._boundingSphere)){var s=V(e);return t.fromDegrees(s[0],s[1],s[2])}}},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),model:{uri:i+"Ring.gltf",scale:new S(function(){if(null!=e.editObject&&"modelLOD"===e.editObject._type)return e.editObject.rootNode.children[0].bdSphere.radius*e.editObject.scale.x;if(null!=e.editObject&&"PGEarth3DTileset"===e.editObject._type)return e.editObject.boundingSphere.radius;if(n(e._primitive._boundingSphere)){var t=e._primitive._boundingSphere.clone(),i=e._primitive.modelMatrix.clone();return u.transform(t,i,t),1.4*t.radius*e._primitive.scale}},!1)}});B.push(c)}function F(e){var i=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(-1,-1,-1,e,t):H(-1,-1,-1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(i);var o=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(1,-1,-1,e,t):H(1,-1,-1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(o);var r=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(1,1,-1,e,t):H(1,1,-1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(r);var d=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(-1,1,-1,e,t):H(-1,1,-1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(d);var s=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(-1,-1,1,e,t):H(-1,-1,1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(s);var l=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(1,-1,1,e,t):H(1,-1,1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(l);var a=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(1,1,1,e,t):H(1,1,1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(a);var c=e._viewer.entities.add({position:new S(function(){var t=K(e._bigBoxEntity);return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:W(-1,1,1,e,t):H(-1,1,1,e,t)},!1),orientation:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?e._primitive.id.orientation._value:k(e)},!1),name:"littleBox",box:{dimensions:new S(function(){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type||!n(e._primitive._boundingSphere)?void 0:new t(e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5,e._primitive._boundingSphere.radius*e._primitive.scale/5):I(e)},!1),material:h.SPRINGGREEN.withAlpha(.8),outline:!1,outlineColor:h.WHITE}});B.push(c)}function R(e){for(var t=B.length,i=0;i<t;i++)e._viewer.entities.removeById(B[i].id);B=[]}function I(e){var i,n=new t;if("modelLOD"!==e.editObject._type){if("PGEarth3DTileset"!==e.editObject._type)return;_.getScale(e.editObject.modelMatrix,n);var o=e._bigBoxEntity.dimensions,r=U(o.x,o.y,o.z);return new t(.25*r,.25*r,.25*r)}i=e.editObject.rootNode.children[0].boundingBox,n=t.clone(e.editObject.scale);var d=i.minimum,s=i.maximum,l=U((s.x-d.x)*n.x,(s.y-d.y)*n.y,(s.z-d.z)*n.z);return new t(l/4,l/4,l/4)}function k(e){var n=new t,o=new v;if("modelLOD"===e.editObject._type){n=t.fromDegrees(parseFloat(e.editObject._position.x),parseFloat(e.editObject._position.y),parseFloat(e.editObject._position.z));var r=-e.editObject.rotate.z,d=-e.editObject.rotate.y,s=e.editObject.rotate.x;o=new v(r,d,s)}else if("PGEarth3DTileset"===e.editObject._type){var l=new p,a=new i,c=_.multiply(e.editObject.modelMatrix,e.editObject._root.transform,new _),u=_.getScale(e.editObject.modelMatrix,new t),b=_.fromScale(u);return _.inverse(b,b),_.multiply(b,c,c),_.getRotation(c,l),i.fromRotationMatrix(l,a),a}return m.headingPitchRollQuaternion(n,o)}function H(e,i,n,o,r){var d,s=new u;if("modelLOD"===o.editObject._type){var l=(d=o.editObject.rootNode.children[0].boundingBox).minimum,a=d.maximum;s.center.x=e*(a.x-l.x)*o.editObject.scale.x/2,s.center.y=i*(a.y-l.y)*o.editObject.scale.y/2,s.center.z=n*(a.z-l.z)*o.editObject.scale.z/2,s.radius=o.editObject.rootNode.children[0].bdSphere.radius}else if("pageLOD"===o.editObject._type)l=(d=o.editObject.boundingBox).minimum,a=d.maximum,s.center.x=e*(a.x-l.x)/2,s.center.y=i*(a.y-l.y)/2,s.center.z=n*(a.z-l.z)/2,s.radius=o.editObject.boundingSphere.radius;else if("PGEarth3DTileset"===o.editObject._type){var c=o._bigBoxEntity.dimensions,p=new t;_.getScale(o.editObject.modelMatrix,p),s.center.x=e*c.x/2,s.center.y=i*c.y/2,s.center.z=n*c.z/2,s.radius=o.editObject.boundingSphere.radius}return u.transform(s,r,s),s.center}function W(e,t,i,n,o){var r=n._primitive._boundingSphere.clone(),d=n._primitive.modelMatrix.clone();u.transform(r,d,r);var s=new u;return s.center.x=e*r.radius*n._primitive.scale,s.center.y=t*r.radius*n._primitive.scale,s.center.z=i*r.radius*n._primitive.scale,s.radius=r.radius,u.transform(s,o,s),s.center}function V(e){var i=[],n=new t;n.x=e._primitive.id.position._value.x,n.y=e._primitive.id.position._value.y,n.z=e._primitive.id.position._value.z;var o=c.fromCartesian(n),r=a.toDegrees(o.longitude);i.push(r);var d=a.toDegrees(o.latitude);i.push(d);var s=e._primitive._boundingSphere.clone(),l=e._primitive.modelMatrix.clone();u.transform(s,l,s);var _=c.fromCartesian(s.center).height;return i.push(_),i.push(1.5*s.radius*e._primitive.scale),i}function q(e){var i;if("modelLOD"===e.editObject._type)i=e.editObject.rootNode.children[0].boundingBox;else if("pageLOD"===e.editObject._type)i=e.editObject.boundingBox;else if("PGEarth3DTileset"===e.editObject._type){var n=new t,o=e.editObject._root._boundingVolume.boundingVolume.radius;return[(n=new t(1*o,1*o,800)).x,n.y,n.z]}var r=i.minimum,d=i.maximum,s=[];return s.push(d.x-r.x),s.push(d.y-r.y),s.push(d.z-r.z),s}function U(e,t,i){return e<t?e<i?e:i:t<i?t:i}function Q(e,t,i){return t<e?i<e?e:i:i<t?t:i}function Z(e,i,n,o,r,d,s,l){var a=(e.x+i.x+n.x+o.x+r.x+d.x+s.x+l.x)/8,c=(e.y+i.y+n.y+o.y+r.y+d.y+s.y+l.y)/8,_=(e.z+i.z+n.z+o.z+r.z+d.z+s.z+l.z)/8;return new t(a,c,_)}function Y(e){var i=c.fromCartesian(e),n=a.toDegrees(i.longitude),o=a.toDegrees(i.latitude),r=i.height;return new t(n,o,r)}function K(e){var t=new _,i=e.position;if(n(i)){var o=e.orientation;if(n(o)&&!o.equals({x:0,y:0,z:0,w:1})){var r=p.fromQuaternion(o);t=_.fromRotationTranslation(r,i,t)}else t=m.eastNorthUpToFixedFrame(i,void 0,t);return t}}return r(M.prototype,{scene:{get:function(){return this._scene}},showAxis:{get:function(){return this._axisPrimitive.show},set:function(e){this._axisPrimitive.show=e}},position:{get:function(){return this._position},set:function(e){t.equals(this._position,e)||(function(e,t){null!==e.editObject&&("modelLOD"===e.editObject._type?e.editObject.setPosition(t.x,t.y,t.z):"pageLOD"===e.editObject._type?e.editObject.origin=t:"PGEarth3DTileset"===e.editObject._type&&G(e,e._rotation,e._scale,t))}(this,e),this._position=e)}},rotation:{get:function(){return this._rotation},set:function(e){t.equals(this._rotation,e)||(function(e,t){null!==e.editObject&&("modelLOD"===e.editObject._type?e.editObject.setRotate(t.x,t.y,t.z):"PGEarth3DTileset"===e.editObject._type&&G(e,0,e._scale,e._position))}(this,e),this._rotation=e)}},scale:{get:function(){return this._scale},set:function(e){t.equals(this._scale,e)||(function(e,t){null!==e.editObject&&("modelLOD"===e.editObject._type?e.editObject.setScale(t.x,t.y,t.z):"PGEarth3DTileset"===e.editObject._type&&G(e,e._rotation,0,e._position))}(this,e),this._scale=e)}}}),M.prototype.move=function(){null===this.editObject||"modelLOD"!==this.editObject._type&&"pageLOD"!==this.editObject._type&&"PGEarth3DTileset"!==this.editObject._type||(R(this),this._showCylinder=!0,this._showAxis=!0),this._editAction=C.Edit_Model_Move},M.prototype.rotate=function(){null===this.editObject||"modelLOD"!==this.editObject._type&&"PGEarth3DTileset"!==this.editObject._type||(R(this),N(this),this._showAxis=!0,this._showCylinder=!1),this._editAction=C.Edit_Model_Rotate},M.prototype.zoom=function(){null===this.editObject||"modelLOD"!==this.editObject._type&&"PGEarth3DTileset"!==this.editObject._type||(R(this),F(this),this._showAxis=!0,this._showCylinder=!1),this._editAction=C.Edit_Model_Zoom},M.prototype.all=function(){null!==this.editObject&&(R(this),this._showCylinder=!0,this._showAxis=!0,"modelLOD"!==this.editObject._type&&"PGEarth3DTileset"!==this.editObject._type||(N(this),F(this))),this._editAction=C.Edit_Model_EditAll},M.prototype.cancel=function(){null!==this.editObject&&(R(this),this._showAxis=!1,this._showCylinder=!1,this._editAction=C.Edit_Model_NONE)},M.prototype.update=function(e){if(n(this.editObject)){if(e.passes.pick)return n(this._bigBoxPrimitive)&&(this._bigBoxPrimitive.update(e),e.commandList[e.commandList.length-2].pass=f.OPAQUE,e.commandList[e.commandList.length-1].pass=f.OPAQUE),void(n(this._cylinderPrimitive)&&this._cylinderPrimitive.update(e));this._bigBoxEntity.dimensions=function(e){if(null!=e.editObject&&"modelLOD"===e.editObject._type){if(n(e.editObject.rootNode)){var i=q(e);return new t(i[0]*e.editObject.scale.x,i[1]*e.editObject.scale.y,i[2]*e.editObject.scale.z)}}else{if(null!=e.editObject&&"pageLOD"===e.editObject._type){i=q(e);return new t(i[0],i[1],i[2])}if(null!=e.editObject&&"PGEarth3DTileset"===e.editObject._type){i=q(e);return new t(i[0],i[1],i[2])}if(n(e._primitive._boundingSphere)){var o=e._primitive._boundingSphere.clone(),r=e._primitive.modelMatrix.clone();return u.transform(o,r,o),new t(2*o.radius*e._primitive.scale,2*o.radius*e._primitive.scale,2*o.radius*e._primitive.scale)}}}(this),this._bigBoxEntity.position=function(e){if(null!=e.editObject&&"modelLOD"===e.editObject._type){if(n(e.editObject)){var i=parseFloat(e.editObject._position.x),o=parseFloat(e.editObject._position.y),r=parseFloat(e.editObject._position.z),d=e.editObject.rootNode.children[0].boundingBox.center.z*e.editObject.scale.z;return t.fromDegrees(i,o,r+d)}}else{if(null!=e.editObject&&"pageLOD"===e.editObject._type)return e.editObject.tileBoundingSphere.center.clone();if(null!=e.editObject&&"PGEarth3DTileset"===e.editObject._type)return e.editObject._root._boundingVolume.boundingVolume.center.clone();if(n(e._primitive._boundingSphere)){var s=V(e);return t.fromDegrees(s[0],s[1],s[2])}}}(this),this._bigBoxEntity.orientation=function(e){return null==e.editObject||"modelLOD"!==e.editObject._type&&"PGEarth3DTileset"!==e.editObject._type?null!=e.editObject&&"pageLOD"===e.editObject._type?void 0:e._primitive.id.orientation._value:k(e)}(this);var i=K(this._bigBoxEntity);this._bigBoxPrimitive=this._bigBoxPrimitive&&this._bigBoxPrimitive.destroy();var o=new y.fromDimensions({dimensions:this._bigBoxEntity.dimensions,vertexFormat:b.POSITION_ONLY}),r=w.fromType(w.ColorType);r.uniforms.color=h.WHITE.withAlpha(.3);var d=new P({material:r,translucent:r.isTranslucent(),closed:!1}),s=w.fromType(w.ColorType);s.uniforms.color=h.GRAY.withAlpha(.3);var l=new P({material:s,translucent:s.isTranslucent(),closed:!1});if(this._bigBoxPrimitive=new D({geometryInstances:new O({geometry:o,modelMatrix:i,id:"mainBox"}),appearance:d,depthFailAppearance:l,asynchronous:!1}),this._bigBoxPrimitive.update(e),n(this._axisPrimitive)&&this._showAxis){var a=1.2*Q(this._bigBoxEntity.dimensions.x,this._bigBoxEntity.dimensions.y,this._bigBoxEntity.dimensions.z);this._axisPrimitive.length=a,this._axisPrimitive.modelMatrix=i,this._axisPrimitive.update(e),e.commandList[e.commandList.length-1].renderState=x.fromCache({depthTest:{enabled:!1}})}if(this._showCylinder){this._cylinderPrimitive=this._cylinderPrimitive&&this._cylinderPrimitive.destroy();var c=new j({length:function(e){if(null!=e.editObject&&"modelLOD"===e.editObject._type){var i=e.editObject.rootNode.children[0].boundingBox,o=i.minimum,r=i.maximum;return Q((r.x-o.x)*e.editObject.scale.x,(r.y-o.y)*e.editObject.scale.y,(r.z-o.z)*e.editObject.scale.z)/5}if(null!=e.editObject&&"PGEarth3DTileset"===e.editObject._type){var d=e._bigBoxEntity.dimensions,s=new t;return _.getScale(e.editObject.modelMatrix,s),Q(d.x,d.y,d.z)/5}if(null!=e.editObject&&"pageLOD"===e.editObject._type)return Q((d=q(e))[0],d[1],d[2])/10;if(n(e._primitive._boundingSphere)){var l=e._primitive._boundingSphere.clone(),a=e._primitive.modelMatrix.clone();return u.transform(l,a,l),.3*l.radius*e._primitive.scale}}(this),topRadius:0,bottomRadius:function(e){if(null!=e.editObject&&"modelLOD"===e.editObject._type){var i=e.editObject.rootNode.children[0].boundingBox,o=i.minimum,r=i.maximum;return Q((r.x-o.x)*e.editObject.scale.x,(r.y-o.y)*e.editObject.scale.y,(r.z-o.z)*e.editObject.scale.z)/10}if(null!=e.editObject&&"pageLOD"===e.editObject._type)return Q((d=q(e))[0],d[1],d[2])/20;if(null!=e.editObject&&"PGEarth3DTileset"===e.editObject._type){var d=e._bigBoxEntity.dimensions,s=new t;return _.getScale(e.editObject.modelMatrix,s),Q(d.x,d.y,d.z)/10}if(n(e._primitive._boundingSphere)){var l=e._primitive._boundingSphere.clone(),a=e._primitive.modelMatrix.clone();return u.transform(l,a,l),.2*l.radius*e._primitive.scale}}(this),vertexFormat:b.POSITION_ONLY}),p=w.fromType(w.ColorType);p.uniforms.color=h.YELLOW.withAlpha(.8);var v=new P({material:p,translucent:p.isTranslucent(),renderState:{depthTest:{enabled:!1}},closed:!1});this._cylinderPrimitive=new D({geometryInstances:new O({geometry:c,modelMatrix:m.eastNorthUpToFixedFrame(function(e){var i=K(e._bigBoxEntity);if(null!=e.editObject&&("modelLOD"===e.editObject._type||"pageLOD"===e.editObject._type||"PGEarth3DTileset"===e.editObject._type)){var o=Y(H(-1,-1,-1,e,i)),r=Y(H(1,-1,-1,e,i)),d=Y(H(1,1,-1,e,i)),s=Y(H(-1,1,-1,e,i)),l=Y(H(-1,-1,1,e,i)),a=Y(H(1,-1,1,e,i)),c=Y(H(1,1,1,e,i)),_=Y(H(-1,1,1,e,i)),p=Z(o,r,d,s,l,a,c,_);if("modelLOD"===e.editObject._type){var u=q(e),b=Math.sqrt(u[0]*u[0]+u[1]*u[1])/4;return t.fromDegrees(p.x,p.y,_.z+1.5*b*e.editObject.scale.z)}if("PGEarth3DTileset"===e.editObject._type){u=q(e),b=Math.sqrt(u[0]*u[0]+u[1]*u[1])/4;return t.fromDegrees(p.x,p.y,_.z+1.5*b)}u=q(e),b=Math.sqrt(u[0]*u[0]+u[1]*u[1])/4;return t.fromDegrees(p.x,p.y,_.z+b)}if(n(e._primitive._boundingSphere)){var h=V(e);return t.fromDegrees(h[0],h[1],h[2]+h[3])}}(this)),id:"cylinder"}),appearance:v,asynchronous:!1}),this._cylinderPrimitive.update(e)}}},M.prototype.isDestroyed=function(){return!1},M.prototype.destroy=function(){return this._primitive.destroy(),this._primitiveBoundingSpherePosition.destroy(),this._ellipsoid.destroy(),this._removePostRenderEvent(),this._editObject.dispose(),this._screenSpaceEventHandler.destroy(),this._axisPrimitive.destroy(),this._cylinderPrimitive=this._cylinderPrimitive&&this._cylinderPrimitive.destroy(),this._bigBoxPrimitive=this._bigBoxPrimitive&&this._bigBoxPrimitive.destroy(),this._scene.primitives.remove(this),o(this)},M});