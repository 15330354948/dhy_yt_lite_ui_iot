define(["../Core/Credit","../Core/decodeGoogleEarthEnterpriseData","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Event","../Core/GeographicTilingScheme","../Core/GoogleEarthEnterpriseMetadata","../Core/loadImageFromTypedArray","../Core/Math","../Core/Rectangle","../Core/Request","../Core/Resource","../Core/RuntimeError","../Core/TileProviderError","../ThirdParty/protobuf-minimal","../ThirdParty/when"],function(e,r,t,i,a,o,n,s,d,l,h,u,c,m,y,g,f,p){"use strict";function v(){this._image=new Image}function _(r){if(r=t(r,t.EMPTY_OBJECT),!i(r.url)&&!i(r.metadata))throw new o("options.url or options.metadata is required.");var a;if(i(r.metadata))a=r.metadata;else{var l=m.createIfNeeded(r.url);a=new d(l)}this._metadata=a,this._tileDiscardPolicy=r.tileDiscardPolicy,this._tilingScheme=new s({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:2,rectangle:new u(-h.PI,-h.PI,h.PI,h.PI),ellipsoid:r.ellipsoid});var c=r.credit;"string"==typeof c&&(c=new e(c)),this._credit=c,this._tileWidth=256,this._tileHeight=256,this._maximumLevel=23,i(this._tileDiscardPolicy)||(this._tileDiscardPolicy=new v),this._errorEvent=new n,this._ready=!1;var f,_=this;this._readyPromise=a.readyPromise.then(function(e){if(!a.imageryPresent){var r=new y("The server "+a.url+" doesn't have imagery");return f=g.handleError(f,_,_._errorEvent,r.message,void 0,void 0,void 0,r),p.reject(r)}return g.handleSuccess(f),_._ready=e,e}).otherwise(function(e){return f=g.handleError(f,_,_._errorEvent,e.message,void 0,void 0,void 0,e),p.reject(e)})}return v.prototype.isReady=function(){return!0},v.prototype.shouldDiscardImage=function(e){return e===this._image},a(_.prototype,{url:{get:function(){return this._metadata.url}},proxy:{get:function(){return this._metadata.proxy}},tileWidth:{get:function(){if(!this._ready)throw new o("tileWidth must not be called before the imagery provider is ready.");return this._tileWidth}},tileHeight:{get:function(){if(!this._ready)throw new o("tileHeight must not be called before the imagery provider is ready.");return this._tileHeight}},maximumLevel:{get:function(){if(!this._ready)throw new o("maximumLevel must not be called before the imagery provider is ready.");return this._maximumLevel}},minimumLevel:{get:function(){if(!this._ready)throw new o("minimumLevel must not be called before the imagery provider is ready.");return 0}},tilingScheme:{get:function(){if(!this._ready)throw new o("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme}},rectangle:{get:function(){if(!this._ready)throw new o("rectangle must not be called before the imagery provider is ready.");return this._tilingScheme.rectangle}},tileDiscardPolicy:{get:function(){if(!this._ready)throw new o("tileDiscardPolicy must not be called before the imagery provider is ready.");return this._tileDiscardPolicy}},errorEvent:{get:function(){return this._errorEvent}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise}},credit:{get:function(){return this._credit}},hasAlphaChannel:{get:function(){return!1}}}),_.prototype.getTileCredits=function(e,r,t){if(!this._ready)throw new o("getTileCredits must not be called before the imagery provider is ready.");var a=this._metadata,n=a.getTileInformation(e,r,t);if(i(n)){var s=a.providers[n.imageryProvider];if(i(s))return[s]}},_.prototype.requestImage=function(e,t,a,n){if(!this._ready)throw new o("requestImage must not be called before the imagery provider is ready.");var s=this._tileDiscardPolicy._image,h=this._metadata,u=d.tileXYToQuadKey(e,t,a),m=h.getTileInformation(e,t,a);if(!i(m)){if(h.isValid(u)){var g=new c({throttle:n.throttle,throttleByServer:n.throttleByServer,type:n.type,priorityFunction:n.priorityFunction});return void h.populateSubtree(e,t,a,g)}return s}if(!m.hasImagery())return s;var p=function(e,r,t,a,o,n){var s=d.tileXYToQuadKey(t,a,o),l=r.imageryVersion;return l=i(l)&&l>0?l:1,e._metadata.resource.getDerivedResource({url:"flatfile?f1-0"+s+"-i."+l.toString(),request:n})}(this,m,e,t,a,n).fetchArrayBuffer();return i(p)?p.then(function(e){r(h.key,e);var t,a=new Uint8Array(e),o=h.protoImagery;if(i(o)&&o||(t=function(e){if(e[6]==="JFIF".charCodeAt(0)&&e[7]==="JFIF".charCodeAt(1)&&e[8]==="JFIF".charCodeAt(2)&&e[9]==="JFIF".charCodeAt(3))return"image/jpeg";if(e[1]==="PNG".charCodeAt(0)&&e[2]==="PNG".charCodeAt(1)&&e[3]==="PNG".charCodeAt(2))return"image/png";return}(a)),!i(t)&&(!i(o)||o)){var n=function(e){var r=f.Reader.create(e),t=r.len,a={};for(;r.pos<t;){var o=r.uint32();switch(o>>>3){case 1:a.imageType=r.uint32();break;case 2:a.imageData=r.bytes();break;case 3:a.alphaType=r.uint32();break;case 4:a.imageAlpha=r.bytes();break;case 5:var n=a.copyrightIds;if(i(n)||(n=a.copyrightIds=[]),2==(7&o))for(var s=r.uint32()+r.pos;r.pos<s;)n.push(r.uint32());else n.push(r.uint32());break;default:r.skipType(7&o)}}var d=a.imageType;if(i(d))switch(d){case 0:a.imageType="image/jpeg";break;case 4:a.imageType="image/png";break;default:throw new y("GoogleEarthEnterpriseImageryProvider: Unsupported image type.")}var l=a.alphaType;i(l)&&0!==l&&(console.log("GoogleEarthEnterpriseImageryProvider: External alpha not supported."),delete a.alphaType,delete a.imageAlpha);return a}(a);t=n.imageType,a=n.imageData}return i(t)&&i(a)?l({uint8Array:a,format:t,flipY:!0}):s}):void 0},_.prototype.pickFeatures=function(e,r,t,i,a){},_});