define(["../Core/BoundingRectangle","../Core/Check","../Core/Color","../Core/combine","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Math","../Core/PixelFormat","../Core/Resource","../Renderer/PassState","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/Sampler","../Renderer/ShaderSource","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","../ThirdParty/when","./PostProcessStageSampleMode"],function(e,t,r,n,i,o,s,a,c,d,u,l,h,_,f,m,p,g,T,x,S,v,y,w){"use strict";function C(n){var a=(n=o(n,o.EMPTY_OBJECT)).fragmentShader,c=o(n.textureScale,1),u=o(n.pixelFormat,l.RGBA);if(t.typeOf.string("options.fragmentShader",a),t.typeOf.number.greaterThan("options.textureScale",c,0),t.typeOf.number.lessThanOrEquals("options.textureScale",c,1),!l.isColorFormat(u))throw new d("options.pixelFormat must be a color format.");this._fragmentShader=a,this._uniforms=n.uniforms,this._textureScale=c,this._forcePowerOfTwo=o(n.forcePowerOfTwo,!1),this._sampleMode=o(n.sampleMode,w.NEAREST),this._pixelFormat=u,this._pixelDatatype=o(n.pixelDatatype,f.UNSIGNED_BYTE),this._clearColor=o(n.clearColor,r.BLACK),this._uniformMap=void 0,this._command=void 0,this._colorTexture=void 0,this._depthTexture=void 0,this._idTexture=void 0,this._actualUniforms={},this._dirtyUniforms=[],this._texturesToRelease=[],this._texturesToCreate=[],this._texturePromise=void 0;var h=new _;h.scissorTest={enabled:!0,rectangle:s(n.scissorRectangle)?e.clone(n.scissorRectangle):new e},this._passState=h,this._ready=!1;var m=n.name;s(m)||(m=i()),this._name=m,this._logDepthChanged=void 0,this._useLogDepth=void 0,this._selectedIdTexture=void 0,this._selected=void 0,this._selectedShadow=void 0,this._parentSelected=void 0,this._parentSelectedShadow=void 0,this._combinedSelected=void 0,this._combinedSelectedShadow=void 0,this._selectedLength=0,this._parentSelectedLength=0,this._selectedDirty=!0,this._textureCache=void 0,this._index=void 0,this.enabled=!0,this._enabled=!0}a(C.prototype,{ready:{get:function(){return this._ready}},name:{get:function(){return this._name}},fragmentShader:{get:function(){return this._fragmentShader}},uniforms:{get:function(){return this._uniforms}},textureScale:{get:function(){return this._textureScale}},forcePowerOfTwo:{get:function(){return this._forcePowerOfTwo}},sampleMode:{get:function(){return this._sampleMode}},pixelFormat:{get:function(){return this._pixelFormat}},pixelDatatype:{get:function(){return this._pixelDatatype}},clearColor:{get:function(){return this._clearColor}},scissorRectangle:{get:function(){return this._passState.scissorTest.rectangle}},outputTexture:{get:function(){if(s(this._textureCache)){var e=this._textureCache.getFramebuffer(this._name);if(s(e))return e.getColorTexture(0)}}},selected:{get:function(){return this._selected},set:function(e){this._selected=e}},parentSelected:{get:function(){return this._parentSelected},set:function(e){this._parentSelected=e}}});var E=/uniform\s+sampler2D\s+depthTexture/g;function D(e,t,r){var n=t[r];return("string"==typeof n||n instanceof HTMLCanvasElement||n instanceof HTMLImageElement||n instanceof HTMLVideoElement||n instanceof ImageData)&&e._dirtyUniforms.push(r),{get:function(){return t[r]},set:function(n){var i=t[r];t[r]=n;var o=e._actualUniforms,a=o[r];s(a)&&a!==i&&a instanceof T&&!s(e._textureCache.getStageByName(r))&&(e._texturesToRelease.push(a),delete o[r],delete o[r+"Dimensions"]),i instanceof T&&e._texturesToRelease.push(i),"string"==typeof n||n instanceof HTMLCanvasElement||n instanceof HTMLImageElement||n instanceof HTMLVideoElement||n instanceof ImageData?e._dirtyUniforms.push(r):o[r]=n}}}function I(e,t){return function(){var r=e._actualUniforms[t];return"function"==typeof r?r():r}}function b(e,t){return function(){var r=e[t]();if(s(r))return r.dimensions}}function R(e,t){return function(r){e._texturesToCreate.push({name:t,source:r})}}function L(e,t){return function(){return e._textureCache.getOutputTexture(t)}}function M(e){s(e._command)&&(e._command.shaderProgram=e._command.shaderProgram&&e._command.shaderProgram.destroy(),e._command=void 0),e._selectedIdTexture=e._selectedIdTexture&&e._selectedIdTexture.destroy();var t=e._textureCache;if(s(t)){var r=e._uniforms,n=e._actualUniforms;for(var i in n)n.hasOwnProperty(i)&&n[i]instanceof T&&(s(t.getStageByName(r[i]))||n[i].destroy(),e._dirtyUniforms.push(i))}}return C.prototype._isSupported=function(e){return!E.test(this._fragmentShader)||e.depthTexture},C.prototype.update=function(t,i){if(this.enabled===this._enabled||this.enabled||M(this),this._enabled=this.enabled,this._enabled&&(this._logDepthChanged=i!==this._useLogDepth,this._useLogDepth=i,this._selectedDirty=function(e){var t=s(e._selected)?e._selected.length:0,r=s(e._parentSelected)?e._parentSelected:0,n=e._selected!==e._selectedShadow||t!==e._selectedLength;if(n=n||e._parentSelected!==e._parentSelectedShadow||r!==e._parentSelectedLength,s(e._selected)&&s(e._parentSelected)?e._combinedSelected=e._selected.concat(e._parentSelected):s(e._parentSelected)?e._combinedSelected=e._parentSelected:e._combinedSelected=e._selected,!n&&s(e._combinedSelected)){if(!s(e._combinedSelectedShadow))return!0;t=e._combinedSelected.length;for(var i=0;i<t;++i)if(e._combinedSelected[i]!==e._combinedSelectedShadow[i])return!0}return n}(this),this._selectedShadow=this._selected,this._parentSelectedShadow=this._parentSelected,this._combinedSelectedShadow=this._combinedSelected,this._selectedLength=s(this._selected)?this._selected.length:0,this._parentSelectedLength=s(this._parentSelected)?this._parentSelected.length:0,function(e,t){if(e._selectedDirty){e._selectedIdTexture=e._selectedIdTexture&&e._selectedIdTexture.destroy(),e._selectedIdTexture=void 0;var n=e._combinedSelected;if(s(n)){var i,o,a,c=0,d=n.length;for(i=0;i<d;++i)o=n[i],s(o.pickIds)?c+=o.pickIds.length:s(o.pickId)&&++c;if(0===d||0===c){var u=new Uint8Array(4);return u[0]=255,u[1]=255,u[2]=255,u[3]=255,void(e._selectedIdTexture=new T({context:t,pixelFormat:l.RGBA,pixelDatatype:f.UNSIGNED_BYTE,source:{arrayBufferView:u,width:1,height:1},sampler:new p({wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE,minificationFilter:S.NEAREST,magnificationFilter:x.NEAREST})}))}var h=0,_=new Uint8Array(4*c);for(i=0;i<d;++i)if(o=n[i],s(o.pickIds))for(var m=o.pickIds,g=m.length,y=0;y<g;++y)a=m[y].color,_[h]=r.floatToByte(a.red),_[h+1]=r.floatToByte(a.green),_[h+2]=r.floatToByte(a.blue),_[h+3]=r.floatToByte(a.alpha),h+=4;else s(o.pickId)&&(a=o.pickId.color,_[h]=r.floatToByte(a.red),_[h+1]=r.floatToByte(a.green),_[h+2]=r.floatToByte(a.blue),_[h+3]=r.floatToByte(a.alpha),h+=4);e._selectedIdTexture=new T({context:t,pixelFormat:l.RGBA,pixelDatatype:f.UNSIGNED_BYTE,source:{arrayBufferView:_,width:c,height:1},sampler:new p({wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE,minificationFilter:S.NEAREST,magnificationFilter:x.NEAREST})})}}}(this,t),function(e){if(!s(e._uniformMap)){var t={},r={},i=e._uniforms,o=e._actualUniforms;for(var c in i)if(i.hasOwnProperty(c)){"function"!=typeof i[c]?(t[c]=I(e,c),r[c]=D(e,i,c)):(t[c]=i[c],r[c]=i[c]),o[c]=i[c];var d=t[c]();("string"==typeof d||d instanceof T||d instanceof HTMLImageElement||d instanceof HTMLCanvasElement||d instanceof HTMLVideoElement)&&(t[c+"Dimensions"]=b(t,c))}e._uniforms={},a(e._uniforms,r),e._uniformMap=n(t,{colorTexture:function(){return e._colorTexture},colorTextureDimensions:function(){return e._colorTexture.dimensions},depthTexture:function(){return e._depthTexture},depthTextureDimensions:function(){return e._depthTexture.dimensions},czm_idTexture:function(){return e._idTexture},czm_selectedIdTexture:function(){return e._selectedIdTexture},czm_selectedIdTextureStep:function(){return 1/e._selectedIdTexture.width}})}}(this),function(e,t){var r,n,i,o=e._texturesToRelease,a=o.length;for(r=0;r<a;++r)n=(n=o[r])&&n.destroy();o.length=0;var c=e._texturesToCreate;for(a=c.length,r=0;r<a;++r){var d=c[r];i=d.name;var u=d.source;e._actualUniforms[i]=new T({context:t,source:u})}c.length=0;var l=e._dirtyUniforms;if(0!==l.length||s(e._texturePromise)){if(0!==l.length&&!s(e._texturePromise)){a=l.length;var _=e._uniforms,f=[];for(r=0;r<a;++r){var m=_[i=l[r]],p=e._textureCache.getStageByName(m);if(s(p))e._actualUniforms[i]=L(e,m);else if("string"==typeof m){var g=new h({url:m});f.push(g.fetchImage().then(R(e,i)))}else e._texturesToCreate.push({name:i,source:m})}l.length=0,f.length>0?(e._ready=!1,e._texturePromise=y.all(f).then(function(){e._ready=!0,e._texturePromise=void 0})):e._ready=!0}}else e._ready=!0}(this,t),function(e,t){if(!s(e._command)||e._logDepthChanged||e._selectedDirty){var r=e._fragmentShader;s(e._selectedIdTexture)&&(r="#define CZM_SELECTED_FEATURE \nuniform sampler2D czm_idTexture; \nuniform sampler2D czm_selectedIdTexture; \nuniform float czm_selectedIdTextureStep; \nvarying vec2 v_textureCoordinates; \nbool czm_selected(vec2 offset) \n{ \n    bool selected = false;\n    vec4 id = texture2D(czm_idTexture, v_textureCoordinates + offset); \n    for (int i = 0; i < "+e._selectedIdTexture.width+"; ++i) \n    { \n        vec4 selectedId = texture2D(czm_selectedIdTexture, vec2(float(i) * czm_selectedIdTextureStep, 0.5)); \n        if (all(equal(id, selectedId))) \n        { \n            return true; \n        } \n    } \n    return false; \n} \n\nbool czm_selected() \n{ \n    return czm_selected(vec2(0.0)); \n} \n\n"+(r=r.replace(/varying\s+vec2\s+v_textureCoordinates;/g,"")));var n=new g({defines:[e._useLogDepth?"LOG_DEPTH":""],sources:[r]});e._command=t.createViewportQuadCommand(n,{uniformMap:e._uniformMap,owner:e})}}(this,t),function(e){var t,r;e._sampleMode===w.LINEAR?(t=S.LINEAR,r=x.LINEAR):(t=S.NEAREST,r=x.NEAREST);var n=e._sampler;s(n)&&n.minificationFilter===t&&n.magnificationFilter===r||(e._sampler=new p({wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE,minificationFilter:t,magnificationFilter:r}))}(this),this._selectedDirty=!1,this._ready)){var o=this._textureCache.getFramebuffer(this._name);if(this._command.framebuffer=o,s(o)){var c,d=o.getColorTexture(0);d.width===t.drawingBufferWidth&&d.height===t.drawingBufferHeight||(c=this._renderState,s(c)&&d.width===c.viewport.width&&d.height===c.viewport.height||(this._renderState=m.fromCache({viewport:new e(0,0,d.width,d.height)}))),this._command.renderState=c}}},C.prototype.execute=function(e,t,r,n){if(s(this._command)&&s(this._command.framebuffer)&&this._ready&&this._enabled){this._colorTexture=t,this._depthTexture=r,this._idTexture=n,p.equals(this._colorTexture.sampler,this._sampler)||(this._colorTexture.sampler=this._sampler);var i=this.scissorRectangle.width>0&&this.scissorRectangle.height>0?this._passState:void 0;s(i)&&(i.context=e),this._command.execute(e,i)}},C.prototype.isDestroyed=function(){return!1},C.prototype.destroy=function(){return M(this),c(this)},C});