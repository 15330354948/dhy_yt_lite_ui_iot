define(["../Core/Cartesian3","../Core/Color","../Core/defined","../Core/destroyObject","../Core/FeatureDetection","../Core/PixelFormat","../Core/PrimitiveType","../Renderer/ClearCommand","../Renderer/DrawCommand","../Renderer/Framebuffer","../Renderer/Pass","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/Sampler","../Renderer/ShaderSource","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","../Scene/BlendingState","../Scene/StencilConstants","../Shaders/PostProcessStages/PointCloudEyeDomeLighting"],function(e,r,t,o,n,a,i,d,f,s,u,h,c,_,m,p,l,g,C,S,T,v){"use strict";function w(){this._framebuffer=void 0,this._colorGBuffer=void 0,this._depthGBuffer=void 0,this._depthTexture=void 0,this._drawCommand=void 0,this._clearCommand=void 0,this._strength=1,this._radius=1}function x(){return new _({wrapS:C.CLAMP_TO_EDGE,wrapT:C.CLAMP_TO_EDGE,minificationFilter:g.NEAREST,magnificationFilter:l.NEAREST})}function E(e){var r=e._framebuffer;t(r)&&(e._colorGBuffer.destroy(),e._depthGBuffer.destroy(),e._depthTexture.destroy(),r.destroy(),e._framebuffer=void 0,e._colorGBuffer=void 0,e._depthGBuffer=void 0,e._depthTexture=void 0,e._drawCommand=void 0,e._clearCommand=void 0)}var B=new e;function D(e,o){var n=o.drawingBufferWidth,i=o.drawingBufferHeight,f=e._colorGBuffer,_=!1,m=t(f)&&(f.width!==n||f.height!==i);return t(f)&&!m||(E(e),function(e,r){var t=r.drawingBufferWidth,o=r.drawingBufferHeight,n=new p({context:r,width:t,height:o,pixelFormat:a.RGBA,pixelDatatype:h.UNSIGNED_BYTE,sampler:x()}),i=new p({context:r,width:t,height:o,pixelFormat:a.RGBA,pixelDatatype:h.UNSIGNED_BYTE,sampler:x()}),d=new p({context:r,width:t,height:o,pixelFormat:a.DEPTH_COMPONENT,pixelDatatype:h.UNSIGNED_INT,sampler:x()});e._framebuffer=new s({context:r,colorTextures:[n,i],depthTexture:d,destroyAttachments:!1}),e._colorGBuffer=n,e._depthGBuffer=i,e._depthTexture=d}(e,o),function(e,t){var o=v,n={u_pointCloud_colorGBuffer:function(){return e._colorGBuffer},u_pointCloud_depthGBuffer:function(){return e._depthGBuffer},u_distancesAndEdlStrength:function(){return B.x=e._radius/t.drawingBufferWidth,B.y=e._radius/t.drawingBufferHeight,B.z=e._strength,B}},a=c.fromCache({blending:S.ALPHA_BLEND,depthMask:!0,depthTest:{enabled:!0},stencilTest:T.setPGEarth3DTileBit(),stencilMask:T.PGEARTH_3D_TILE_MASK});e._drawCommand=t.createViewportQuadCommand(o,{uniformMap:n,renderState:a,pass:u.PGEARTH_3D_TILE,owner:e}),e._clearCommand=new d({framebuffer:e._framebuffer,color:new r(0,0,0,0),depth:1,renderState:c.fromCache(),pass:u.PGEARTH_3D_TILE,owner:e})}(e,o),_=!0),_}function G(e){return e.drawBuffers&&e.fragmentDepth}function P(e,r){var o=e.shaderCache.getDerivedShaderProgram(r,"EC");if(!t(o)){var n=r._attributeLocations,a=r.fragmentShaderSource.clone();a.sources=a.sources.map(function(e){return e=(e=m.replaceMain(e,"czm_point_cloud_post_process_main")).replace(/gl_FragColor/g,"gl_FragData[0]")}),a.sources.unshift("#extension GL_EXT_draw_buffers : enable \n"),a.sources.push("void main() \n{ \n    czm_point_cloud_post_process_main(); \n    gl_FragData[1] = czm_packDepth(gl_FragCoord.z); \n}"),o=e.shaderCache.createDerivedShaderProgram(r,"EC",{vertexShaderSource:r.vertexShaderSource,fragmentShaderSource:a,attributeLocations:n})}return o}return w.isSupported=G,w.prototype.update=function(e,r,o){if(G(e.context)){this._strength=o.eyeDomeLightingStrength,this._radius=o.eyeDomeLightingRadius;var n,a=D(this,e.context),d=e.commandList,s=d.length;for(n=r;n<s;++n){var h=d[n];if(h.primitiveType===i.POINTS&&h.pass!==u.TRANSLUCENT){var c=h.derivedCommands.pointCloudProcessor;(!t(c)||h.dirty||a||c.framebuffer!==this._framebuffer)&&(c=f.shallowClone(h),h.derivedCommands.pointCloudProcessor=c,c.framebuffer=this._framebuffer,c.shaderProgram=P(e.context,h.shaderProgram),c.castShadows=!1,c.receiveShadows=!1),d[n]=c}}var _=this._clearCommand,m=this._drawCommand;d.push(m),d.push(_)}},w.prototype.isDestroyed=function(){return!1},w.prototype.destroy=function(){return E(this),o(this)},w});