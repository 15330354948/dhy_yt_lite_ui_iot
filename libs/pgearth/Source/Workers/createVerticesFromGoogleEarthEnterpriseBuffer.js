define(["../Core/AxisAlignedBoundingBox","../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/defaultValue","../Core/defined","../Core/Ellipsoid","../Core/EllipsoidalOccluder","../Core/Math","../Core/Matrix4","../Core/OrientedBoundingBox","../Core/Rectangle","../Core/RuntimeError","../Core/TerrainEncoding","../Core/Transforms","../Core/WebMercatorProjection","./createTaskProcessorWorker"],function(e,t,r,n,i,o,a,u,s,d,h,c,l,g,m,p,I,v){"use strict";var E=Uint16Array.BYTES_PER_ELEMENT,T=Int32Array.BYTES_PER_ELEMENT,f=Uint32Array.BYTES_PER_ELEMENT,N=Float32Array.BYTES_PER_ELEMENT,x=Float64Array.BYTES_PER_ELEMENT;function S(e,t,r){r=o(r,d);for(var n=e.length,i=0;i<n;++i)if(r.equalsEpsilon(e[i],t,d.EPSILON12))return i;return-1}var C=new i,w=new n,B=new n,P=new n,R=new h;function b(e,t,o,u,s,c,l,g,m,p){for(var I=l.length,v=0;v<I;++v){var E=l[v],T=E.cartographic,f=E.index,N=e.length,x=T.longitude,S=T.latitude;S=d.clamp(S,-d.PI_OVER_TWO,d.PI_OVER_TWO);var B=T.height-c.skirtHeight;c.hMin=Math.min(c.hMin,B),i.fromRadians(x,S,B,C),m&&(C.longitude+=g),m?v===I-1?C.latitude+=p:0===v&&(C.latitude-=p):C.latitude+=g;var P=c.ellipsoid.cartographicToCartesian(C);e.push(P),t.push(B),o.push(r.clone(o[f])),u.length>0&&u.push(u[f]),h.multiplyByPoint(c.toENU,P,w);var R=c.minimum,b=c.maximum;n.minimumByComponent(w,R,R),n.maximumByComponent(w,b,b);var A=c.lastBorderPoint;if(a(A)){var _=A.index;s.push(_,N-1,N,N,f,_)}c.lastBorderPoint=E}}return v(function(o,v){o.ellipsoid=u.clone(o.ellipsoid),o.rectangle=l.clone(o.rectangle);var A=function(o,u,l,v,A,_,y,M,F,O){var W,V,Y,k,U,H;a(v)?(W=v.west,V=v.south,Y=v.east,k=v.north,U=v.width,H=v.height):(W=d.toRadians(A.west),V=d.toRadians(A.south),Y=d.toRadians(A.east),k=d.toRadians(A.north),U=d.toRadians(v.width),H=d.toRadians(v.height));var L,D,G=[V,k],z=[W,Y],j=p.eastNorthUpToFixedFrame(u,l),q=h.inverseTransformation(j,R);M&&(L=I.geodeticLatitudeToMercatorAngle(V),D=1/(I.geodeticLatitudeToMercatorAngle(k)-L));var J=new DataView(o),K=Number.POSITIVE_INFINITY,Q=Number.NEGATIVE_INFINITY,X=B;X.x=Number.POSITIVE_INFINITY,X.y=Number.POSITIVE_INFINITY,X.z=Number.POSITIVE_INFINITY;var Z=P;Z.x=Number.NEGATIVE_INFINITY,Z.y=Number.NEGATIVE_INFINITY,Z.z=Number.NEGATIVE_INFINITY;var $,ee,te=0,re=0,ne=0;for(ee=0;ee<4;++ee){var ie=te;$=J.getUint32(ie,!0),ie+=f;var oe=d.toRadians(180*J.getFloat64(ie,!0));ie+=x,-1===S(z,oe)&&z.push(oe);var ae=d.toRadians(180*J.getFloat64(ie,!0));ie+=x,-1===S(G,ae)&&G.push(ae),ie+=2*x;var ue=J.getInt32(ie,!0);ie+=T,re+=ue,ue=J.getInt32(ie,!0),ne+=3*ue,te+=$+f}var se=[],de=[],he=new Array(re),ce=new Array(re),le=new Array(re),ge=M?new Array(re):[],me=new Array(ne),pe=[],Ie=[],ve=[],Ee=[],Te=0,fe=0;for(te=0,ee=0;ee<4;++ee){$=J.getUint32(te,!0);var Ne=te+=f,xe=d.toRadians(180*J.getFloat64(te,!0));te+=x;var Se=d.toRadians(180*J.getFloat64(te,!0));te+=x;var Ce=d.toRadians(180*J.getFloat64(te,!0)),we=.5*Ce;te+=x;var Be=d.toRadians(180*J.getFloat64(te,!0)),Pe=.5*Be;te+=x;var Re=J.getInt32(te,!0);te+=T;var be=J.getInt32(te,!0);te+=T,te+=T;for(var Ae=new Array(Re),_e=0;_e<Re;++_e){var ye=xe+J.getUint8(te++)*Ce;C.longitude=ye;var Me=Se+J.getUint8(te++)*Be;C.latitude=Me;var Fe=6371010*J.getFloat32(te,!0);if(te+=N,Fe<O&&(Fe*=F),Fe*=_,C.height=Fe,-1!==S(z,ye)||-1!==S(G,Me)){var Oe=S(se,C,i);if(-1!==Oe){Ae[_e]=de[Oe];continue}se.push(i.clone(C)),de.push(Te)}Ae[_e]=Te,Math.abs(ye-W)<we?pe.push({index:Te,cartographic:i.clone(C)}):Math.abs(ye-Y)<we?ve.push({index:Te,cartographic:i.clone(C)}):Math.abs(Me-V)<Pe?Ie.push({index:Te,cartographic:i.clone(C)}):Math.abs(Me-k)<Pe&&Ee.push({index:Te,cartographic:i.clone(C)}),K=Math.min(Fe,K),Q=Math.max(Fe,Q),le[Te]=Fe;var We=l.cartographicToCartesian(C);he[Te]=We,M&&(ge[Te]=(I.geodeticLatitudeToMercatorAngle(Me)-L)*D),h.multiplyByPoint(q,We,w),n.minimumByComponent(w,X,X),n.maximumByComponent(w,Z,Z);var Ve=(ye-W)/(Y-W);Ve=d.clamp(Ve,0,1);var Ye=(Me-V)/(k-V);Ye=d.clamp(Ye,0,1),ce[Te]=new r(Ve,Ye),++Te}for(var ke=3*be,Ue=0;Ue<ke;++Ue,++fe)me[fe]=Ae[J.getUint16(te,!0)],te+=E;if($!==te-Ne)throw new g("Invalid terrain tile.")}he.length=Te,ce.length=Te,le.length=Te,M&&(ge.length=Te);var He=Te,Le=fe,De={hMin:K,lastBorderPoint:void 0,skirtHeight:y,toENU:q,ellipsoid:l,minimum:X,maximum:Z};if(pe.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),Ie.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),ve.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),Ee.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude}),b(he,le,ce,ge,me,De,pe,-1e-5*U,!0,-1e-5*H),b(he,le,ce,ge,me,De,Ie,-1e-5*H,!1),b(he,le,ce,ge,me,De,ve,1e-5*U,!0,1e-5*H),b(he,le,ce,ge,me,De,Ee,1e-5*H,!1),pe.length>0&&Ee.length>0){var Ge=pe[0].index,ze=He,je=Ee[Ee.length-1].index,qe=he.length-1;me.push(je,qe,ze,ze,Ge,je)}re=he.length;var Je,Ke=t.fromPoints(he);a(v)&&v.width<d.PI_OVER_TWO+d.EPSILON5&&(Je=c.fromRectangle(v,K,Q,l));for(var Qe=new s(l).computeHorizonCullingPoint(u,he),Xe=new e(X,Z,u),Ze=new m(Xe,De.hMin,Q,j,!1,M),$e=new Float32Array(re*Ze.getStride()),et=0,tt=0;tt<re;++tt)et=Ze.encode($e,et,he[tt],ce[tt],le[tt],void 0,ge[tt]);var rt=pe.map(function(e){return e.index}).reverse(),nt=Ie.map(function(e){return e.index}).reverse(),it=ve.map(function(e){return e.index}).reverse(),ot=Ee.map(function(e){return e.index}).reverse();return nt.unshift(it[it.length-1]),nt.push(rt[0]),ot.unshift(rt[rt.length-1]),ot.push(it[0]),{vertices:$e,indices:new Uint16Array(me),maximumHeight:Q,minimumHeight:K,encoding:Ze,boundingSphere3D:Ke,orientedBoundingBox:Je,occludeePointInScaledSpace:Qe,vertexCountWithoutSkirts:He,skirtIndex:Le,westIndicesSouthToNorth:rt,southIndicesEastToWest:nt,eastIndicesNorthToSouth:it,northIndicesWestToEast:ot}}(o.buffer,o.relativeToCenter,o.ellipsoid,o.rectangle,o.nativeRectangle,o.exaggeration,o.skirtHeight,o.includeWebMercatorT,o.negativeAltitudeExponentBias,o.negativeElevationThreshold),_=A.vertices;v.push(_.buffer);var y=A.indices;return v.push(y.buffer),{vertices:_.buffer,indices:y.buffer,numberOfAttributes:A.encoding.getStride(),minimumHeight:A.minimumHeight,maximumHeight:A.maximumHeight,boundingSphere3D:A.boundingSphere3D,orientedBoundingBox:A.orientedBoundingBox,occludeePointInScaledSpace:A.occludeePointInScaledSpace,encoding:A.encoding,vertexCountWithoutSkirts:A.vertexCountWithoutSkirts,skirtIndex:A.skirtIndex,westIndicesSouthToNorth:A.westIndicesSouthToNorth,southIndicesEastToWest:A.southIndicesEastToWest,eastIndicesNorthToSouth:A.eastIndicesNorthToSouth,northIndicesWestToEast:A.northIndicesWestToEast}})});