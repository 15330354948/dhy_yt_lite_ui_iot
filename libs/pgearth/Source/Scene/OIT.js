define(["../Core/BoundingRectangle","../Core/Color","../Core/defined","../Core/destroyObject","../Core/PixelFormat","../Core/WebGLConstants","../Renderer/ClearCommand","../Renderer/DrawCommand","../Renderer/Framebuffer","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/ShaderSource","../Renderer/Texture","../Shaders/AdjustTranslucentFS","../Shaders/CompositeOITFS","./BlendEquation","./BlendFunction"],function(e,t,a,r,n,o,s,u,i,d,m,c,l,h,_,p,C){"use strict";function f(a){this._translucentMultipassSupport=!1,this._translucentMRTSupport=!1;var r=a.colorBufferFloat&&a.depthTexture;this._translucentMRTSupport=a.drawBuffers&&r,this._translucentMultipassSupport=!this._translucentMRTSupport&&r,this._opaqueFBO=void 0,this._opaqueTexture=void 0,this._depthStencilTexture=void 0,this._accumulationTexture=void 0,this._translucentFBO=void 0,this._alphaFBO=void 0,this._adjustTranslucentFBO=void 0,this._adjustAlphaFBO=void 0,this._opaqueClearCommand=new s({color:new t(0,0,0,0),owner:this}),this._translucentMRTClearCommand=new s({color:new t(0,0,0,1),owner:this}),this._translucentMultipassClearCommand=new s({color:new t(0,0,0,0),owner:this}),this._alphaClearCommand=new s({color:new t(1,1,1,1),owner:this}),this._translucentRenderStateCache={},this._alphaRenderStateCache={},this._compositeCommand=void 0,this._adjustTranslucentCommand=void 0,this._adjustAlphaCommand=void 0,this._viewport=new e,this._rs=void 0,this._useScissorTest=!1,this._scissorRectangle=void 0,this._useHDR=!1}function g(e){e._accumulationTexture=e._accumulationTexture&&!e._accumulationTexture.isDestroyed()&&e._accumulationTexture.destroy(),e._revealageTexture=e._revealageTexture&&!e._revealageTexture.isDestroyed()&&e._revealageTexture.destroy()}function T(e){e._translucentFBO=e._translucentFBO&&!e._translucentFBO.isDestroyed()&&e._translucentFBO.destroy(),e._alphaFBO=e._alphaFBO&&!e._alphaFBO.isDestroyed()&&e._alphaFBO.destroy(),e._adjustTranslucentFBO=e._adjustTranslucentFBO&&!e._adjustTranslucentFBO.isDestroyed()&&e._adjustTranslucentFBO.destroy(),e._adjustAlphaFBO=e._adjustAlphaFBO&&!e._adjustAlphaFBO.isDestroyed()&&e._adjustAlphaFBO.destroy()}function S(e){g(e),T(e)}f.prototype.update=function(t,r,s,u){if(this.isSupported()){this._opaqueFBO=s,this._opaqueTexture=s.getColorTexture(0),this._depthStencilTexture=s.depthStencilTexture;var p=this._opaqueTexture.width,C=this._opaqueTexture.height,f=this._accumulationTexture,v=!a(f)||f.width!==p||f.height!==C||u!==this._useHDR;if(v&&function(e,t,a,r){g(e),e._accumulationTexture=new l({context:t,width:a,height:r,pixelFormat:n.RGBA,pixelDatatype:d.FLOAT});var o=new Float32Array(a*r*4);e._revealageTexture=new l({context:t,pixelFormat:n.RGBA,pixelDatatype:d.FLOAT,source:{arrayBufferView:o,width:a,height:r},flipY:!1})}(this,t,p,C),a(this._translucentFBO)&&!v||function(e,t){T(e);var a=o.FRAMEBUFFER_COMPLETE,r=!0;if(e._translucentMRTSupport&&(e._translucentFBO=new i({context:t,colorTextures:[e._accumulationTexture,e._revealageTexture],depthStencilTexture:e._depthStencilTexture,destroyAttachments:!1}),e._adjustTranslucentFBO=new i({context:t,colorTextures:[e._accumulationTexture,e._revealageTexture],destroyAttachments:!1}),e._translucentFBO.status===a&&e._adjustTranslucentFBO.status===a||(T(e),e._translucentMRTSupport=!1)),!e._translucentMRTSupport){e._translucentFBO=new i({context:t,colorTextures:[e._accumulationTexture],depthStencilTexture:e._depthStencilTexture,destroyAttachments:!1}),e._alphaFBO=new i({context:t,colorTextures:[e._revealageTexture],depthStencilTexture:e._depthStencilTexture,destroyAttachments:!1}),e._adjustTranslucentFBO=new i({context:t,colorTextures:[e._accumulationTexture],destroyAttachments:!1}),e._adjustAlphaFBO=new i({context:t,colorTextures:[e._revealageTexture],destroyAttachments:!1});var n=e._translucentFBO.status===a,s=e._alphaFBO.status===a,u=e._adjustTranslucentFBO.status===a,d=e._adjustAlphaFBO.status===a;n&&s&&u&&d||(S(e),e._translucentMultipassSupport=!1,r=!1)}return r}(this,t)){this._useHDR=u;var w,x,F=this;a(this._compositeCommand)||(w=new c({sources:[_]}),this._translucentMRTSupport&&w.defines.push("MRT"),x={u_opaque:function(){return F._opaqueTexture},u_accumulation:function(){return F._accumulationTexture},u_revealage:function(){return F._revealageTexture}},this._compositeCommand=t.createViewportQuadCommand(w,{uniformMap:x,owner:this})),a(this._adjustTranslucentCommand)||(this._translucentMRTSupport?(w=new c({defines:["MRT"],sources:[h]}),x={u_bgColor:function(){return F._translucentMRTClearCommand.color},u_depthTexture:function(){return F._depthStencilTexture}},this._adjustTranslucentCommand=t.createViewportQuadCommand(w,{uniformMap:x,owner:this})):this._translucentMultipassSupport&&(w=new c({sources:[h]}),x={u_bgColor:function(){return F._translucentMultipassClearCommand.color},u_depthTexture:function(){return F._depthStencilTexture}},this._adjustTranslucentCommand=t.createViewportQuadCommand(w,{uniformMap:x,owner:this}),x={u_bgColor:function(){return F._alphaClearCommand.color},u_depthTexture:function(){return F._depthStencilTexture}},this._adjustAlphaCommand=t.createViewportQuadCommand(w,{uniformMap:x,owner:this}))),this._viewport.width=p,this._viewport.height=C;var O=!e.equals(this._viewport,r.viewport),R=O!==this._useScissorTest;this._useScissorTest=O,e.equals(this._scissorRectangle,r.viewport)||(this._scissorRectangle=e.clone(r.viewport,this._scissorRectangle),R=!0),a(this._rs)&&e.equals(this._viewport,this._rs.viewport)&&!R||(this._rs=m.fromCache({viewport:this._viewport,scissorTest:{enabled:this._useScissorTest,rectangle:this._scissorRectangle}})),a(this._compositeCommand)&&(this._compositeCommand.renderState=this._rs),this._adjustTranslucentCommand&&(this._adjustTranslucentCommand.renderState=this._rs),a(this._adjustAlphaCommand)&&(this._adjustAlphaCommand.renderState=this._rs)}}};var v={enabled:!0,color:new t(0,0,0,0),equationRgb:p.ADD,equationAlpha:p.ADD,functionSourceRgb:C.ONE,functionDestinationRgb:C.ONE,functionSourceAlpha:C.ZERO,functionDestinationAlpha:C.ONE_MINUS_SOURCE_ALPHA},w={enabled:!0,color:new t(0,0,0,0),equationRgb:p.ADD,equationAlpha:p.ADD,functionSourceRgb:C.ONE,functionDestinationRgb:C.ONE,functionSourceAlpha:C.ONE,functionDestinationAlpha:C.ONE},x={enabled:!0,color:new t(0,0,0,0),equationRgb:p.ADD,equationAlpha:p.ADD,functionSourceRgb:C.ZERO,functionDestinationRgb:C.ONE_MINUS_SOURCE_ALPHA,functionSourceAlpha:C.ZERO,functionDestinationAlpha:C.ONE_MINUS_SOURCE_ALPHA};function F(e,t,r,n){var o=r[n.id];if(!a(o)){var s=m.getState(n);s.depthMask=!1,s.blending=t,o=m.fromCache(s),r[n.id]=o}return o}var O="    vec3 Ci = czm_gl_FragColor.rgb * czm_gl_FragColor.a;\n    float ai = czm_gl_FragColor.a;\n    float wzi = czm_alphaWeight(ai);\n    gl_FragData[0] = vec4(Ci * wzi, ai);\n    gl_FragData[1] = vec4(ai * wzi);\n",R="    vec3 Ci = czm_gl_FragColor.rgb * czm_gl_FragColor.a;\n    float ai = czm_gl_FragColor.a;\n    float wzi = czm_alphaWeight(ai);\n    gl_FragColor = vec4(Ci, ai) * wzi;\n",B="    float ai = czm_gl_FragColor.a;\n    gl_FragColor = vec4(ai);\n";function A(e,t,r,n){var o=e.shaderCache.getDerivedShaderProgram(t,r);if(!a(o)){var s=t._attributeLocations,u=t.fragmentShaderSource.clone();u.sources=u.sources.map(function(e){return e=(e=(e=(e=c.replaceMain(e,"czm_translucent_main")).replace(/gl_FragColor/g,"czm_gl_FragColor")).replace(/\bdiscard\b/g,"czm_discard = true")).replace(/czm_phong/g,"czm_translucentPhong")}),u.sources.splice(0,0,(-1!==n.indexOf("gl_FragData")?"#extension GL_EXT_draw_buffers : enable \n":"")+"vec4 czm_gl_FragColor;\nbool czm_discard = false;\n"),u.sources.push("void main()\n{\n    czm_translucent_main();\n    if (czm_discard)\n    {\n        discard;\n    }\n"+n+"}\n"),o=e.shaderCache.createDerivedShaderProgram(t,r,{vertexShaderSource:t.vertexShaderSource,fragmentShaderSource:u,attributeLocations:s})}return o}return f.prototype.createDerivedCommands=function(e,t,r){var n,o,s,i,d,m,c,l;(a(r)||(r={}),this._translucentMRTSupport)?(a(r.translucentCommand)&&(n=r.translucentCommand.shaderProgram,o=r.translucentCommand.renderState),r.translucentCommand=u.shallowClone(e,r.translucentCommand),a(n)&&r.shaderProgramId===e.shaderProgram.id?(r.translucentCommand.shaderProgram=n,r.translucentCommand.renderState=o):(r.translucentCommand.shaderProgram=function(e,t){return A(e,t,"translucentMRT",O)}(t,e.shaderProgram),r.translucentCommand.renderState=(c=this,l=e.renderState,F(0,v,c._translucentRenderStateCache,l)),r.shaderProgramId=e.shaderProgram.id)):(a(r.translucentCommand)&&(s=r.translucentCommand.shaderProgram,i=r.translucentCommand.renderState,d=r.alphaCommand.shaderProgram,m=r.alphaCommand.renderState),r.translucentCommand=u.shallowClone(e,r.translucentCommand),r.alphaCommand=u.shallowClone(e,r.alphaCommand),a(s)&&r.shaderProgramId===e.shaderProgram.id?(r.translucentCommand.shaderProgram=s,r.translucentCommand.renderState=i,r.alphaCommand.shaderProgram=d,r.alphaCommand.renderState=m):(r.translucentCommand.shaderProgram=function(e,t){return A(e,t,"translucentMultipass",R)}(t,e.shaderProgram),r.translucentCommand.renderState=function(e,t,a){return F(0,w,e._translucentRenderStateCache,a)}(this,0,e.renderState),r.alphaCommand.shaderProgram=function(e,t){return A(e,t,"alphaMultipass",B)}(t,e.shaderProgram),r.alphaCommand.renderState=function(e,t,a){return F(0,x,e._alphaRenderStateCache,a)}(this,0,e.renderState),r.shaderProgramId=e.shaderProgram.id));return r},f.prototype.executeCommands=function(e,t,r,n,o){this._translucentMRTSupport?function(e,t,r,n,o,s){var u=t.context,i=t.frameState.useLogDepth,d=t._hdr,m=n.framebuffer,c=o.length,l=t.frameState.shadowState.lightShadowsEnabled;n.framebuffer=e._adjustTranslucentFBO,e._adjustTranslucentCommand.execute(u,n);var h,_=e._opaqueFBO;n.framebuffer=e._translucentFBO;for(var p=0;p<c;++p)h=o[p],h=i?h.derivedCommands.logDepth.command:h,h=d?h.derivedCommands.hdr.command:h,r(l&&h.receiveShadows?h.derivedCommands.oit.shadows.translucentCommand:h.derivedCommands.oit.translucentCommand,t,u,n,_);a(s)&&(h=s.unclassifiedCommand,r(l&&h.receiveShadows?h.derivedCommands.oit.shadows.translucentCommand:h.derivedCommands.oit.translucentCommand,t,u,n,_)),n.framebuffer=m}(this,e,t,r,n,o):function(e,t,r,n,o,s){var u,i,d=t.context,m=t.frameState.useLogDepth,c=t._hdr,l=n.framebuffer,h=o.length,_=t.frameState.shadowState.lightShadowsEnabled;n.framebuffer=e._adjustTranslucentFBO,e._adjustTranslucentCommand.execute(d,n),n.framebuffer=e._adjustAlphaFBO,e._adjustAlphaCommand.execute(d,n);var p=e._opaqueFBO;for(n.framebuffer=e._translucentFBO,i=0;i<h;++i)u=o[i],u=m?u.derivedCommands.logDepth.command:u,u=c?u.derivedCommands.hdr.command:u,r(_&&u.receiveShadows?u.derivedCommands.oit.shadows.translucentCommand:u.derivedCommands.oit.translucentCommand,t,d,n,p);for(a(s)&&(u=s.unclassifiedCommand,r(_&&u.receiveShadows?u.derivedCommands.oit.shadows.translucentCommand:u.derivedCommands.oit.translucentCommand,t,d,n,p)),n.framebuffer=e._alphaFBO,i=0;i<h;++i)u=o[i],u=m?u.derivedCommands.logDepth.command:u,u=c?u.derivedCommands.hdr.command:u,r(_&&u.receiveShadows?u.derivedCommands.oit.shadows.alphaCommand:u.derivedCommands.oit.alphaCommand,t,d,n,p);a(s)&&(u=s.unclassifiedCommand,r(_&&u.receiveShadows?u.derivedCommands.oit.shadows.alphaCommand:u.derivedCommands.oit.alphaCommand,t,d,n,p)),n.framebuffer=l}(this,e,t,r,n,o)},f.prototype.execute=function(e,t){this._compositeCommand.execute(e,t)},f.prototype.clear=function(e,a,r){var n=a.framebuffer;a.framebuffer=this._opaqueFBO,t.clone(r,this._opaqueClearCommand.color),this._opaqueClearCommand.execute(e,a),a.framebuffer=this._translucentFBO,(this._translucentMRTSupport?this._translucentMRTClearCommand:this._translucentMultipassClearCommand).execute(e,a),this._translucentMultipassSupport&&(a.framebuffer=this._alphaFBO,this._alphaClearCommand.execute(e,a)),a.framebuffer=n},f.prototype.isSupported=function(){return this._translucentMRTSupport||this._translucentMultipassSupport},f.prototype.isDestroyed=function(){return!1},f.prototype.destroy=function(){return S(this),a(this._compositeCommand)&&(this._compositeCommand.shaderProgram=this._compositeCommand.shaderProgram&&this._compositeCommand.shaderProgram.destroy()),a(this._adjustTranslucentCommand)&&(this._adjustTranslucentCommand.shaderProgram=this._adjustTranslucentCommand.shaderProgram&&this._adjustTranslucentCommand.shaderProgram.destroy()),a(this._adjustAlphaCommand)&&(this._adjustAlphaCommand.shaderProgram=this._adjustAlphaCommand.shaderProgram&&this._adjustAlphaCommand.shaderProgram.destroy()),r(this)},f});