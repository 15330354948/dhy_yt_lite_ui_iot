define(["./ArcType","./arrayRemoveDuplicates","./Cartesian2","./Cartesian3","./Cartographic","./ComponentDatatype","./defaultValue","./defined","./DeveloperError","./Ellipsoid","./EllipsoidRhumbLine","./Geometry","./GeometryAttribute","./GeometryAttributes","./GeometryPipeline","./IndexDatatype","./Math","./Matrix3","./PolygonPipeline","./PrimitiveType","./Quaternion","./Queue","./WindingOrder"],function(e,r,n,t,i,a,o,u,s,l,c,h,p,f,v,d,g,y,m,w,b,I,E){"use strict";var T={computeHierarchyPackedLength:function(e){for(var r=0,n=[e];n.length>0;){var i=n.pop();if(u(i)){r+=2;var a=i.positions,o=i.holes;if(u(a)&&(r+=a.length*t.packedLength),u(o))for(var s=o.length,l=0;l<s;++l)n.push(o[l])}}return r},packPolygonHierarchy:function(e,r,n){for(var i=[e];i.length>0;){var a=i.pop();if(u(a)){var o=a.positions,s=a.holes;if(r[n++]=u(o)?o.length:0,r[n++]=u(s)?s.length:0,u(o))for(var l=o.length,c=0;c<l;++c,n+=3)t.pack(o[c],r,n);if(u(s))for(var h=s.length,p=0;p<h;++p)i.push(s[p])}}return n},unpackPolygonHierarchy:function(e,r){for(var n=e[r++],i=e[r++],a=new Array(n),o=i>0?new Array(i):void 0,u=0;u<n;++u,r+=t.packedLength)a[u]=t.unpack(e,r);for(var s=0;s<i;++s)o[s]=T.unpackPolygonHierarchy(e,r),r=o[s].startingIndex,delete o[s].startingIndex;return{positions:a,holes:o,startingIndex:r}}},x=new t;function S(e,r,n,i){return t.subtract(r,e,x),t.multiplyByScalar(x,n/i,x),t.add(e,x,x),[x.x,x.y,x.z]}T.subdivideLineCount=function(e,r,n){var i=t.distance(e,r)/n,a=Math.max(0,Math.ceil(g.log2(i)));return Math.pow(2,a)};var L=new i,C=new i,A=new i,G=new t;T.subdivideRhumbLineCount=function(e,r,n,t){var i=e.cartesianToCartographic(r,L),a=e.cartesianToCartographic(n,C),o=new c(i,a,e).surfaceDistance/t,u=Math.max(0,Math.ceil(g.log2(o)));return Math.pow(2,u)},T.subdivideLine=function(e,r,n,i){var a=T.subdivideLineCount(e,r,n),o=t.distance(e,r),s=o/a;u(i)||(i=[]);var l=i;l.length=3*a;for(var c=0,h=0;h<a;h++){var p=S(e,r,h*s,o);l[c++]=p[0],l[c++]=p[1],l[c++]=p[2]}return l},T.subdivideRhumbLine=function(e,r,n,t,i){var a=e.cartesianToCartographic(r,L),o=e.cartesianToCartographic(n,C),s=new c(a,o,e),l=s.surfaceDistance/t,h=Math.max(0,Math.ceil(g.log2(l))),p=Math.pow(2,h),f=s.surfaceDistance/p;u(i)||(i=[]);var v=i;v.length=3*p;for(var d=0,y=0;y<p;y++){var m=s.interpolateUsingSurfaceDistance(y*f,A),w=e.cartographicToCartesian(m,G);v[d++]=w.x,v[d++]=w.y,v[d++]=w.z}return v};var N=new t,D=new t,M=new t,O=new t;T.scaleToGeodeticHeightExtruded=function(e,r,n,i,a){i=o(i,l.WGS84);var s=N,c=D,h=M,p=O;if(u(e)&&u(e.attributes)&&u(e.attributes.position))for(var f=e.attributes.position.values,v=f.length/2,d=0;d<v;d+=3)t.fromArray(f,d,h),i.geodeticSurfaceNormal(h,s),p=i.scaleToGeodeticSurface(h,p),c=t.multiplyByScalar(s,n,c),c=t.add(p,c,c),f[d+v]=c.x,f[d+1+v]=c.y,f[d+2+v]=c.z,a&&(p=t.clone(h,p)),c=t.multiplyByScalar(s,r,c),c=t.add(p,c,c),f[d]=c.x,f[d+1]=c.y,f[d+2]=c.z;return e},T.polygonOutlinesFromHierarchy=function(e,n,i){var a,o,s,l=[],c=new I;for(c.enqueue(e);0!==c.length;){var h=c.dequeue(),p=h.positions;if(n)for(s=p.length,a=0;a<s;a++)i.scaleToGeodeticSurface(p[a],p[a]);if(!((p=r(p,t.equalsEpsilon,!0)).length<3)){var f=h.holes?h.holes.length:0;for(a=0;a<f;a++){var v=h.holes[a],d=v.positions;if(n)for(s=d.length,o=0;o<s;++o)i.scaleToGeodeticSurface(d[o],d[o]);if(!((d=r(d,t.equalsEpsilon,!0)).length<3)){l.push(d);var g=0;for(u(v.holes)&&(g=v.holes.length),o=0;o<g;o++)c.enqueue(v.holes[o])}}l.push(p)}}return l},T.polygonsFromHierarchy=function(e,n,i,a){var o=[],s=[],l=new I;for(l.enqueue(e);0!==l.length;){var c,h,p=l.dequeue(),f=p.positions,v=p.holes;if(i)for(h=f.length,c=0;c<h;c++)a.scaleToGeodeticSurface(f[c],f[c]);if(!((f=r(f,t.equalsEpsilon,!0)).length<3)){var d=n(f);if(u(d)){var g=[],y=m.computeWindingOrder2D(d);y===E.CLOCKWISE&&(d.reverse(),f=f.slice().reverse());var w,b=f.slice(),T=u(v)?v.length:0,x=[];for(c=0;c<T;c++){var S=v[c],L=S.positions;if(i)for(h=L.length,w=0;w<h;++w)a.scaleToGeodeticSurface(L[w],L[w]);if(!((L=r(L,t.equalsEpsilon,!0)).length<3)){var C=n(L);if(u(C)){(y=m.computeWindingOrder2D(C))===E.CLOCKWISE&&(C.reverse(),L=L.slice().reverse()),x.push(L),g.push(b.length),b=b.concat(L),d=d.concat(C);var A=0;for(u(S.holes)&&(A=S.holes.length),w=0;w<A;w++)l.enqueue(S.holes[w])}}}o.push({outerRing:f,holes:x}),s.push({positions:b,positions2D:d,holes:g})}}}return{hierarchy:o,polygons:s}};var P=new n,R=new t,q=new b,B=new y;T.computeBoundingRectangle=function(e,r,n,i,a){for(var o=b.fromAxisAngle(e,i,q),s=y.fromQuaternion(o,B),l=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,h=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,f=n.length,v=0;v<f;++v){var d=t.clone(n[v],R);y.multiplyByVector(s,d,d);var g=r(d,P);u(g)&&(l=Math.min(l,g.x),c=Math.max(c,g.x),h=Math.min(h,g.y),p=Math.max(p,g.y))}return a.x=l,a.y=h,a.width=c-l,a.height=p-h,a},T.createGeometryFromPositions=function(r,n,t,i,o,u){var s=m.triangulate(n.positions2D,n.holes);s.length<3&&(s=[0,1,2]);var l=n.positions;if(i){for(var c=l.length,f=new Array(3*c),d=0,g=0;g<c;g++){var y=l[g];f[d++]=y.x,f[d++]=y.y,f[d++]=y.z}var b=new h({attributes:{position:new p({componentDatatype:a.DOUBLE,componentsPerAttribute:3,values:f})},indices:s,primitiveType:w.TRIANGLES});return o.normal?v.computeNormal(b):b}return u===e.GEODESIC?m.computeSubdivision(r,l,s,t):u===e.RHUMB?m.computeRhumbLineSubdivision(r,l,s,t):void 0};var H=[],z=new t,k=new t;return T.computeWallGeometry=function(r,n,i,o,u){var s,l,c,v,y,m=r.length,b=0;if(o)for(l=3*m*2,s=new Array(2*l),c=0;c<m;c++)v=r[c],y=r[(c+1)%m],s[b]=s[b+l]=v.x,s[++b]=s[b+l]=v.y,s[++b]=s[b+l]=v.z,s[++b]=s[b+l]=y.x,s[++b]=s[b+l]=y.y,s[++b]=s[b+l]=y.z,++b;else{var I=g.chordLength(i,n.maximumRadius),E=0;if(u===e.GEODESIC)for(c=0;c<m;c++)E+=T.subdivideLineCount(r[c],r[(c+1)%m],I);else if(u===e.RHUMB)for(c=0;c<m;c++)E+=T.subdivideRhumbLineCount(n,r[c],r[(c+1)%m],I);for(l=3*(E+m),s=new Array(2*l),c=0;c<m;c++){var x;v=r[c],y=r[(c+1)%m],u===e.GEODESIC?x=T.subdivideLine(v,y,I,H):u===e.RHUMB&&(x=T.subdivideRhumbLine(n,v,y,I,H));for(var S=x.length,L=0;L<S;++L,++b)s[b]=x[L],s[b+l]=x[L];s[b]=y.x,s[b+l]=y.x,s[++b]=y.y,s[b+l]=y.y,s[++b]=y.z,s[b+l]=y.z,++b}}m=s.length;var C=d.createTypedArray(m/3,m-6*r.length),A=0;for(m/=6,c=0;c<m;c++){var G=c,N=G+1,D=G+m,M=D+1;v=t.fromArray(s,3*G,z),y=t.fromArray(s,3*N,k),t.equalsEpsilon(v,y,g.EPSILON14,g.EPSILON6)||(C[A++]=G,C[A++]=D,C[A++]=N,C[A++]=N,C[A++]=D,C[A++]=M)}return new h({attributes:new f({position:new p({componentDatatype:a.DOUBLE,componentsPerAttribute:3,values:s})}),indices:C,primitiveType:w.TRIANGLES})},T});