define(["../Core/ApproximateTerrainHeights","../Core/BoundingRectangle","../Core/BoundingSphere","../Core/BoxGeometry","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/Check","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/createGuid","../Core/CullingVolume","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/EllipsoidGeometry","../Core/Event","../Core/GeographicProjection","../Core/GeometryInstance","../Core/GeometryPipeline","../Core/Intersect","../Core/JulianDate","../Core/Math","../Core/Matrix4","../Core/mergeSort","../Core/Occluder","../Core/OrthographicFrustum","../Core/OrthographicOffCenterFrustum","../Core/PerspectiveFrustum","../Core/PerspectiveOffCenterFrustum","../Core/PixelFormat","../Core/Ray","../Core/RequestScheduler","../Core/ShowGeometryInstanceAttribute","../Core/TaskProcessor","../Core/Transforms","../Renderer/ClearCommand","../Renderer/ComputeEngine","../Renderer/Context","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Framebuffer","../Renderer/Pass","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/Texture","../ThirdParty/when","./BrdfLutGenerator","./Camera","./PGEarth3DTileFeature","./PGEarth3DTilePass","./PGEarth3DTilePassState","./PGEarth3DTileset","./CreditDisplay","./DebugCameraPrimitive","./DepthPlane","./DerivedCommand","./DeviceOrientationCameraController","./Fog","./FrameState","./GlobeDepth","./InvertClassification","./JobScheduler","./MapMode2D","./OctahedralProjectedCubeMap","./PerformanceDisplay","./PerInstanceColorAppearance","./PickDepth","./PostProcessStageCollection","./Primitive","./PrimitiveCollection","./SceneMode","./SceneTransforms","./SceneTransitioner","./ScreenSpaceCameraController","./ShadowMap","./StencilConstants","./SunPostProcess","./TweenCollection","./View","../Oblique/PGPageLOD/PGPageLODCollection"],function(e,t,r,i,o,s,n,a,u,m,d,h,c,l,p,f,g,_,v,C,w,b,S,D,y,P,x,E,T,F,R,L,O,k,A,I,V,M,N,G,B,W,H,U,j,q,z,Q,K,Y,J,X,Z,$,ee,te,re,ie,oe,se,ne,ae,ue,me,de,he,ce,le,pe,fe,ge,_e,ve,Ce,we,be,Se,De,ye,Pe,xe,Ee,Te,Fe,Re){"use strict";var Le=function(e){return function(){e.frameState.afterRender.push(function(){e.requestRender()})}};function Oe(e){var r=(e=c(e,c.EMPTY_OBJECT)).canvas,i=e.contextOptions,o=e.creditContainer,n=e.creditViewport;if(!l(r))throw new g("options and options.canvas are required.");var a=l(o),m=new B(r,i);a||((o=document.createElement("div")).style.position="absolute",o.style.bottom="0",o.style["text-shadow"]="0 0 2px #000000",o.style.color="#ffffff",o.style["font-size"]="10px",o.style["padding-right"]="5px",r.parentNode.appendChild(o)),l(n)||(n=r.parentNode),this._id=d(),this._jobScheduler=new ce,this._frameState=new me(m,new ie(o," â€¢ ",n),this._jobScheduler),this._frameState.scene3DOnly=c(e.scene3DOnly,!1),this._removeCreditContainer=!a,this._creditContainer=o,this._canvas=r,this._context=m,this._computeEngine=new G(m),this._globe=void 0,this._primitives=new we,this._groundPrimitives=new we,this._mostDetailedRayPicks=[],this._logDepthBuffer=!1,this._logDepthBufferDirty=!0,this._tweens=new Te,this._pageLODs=new Re,this._shaderFrameCount=0,this._sunPostProcess=void 0,this._computeCommandList=[],this._overlayCommandList=[],this._useOIT=c(e.orderIndependentTranslucency,!0),this._executeOITFunction=void 0,this._depthPlane=new se,this._clearColorCommand=new N({color:new u,stencil:0,owner:this}),this._depthClearCommand=new N({depth:1,owner:this}),this._stencilClearCommand=new N({stencil:0}),this._classificationStencilClearCommand=new N({stencil:0,renderState:z.fromCache({stencilMask:xe.CLASSIFICATION_MASK})}),this._depthOnlyRenderStateCache={},this._pickRenderStateCache={},this._transitioner=new De(this),this._preUpdate=new v,this._postUpdate=new v,this._renderError=new v,this._preRender=new v,this._postRender=new v,this._pickPositionCache={},this._pickPositionCacheDirty=!1,this._minimumDisableDepthTestDistance=0,this.rethrowRenderErrors=!1,this.completeMorphOnUserInput=!0,this.morphStart=new v,this.morphComplete=new v,this.skyBox=void 0,this.skyAtmosphere=void 0,this.sun=void 0,this.sunBloom=!0,this._sunBloom=void 0,this.moon=void 0,this.backgroundColor=u.clone(u.BLACK),this._mode=be.SCENE3D,this._mapProjection=l(e.mapProjection)?e.mapProjection:new C,this.morphTime=1,this.farToNearRatio=1e3,this.logarithmicDepthFarToNearRatio=1e9,this.nearToFarDistance2D=175e4,this.debugCommandFilter=void 0,this.debugShowCommands=!1,this.debugShowFrustums=!1,this.debugShowFramesPerSecond=!1,this.debugShowGlobeDepth=!1,this.debugShowDepthFrustum=1,this.debugShowFrustumPlanes=!1,this._debugShowFrustumPlanes=!1,this._debugFrustumPlanes=void 0,this.useDepthPicking=!0,this.pickTranslucentDepth=!1,this.cameraEventWaitTime=500,this.fog=new ue,this._sunCamera=new Z(this),this.shadowMap=new Pe({context:m,lightCamera:this._sunCamera,enabled:c(e.shadows,!1)}),this.invertClassification=!1,this.invertClassificationColor=u.clone(u.WHITE),this._actualInvertClassificationColor=u.clone(this._invertClassificationColor),this._invertClassification=new he,this.focalLength=void 0,this.eyeSeparation=void 0,this.postProcessStages=new ve,this._brdfLutGenerator=new X,this._terrainExaggeration=c(e.terrainExaggeration,1),this._performanceDisplay=void 0,this._debugVolume=void 0,this._screenSpaceCameraController=new ye(this),this._mapMode2D=c(e.mapMode2D,le.INFINITE_SCROLL),this._environmentState={skyBoxCommand:void 0,skyAtmosphereCommand:void 0,sunDrawCommand:void 0,sunComputeCommand:void 0,moonCommand:void 0,isSunVisible:!1,isMoonVisible:!1,isReadyForAtmosphere:!1,isSkyAtmosphereVisible:!1,clearGlobeDepth:!1,useDepthPlane:!1,renderTranslucentDepthForPick:!1,originalFramebuffer:void 0,useGlobeDepthFramebuffer:!1,useOIT:!1,useInvertClassification:!1,usePostProcess:!1,usePostProcessSelected:!1,useWebVR:!1},this._useWebVR=!1,this._cameraVR=void 0,this._aspectRatioVR=void 0,this._useSingleFrustum=!0,this.requestRenderMode=c(e.requestRenderMode,!1),this._renderRequested=!0,this.maximumRenderTimeChange=c(e.maximumRenderTimeChange,0),this._lastRenderTime=void 0,this._frameRateMonitor=void 0,this._removeRequestListenerCallback=A.requestCompletedEvent.addEventListener(Le(this)),this._removeTaskProcessorListenerCallback=V.taskCompletedEvent.addEventListener(Le(this)),this._removeGlobeCallbacks=[];var h=new t(0,0,m.drawingBufferWidth,m.drawingBufferHeight),p=new Z(this);this._logDepthBuffer&&(p.frustum.near=.1,p.frustum.far=1e10);var f=new t(0,0,1,1),_=new Z(this);_.frustum=new T({width:.1,aspectRatio:1,near:.1}),this._pickOffscreenView=new Fe(this,_,f),this.preloadFlightCamera=new Z(this),this.preloadFlightCullingVolume=void 0,this.pickOffscreenDefaultWidth=.1,this._defaultView=new Fe(this,p,h),this._view=this._defaultView,this._hdr=void 0,this._hdrDirty=void 0,this.highDynamicRange=!1,this.gamma=2.2,this._sunColor=new s(1.8,1.85,2),this.sphericalHarmonicCoefficients=void 0,this.specularEnvironmentMaps=void 0,this._specularEnvironmentMapAtlas=void 0,je(this,0,D.now()),qe(this),this.initializeFrame()}function ke(e,t,r){var i=e._frameState,o=e._context,s=e._view.oit,n=i.shadowState.lightShadowMaps,a=i.shadowState.lightShadowsEnabled,u=t.derivedCommands;l(t.pickId)&&(u.picking=ne.createPickDerivedCommand(e,t,o,u.picking)),t.pickOnly||(u.depth=ne.createDepthOnlyDerivedCommand(e,t,o,u.depth)),u.originalCommand=t,e._hdr&&(u.hdr=ne.createHdrCommand(t,o,u.hdr),u=(t=u.hdr.command).derivedCommands),a&&t.receiveShadows&&(u.shadows=Pe.createReceiveDerivedCommand(n,t,r,o,u.shadows)),t.pass===j.TRANSLUCENT&&l(s)&&s.isSupported()&&(a&&t.receiveShadows?(u.oit=l(u.oit)?u.oit:{},u.oit.shadows=s.createDerivedCommands(u.shadows.receiveCommand,o,u.oit.shadows)):u.oit=s.createDerivedCommands(t,o,u.oit))}p(Oe.prototype,{canvas:{get:function(){return this._canvas}},drawingBufferHeight:{get:function(){return this._context.drawingBufferHeight}},drawingBufferWidth:{get:function(){return this._context.drawingBufferWidth}},maximumAliasedLineWidth:{get:function(){return W.maximumAliasedLineWidth}},maximumCubeMapSize:{get:function(){return W.maximumCubeMapSize}},pickPositionSupported:{get:function(){return this._context.depthTexture}},sampleHeightSupported:{get:function(){return this._context.depthTexture}},clampToHeightSupported:{get:function(){return this._context.depthTexture}},invertClassificationSupported:{get:function(){return this._context.depthTexture}},globe:{get:function(){return this._globe},set:function(e){this._globe=this._globe&&this._globe.destroy(),this._globe=e,function(e,t){for(var r=0;r<e._removeGlobeCallbacks.length;++r)e._removeGlobeCallbacks[r]();e._removeGlobeCallbacks.length=0;var i=[];l(t)&&(i.push(t.imageryLayersUpdatedEvent.addEventListener(Le(e))),i.push(t.terrainProviderChanged.addEventListener(Le(e)))),e._removeGlobeCallbacks=i}(this,e)}},primitives:{get:function(){return this._primitives}},groundPrimitives:{get:function(){return this._groundPrimitives}},pageLODLayers:{get:function(){return this._pageLODs}},camera:{get:function(){return this._view.camera},set:function(e){this._view.camera=e}},screenSpaceCameraController:{get:function(){return this._screenSpaceCameraController}},mapProjection:{get:function(){return this._mapProjection}},frameState:{get:function(){return this._frameState}},tweens:{get:function(){return this._tweens}},imageryLayers:{get:function(){if(l(this.globe))return this.globe.imageryLayers}},terrainProvider:{get:function(){if(l(this.globe))return this.globe.terrainProvider},set:function(e){l(this.globe)&&(this.globe.terrainProvider=e)}},terrainProviderChanged:{get:function(){if(l(this.globe))return this.globe.terrainProviderChanged}},preUpdate:{get:function(){return this._preUpdate}},postUpdate:{get:function(){return this._postUpdate}},renderError:{get:function(){return this._renderError}},preRender:{get:function(){return this._preRender}},postRender:{get:function(){return this._postRender}},lastRenderTime:{get:function(){return this._lastRenderTime}},context:{get:function(){return this._context}},debugFrustumStatistics:{get:function(){return this._view.debugFrustumStatistics}},scene3DOnly:{get:function(){return this._frameState.scene3DOnly}},orderIndependentTranslucency:{get:function(){return this._useOIT}},id:{get:function(){return this._id}},mode:{get:function(){return this._mode},set:function(e){if(this.scene3DOnly&&e!==be.SCENE3D)throw new g("Only SceneMode.SCENE3D is valid when scene3DOnly is true.");if(e===be.SCENE2D)this.morphTo2D(0);else if(e===be.SCENE3D)this.morphTo3D(0);else{if(e!==be.COLUMBUS_VIEW)throw new g("value must be a valid SceneMode enumeration.");this.morphToColumbusView(0)}this._mode=e}},frustumCommandsList:{get:function(){return this._view.frustumCommandsList}},numberOfFrustums:{get:function(){return this._view.frustumCommandsList.length}},terrainExaggeration:{get:function(){return this._terrainExaggeration}},useWebVR:{get:function(){return this._useWebVR},set:function(e){if(this.camera.frustum instanceof T)throw new g("VR is unsupported with an orthographic projection.");this._useWebVR=e,this._useWebVR?(this._frameState.creditDisplay.container.style.visibility="hidden",this._cameraVR=new Z(this),l(this._deviceOrientationCameraController)||(this._deviceOrientationCameraController=new ae(this)),this._aspectRatioVR=this.camera.frustum.aspectRatio):(this._frameState.creditDisplay.container.style.visibility="visible",this._cameraVR=void 0,this._deviceOrientationCameraController=this._deviceOrientationCameraController&&!this._deviceOrientationCameraController.isDestroyed()&&this._deviceOrientationCameraController.destroy(),this.camera.frustum.aspectRatio=this._aspectRatioVR,this.camera.frustum.xOffset=0)}},mapMode2D:{get:function(){return this._mapMode2D}},imagerySplitPosition:{get:function(){return this._frameState.imagerySplitPosition},set:function(e){this._frameState.imagerySplitPosition=e}},minimumDisableDepthTestDistance:{get:function(){return this._minimumDisableDepthTestDistance},set:function(e){if(!l(e)||e<0)throw new g("minimumDisableDepthTestDistance must be greater than or equal to 0.0.");this._minimumDisableDepthTestDistance=e}},logarithmicDepthBuffer:{get:function(){return this._logDepthBuffer},set:function(e){e=this._context.fragmentDepth&&e,this._logDepthBuffer!==e&&(this._logDepthBuffer=e,this._logDepthBufferDirty=!0,this._defaultView.updateFrustums=!0)}},gamma:{get:function(){return this._context.uniformState.gamma},set:function(e){this._context.uniformState.gamma=e}},highDynamicRange:{get:function(){return this._hdr},set:function(e){var t=this._context,r=e&&t.depthTexture&&(t.colorBufferFloat||t.colorBufferHalfFloat);this._hdrDirty=r!==this._hdr,this._hdr=r}},highDynamicRangeSupported:{get:function(){var e=this._context;return e.depthTexture&&(e.colorBufferFloat||e.colorBufferHalfFloat)}},sunColor:{get:function(){return this._sunColor},set:function(e){this._sunColor=e}},opaqueFrustumNearOffset:{get:function(){return this._frameState.useLogDepth?.9:.9999}},useSingleFrustum:{get:function(){return this._useSingleFrustum},set:function(e){this._useSingleFrustum=e,e&&(this.camera.frustum.near=1,this.camera.frustum.far=5e8)}}}),Oe.prototype.getCompressedTextureFormatSupported=function(e){var t=this.context;return("WEBGL_compressed_texture_s3tc"===e||"s3tc"===e)&&t.s3tc||("WEBGL_compressed_texture_pvrtc"===e||"pvrtc"===e)&&t.pvrtc||("WEBGL_compressed_texture_etc1"===e||"etc1"===e)&&t.etc1},Oe.prototype.updateDerivedCommands=function(e){if(l(e.derivedCommands)){var t=this._frameState,r=this._context,i=!1,o=t.shadowState.lastDirtyTime;e.lastDirtyTime!==o&&(e.lastDirtyTime=o,e.dirty=!0,i=!0);var s=t.useLogDepth,n=this._hdr,a=e.derivedCommands,u=l(a.logDepth),m=l(a.hdr),d=l(a.originalCommand),h=s&&!u,c=n&&!m,p=!(s&&n||d);if(e.dirty=e.dirty||h||c||p,e.dirty){e.dirty=!1;var f=t.shadowState.shadowMaps;t.shadowState.shadowsEnabled&&e.castShadows&&(a.shadows=Pe.createCastDerivedCommand(f,e,i,r,a.shadows)),(u||h)&&(a.logDepth=ne.createLogDepthCommand(e,r,a.logDepth),ke(this,a.logDepth.command,i)),(d||p)&&ke(this,e,i)}}};var Ae,Ie=new te({pass:ee.MOST_DETAILED_PRELOAD}),Ve=new te({pass:ee.MOST_DETAILED_PICK}),Me=new te({pass:ee.RENDER}),Ne=new te({pass:ee.PICK}),Ge=new te({pass:ee.PRELOAD}),Be=new te({pass:ee.PRELOAD_FLIGHT}),We=new te({pass:ee.REQUEST_RENDER_MODE_DEFER_CHECK}),He=new r;function Ue(e){e.render=!1,e.pick=!1,e.depth=!1,e.postProcess=!1,e.offscreen=!1}function je(e,t,r){var i=e._frameState;i.frameNumber=t,i.time=D.clone(r,i.time)}function qe(e){var t=e.camera;if(e.useSingleFrustum){var r=Math.abs(t.positionCartographic.height);if(l(e.globe)){var i=e.globe.getHeight(t.positionCartographic);l(i)&&(r=Math.abs(t.positionCartographic.height-i))}var o=r/100*.05;(o*=o)>.05&&(o=.05);var n=o*r;n<1&&(n=1),t.frustum.near=n;var a=s.magnitude(t.positionWC),m=a-t.positionCartographic.height;Math.sqrt(a*a-m*m),t.frustum.far=1e8}var d=e._frameState;d.commandList.length=0,d.shadowMaps.length=0,d.brdfLutGenerator=e._brdfLutGenerator,d.environmentMap=e.skyBox&&e.skyBox._cubeMap,d.mode=e._mode,d.morphTime=e.morphTime,d.mapProjection=e.mapProjection,d.camera=t,d.cullingVolume=t.frustum.computeCullingVolume(t.positionWC,t.directionWC,t.upWC),d.occluder=function(e){var t=e.globe;if(e._mode===be.SCENE3D&&l(t)&&t.show){var r=t.ellipsoid;return He.radius=r.minimumRadius,Ae=E.fromBoundingSphere(He,e.camera.positionWC,Ae)}}(e),d.terrainExaggeration=e._terrainExaggeration,d.minimumDisableDepthTestDistance=e._minimumDisableDepthTestDistance,d.invertClassification=e.invertClassification,d.useLogDepth=e._logDepthBuffer&&!(e.camera.frustum instanceof T||e.camera.frustum instanceof F),d.sunColor=e._sunColor,l(e._specularEnvironmentMapAtlas)&&e._specularEnvironmentMapAtlas.ready?(d.specularEnvironmentMaps=e._specularEnvironmentMapAtlas.texture,d.specularEnvironmentMapsMaximumLOD=e._specularEnvironmentMapAtlas.maximumMipmapLevel):(d.specularEnvironmentMaps=void 0,d.specularEnvironmentMapsMaximumLOD=void 0),d.sphericalHarmonicCoefficients=e.sphericalHarmonicCoefficients,e._actualInvertClassificationColor=u.clone(e.invertClassificationColor,e._actualInvertClassificationColor),he.isTranslucencySupported(e._context)||(e._actualInvertClassificationColor.alpha=1),d.invertClassificationColor=e._actualInvertClassificationColor,l(e.globe)?d.maximumScreenSpaceError=e.globe.maximumScreenSpaceError:d.maximumScreenSpaceError=2,Ue(d.passes),d.tilesetPassState=void 0}var ze=new h;function Qe(e,t,r){var i=H.shallowClone(e);i.shaderProgram=function(e,t,r){var i=t.context,o=c(r,e.shaderProgram),s=o.fragmentShaderSource.clone(),n=[];s.sources=s.sources.map(function(e){e=K.replaceMain(e,"czm_Debug_main");for(var t,r=/gl_FragData\[(\d+)\]/g;null!==(t=r.exec(e));)-1===n.indexOf(t[1])&&n.push(t[1]);return e});var a,m=n.length,d="void main() \n{ \n    czm_Debug_main(); \n";if(t.debugShowCommands){l(e._debugColor)||(e._debugColor=u.fromRandom());var h=e._debugColor;if(m>0)for(a=0;a<m;++a)d+="    gl_FragData["+n[a]+"].rgb *= vec3("+h.red+", "+h.green+", "+h.blue+"); \n";else d+="    gl_FragColor.rgb *= vec3("+h.red+", "+h.green+", "+h.blue+"); \n"}if(t.debugShowFrustums){var p=1&e.debugOverlappingFrustums?"1.0":"0.0",f=2&e.debugOverlappingFrustums?"1.0":"0.0",g=4&e.debugOverlappingFrustums?"1.0":"0.0";if(m>0)for(a=0;a<m;++a)d+="    gl_FragData["+n[a]+"].rgb *= vec3("+p+", "+f+", "+g+"); \n";else d+="    gl_FragColor.rgb *= vec3("+p+", "+f+", "+g+"); \n"}d+="}",s.sources.push(d);var _=function(e){var t={},r=e.vertexAttributes;for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i].index);return t}(o);return Q.fromCache({context:i,vertexShaderSource:o.vertexShaderSource,fragmentShaderSource:s,attributeLocations:_})}(e,t),i.execute(t.context,r),i.shaderProgram.destroy()}Oe.prototype.isVisible=function(e,t,r){return l(e)&&(!l(e.boundingVolume)||!e.cull||t.computeVisibility(e.boundingVolume)!==S.OUTSIDE&&(!l(r)||!e.occlude||!e.boundingVolume.isOccluded(r)))};var Ke=new P(0,0,1,0,1,0,0,0,0,1,0,0,0,0,0,1);function Ye(e,t,r,o,n){var a=t._frameState;if(!l(t.debugCommandFilter)||t.debugCommandFilter(e))if(e instanceof N)e.execute(r,o);else{e.debugShowBoundingVolume&&l(e.boundingVolume)&&function(e,t,r,o){var n,a=t._frameState,u=a.context,d=e.boundingVolume;l(t._debugVolume)&&t._debugVolume.destroy();var h=s.clone(d.center);if(a.mode!==be.SCENE3D){h=P.multiplyByPoint(Ke,h,h);var c=a.mapProjection,p=c.unproject(h);h=c.ellipsoid.cartographicToCartesian(p)}if(l(d.radius)){var f=d.radius;n=b.toWireframe(_.createGeometry(new _({radii:new s(f,f,f),vertexFormat:ge.FLAT_VERTEX_FORMAT}))),t._debugVolume=new Ce({geometryInstances:new w({geometry:n,modelMatrix:P.fromTranslation(h),attributes:{color:new m(1,0,0,1)}}),appearance:new ge({flat:!0,translucent:!1}),asynchronous:!1})}else{var g=d.halfAxes;n=b.toWireframe(i.createGeometry(i.fromDimensions({dimensions:new s(2,2,2),vertexFormat:ge.FLAT_VERTEX_FORMAT}))),t._debugVolume=new Ce({geometryInstances:new w({geometry:n,modelMatrix:P.fromRotationTranslation(g,h,new P),attributes:{color:new m(1,0,0,1)}}),appearance:new ge({flat:!0,translucent:!1}),asynchronous:!1})}var v,C=a.commandList,S=a.commandList=[];t._debugVolume.update(a),e=S[0],a.useLogDepth&&(e=ne.createLogDepthCommand(e,u).command),l(o)&&(v=r.framebuffer,r.framebuffer=o),e.execute(u,r),l(v)&&(r.framebuffer=v),a.commandList=C}(e,t,o,n),a.useLogDepth&&l(e.derivedCommands.logDepth)&&(e=e.derivedCommands.logDepth.command);var u=a.passes;if(!u.pick&&t._hdr&&l(e.derivedCommands)&&l(e.derivedCommands.hdr)&&(e=e.derivedCommands.hdr.command),u.pick||u.depth){if(u.pick&&!u.depth&&l(e.derivedCommands.picking))return void(e=e.derivedCommands.picking.pickCommand).execute(r,o);if(l(e.derivedCommands.depth))return void(e=e.derivedCommands.depth.depthOnlyCommand).execute(r,o)}t.debugShowCommands||t.debugShowFrustums?Qe(e,t,o):a.shadowState.lightShadowsEnabled&&e.receiveShadows&&l(e.derivedCommands.shadows)?e.derivedCommands.shadows.receiveCommand.execute(r,o):e.execute(r,o)}}function Je(e,t,r,i){var o=t._frameState,s=e.derivedCommands;l(s)&&(o.useLogDepth&&l(s.logDepth)&&(e=s.logDepth.command),s=e.derivedCommands,l(s.picking)?(e=s.picking.pickCommand).execute(r,i):l(s.depth)&&(e=s.depth.depthOnlyCommand).execute(r,i))}function Xe(e,t,r){return t.boundingVolume.distanceSquaredTo(r)-e.boundingVolume.distanceSquaredTo(r)}function Ze(e,t,r){return e.boundingVolume.distanceSquaredTo(r)-t.boundingVolume.distanceSquaredTo(r)+y.EPSILON12}function $e(e,t,r,i,o){var s=e.context;x(i,Xe,e.camera.positionWC),l(o)&&t(o.unclassifiedCommand,e,s,r);for(var n=i.length,a=0;a<n;++a)t(i[a],e,s,r)}function et(e,t,r,i,o){var s=e.context;x(i,Ze,e.camera.positionWC),l(o)&&t(o.unclassifiedCommand,e,s,r);for(var n=i.length,a=0;a<n;++a)t(i[a],e,s,r)}function tt(e,t){var r=e._view.debugGlobeDepths,i=r[t];return!l(i)&&e.context.depthTexture&&(i=new de,r[t]=i),i}function rt(e,t){var r=e._view.pickDepths,i=r[t];return l(i)||(i=new _e,r[t]=i),i}Ke=P.inverseTransformation(Ke,Ke);var it=new R,ot=new L,st=new T,nt=new F;function at(e,t){var r,i=e.camera,o=e.context,s=o.uniformState;s.updateCamera(i),(r=l(i.frustum.fov)?i.frustum.clone(it):l(i.frustum.infiniteProjectionMatrix)?i.frustum.clone(ot):l(i.frustum.width)?i.frustum.clone(st):i.frustum.clone(nt)).near=i.frustum.near,r.far=i.frustum.far,s.updateFrustum(r),s.updatePass(j.ENVIRONMENT);var n,a=e._frameState.passes,u=a.pick,m=e._environmentState,d=e._view,h=m.renderTranslucentDepthForPick,c=m.useWebVR;if(!u){var p,f=m.skyBoxCommand;if(l(f)&&Ye(f,e,o,t),m.isSkyAtmosphereVisible&&Ye(m.skyAtmosphereCommand,e,o,t),m.isSunVisible)if(m.sunDrawCommand.execute(o,t),e.sunBloom&&!c)p=m.useGlobeDepthFramebuffer?d.globeDepth.framebuffer:m.usePostProcess?d.sceneFramebuffer.getFramebuffer():m.originalFramebuffer,e._sunPostProcess.execute(o),e._sunPostProcess.copy(o,p),t.framebuffer=p;m.isMoonVisible&&m.moonCommand.execute(o,t)}m.useOIT?(l(e._executeOITFunction)||(e._executeOITFunction=function(e,t,r,i,o){d.oit.executeCommands(e,t,r,i,o)}),n=e._executeOITFunction):n=a.render?$e:et;var g,_=m.clearGlobeDepth,v=m.useDepthPlane,C=e._depthClearCommand,w=e._stencilClearCommand,b=e._classificationStencilClearCommand,S=e._depthPlane,D=m.usePostProcessSelected,y=i.position.z,P=d.frustumCommandsList,x=P.length;i.workingFrustums.length=0;for(var E=0;E<x;++E){var T=x-E-1,F=P[T];e.mode===be.SCENE2D?(i.position.z=y-F.near+1,r.far=Math.max(1,F.far-F.near),r.near=1,s.update(e.frameState),s.updateFrustum(r)):(r.near=0!==T?F.near*e.opaqueFrustumNearOffset:F.near,r.far=F.far,s.updateFrustum(r)),i.workingFrustums[T]=r.clone();var R,L=e.debugShowGlobeDepth?tt(e,T):d.globeDepth;e.debugShowGlobeDepth&&l(L)&&m.useGlobeDepthFramebuffer&&(L.update(o,t,d.viewport),L.clear(o,t,e._clearColorCommand.color),R=t.framebuffer,t.framebuffer=L.framebuffer),C.execute(o,t),o.stencilBuffer&&w.execute(o,t),s.updatePass(j.GLOBE);var O,k=F.commands[j.GLOBE],A=F.indices[j.GLOBE];for(g=0;g<A;++g)Ye(k[g],e,o,t);for(l(L)&&m.useGlobeDepthFramebuffer&&L.executeCopyDepth(o,t),e.debugShowGlobeDepth&&l(L)&&m.useGlobeDepthFramebuffer&&(t.framebuffer=R),s.updatePass(j.TERRAIN_CLASSIFICATION),k=F.commands[j.TERRAIN_CLASSIFICATION],A=F.indices[j.TERRAIN_CLASSIFICATION],g=0;g<A;++g)Ye(k[g],e,o,t);if(_&&(C.execute(o,t),v&&S.execute(o,t)),!m.useInvertClassification||u){for(s.updatePass(j.PGEARTH_3D_TILE),k=F.commands[j.PGEARTH_3D_TILE],A=F.indices[j.PGEARTH_3D_TILE],g=0;g<A;++g)Ye(k[g],e,o,t);if(A>0)for(l(L)&&m.useGlobeDepthFramebuffer&&L.executeUpdateDepth(o,t,_),s.updatePass(j.PGEARTH_3D_TILE_CLASSIFICATION),k=F.commands[j.PGEARTH_3D_TILE_CLASSIFICATION],A=F.indices[j.PGEARTH_3D_TILE_CLASSIFICATION],g=0;g<A;++g)Ye(k[g],e,o,t)}else{e._invertClassification.clear(o,t);var I=t.framebuffer;for(t.framebuffer=e._invertClassification._fbo,s.updatePass(j.PGEARTH_3D_TILE),k=F.commands[j.PGEARTH_3D_TILE],A=F.indices[j.PGEARTH_3D_TILE],g=0;g<A;++g)Ye(k[g],e,o,t);for(l(L)&&m.useGlobeDepthFramebuffer&&L.executeUpdateDepth(o,t,_),s.updatePass(j.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW),k=F.commands[j.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW],A=F.indices[j.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW],g=0;g<A;++g)Ye(k[g],e,o,t);for(t.framebuffer=I,e._invertClassification.executeClassified(o,t),1===e.frameState.invertClassificationColor.alpha&&e._invertClassification.executeUnclassified(o,t),A>0&&o.stencilBuffer&&b.execute(o,t),s.updatePass(j.PGEARTH_3D_TILE_CLASSIFICATION),k=F.commands[j.PGEARTH_3D_TILE_CLASSIFICATION],A=F.indices[j.PGEARTH_3D_TILE_CLASSIFICATION],g=0;g<A;++g)Ye(k[g],e,o,t)}for(A>0&&o.stencilBuffer&&w.execute(o,t),s.updatePass(j.OPAQUE),k=F.commands[j.OPAQUE],A=F.indices[j.OPAQUE],g=0;g<A;++g)Ye(k[g],e,o,t);if(0!==T&&e.mode!==be.SCENE2D&&(r.near=F.near,s.updateFrustum(r)),!u&&m.useInvertClassification&&e.frameState.invertClassificationColor.alpha<1&&(O=e._invertClassification),s.updatePass(j.TRANSLUCENT),(k=F.commands[j.TRANSLUCENT]).length=F.indices[j.TRANSLUCENT],n(e,Ye,t,k,O),o.depthTexture&&e.useDepthPicking&&(m.useGlobeDepthFramebuffer||h)){var V=h?t.framebuffer.depthStencilTexture:L.framebuffer.depthStencilTexture,M=rt(e,T);M.update(o,V),M.executeCopyDepth(o,t)}if(!u&&D){var N=t.framebuffer;for(t.framebuffer=d.sceneFramebuffer.getIdFramebuffer(),r.near=0!==T?F.near*e.opaqueFrustumNearOffset:F.near,r.far=F.far,s.updateFrustum(r),s.updatePass(j.GLOBE),k=F.commands[j.GLOBE],A=F.indices[j.GLOBE],g=0;g<A;++g)Je(k[g],e,o,t);for(_&&(C.framebuffer=t.framebuffer,C.execute(o,t),C.framebuffer=void 0),_&&v&&S.execute(o,t),s.updatePass(j.PGEARTH_3D_TILE),k=F.commands[j.PGEARTH_3D_TILE],A=F.indices[j.PGEARTH_3D_TILE],g=0;g<A;++g)Je(k[g],e,o,t);for(s.updatePass(j.OPAQUE),k=F.commands[j.OPAQUE],A=F.indices[j.OPAQUE],g=0;g<A;++g)Je(k[g],e,o,t);for(s.updatePass(j.TRANSLUCENT),k=F.commands[j.TRANSLUCENT],A=F.indices[j.TRANSLUCENT],g=0;g<A;++g)Je(k[g],e,o,t);t.framebuffer=N}}}function ut(e){e.context.uniformState.updatePass(j.COMPUTE);var t=e._environmentState.sunComputeCommand;l(t)&&t.execute(e._computeEngine);for(var r=e._computeCommandList,i=r.length,o=0;o<i;++o)r[o].execute(e._computeEngine)}function mt(e,t,r){for(var i=r.shadowMapCullingVolume,o=r.isPointLight,s=r.passes,n=s.length,a=t.length,u=0;u<a;++u){var m=t[u];if(e.updateDerivedCommands(m),m.castShadows&&(m.pass===j.GLOBE||m.pass===j.PGEARTH_3D_TILE||m.pass===j.OPAQUE||m.pass===j.TRANSLUCENT)&&e.isVisible(m,i))if(o)for(var d=0;d<n;++d)s[d].commandList.push(m);else if(1===n)s[0].commandList.push(m);else for(var h=!1,c=n-1;c>=0;--c){var l=s[c].cullingVolume;if(e.isVisible(m,l))s[c].commandList.push(m),h=!0;else if(h)break}}}function dt(e){var t=e.frameState,r=t.shadowState.shadowMaps,i=r.length;if(t.shadowState.shadowsEnabled)for(var o=e.context,s=o.uniformState,n=0;n<i;++n){var a=r[n];if(!a.outOfView){var u,m=a.passes,d=m.length;for(u=0;u<d;++u)m[u].commandList.length=0;for(mt(e,e.frameState.commandList,a),u=0;u<d;++u){var h=a.passes[u];s.updateCamera(h.camera),a.updatePass(o,u);for(var c=h.commandList.length,l=0;l<c;++l){var p=h.commandList[l];s.updatePass(p.pass),Ye(p.derivedCommands.shadows.castCommands[n],e,o,h.passState)}}}}}var ht=new s;function ct(e,r,i){var o=e._frameState.mode;e._environmentState.useWebVR?function(e,t,r){var i=e._view,o=i.camera,n=e._environmentState.renderTranslucentDepthForPick;yt(e,t,r),n||Dt(e);i.createPotentiallyVisibleSet(e),n||(ut(e),dt(e));var a=t.viewport;a.x=0,a.y=0,a.width=.5*a.width;var u=Z.clone(o,e._cameraVR);u.frustum=o.frustum;var m=o.frustum.near,d=m*c(e.focalLength,5),h=c(e.eyeSeparation,d/30),l=s.multiplyByScalar(u.right,.5*h,ht);o.frustum.aspectRatio=a.width/a.height;var p=.5*h*m/d;s.add(u.position,l,o.position),o.frustum.xOffset=p,at(e,t),a.x=a.width,s.subtract(u.position,l,o.position),o.frustum.xOffset=-p,at(e,t),Z.clone(u,o)}(e,r,i):o!==be.SCENE2D||e._mapMode2D===le.ROTATE?bt(!0,e,r,i):(yt(e,r,i),function(e,r){var i=e.context,o=e.frameState,n=e.camera,a=r.viewport,u=t.clone(a,wt);r.viewport=u;var m=lt,d=pt;e.mapProjection.project(m,d);var h=s.clone(n.position,ft),c=P.clone(n.transform,_t),l=n.frustum.clone();n._setTransform(P.IDENTITY);var p=P.computeViewportTransformation(u,0,1,gt),f=n.frustum.projectionMatrix,g=n.positionWC.y,_=s.fromElements(y.sign(g)*d.x-g,0,-n.positionWC.x,vt),v=M.pointToGLWindowCoordinates(f,p,_,Ct);v.x=Math.floor(v.x);var C=u.x,w=u.width;if(0===g||v.x<=C||v.x>=C+w)bt(!0,e,r);else if(Math.abs(C+.5*w-v.x)<1)u.width=v.x-u.x,n.position.x*=y.sign(n.position.x),n.frustum.right=0,o.cullingVolume=n.frustum.computeCullingVolume(n.positionWC,n.directionWC,n.upWC),i.uniformState.update(o),bt(!0,e,r),u.x=v.x,n.position.x=-n.position.x,n.frustum.right=-n.frustum.left,n.frustum.left=0,o.cullingVolume=n.frustum.computeCullingVolume(n.positionWC,n.directionWC,n.upWC),i.uniformState.update(o),bt(!1,e,r);else if(v.x>C+.5*w){u.width=v.x-C;var b=n.frustum.right;n.frustum.right=d.x-g,o.cullingVolume=n.frustum.computeCullingVolume(n.positionWC,n.directionWC,n.upWC),i.uniformState.update(o),bt(!0,e,r),u.x=v.x,u.width=C+w-v.x,n.position.x=-n.position.x,n.frustum.left=-n.frustum.right,n.frustum.right=b-2*n.frustum.right,o.cullingVolume=n.frustum.computeCullingVolume(n.positionWC,n.directionWC,n.upWC),i.uniformState.update(o),bt(!1,e,r)}else{u.x=v.x,u.width=C+w-v.x;var S=n.frustum.left;n.frustum.left=-d.x-g,o.cullingVolume=n.frustum.computeCullingVolume(n.positionWC,n.directionWC,n.upWC),i.uniformState.update(o),bt(!0,e,r),u.x=C,u.width=v.x-C,n.position.x=-n.position.x,n.frustum.right=-n.frustum.left,n.frustum.left=S-2*n.frustum.left,o.cullingVolume=n.frustum.computeCullingVolume(n.positionWC,n.directionWC,n.upWC),i.uniformState.update(o),bt(!1,e,r)}n._setTransform(c),s.clone(h,n.position),n.frustum=l.clone(),r.viewport=a}(e,r))}var lt=new n(Math.PI,y.PI_OVER_TWO),pt=new s,ft=new s,gt=new P,_t=new P,vt=new s,Ct=new s,wt=new t;function bt(e,t,r,i){var o=t._environmentState,s=t._view,n=o.renderTranslucentDepthForPick;e||n||(t.frameState.commandList.length=0),n||Dt(t),s.createPotentiallyVisibleSet(t),e&&(l(i)&&yt(t,r,i),n||(ut(t),dt(t))),at(t,r)}function St(e){var t=e._frameState,r=e._view,i=e._environmentState,o=t.passes.render,s=t.passes.offscreen,n=e.skyAtmosphere,a=e.globe;if(!o||e._mode!==be.SCENE2D&&r.camera.frustum instanceof T)i.skyAtmosphereCommand=void 0,i.skyBoxCommand=void 0,i.sunDrawCommand=void 0,i.sunComputeCommand=void 0,i.moonCommand=void 0;else{l(n)&&l(a)&&(n.setDynamicAtmosphereColor(a.enableLighting),i.isReadyForAtmosphere=i.isReadyForAtmosphere||a._surface._tilesToRender.length>0),i.skyAtmosphereCommand=l(n)?n.update(t):void 0,i.skyBoxCommand=l(e.skyBox)?e.skyBox.update(t,e._hdr):void 0;var u=l(e.sun)?e.sun.update(t,r.passState,e._hdr):void 0;i.sunDrawCommand=l(u)?u.drawCommand:void 0,i.sunComputeCommand=l(u)?u.computeCommand:void 0,i.moonCommand=l(e.moon)?e.moon.update(t):void 0}var m=i.clearGlobeDepth=l(a)&&(!a.depthTestAgainstTerrain||e.mode===be.SCENE2D);(i.useDepthPlane=m&&e.mode===be.SCENE3D)&&e._depthPlane.update(t),i.renderTranslucentDepthForPick=!1,i.useWebVR=e._useWebVR&&e.mode!==be.SCENE2D&&!s;for(var d=t.mode===be.SCENE3D?t.occluder:void 0,h=t.cullingVolume,c=ze.planes,p=0;p<5;++p)c[p]=h.planes[p];h=ze,i.isSkyAtmosphereVisible=l(i.skyAtmosphereCommand)&&i.isReadyForAtmosphere,i.isSunVisible=e.isVisible(i.sunDrawCommand,h,d),i.isMoonVisible=e.isVisible(i.moonCommand,h,d);var f=e.specularEnvironmentMaps,g=e._specularEnvironmentMapAtlas;!l(f)||l(g)&&g.url===f?!l(f)&&l(g)&&(g.destroy(),e._specularEnvironmentMapAtlas=void 0):(g=g&&g.destroy(),e._specularEnvironmentMapAtlas=new pe(f)),l(e._specularEnvironmentMapAtlas)&&e._specularEnvironmentMapAtlas.update(t)}function Dt(e){var t=e._frameState;e._groundPrimitives.update(t),e._primitives.update(t),e._pageLODs.update(t),function(e){var t=e._frameState;e.debugShowFrustumPlanes!==e._debugShowFrustumPlanes&&(e.debugShowFrustumPlanes?e._debugFrustumPlanes=new oe({camera:e.camera,updateOnChange:!1}):e._debugFrustumPlanes=e._debugFrustumPlanes&&e._debugFrustumPlanes.destroy(),e._debugShowFrustumPlanes=e.debugShowFrustumPlanes),l(e._debugFrustumPlanes)&&e._debugFrustumPlanes.update(t)}(e),function(e){var t=e._frameState,r=t.shadowMaps,i=r.length,o=i>0&&!t.passes.pick&&e.mode===be.SCENE3D;if(o!==t.shadowState.shadowsEnabled&&(++t.shadowState.lastDirtyTime,t.shadowState.shadowsEnabled=o),t.shadowState.lightShadowsEnabled=!1,o){for(var s=0;s<i;++s)if(r[s]!==t.shadowState.shadowMaps[s]){++t.shadowState.lastDirtyTime;break}t.shadowState.shadowMaps.length=0,t.shadowState.lightShadowMaps.length=0;for(var n=0;n<i;++n){var a=r[n];a.update(t),t.shadowState.shadowMaps.push(a),a.fromLightSource&&(t.shadowState.lightShadowMaps.push(a),t.shadowState.lightShadowsEnabled=!0),a.dirty&&(++t.shadowState.lastDirtyTime,a.dirty=!1)}}}(e),e._globe&&e._globe.render(t)}function yt(e,t,r){var i=e._context,o=e._frameState,s=e._environmentState,n=e._view,a=e._frameState.passes.pick,m=s.useWebVR;s.originalFramebuffer=t.framebuffer,l(e.sun)&&e.sunBloom!==e._sunBloom?(e.sunBloom&&!m?e._sunPostProcess=new Ee:l(e._sunPostProcess)&&(e._sunPostProcess=e._sunPostProcess.destroy()),e._sunBloom=e.sunBloom):!l(e.sun)&&l(e._sunPostProcess)&&(e._sunPostProcess=e._sunPostProcess.destroy(),e._sunBloom=!1);var d=e._clearColorCommand;u.clone(r,d.color),d.execute(i,t);var h=s.useGlobeDepthFramebuffer=l(n.globeDepth);h&&(n.globeDepth.update(i,t,n.viewport,e._hdr),n.globeDepth.clear(i,t,r));var c=n.oit,p=s.useOIT=!a&&l(c)&&c.isSupported();p&&(c.update(i,t,n.globeDepth.framebuffer,e._hdr),c.clear(i,t,r),s.useOIT=c.isSupported());var f,g=e.postProcessStages,_=s.usePostProcess=!a&&(e._hdr||g.length>0||g.ambientOcclusion.enabled||g.fxaa.enabled||g.bloom.enabled);if(s.usePostProcessSelected=!1,_&&(n.sceneFramebuffer.update(i,n.viewport,e._hdr),n.sceneFramebuffer.clear(i,t,r),g.update(i,o.useLogDepth,e._hdr),g.clear(i),_=s.usePostProcess=g.ready,s.usePostProcessSelected=_&&g.hasSelected),s.isSunVisible&&e.sunBloom&&!m?(t.framebuffer=e._sunPostProcess.update(t),e._sunPostProcess.clear(i,t,r)):h?t.framebuffer=n.globeDepth.framebuffer:_&&(t.framebuffer=n.sceneFramebuffer.getFramebuffer()),l(t.framebuffer)&&d.execute(i,t),s.useInvertClassification=!a&&l(t.framebuffer)&&e.invertClassification)if(1===e.frameState.invertClassificationColor.alpha&&s.useGlobeDepthFramebuffer&&(f=n.globeDepth.framebuffer),l(f)||i.depthTexture){if(e._invertClassification.previousFramebuffer=f,e._invertClassification.update(i),e._invertClassification.clear(i,t),e.frameState.invertClassificationColor.alpha<1&&p){var v=e._invertClassification.unclassifiedCommand,C=v.derivedCommands;C.oit=c.createDerivedCommands(v,i,C.oit)}}else s.useInvertClassification=!1}function Pt(e,t){var r=e._context,i=e._frameState,o=e._environmentState,s=e._view,n=o.useOIT,a=o.useGlobeDepthFramebuffer,u=o.usePostProcess,m=o.originalFramebuffer,d=a?s.globeDepth.framebuffer:void 0,h=s.sceneFramebuffer.getFramebuffer(),l=s.sceneFramebuffer.getIdFramebuffer();if(n&&(t.framebuffer=u?h:m,s.oit.execute(r,t)),u){var p=h;a&&!n&&(p=d);var f=e.postProcessStages,g=p.getColorTexture(0),_=l.getColorTexture(0),v=c(d,h).depthStencilTexture;f.execute(r,g,v,_),f.copy(r,m)}n||u||!a||(t.framebuffer=m,s.globeDepth.executeCopyColor(r,t));var C=i.useLogDepth;e.debugShowGlobeDepth&&a&&tt(e,e.debugShowDepthFrustum-1).executeDebugGlobeDepth(r,t,C);e.debugShowPickDepth&&a&&rt(e,e.debugShowDepthFrustum-1).executeDebugPickDepth(r,t,C)}function xt(e){e._jobScheduler.resetBudgets();var t=e._frameState;e.primitives.prePassesUpdate(t),l(e.globe)&&e.globe.update(t),e._pickPositionCacheDirty=!0,t.creditDisplay.update()}function Et(e){var t=e._frameState;e.primitives.postPassesUpdate(t),A.update()}Oe.prototype.initializeFrame=function(){120==this._shaderFrameCount++&&(this._shaderFrameCount=0,this._context.shaderCache.destroyReleasedShaderPrograms(),this._context.textureCache.destroyReleasedTextures()),this._tweens.update(),this._screenSpaceCameraController.update(),l(this._deviceOrientationCameraController)&&this._deviceOrientationCameraController.update(),this.camera.update(this._mode),this.camera._updateCameraChanged()};var Tt=new u;function Ft(e){var r=e._frameState,i=e.context,o=i.uniformState,n=e._defaultView;e._view=n,qe(e),r.passes.render=!0,r.passes.postProcess=e.postProcessStages.hasSelected,r.tilesetPassState=Me;var a=c(e.backgroundColor,u.BLACK);e._hdr&&((a=u.clone(a,Tt)).red=Math.pow(a.red,e.gamma),a.green=Math.pow(a.green,e.gamma),a.blue=Math.pow(a.blue,e.gamma)),r.backgroundColor=a,r.creditDisplay.beginFrame(),e.fog.update(r),o.update(r);var m=e.shadowMap;l(m)&&m.enabled&&(s.negate(o.sunDirectionWC,e._sunCamera.direction),r.shadowMaps.push(m)),e._computeCommandList.length=0,e._overlayCommandList.length=0;var d=n.viewport;d.x=0,d.y=0,d.width=i.drawingBufferWidth,d.height=i.drawingBufferHeight;var h=n.passState;h.framebuffer=void 0,h.blendingEnabled=void 0,h.scissorTest=void 0,h.viewport=t.clone(d,h.viewport),l(e.globe)&&e.globe.beginFrame(r),St(e),ct(e,h,a),Pt(e,h),h.framebuffer=void 0,function(e,t){e.context.uniformState.updatePass(j.OVERLAY);for(var r=e.context,i=e._overlayCommandList,o=i.length,s=0;s<o;++s)i[s].execute(r,t)}(e,h),l(e.globe)&&(e.globe.endFrame(r),e.globe.tilesLoaded||(e._renderRequested=!0)),r.creditDisplay.endFrame(),i.endFrame()}function Rt(e,t){try{t(e)}catch(t){if(e._renderError.raiseEvent(e,t),e.rethrowRenderErrors)throw t}}Oe.prototype.render=function(e){this._preUpdate.raiseEvent(this,e);var t=this._frameState;t.newFrame=!1,l(e)||(e=D.now());var r=this._view.checkForCameraUpdates(this),i=!this.requestRenderMode||this._renderRequested||r||this._logDepthBufferDirty||this._hdrDirty||this.mode===be.MORPHING;if(!i&&l(this.maximumRenderTimeChange)&&l(this._lastRenderTime)){var o=Math.abs(D.secondsDifference(this._lastRenderTime,e));i=i||o>this.maximumRenderTimeChange}i&&(this._lastRenderTime=D.clone(e,this._lastRenderTime),this._renderRequested=!1,this._logDepthBufferDirty=!1,this._hdrDirty=!1,je(this,y.incrementWrap(t.frameNumber,15e6,1),e),t.newFrame=!0);Rt(this,xt),Rt(this,Zt),Rt(this,qt),Rt(this,zt),i||Rt(this,Qt),this._postUpdate.raiseEvent(this,e),i&&(this._preRender.raiseEvent(this,e),Rt(this,Ft)),function(e,t){if(e.debugShowFramesPerSecond){if(!l(e._performanceDisplay)){var r=document.createElement("div");r.className="pgEarth-performanceDisplay-defaultContainer",e._canvas.parentNode.appendChild(r);var i=new fe({container:r});e._performanceDisplay=i,e._performanceContainer=r}e._performanceDisplay.throttled=e.requestRenderMode,e._performanceDisplay.update(t)}else l(e._performanceDisplay)&&(e._performanceDisplay=e._performanceDisplay&&e._performanceDisplay.destroy(),e._performanceContainer.parentNode.removeChild(e._performanceContainer))}(this,i),Rt(this,Et),function(e){for(var t=e._frameState.afterRender,r=0,i=t.length;r<i;++r)t[r](),e.requestRender();t.length=0}(this),i&&this._postRender.raiseEvent(this,e)},Oe.prototype.forceRender=function(e){this._renderRequested=!0,this.render(e)},Oe.prototype.requestRender=function(){this._renderRequested=!0},Oe.prototype.clampLineWidth=function(e){return Math.max(W.minimumAliasedLineWidth,Math.min(e,W.maximumAliasedLineWidth))};var Lt=new F,Ot=new s,kt=new s,At=new o,It=new P;var Vt=new L;function Mt(e,t,r,i,o){var n=e.camera.frustum;return n instanceof T||n instanceof F?function(e,t,r,i,o){var n=e.camera,a=n.frustum;l(a._offCenterFrustum)&&(a=a._offCenterFrustum);var u=2*(t.x-o.x)/o.width-1;u*=.5*(a.right-a.left);var m=2*(o.height-t.y-o.y)/o.height-1;m*=.5*(a.top-a.bottom);var d=P.clone(n.transform,It);n._setTransform(P.IDENTITY);var h=s.clone(n.position,Ot);s.multiplyByScalar(n.right,u,kt),s.add(kt,h,h),s.multiplyByScalar(n.up,m,kt),s.add(kt,h,h),n._setTransform(d),e.mode===be.SCENE2D&&s.fromElements(h.z,h.x,h.y,h);var c=a.getPixelDimensions(o.width,o.height,1,At),p=Lt;return p.right=.5*c.x,p.left=-p.right,p.top=.5*c.y,p.bottom=-p.top,p.near=a.near,p.far=a.far,p.computeCullingVolume(h,n.directionWC,n.upWC)}(e,t,0,0,o):function(e,t,r,i,o){var s=e.camera,n=s.frustum,a=n.near,u=Math.tan(.5*n.fovy),m=n.aspectRatio*u,d=(2*(t.x-o.x)/o.width-1)*a*m,h=(2*(o.height-t.y-o.y)/o.height-1)*a*u,c=n.getPixelDimensions(o.width,o.height,1,At),l=c.x*r*.5,p=c.y*i*.5,f=Vt;return f.top=h+p,f.bottom=h-p,f.right=d+l,f.left=d-l,f.near=a,f.far=n.far,f.computeCullingVolume(s.positionWC,s.directionWC,s.upWC)}(e,t,r,i,o)}var Nt=3,Gt=3,Bt=new t(0,0,Nt,Gt),Wt=new u(0,0,0,0),Ht=new o;Oe.prototype.pick=function(e,r,i){if(!l(e))throw new g("windowPosition is undefined.");Nt=c(r,3),Gt=c(i,Nt);var o=this._context,s=o.uniformState,n=this._frameState,a=this._defaultView;this._view=a;var u=a.viewport;u.x=0,u.y=0,u.width=o.drawingBufferWidth,u.height=o.drawingBufferHeight;var m=a.passState;m.viewport=t.clone(u,m.viewport);var d=Se.transformWindowToDrawingBuffer(this,e,Ht);this._jobScheduler.disableThisFrame(),qe(this),n.cullingVolume=Mt(this,d,Nt,Gt,u),n.invertClassification=!1,n.passes.pick=!0,n.tilesetPassState=Ne,s.update(n),St(this),Bt.x=d.x-.5*(Nt-1),Bt.y=this.drawingBufferHeight-d.y-.5*(Gt-1),Bt.width=Nt,Bt.height=Gt,ct(this,m=a.pickFramebuffer.begin(Bt,a.viewport),Wt),Pt(this,m);var h=a.pickFramebuffer.end(Bt);return o.endFrame(),h},Oe.prototype.pickPositionWorldCoordinates=function(e,r){if(this.useDepthPicking){if(!l(e))throw new g("windowPosition is undefined.");if(!this._context.depthTexture)throw new g("Picking from the depth buffer is not supported. Check pickPositionSupported.");var i=e.toString();if(this._pickPositionCacheDirty)this._pickPositionCache={},this._pickPositionCacheDirty=!1;else if(this._pickPositionCache.hasOwnProperty(i))return s.clone(this._pickPositionCache[i],r);var o=this._frameState,n=this._context,a=n.uniformState,u=this._defaultView;this._view=u;var m=Se.transformWindowToDrawingBuffer(this,e,Ht);this.pickTranslucentDepth?function(e,r){var i=e._context,o=e._frameState,s=e._environmentState,n=e._defaultView;e._view=n;var a=n.viewport;a.x=0,a.y=0,a.width=i.drawingBufferWidth,a.height=i.drawingBufferHeight;var u=n.passState;u.viewport=t.clone(a,u.viewport),Ue(o.passes),o.passes.pick=!0,o.passes.depth=!0,o.cullingVolume=Mt(e,r,1,1,a),o.tilesetPassState=Ne,St(e),s.renderTranslucentDepthForPick=!0,ct(e,u=n.pickDepthFramebuffer.update(i,r,a),Wt),Pt(e,u),i.endFrame()}(this,m):(qe(this,o.frameNumber,o.time),a.update(o),St(this)),m.y=this.drawingBufferHeight-m.y;var d,h=this.camera;d=l(h.frustum.fov)?h.frustum.clone(it):l(h.frustum.infiniteProjectionMatrix)?h.frustum.clone(ot):l(h.frustum.width)?h.frustum.clone(st):h.frustum.clone(nt);for(var c=u.frustumCommandsList,p=c.length,f=0;f<p;++f){var _=rt(this,f).getDepth(n,m.x,m.y);if(_>0&&_<1){var v,C=c[f];return this.mode===be.SCENE2D?(v=h.position.z,h.position.z=v-C.near+1,d.far=Math.max(1,C.far-C.near),d.near=1,a.update(o),a.updateFrustum(d)):(d.near=C.near*(0!==f?this.opaqueFrustumNearOffset:1),d.far=C.far,a.updateFrustum(d)),r=Se.drawingBufferToWgs84Coordinates(this,m,_,r),this.mode===be.SCENE2D&&(h.position.z=v,a.update(o)),this._pickPositionCache[i]=s.clone(r),r}}this._pickPositionCache[i]=void 0}};var Ut=new n;function jt(e,t){var r,i,o=[],s=[],n=[],a=[];l(e)||(e=Number.MAX_VALUE);for(var u=t();l(u);){var m=u.object,d=u.position,h=u.exclude;if(l(d)&&!l(m)){o.push(u);break}if(!l(m)||!l(m.primitive))break;if(!h&&(o.push(u),0>=--e))break;var c=m.primitive,p=!1;"function"==typeof c.getGeometryInstanceAttributes&&l(m.id)&&(i=c.getGeometryInstanceAttributes(m.id),l(i)&&l(i.show)&&(p=!0,i.show=I.toValue(!1,i.show),n.push(i))),m instanceof $&&(p=!0,m.show=!1,a.push(m)),p||(c.show=!1,s.push(c)),u=t()}for(r=0;r<s.length;++r)s[r].show=!0;for(r=0;r<n.length;++r)(i=n[r]).show=I.toValue(!0,i.show);for(r=0;r<a.length;++r)a[r].show=!0;return o}function qt(e){var t=e._frameState;Ge.camera=t.camera,Ge.cullingVolume=t.cullingVolume,e.primitives.updateForPass(t,Ge)}function zt(e){var t=e._frameState;t.camera.hasCurrentFlight()&&(Be.camera=e.preloadFlightCamera,Be.cullingVolume=e.preloadFlightCullingVolume,e.primitives.updateForPass(t,Be))}function Qt(e){e.primitives.updateForPass(e._frameState,We)}Oe.prototype.pickPosition=function(e,t){if(t=this.pickPositionWorldCoordinates(e,t),l(t)&&this.mode!==be.SCENE3D){s.fromElements(t.y,t.z,t.x,t);var r=this.mapProjection,i=r.ellipsoid,o=r.unproject(t,Ut);i.cartographicToCartesian(o,t)}return t},Oe.prototype.drillPick=function(e,t,r,i){var o=this;return jt(t,function(){var t=o.pick(e,r,i);if(l(t))return{object:t,position:void 0,exclude:!1}}).map(function(e){return e.object})};var Kt=new s,Yt=new s;function Jt(e,t,r,i){var o=t.direction,n=s.mostOrthogonalAxis(o,Kt),a=s.cross(o,n,Kt),u=s.cross(o,a,Yt);return i.position=t.origin,i.direction=o,i.up=u,i.right=a,i.frustum.width=c(r,e.pickOffscreenDefaultWidth),i.frustum.computeCullingVolume(i.positionWC,i.directionWC,i.upWC)}function Xt(e,t){var r=e._frameState,i=t.ray,o=t.width,s=t.tilesets,n=e._pickOffscreenView.camera,a=Jt(e,i,o,n),u=Ie;u.camera=n,u.cullingVolume=a;for(var m=!0,d=s.length,h=0;h<d;++h){var c=s[h];c.show&&e.primitives.contains(c)&&(c.updateForPass(r,u),m=m&&u.ready)}return m&&t.deferred.resolve(),m}function Zt(e){for(var t=e._mostDetailedRayPicks,r=0;r<t.length;++r)Xt(e,t[r])&&t.splice(r--,1)}function $t(e,t,r,i,o){var s=[];if(function e(t,r,i){for(var o=t.length,s=0;s<o;++s){var n=t.get(s);n.show&&(n instanceof re?l(r)&&-1!==r.indexOf(n)||i.push(n):n instanceof we&&e(n,r,i))}}(e.primitives,r,s),0===s.length)return J.resolve(o());var n=new function(e,t,r){this.ray=e,this.width=t,this.tilesets=r,this.ready=!1,this.deferred=J.defer(),this.promise=this.deferred.promise}(t,i,s);return e._mostDetailedRayPicks.push(n),n.promise.then(function(){return o()})}function er(e,r,i,o,s,n){var a=e._context,u=a.uniformState,m=e._frameState,d=e._pickOffscreenView;e._view=d,Jt(e,r,o,d.camera),Bt=t.clone(d.viewport,Bt);var h,c=d.pickFramebuffer.begin(Bt,d.viewport);e._jobScheduler.disableThisFrame(),qe(e),m.invertClassification=!1,m.passes.pick=!0,m.passes.offscreen=!0,m.tilesetPassState=n?Ve:Ne,u.update(m),St(e),ct(e,c,Wt),Pt(e,c);var p=d.pickFramebuffer.end(a);if(e._context.depthTexture)for(var f=d.frustumCommandsList.length,g=0;g<f;++g){var _=rt(e,g).getDepth(a,0,0);if(_>0&&_<1){var v=d.frustumCommandsList[g],C=v.near*(0!==g?e.opaqueFrustumNearOffset:1),w=C+_*(v.far-C);h=k.getPoint(r,w);break}}if(e._view=e._defaultView,a.endFrame(),l(p)||l(h))return{object:p,position:h,exclude:!l(h)&&s||function(e,t){return!(!l(e)||!l(t)||0===t.length)&&(t.indexOf(e)>-1||t.indexOf(e.primitive)>-1||t.indexOf(e.id)>-1)}(p,i)}}function tr(e,t,r,i,o,s,n){return jt(r,function(){return er(e,t,i,o,s,n)})}function rr(e,t,r,i,o,s){var n=tr(e,t,1,r,i,o,s);if(n.length>0)return n[0]}function ir(e,t,r,i,o,s,n){return tr(e,t,r,i,o,s,n)}function or(e,t){var r=J.defer();return t.then(function(t){var i=e.postRender.addEventListener(function(){r.resolve(t),i()})}),r.promise}Oe.prototype.pickFromRay=function(e,t,r){if(a.defined("ray",e),this._mode!==be.SCENE3D)throw new g("Ray intersections are only supported in 3D mode.");return rr(this,e,t,r,!1,!1)},Oe.prototype.drillPickFromRay=function(e,t,r,i){if(a.defined("ray",e),this._mode!==be.SCENE3D)throw new g("Ray intersections are only supported in 3D mode.");return ir(this,e,t,r,i,!1,!1)},Oe.prototype.pickFromRayMostDetailed=function(e,t,r){if(a.defined("ray",e),this._mode!==be.SCENE3D)throw new g("Ray intersections are only supported in 3D mode.");var i=this;return e=k.clone(e),t=l(t)?t.slice():t,or(this,$t(this,e,t,r,function(){return rr(i,e,t,r,!1,!0)}))},Oe.prototype.drillPickFromRayMostDetailed=function(e,t,r,i){if(a.defined("ray",e),this._mode!==be.SCENE3D)throw new g("Ray intersections are only supported in 3D mode.");var o=this;return e=k.clone(e),r=l(r)?r.slice():r,or(this,$t(this,e,r,i,function(){return ir(o,e,t,r,i,!1,!0)}))};var sr=new s,nr=new s,ar=new k,ur=new n;function mr(t,r){var i=t.globe,o=l(i)?i.ellipsoid:t.mapProjection.ellipsoid,a=e._defaultMaxTerrainHeight,u=o.geodeticSurfaceNormalCartographic(r,nr),m=n.toCartesian(r,o,sr),d=ar;d.origin=m,d.direction=u;var h=new k;return k.getPoint(d,a,h.origin),s.negate(u,h.direction),h}function dr(e,t){var r=e.globe,i=l(r)?r.ellipsoid:e.mapProjection.ellipsoid;return mr(e,n.fromCartesian(t,i,ur))}function hr(e,t){var r=e.globe,i=l(r)?r.ellipsoid:e.mapProjection.ellipsoid;return n.fromCartesian(t,i,ur).height}function cr(e,t,r,i){var o=mr(e,t);return $t(e,o,r,i,function(){var t=rr(e,o,r,i,!0,!0);if(l(t))return hr(e,t.position)})}function lr(e,t,r,i,o){var n=dr(e,t);return $t(e,n,r,i,function(){var t=rr(e,n,r,i,!0,!0);if(l(t))return s.clone(t.position,o)})}return Oe.prototype.sampleHeight=function(e,t,r){if(a.defined("position",e),this._mode!==be.SCENE3D)throw new g("sampleHeight is only supported in 3D mode.");if(!this.sampleHeightSupported)throw new g("sampleHeight requires depth texture support. Check sampleHeightSupported.");var i=rr(this,mr(this,e),t,r,!0,!1);if(l(i))return hr(this,i.position)},Oe.prototype.clampToHeight=function(e,t,r,i){if(a.defined("cartesian",e),this._mode!==be.SCENE3D)throw new g("sampleHeight is only supported in 3D mode.");if(!this.clampToHeightSupported)throw new g("clampToHeight requires depth texture support. Check clampToHeightSupported.");var o=rr(this,dr(this,e),t,r,!0,!1);if(l(o))return s.clone(o.position,i)},Oe.prototype.sampleHeightMostDetailed=function(e,t,r){if(a.defined("positions",e),this._mode!==be.SCENE3D)throw new g("sampleHeightMostDetailed is only supported in 3D mode.");if(!this.sampleHeightSupported)throw new g("sampleHeightMostDetailed requires depth texture support. Check sampleHeightSupported.");t=l(t)?t.slice():t;for(var i=e.length,o=new Array(i),s=0;s<i;++s)o[s]=cr(this,e[s],t,r);return or(this,J.all(o).then(function(t){for(var r=t.length,i=0;i<r;++i)e[i].height=t[i];return e}))},Oe.prototype.clampToHeightMostDetailed=function(e,t,r){if(a.defined("cartesians",e),this._mode!==be.SCENE3D)throw new g("clampToHeightMostDetailed is only supported in 3D mode.");if(!this.clampToHeightSupported)throw new g("clampToHeightMostDetailed requires depth texture support. Check clampToHeightSupported.");t=l(t)?t.slice():t;for(var i=e.length,o=new Array(i),s=0;s<i;++s)o[s]=lr(this,e[s],t,r,e[s]);return or(this,J.all(o).then(function(t){for(var r=t.length,i=0;i<r;++i)e[i]=t[i];return e}))},Oe.prototype.cartesianToCanvasCoordinates=function(e,t){return Se.wgs84ToWindowCoordinates(this,e,t)},Oe.prototype.completeMorph=function(){this._transitioner.completeMorph()},Oe.prototype.morphTo2D=function(e){var t,r=this.globe;t=l(r)?r.ellipsoid:this.mapProjection.ellipsoid,e=c(e,2),this._transitioner.morphTo2D(e,t)},Oe.prototype.morphToColumbusView=function(e){var t,r=this.globe;t=l(r)?r.ellipsoid:this.mapProjection.ellipsoid,e=c(e,2),this._transitioner.morphToColumbusView(e,t)},Oe.prototype.morphTo3D=function(e){var t,r=this.globe;t=l(r)?r.ellipsoid:this.mapProjection.ellipsoid,e=c(e,2),this._transitioner.morphTo3D(e,t)},Oe.prototype.isDestroyed=function(){return!1},Oe.prototype.destroy=function(){this._tweens.removeAll(),this._computeEngine=this._computeEngine&&this._computeEngine.destroy(),this._screenSpaceCameraController=this._screenSpaceCameraController&&this._screenSpaceCameraController.destroy(),this._deviceOrientationCameraController=this._deviceOrientationCameraController&&!this._deviceOrientationCameraController.isDestroyed()&&this._deviceOrientationCameraController.destroy(),this._primitives=this._primitives&&this._primitives.destroy(),this._groundPrimitives=this._groundPrimitives&&this._groundPrimitives.destroy(),this._globe=this._globe&&this._globe.destroy(),this.skyBox=this.skyBox&&this.skyBox.destroy(),this.skyAtmosphere=this.skyAtmosphere&&this.skyAtmosphere.destroy(),this._debugSphere=this._debugSphere&&this._debugSphere.destroy(),this.sun=this.sun&&this.sun.destroy(),this._sunPostProcess=this._sunPostProcess&&this._sunPostProcess.destroy(),this._depthPlane=this._depthPlane&&this._depthPlane.destroy(),this._transitioner=this._transitioner&&this._transitioner.destroy(),this._debugFrustumPlanes=this._debugFrustumPlanes&&this._debugFrustumPlanes.destroy(),this._brdfLutGenerator=this._brdfLutGenerator&&this._brdfLutGenerator.destroy(),this._defaultView=this._defaultView&&this._defaultView.destroy(),this._pickOffscreenView=this._pickOffscreenView&&this._pickOffscreenView.destroy(),this._view=void 0,this._removeCreditContainer&&this._canvas.parentNode.removeChild(this._creditContainer),this.postProcessStages=this.postProcessStages&&this.postProcessStages.destroy(),this._context=this._context&&this._context.destroy(),this._frameState.creditDisplay=this._frameState.creditDisplay&&this._frameState.creditDisplay.destroy(),l(this._performanceDisplay)&&(this._performanceDisplay=this._performanceDisplay&&this._performanceDisplay.destroy(),this._performanceContainer.parentNode.removeChild(this._performanceContainer)),this._removeRequestListenerCallback(),this._removeTaskProcessorListenerCallback();for(var e=0;e<this._removeGlobeCallbacks.length;++e)this._removeGlobeCallbacks[e]();return this._removeGlobeCallbacks.length=0,f(this)},Oe});