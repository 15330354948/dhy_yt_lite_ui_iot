define(["../Core/Cartesian4","../Core/defined","../Core/destroyObject","../Core/PixelFormat","../Renderer/Framebuffer","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/ShaderSource","../Renderer/Texture"],function(e,t,r,o,n,i,a,u,d){"use strict";function p(){this._framebuffer=void 0,this._depthTexture=void 0,this._textureToCopy=void 0,this._copyDepthCommand=void 0,this._useLogDepth=void 0,this._debugPickDepthViewportCommand=void 0}function f(e){e._depthTexture=e._depthTexture&&!e._depthTexture.isDestroyed()&&e._depthTexture.destroy()}function h(e){e._framebuffer=e._framebuffer&&!e._framebuffer.isDestroyed()&&e._framebuffer.destroy()}function _(e,t,r,a){f(e),h(e),function(e,t,r,n){e._depthTexture=new d({context:t,width:r,height:n,pixelFormat:o.RGBA,pixelDatatype:i.UNSIGNED_BYTE})}(e,t,r,a),e._framebuffer=new n({context:t,colorTextures:[e._depthTexture],destroyAttachments:!1})}p.prototype.executeDebugPickDepth=function(e,r,o){!function(e,r,o,n){if(!t(e._debugPickDepthViewportCommand)||n!==e._useLogDepth){var i=new u({defines:[n?"LOG_DEPTH":""],sources:["uniform sampler2D u_texture;\nvarying vec2 v_textureCoordinates;\nvoid main()\n{\n    float z_window = czm_unpackDepth(texture2D(u_texture, v_textureCoordinates));\n    z_window = czm_reverseLogDepth(z_window); \n    float n_range = czm_depthRange.near;\n    float f_range = czm_depthRange.far;\n    float z_ndc = (2.0 * z_window - n_range - f_range) / (f_range - n_range);\n    float scale = pow(z_ndc * 0.5 + 0.5, 8.0);\n    gl_FragColor = vec4(mix(vec3(0.0), vec3(1.0), scale), 1.0);\n}\n"]});e._debugPickDepthViewportCommand=r.createViewportQuadCommand(i,{uniformMap:{u_texture:function(){return e._depthTexture}},owner:e}),e._useLogDepth=n}e._debugPickDepthViewportCommand.execute(r,o)}(this,e,r,o)},p.prototype.update=function(e,r){!function(e,r,o){var n=o.width,i=o.height,a=e._depthTexture,u=!t(a)||a.width!==n||a.height!==i;t(e._framebuffer)&&!u||_(e,r,n,i)}(this,e,r),function(e,r,o){t(e._copyDepthCommand)||(e._copyDepthCommand=r.createViewportQuadCommand("uniform sampler2D u_texture;\nvarying vec2 v_textureCoordinates;\nvoid main()\n{\n    gl_FragColor = czm_packDepth(texture2D(u_texture, v_textureCoordinates).r);\n}\n",{renderState:a.fromCache(),uniformMap:{u_texture:function(){return e._textureToCopy}},owner:e}));e._textureToCopy=o,e._copyDepthCommand.framebuffer=e._framebuffer}(this,e,r)};var c=new e,m=new e(1,1/255,1/65025,1/16581375);return p.prototype.getDepth=function(t,r,o){var n=t.readPixels({x:r,y:o,width:1,height:1,framebuffer:this._framebuffer}),i=e.unpack(n,0,c);return e.divideByScalar(i,255,i),e.dot(i,m)},p.prototype.executeCopyDepth=function(e,t){this._copyDepthCommand.execute(e,t)},p.prototype.isDestroyed=function(){return!1},p.prototype.destroy=function(){return f(this),h(this),this._copyDepthCommand.shaderProgram=t(this._copyDepthCommand.shaderProgram)&&this._copyDepthCommand.shaderProgram.destroy(),r(this)},p});