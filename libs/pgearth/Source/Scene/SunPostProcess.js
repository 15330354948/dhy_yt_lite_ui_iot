define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/Cartesian4","../Core/defined","../Core/destroyObject","../Core/Math","../Core/Matrix4","../Core/Transforms","../Shaders/PostProcessStages/AdditiveBlend","../Shaders/PostProcessStages/BrightPass","../Shaders/PostProcessStages/GaussianBlur1D","../Shaders/PostProcessStages/PassThrough","./PostProcessStage","./PostProcessStageComposite","./PostProcessStageSampleMode","./PostProcessStageTextureCache","./SceneFramebuffer"],function(e,t,r,o,n,a,s,i,u,c,f,h,g,d,m,p,l){"use strict";function _(){this._sceneFramebuffer=new l;var e=new Array(6);e[0]=new g({fragmentShader:h,textureScale:.125,forcePowerOfTwo:!0,sampleMode:m.LINEAR});var r=e[1]=new g({fragmentShader:c,uniforms:{avgLuminance:.5,threshold:.25,offset:.1},textureScale:.125,forcePowerOfTwo:!0}),o=this;this._delta=1,this._sigma=2,this._blurStep=new t,e[2]=new g({fragmentShader:f,uniforms:{step:function(){return o._blurStep.x=o._blurStep.y=1/r.outputTexture.width,o._blurStep},delta:function(){return o._delta},sigma:function(){return o._sigma},direction:0},textureScale:.125,forcePowerOfTwo:!0}),e[3]=new g({fragmentShader:f,uniforms:{step:function(){return o._blurStep.x=o._blurStep.y=1/r.outputTexture.width,o._blurStep},delta:function(){return o._delta},sigma:function(){return o._sigma},direction:1},textureScale:.125,forcePowerOfTwo:!0}),e[4]=new g({fragmentShader:h,sampleMode:m.LINEAR}),this._uCenter=new t,this._uRadius=void 0,e[5]=new g({fragmentShader:u,uniforms:{center:function(){return o._uCenter},radius:function(){return o._uRadius},colorTexture2:function(){return o._sceneFramebuffer.getFramebuffer().getColorTexture(0)}}}),this._stages=new d({stages:e});for(var n=new p(this),a=e.length,s=0;s<a;++s)e[s]._textureCache=n;this._textureCache=n,this.length=e.length}_.prototype.get=function(e){return this._stages.get(e)},_.prototype.getStageByName=function(e){for(var t=this._stages.length,r=0;r<t;++r){var o=this._stages.get(r);if(o.name===e)return o}};var w=new r,x=new t,C=new t,S=new s;return _.prototype.clear=function(e,t,r){this._sceneFramebuffer.clear(e,t,r),this._textureCache.clear(e)},_.prototype.update=function(r){var o=r.context,n=r.viewport,u=this._sceneFramebuffer;u.update(o,n);var c=u.getFramebuffer();return this._textureCache.update(o),this._stages.update(o,!1),function(r,o,n){var u=o.uniformState,c=u.sunPositionWC,f=u.view,h=u.viewProjection,g=u.projection,d=s.computeViewportTransformation(n,0,1,S),m=s.multiplyByPoint(f,c,w),p=i.pointToGLWindowCoordinates(h,d,c,x);m.x+=a.SOLAR_RADIUS;var l=i.pointToGLWindowCoordinates(g,d,m,m),_=30*t.magnitude(t.subtract(l,p,l))*2,y=C;y.x=_,y.y=_,r._uCenter=t.clone(p,r._uCenter),r._uRadius=.15*Math.max(y.x,y.y);var P=o.drawingBufferWidth,v=o.drawingBufferHeight,T=r._stages,b=T.get(0),M=b.outputTexture.width,R=b.outputTexture.height,F=new e;F.width=M,F.height=R,d=s.computeViewportTransformation(F,0,1,S),p=i.pointToGLWindowCoordinates(h,d,c,x),y.x*=M/P,y.y*=R/v;var B=b.scissorRectangle;B.x=Math.max(p.x-.5*y.x,0),B.y=Math.max(p.y-.5*y.y,0),B.width=Math.min(y.x,P),B.height=Math.min(y.y,v);for(var L=1;L<4;++L)e.clone(B,T.get(L).scissorRectangle)}(this,o,n),c},_.prototype.execute=function(e){var t=this._sceneFramebuffer.getFramebuffer().getColorTexture(0),r=this._stages,o=r.length;r.get(0).execute(e,t);for(var n=1;n<o;++n)r.get(n).execute(e,r.get(n-1).outputTexture)},_.prototype.copy=function(e,t){if(!o(this._copyColorCommand)){var r=this;this._copyColorCommand=e.createViewportQuadCommand(h,{uniformMap:{colorTexture:function(){return r._stages.get(r._stages.length-1).outputTexture}},owner:this})}this._copyColorCommand.framebuffer=t,this._copyColorCommand.execute(e)},_.prototype.isDestroyed=function(){return!1},_.prototype.destroy=function(){return this._textureCache.destroy(),this._stages.destroy(),n(this)},_});