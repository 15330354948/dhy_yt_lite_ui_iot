define(["../Core/Cartographic","../Core/defined","../Core/DeveloperError","../Core/RuntimeError","./ImageryLayerFeatureInfo","../extends/core/MercatorToDegree"],function(e,t,r,o,n,i){"use strict";function a(r){for(var o=[],a=r.features,l=0;l<a.length;++l){var s=a[l],m=new n;if(m.data=s,m.properties=s.properties,m.configureNameFromProperties(s.properties),m.configureDescriptionFromProperties(s.properties),t(s.geometry)&&"Point"===s.geometry.type){var c=s.geometry.coordinates[0],f=s.geometry.coordinates[1];if(c>=-180&&c<=180)m.position=e.fromDegrees(c,f);else{var u=i.handleMecToDegree(c,f);m.position=e.fromDegrees(u[0],u[1])}}o.push(m)}return o}var l="http://www.mapinfo.com/mxp",s="http://www.esri.com/wms",m="http://www.opengis.net/wfs",c="http://www.opengis.net/gml";function f(e){var r=e.documentElement;if("MultiFeatureCollection"===r.localName&&r.namespaceURI===l)return function(e){for(var t=[],r=e.documentElement.getElementsByTagNameNS(l,"Feature"),o=0;o<r.length;++o){for(var i=r[o],a={},s=i.getElementsByTagNameNS(l,"Val"),m=0;m<s.length;++m){var c=s[m];if(c.hasAttribute("ref")){var f=c.getAttribute("ref"),u=c.textContent.trim();a[f]=u}}var p=new n;p.data=i,p.properties=a,p.configureNameFromProperties(a),p.configureDescriptionFromProperties(a),t.push(p)}return t}(e);if("FeatureInfoResponse"===r.localName&&r.namespaceURI===s)return function(e){var t,r=e.documentElement,o=[],n=r.getElementsByTagNameNS("*","FIELDS");if(n.length>0)for(var i=0;i<n.length;++i){var a=n[i];t={};for(var l=a.attributes,s=0;s<l.length;++s){var m=l[s];t[m.name]=m.value}o.push(p(a,t))}else for(var c=r.getElementsByTagNameNS("*","FeatureInfo"),f=0;f<c.length;++f){var u=c[f];t={};for(var d=u.childNodes,h=0;h<d.length;++h){var g=d[h];g.nodeType===Node.ELEMENT_NODE&&(t[g.localName]=g.textContent)}o.push(p(u,t))}return o}(e);if("FeatureCollection"===r.localName&&r.namespaceURI===m)return function(e){for(var t=[],r=e.documentElement.getElementsByTagNameNS(c,"featureMember"),o=0;o<r.length;++o){var n=r[o],i={};u(n,i),t.push(p(n,i))}return t}(e);if("ServiceExceptionReport"===r.localName)throw new o((new XMLSerializer).serializeToString(r));return"msGMLOutput"===r.localName?function(e){for(var r,n=[],i=e.documentElement.childNodes,a=0;a<i.length;a++)if(i[a].nodeType===Node.ELEMENT_NODE){r=i[a];break}if(!t(r))throw new o("Unable to find first child of the feature info xml document");for(var l=r.childNodes,s=0;s<l.length;++s){var m=l[s];if(m.nodeType===Node.ELEMENT_NODE){var c={};u(m,c),n.push(p(m,c))}}return n}(e):function(e){var t=(new XMLSerializer).serializeToString(e),r=document.createElement("div"),o=document.createElement("pre");o.textContent=t,r.appendChild(o);var i=new n;return i.data=e,i.description=r.innerHTML,[i]}(e)}function u(e,t){for(var r=!0,o=0;o<e.childNodes.length;++o){var n=e.childNodes[o];n.nodeType===Node.ELEMENT_NODE&&(r=!1),"Point"!==n.localName&&"LineString"!==n.localName&&"Polygon"!==n.localName&&"boundedBy"!==n.localName&&(n.hasChildNodes()&&u(n,t)&&(t[n.localName]=n.textContent))}return r}function p(e,t){var r=new n;return r.data=e,r.properties=t,r.configureNameFromProperties(t),r.configureDescriptionFromProperties(t),r}var d=/<body>\s*<\/body>/im,h=/<ServiceExceptionReport([\s\S]*)<\/ServiceExceptionReport>/im,g=/<title>([\s\S]*)<\/title>/im;function N(e){if(!d.test(e)&&!h.test(e)){var t,r=g.exec(e);r&&r.length>1&&(t=r[1]);var o=new n;return o.name=t,o.description=e,o.data=e,[o]}}return function(e,o,n){if(!t(e))throw new r("type is required.");if(this.type=e,!t(o))if("json"===e)o="application/json";else if("xml"===e)o="text/xml";else if("html"===e)o="text/html";else{if("text"!==e)throw new r('format is required when type is not "json", "xml", "html", or "text".');o="text/plain"}if(this.format=o,!t(n))if("json"===e)n=a;else if("xml"===e)n=f;else if("html"===e)n=N;else{if("text"!==e)throw new r('callback is required when type is not "json", "xml", "html", or "text".');n=N}this.callback=n}});