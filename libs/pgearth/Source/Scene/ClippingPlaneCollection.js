define(["../Core/AttributeCompression","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Check","../Core/Color","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/deprecationWarning","../Core/destroyObject","../Core/DeveloperError","../Core/Event","../Core/Intersect","../Core/Matrix4","../Core/PixelFormat","../Core/Plane","../Renderer/ContextLimits","../Renderer/PixelDatatype","../Renderer/Sampler","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","./ClippingPlane"],function(e,t,i,n,r,o,a,s,l,h,p,u,d,f,c,g,_,y,x,w,v,C,m,T,P){"use strict";function E(e){e=a(e,a.EMPTY_OBJECT),this._planes=[],this._dirtyIndex=-1,this._multipleDirtyPlanes=!1,this._enabled=a(e.enabled,!0),this.modelMatrix=c.clone(a(e.modelMatrix,c.IDENTITY)),this.edgeColor=o.clone(a(e.edgeColor,o.WHITE)),this.edgeWidth=a(e.edgeWidth,0),this.planeAdded=new d,this.planeRemoved=new d,this._owner=void 0;var t=a(e.unionClippingRegions,!1);this._unionClippingRegions=t,this._testIntersection=t?I:R,this._uint8View=void 0,this._float32View=void 0,this._clippingPlanesTexture=void 0;var i=e.planes;if(s(i))for(var n=i.length,r=0;r<n;++r)this.add(i[r])}function I(e){return e===f.OUTSIDE}function R(e){return e===f.INSIDE}function D(e,t){e._multipleDirtyPlanes=e._multipleDirtyPlanes||-1!==e._dirtyIndex&&e._dirtyIndex!==t,e._dirtyIndex=t}function F(e,t){for(var i=e.length,n=0;n<i;++n)if(_.equals(e[n],t))return n;return-1}l(E.prototype,{length:{get:function(){return this._planes.length}},unionClippingRegions:{get:function(){return this._unionClippingRegions},set:function(e){this._unionClippingRegions!==e&&(this._unionClippingRegions=e,this._testIntersection=e?I:R)}},enabled:{get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e)}},texture:{get:function(){return this._clippingPlanesTexture}},owner:{get:function(){return this._owner}},clippingPlanesState:{get:function(){return this._unionClippingRegions?this._planes.length:-this._planes.length}}}),E.prototype.add=function(e){var t=this._planes.length,i=this;e.onChangeCallback=function(e){D(i,e)},e.index=t,D(this,t),this._planes.push(e),this.planeAdded.raiseEvent(e,t)},E.prototype.get=function(e){return r.typeOf.number("index",e),this._planes[e]},E.prototype.contains=function(e){return-1!==F(this._planes,e)},E.prototype.remove=function(e){var t=this._planes,i=F(t,e);if(-1===i)return!1;e instanceof P&&(e.onChangeCallback=void 0,e.index=-1);for(var n=t.length-1,r=i;r<n;++r){var o=t[r+1];t[r]=o,o instanceof P&&(o.index=r)}return this._multipleDirtyPlanes=!0,t.length=n,this.planeRemoved.raiseEvent(e,i),!0},E.prototype.removeAll=function(){for(var e=this._planes,t=e.length,i=0;i<t;++i){var n=e[i];n instanceof P&&(n.onChangeCallback=void 0,n.index=-1),this.planeRemoved.raiseEvent(n,i)}this._multipleDirtyPlanes=!0,this._planes=[]};var V=new n,M=new n;function b(t,i,r){for(var o=t._uint8View,a=t._planes,s=0,l=i;l<r;++l){var h=a[l],p=e.octEncodeToCartesian4(h.normal,M);o[s]=p.x,o[s+1]=p.y,o[s+2]=p.z,o[s+3]=p.w;var u=n.packFloat(h.distance,V);o[s+4]=u.x,o[s+5]=u.y,o[s+6]=u.z,o[s+7]=u.w,s+=8}}function A(e,t,i){for(var n=e._float32View,r=e._planes,o=0,a=t;a<i;++a){var s=r[a],l=s.normal;n[o]=l.x,n[o+1]=l.y,n[o+2]=l.z,n[o+3]=s.distance,o+=4}}function S(e,t){var i=y.maximumTextureSize;return t.x=Math.min(e,i),t.y=Math.ceil(e/t.x),t}var N=new t;E.prototype.update=function(e){var t=this._clippingPlanesTexture,i=e.context,n=E.useFloatTexture(i),r=n?this.length:2*this.length;if(s(t)){var o=t.width*t.height;(o<r||r<.25*o)&&(t.destroy(),t=void 0,this._clippingPlanesTexture=void 0)}if(0!==this.length){if(!s(t)){var a=S(r,N);a.y*=2;var l=new w({wrapS:T.CLAMP_TO_EDGE,wrapT:T.CLAMP_TO_EDGE,minificationFilter:m.NEAREST,magnificationFilter:C.NEAREST});n?(t=new v({context:i,width:a.x,height:a.y,pixelFormat:g.RGBA,pixelDatatype:x.FLOAT,sampler:l,flipY:!1}),this._float32View=new Float32Array(a.x*a.y*4)):(t=new v({context:i,width:a.x,height:a.y,pixelFormat:g.RGBA,pixelDatatype:x.UNSIGNED_BYTE,sampler:l,flipY:!1}),this._uint8View=new Uint8Array(a.x*a.y*4)),this._clippingPlanesTexture=t,this._multipleDirtyPlanes=!0}var h=this._dirtyIndex;if(this._multipleDirtyPlanes||-1!==h){if(this._multipleDirtyPlanes)n?(A(this,0,this._planes.length),t.copyFrom({width:t.width,height:t.height,arrayBufferView:this._float32View})):(b(this,0,this._planes.length),t.copyFrom({width:t.width,height:t.height,arrayBufferView:this._uint8View}));else{var p=0,u=0;n?(u=Math.floor(h/t.width),p=Math.floor(h-u*t.width),A(this,h,h+1),t.copyFrom({width:1,height:1,arrayBufferView:this._float32View},p,u)):(u=Math.floor(2*h/t.width),p=Math.floor(2*h-u*t.width),b(this,h,h+1),t.copyFrom({width:2,height:1,arrayBufferView:this._uint8View},p,u))}this._multipleDirtyPlanes=!1,this._dirtyIndex=-1}}};var B=new c,O=new _(i.UNIT_X,0);return E.prototype.computeIntersectionWithBoundingVolume=function(e,t){var i=this._planes,n=i.length,r=this.modelMatrix;s(t)&&(r=c.multiply(t,r,B));var o=f.INSIDE;!this.unionClippingRegions&&n>0&&(o=f.OUTSIDE);for(var a=0;a<n;++a){var l=i[a];_.transform(l,r,O);var h=e.intersectPlane(O);if(h===f.INTERSECTING)o=h;else if(this._testIntersection(h))return h}return o},E.setOwner=function(e,t,i){if(e!==t[i]&&(t[i]=t[i]&&t[i].destroy(),s(e))){if(s(e._owner))throw new u("ClippingPlaneCollection should only be assigned to one object");e._owner=t,t[i]=e}},E.useFloatTexture=function(e){return e.floatingPointTexture},E.getTextureResolution=function(e,t,i){var n=e.texture;if(s(n))return i.x=n.width,i.y=n.height,i;var r=S(E.useFloatTexture(t)?e.length:2*e.length,i);return r.y*=2,r},E.prototype.isDestroyed=function(){return!1},E.prototype.destroy=function(){return this._clippingPlanesTexture=this._clippingPlanesTexture&&this._clippingPlanesTexture.destroy(),p(this)},E});