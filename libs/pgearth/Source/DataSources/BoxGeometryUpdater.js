define(["../Core/BoxGeometry","../Core/BoxOutlineGeometry","../Core/Cartesian3","../Core/Check","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/GeometryInstance","../Core/GeometryOffsetAttribute","../Core/Iso8601","../Core/OffsetGeometryInstanceAttribute","../Core/ShowGeometryInstanceAttribute","../Scene/HeightReference","../Scene/MaterialAppearance","../Scene/PerInstanceColorAppearance","./heightReferenceOnEntityPropertyChanged","./ColorMaterialProperty","./DynamicGeometryUpdater","./GeometryUpdater","./Property"],function(e,t,o,i,r,n,s,a,p,l,c,f,y,d,h,u,m,_,C,g,O,b,P){"use strict";var v=o.ZERO,D=new o,w=new o,A=new r;function V(e,t){b.call(this,{entity:e,scene:t,geometryOptions:new function(e){this.id=e,this.vertexFormat=void 0,this.dimensions=void 0,this.offsetAttribute=void 0}(e),geometryPropertyName:"box",observedPropertyNames:["availability","position","orientation","box"]}),this._onEntityPropertyChanged(e,"box",e.box,void 0)}function E(e,t,o){O.call(this,e,t,o)}return s(Object.create)&&(V.prototype=Object.create(b.prototype),V.prototype.constructor=V),a(V.prototype,{terrainOffsetProperty:{get:function(){return this._terrainOffsetProperty}}}),V.prototype.createFillGeometryInstance=function(t){if(i.defined("time",t),!this._fillEnabled)throw new p("This instance does not represent a filled geometry.");var o,a=this._entity,f=a.isAvailable(t),y=new h(f&&a.isShowing&&this._showProperty.getValue(t)&&this._fillProperty.getValue(t)),u=this._distanceDisplayConditionProperty.getValue(t),m={show:y,distanceDisplayCondition:l.fromDistanceDisplayCondition(u),color:void 0,offset:void 0};this._materialProperty instanceof g&&(s(this._materialProperty.color)&&(this._materialProperty.color.isConstant||f)&&(o=this._materialProperty.color.getValue(t,A)),s(o)||(o=r.WHITE),m.color=n.fromColor(o));return s(this._options.offsetAttribute)&&(m.offset=d.fromCartesian3(P.getValueOrDefault(this._terrainOffsetProperty,t,v,D))),new c({id:a,geometry:e.fromDimensions(this._options),modelMatrix:a.computeModelMatrixForHeightReference(t,a.box.heightReference,.5*this._options.dimensions.z,this._scene.mapProjection.ellipsoid),attributes:m})},V.prototype.createOutlineGeometryInstance=function(e){if(i.defined("time",e),!this._outlineEnabled)throw new p("This instance does not represent an outlined geometry.");var o=this._entity,a=o.isAvailable(e),f=P.getValueOrDefault(this._outlineColorProperty,e,r.BLACK,A),y=this._distanceDisplayConditionProperty.getValue(e),u={show:new h(a&&o.isShowing&&this._showProperty.getValue(e)&&this._showOutlineProperty.getValue(e)),color:n.fromColor(f),distanceDisplayCondition:l.fromDistanceDisplayCondition(y),offset:void 0};return s(this._options.offsetAttribute)&&(u.offset=d.fromCartesian3(P.getValueOrDefault(this._terrainOffsetProperty,e,v,D))),new c({id:o,geometry:t.fromDimensions(this._options),modelMatrix:o.computeModelMatrixForHeightReference(e,o.box.heightReference,.5*this._options.dimensions.z,this._scene.mapProjection.ellipsoid),attributes:u})},V.prototype._computeCenter=function(e,t){return P.getValueOrUndefined(this._entity.position,e,t)},V.prototype._isHidden=function(e,t){return!s(t.dimensions)||!s(e.position)||b.prototype._isHidden.call(this,e,t)},V.prototype._isDynamic=function(e,t){return!(e.position.isConstant&&P.isConstant(e.orientation)&&t.dimensions.isConstant&&P.isConstant(t.outlineWidth))},V.prototype._setStaticOptions=function(e,t){var o=P.getValueOrDefault(t.heightReference,y.MINIMUM_VALUE,u.NONE),i=this._options;i.vertexFormat=this._materialProperty instanceof g?_.VERTEX_FORMAT:m.MaterialSupport.TEXTURED.vertexFormat,i.dimensions=t.dimensions.getValue(y.MINIMUM_VALUE,i.dimensions),i.offsetAttribute=o!==u.NONE?f.ALL:void 0},V.prototype._onEntityPropertyChanged=C,V.DynamicGeometryUpdater=E,s(Object.create)&&(E.prototype=Object.create(O.prototype),E.prototype.constructor=E),E.prototype._isHidden=function(e,t,o){var i=P.getValueOrUndefined(e.position,o,w),r=this._options.dimensions;return!s(i)||!s(r)||O.prototype._isHidden.call(this,e,t,o)},E.prototype._setOptions=function(e,t,o){var i=P.getValueOrDefault(t.heightReference,o,u.NONE),r=this._options;r.dimensions=P.getValueOrUndefined(t.dimensions,o,r.dimensions),r.offsetAttribute=i!==u.NONE?f.ALL:void 0},V});