define(["../ThirdParty/when","./Check"],function(e,t){"use strict";function r(e){var t=e.positions,r=e.tilingScheme.tileXYToRectangle(e.x,e.y,e.level);return function(e){for(var n=0;n<t.length;++n){var i=t[n];i.height=e.interpolateHeight(r,i.longitude,i.latitude)}}}function n(e){var t=e.positions;return function(){for(var e=0;e<t.length;++e){t[e].height=void 0}}}return function(i,o,l){return t.typeOf.object("terrainProvider",i),t.typeOf.number("level",o),t.defined("positions",l),i.readyPromise.then(function(){return function(t,i,o){var l,u=t.tilingScheme,h=[],a={};for(l=0;l<o.length;++l){var s=u.positionToTileXY(o[l],i),f=s.toString();if(!a.hasOwnProperty(f)){var v={x:s.x,y:s.y,level:i,tilingScheme:u,terrainProvider:t,positions:[]};a[f]=v,h.push(v)}a[f].positions.push(o[l])}var c=[];for(l=0;l<h.length;++l){var g=h[l],p=g.terrainProvider.requestTileGeometry(g.x,g.y,g.level),d=p.then(r(g)).otherwise(n(g));c.push(d)}return e.all(c,function(){return o})}(i,o,l)})}});