define(["../Core/BoundingSphere","../Core/BoxGeometry","../Core/Cartesian3","../Core/combine","../Core/defaultValue","../Core/defined","../Core/destroyObject","../Core/DeveloperError","../Core/Matrix4","../Core/VertexFormat","../Renderer/BufferUsage","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArray","../Shaders/EllipsoidFS","../Shaders/EllipsoidVS","./BlendingState","./CullFace","./Material","./SceneMode"],function(e,i,t,r,s,n,o,h,a,d,u,_,c,l,p,m,S,g,f,v,x,L,y){"use strict";var E={position:0};function T(i){i=s(i,s.EMPTY_OBJECT),this.center=t.clone(s(i.center,t.ZERO)),this._center=new t,this.radii=t.clone(i.radii),this._radii=new t,this._oneOverEllipsoidRadiiSquared=new t,this._boundingSphere=new e,this.modelMatrix=a.clone(s(i.modelMatrix,a.IDENTITY)),this._modelMatrix=new a,this._computedModelMatrix=new a,this.show=s(i.show,!0),this.material=s(i.material,L.fromType(L.ColorType)),this._material=void 0,this._translucent=void 0,this.id=i.id,this._id=void 0,this.debugShowBoundingVolume=s(i.debugShowBoundingVolume,!1),this.onlySunLighting=s(i.onlySunLighting,!1),this._onlySunLighting=!1,this._depthTestEnabled=s(i.depthTestEnabled,!0),this._useLogDepth=!1,this._sp=void 0,this._rs=void 0,this._va=void 0,this._pickSP=void 0,this._pickId=void 0,this._colorCommand=new _({owner:s(i._owner,this)}),this._pickCommand=new _({owner:s(i._owner,this),pickOnly:!0});var r=this;this._uniforms={u_radii:function(){return r.radii},u_oneOverEllipsoidRadiiSquared:function(){return r._oneOverEllipsoidRadiiSquared}},this._pickUniforms={czm_pickColor:function(){return r._pickId.color}}}var C="#ifdef GL_EXT_frag_depth \n#extension GL_EXT_frag_depth : enable \n#endif \n\n";return T.prototype.update=function(s){if(this.show&&s.mode===y.SCENE3D&&n(this.center)&&n(this.radii)){if(!n(this.material))throw new h("this.material must be defined.");var o=s.context,_=this.material.isTranslucent(),L=this._translucent!==_;n(this._rs)&&!L||(this._translucent=_,this._rs=l.fromCache({cull:{enabled:!0,face:x.FRONT},depthTest:{enabled:this._depthTestEnabled},depthMask:!_&&o.fragmentDepth,blending:_?v.ALPHA_BLEND:void 0})),n(this._va)||(this._va=function(e){var r=e.cache.ellipsoidPrimitive_vertexArray;if(n(r))return r;var s=i.createGeometry(i.fromDimensions({dimensions:new t(2,2,2),vertexFormat:d.POSITION_ONLY}));return r=S.fromGeometry({context:e,geometry:s,attributeLocations:E,bufferUsage:u.STATIC_DRAW,interleave:!0}),e.cache.ellipsoidPrimitive_vertexArray=r,r}(o));var T=!1,P=this.radii;if(!t.equals(this._radii,P)){t.clone(P,this._radii);var k=this._oneOverEllipsoidRadiiSquared;k.x=1/(P.x*P.x),k.y=1/(P.y*P.y),k.z=1/(P.z*P.z),T=!0}a.equals(this.modelMatrix,this._modelMatrix)&&t.equals(this.center,this._center)||(a.clone(this.modelMatrix,this._modelMatrix),t.clone(this.center,this._center),a.multiplyByTranslation(this.modelMatrix,this.center,this._computedModelMatrix),T=!0),T&&(t.clone(t.ZERO,this._boundingSphere.center),this._boundingSphere.radius=t.maximumComponent(P),e.transform(this._boundingSphere,this._computedModelMatrix,this._boundingSphere));var b=this._material!==this.material;this._material=this.material,this._material.update(o);var w=this.onlySunLighting!==this._onlySunLighting;this._onlySunLighting=this.onlySunLighting;var I=s.useLogDepth,M=this._useLogDepth!==I;this._useLogDepth=I;var D,O,R=this._colorCommand;(b||w||L||M)&&(D=new m({sources:[f]}),O=new m({sources:[this.material.shaderSource,g]}),this.onlySunLighting&&O.defines.push("ONLY_SUN_LIGHTING"),!_&&o.fragmentDepth&&O.defines.push("WRITE_DEPTH"),this._useLogDepth&&(D.defines.push("LOG_DEPTH","DISABLE_GL_POSITION_LOG_DEPTH"),O.defines.push("LOG_DEPTH"),O.sources.push(C)),this._sp=p.replaceCache({context:o,shaderProgram:this._sp,vertexShaderSource:D,fragmentShaderSource:O,attributeLocations:E}),R.vertexArray=this._va,R.renderState=this._rs,R.shaderProgram=this._sp,R.uniformMap=r(this._uniforms,this.material._uniforms),R.executeInClosestFrustum=_);var N=s.commandList,G=s.passes;if(G.render&&(R.boundingVolume=this._boundingSphere,R.debugShowBoundingVolume=this.debugShowBoundingVolume,R.modelMatrix=this._computedModelMatrix,R.pass=_?c.TRANSLUCENT:c.OPAQUE,N.push(R)),G.pick){var A=this._pickCommand;n(this._pickId)&&this._id===this.id||(this._id=this.id,this._pickId=this._pickId&&this._pickId.destroy(),this._pickId=o.createPickId({primitive:this,id:this.id})),(b||w||!n(this._pickSP)||M)&&(D=new m({sources:[f]}),O=new m({sources:[this.material.shaderSource,g],pickColorQualifier:"uniform"}),this.onlySunLighting&&O.defines.push("ONLY_SUN_LIGHTING"),!_&&o.fragmentDepth&&O.defines.push("WRITE_DEPTH"),this._useLogDepth&&(D.defines.push("LOG_DEPTH"),O.defines.push("LOG_DEPTH"),O.sources.push(C)),this._pickSP=p.replaceCache({context:o,shaderProgram:this._pickSP,vertexShaderSource:D,fragmentShaderSource:O,attributeLocations:E}),A.vertexArray=this._va,A.renderState=this._rs,A.shaderProgram=this._pickSP,A.uniformMap=r(r(this._uniforms,this._pickUniforms),this.material._uniforms),A.executeInClosestFrustum=_),A.boundingVolume=this._boundingSphere,A.modelMatrix=this._computedModelMatrix,A.pass=_?c.TRANSLUCENT:c.OPAQUE,N.push(A)}}},T.prototype.isDestroyed=function(){return!1},T.prototype.destroy=function(){return this._sp=this._sp&&this._sp.destroy(),this._pickSP=this._pickSP&&this._pickSP.destroy(),this._pickId=this._pickId&&this._pickId.destroy(),o(this)},T});