define(["../Core/arrayFill","../Core/Check","../Core/combine","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/Event","../Core/getTimestamp","../Core/JulianDate","../Core/Math","../Core/Matrix4","../Core/Resource","../ThirdParty/when","./ClippingPlaneCollection","./PointCloud","./PointCloudEyeDomeLighting","./PointCloudShading","./SceneMode","./ShadowMode"],function(e,t,n,i,r,a,o,s,u,l,d,m,h,c,g,p,f,_,y,v){"use strict";function C(n){n=i(n,i.EMPTY_OBJECT),t.typeOf.object("options.clock",n.clock),t.typeOf.object("options.intervals",n.intervals),this.show=i(n.show,!0),this.modelMatrix=m.clone(i(n.modelMatrix,m.IDENTITY)),this.shadows=i(n.shadows,v.ENABLED),this.maximumMemoryUsage=i(n.maximumMemoryUsage,256),this.shading=new _(n.shading),this.style=n.style,this.frameFailed=new s,this.frameChanged=new s,this._clock=n.clock,this._intervals=n.intervals,this._clippingPlanes=void 0,this.clippingPlanes=n.clippingPlanes,this._pointCloudEyeDomeLighting=new f,this._loadTimestamp=void 0,this._clippingPlanesState=0,this._styleDirty=!1,this._pickId=void 0,this._totalMemoryUsageInBytes=0,this._frames=[],this._previousInterval=void 0,this._nextInterval=void 0,this._lastRenderedFrame=void 0,this._clockMultiplier=0,this._readyPromise=c.defer(),this._runningSum=0,this._runningLength=0,this._runningIndex=0,this._runningSamples=e(new Array(5),0),this._runningAverage=0}function P(e){return"uniform vec4 czm_pickColor;\n"+e}function I(){return"czm_pickColor"}a(C.prototype,{clippingPlanes:{get:function(){return this._clippingPlanes},set:function(e){g.setOwner(e,this,"_clippingPlanes")}},totalMemoryUsageInBytes:{get:function(){return this._totalMemoryUsageInBytes}},boundingSphere:{get:function(){if(r(this._lastRenderedFrame))return this._lastRenderedFrame.pointCloud.boundingSphere}},readyPromise:{get:function(){return this._readyPromise.promise}}}),C.prototype.makeStyleDirty=function(){this._styleDirty=!0},C.prototype._getAverageLoadTime=function(){return 0===this._runningLength?.05:this._runningAverage};var S=new l;function b(e){var t=e._clock,n=t.canAnimate&&t.shouldAnimate,i=t.multiplier;return n?i:0}function k(e,t){return e._intervals.indexOf(t.start)}function L(e,t,i){var a=k(e,t),o=e._frames,s=o[a];if(!r(s)){var l=t.data.transform,d=r(l)?m.fromArray(l):void 0,c=t.data.uri;s={pointCloud:void 0,transform:d,timestamp:u(),sequential:!0,ready:!1,touchedFrameNumber:i.frameNumber},o[a]=s,h.fetchArrayBuffer({url:c}).then(function(t){var i;return s.pointCloud=new p({arrayBuffer:t,cull:!0,fragmentShaderLoaded:P,uniformMapLoaded:(i=e,function(e){return n(e,{czm_pickColor:function(){return i._pickId.color}})}),pickIdLoaded:I}),s.pointCloud.readyPromise}).otherwise(function(e,t){return function(n){var i=r(n.message)?n.message:n.toString();e.frameFailed.numberOfListeners>0?e.frameFailed.raiseEvent({uri:t,message:i}):(console.log("A frame failed to load: "+t),console.log("Error: "+i))}}(e,c))}return s}function M(e,t,n,i){t.touchedFrameNumber<i.frameNumber-1&&(t.sequential=!1);var a=t.pointCloud;if(r(a)&&!t.ready){var o=i.commandList,s=o.length;if(F(e,t,n,i),a.ready)if(t.ready=!0,e._totalMemoryUsageInBytes+=a.geometryByteLength,o.length=s,t.sequential)!function(e,t){e._runningSum+=t,e._runningSum-=e._runningSamples[e._runningIndex],e._runningSamples[e._runningIndex]=t,e._runningLength=Math.min(e._runningLength+1,e._runningSamples.length),e._runningIndex=(e._runningIndex+1)%e._runningSamples.length,e._runningAverage=e._runningSum/e._runningLength}(e,(u()-t.timestamp)/1e3)}t.touchedFrameNumber=i.frameNumber}var x=new m;var w=new _;function F(e,t,n,a){var o=i(e.shading,w),s=t.pointCloud,u=i(t.transform,m.IDENTITY);s.modelMatrix=m.multiplyTransformation(e.modelMatrix,u,x),s.style=e.style,s.time=n.timeSinceLoad,s.shadows=e.shadows,s.clippingPlanes=e._clippingPlanes,s.isClipped=n.isClipped,s.attenuation=o.attenuation,s.backFaceCulling=o.backFaceCulling,s.normalShading=o.normalShading,s.geometricError=function(e,t){var n=e.shading;return r(n)&&r(n.baseResolution)?n.baseResolution:r(t.boundingSphere)?d.cbrt(t.boundingSphere.volume()/t.pointsLength):0}(e,s),s.geometricErrorScale=o.geometricErrorScale,s.maximumAttenuation=function(e){var t=e.shading;return r(t)&&r(t.maximumAttenuation)?t.maximumAttenuation:10}(e),s.update(a),t.touchedFrameNumber=a.frameNumber}function D(e,t,n,i){M(e,L(e,t,i),n,i)}function T(e,t){for(var n=e._frames,i=n.length,a=0;a<i;++a){var o=n[a];if(r(o)&&(!r(t)||t(o))){var s=o.pointCloud;o.ready&&(e._totalMemoryUsageInBytes-=s.geometryByteLength),r(s)&&s.destroy(),o===e._lastRenderedFrame&&(e._lastRenderedFrame=void 0),n[a]=void 0}}}function E(e,t,n,i,a){return!!r(n)&&(!!n.ready||(D(e,t,i,a),n.ready))}var A={timeSinceLoad:0,isClipped:!1,clippingPlanesDirty:!1};return C.prototype.update=function(e){if(e.mode!==y.MORPHING&&this.show){r(this._pickId)||(this._pickId=e.context.createPickId({primitive:this})),r(this._loadTimestamp)||(this._loadTimestamp=l.clone(e.time));var t=Math.max(1e3*l.secondsDifference(e.time,this._loadTimestamp),0),n=this._clippingPlanes,i=0,a=!1,o=r(n)&&n.enabled;o&&(n.update(e),i=n.clippingPlanesState),this._clippingPlanesState!==i&&(this._clippingPlanesState=i,a=!0);var s=this._styleDirty;this._styleDirty=!1,(a||s)&&function(e,t,n){for(var i=e._frames,a=i.length,o=0;o<a;++o){var s=i[o];r(s)&&r(s.pointCloud)&&(s.pointCloud.clippingPlanesDirty=t,s.pointCloud.styleDirty=n)}}(this,a,s),A.timeSinceLoad=t,A.isClipped=o;var u=this.shading,d=this._pointCloudEyeDomeLighting,m=e.commandList,h=m.length,c=this._previousInterval,g=this._nextInterval,p=function(e){var t=e._intervals,n=e._clock.currentTime,i=t.indexOf(n);return t.get(i)}(this);if(r(p)){var f=!1,_=b(this),v=0===_;_!==this._clockMultiplier&&(f=!0,this._clockMultiplier=_),r(c)&&!v||(c=p),(!r(g)||f||function(e,t,n){var i=b(e),r=k(e,t),a=k(e,n);return i>=0?r>=a:r<=a}(this,p,g))&&(g=function(e,t){var n=e._intervals,i=e._clock,r=b(e);if(0!==r){var a=e._getAverageLoadTime(),o=l.addSeconds(i.currentTime,a*r,S),s=n.indexOf(o);return s===k(e,t)&&(r>=0?++s:--s),n.get(s)}}(this,p));var C=function(e,t){var n=k(e,t),i=e._frames[n];if(r(i)&&i.ready)return i}(this,c=function(e,t,n,i,r){var a,o,s=e._intervals,u=e._frames,l=k(e,n),d=k(e,t);if(l>=d){for(a=l;a>=d;--a)if(E(e,o=s.get(a),u[a],i,r))return o}else for(a=l;a<=d;++a)if(E(e,o=s.get(a),u[a],i,r))return o;return t}(this,c,p,A,e));r(C)||(D(this,c,A,e),C=this._lastRenderedFrame),r(C)&&F(this,C,A,e),r(g)&&D(this,g,A,e);var P=this;r(C)&&!r(this._lastRenderedFrame)&&e.afterRender.push(function(){P._readyPromise.resolve(P)}),r(C)&&C!==this._lastRenderedFrame&&P.frameChanged.numberOfListeners>0&&e.afterRender.push(function(){P.frameChanged.raiseEvent(P)}),this._previousInterval=c,this._nextInterval=g,this._lastRenderedFrame=C,this._totalMemoryUsageInBytes>1024*this.maximumMemoryUsage*1024&&T(this,function(e){return function(t){return t.touchedFrameNumber<e.frameNumber}}(e));var I=m.length-h;r(u)&&u.attenuation&&u.eyeDomeLighting&&I>0&&d.update(e,h,u)}}},C.prototype.isDestroyed=function(){return!1},C.prototype.destroy=function(){return T(this),this._clippingPlanes=this._clippingPlanes&&this._clippingPlanes.destroy(),this._pickId=this._pickId&&this._pickId.destroy(),o(this)},C});