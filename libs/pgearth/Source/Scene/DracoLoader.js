define(["../Core/arraySlice","../Core/ComponentDatatype","../Core/defined","../Core/FeatureDetection","../Core/TaskProcessor","../ThirdParty/GltfPipeline/ForEach","../ThirdParty/when"],function(e,r,o,d,c,a,s){"use strict";function n(){}function t(e,r){var o="runtime."+Object.keys(e.createdBufferViews).length,d=e.buffers,c=Object.keys(d).length;return d[c]=r,e.createdBufferViews[o]={buffer:c,byteOffset:0,byteLength:r.byteLength},o}function i(e,r,o){var d=r._loadResources,c=t(d,e);return d.vertexBuffersToCreate.enqueue(c),c}function u(e,d,c,a){if(n._taskProcessorReady){var s=c.primitivesToDecode.peek();if(o(s)){var u=e.scheduleTask(s,[s.array.buffer]);if(o(u))return c.activeDecodingTasks++,c.primitivesToDecode.dequeue(),u.then(function(e){c.activeDecodingTasks--;var o=function(e,o,d){var c=e.typedArray,a=o._loadResources,s=t(a,c);return a.indexBuffersToCreate.enqueue({id:s,componentType:r.fromTypedArray(c)}),{bufferViewId:s,numberOfIndices:e.numberOfIndices}}(e.indexArray,d),a={},n=e.attributeData;for(var u in n)if(n.hasOwnProperty(u)){var f=n[u],h=i(f.array,d),_=f.data;_.bufferView=h,a[u]=_}d._decodedData[s.mesh+".primitive."+s.primitive]={bufferView:o.bufferViewId,numberOfIndices:o.numberOfIndices,attributes:a}})}}}return n._maxDecodingConcurrency=Math.max(d.hardwareConcurrency-1,1),n._decoderTaskProcessor=void 0,n._taskProcessorReady=!1,n._getDecoderTaskProcessor=function(){if(!o(n._decoderTaskProcessor)){var e=new c("decodeDraco",n._maxDecodingConcurrency);e.initWebAssemblyModule({modulePath:"ThirdParty/Workers/draco_wasm_wrapper.js",wasmBinaryFile:"ThirdParty/draco_decoder.wasm",fallbackModulePath:"ThirdParty/Workers/draco_decoder.js"}).then(function(){n._taskProcessorReady=!0}),n._decoderTaskProcessor=e}return n._decoderTaskProcessor},n.hasExtension=function(e){return o(e.extensionsRequired.KHR_draco_mesh_compression)||o(e.extensionsUsed.KHR_draco_mesh_compression)},n._decodedModelResourceCache=void 0,n.parse=function(r,d){if(n.hasExtension(r)){var c=r._loadResources,s=r.cacheKey;if(o(s)){o(n._decodedModelResourceCache)||(o(d.cache.modelDecodingCache)||(d.cache.modelDecodingCache={}),n._decodedModelResourceCache=d.cache.modelDecodingCache);var t=n._decodedModelResourceCache[s];if(o(t))return t.count++,void(c.pendingDecodingCache=!0)}var i=r._dequantizeInShader,u=r.gltf;a.mesh(u,function(r,d){a.meshPrimitive(r,function(r,a){if(o(r.extensions)){var s=r.extensions.KHR_draco_mesh_compression;if(o(s)){var n=u.bufferViews[s.bufferView],t=e(u.buffers[n.buffer].extras._pipeline.source,n.byteOffset,n.byteOffset+n.byteLength);c.primitivesToDecode.enqueue({mesh:d,primitive:a,array:t,bufferView:n,compressedAttributes:s.attributes,dequantizeInShader:i})}}})})}},n.decodeModel=function(e,r){if(!n.hasExtension(e))return s.resolve();var d=e._loadResources,c=e.cacheKey;if(o(c)&&o(n._decodedModelResourceCache)){var a=n._decodedModelResourceCache[c];if(o(a)&&d.pendingDecodingCache)return s(a.ready,function(){e._decodedData=a.data,d.pendingDecodingCache=!1});n._decodedModelResourceCache[c]={ready:!1,count:1,data:void 0}}if(0===d.primitivesToDecode.length)return s.resolve();for(var t=n._getDecoderTaskProcessor(),i=[],f=u(t,e,d);o(f);)i.push(f),f=u(t,e,d);return s.all(i)},n.decodePointCloud=function(e){var r=n._getDecoderTaskProcessor();if(n._taskProcessorReady)return r.scheduleTask(e,[e.buffer.buffer])},n.cacheDataForModel=function(e){var r=e.cacheKey;if(o(r)&&o(n._decodedModelResourceCache)){var d=n._decodedModelResourceCache[r];o(d)&&(d.ready=!0,d.data=e._decodedData)}},n.destroyCachedDataForModel=function(e){var r=e.cacheKey;if(o(r)&&o(n._decodedModelResourceCache)){var d=n._decodedModelResourceCache[r];o(d)&&0==--d.count&&delete n._decodedModelResourceCache[r]}},n});