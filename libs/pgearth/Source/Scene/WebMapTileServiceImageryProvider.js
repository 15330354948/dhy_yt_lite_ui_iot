define(["../Core/combine","../Core/Credit","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Event","../Core/freezeObject","../Core/isArray","../Core/Rectangle","../Core/Resource","../Core/WebMercatorTilingScheme","../ThirdParty/when","./ImageryProvider","./TimeDynamicImagery"],function(e,t,i,r,s,n,o,a,l,m,u,c,h,_,d){"use strict";var g=a({service:"WMTS",version:"1.0.0",request:"GetTile"});function f(e){if(e=i(e,i.EMPTY_OBJECT),!r(e.url))throw new n("options.url is required.");if(!r(e.layer))throw new n("options.layer is required.");if(!r(e.style))throw new n("options.style is required.");if(!r(e.tileMatrixSetID))throw new n("options.tileMatrixSetID is required.");if(r(e.times)&&!r(e.clock))throw new n("options.times was specified, so options.clock is required.");var s=u.createIfNeeded(e.url),a=e.style,_=e.tileMatrixSetID;if(s.url.indexOf("{")>=0){var f={style:a,Style:a,TileMatrixSet:_};s.setTemplateValues(f),this._useKvp=!1}else s.setQueryParameters(g),this._useKvp=!0;this._resource=s,this._layer=e.layer,this._style=a,this._tileMatrixSetID=_,this._tileMatrixLabels=e.tileMatrixLabels,this._format=i(e.format,"image/jpeg"),this._tileDiscardPolicy=e.tileDiscardPolicy,this._tilingScheme=r(e.tilingScheme)?e.tilingScheme:new c({ellipsoid:e.ellipsoid}),this._tileWidth=i(e.tileWidth,256),this._tileHeight=i(e.tileHeight,256),this._minimumLevel=i(e.minimumLevel,0),this._maximumLevel=e.maximumLevel,this._rectangle=i(e.rectangle,this._tilingScheme.rectangle),this._dimensions=e.dimensions;var v=this;this._reload=void 0,r(e.times)&&(this._timeDynamicImagery=new d({clock:e.clock,times:e.times,requestImageFunction:function(e,t,i,r,s){return y(v,e,t,i,r,s)},reloadFunction:function(){r(v._reload)&&v._reload()}})),this._readyPromise=h.resolve(!0);var p=this._tilingScheme.positionToTileXY(m.southwest(this._rectangle),this._minimumLevel),w=this._tilingScheme.positionToTileXY(m.northeast(this._rectangle),this._minimumLevel),x=(Math.abs(w.x-p.x)+1)*(Math.abs(w.y-p.y)+1);if(x>4)throw new n("The imagery provider's rectangle and minimumLevel indicate that there are "+x+" tiles at the minimum level. Imagery providers with more than four tiles at the minimum level are not supported.");this._errorEvent=new o;var T=e.credit;this._credit="string"==typeof T?new t(T):T,this._subdomains=e.subdomains,l(this._subdomains)?this._subdomains=this._subdomains.slice():r(this._subdomains)&&this._subdomains.length>0?this._subdomains=this._subdomains.split(""):this._subdomains=["a","b","c"]}function y(t,i,s,n,o,a){var l,m=t._tileMatrixLabels,u=r(m)?m[n]:n.toString(),c=t._subdomains,h=t._dimensions,d=r(a)?a.data:void 0;if(t._useKvp){var g={};g.tilematrix=u,g.layer=t._layer,g.style=t._style,g.tilerow=s,g.tilecol=i,g.tilematrixset=t._tileMatrixSetID,g.format=t._format,r(h)&&(g=e(g,h)),r(d)&&(g=e(g,d)),l=t._resource.getDerivedResource({queryParameters:g,request:o})}else{var f={TileMatrix:u,TileRow:s.toString(),TileCol:i.toString(),s:c[(i+s+n)%c.length]};(l=t._resource.getDerivedResource({request:o})).setTemplateValues(f),r(h)&&l.setTemplateValues(h),r(d)&&l.setTemplateValues(d)}return _.loadImage(t,l)}return s(f.prototype,{url:{get:function(){return this._resource.url}},proxy:{get:function(){return this._resource.proxy}},tileWidth:{get:function(){return this._tileWidth}},tileHeight:{get:function(){return this._tileHeight}},maximumLevel:{get:function(){return this._maximumLevel}},minimumLevel:{get:function(){return this._minimumLevel}},tilingScheme:{get:function(){return this._tilingScheme}},rectangle:{get:function(){return this._rectangle}},tileDiscardPolicy:{get:function(){return this._tileDiscardPolicy}},errorEvent:{get:function(){return this._errorEvent}},format:{get:function(){return this._format}},ready:{value:!0},readyPromise:{get:function(){return this._readyPromise}},credit:{get:function(){return this._credit}},hasAlphaChannel:{get:function(){return!0}},clock:{get:function(){return this._timeDynamicImagery.clock},set:function(e){this._timeDynamicImagery.clock=e}},times:{get:function(){return this._timeDynamicImagery.times},set:function(e){this._timeDynamicImagery.times=e}},dimensions:{get:function(){return this._dimensions},set:function(e){this._dimensions!==e&&(this._dimensions=e,r(this._reload)&&this._reload())}}}),f.prototype.getTileCredits=function(e,t,i){},f.prototype.requestImage=function(e,t,i,s){var n,o,a=this._timeDynamicImagery;return r(a)&&(o=a.currentInterval,n=a.getFromCache(e,t,i,s)),r(n)||(n=y(this,e,t,i,s,o)),r(n)&&r(a)&&a.checkApproachingInterval(e,t,i,s),n},f.prototype.pickFeatures=function(e,t,i,r,s){},f});