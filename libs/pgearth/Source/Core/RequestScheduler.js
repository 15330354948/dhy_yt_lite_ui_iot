define(["../ThirdParty/Uri","../ThirdParty/when","./Check","./defaultValue","./defined","./defineProperties","./Event","./Heap","./isBlobUri","./isDataUri","./RequestState"],function(e,t,r,s,u,n,i,c,f,a,o){"use strict";var l={numberOfAttemptedRequests:0,numberOfActiveRequests:0,numberOfCancelledRequests:0,numberOfCancelledActiveRequests:0,numberOfFailedRequests:0,numberOfActiveRequestsEver:0,lastNumberOfActiveRequests:0},m=20,v=new c({comparator:function(e,t){return e.priority-t.priority}});v.maximumLength=m,v.reserve(m);var q=[],d={},R="undefined"!=typeof document?new e(document.location.href):new e,b=new i;function O(){}function p(e){u(e.priorityFunction)&&(e.priority=e.priorityFunction())}function A(e){var t=s(O.requestsByServer[e],O.maximumRequestsPerServer);return d[e]<t}function h(e){return e.state===o.UNISSUED&&(e.state=o.ISSUED,e.deferred=t.defer()),e.deferred.promise}function y(e){var t=h(e);return e.state=o.ACTIVE,q.push(e),++l.numberOfActiveRequests,++l.numberOfActiveRequestsEver,++d[e.serverKey],e.requestFunction().then(function(e){return function(t){e.state!==o.CANCELLED&&(--l.numberOfActiveRequests,--d[e.serverKey],b.raiseEvent(),e.state=o.RECEIVED,e.deferred.resolve(t))}}(e)).otherwise(function(e){return function(t){e.state!==o.CANCELLED&&(++l.numberOfFailedRequests,--l.numberOfActiveRequests,--d[e.serverKey],b.raiseEvent(t),e.state=o.FAILED,e.deferred.reject(t))}}(e)),t}function E(e){var t=e.state===o.ACTIVE;e.state=o.CANCELLED,++l.numberOfCancelledRequests,e.deferred.reject(),t&&(--l.numberOfActiveRequests,--d[e.serverKey],++l.numberOfCancelledActiveRequests),u(e.cancelFunction)&&e.cancelFunction()}return O.maximumRequests=50,O.maximumRequestsPerServer=6,O.requestsByServer={"api.pgEarth.com:443":18,"assets.pgEarth.com:443":18},O.throttleRequests=!0,O.debugShowStatistics=!1,O.requestCompletedEvent=b,n(O,{statistics:{get:function(){return l}},priorityHeapLength:{get:function(){return m},set:function(e){if(e<m)for(;v.length>e;){E(v.pop())}m=e,v.maximumLength=e,v.reserve(e)}}}),O.update=function(){var e,t,r=0,s=q.length;for(e=0;e<s;++e)(t=q[e]).cancelled&&E(t),t.state===o.ACTIVE?r>0&&(q[e-r]=t):++r;q.length-=r;var u=v.internalArray,n=v.length;for(e=0;e<n;++e)p(u[e]);v.resort();for(var i=Math.max(O.maximumRequests-q.length,0),c=0;c<i&&v.length>0;)(t=v.pop()).cancelled?E(t):!t.throttleByServer||A(t.serverKey)?(y(t),++c):E(t);!function(){if(!O.debugShowStatistics)return;0===l.numberOfActiveRequests&&l.lastNumberOfActiveRequests>0&&(l.numberOfAttemptedRequests>0&&(console.log("Number of attempted requests: "+l.numberOfAttemptedRequests),l.numberOfAttemptedRequests=0),l.numberOfCancelledRequests>0&&(console.log("Number of cancelled requests: "+l.numberOfCancelledRequests),l.numberOfCancelledRequests=0),l.numberOfCancelledActiveRequests>0&&(console.log("Number of cancelled active requests: "+l.numberOfCancelledActiveRequests),l.numberOfCancelledActiveRequests=0),l.numberOfFailedRequests>0&&(console.log("Number of failed requests: "+l.numberOfFailedRequests),l.numberOfFailedRequests=0));l.lastNumberOfActiveRequests=l.numberOfActiveRequests}()},O.getServerKey=function(t){r.typeOf.string("url",t);var s=new e(t).resolve(R);s.normalize();var n=s.authority;/:/.test(n)||(n=n+":"+("https"===s.scheme?"443":"80"));var i=d[n];return u(i)||(d[n]=0),n},O.request=function(e){if(r.typeOf.object("request",e),r.typeOf.string("request.url",e.url),r.typeOf.func("request.requestFunction",e.requestFunction),a(e.url)||f(e.url))return b.raiseEvent(),e.state=o.RECEIVED,e.requestFunction();if(++l.numberOfAttemptedRequests,u(e.serverKey)||(e.serverKey=O.getServerKey(e.url)),!e.throttleByServer||A(e.serverKey)){if(!O.throttleRequests||!e.throttle)return y(e);if(!(q.length>=O.maximumRequests)){p(e);var t=v.insert(e);if(u(t)){if(t===e)return;E(t)}return h(e)}}},O.clearForSpecs=function(){for(;v.length>0;){E(v.pop())}for(var e=q.length,t=0;t<e;++t)E(q[t]);q.length=0,d={},l.numberOfAttemptedRequests=0,l.numberOfActiveRequests=0,l.numberOfCancelledRequests=0,l.numberOfCancelledActiveRequests=0,l.numberOfFailedRequests=0,l.numberOfActiveRequestsEver=0,l.lastNumberOfActiveRequests=0},O.numberOfActiveRequestsByServer=function(e){return d[e]},O.requestHeap=v,O});