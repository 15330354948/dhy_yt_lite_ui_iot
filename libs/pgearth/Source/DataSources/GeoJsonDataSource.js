define(["../Core/ArcType","../Core/Cartesian3","../Core/Color","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Event","../Core/getFilenameFromUri","../Core/PinBuilder","../Core/PolygonHierarchy","../Core/Resource","../Core/RuntimeError","../Scene/HeightReference","../Scene/VerticalOrigin","../ThirdParty/topojson","../ThirdParty/when","./BillboardGraphics","./CallbackProperty","./ColorMaterialProperty","./ConstantPositionProperty","./ConstantProperty","./DataSource","./EntityCluster","./EntityCollection","./PolygonGraphics","./PolylineGraphics"],function(e,r,t,n,o,i,a,l,s,c,u,f,p,h,y,d,g,m,w,v,C,k,_,P,b,S,E,T){"use strict";function G(e){return r.fromDegrees(e[0],e[1],e[2])}var M,L={"urn:ogc:def:crs:OGC:1.3:CRS84":G,"EPSG:4326":G,"urn:ogc:def:crs:EPSG::4326":G},O={},U={},B=48,R=t.ROYALBLUE,j=t.YELLOW,A=2,W=t.fromBytes(255,255,0,100),z=!1,H={small:24,medium:48,large:64},N=["title","description","marker-size","marker-symbol","marker-color","stroke","stroke-opacity","stroke-width","fill","fill-opacity"];function F(e,r){var t="";for(var n in e)if(e.hasOwnProperty(n)){if(n===r||-1!==N.indexOf(n))continue;var o=e[n];i(o)&&(t+="object"==typeof o?"<tr><th>"+n+"</th><td>"+F(o)+"</td></tr>":"<tr><th>"+n+"</th><td>"+o+"</td></tr>")}return t.length>0&&(t='<table class="pgEarth-infoBox-defaultTable"><tbody>'+t+"</tbody></table>"),t}function D(e,r){return new v(function(e,r,t){var n;return function(o,a){return i(n)||(n=e(r,t)),n}}(F,e,r),!0)}function I(e,r,t){var o=e.id;if(i(o)&&"Feature"===e.type){for(var a=2,l=o;i(r.getById(l));)l=o+"_"+a,a++;o=l}else o=n();var s=r.getOrCreateEntity(o),c=e.properties;if(i(c)){var u;s.properties=c;var f=c.title;if(i(f))s.name=f,u="title";else{var p=Number.MAX_VALUE;for(var h in c)if(c.hasOwnProperty(h)&&c[h]){var y=h.toLowerCase();if(p>1&&"title"===y){p=1,u=h;break}p>2&&"name"===y?(p=2,u=h):p>3&&/title/i.test(h)?(p=3,u=h):p>4&&/name/i.test(h)&&(p=4,u=h)}i(u)&&(s.name=c[u])}var d=c.description;null!==d&&(s.description=i(d)?new _(d):t(c,u))}return s}function J(e,r){for(var t=new Array(e.length),n=0;n<e.length;n++)t[n]=r(e[n]);return t}var x={Feature:Y,FeatureCollection:function(e,r,t,n,o){for(var i=r.features,a=0,l=i.length;a<l;a++)Y(e,i[a],void 0,n,o)},GeometryCollection:q,LineString:$,MultiLineString:ee,MultiPoint:Q,MultiPolygon:ne,Point:K,Polygon:te,Topology:oe},V={GeometryCollection:q,LineString:$,MultiLineString:ee,MultiPoint:Q,MultiPolygon:ne,Point:K,Polygon:te,Topology:oe};function Y(e,r,t,n,o){if(null!==r.geometry){if(!i(r.geometry))throw new h("feature.geometry is required.");var a=r.geometry.type,l=V[a];if(!i(l))throw new h("Unknown geometry type: "+a);l(e,r,r.geometry,n,o)}else I(r,e._entityCollection,o.describe)}function q(e,r,t,n,o){for(var a=t.geometries,l=0,s=a.length;l<s;l++){var c=a[l],u=c.type,f=V[u];if(!i(f))throw new h("Unknown geometry type: "+u);f(e,r,c,n,o)}}function X(e,r,n,a,l){var s,c=l.markerSymbol,u=l.markerColor,f=l.markerSize,p=r.properties;if(i(p)){var h=p["marker-color"];i(h)&&(u=t.fromCssColorString(h)),f=o(H[p["marker-size"]],f);var g=p["marker-symbol"];i(g)&&(c=g)}s=i(c)?1===c.length?e._pinBuilder.fromText(c.toUpperCase(),u,f):e._pinBuilder.fromMakiIconId(c,u,f):e._pinBuilder.fromColor(u,f);var v=new w;v.verticalOrigin=new _(d.BOTTOM),2===a.length&&l.clampToGround&&(v.heightReference=y.CLAMP_TO_GROUND);var C=I(r,e._entityCollection,l.describe);C.billboard=v,C.position=new k(n(a));var P=m(s).then(function(e){v.image=new _(e)}).otherwise(function(){v.image=new _(e._pinBuilder.fromColor(u,f))});e._promises.push(P)}function K(e,r,t,n,o){X(e,r,n,t.coordinates,o)}function Q(e,r,t,n,o){for(var i=t.coordinates,a=0;a<i.length;a++)X(e,r,n,i[a],o)}function Z(r,n,o,a,l){var s=l.strokeMaterialProperty,c=l.strokeWidthProperty,u=n.properties;if(i(u)){var f,p=u["stroke-width"];i(p)&&(c=new _(p));var h=u.stroke;i(h)&&(f=t.fromCssColorString(h));var y=u["stroke-opacity"];i(y)&&1!==y&&(i(f)||(f=s.color.clone()),f.alpha=y),i(f)&&(s=new C(f))}var d=I(n,r._entityCollection,l.describe),g=new T;d.polyline=g,g.clampToGround=l.clampToGround,g.material=s,g.width=c,g.positions=new _(J(a,o)),g.arcType=e.RHUMB}function $(e,r,t,n,o){Z(e,r,n,t.coordinates,o)}function ee(e,r,t,n,o){for(var i=t.coordinates,a=0;a<i.length;a++)Z(e,r,n,i[a],o)}function re(r,n,o,a,l){if(0!==a.length&&0!==a[0].length){var s=l.strokeMaterialProperty.color,c=l.fillMaterialProperty,u=l.strokeWidthProperty,p=n.properties;if(i(p)){var h,y=p["stroke-width"];i(y)&&(u=new _(y));var d=p.stroke;i(d)&&(h=t.fromCssColorString(d));var g,m=p["stroke-opacity"];i(m)&&1!==m&&(i(h)||(h=l.strokeMaterialProperty.color.clone()),h.alpha=m),i(h)&&(s=new _(h));var w=p.fill;i(w)&&((g=t.fromCssColorString(w)).alpha=c.color.alpha),m=p["fill-opacity"],i(m)&&m!==c.color.alpha&&(i(g)||(g=c.color.clone()),g.alpha=m),i(g)&&(c=new C(g))}var v=new E;v.outline=new _(!0),v.outlineColor=s,v.outlineWidth=u,v.material=c,v.arcType=e.RHUMB;for(var k=[],P=1,b=a.length;P<b;P++)k.push(new f(J(a[P],o)));var S=a[0];v.hierarchy=new _(new f(J(S,o),k)),S[0].length>2?v.perPositionHeight=new _(!0):l.clampToGround||(v.height=0),I(n,r._entityCollection,l.describe).polygon=v}}function te(e,r,t,n,o){re(e,r,n,t.coordinates,o)}function ne(e,r,t,n,o){for(var i=t.coordinates,a=0;a<i.length;a++)re(e,r,n,i[a],o)}function oe(e,r,t,n,o){for(var i in t.objects)if(t.objects.hasOwnProperty(i)){var a=g.feature(t,t.objects[i]);(0,x[a.type])(e,a,a,n,o)}}function ie(e){this._name=e,this._changed=new s,this._error=new s,this._isLoading=!1,this._loading=new s,this._entityCollection=new S(this),this._promises=[],this._pinBuilder=new u,this._entityCluster=new b}return ie.load=function(e,r){return(new ie).load(e,r)},a(ie,{markerSize:{get:function(){return B},set:function(e){B=e}},markerSymbol:{get:function(){return M},set:function(e){M=e}},markerColor:{get:function(){return R},set:function(e){R=e}},stroke:{get:function(){return j},set:function(e){j=e}},strokeWidth:{get:function(){return A},set:function(e){A=e}},fill:{get:function(){return W},set:function(e){W=e}},clampToGround:{get:function(){return z},set:function(e){z=e}},crsNames:{get:function(){return L}},crsLinkHrefs:{get:function(){return O}},crsLinkTypes:{get:function(){return U}}}),a(ie.prototype,{name:{get:function(){return this._name},set:function(e){this._name!==e&&(this._name=e,this._changed.raiseEvent(this))}},clock:{value:void 0,writable:!1},entities:{get:function(){return this._entityCollection}},isLoading:{get:function(){return this._isLoading}},changedEvent:{get:function(){return this._changed}},errorEvent:{get:function(){return this._error}},loadingEvent:{get:function(){return this._loading}},show:{get:function(){return this._entityCollection.show},set:function(e){this._entityCollection.show=e}},clustering:{get:function(){return this._entityCluster},set:function(e){if(!i(e))throw new l("value must be defined.");this._entityCluster=e}}}),ie.prototype.load=function(e,r){if(!i(e))throw new l("data is required.");P.setLoading(this,!0);var t=e,n=(r=o(r,o.EMPTY_OBJECT)).sourceUri;("string"==typeof e||e instanceof p)&&(t=(e=p.createIfNeeded(e)).fetchJson(),n=o(n,e.getUrlComponent())),r={describe:o(r.describe,D),markerSize:o(r.markerSize,B),markerSymbol:o(r.markerSymbol,M),markerColor:o(r.markerColor,R),strokeWidthProperty:new _(o(r.strokeWidth,A)),strokeMaterialProperty:new C(o(r.stroke,j)),fillMaterialProperty:new C(o(r.fill,W)),clampToGround:o(r.clampToGround,z)};var a=this;return m(t,function(e){return function(e,r,t,n){var o;i(n)&&(o=c(n));i(o)&&e._name!==o&&(e._name=o,e._changed.raiseEvent(e));var a=x[r.type];if(!i(a))throw new h("Unsupported GeoJSON object type: "+r.type);var l=r.crs,s=null!==l?G:null;if(i(l)){if(!i(l.properties))throw new h("crs.properties is undefined.");var u=l.properties;if("name"===l.type){if(s=L[u.name],!i(s))throw new h("Unknown crs name: "+u.name)}else if("link"===l.type){var f=O[u.href];if(i(f)||(f=U[u.type]),!i(f))throw new h("Unable to resolve crs link: "+JSON.stringify(u));s=f(u)}else{if("EPSG"!==l.type)throw new h("Unknown crs type: "+l.type);if(s=L["EPSG:"+u.code],!i(s))throw new h("Unknown crs EPSG code: "+u.code)}}return m(s,function(n){return e._entityCollection.removeAll(),null!==n&&a(e,r,r,n,t),m.all(e._promises,function(){return e._promises.length=0,P.setLoading(e,!1),e})})}(a,e,r,n)}).otherwise(function(e){return P.setLoading(a,!1),a._error.raiseEvent(a,e),console.log(e),m.reject(e)})},ie});