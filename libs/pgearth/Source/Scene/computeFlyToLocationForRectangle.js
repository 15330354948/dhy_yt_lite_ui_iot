define(["../Core/defined","../Core/Rectangle","../Core/sampleTerrainMostDetailed","./SceneMode","../ThirdParty/when"],function(e,r,t,a,n){"use strict";function i(t,o){var s,u=o.terrainProvider,c=o.mapProjection,d=c.ellipsoid,h=o.camera.getRectangleCameraCoordinates(t);return s=o.mode===a.SCENE3D?d.cartesianToCartographic(h):c.unproject(h),e(u)?u.readyPromise.then(function(){var n=u.availability;if(!e(n)||o.mode===a.SCENE2D)return s;var c=[r.center(t),r.southeast(t),r.southwest(t),r.northeast(t),r.northwest(t)];return i._sampleTerrainMostDetailed(u,c).then(function(e){var r=e.reduce(function(e,r){return Math.max(r.height,e)},-Number.MAX_VALUE),t=s;return t.height+=r,t})}):n.resolve(s)}return i._sampleTerrainMostDetailed=t,i});