define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/Color","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/EncodedCartesian3","../Core/Math","../Core/Matrix3","../Core/Matrix4","../Core/OrthographicFrustum","../Core/Simon1994PlanetaryPositions","../Core/Transforms","../Scene/SceneMode","./Sampler"],function(e,i,t,o,n,r,s,a,_,c,h,u,l,m,v,D,w,d){"use strict";function y(){this.globeDepthTexture=void 0,this.gamma=void 0,this._viewport=new e,this._viewportCartesian4=new o,this._viewportDirty=!1,this._viewportOrthographicMatrix=l.clone(l.IDENTITY),this._viewportTransformation=l.clone(l.IDENTITY),this._model=l.clone(l.IDENTITY),this._view=l.clone(l.IDENTITY),this._inverseView=l.clone(l.IDENTITY),this._projection=l.clone(l.IDENTITY),this._infiniteProjection=l.clone(l.IDENTITY),this._entireFrustum=new i,this._currentFrustum=new i,this._frustumPlanes=new o,this._log2FarDistance=void 0,this._log2FarPlusOne=void 0,this._log2NearDistance=void 0,this._frameState=void 0,this._temeToPseudoFixed=u.clone(l.IDENTITY),this._view3DDirty=!0,this._view3D=new l,this._inverseView3DDirty=!0,this._inverseView3D=new l,this._inverseModelDirty=!0,this._inverseModel=new l,this._inverseTransposeModelDirty=!0,this._inverseTransposeModel=new u,this._viewRotation=new u,this._inverseViewRotation=new u,this._viewRotation3D=new u,this._inverseViewRotation3D=new u,this._inverseProjectionDirty=!0,this._inverseProjection=new l,this._modelViewDirty=!0,this._modelView=new l,this._modelView3DDirty=!0,this._modelView3D=new l,this._modelViewRelativeToEyeDirty=!0,this._modelViewRelativeToEye=new l,this._inverseModelViewDirty=!0,this._inverseModelView=new l,this._inverseModelView3DDirty=!0,this._inverseModelView3D=new l,this._viewProjectionDirty=!0,this._viewProjection=new l,this._inverseViewProjectionDirty=!0,this._inverseViewProjection=new l,this._modelViewProjectionDirty=!0,this._modelViewProjection=new l,this._inverseModelViewProjectionDirty=!0,this._inverseModelViewProjection=new l,this._modelViewProjectionRelativeToEyeDirty=!0,this._modelViewProjectionRelativeToEye=new l,this._modelViewInfiniteProjectionDirty=!0,this._modelViewInfiniteProjection=new l,this._normalDirty=!0,this._normal=new u,this._normal3DDirty=!0,this._normal3D=new u,this._inverseNormalDirty=!0,this._inverseNormal=new u,this._inverseNormal3DDirty=!0,this._inverseNormal3D=new u,this._encodedCameraPositionMCDirty=!0,this._encodedCameraPositionMC=new c,this._cameraPosition=new t,this._sunPositionWC=new t,this._sunPositionColumbusView=new t,this._sunDirectionWC=new t,this._sunDirectionEC=new t,this._sunColor=new t,this._moonDirectionEC=new t,this._pass=void 0,this._mode=void 0,this._mapProjection=void 0,this._cameraDirection=new t,this._cameraRight=new t,this._cameraUp=new t,this._frustum2DWidth=0,this._eyeHeight2D=new i,this._resolutionScale=1,this._orthographicIn3D=!1,this._backgroundColor=new r,this._brdfLut=void 0,this._environmentMap=void 0,this._sphericalHarmonicCoefficients=void 0,this._specularEnvironmentMaps=void 0,this._specularEnvironmentMapsDimensions=new i,this._specularEnvironmentMapsMaximumLOD=void 0,this._fogDensity=void 0,this._invertClassificationColor=void 0,this._imagerySplitPosition=0,this._pixelSizePerMeter=void 0,this._geometricToleranceOverMeter=void 0,this._minimumDisableDepthTestDistance=void 0}_(y.prototype,{frameState:{get:function(){return this._frameState}},viewport:{get:function(){return this._viewport},set:function(i){if(!e.equals(i,this._viewport)){e.clone(i,this._viewport);var t=this._viewport,o=this._viewportCartesian4;o.x=t.x,o.y=t.y,o.z=t.width,o.w=t.height,this._viewportDirty=!0}}},viewportCartesian4:{get:function(){return this._viewportCartesian4}},viewportOrthographic:{get:function(){return P(this),this._viewportOrthographicMatrix}},viewportTransformation:{get:function(){return P(this),this._viewportTransformation}},model:{get:function(){return this._model},set:function(e){l.clone(e,this._model),this._modelView3DDirty=!0,this._inverseModelView3DDirty=!0,this._inverseModelDirty=!0,this._inverseTransposeModelDirty=!0,this._modelViewDirty=!0,this._inverseModelViewDirty=!0,this._modelViewRelativeToEyeDirty=!0,this._inverseModelViewDirty=!0,this._modelViewProjectionDirty=!0,this._inverseModelViewProjectionDirty=!0,this._modelViewProjectionRelativeToEyeDirty=!0,this._modelViewInfiniteProjectionDirty=!0,this._normalDirty=!0,this._inverseNormalDirty=!0,this._normal3DDirty=!0,this._inverseNormal3DDirty=!0,this._encodedCameraPositionMCDirty=!0}},inverseModel:{get:function(){return this._inverseModelDirty&&(this._inverseModelDirty=!1,l.inverse(this._model,this._inverseModel)),this._inverseModel}},inverseTransposeModel:{get:function(){var e=this._inverseTransposeModel;return this._inverseTransposeModelDirty&&(this._inverseTransposeModelDirty=!1,l.getRotation(this.inverseModel,e),u.transpose(e,e)),e}},view:{get:function(){return this._view}},view3D:{get:function(){return N(this),this._view3D}},viewRotation:{get:function(){return N(this),this._viewRotation}},viewRotation3D:{get:function(){return N(this),this._viewRotation3D}},inverseView:{get:function(){return this._inverseView}},inverseView3D:{get:function(){return F(this),this._inverseView3D}},inverseViewRotation:{get:function(){return this._inverseViewRotation}},inverseViewRotation3D:{get:function(){return F(this),this._inverseViewRotation3D}},projection:{get:function(){return this._projection}},inverseProjection:{get:function(){var e;return(e=this)._inverseProjectionDirty&&(e._inverseProjectionDirty=!1,e._mode===w.SCENE2D||e._mode===w.MORPHING||e._orthographicIn3D?l.clone(l.ZERO,e._inverseProjection):l.inverse(e._projection,e._inverseProjection)),this._inverseProjection}},infiniteProjection:{get:function(){return this._infiniteProjection}},modelView:{get:function(){var e;return(e=this)._modelViewDirty&&(e._modelViewDirty=!1,l.multiplyTransformation(e._view,e._model,e._modelView)),this._modelView}},modelView3D:{get:function(){var e;return(e=this)._modelView3DDirty&&(e._modelView3DDirty=!1,l.multiplyTransformation(e.view3D,e._model,e._modelView3D)),this._modelView3D}},modelViewRelativeToEye:{get:function(){return function(e){if(e._modelViewRelativeToEyeDirty){e._modelViewRelativeToEyeDirty=!1;var i=e.modelView,t=e._modelViewRelativeToEye;t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=0,t[13]=0,t[14]=0,t[15]=i[15]}}(this),this._modelViewRelativeToEye}},inverseModelView:{get:function(){var e;return(e=this)._inverseModelViewDirty&&(e._inverseModelViewDirty=!1,l.inverse(e.modelView,e._inverseModelView)),this._inverseModelView}},inverseModelView3D:{get:function(){var e;return(e=this)._inverseModelView3DDirty&&(e._inverseModelView3DDirty=!1,l.inverse(e.modelView3D,e._inverseModelView3D)),this._inverseModelView3D}},viewProjection:{get:function(){var e;return(e=this)._viewProjectionDirty&&(e._viewProjectionDirty=!1,l.multiply(e._projection,e._view,e._viewProjection)),this._viewProjection}},inverseViewProjection:{get:function(){var e;return(e=this)._inverseViewProjectionDirty&&(e._inverseViewProjectionDirty=!1,l.inverse(e.viewProjection,e._inverseViewProjection)),this._inverseViewProjection}},modelViewProjection:{get:function(){var e;return(e=this)._modelViewProjectionDirty&&(e._modelViewProjectionDirty=!1,l.multiply(e._projection,e.modelView,e._modelViewProjection)),this._modelViewProjection}},inverseModelViewProjection:{get:function(){var e;return(e=this)._inverseModelViewProjectionDirty&&(e._inverseModelViewProjectionDirty=!1,l.inverse(e.modelViewProjection,e._inverseModelViewProjection)),this._inverseModelViewProjection}},modelViewProjectionRelativeToEye:{get:function(){var e;return(e=this)._modelViewProjectionRelativeToEyeDirty&&(e._modelViewProjectionRelativeToEyeDirty=!1,l.multiply(e._projection,e.modelViewRelativeToEye,e._modelViewProjectionRelativeToEye)),this._modelViewProjectionRelativeToEye}},modelViewInfiniteProjection:{get:function(){var e;return(e=this)._modelViewInfiniteProjectionDirty&&(e._modelViewInfiniteProjectionDirty=!1,l.multiply(e._infiniteProjection,e.modelView,e._modelViewInfiniteProjection)),this._modelViewInfiniteProjection}},normal:{get:function(){return function(e){if(e._normalDirty){e._normalDirty=!1;var i=e._normal;l.getRotation(e.inverseModelView,i),u.transpose(i,i)}}(this),this._normal}},normal3D:{get:function(){return function(e){if(e._normal3DDirty){e._normal3DDirty=!1;var i=e._normal3D;l.getRotation(e.inverseModelView3D,i),u.transpose(i,i)}}(this),this._normal3D}},inverseNormal:{get:function(){var e;return(e=this)._inverseNormalDirty&&(e._inverseNormalDirty=!1,l.getRotation(e.inverseModelView,e._inverseNormal)),this._inverseNormal}},inverseNormal3D:{get:function(){var e;return(e=this)._inverseNormal3DDirty&&(e._inverseNormal3DDirty=!1,l.getRotation(e.inverseModelView3D,e._inverseNormal3D)),this._inverseNormal3D}},entireFrustum:{get:function(){return this._entireFrustum}},currentFrustum:{get:function(){return this._currentFrustum}},frustumPlanes:{get:function(){return this._frustumPlanes}},log2FarDistance:{get:function(){return this._log2FarDistance}},log2FarPlusOne:{get:function(){return this._log2FarPlusOne}},log2NearDistance:{get:function(){return this._log2NearDistance}},eyeHeight2D:{get:function(){return this._eyeHeight2D}},sunPositionWC:{get:function(){return this._sunPositionWC}},sunPositionColumbusView:{get:function(){return this._sunPositionColumbusView}},sunDirectionWC:{get:function(){return this._sunDirectionWC}},sunDirectionEC:{get:function(){return this._sunDirectionEC}},sunColor:{get:function(){return this._sunColor}},moonDirectionEC:{get:function(){return this._moonDirectionEC}},encodedCameraPositionMCHigh:{get:function(){return C(this),this._encodedCameraPositionMC.high}},encodedCameraPositionMCLow:{get:function(){return C(this),this._encodedCameraPositionMC.low}},temeToPseudoFixedMatrix:{get:function(){return this._temeToPseudoFixed}},resolutionScale:{get:function(){return this._resolutionScale}},fogDensity:{get:function(){return this._fogDensity}},geometricToleranceOverMeter:{get:function(){return this._geometricToleranceOverMeter}},pass:{get:function(){return this._pass}},backgroundColor:{get:function(){return this._backgroundColor}},brdfLut:{get:function(){return this._brdfLut}},environmentMap:{get:function(){return this._environmentMap}},sphericalHarmonicCoefficients:{get:function(){return this._sphericalHarmonicCoefficients}},specularEnvironmentMaps:{get:function(){return this._specularEnvironmentMaps}},specularEnvironmentMapsDimensions:{get:function(){return this._specularEnvironmentMapsDimensions}},specularEnvironmentMapsMaximumLOD:{get:function(){return this._specularEnvironmentMapsMaximumLOD}},imagerySplitPosition:{get:function(){return this._imagerySplitPosition}},minimumDisableDepthTestDistance:{get:function(){return this._minimumDisableDepthTestDistance}},invertClassificationColor:{get:function(){return this._invertClassificationColor}},orthographicIn3D:{get:function(){return this._orthographicIn3D}}});var f=new u,p=new n;y.prototype.updateCamera=function(e){var i,o;i=this,o=e.viewMatrix,l.clone(o,i._view),l.getRotation(o,i._viewRotation),i._view3DDirty=!0,i._inverseView3DDirty=!0,i._modelViewDirty=!0,i._modelView3DDirty=!0,i._modelViewRelativeToEyeDirty=!0,i._inverseModelViewDirty=!0,i._inverseModelView3DDirty=!0,i._viewProjectionDirty=!0,i._inverseViewProjectionDirty=!0,i._modelViewProjectionDirty=!0,i._modelViewProjectionRelativeToEyeDirty=!0,i._modelViewInfiniteProjectionDirty=!0,i._normalDirty=!0,i._inverseNormalDirty=!0,i._normal3DDirty=!0,i._inverseNormal3DDirty=!0,function(e,i){l.clone(i,e._inverseView),l.getRotation(i,e._inverseViewRotation)}(this,e.inverseViewMatrix),function(e,i){t.clone(i.positionWC,e._cameraPosition),t.clone(i.directionWC,e._cameraDirection),t.clone(i.rightWC,e._cameraRight),t.clone(i.upWC,e._cameraUp),e._encodedCameraPositionMCDirty=!0}(this,e),this._entireFrustum.x=e.frustum.near,this._entireFrustum.y=e.frustum.far,this.updateFrustum(e.frustum),this._orthographicIn3D=this._mode!==w.SCENE2D&&e.frustum instanceof m},y.prototype.updateFrustum=function(e){var i,t;i=this,t=e.projectionMatrix,l.clone(t,i._projection),i._inverseProjectionDirty=!0,i._viewProjectionDirty=!0,i._inverseViewProjectionDirty=!0,i._modelViewProjectionDirty=!0,i._modelViewProjectionRelativeToEyeDirty=!0,a(e.infiniteProjectionMatrix)&&function(e,i){l.clone(i,e._infiniteProjection),e._modelViewInfiniteProjectionDirty=!0}(this,e.infiniteProjectionMatrix),this._currentFrustum.x=e.near,this._currentFrustum.y=e.far,this._log2FarDistance=2/h.log2(e.far+1),this._log2FarPlusOne=h.log2(e.far+1),this._log2NearDistance=h.log2(e.near),a(e._offCenterFrustum)&&(e=e._offCenterFrustum),this._frustumPlanes.x=e.top,this._frustumPlanes.y=e.bottom,this._frustumPlanes.z=e.left,this._frustumPlanes.w=e.right},y.prototype.updatePass=function(e){this._pass=e};var g=[];function P(e){if(e._viewportDirty){var i=e._viewport;l.computeOrthographicOffCenter(i.x,i.x+i.width,i.y,i.y+i.height,0,1,e._viewportOrthographicMatrix),l.computeViewportTransformation(i,0,1,e._viewportTransformation),e._viewportDirty=!1}}y.prototype.update=function(e){this._mode=e.mode,this._mapProjection=e.mapProjection;var o=e.context._canvas;this._resolutionScale=o.width/o.clientWidth;var n=e.camera;this.updateCamera(n),e.mode===w.SCENE2D?(this._frustum2DWidth=n.frustum.right-n.frustum.left,this._eyeHeight2D.x=.5*this._frustum2DWidth,this._eyeHeight2D.y=this._eyeHeight2D.x*this._eyeHeight2D.x):(this._frustum2DWidth=0,this._eyeHeight2D.x=0,this._eyeHeight2D.y=0),function(e,i){a(D.computeIcrfToFixedMatrix(i.time,f))||(f=D.computeTemeToPseudoFixedMatrix(i.time,f));var o=v.computeSunPositionInEarthInertialFrame(i.time,e._sunPositionWC);u.multiplyByVector(f,o,o),t.normalize(o,e._sunDirectionWC),o=u.multiplyByVector(e.viewRotation3D,o,e._sunDirectionEC),t.normalize(o,o),o=v.computeMoonPositionInEarthInertialFrame(i.time,e._moonDirectionEC),u.multiplyByVector(f,o,o),u.multiplyByVector(e.viewRotation3D,o,o),t.normalize(o,o);var n=i.mapProjection,r=n.ellipsoid.cartesianToCartographic(e._sunPositionWC,p);n.project(r,e._sunPositionColumbusView)}(this,e),this._sunColor=t.clone(e.sunColor,this._sunColor);var _=e.brdfLutGenerator,c=a(_)?_.colorTexture:void 0;this._brdfLut=c,this._environmentMap=s(e.environmentMap,e.context.defaultCubeMap),this._sphericalHarmonicCoefficients=s(e.sphericalHarmonicCoefficients,g),this._specularEnvironmentMaps=e.specularEnvironmentMaps,this._specularEnvironmentMapsMaximumLOD=e.specularEnvironmentMapsMaximumLOD,a(this._specularEnvironmentMaps)&&i.clone(this._specularEnvironmentMaps.dimensions,this._specularEnvironmentMapsDimensions),this._fogDensity=e.fog.density,this._invertClassificationColor=e.invertClassificationColor,this._frameState=e,this._temeToPseudoFixed=D.computeTemeToPseudoFixedMatrix(e.time,this._temeToPseudoFixed),this._imagerySplitPosition=e.imagerySplitPosition*e.context.drawingBufferWidth;var h,l=n.frustum.fov,m=this._viewport;h=m.height>m.width?2*Math.tan(.5*l)/m.height:2*Math.tan(.5*l)/m.width,this._geometricToleranceOverMeter=h*e.maximumScreenSpaceError,r.clone(e.backgroundColor,this._backgroundColor),this._minimumDisableDepthTestDistance=e.minimumDisableDepthTestDistance,this._minimumDisableDepthTestDistance*=this._minimumDisableDepthTestDistance,this._minimumDisableDepthTestDistance===Number.POSITIVE_INFINITY&&(this._minimumDisableDepthTestDistance=-1)};var V=new t;function C(e){e._encodedCameraPositionMCDirty&&(e._encodedCameraPositionMCDirty=!1,l.multiplyByPoint(e.inverseModel,e._cameraPosition,V),c.fromCartesian(V,e._encodedCameraPositionMC))}var M=new t,j=new t,T=new t,E=new t,x=new n,R=new t,I=new l;function N(e){e._view3DDirty&&(e._mode===w.SCENE3D?l.clone(e._view,e._view3D):function(e,i,o,n,r,s,_,c){var u=M;u.x=e.y,u.y=e.z,u.z=e.x;var m=j;m.x=o.y,m.y=o.z,m.z=o.x;var v=T;v.x=n.y,v.y=n.z,v.z=n.x;var d=E;d.x=i.y,d.y=i.z,d.z=i.x,s===w.SCENE2D&&(u.z=.5*r);var y=_.unproject(u,x);y.longitude=h.clamp(y.longitude,-Math.PI,Math.PI),y.latitude=h.clamp(y.latitude,-h.PI_OVER_TWO,h.PI_OVER_TWO);var f=_.ellipsoid,p=f.cartographicToCartesian(y,R),g=D.eastNorthUpToFixedFrame(p,f,I);l.multiplyByPointAsVector(g,m,m),l.multiplyByPointAsVector(g,v,v),l.multiplyByPointAsVector(g,d,d),a(c)||(c=new l),c[0]=m.x,c[1]=v.x,c[2]=-d.x,c[3]=0,c[4]=m.y,c[5]=v.y,c[6]=-d.y,c[7]=0,c[8]=m.z,c[9]=v.z,c[10]=-d.z,c[11]=0,c[12]=-t.dot(m,p),c[13]=-t.dot(v,p),c[14]=t.dot(d,p),c[15]=1}(e._cameraPosition,e._cameraDirection,e._cameraRight,e._cameraUp,e._frustum2DWidth,e._mode,e._mapProjection,e._view3D),l.getRotation(e._view3D,e._viewRotation3D),e._view3DDirty=!1)}function F(e){e._inverseView3DDirty&&(l.inverseTransformation(e.view3D,e._inverseView3D),l.getRotation(e._inverseView3D,e._inverseViewRotation3D),e._inverseView3DDirty=!1)}return y});