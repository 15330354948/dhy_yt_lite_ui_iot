define(["../Core/ApproximateTerrainHeights","../Core/Cartesian3","../Core/Cartographic","../Core/Check","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defined","../Core/DeveloperError","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/Ellipsoid","../Core/GeometryInstance","../Core/GeometryOffsetAttribute","../Core/Iso8601","../Core/OffsetGeometryInstanceAttribute","../Core/Rectangle","../Core/RectangleGeometry","../Core/RectangleOutlineGeometry","../Core/ShowGeometryInstanceAttribute","../Scene/GroundPrimitive","../Scene/HeightReference","../Scene/MaterialAppearance","../Scene/PerInstanceColorAppearance","./ColorMaterialProperty","./DynamicGeometryUpdater","./GeometryUpdater","./GroundGeometryUpdater","./Property"],function(e,t,r,i,o,n,a,s,l,d,u,c,h,g,p,f,y,m,C,_,O,V,U,M,v,A,I){"use strict";var E=new o,G=t.ZERO,b=new t,w=new p,D=new p,P=new r;function H(e,t){A.call(this,{entity:e,scene:t,geometryOptions:new function(e){this.id=e,this.vertexFormat=void 0,this.rectangle=void 0,this.height=void 0,this.extrudedHeight=void 0,this.granularity=void 0,this.stRotation=void 0,this.rotation=void 0,this.offsetAttribute=void 0}(e),geometryPropertyName:"rectangle",observedPropertyNames:["availability","rectangle"]}),this._onEntityPropertyChanged(e,"rectangle",e.rectangle,void 0)}function R(e,t,r){M.call(this,e,t,r)}return a(Object.create)&&(H.prototype=Object.create(A.prototype),H.prototype.constructor=H),H.prototype.createFillGeometryInstance=function(e){if(i.defined("time",e),!this._fillEnabled)throw new s("This instance does not represent a filled geometry.");var t,r=this._entity,d=r.isAvailable(e),c={show:new m(d&&r.isShowing&&this._showProperty.getValue(e)&&this._fillProperty.getValue(e)),distanceDisplayCondition:l.fromDistanceDisplayCondition(this._distanceDisplayConditionProperty.getValue(e)),offset:void 0,color:void 0};this._materialProperty instanceof U&&(a(this._materialProperty.color)&&(this._materialProperty.color.isConstant||d)&&(t=this._materialProperty.color.getValue(e,E)),a(t)||(t=o.WHITE),c.color=n.fromColor(t));return a(this._options.offsetAttribute)&&(c.offset=g.fromCartesian3(I.getValueOrDefault(this._terrainOffsetProperty,e,G,b))),new u({id:r,geometry:new f(this._options),attributes:c})},H.prototype.createOutlineGeometryInstance=function(e){if(i.defined("time",e),!this._outlineEnabled)throw new s("This instance does not represent an outlined geometry.");var t=this._entity,r=t.isAvailable(e),d=I.getValueOrDefault(this._outlineColorProperty,e,o.BLACK,E),c=this._distanceDisplayConditionProperty.getValue(e),h={show:new m(r&&t.isShowing&&this._showProperty.getValue(e)&&this._showOutlineProperty.getValue(e)),color:n.fromColor(d),distanceDisplayCondition:l.fromDistanceDisplayCondition(c),offset:void 0};return a(this._options.offsetAttribute)&&(h.offset=g.fromCartesian3(I.getValueOrDefault(this._terrainOffsetProperty,e,G,b))),new u({id:t,geometry:new y(this._options),attributes:h})},H.prototype._computeCenter=function(e,t){var i=I.getValueOrUndefined(this._entity.rectangle.coordinates,e,D);if(a(i)){var o=p.center(i,P);return r.toCartesian(o,d.WGS84,t)}},H.prototype._isHidden=function(e,t){return!a(t.coordinates)||v.prototype._isHidden.call(this,e,t)},H.prototype._isDynamic=function(e,t){return!t.coordinates.isConstant||!I.isConstant(t.height)||!I.isConstant(t.extrudedHeight)||!I.isConstant(t.granularity)||!I.isConstant(t.stRotation)||!I.isConstant(t.rotation)||!I.isConstant(t.outlineWidth)||!I.isConstant(t.zIndex)||this._onTerrain&&!I.isConstant(this._materialProperty)},H.prototype._setStaticOptions=function(t,r){var i=this._materialProperty instanceof U,o=I.getValueOrUndefined(r.height,h.MINIMUM_VALUE),n=I.getValueOrDefault(r.heightReference,h.MINIMUM_VALUE,_.NONE),s=I.getValueOrUndefined(r.extrudedHeight,h.MINIMUM_VALUE),l=I.getValueOrDefault(r.extrudedHeightReference,h.MINIMUM_VALUE,_.NONE);a(s)&&!a(o)&&(o=0);var d=this._options;d.vertexFormat=i?V.VERTEX_FORMAT:O.MaterialSupport.TEXTURED.vertexFormat,d.rectangle=r.coordinates.getValue(h.MINIMUM_VALUE,d.rectangle),d.granularity=I.getValueOrUndefined(r.granularity,h.MINIMUM_VALUE),d.stRotation=I.getValueOrUndefined(r.stRotation,h.MINIMUM_VALUE),d.rotation=I.getValueOrUndefined(r.rotation,h.MINIMUM_VALUE),d.offsetAttribute=A.computeGeometryOffsetAttribute(o,n,s,l),d.height=A.getGeometryHeight(o,n),(s=A.getGeometryExtrudedHeight(s,l))===A.CLAMP_TO_GROUND&&(s=e.getMinimumMaximumHeights(f.computeRectangle(d,w)).minimumTerrainHeight),d.extrudedHeight=s},H.DynamicGeometryUpdater=R,a(Object.create)&&(R.prototype=Object.create(M.prototype),R.prototype.constructor=R),R.prototype._isHidden=function(e,t,r){return!a(this._options.rectangle)||M.prototype._isHidden.call(this,e,t,r)},R.prototype._setOptions=function(t,r,i){var o=this._options,n=I.getValueOrUndefined(r.height,i),s=I.getValueOrDefault(r.heightReference,i,_.NONE),l=I.getValueOrUndefined(r.extrudedHeight,i),d=I.getValueOrDefault(r.extrudedHeightReference,i,_.NONE);a(l)&&!a(n)&&(n=0),o.rectangle=I.getValueOrUndefined(r.coordinates,i,o.rectangle),o.granularity=I.getValueOrUndefined(r.granularity,i),o.stRotation=I.getValueOrUndefined(r.stRotation,i),o.rotation=I.getValueOrUndefined(r.rotation,i),o.offsetAttribute=A.computeGeometryOffsetAttribute(n,s,l,d),o.height=A.getGeometryHeight(n,s),(l=A.getGeometryExtrudedHeight(l,d))===A.CLAMP_TO_GROUND&&(l=e.getMinimumMaximumHeights(f.computeRectangle(o,w)).minimumTerrainHeight),o.extrudedHeight=l},H});