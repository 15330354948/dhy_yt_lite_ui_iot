define(["./BoundingSphere","./Cartesian2","./Cartesian3","./Check","./defaultValue","./defined","./defineProperties","./DeveloperError","./IndexDatatype","./Intersections2D","./Math","./OrientedBoundingBox","./QuantizedMeshTerrainData","./Rectangle","./TaskProcessor","./TerrainEncoding","./TerrainMesh"],function(e,t,i,n,r,o,s,a,h,d,u,c,l,g,m,p,v){"use strict";function f(e){e=r(e,r.EMPTY_OBJECT),n.typeOf.object("options.buffer",e.buffer),n.typeOf.number("options.negativeAltitudeExponentBias",e.negativeAltitudeExponentBias),n.typeOf.number("options.negativeElevationThreshold",e.negativeElevationThreshold),this._buffer=e.buffer,this._credits=e.credits,this._negativeAltitudeExponentBias=e.negativeAltitudeExponentBias,this._negativeElevationThreshold=e.negativeElevationThreshold;var t=r(e.childTileMask,15),i=3&t;i|=4&t?8:0,i|=8&t?4:0,this._childTileMask=i,this._createdByUpsampling=r(e.createdByUpsampling,!1),this._skirtHeight=void 0,this._bufferType=this._buffer.constructor,this._mesh=void 0,this._minimumHeight=void 0,this._maximumHeight=void 0,this._vertexCountWithoutSkirts=void 0,this._skirtIndex=void 0}s(f.prototype,{credits:{get:function(){return this._credits}},waterMask:{get:function(){}}});var y=new m("createVerticesFromGoogleEarthEnterpriseBuffer"),_=new g,E=new g;f.prototype.createMesh=function(t,s,a,h,d){n.typeOf.object("tilingScheme",t),n.typeOf.number("x",s),n.typeOf.number("y",a),n.typeOf.number("level",h);var u=t.ellipsoid;t.tileXYToNativeRectangle(s,a,h,_),t.tileXYToRectangle(s,a,h,E),d=r(d,1);var l=u.cartographicToCartesian(g.center(E)),m=40075.16/(1<<h);this._skirtHeight=Math.min(8*m,1e3),this._skirtHeight=1e-6;var f=y.scheduleTask({buffer:this._buffer,nativeRectangle:_,rectangle:E,relativeToCenter:l,ellipsoid:u,skirtHeight:this._skirtHeight,exaggeration:d,includeWebMercatorT:!0,negativeAltitudeExponentBias:this._negativeAltitudeExponentBias,negativeElevationThreshold:this._negativeElevationThreshold});if(o(f)){var T=this;return f.then(function(t){return T._mesh=new v(l,new Float32Array(t.vertices),new Uint16Array(t.indices),t.minimumHeight,t.maximumHeight,e.clone(t.boundingSphere3D),i.clone(t.occludeePointInScaledSpace),t.numberOfAttributes,c.clone(t.orientedBoundingBox),p.clone(t.encoding),d,t.westIndicesSouthToNorth,t.southIndicesEastToWest,t.eastIndicesNorthToSouth,t.northIndicesWestToEast),T._vertexCountWithoutSkirts=t.vertexCountWithoutSkirts,T._skirtIndex=t.skirtIndex,T._minimumHeight=t.minimumHeight,T._maximumHeight=t.maximumHeight,T._buffer=void 0,T._mesh})}},f.prototype.interpolateHeight=function(e,t,i){var n=u.clamp((t-e.west)/e.width,0,1),r=u.clamp((i-e.south)/e.height,0,1);return o(this._mesh)?function(e,t,i){for(var n=e._mesh,r=n.vertices,o=n.encoding,s=n.indices,a=0,h=s.length;a<h;a+=3){var u=s[a],c=s[a+1],l=s[a+2],g=o.decodeTextureCoordinates(r,u,x),m=o.decodeTextureCoordinates(r,c,b),p=o.decodeTextureCoordinates(r,l,w),v=d.computeBarycentricCoordinates(t,i,g.x,g.y,m.x,m.y,p.x,p.y,H);if(v.x>=-1e-15&&v.y>=-1e-15&&v.z>=-1e-15){var f=o.decodeHeight(r,u),y=o.decodeHeight(r,c),_=o.decodeHeight(r,l);return v.x*f+v.y*y+v.z*_}}return}(this,n,r):function(e,t,i,n){var r=e._buffer,o=0,s=0,a=0;i>.5?(t>.5?(o=2,s=.5):o=3,a=.5):t>.5&&(o=1,s=.5);for(var h=new DataView(r),c=0,l=0;l<o;++l)c+=h.getUint32(c,!0),c+=B;c+=B,c+=2*O;var g=u.toRadians(180*h.getFloat64(c,!0));c+=O;var m=u.toRadians(180*h.getFloat64(c,!0));c+=O;var p=n.width/g/2,v=n.height/m/2,f=h.getInt32(c,!0);c+=S;var y=3*h.getInt32(c,!0);c+=S,c+=S;var _,E=new Array(f),T=new Array(f),x=new Array(f);for(_=0;_<f;++_)E[_]=s+h.getUint8(c++)*p,T[_]=a+h.getUint8(c++)*v,x[_]=6371010*h.getFloat32(c,!0),c+=I;var b=new Array(y);for(_=0;_<y;++_)b[_]=h.getUint16(c,!0),c+=k;for(_=0;_<y;_+=3){var w=b[_],A=b[_+1],C=b[_+2],M=E[w],U=E[A],R=E[C],Y=T[w],P=T[A],z=T[C],N=d.computeBarycentricCoordinates(t,i,M,Y,U,P,R,z,H);if(N.x>=-1e-15&&N.y>=-1e-15&&N.z>=-1e-15)return N.x*x[w]+N.y*x[A]+N.z*x[C]}return}(this,n,r,e)};var T=new m("upsampleQuantizedTerrainMesh");f.prototype.upsample=function(t,r,s,d,u,g,m){if(n.typeOf.object("tilingScheme",t),n.typeOf.number("thisX",r),n.typeOf.number("thisY",s),n.typeOf.number("thisLevel",d),n.typeOf.number("descendantX",u),n.typeOf.number("descendantY",g),n.typeOf.number("descendantLevel",m),m-d>1)throw new a("Upsampling through more than one level at a time is not currently supported.");var p=this._mesh;if(o(this._mesh)){var v=2*r!==u,f=2*s===g,y=t.ellipsoid,_=t.tileXYToRectangle(u,g,m),E=T.scheduleTask({vertices:p.vertices,vertexCountWithoutSkirts:this._vertexCountWithoutSkirts,indices:p.indices,skirtIndex:this._skirtIndex,encoding:p.encoding,minimumHeight:this._minimumHeight,maximumHeight:this._maximumHeight,isEastChild:v,isNorthChild:f,childRectangle:_,ellipsoid:y,exaggeration:p.exaggeration});if(o(E)){var x=this;return E.then(function(t){var n=new Uint16Array(t.vertices),r=h.createTypedArray(n.length/3,t.indices),o=x._skirtHeight;return new l({quantizedVertices:n,indices:r,minimumHeight:t.minimumHeight,maximumHeight:t.maximumHeight,boundingSphere:e.clone(t.boundingSphere),orientedBoundingBox:c.clone(t.orientedBoundingBox),horizonOcclusionPoint:i.clone(t.horizonOcclusionPoint),westIndices:t.westIndices,southIndices:t.southIndices,eastIndices:t.eastIndices,northIndices:t.northIndices,westSkirtHeight:o,southSkirtHeight:o,eastSkirtHeight:o,northSkirtHeight:o,childTileMask:0,createdByUpsampling:!0,credits:x._credits})})}}},f.prototype.isChildAvailable=function(e,t,i,r){n.typeOf.number("thisX",e),n.typeOf.number("thisY",t),n.typeOf.number("childX",i),n.typeOf.number("childY",r);var o=2;return i!==2*e&&++o,r!==2*t&&(o-=2),0!=(this._childTileMask&1<<o)},f.prototype.wasCreatedByUpsampling=function(){return this._createdByUpsampling};var x=new t,b=new t,w=new t,H=new i;var k=Uint16Array.BYTES_PER_ELEMENT,B=Uint32Array.BYTES_PER_ELEMENT,S=Int32Array.BYTES_PER_ELEMENT,I=Float32Array.BYTES_PER_ELEMENT,O=Float64Array.BYTES_PER_ELEMENT;return f});