define(["../../../../Core/defined","../../../../Core/DeveloperError","../../../../Core/EllipsoidGeodesic","../../../../Core/Cartesian2","../../../../Core/getTimestamp","../../../../Core/EventHelper","../../../../ThirdParty/knockout","../Core/loadView"],function(e,i,t,a,n,r,d,s){"use strict";var o=function(t){if(!e(t)||!e(t.terria))throw new i("options.terria is required.");this.terria=t.terria,this._removeSubscription=void 0,this._lastLegendUpdate=void 0,this.eventHelper=new r,this.distanceLabel=void 0,this.barWidth=void 0,this.enableDistanceLegend=!e(t.enableDistanceLegend)||t.enableDistanceLegend,d.track(this,["distanceLabel","barWidth"]),this.eventHelper.add(this.terria.afterWidgetChanged,function(){e(this._removeSubscription)&&(this._removeSubscription(),this._removeSubscription=void 0)},this);var s=this;function o(){if(e(s.terria)){var i=s.terria.scene;s._removeSubscription=i.postRender.addEventListener(function(){!function(i,t){if(!i.enableDistanceLegend)return i.barWidth=void 0,void(i.distanceLabel=void 0);var r=n();if(r<i._lastLegendUpdate+250)return;i._lastLegendUpdate=r;var d=t.canvas.clientWidth,s=t.canvas.clientHeight,o=t.camera.getPickRay(new a(d/2|0,s-1)),v=t.camera.getPickRay(new a(1+d/2|0,s-1)),b=t.globe,h=b.pick(o,t),p=b.pick(v,t);if(!e(h)||!e(p))return i.barWidth=void 0,void(i.distanceLabel=void 0);var f=b.ellipsoid.cartesianToCartographic(h),g=b.ellipsoid.cartesianToCartographic(p);c.setEndPoints(f,g);for(var u,L=c.surfaceDistance,m=l.length-1;!e(u)&&m>=0;--m)l[m]/L<100&&(u=l[m]);if(e(u)){var W;W=u>=1e3?(u/1e3).toString()+" km":u.toString()+" m",i.barWidth=u/L|0,i.distanceLabel=W}else i.barWidth=void 0,i.distanceLabel=void 0}(this,i)},s)}else if(e(s.terria.leaflet)){var t=s.terria.leaflet.map,r=function(){v(s,t)};s._removeSubscription=function(){t.off("zoomend",r),t.off("moveend",r)},t.on("zoomend",r),t.on("moveend",r),v(s,t)}}o(),this.eventHelper.add(this.terria.afterWidgetChanged,function(){o()},this)};o.prototype.destroy=function(){this.eventHelper.removeAll()},o.prototype.show=function(e){var i;i=this.enableDistanceLegend?'<div class="distance-legend" data-bind="visible: distanceLabel && barWidth"><div class="distance-legend-label" data-bind="text: distanceLabel"></div><div class="distance-legend-scale-bar" data-bind="style: { width: barWidth + \'px\', left: (5 + (125 - barWidth) / 2) + \'px\' }"></div></div>':'<div class="distance-legend"  style="display: none;" data-bind="visible: distanceLabel && barWidth"><div class="distance-legend-label"  data-bind="text: distanceLabel"></div><div class="distance-legend-scale-bar"  data-bind="style: { width: barWidth + \'px\', left: (5 + (125 - barWidth) / 2) + \'px\' }"></div></div>',s(i,e,this)},o.create=function(e){var i=new o(e);return i.show(e.container),i};var c=new t,l=[1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7,2e7,3e7,5e7];function v(e,i){var t=i.getSize().y/2;i.containerPointToLatLng([0,t]).distanceTo(i.containerPointToLatLng([100,t]));e.distanceLabel=label}return o});