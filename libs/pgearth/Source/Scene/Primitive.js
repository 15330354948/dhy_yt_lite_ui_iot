define(["../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/clone","../Core/Color","../Core/combine","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/EncodedCartesian3","../Core/FeatureDetection","../Core/Geometry","../Core/GeometryAttribute","../Core/GeometryAttributes","../Core/GeometryOffsetAttribute","../Core/Intersect","../Core/isArray","../Core/Matrix4","../Core/Plane","../Core/RuntimeError","../Core/subdivideArray","../Core/TaskProcessor","../Renderer/BufferUsage","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArray","../ThirdParty/when","./BatchTable","./CullFace","./DepthFunction","./PrimitivePipeline","./PrimitiveState","./SceneMode","./ShadowMode"],function(e,t,n,r,i,a,o,s,c,h,p,d,u,l,_,m,b,f,g,v,y,S,C,T,D,w,I,A,x,z,F,P,O,E,R,k,B,M,L,V,N,G,H){"use strict";function U(e){if(e=h(e,h.EMPTY_OBJECT),this.geometryInstances=e.geometryInstances,this.appearance=e.appearance,this._appearance=void 0,this._material=void 0,this.depthFailAppearance=e.depthFailAppearance,this._depthFailAppearance=void 0,this._depthFailMaterial=void 0,this.modelMatrix=C.clone(h(e.modelMatrix,C.IDENTITY)),this._modelMatrix=new C,this.show=h(e.show,!0),this._vertexCacheOptimize=h(e.vertexCacheOptimize,!1),this._interleave=h(e.interleave,!1),this._releaseGeometryInstances=h(e.releaseGeometryInstances,!0),this._allowPicking=h(e.allowPicking,!0),this._asynchronous=h(e.asynchronous,!0),this._compressVertices=h(e.compressVertices,!0),this.cull=h(e.cull,!0),this.debugShowBoundingVolume=h(e.debugShowBoundingVolume,!1),this.rtcCenter=e.rtcCenter,p(this.rtcCenter)&&(!p(this.geometryInstances)||S(this.geometryInstances)&&1!==this.geometryInstances))throw new l("Relative-to-center rendering only supports one geometry instance.");this.shadows=h(e.shadows,H.DISABLED),this._translucent=void 0,this._state=N.READY,this._geometries=[],this._error=void 0,this._numberOfInstances=0,this._boundingSpheres=[],this._boundingSphereWC=[],this._boundingSphereCV=[],this._boundingSphere2D=[],this._boundingSphereMorph=[],this._perInstanceAttributeCache=[],this._instanceIds=[],this._lastPerInstanceAttributeIndex=0,this._va=[],this._attributeLocations=void 0,this._primitiveType=void 0,this._frontFaceRS=void 0,this._backFaceRS=void 0,this._sp=void 0,this._depthFailAppearance=void 0,this._spDepthFail=void 0,this._frontFaceDepthFailRS=void 0,this._backFaceDepthFailRS=void 0,this._pickIds=[],this._colorCommands=[],this._pickCommands=[],this._readOnlyInstanceAttributes=e._readOnlyInstanceAttributes,this._createBoundingVolumeFunction=e._createBoundingVolumeFunction,this._createRenderStatesFunction=e._createRenderStatesFunction,this._createShaderProgramFunction=e._createShaderProgramFunction,this._createCommandsFunction=e._createCommandsFunction,this._updateAndQueueCommandsFunction=e._updateAndQueueCommandsFunction,this._createPickOffsets=e._createPickOffsets,this._pickOffsets=void 0,this._createGeometryResults=void 0,this._ready=!1,this._readyPromise=k.defer(),this._batchTable=void 0,this._batchTableAttributeIndices=void 0,this._offsetInstanceExtend=void 0,this._batchTableOffsetAttribute2DIndex=void 0,this._batchTableOffsetsUpdated=!1,this._instanceBoundingSpheres=void 0,this._instanceBoundingSpheresCV=void 0,this._tempBoundingSpheres=void 0,this._recomputeBoundingSpheres=!1,this._batchTableBoundingSpheresUpdated=!1,this._batchTableBoundingSphereAttributeIndices=void 0}d(U.prototype,{vertexCacheOptimize:{get:function(){return this._vertexCacheOptimize}},interleave:{get:function(){return this._interleave}},releaseGeometryInstances:{get:function(){return this._releaseGeometryInstances}},allowPicking:{get:function(){return this._allowPicking}},asynchronous:{get:function(){return this._asynchronous}},compressVertices:{get:function(){return this._compressVertices}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}}});var q=new t,j=new n,W=new r;function $(e){var i=e.length;return 1===i?e[0]:2===i?t.unpack(e,0,q):3===i?n.unpack(e,0,j):4===i?r.unpack(e,0,W):void 0}function Y(e,t){var n=e.geometryInstances,r=S(n)?n:[n],i=r.length;if(0!==i){var a,s,d,u,l=function(e){var t,n=e.length,r=[],i=e[0].attributes;for(t in i)if(i.hasOwnProperty(t)&&p(i[t])){for(var a=i[t],o=!0,s=1;s<n;++s){var c=e[s].attributes[t];if(!p(c)||a.componentDatatype!==c.componentDatatype||a.componentsPerAttribute!==c.componentsPerAttribute||a.normalize!==c.normalize){o=!1;break}}o&&r.push(t)}return r}(r),_=l.length,m=[],b={},f={},g=r[0].attributes;for(s=0;s<_;++s)u=g[d=l[s]],b[d]=s,m.push({functionName:"czm_batchTable_"+d,componentDatatype:u.componentDatatype,componentsPerAttribute:u.componentsPerAttribute,normalize:u.normalize});-1!==l.indexOf("distanceDisplayCondition")&&(m.push({functionName:"czm_batchTable_boundingSphereCenter3DHigh",componentDatatype:c.FLOAT,componentsPerAttribute:3},{functionName:"czm_batchTable_boundingSphereCenter3DLow",componentDatatype:c.FLOAT,componentsPerAttribute:3},{functionName:"czm_batchTable_boundingSphereCenter2DHigh",componentDatatype:c.FLOAT,componentsPerAttribute:3},{functionName:"czm_batchTable_boundingSphereCenter2DLow",componentDatatype:c.FLOAT,componentsPerAttribute:3},{functionName:"czm_batchTable_boundingSphereRadius",componentDatatype:c.FLOAT,componentsPerAttribute:1}),f.center3DHigh=m.length-5,f.center3DLow=m.length-4,f.center2DHigh=m.length-3,f.center2DLow=m.length-2,f.radius=m.length-1),-1!==l.indexOf("offset")&&(m.push({functionName:"czm_batchTable_offset2D",componentDatatype:c.FLOAT,componentsPerAttribute:3}),a=m.length-1),m.push({functionName:"czm_batchTable_pickColor",componentDatatype:c.UNSIGNED_BYTE,componentsPerAttribute:4,normalize:!0});var v=m.length,y=new B(t,m,i);for(s=0;s<i;++s){var C=r[s];g=C.attributes;for(var T=0;T<_;++T){var D=$((u=g[d=l[T]]).value),w=b[d];y.setBatchedAttribute(s,w,D)}var I={primitive:h(C.pickPrimitive,e)};p(C.id)&&(I.id=C.id);var A=t.createPickId(I);e._pickIds.push(A);var x=A.color,z=W;z.x=o.floatToByte(x.red),z.y=o.floatToByte(x.green),z.z=o.floatToByte(x.blue),z.w=o.floatToByte(x.alpha),y.setBatchedAttribute(s,v-1,z)}e._batchTable=y,e._batchTableAttributeIndices=b,e._batchTableBoundingSphereAttributeIndices=f,e._batchTableOffsetAttribute2DIndex=a}}function Z(t){var n,r,i,a=t.attributes,o=new g;for(var s in a)a.hasOwnProperty(s)&&p(a[s])&&(o[s]=(n=a[s],r=void 0,r=S(n.values)?n.values.slice(0):new n.values.constructor(n.values),new f({componentDatatype:n.componentDatatype,componentsPerAttribute:n.componentsPerAttribute,normalize:n.normalize,values:r})));if(p(t.indices)){var c=t.indices;i=S(c)?c.slice(0):new c.constructor(c)}return new b({attributes:o,indices:i,primitiveType:t.primitiveType,boundingSphere:e.clone(t.boundingSphere)})}function X(e,t){return{geometry:t,attributes:e.attributes,modelMatrix:C.clone(e.modelMatrix),pickPrimitive:e.pickPrimitive,id:e.id}}var Q=/attribute\s+vec(?:3|4)\s+(.*)3DHigh;/g;function K(e){return E.replaceMain(e,"czm_non_pick_main")+"\nvarying vec4 v_pickColor; \nvoid main() \n{ \n    czm_non_pick_main(); \n    v_pickColor = czm_batchTable_pickColor(batchId); \n}"}function J(e){return"varying vec4 v_pickColor;\n"+e}function ee(e,t){if(!e.compressVertices)return t;var n=-1!==t.search(/attribute\s+vec3\s+normal;/g),r=-1!==t.search(/attribute\s+vec2\s+st;/g);if(!n&&!r)return t;var i=-1!==t.search(/attribute\s+vec3\s+tangent;/g),a=-1!==t.search(/attribute\s+vec3\s+bitangent;/g),o=r&&n?2:1,s="compressedAttributes",c="attribute "+((o+=i||a?1:0)>1?"vec"+o:"float")+" "+s+";",h="",p="";r&&(h+="vec2 st;\n",p+="    st = czm_decompressTextureCoordinates("+(o>1?s+".x":s)+");\n");n&&i&&a?(h+="vec3 normal;\nvec3 tangent;\nvec3 bitangent;\n",p+="    czm_octDecode("+s+"."+(r?"yz":"xy")+", normal, tangent, bitangent);\n"):(n&&(h+="vec3 normal;\n",p+="    normal = czm_octDecode("+s+(o>1?"."+(r?"y":"x"):"")+");\n"),i&&(h+="vec3 tangent;\n",p+="    tangent = czm_octDecode("+s+"."+(r&&n?"z":"y")+");\n"),a&&(h+="vec3 bitangent;\n",p+="    bitangent = czm_octDecode("+s+"."+(r&&n?"z":"y")+");\n"));var d=t;return d=(d=(d=(d=d.replace(/attribute\s+vec3\s+normal;/g,"")).replace(/attribute\s+vec2\s+st;/g,"")).replace(/attribute\s+vec3\s+tangent;/g,"")).replace(/attribute\s+vec3\s+bitangent;/g,""),[c,h,d=E.replaceMain(d,"czm_non_compressed_main"),"void main() \n{ \n"+p+"    czm_non_compressed_main(); \n}"].join("\n")}function te(e,t){var n=e.vertexAttributes;for(var r in n)if(n.hasOwnProperty(r)&&!p(t[r]))throw new l("Appearance/Geometry mismatch.  The appearance requires vertex shader attribute input '"+r+"', which was not computed as part of the Geometry.  Use the appearance's vertexFormat property when constructing the geometry.")}function ne(e,t){return function(){return e[t]}}U._modifyShaderPosition=function(e,t,n){for(var r,i="",a="",o="";null!==(r=Q.exec(t));){var s=r[1],c="vec4 czm_compute"+s[0].toUpperCase()+s.substr(1)+"()";"vec4 czm_computePosition()"!==c&&(i+=c+";\n"),p(e.rtcCenter)?(i+="uniform mat4 u_modifiedModelView;\n",a+="attribute vec4 position;\n",o+=c+"\n{\n    return u_modifiedModelView * position;\n}\n\n",t=(t=(t=(t=t.replace(/attribute\s+vec(?:3|4)\s+position3DHigh;/g,"")).replace(/attribute\s+vec(?:3|4)\s+position3DLow;/g,"")).replace(/czm_modelViewRelativeToEye\s+\*\s+/g,"")).replace(/czm_modelViewProjectionRelativeToEye/g,"czm_projection")):n?o+=c+"\n{\n    return czm_translateRelativeToEye("+s+"3DHigh, "+s+"3DLow);\n}\n\n":(a+="attribute vec3 "+s+"2DHigh;\nattribute vec3 "+s+"2DLow;\n",o+=c+"\n{\n    vec4 p;\n    if (czm_morphTime == 1.0)\n    {\n        p = czm_translateRelativeToEye("+s+"3DHigh, "+s+"3DLow);\n    }\n    else if (czm_morphTime == 0.0)\n    {\n        p = czm_translateRelativeToEye("+s+"2DHigh.zxy, "+s+"2DLow.zxy);\n    }\n    else\n    {\n        p = czm_columbusViewMorph(\n                czm_translateRelativeToEye("+s+"2DHigh.zxy, "+s+"2DLow.zxy),\n                czm_translateRelativeToEye("+s+"3DHigh, "+s+"3DLow),\n                czm_morphTime);\n    }\n    return p;\n}\n\n")}return[i,a,t,o].join("\n")},U._appendShowToShader=function(e,t){if(!p(e._batchTableAttributeIndices.show))return t;return E.replaceMain(t,"czm_non_show_main")+"\nvoid main() \n{ \n    czm_non_show_main(); \n    gl_Position *= czm_batchTable_show(batchId); \n}"},U._updateColorAttribute=function(e,t,n){if(!p(e._batchTableAttributeIndices.color)&&!p(e._batchTableAttributeIndices.depthFailColor))return t;if(-1===t.search(/attribute\s+vec4\s+color;/g))return t;if(n&&!p(e._batchTableAttributeIndices.depthFailColor))throw new l("A depthFailColor per-instance attribute is required when using a depth fail appearance that uses a color attribute.");var r=t;return r=r.replace(/attribute\s+vec4\s+color;/g,""),r=n?r.replace(/(\b)color(\b)/g,"$1czm_batchTable_depthFailColor(batchId)$2"):r.replace(/(\b)color(\b)/g,"$1czm_batchTable_color(batchId)$2")},U._updatePickColorAttribute=function(e){var t=e.replace(/attribute\s+vec4\s+pickColor;/g,"");return t=t.replace(/(\b)pickColor(\b)/g,"$1czm_batchTable_pickColor(batchId)$2")},U._appendOffsetToShader=function(e,t){if(!p(e._batchTableAttributeIndices.offset))return t;var n="attribute float batchId;\n";n+="attribute float applyOffset;";var r=t.replace(/attribute\s+float\s+batchId;/g,n),i="vec4 $1 = czm_computePosition();\n";return i+="    if (czm_sceneMode == czm_sceneMode3D)\n",i+="    {\n",i+="        $1 = $1 + vec4(czm_batchTable_offset(batchId) * applyOffset, 0.0);",i+="    }\n",i+="    else\n",i+="    {\n",i+="        $1 = $1 + vec4(czm_batchTable_offset2D(batchId) * applyOffset, 0.0);",i+="    }\n",r=r.replace(/vec4\s+([A-Za-z0-9_]+)\s+=\s+czm_computePosition\(\);/g,i)},U._appendDistanceDisplayConditionToShader=function(e,t,n){if(!p(e._batchTableAttributeIndices.distanceDisplayCondition))return t;var r=E.replaceMain(t,"czm_non_distanceDisplayCondition_main"),i="void main() \n{ \n    czm_non_distanceDisplayCondition_main(); \n    vec2 distanceDisplayCondition = czm_batchTable_distanceDisplayCondition(batchId);\n    vec3 boundingSphereCenter3DHigh = czm_batchTable_boundingSphereCenter3DHigh(batchId);\n    vec3 boundingSphereCenter3DLow = czm_batchTable_boundingSphereCenter3DLow(batchId);\n    float boundingSphereRadius = czm_batchTable_boundingSphereRadius(batchId);\n";return i+=n?"    vec4 centerRTE = czm_translateRelativeToEye(boundingSphereCenter3DHigh, boundingSphereCenter3DLow);\n":"    vec3 boundingSphereCenter2DHigh = czm_batchTable_boundingSphereCenter2DHigh(batchId);\n    vec3 boundingSphereCenter2DLow = czm_batchTable_boundingSphereCenter2DLow(batchId);\n    vec4 centerRTE;\n    if (czm_morphTime == 1.0)\n    {\n        centerRTE = czm_translateRelativeToEye(boundingSphereCenter3DHigh, boundingSphereCenter3DLow);\n    }\n    else if (czm_morphTime == 0.0)\n    {\n        centerRTE = czm_translateRelativeToEye(boundingSphereCenter2DHigh.zxy, boundingSphereCenter2DLow.zxy);\n    }\n    else\n    {\n        centerRTE = czm_columbusViewMorph(\n                czm_translateRelativeToEye(boundingSphereCenter2DHigh.zxy, boundingSphereCenter2DLow.zxy),\n                czm_translateRelativeToEye(boundingSphereCenter3DHigh, boundingSphereCenter3DLow),\n                czm_morphTime);\n    }\n",r+"\n"+(i+="    float radiusSq = boundingSphereRadius * boundingSphereRadius; \n    float distanceSq; \n    if (czm_sceneMode == czm_sceneMode2D) \n    { \n        distanceSq = czm_eyeHeight2D.y - radiusSq; \n    } \n    else \n    { \n        distanceSq = dot(centerRTE.xyz, centerRTE.xyz) - radiusSq; \n    } \n    distanceSq = max(distanceSq, 0.0); \n    float nearSq = distanceDisplayCondition.x * distanceDisplayCondition.x; \n    float farSq = distanceDisplayCondition.y * distanceDisplayCondition.y; \n    float show = (distanceSq >= nearSq && distanceSq <= farSq) ? 1.0 : 0.0; \n    gl_Position *= show; \n}")};var re,ie=Math.max(m.hardwareConcurrency-1,1),ae=new I("combineGeometry",Number.POSITIVE_INFINITY);var oe=new _,se=new i,ce=new n,he=new e;var pe=new n,de=new n;function ue(t,r){if(p(t._batchTableAttributeIndices.offset)&&!t._batchTableOffsetsUpdated&&!r.scene3DOnly){for(var i=t._batchTableOffsetAttribute2DIndex,a=r.mapProjection,o=a.ellipsoid,s=t._batchTable,c=t._instanceBoundingSpheres,h=c.length,d=0;d<h;++d){var u=c[d];if(p(u)){var l=s.getBatchedAttribute(d,t._batchTableAttributeIndices.offset);if(n.equals(l,n.ZERO))s.setBatchedAttribute(d,i,n.ZERO);else{var _=t.modelMatrix;p(_)&&(u=e.transform(u,_,he));var m=u.center;m=o.scaleToGeodeticSurface(m,de);var b=o.cartesianToCartographic(m,se),f=a.project(b,ce),g=n.add(l,m,pe);b=o.cartesianToCartographic(g,b);var v=a.project(b,pe),y=n.subtract(v,f,pe),S=y.x;y.x=y.z,y.z=y.y,y.y=S,s.setBatchedAttribute(d,i,y)}}}t._batchTableOffsetsUpdated=!0}}function le(e,t,n,r){var i,o=n.getRenderState();r?((i=a(o,!1)).cull={enabled:!0,face:M.BACK},e._frontFaceRS=P.fromCache(i),i.cull.face=M.FRONT,e._backFaceRS=P.fromCache(i)):(e._frontFaceRS=P.fromCache(o),e._backFaceRS=e._frontFaceRS),i=a(o,!1),p(e._depthFailAppearance)&&(i.depthTest.enabled=!1),p(e._depthFailAppearance)&&(o=e._depthFailAppearance.getRenderState(),(i=a(o,!1)).depthTest.func=L.GREATER,r?(i.cull={enabled:!0,face:M.BACK},e._frontFaceDepthFailRS=P.fromCache(i),i.cull.face=M.FRONT,e._backFaceDepthFailRS=P.fromCache(i)):(e._frontFaceDepthFailRS=P.fromCache(i),e._backFaceDepthFailRS=e._frontFaceRS))}function _e(e,t,n){var r=t.context,i=e._attributeLocations,a=e._batchTable.getVertexShaderCallback()(n.vertexShaderSource);a=U._appendOffsetToShader(e,a),a=U._appendShowToShader(e,a),a=K(a=U._appendDistanceDisplayConditionToShader(e,a,t.scene3DOnly)),a=ee(e,a=U._updateColorAttribute(e,a,!1)),a=U._modifyShaderPosition(e,a,t.scene3DOnly);var o,s,c,h,d=n.getFragmentShaderSource();d=J(d),e._sp=O.replaceCache({context:r,shaderProgram:e._sp,vertexShaderSource:a,fragmentShaderSource:d,attributeLocations:i}),te(e._sp,i),p(e._depthFailAppearance)&&(a=e._batchTable.getVertexShaderCallback()(e._depthFailAppearance.vertexShaderSource),a=U._appendShowToShader(e,a),a=K(a=U._appendDistanceDisplayConditionToShader(e,a,t.scene3DOnly)),a=ee(e,a=U._updateColorAttribute(e,a,!0)),a=U._modifyShaderPosition(e,a,t.scene3DOnly),c=a,h=E.replaceMain(c,"czm_non_depth_clamp_main"),a=h+="varying float v_WindowZ;\nvoid main() {\n    czm_non_depth_clamp_main();\n    vec4 position = gl_Position;\n    v_WindowZ = (0.5 * (position.z / position.w) + 0.5) * position.w;\n    position.z = min(position.z, position.w);\n    gl_Position = position;\n}\n",d=J(d=e._depthFailAppearance.getFragmentShaderSource()),o=d,s=E.replaceMain(o,"czm_non_depth_clamp_main"),d=s="#ifdef GL_EXT_frag_depth\n#extension GL_EXT_frag_depth : enable\n#endif\n"+(s+="varying float v_WindowZ;\nvoid main() {\n    czm_non_depth_clamp_main();\n#if defined(GL_EXT_frag_depth) && !defined(LOG_DEPTH)\n    gl_FragDepthEXT = min(v_WindowZ * gl_FragCoord.w, 1.0);\n#endif\n}\n"),e._spDepthFail=O.replaceCache({context:r,shaderProgram:e._spDepthFail,vertexShaderSource:a,fragmentShaderSource:d,attributeLocations:i}),te(e._spDepthFail,i))}var me=new C,be=new n;function fe(e,t,n,r){var i=p(n)?n._uniforms:void 0,a={},o=t.uniforms;if(p(o))for(var c in o)if(o.hasOwnProperty(c)){if(p(i)&&p(i[c]))throw new l("Appearance and material have a uniform with the same name: "+c);a[c]=ne(o,c)}var h=s(a,i);return h=e._batchTable.getUniformMapCallback()(h),p(e.rtcCenter)&&(h.u_modifiedModelView=function(){var t=r.context.uniformState.view;return C.multiply(t,e._modelMatrix,me),C.multiplyByPoint(me,e.rtcCenter,be),C.setTranslation(me,be,me),me}),h}function ge(e,t,n,r,i,a,o,s){var c,h=fe(e,t,n,s);p(e._depthFailAppearance)&&(c=fe(e,e._depthFailAppearance,e._depthFailAppearance.material,s));var d=r?F.TRANSLUCENT:F.OPAQUE,u=i?2:1;u*=p(e._depthFailAppearance)?2:1,a.length=e._va.length*u;for(var l=a.length,_=0,m=0;m<l;++m){var b;i&&(b=a[m],p(b)||(b=a[m]=new z({owner:e,primitiveType:e._primitiveType})),b.vertexArray=e._va[_],b.renderState=e._backFaceRS,b.shaderProgram=e._sp,b.uniformMap=h,b.pass=d,++m),b=a[m],p(b)||(b=a[m]=new z({owner:e,primitiveType:e._primitiveType})),b.vertexArray=e._va[_],b.renderState=e._frontFaceRS,b.shaderProgram=e._sp,b.uniformMap=h,b.pass=d,p(e._depthFailAppearance)&&(i&&(b=a[++m],p(b)||(b=a[m]=new z({owner:e,primitiveType:e._primitiveType})),b.vertexArray=e._va[_],b.renderState=e._backFaceDepthFailRS,b.shaderProgram=e._spDepthFail,b.uniformMap=c,b.pass=d),b=a[++m],p(b)||(b=a[m]=new z({owner:e,primitiveType:e._primitiveType})),b.vertexArray=e._va[_],b.renderState=e._frontFaceDepthFailRS,b.shaderProgram=e._spDepthFail,b.uniformMap=c,b.pass=d),++_}}function ve(e,t,n,r,i,a,o,s){if(t.mode!==G.SCENE3D&&!C.equals(i,C.IDENTITY))throw new l("Primitive.modelMatrix is only supported in 3D mode.");var c;U._updateBoundingVolumes(e,t,i),t.mode===G.SCENE3D?c=e._boundingSphereWC:t.mode===G.COLUMBUS_VIEW?c=e._boundingSphereCV:t.mode===G.SCENE2D&&p(e._boundingSphere2D)?c=e._boundingSphere2D:p(e._boundingSphereMorph)&&(c=e._boundingSphereMorph);var h=t.commandList,d=t.passes;if(d.render||d.pick){var u=e.allowPicking,_=H.castShadows(e.shadows),m=H.receiveShadows(e.shadows),b=n.length,f=s?2:1;f*=p(e._depthFailAppearance)?2:1;for(var g=0;g<b;++g){var v=Math.floor(g/f),y=n[g];y.modelMatrix=i,y.boundingVolume=c[v],y.cull=a,y.debugShowBoundingVolume=o,y.castShadows=_,y.receiveShadows=m,y.pickId=u?"v_pickColor":void 0,h.push(y)}}}U._updateBoundingVolumes=function(t,n,r,i){var a,o,s;if(i||!C.equals(r,t._modelMatrix))for(C.clone(r,t._modelMatrix),o=t._boundingSpheres.length,a=0;a<o;++a)s=t._boundingSpheres[a],p(s)&&(t._boundingSphereWC[a]=e.transform(s,r,t._boundingSphereWC[a]),n.scene3DOnly||(t._boundingSphere2D[a]=e.clone(t._boundingSphereCV[a],t._boundingSphere2D[a]),t._boundingSphere2D[a].center.x=0,t._boundingSphereMorph[a]=e.union(t._boundingSphereWC[a],t._boundingSphereCV[a])));var c=t.appearance.pixelSize;if(p(c))for(o=t._boundingSpheres.length,a=0;a<o;++a){s=t._boundingSpheres[a];var h=t._boundingSphereWC[a],d=n.camera.getPixelSize(s,n.context.drawingBufferWidth,n.context.drawingBufferHeight)*c;h.radius=s.radius+d}},U.prototype.update=function(t){if(!(!p(this.geometryInstances)&&0===this._va.length||p(this.geometryInstances)&&S(this.geometryInstances)&&0===this.geometryInstances.length||!p(this.appearance)||t.mode!==G.SCENE3D&&t.scene3DOnly||!t.passes.render&&!t.passes.pick)){if(p(this._error))throw this._error;if(p(this.rtcCenter)&&!t.scene3DOnly)throw new l("RTC rendering is only available for 3D only scenes.");if(this._state!==N.FAILED){var r=t.context;if(p(this._batchTable)||Y(this,r),this._batchTable.attributes.length>0){if(0===x.maximumVertexTextureImageUnits)throw new D("Vertex texture fetch support is required to render primitives with per-instance attributes. The maximum number of vertex texture image units must be greater than zero.");this._batchTable.update(t)}if(this._state!==N.COMPLETE&&this._state!==N.COMBINED&&(this.asynchronous?function(e,t){var n,r,i,a,o=e._instanceIds;if(e._state===N.READY){n=S(e.geometryInstances)?e.geometryInstances:[e.geometryInstances];var s,c=e._numberOfInstances=n.length,d=[],u=[];for(i=0;i<c;++i){if(r=n[i].geometry,o.push(n[i].id),!p(r._workerName))throw new l("_workerName must be defined for asynchronous geometry.");u.push({moduleName:r._workerName,geometry:r})}if(!p(re))for(re=new Array(ie),i=0;i<ie;i++)re[i]=new I("createGeometry",Number.POSITIVE_INFINITY);for(u=w(u,ie),i=0;i<u.length;i++){var _,m=0,b=u[i],f=b.length;for(a=0;a<f;++a)r=(s=b[a]).geometry,p(r.constructor.pack)&&(s.offset=m,m+=h(r.constructor.packedLength,r.packedLength));if(m>0){var g=new Float64Array(m);for(_=[g.buffer],a=0;a<f;++a)r=(s=b[a]).geometry,p(r.constructor.pack)&&(r.constructor.pack(r,g,s.offset),s.geometry=g)}d.push(re[i].scheduleTask({subTasks:u[i]},_))}e._state=N.CREATING,k.all(d,function(t){e._createGeometryResults=t,e._state=N.CREATED}).otherwise(function(n){Ie(e,t,N.FAILED,n)})}else if(e._state===N.CREATED){var v=[];n=S(e.geometryInstances)?e.geometryInstances:[e.geometryInstances];var y=t.scene3DOnly,T=t.mapProjection,D=ae.scheduleTask(V.packCombineGeometryParameters({createGeometryResults:e._createGeometryResults,instances:n,ellipsoid:T.ellipsoid,projection:T,elementIndexUintSupported:t.context.elementIndexUint,scene3DOnly:y,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e._createPickOffsets},v),v);e._createGeometryResults=void 0,e._state=N.COMBINING,k(D,function(n){var r=V.unpackCombineGeometryResults(n);e._geometries=r.geometries,e._attributeLocations=r.attributeLocations,e.modelMatrix=C.clone(r.modelMatrix,e.modelMatrix),e._pickOffsets=r.pickOffsets,e._offsetInstanceExtend=r.offsetInstanceExtend,e._instanceBoundingSpheres=r.boundingSpheres,e._instanceBoundingSpheresCV=r.boundingSpheresCV,p(e._geometries)&&e._geometries.length>0?(e._recomputeBoundingSpheres=!0,e._state=N.COMBINED):Ie(e,t,N.FAILED,void 0)}).otherwise(function(n){Ie(e,t,N.FAILED,n)})}}(this,t):function(e,t){var n,r,i=S(e.geometryInstances)?e.geometryInstances:[e.geometryInstances],a=e._numberOfInstances=i.length,o=new Array(a),s=e._instanceIds,c=0;for(r=0;r<a;r++){var h,d=(n=i[r]).geometry;h=p(d.attributes)&&p(d.primitiveType)?Z(d):d.constructor.createGeometry(d),o[c++]=X(n,h),s.push(n.id)}o.length=c;var u=t.scene3DOnly,l=t.mapProjection,_=V.combineGeometry({instances:o,ellipsoid:l.ellipsoid,projection:l,elementIndexUintSupported:t.context.elementIndexUint,scene3DOnly:u,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e._createPickOffsets});e._geometries=_.geometries,e._attributeLocations=_.attributeLocations,e.modelMatrix=C.clone(_.modelMatrix,e.modelMatrix),e._pickOffsets=_.pickOffsets,e._offsetInstanceExtend=_.offsetInstanceExtend,e._instanceBoundingSpheres=_.boundingSpheres,e._instanceBoundingSpheresCV=_.boundingSpheresCV,p(e._geometries)&&e._geometries.length>0?(e._recomputeBoundingSpheres=!0,e._state=N.COMBINED):Ie(e,t,N.FAILED,void 0)}(this,t)),this._state===N.COMBINED&&(function(t,n){if(p(t._batchTableAttributeIndices.distanceDisplayCondition)&&!t._batchTableBoundingSpheresUpdated){for(var r=t._batchTableBoundingSphereAttributeIndices,i=r.center3DHigh,a=r.center3DLow,o=r.center2DHigh,s=r.center2DLow,c=r.radius,h=n.mapProjection,d=h.ellipsoid,u=t._batchTable,l=t._instanceBoundingSpheres,m=l.length,b=0;b<m;++b){var f=l[b];if(p(f)){var g=t.modelMatrix;p(g)&&(f=e.transform(f,g,he));var v=f.center,y=f.radius,S=_.fromCartesian(v,oe);if(u.setBatchedAttribute(b,i,S.high),u.setBatchedAttribute(b,a,S.low),!n.scene3DOnly){var C=d.cartesianToCartographic(v,se),T=h.project(C,ce);S=_.fromCartesian(T,oe),u.setBatchedAttribute(b,o,S.high),u.setBatchedAttribute(b,s,S.low)}u.setBatchedAttribute(b,c,y)}}t._batchTableBoundingSpheresUpdated=!0}}(this,t),ue(this,t),function(t,n){for(var r=t._attributeLocations,i=t._geometries,a=n.scene3DOnly,o=n.context,s=[],c=i.length,h=0;h<c;++h){var d=i[h];if(s.push(R.fromGeometry({context:o,geometry:d,attributeLocations:r,bufferUsage:A.STATIC_DRAW,interleave:t._interleave})),p(t._createBoundingVolumeFunction))t._createBoundingVolumeFunction(n,d);else if(t._boundingSpheres.push(e.clone(d.boundingSphere)),t._boundingSphereWC.push(new e),!a){var u=d.boundingSphereCV.center,l=u.x,_=u.y,m=u.z;u.x=m,u.y=l,u.z=_,t._boundingSphereCV.push(e.clone(d.boundingSphereCV)),t._boundingSphere2D.push(new e),t._boundingSphereMorph.push(new e)}}t._va=s,t._primitiveType=i[0].primitiveType,t.releaseGeometryInstances&&(t.geometryInstances=void 0),t._geometries=void 0,Ie(t,n,N.COMPLETE,void 0)}(this,t)),this.show&&this._state===N.COMPLETE){this._batchTableOffsetsUpdated||ue(this,t),this._recomputeBoundingSpheres&&function(t,r){var i=t._batchTableAttributeIndices.offset;if(t._recomputeBoundingSpheres&&p(i)){var a,o=t._offsetInstanceExtend,s=t._instanceBoundingSpheres,c=s.length,h=t._tempBoundingSpheres;if(!p(h)){for(h=new Array(c),a=0;a<c;a++)h[a]=new e;t._tempBoundingSpheres=h}for(a=0;a<c;++a){var d=h[a],u=t._batchTable.getBatchedAttribute(a,i,new n);Ce(d=s[a].clone(d),u,o[a])}var l=[],_=[],m=[];for(a=0;a<c;++a){var b=h[a];b.center.x-b.radius>0||e.intersectPlane(b,T.ORIGIN_ZX_PLANE)!==y.INTERSECTING?l.push(b):(_.push(b),m.push(b))}var f=l[0],g=m[0],v=_[0];for(a=1;a<l.length;a++)f=e.union(f,l[a]);for(a=1;a<m.length;a++)g=e.union(g,m[a]);for(a=1;a<_.length;a++)v=e.union(v,_[a]);var S=[];for(p(f)&&S.push(f),p(g)&&S.push(g),p(v)&&S.push(v),a=0;a<S.length;a++){var C=S[a].clone(t._boundingSpheres[a]);t._boundingSpheres[a]=C,t._boundingSphereCV[a]=e.projectTo2D(C,r.mapProjection,t._boundingSphereCV[a])}U._updateBoundingVolumes(t,r,t.modelMatrix,!0),t._recomputeBoundingSpheres=!1}else t._recomputeBoundingSpheres=!1}(this,t);var i=this.appearance,a=i.material,o=!1,s=!1;this._appearance!==i?(this._appearance=i,this._material=a,o=!0,s=!0):this._material!==a&&(this._material=a,s=!0);var c=this.depthFailAppearance,d=p(c)?c.material:void 0;this._depthFailAppearance!==c?(this._depthFailAppearance=c,this._depthFailMaterial=d,o=!0,s=!0):this._depthFailMaterial!==d&&(this._depthFailMaterial=d,s=!0);var u=this._appearance.isTranslucent();this._translucent!==u&&(this._translucent=u,o=!0),p(this._material)&&this._material.update(r);var m=i.closed&&u;if(o)h(this._createRenderStatesFunction,le)(this,r,i,m);if(s)h(this._createShaderProgramFunction,_e)(this,t,i);if(o||s)h(this._createCommandsFunction,ge)(this,i,a,u,m,this._colorCommands,this._pickCommands,t);h(this._updateAndQueueCommandsFunction,ve)(this,t,this._colorCommands,this._pickCommands,this.modelMatrix,this.cull,this.debugShowBoundingVolume,m)}}}};var ye=new e,Se=new e;function Ce(t,r,i){if(i===v.TOP){var a=e.clone(t,ye),o=e.clone(t,Se);o.center=n.add(o.center,r,o.center),t=e.union(a,o,t)}else i===v.ALL&&(t.center=n.add(t.center,r,t.center));return t}function Te(e,t,n){return function(){var r=e.getBatchedAttribute(t,n),i=e.attributes[n],a=i.componentsPerAttribute,o=c.createTypedArray(i.componentDatatype,a);return p(r.constructor.pack)?r.constructor.pack(r,o,0):o[0]=r,o}}function De(e,t,n,r,i){return function(a){if(!p(a)||!p(a.length)||a.length<1||a.length>4)throw new l("value must be and array with length between 1 and 4.");var o=$(a);e.setBatchedAttribute(t,n,o),"offset"===i&&(r._recomputeBoundingSpheres=!0,r._batchTableOffsetsUpdated=!1)}}var we=new n;function Ie(e,t,n,r){e._error=r,e._state=n,t.afterRender.push(function(){e._ready=e._state===N.COMPLETE||e._state===N.FAILED,p(r)?e._readyPromise.reject(r):e._readyPromise.resolve(e)})}return U.prototype.getGeometryInstanceAttributes=function(t){if(!p(t))throw new l("id is required");if(!p(this._batchTable))throw new l("must call update before calling getGeometryInstanceAttributes");for(var r=-1,i=this._lastPerInstanceAttributeIndex,a=this._instanceIds,o=a.length,s=0;s<o;++s){var c=(i+s)%o;if(t===a[c]){r=c;break}}if(-1!==r){var h=this._perInstanceAttributeCache[r];if(p(h))return h;var u=this._batchTable,_=this._batchTableAttributeIndices;h={};var m={};for(var b in _)if(_.hasOwnProperty(b)){var f=_[b];m[b]={get:Te(u,r,f)};var g=!0,v=this._readOnlyInstanceAttributes;if(g&&p(v)){o=v.length;for(var y=0;y<o;++y)if(b===v[y]){g=!1;break}}g&&(m[b].set=De(u,r,f,this,b))}return function(t,r,i){r.boundingSphere={get:function(){var a=t._instanceBoundingSpheres[i];if(p(a)){a=a.clone();var o=t.modelMatrix,s=r.offset;p(s)&&Ce(a,n.fromArray(s.get(),0,we),t._offsetInstanceExtend[i]),p(o)&&(a=e.transform(a,o))}return a}},r.boundingSphereCV={get:function(){return t._instanceBoundingSpheresCV[i]}}}(this,m,r),function(e,t,n){t.pickId={get:function(){return e._pickIds[n]}}}(this,m,r),d(h,m),this._lastPerInstanceAttributeIndex=r,this._perInstanceAttributeCache[r]=h,h}},U.prototype.isDestroyed=function(){return!1},U.prototype.destroy=function(){var e,t;this._sp=this._sp&&this._sp.destroy(),this._pickSP=this._pickSP&&this._pickSP.destroy();var n=this._va;for(e=n.length,t=0;t<e;++t)n[t].destroy();this._va=void 0;var r=this._pickIds;for(e=r.length,t=0;t<e;++t)r[t].destroy();return this._pickIds=void 0,this._batchTable=this._batchTable&&this._batchTable.destroy(),this._instanceIds=void 0,this._perInstanceAttributeCache=void 0,this._attributeLocations=void 0,u(this)},U});