define(["./Cartesian3","./Math","./Matrix3","./Quaternion"],function(r,a,e,t){"use strict";var i={},n=new r,o=new r,l=new t,y=new e;function s(a,i,s,c,u,x,z,h,m,f){var _=a+i;r.multiplyByScalar(c,Math.cos(_),n),r.multiplyByScalar(s,Math.sin(_),o),r.add(n,o,n);var v=Math.cos(a);v*=v;var O=Math.sin(a);O*=O;var d=x/Math.sqrt(z*v+u*O)/h;return t.fromAxisAngle(n,d,l),e.fromQuaternion(l,y),e.multiplyByVector(y,m,f),r.normalize(f,f),r.multiplyByScalar(f,h,f),f}var c=new r,u=new r,x=new r,z=new r;i.raisePositionsToHeight=function(a,e,t){for(var i=e.ellipsoid,n=e.height,o=e.extrudedHeight,l=t?a.length/3*2:a.length/3,y=new Float64Array(3*l),s=a.length,h=t?s:0,m=0;m<s;m+=3){var f=m+1,_=m+2,v=r.fromArray(a,m,c);i.scaleToGeodeticSurface(v,v);var O=r.clone(v,u),d=i.geodeticSurfaceNormal(v,z),w=r.multiplyByScalar(d,n,x);r.add(v,w,v),t&&(r.multiplyByScalar(d,o,w),r.add(O,w,O),y[m+h]=O.x,y[f+h]=O.y,y[_+h]=O.z),y[m]=v.x,y[f]=v.y,y[_]=v.z}return y};var h=new r,m=new r,f=new r;return i.computeEllipsePositions=function(e,t,i){var n=e.semiMinorAxis,o=e.semiMajorAxis,l=e.rotation,y=e.center,z=8*e.granularity,_=n*n,v=o*o,O=o*n,d=r.magnitude(y),w=r.normalize(y,h),M=r.cross(r.UNIT_Z,y,m);M=r.normalize(M,M);var P=r.cross(w,M,f),p=1+Math.ceil(a.PI_OVER_TWO/z),I=a.PI_OVER_TWO/(p-1),T=a.PI_OVER_TWO-p*I;T<0&&(p-=Math.ceil(Math.abs(T)/I));var g,E,V,A,R,W=t?new Array(3*(p*(p+2)*2)):void 0,S=0,B=c,H=u,N=4*p*3,Q=N-1,b=0,j=i?new Array(N):void 0;for(B=s(T=a.PI_OVER_TWO,l,P,M,_,O,v,d,w,B),t&&(W[S++]=B.x,W[S++]=B.y,W[S++]=B.z),i&&(j[Q--]=B.z,j[Q--]=B.y,j[Q--]=B.x),T=a.PI_OVER_TWO-I,g=1;g<p+1;++g){if(B=s(T,l,P,M,_,O,v,d,w,B),H=s(Math.PI-T,l,P,M,_,O,v,d,w,H),t){for(W[S++]=B.x,W[S++]=B.y,W[S++]=B.z,V=2*g+2,E=1;E<V-1;++E)A=E/(V-1),R=r.lerp(B,H,A,x),W[S++]=R.x,W[S++]=R.y,W[S++]=R.z;W[S++]=H.x,W[S++]=H.y,W[S++]=H.z}i&&(j[Q--]=B.z,j[Q--]=B.y,j[Q--]=B.x,j[b++]=H.x,j[b++]=H.y,j[b++]=H.z),T=a.PI_OVER_TWO-(g+1)*I}for(g=p;g>1;--g){if(B=s(-(T=a.PI_OVER_TWO-(g-1)*I),l,P,M,_,O,v,d,w,B),H=s(T+Math.PI,l,P,M,_,O,v,d,w,H),t){for(W[S++]=B.x,W[S++]=B.y,W[S++]=B.z,V=2*(g-1)+2,E=1;E<V-1;++E)A=E/(V-1),R=r.lerp(B,H,A,x),W[S++]=R.x,W[S++]=R.y,W[S++]=R.z;W[S++]=H.x,W[S++]=H.y,W[S++]=H.z}i&&(j[Q--]=B.z,j[Q--]=B.y,j[Q--]=B.x,j[b++]=H.x,j[b++]=H.y,j[b++]=H.z)}B=s(-(T=a.PI_OVER_TWO),l,P,M,_,O,v,d,w,B);var q={};return t&&(W[S++]=B.x,W[S++]=B.y,W[S++]=B.z,q.positions=W,q.numPts=p),i&&(j[Q--]=B.z,j[Q--]=B.y,j[Q--]=B.x,q.outerPositions=j),q},i});