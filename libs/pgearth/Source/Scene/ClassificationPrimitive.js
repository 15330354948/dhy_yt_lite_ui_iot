define(["../Core/ColorGeometryInstanceAttribute","../Core/combine","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/GeometryInstance","../Core/isArray","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Shaders/ShadowVolumeFS","../Shaders/ShadowVolumeAppearanceVS","../ThirdParty/when","./BlendingState","./ClassificationType","./DepthFunction","./PerInstanceColorAppearance","./Primitive","./SceneMode","./ShadowVolumeAppearance","./StencilConstants","./StencilFunction","./StencilOperation"],function(e,t,r,i,a,s,o,n,c,d,h,l,p,m,u,_,S,P,v,C,f,A,E,g,I,T,b){"use strict";var w=["color"];function D(e){var t,a=(e=r(e,r.EMPTY_OBJECT)).geometryInstances;this.geometryInstances=a,this.show=r(e.show,!0),this.classificationType=r(e.classificationType,v.BOTH),this.debugShowBoundingVolume=r(e.debugShowBoundingVolume,!1),this.debugShowShadowVolume=r(e.debugShowShadowVolume,!1),this._debugShowShadowVolume=!1,this._extruded=r(e._extruded,!1),this._uniformMap=e._uniformMap,this._sp=void 0,this._spStencil=void 0,this._spPick=void 0,this._spColor=void 0,this._spPick2D=void 0,this._spColor2D=void 0,this._rsStencilPreloadPass=void 0,this._rsStencilPreloadPass3DTiles=void 0,this._rsStencilDepthPass=void 0,this._rsStencilDepthPass3DTiles=void 0,this._rsColorPass=void 0,this._rsPickPass=void 0,this._commandsIgnoreShow=[],this._ready=!1,this._readyPromise=S.defer(),this._primitive=void 0,this._pickPrimitive=e._pickPrimitive,this._hasSphericalExtentsAttribute=!1,this._hasPlanarExtentsAttributes=!1,this._hasPerColorAttribute=!1,this.appearance=e.appearance,i(a)&&c(a)&&a.length>1&&(t=w),this._createBoundingVolumeFunction=e._createBoundingVolumeFunction,this._updateAndQueueCommandsFunction=e._updateAndQueueCommandsFunction,this._usePickOffsets=!1,this._primitiveOptions={geometryInstances:void 0,appearance:void 0,vertexCacheOptimize:r(e.vertexCacheOptimize,!1),interleave:r(e.interleave,!1),releaseGeometryInstances:r(e.releaseGeometryInstances,!0),allowPicking:r(e.allowPicking,!0),asynchronous:r(e.asynchronous,!0),compressVertices:r(e.compressVertices,!0),_readOnlyInstanceAttributes:t,_createBoundingVolumeFunction:void 0,_createRenderStatesFunction:void 0,_createShaderProgramFunction:void 0,_createCommandsFunction:void 0,_updateAndQueueCommandsFunction:void 0,_createPickOffsets:!0}}function y(e,t){var r=t?T.EQUAL:T.ALWAYS;return{colorMask:{red:!1,green:!1,blue:!1,alpha:!1},stencilTest:{enabled:e,frontFunction:r,frontOperation:{fail:b.KEEP,zFail:b.DECREMENT_WRAP,zPass:b.DECREMENT_WRAP},backFunction:r,backOperation:{fail:b.KEEP,zFail:b.INCREMENT_WRAP,zPass:b.INCREMENT_WRAP},reference:I.PGEARTH_3D_TILE_MASK,mask:I.PGEARTH_3D_TILE_MASK},stencilMask:I.CLASSIFICATION_MASK,depthTest:{enabled:!1},depthMask:!1}}function k(e,t){var r=t?T.EQUAL:T.ALWAYS;return{colorMask:{red:!1,green:!1,blue:!1,alpha:!1},stencilTest:{enabled:e,frontFunction:r,frontOperation:{fail:b.KEEP,zFail:b.KEEP,zPass:b.INCREMENT_WRAP},backFunction:r,backOperation:{fail:b.KEEP,zFail:b.KEEP,zPass:b.DECREMENT_WRAP},reference:I.PGEARTH_3D_TILE_MASK,mask:I.PGEARTH_3D_TILE_MASK},stencilMask:I.CLASSIFICATION_MASK,depthTest:{enabled:!0,func:C.LESS_OR_EQUAL},depthMask:!1}}function O(e){return{stencilTest:{enabled:e,frontFunction:T.NOT_EQUAL,frontOperation:{fail:b.KEEP,zFail:b.KEEP,zPass:b.DECREMENT_WRAP},backFunction:T.NOT_EQUAL,backOperation:{fail:b.KEEP,zFail:b.KEEP,zPass:b.DECREMENT_WRAP},reference:0,mask:I.CLASSIFICATION_MASK},stencilMask:I.CLASSIFICATION_MASK,depthTest:{enabled:!1},depthMask:!1,blending:P.ALPHA_BLEND}}a(D.prototype,{vertexCacheOptimize:{get:function(){return this._primitiveOptions.vertexCacheOptimize}},interleave:{get:function(){return this._primitiveOptions.interleave}},releaseGeometryInstances:{get:function(){return this._primitiveOptions.releaseGeometryInstances}},allowPicking:{get:function(){return this._primitiveOptions.allowPicking}},asynchronous:{get:function(){return this._primitiveOptions.asynchronous}},compressVertices:{get:function(){return this._primitiveOptions.compressVertices}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},_needs2DShader:{get:function(){return this._hasPlanarExtentsAttributes||this._hasSphericalExtentsAttribute}}}),D.isSupported=function(e){return e.context.stencilBuffer};var F={stencilTest:{enabled:!0,frontFunction:T.NOT_EQUAL,frontOperation:{fail:b.KEEP,zFail:b.KEEP,zPass:b.DECREMENT_WRAP},backFunction:T.NOT_EQUAL,backOperation:{fail:b.KEEP,zFail:b.KEEP,zPass:b.DECREMENT_WRAP},reference:0,mask:I.CLASSIFICATION_MASK},stencilMask:I.CLASSIFICATION_MASK,depthTest:{enabled:!1},depthMask:!1};function x(e,t){var r=t.context,a=e._primitive,s=_;s=e._primitive._batchTable.getVertexShaderCallback()(s),s=A._appendDistanceDisplayConditionToShader(a,s),s=A._modifyShaderPosition(e,s,t.scene3DOnly),s=A._updateColorAttribute(a,s);var o=e._hasPlanarExtentsAttributes,n=o||e._hasSphericalExtentsAttribute;e._extruded&&(s=function(e,t){if(!e.compressVertices)return t;if(-1!==t.search(/attribute\s+vec3\s+extrudeDirection;/g)){var r="attribute vec2 compressedAttributes;",i=t;return i=i.replace(/attribute\s+vec3\s+extrudeDirection;/g,""),[r,"vec3 extrudeDirection;\n",i=m.replaceMain(i,"czm_non_compressed_main"),"void main() \n{ \n    extrudeDirection = czm_octDecode(compressedAttributes, 65535.0);\n    czm_non_compressed_main(); \n}"].join("\n")}}(a,s));var c=e._extruded?"EXTRUDED_GEOMETRY":"",d="ENABLE_GL_POSITION_LOG_DEPTH_AT_HEIGHT",h=new m({defines:[c,d],sources:[s]}),l=new m({sources:[u]}),S=e._primitive._attributeLocations,P=new g(n,o,e.appearance);if(e._spStencil=p.replaceCache({context:r,shaderProgram:e._spStencil,vertexShaderSource:h,fragmentShaderSource:l,attributeLocations:S}),e._primitive.allowPicking){var v=m.createPickVertexShaderSource(s);v=A._appendShowToShader(a,v),v=A._updatePickColorAttribute(v);var C=P.createPickFragmentShader(!1),f=P.createPickVertexShader([c,d],v,!1,t.mapProjection);if(e._spPick=p.replaceCache({context:r,shaderProgram:e._spPick,vertexShaderSource:f,fragmentShaderSource:C,attributeLocations:S}),n){var E=r.shaderCache.getDerivedShaderProgram(e._spPick,"2dPick");if(!i(E)){var I=P.createPickFragmentShader(!0),T=P.createPickVertexShader([c,d],v,!0,t.mapProjection);E=r.shaderCache.createDerivedShaderProgram(e._spPick,"2dPick",{vertexShaderSource:T,fragmentShaderSource:I,attributeLocations:S})}e._spPick2D=E}}else e._spPick=p.fromCache({context:r,vertexShaderSource:h,fragmentShaderSource:l,attributeLocations:S});s=A._appendShowToShader(a,s),h=new m({defines:[c,d],sources:[s]}),e._sp=p.replaceCache({context:r,shaderProgram:e._sp,vertexShaderSource:h,fragmentShaderSource:l,attributeLocations:S});var b=P.createFragmentShader(!1),w=P.createVertexShader([c,d],s,!1,t.mapProjection);if(e._spColor=p.replaceCache({context:r,shaderProgram:e._spColor,vertexShaderSource:w,fragmentShaderSource:b,attributeLocations:S}),n){var D=r.shaderCache.getDerivedShaderProgram(e._spColor,"2dColor");if(!i(D)){var y=P.createFragmentShader(!0),k=P.createVertexShader([c,d],s,!0,t.mapProjection);D=r.shaderCache.createDerivedShaderProgram(e._spColor,"2dColor",{vertexShaderSource:k,fragmentShaderSource:y,attributeLocations:S})}e._spColor2D=D}}function R(e,r,a,s,o,n,c){!function(e,r){var a,s,o,n=e._primitive,c=3*n._va.length;r.length=c;var l=0,p=n._batchTable.getUniformMapCallback()(e._uniformMap),m=e._needs2DShader;for(a=0;a<c;a+=3){var u=n._va[l++];s=r[a],i(s)||(s=r[a]=new d({owner:e,primitiveType:n._primitiveType})),s.vertexArray=u,s.renderState=e._rsStencilPreloadPass,s.shaderProgram=e._sp,s.uniformMap=p,s.pass=h.TERRAIN_CLASSIFICATION,(o=d.shallowClone(s,s.derivedCommands.tileset)).renderState=e._rsStencilPreloadPass3DTiles,o.pass=h.PGEARTH_3D_TILE_CLASSIFICATION,s.derivedCommands.tileset=o,s=r[a+1],i(s)||(s=r[a+1]=new d({owner:e,primitiveType:n._primitiveType})),s.vertexArray=u,s.renderState=e._rsStencilDepthPass,s.shaderProgram=e._sp,s.uniformMap=p,s.pass=h.TERRAIN_CLASSIFICATION,(o=d.shallowClone(s,s.derivedCommands.tileset)).renderState=e._rsStencilDepthPass3DTiles,o.pass=h.PGEARTH_3D_TILE_CLASSIFICATION,s.derivedCommands.tileset=o,s=r[a+2],i(s)||(s=r[a+2]=new d({owner:e,primitiveType:n._primitiveType})),s.vertexArray=u,s.renderState=e._rsColorPass,s.shaderProgram=e._spColor,s.pass=h.TERRAIN_CLASSIFICATION;var _=e.appearance.material;if(i(_)&&(p=t(p,_._uniforms)),s.uniformMap=p,(o=d.shallowClone(s,s.derivedCommands.tileset)).pass=h.PGEARTH_3D_TILE_CLASSIFICATION,s.derivedCommands.tileset=o,m){var S=d.shallowClone(s,s.derivedCommands.appearance2D);S.shaderProgram=e._spColor2D,s.derivedCommands.appearance2D=S,(S=d.shallowClone(o,o.derivedCommands.appearance2D)).shaderProgram=e._spColor2D,o.derivedCommands.appearance2D=S}}var P=e._commandsIgnoreShow,v=e._spStencil,C=0;c=P.length=c/3*2;for(var f=0;f<c;f+=2){var A=P[f]=d.shallowClone(r[C],P[f]);A.shaderProgram=v,A.pass=h.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW,(A=P[f+1]=d.shallowClone(r[C+1],P[f+1])).shaderProgram=v,A.pass=h.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW,C+=3}}(e,n),function(e,t){var r,a,s,o,n,c=e._usePickOffsets,l=e._primitive,p=3*l._va.length,m=0;c&&(p=3*(r=l._pickOffsets).length),t.length=p;var u=0,_=l._batchTable.getUniformMapCallback()(e._uniformMap),S=e._needs2DShader;for(s=0;s<p;s+=3){var P=l._va[u++];if(c&&(a=r[m++],P=l._va[a.index]),o=t[s],i(o)||(o=t[s]=new d({owner:e,primitiveType:l._primitiveType,pickOnly:!0})),o.vertexArray=P,o.renderState=e._rsStencilPreloadPass,o.shaderProgram=e._sp,o.uniformMap=_,o.pass=h.TERRAIN_CLASSIFICATION,c&&(o.offset=a.offset,o.count=a.count),(n=d.shallowClone(o,o.derivedCommands.tileset)).renderState=e._rsStencilPreloadPass3DTiles,n.pass=h.PGEARTH_3D_TILE_CLASSIFICATION,o.derivedCommands.tileset=n,o=t[s+1],i(o)||(o=t[s+1]=new d({owner:e,primitiveType:l._primitiveType,pickOnly:!0})),o.vertexArray=P,o.renderState=e._rsStencilDepthPass,o.shaderProgram=e._sp,o.uniformMap=_,o.pass=h.TERRAIN_CLASSIFICATION,c&&(o.offset=a.offset,o.count=a.count),(n=d.shallowClone(o,o.derivedCommands.tileset)).renderState=e._rsStencilDepthPass3DTiles,n.pass=h.PGEARTH_3D_TILE_CLASSIFICATION,o.derivedCommands.tileset=n,o=t[s+2],i(o)||(o=t[s+2]=new d({owner:e,primitiveType:l._primitiveType,pickOnly:!0})),o.vertexArray=P,o.renderState=e._rsPickPass,o.shaderProgram=e._spPick,o.uniformMap=_,o.pass=h.TERRAIN_CLASSIFICATION,c&&(o.offset=a.offset,o.count=a.count),(n=d.shallowClone(o,o.derivedCommands.tileset)).pass=h.PGEARTH_3D_TILE_CLASSIFICATION,o.derivedCommands.tileset=n,S){var v=d.shallowClone(o,o.derivedCommands.pick2D);v.shaderProgram=e._spPick2D,o.derivedCommands.pick2D=v,(v=d.shallowClone(n,n.derivedCommands.pick2D)).shaderProgram=e._spPick2D,n.derivedCommands.pick2D=v}}}(e,c)}function L(e,t){return Math.floor(e%t/3)}function M(e,t,r,i,a,s){e.modelMatrix=r,e.boundingVolume=a,e.cull=i,e.debugShowBoundingVolume=s,t.commandList.push(e)}function N(e,t,r,i,a){e.modelMatrix=r,e.boundingVolume=a,e.cull=i,t.commandList.push(e)}return D.prototype.update=function(t){if(i(this._primitive)||i(this.geometryInstances)){var a=this.appearance;i(a)&&i(a.material)&&a.material.update(t.context);var s=this,d=this._primitiveOptions;if(!i(this._primitive)){var h,p,m,u,_=c(this.geometryInstances)?this.geometryInstances:[this.geometryInstances],S=_.length,P=!1,C=!0,I=!1,T=!1;for(S>0&&(m=_[0].attributes,I=g.hasAttributesForSphericalExtents(m),T=g.hasAttributesForTextureCoordinatePlanes(m),u=m.color),h=0;h<S;h++){var b=(p=_[h]).attributes.color;if(i(b))P=!0;else if(P)throw new o("All GeometryInstances must have color attributes to use per-instance color.");C=C&&i(b)&&e.equals(u,b)}if(!C&&!I&&!T)throw new o("All GeometryInstances must have the same color attribute except via GroundPrimitives");if(P&&!i(a)&&(a=new f({flat:!0}),this.appearance=a),!P&&a instanceof f)throw new o("PerInstanceColorAppearance requires color GeometryInstanceAttributes on all GeometryInstances");if(i(a.material)&&!I&&!T)throw new o("Materials on ClassificationPrimitives are not supported except via GroundPrimitives");this._usePickOffsets=!I&&!T,this._hasSphericalExtentsAttribute=I,this._hasPlanarExtentsAttributes=T,this._hasPerColorAttribute=P;var w=new Array(S);for(h=0;h<S;++h)p=_[h],w[h]=new n({geometry:p.geometry,attributes:p.attributes,modelMatrix:p.modelMatrix,id:p.id,pickPrimitive:r(this._pickPrimitive,s)});d.appearance=a,d.geometryInstances=w,i(this._createBoundingVolumeFunction)&&(d._createBoundingVolumeFunction=function(e,t){s._createBoundingVolumeFunction(e,t)}),d._createRenderStatesFunction=function(e,t,r,a){!function(e,t,r,a){if(!i(e._rsStencilPreloadPass)){var s=!e.debugShowShadowVolume;e._rsStencilPreloadPass=l.fromCache(y(s,!1)),e._rsStencilPreloadPass3DTiles=l.fromCache(y(s,!0)),e._rsStencilDepthPass=l.fromCache(k(s,!1)),e._rsStencilDepthPass3DTiles=l.fromCache(k(s,!0)),e._rsColorPass=l.fromCache(O(s)),e._rsPickPass=l.fromCache(F)}}(s)},d._createShaderProgramFunction=function(e,t,r){x(s,t)},d._createCommandsFunction=function(e,t,r,i,a,o,n){R(s,0,0,0,0,o,n)},i(this._updateAndQueueCommandsFunction)?d._updateAndQueueCommandsFunction=function(e,t,r,i,a,o,n,c){s._updateAndQueueCommandsFunction(e,t,r,i,a,o,n,c)}:d._updateAndQueueCommandsFunction=function(e,t,r,a,o,n,c,d){!function(e,t,r,a,s,o,n,c){var d,h=e._primitive;A._updateBoundingVolumes(h,t,s),t.mode===E.SCENE3D?d=h._boundingSphereWC:t.mode===E.COLUMBUS_VIEW?d=h._boundingSphereCV:t.mode===E.SCENE2D&&i(h._boundingSphere2D)?d=h._boundingSphere2D:i(h._boundingSphereMorph)&&(d=h._boundingSphereMorph);var l,p,m=e.classificationType,u=m!==v.PGEARTH_3D_TILE,_=m!==v.TERRAIN,S=t.passes;if(S.render){var P=r.length;for(l=0;l<P;++l)p=d[L(l,P)],u&&M(r[l],t,s,o,p,n),_&&M(r[l].derivedCommands.tileset,t,s,o,p,n);if(t.invertClassification){var C=e._commandsIgnoreShow,f=C.length;for(l=0;l<f;++l)p=d[Math.floor(l/2)],M(C[l],t,s,o,p,n)}}if(S.pick){var g=a.length,I=h._pickOffsets;for(l=0;l<g;++l)p=d[I[L(l,g)].index],u&&N(a[l],t,s,o,p),_&&N(a[l].derivedCommands.tileset,t,s,o,p)}}(s,t,r,a,o,n,c)},this._primitive=new A(d),this._primitive.readyPromise.then(function(e){s._ready=!0,s.releaseGeometryInstances&&(s.geometryInstances=void 0);var t=e._error;i(t)?s._readyPromise.reject(t):s._readyPromise.resolve(s)})}if(this.debugShowShadowVolume&&!this._debugShowShadowVolume&&this._ready?(this._debugShowShadowVolume=!0,this._rsStencilPreloadPass=l.fromCache(y(!1,!1)),this._rsStencilPreloadPass3DTiles=l.fromCache(y(!1,!0)),this._rsStencilDepthPass=l.fromCache(k(!1,!1)),this._rsStencilDepthPass3DTiles=l.fromCache(k(!1,!0)),this._rsColorPass=l.fromCache(O(!1))):!this.debugShowShadowVolume&&this._debugShowShadowVolume&&(this._debugShowShadowVolume=!1,this._rsStencilPreloadPass=l.fromCache(y(!0,!1)),this._rsStencilPreloadPass3DTiles=l.fromCache(y(!0,!0)),this._rsStencilDepthPass=l.fromCache(k(!0,!1)),this._rsStencilDepthPass3DTiles=l.fromCache(k(!0,!0)),this._rsColorPass=l.fromCache(O(!0))),this._primitive.appearance!==a){if(!this._hasSphericalExtentsAttribute&&!this._hasPlanarExtentsAttributes&&i(a.material))throw new o("Materials on ClassificationPrimitives are not supported except via GroundPrimitive");if(!this._hasPerColorAttribute&&a instanceof f)throw new o("PerInstanceColorAppearance requires color GeometryInstanceAttribute");this._primitive.appearance=a}this._primitive.show=this.show,this._primitive.debugShowBoundingVolume=this.debugShowBoundingVolume,this._primitive.update(t)}},D.prototype.getGeometryInstanceAttributes=function(e){if(!i(this._primitive))throw new o("must call update before calling getGeometryInstanceAttributes");return this._primitive.getGeometryInstanceAttributes(e)},D.prototype.isDestroyed=function(){return!1},D.prototype.destroy=function(){return this._primitive=this._primitive&&this._primitive.destroy(),this._sp=this._sp&&this._sp.destroy(),this._spPick=this._spPick&&this._spPick.destroy(),this._spColor=this._spColor&&this._spColor.destroy(),this._spPick2D=void 0,this._spColor2D=void 0,s(this)},D});