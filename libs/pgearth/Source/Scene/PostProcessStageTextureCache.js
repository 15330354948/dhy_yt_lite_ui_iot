define(["../Core/Color","../Core/defined","../Core/Math","../Core/destroyObject","../Renderer/ClearCommand","../Renderer/Framebuffer","../Renderer/Texture"],function(e,t,r,o,i,a,n){"use strict";function f(e){this._collection=e,this._framebuffers=[],this._stageNameToFramebuffer={},this._width=void 0,this._height=void 0,this._updateDependencies=!1}function u(e){for(;t(e.length);)e=e.get(e.length-1);return e.name}function s(e,r,o,i,a){if(!i.enabled||!i._isSupported(r))return a;var n=o[i.name]={};t(a)&&(n[u(e.getStageByName(a))]=!0);var f=i.uniforms;if(t(f))for(var s=Object.getOwnPropertyNames(f),l=s.length,c=0;c<l;++c){var p=f[s[c]];if("string"==typeof p){var h=e.getStageByName(p);t(h)&&(n[u(h)]=!0)}}return i.name}function l(e,r,o,i,a){if(t(i.enabled)&&!i.enabled||t(i._isSupported)&&!i._isSupported(r))return a;for(var n,f,c=a,p=!t(i.inputPreviousStageTexture)||i.inputPreviousStageTexture,h=a,g=i.length,d=0;d<g;++d){var m=i.get(d);h=t(m.length)?l(e,r,o,m,a):s(e,r,o,m,a),p&&(a=h)}if(p)for(n=1;n<g;++n)f=u(i.get(n)),t(o[f])||(o[f]={}),o[f][c]=!0;else for(n=1;n<g;++n)for(var _=o[f=u(i.get(n))],b=0;b<n;++b)_[u(i.get(b))]=!0;return h}function c(r,o,i){var a,n,f=r._collection.getStageByName(o),u=f._textureScale,s=f._forcePowerOfTwo,l=f._pixelFormat,c=f._pixelDatatype,p=f._clearColor,h=r._framebuffers,g=h.length;for(a=0;a<g;++a)if(u===(n=h[a]).textureScale&&s===n.forcePowerOfTwo&&l===n.pixelFormat&&c===n.pixelDatatype&&e.equals(p,n.clearColor)){for(var d=n.stages,m=d.length,_=!1,b=0;b<m;++b)if(i[d[b]]){_=!0;break}if(!_)break}return t(n)&&a<g?(n.stages.push(o),n):(n={textureScale:u,forcePowerOfTwo:s,pixelFormat:l,pixelDatatype:c,clearColor:p,stages:[o],buffer:void 0,clear:void 0},h.push(n),n)}function p(e,r){var o=function(e,r){var o={};if(t(e.ambientOcclusion)){var i=e.ambientOcclusion,a=e.bloom,n=e._tonemapping,f=e.fxaa,u=l(e,r,o,i,void 0);s(e,r,o,f,u=l(e,r,o,e,u=s(e,r,o,n,u=l(e,r,o,a,u))))}else l(e,r,o,e,void 0);return o}(e._collection,r);for(var i in o)o.hasOwnProperty(i)&&(e._stageNameToFramebuffer[i]=c(e,i,o[i]))}function h(e){for(var t=e._framebuffers,r=t.length,o=0;o<r;++o){var i=t[o];i.buffer=i.buffer&&i.buffer.destroy(),i.buffer=void 0}}return f.prototype.updateDependencies=function(){this._updateDependencies=!0},f.prototype.update=function(e){var o=this._collection,f=this._updateDependencies,u=t(o.ambientOcclusion)&&o.ambientOcclusion.enabled&&o.ambientOcclusion._isSupported(e),s=t(o.bloom)&&o.bloom.enabled&&o.bloom._isSupported(e),l=t(o._tonemapping)&&o._tonemapping.enabled&&o._tonemapping._isSupported(e),c=t(o.fxaa)&&o.fxaa.enabled&&o.fxaa._isSupported(e),g=!t(o._activeStages)||o._activeStages.length>0||u||s||l||c;if((f||!g&&this._framebuffers.length>0)&&(h(this),this._framebuffers.length=0,this._stageNameToFramebuffer={},this._width=void 0,this._height=void 0),f||g){0===this._framebuffers.length&&p(this,e);var d=e.drawingBufferWidth,m=e.drawingBufferHeight,_=this._width!==d||this._height!==m;(f||_)&&(this._width=d,this._height=m,this._updateDependencies=!1,h(this),function(e,t){for(var o=e._width,f=e._height,u=e._framebuffers,s=u.length,l=0;l<s;++l){var c=u[l],p=c.textureScale,h=Math.ceil(o*p),g=Math.ceil(f*p),d=Math.min(h,g);c.forcePowerOfTwo&&(r.isPowerOfTwo(d)||(d=r.nextPowerOfTwo(d)),h=d,g=d),c.buffer=new a({context:t,colorTextures:[new n({context:t,width:h,height:g,pixelFormat:c.pixelFormat,pixelDatatype:c.pixelDatatype})]}),c.clear=new i({color:c.clearColor,framebuffer:c.buffer})}}(this,e))}},f.prototype.clear=function(e){for(var t=this._framebuffers,r=0;r<t.length;++r)t[r].clear.execute(e)},f.prototype.getStageByName=function(e){return this._collection.getStageByName(e)},f.prototype.getOutputTexture=function(e){return this._collection.getOutputTexture(e)},f.prototype.getFramebuffer=function(e){var r=this._stageNameToFramebuffer[e];if(t(r))return r.buffer},f.prototype.isDestroyed=function(){return!1},f.prototype.destroy=function(){return h(this),o(this)},f});