define(["../ThirdParty/protobuf-minimal","../ThirdParty/when","./buildModuleUrl","./Check","./Credit","./defaultValue","./defined","./defineProperties","./GoogleEarthEnterpriseTileInformation","./isBitSet","./loadAndExecuteScript","./Math","./Request","./Resource","./RuntimeError","./TaskProcessor"],function(e,r,t,n,o,i,a,u,s,l,f,h,d,c,g,v){"use strict";var y=function(e){for(var r=e.length,t=new ArrayBuffer(r),n=new Uint8Array(t),o=0;o<r;++o)n[o]=e.charCodeAt(o);return t}('EÃ´Â½\vyÃ¢jE"Â’,ÃqÃ¸IFgQ\0B%Ã†Ã¨a,f)\bÃ†4Ãœjb%y\nwmiÃ–Ã°ÂœkÂ“Â¡Â½NuÃ A[ÃŸ@V\fÃ™Â»rÂ›Â|3SÃ®OlÃ”qÂ°{Ã€EVZÂ­wUe\v3Â’*Â¬l5Ã…0sÃ¸3>mF8JÂ´ÃÃ°.ÃuÃšÂŒDt"Ãºa"\f3"SoÂ¯9D\vÂŒ9Ã™9LÂ¹Â¿Â«\\ÂŒP_ÂŸ"uxÃ©qÂ‘h;ÃÃ„Â›Ã°<VqHÂ‚\'UfYNeÂ˜uÂ£aF}a?A\0ÂŸÃ—Â´4MÃÂ‡FÂ°Ã•Â¸ÂŠ\'{Â‹Ãœ+Â»Mg0ÃˆÃ‘Ã¶\\ÂPÃº[/FÂ›n5/\'C.Ã«\n\f^Â¥se4Ã¥l.jC\'c#UÂ©?q{gC}:Â¯ÃÃ¢TUÂœÃ½KÃ†Ã¢ÂŸ/(Ã­Ã‹\\Ã†-fÂˆÂ§;/*"NÂ°k.Ã\rÂ•}}GÂºCÂ²Â²+>MÂª>}Ã¦ÃIÂ‰Ã†Ã¦x\fa1-Â¤OÂ¥~q ÂˆÃ¬\r1Ã¨N\v\0nPh}=\b\rÂ•Â¦nÂ£hÂ—$[kÃ³#Ã³Â¶sÂ³\r\v@Ã€ÂŸÃ˜Q]Ãº".jÃŸI\0Â¹Â wUÃ†Ã¯jÂ¿{GLÂƒÃ®ÃœÃœFÂ…Â©Â­S+S4Ã¿Â”YÃ¤8Ã¨1ÂƒNÂ¹XFkÃ‹-#Â†Â’p\x005Âˆ"Ã1Â²&/Ã§Ãƒu-6,rtÂ°#GÂ·Ã“Ã‘&Â…7rÃ¢\0ÂŒDÃÃš3-Ã`Â†i#i*|ÃKQ\rÂ•T9w.)ÃªÂ¦PÂ¢jÂoPÂ™\\>TÃ»Ã¯P[\vEÂ‰m(w7Ã›ÂJfJoÂ™ Ã¥pÃ¢Â¹q~\fmI-zÃ¾rÃ‡Ã²Y0ÂÂ»]sÃ¥Ã‰ ÃªxÃ¬ ÂÃ°ÂŠB|G`Â°Â½&Â·qÂ¶Ã‡ÂŸÃ‘3Â‚=Ã“Â«Ã®cÂ™Ãˆ+SÂ D\\qÃ†ÃŒD2O<ÃŠÃ€)=RÃ“aXÂ©}eÂ´ÃœÃ\rÃ´=Ã±\bÂ©BÃš#\tÃ˜Â¿^PIÃ¸MÃ€Ã‹GLOÃ·{+Ã˜Ã…1Â’;ÂµoÃœl\rÂ’ÂˆÃ‘ÂÃ›?Ã¢Ã©Ãš_Ã”Â„Ã¢FaZÃUÃÂ¤\0Â¾Ã½ÃgÃ±JiÂ—Ã¦ HÃ˜]~Â®q NÂ®Ã€VÂ©Â‘<Â‚rÃ§vÃ¬)IÃ–]-ÂƒÃ£Ã›6Â©;fÂ—Â‡jÃ•Â¶=P^RÂ¹KÃ‡sWxÃ‰Ã´.YÂ•Â“oÃKW>\'\'Ã‡`Ã›;Ã­ÂšSD>?ÂÂ’mwÂ¢\nÃ«?RÂ¨Ã†U^1I7Â…Ã´Ã…&-Â©Â¿Â‹\'TÃšÃƒj Ã¥*xÂ°Ã–ÂprÂªÂ‹hÂ½ÂˆÃ·_HÂ±~Ã€XL?fÃ¹>Ã¡eÃ€pÂ§Ã8iÂ¯Ã°VldIÂœ\'Â­xtOÃ‚Â‡ÃV9\0Ãšw\vÃ‹-Â‰Ã»5OÃµ\bQ`Ã\nZGM&30xÃšÃ€ÂœFGÃ¢[y`In7gS\n>Ã©Ã¬F9Â²Ã±4\rÃ†Â„SunÃ¡\fYÃ™Ã)Â…{IIÂ¥wyÂ¾IV.6Ã§\v:Â»Ob{Ã’M1Â•/Â½8{Â¨O!Ã¡Ã¬FpvÂ•})"xÂˆ\nÂÃÂ\\ÃšÃQÃÃ°Ã¼YRe|3ÃŸÃ³HÃšÂ»*uÃ›`Â²Ã”Ã¼Ã­Ã¬5Â¨Ã¿(1-ÃˆÃœÂˆF|ÂŠ["');function p(u){n.defined("resourceOrUrl",u);var s=u;"string"==typeof s||s instanceof c||(n.typeOf.string("resourceOrUrl.url",u.url),s=u.url);var l=c.createIfNeeded(s);l.appendForwardSlash(),this._resource=l,this.imageryPresent=!0,this.protoImagery=void 0,this.terrainPresent=!0,this.negativeAltitudeExponentBias=32,this.negativeAltitudeThreshold=h.EPSILON12,this.providers={},this.key=void 0,this._quadPacketVersion=1,this._tileInfo={},this._subtreePromises={};var d=this;this._readyPromise=function(r){var n=r._resource.getDerivedResource({url:"dbRoot.v5",queryParameters:{output:"proto"}});if(!a(P)){var u=t("ThirdParty/google-earth-dbroot-parser.js"),s=window.pgEarthGoogleEarthDbRootParser;P=f(u).then(function(){b=window.pgEarthGoogleEarthDbRootParser(e),a(s)?window.pgEarthGoogleEarthDbRootParser=s:delete window.pgEarthGoogleEarthDbRootParser})}return P.then(function(){return n.fetchArrayBuffer()}).then(function(e){var t=b.EncryptedDbRootProto.decode(new Uint8Array(e)),n=t.encryptionData,o=n.byteOffset,i=o+n.byteLength,a=r.key=n.buffer.slice(o,i);n=t.dbrootData,o=n.byteOffset,i=o+n.byteLength;var u=n.buffer.slice(o,i);return I.scheduleTask({buffer:u,type:"DbRoot",key:a},[u])}).then(function(e){var t=b.DbRootProto.decode(new Uint8Array(e.buffer));if(r.imageryPresent=i(t.imageryPresent,r.imageryPresent),r.protoImagery=t.protoImagery,r.terrainPresent=i(t.terrainPresent,r.terrainPresent),a(t.endSnippet)&&a(t.endSnippet.model)){var n=t.endSnippet.model;r.negativeAltitudeExponentBias=i(n.negativeAltitudeExponentBias,r.negativeAltitudeExponentBias),r.negativeAltitudeThreshold=i(n.compressedNegativeAltitudeThreshold,r.negativeAltitudeThreshold)}a(t.databaseVersion)&&(r._quadPacketVersion=i(t.databaseVersion.quadtreeVersion,r._quadPacketVersion));for(var u=r.providers,s=i(t.providerInfo,[]),l=s.length,f=0;f<l;++f){var h=s[f],d=h.copyrightString;a(d)&&(u[h.providerId]=new o(d.value))}}).otherwise(function(){console.log("Failed to retrieve "+n.url+". Using defaults."),r.key=y})}(this).then(function(){return d.getQuadTreePacket("",d._quadPacketVersion)}).then(function(){return!0}).otherwise(function(e){var t="An error occurred while accessing "+m(d,"",1).url+".";return r.reject(new g(t))})}u(p.prototype,{url:{get:function(){return this._resource.url}},proxy:{get:function(){return this._resource.proxy}},resource:{get:function(){return this._resource}},readyPromise:{get:function(){return this._readyPromise}}}),p.tileXYToQuadKey=function(e,r,t){for(var n="",o=t;o>=0;--o){var i=1<<o,a=0;l(r,i)?l(e,i)&&(a|=1):(a|=2,l(e,i)||(a|=1)),n+=a}return n},p.quadKeyToTileXY=function(e){for(var r=0,t=0,n=e.length-1,o=n;o>=0;--o){var i=1<<o,a=+e[n-o];l(a,2)?l(a,1)||(r|=i):(t|=i,l(a,1)&&(r|=i))}return{x:r,y:t,level:n}},p.prototype.isValid=function(e){var r=this.getTileInformationFromQuadKey(e);if(a(r))return null!==r;for(var t,n=!0,o=e;o.length>1;){if(t=o.substring(o.length-1),o=o.substring(0,o.length-1),r=this.getTileInformationFromQuadKey(o),a(r)){r.hasSubtree()||r.hasChild(parseInt(t))||(n=!1);break}if(null===r){n=!1;break}}return n};var b,P,I=new v("decodeGoogleEarthEnterprisePacket",Number.POSITIVE_INFINITY);function m(e,r,t,n){return e._resource.getDerivedResource({url:"flatfile?q2-0"+r+"-q."+t.toString(),request:n})}return p.prototype.getQuadTreePacket=function(e,r,t){r=i(r,1);var n=m(this,e=i(e,""),r,t).fetchArrayBuffer();if(a(n)){var o=this._tileInfo,u=this.key;return n.then(function(r){return I.scheduleTask({buffer:r,quadKey:e,type:"Metadata",key:u},[r]).then(function(r){var t,n=-1;if(""!==e){n=e.length+1;var i=r[e];(t=o[e])._bits|=i._bits,delete r[e]}var a=Object.keys(r);a.sort(function(e,r){return e.length-r.length});for(var u=a.length,l=0;l<u;++l){var f=a[l];if(null!==r[f]){var h=s.clone(r[f]),d=f.length;if(d===n)h.setParent(t);else if(d>1){var c=o[f.substring(0,f.length-1)];h.setParent(c)}o[f]=h}else o[f]=null}})})}},p.prototype.populateSubtree=function(e,t,n,o){return function e(t,n,o){var i=t._tileInfo;var u=n;var s=i[u];if(a(s)&&(!s.hasSubtree()||s.hasChildren()))return s;for(;void 0===s&&u.length>1;)u=u.substring(0,u.length-1),s=i[u];var l;var f=t._subtreePromises;var h=f[u];if(a(h))return h.then(function(){return l=new d({throttle:o.throttle,throttleByServer:o.throttleByServer,type:o.type,priorityFunction:o.priorityFunction}),e(t,n,l)});if(!a(s)||!s.hasSubtree())return r.reject(new g("Couldn't load metadata for tile "+n));h=t.getQuadTreePacket(u,s.cnodeVersion,o);if(!a(h))return;f[u]=h;return h.then(function(){return l=new d({throttle:o.throttle,throttleByServer:o.throttleByServer,type:o.type,priorityFunction:o.priorityFunction}),e(t,n,l)}).always(function(){delete f[u]})}(this,p.tileXYToQuadKey(e,t,n),o)},p.prototype.getTileInformation=function(e,r,t){var n=p.tileXYToQuadKey(e,r,t);return this._tileInfo[n]},p.prototype.getTileInformationFromQuadKey=function(e){return this._tileInfo[e]},p});