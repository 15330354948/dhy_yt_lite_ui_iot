define(["../ThirdParty/when","./BoundingSphere","./Cartesian2","./Cartesian3","./defaultValue","./defined","./defineProperties","./DeveloperError","./IndexDatatype","./Intersections2D","./Math","./OrientedBoundingBox","./TaskProcessor","./TerrainEncoding","./TerrainMesh"],function(e,i,t,n,r,s,h,o,d,a,u,c,g,m,l){"use strict";function w(e){if(!s(e)||!s(e.quantizedVertices))throw new o("options.quantizedVertices is required.");if(!s(e.indices))throw new o("options.indices is required.");if(!s(e.minimumHeight))throw new o("options.minimumHeight is required.");if(!s(e.maximumHeight))throw new o("options.maximumHeight is required.");if(!s(e.maximumHeight))throw new o("options.maximumHeight is required.");if(!s(e.boundingSphere))throw new o("options.boundingSphere is required.");if(!s(e.horizonOcclusionPoint))throw new o("options.horizonOcclusionPoint is required.");if(!s(e.westIndices))throw new o("options.westIndices is required.");if(!s(e.southIndices))throw new o("options.southIndices is required.");if(!s(e.eastIndices))throw new o("options.eastIndices is required.");if(!s(e.northIndices))throw new o("options.northIndices is required.");if(!s(e.westSkirtHeight))throw new o("options.westSkirtHeight is required.");if(!s(e.southSkirtHeight))throw new o("options.southSkirtHeight is required.");if(!s(e.eastSkirtHeight))throw new o("options.eastSkirtHeight is required.");if(!s(e.northSkirtHeight))throw new o("options.northSkirtHeight is required.");this._quantizedVertices=e.quantizedVertices,this._encodedNormals=e.encodedNormals,this._indices=e.indices,this._minimumHeight=e.minimumHeight,this._maximumHeight=e.maximumHeight,this._boundingSphere=e.boundingSphere,this._orientedBoundingBox=e.orientedBoundingBox,this._horizonOcclusionPoint=e.horizonOcclusionPoint,this._credits=e.credits;var i=this._quantizedVertices.length/3,t=this._uValues=this._quantizedVertices.subarray(0,i),n=this._vValues=this._quantizedVertices.subarray(i,2*i);function h(e,i){return n[e]-n[i]}function d(e,i){return t[e]-t[i]}this._heightValues=this._quantizedVertices.subarray(2*i,3*i),this._westIndices=p(e.westIndices,h,i),this._southIndices=p(e.southIndices,d,i),this._eastIndices=p(e.eastIndices,h,i),this._northIndices=p(e.northIndices,d,i),this._westSkirtHeight=e.westSkirtHeight,this._southSkirtHeight=e.southSkirtHeight,this._eastSkirtHeight=e.eastSkirtHeight,this._northSkirtHeight=e.northSkirtHeight,this._childTileMask=r(e.childTileMask,15),this._createdByUpsampling=r(e.createdByUpsampling,!1),this._waterMask=e.waterMask,this._mesh=void 0}h(w.prototype,{credits:{get:function(){return this._credits}},waterMask:{get:function(){return this._waterMask}},childTileMask:{get:function(){return this._childTileMask}},canUpsample:{get:function(){return s(this._mesh)}}});var _=[];function p(e,i,t){_.length=e.length;for(var n=!1,r=0,s=e.length;r<s;++r)_[r]=e[r],n=n||r>0&&i(e[r-1],e[r])>0;return n?(_.sort(i),d.createTypedArray(t,_)):e}var H=new g("createVerticesFromQuantizedTerrainMesh");w.prototype.createMesh=function(t,h,a,u,g){if(!s(t))throw new o("tilingScheme is required.");if(!s(h))throw new o("x is required.");if(!s(a))throw new o("y is required.");if(!s(u))throw new o("level is required.");var w=t.ellipsoid,_=t.tileXYToRectangle(h,a,u);g=r(g,1),this._westSkirtHeight=1e-6,this._southSkirtHeight=1e-6,this._eastSkirtHeight=1e-6,this._northSkirtHeight=1e-6;var p=H.scheduleTask({minimumHeight:this._minimumHeight,maximumHeight:this._maximumHeight,quantizedVertices:this._quantizedVertices,octEncodedNormals:this._encodedNormals,includeWebMercatorT:!0,indices:this._indices,westIndices:this._westIndices,southIndices:this._southIndices,eastIndices:this._eastIndices,northIndices:this._northIndices,westSkirtHeight:this._westSkirtHeight,southSkirtHeight:this._southSkirtHeight,eastSkirtHeight:this._eastSkirtHeight,northSkirtHeight:this._northSkirtHeight,rectangle:_,relativeToCenter:this._boundingSphere.center,ellipsoid:w,exaggeration:g});if(s(p)){var f=this;return e(p,function(e){var t=f._quantizedVertices.length/3;t+=f._westIndices.length+f._southIndices.length+f._eastIndices.length+f._northIndices.length;var s=d.createTypedArray(t,e.indices),h=new Float32Array(e.vertices),o=e.center,a=e.minimumHeight,u=e.maximumHeight,w=r(i.clone(e.boundingSphere),f._boundingSphere),_=r(c.clone(e.orientedBoundingBox),f._orientedBoundingBox),p=n.clone(f._horizonOcclusionPoint),H=e.vertexStride,k=m.clone(e.encoding);return f._skirtIndex=e.skirtIndex,f._vertexCountWithoutSkirts=f._quantizedVertices.length/3,f._mesh=new l(o,h,s,a,u,w,p,H,_,k,g,e.westIndicesSouthToNorth,e.southIndicesEastToWest,e.eastIndicesNorthToSouth,e.northIndicesWestToEast),f._quantizedVertices=void 0,f._encodedNormals=void 0,f._indices=void 0,f._uValues=void 0,f._vValues=void 0,f._heightValues=void 0,f._westIndices=void 0,f._southIndices=void 0,f._eastIndices=void 0,f._northIndices=void 0,f._mesh})}};var f=new g("upsampleQuantizedTerrainMesh");w.prototype.upsample=function(t,r,h,a,u,g,m){if(!s(t))throw new o("tilingScheme is required.");if(!s(r))throw new o("thisX is required.");if(!s(h))throw new o("thisY is required.");if(!s(a))throw new o("thisLevel is required.");if(!s(u))throw new o("descendantX is required.");if(!s(g))throw new o("descendantY is required.");if(!s(m))throw new o("descendantLevel is required.");if(m-a>1)throw new o("Upsampling through more than one level at a time is not currently supported.");var l=this._mesh;if(s(this._mesh)){var _=2*r!==u,p=2*h===g,H=t.ellipsoid,k=t.tileXYToRectangle(u,g,m),v=f.scheduleTask({vertices:l.vertices,vertexCountWithoutSkirts:this._vertexCountWithoutSkirts,indices:l.indices,skirtIndex:this._skirtIndex,encoding:l.encoding,minimumHeight:this._minimumHeight,maximumHeight:this._maximumHeight,isEastChild:_,isNorthChild:p,childRectangle:k,ellipsoid:H,exaggeration:l.exaggeration});if(s(v)){var S=Math.min(this._westSkirtHeight,this._eastSkirtHeight);S=Math.min(S,this._southSkirtHeight),S=Math.min(S,this._northSkirtHeight);var I=_?.5*S:this._westSkirtHeight,x=p?.5*S:this._southSkirtHeight,q=_?this._eastSkirtHeight:.5*S,y=p?this._northSkirtHeight:.5*S,T=this._credits;return e(v).then(function(e){var t,r=new Uint16Array(e.vertices),h=d.createTypedArray(r.length/3,e.indices);return s(e.encodedNormals)&&(t=new Uint8Array(e.encodedNormals)),new w({quantizedVertices:r,indices:h,encodedNormals:t,minimumHeight:e.minimumHeight,maximumHeight:e.maximumHeight,boundingSphere:i.clone(e.boundingSphere),orientedBoundingBox:c.clone(e.orientedBoundingBox),horizonOcclusionPoint:n.clone(e.horizonOcclusionPoint),westIndices:e.westIndices,southIndices:e.southIndices,eastIndices:e.eastIndices,northIndices:e.northIndices,westSkirtHeight:I,southSkirtHeight:x,eastSkirtHeight:q,northSkirtHeight:y,childTileMask:0,credits:T,createdByUpsampling:!0})})}}};var k=32767,v=new n;function S(e,i,t,n,r,s,h,o){var d=Math.min(t,r,h),a=Math.max(t,r,h),u=Math.min(n,s,o),c=Math.max(n,s,o);return e>=d&&e<=a&&i>=u&&i<=c}w.prototype.interpolateHeight=function(e,i,t){var n=u.clamp((i-e.west)/e.width,0,1);n*=k;var r=u.clamp((t-e.south)/e.height,0,1);return r*=k,s(this._mesh)?function(e,i,t){for(var n=e._mesh,r=n.vertices,s=n.encoding,h=n.indices,o=0,d=h.length;o<d;o+=3){var u=h[o],c=h[o+1],g=h[o+2],m=s.decodeTextureCoordinates(r,u,I),l=s.decodeTextureCoordinates(r,c,x),w=s.decodeTextureCoordinates(r,g,q);if(S(i,t,m.x,m.y,l.x,l.y,w.x,w.y)){var _=a.computeBarycentricCoordinates(i,t,m.x,m.y,l.x,l.y,w.x,w.y,v);if(_.x>=-1e-15&&_.y>=-1e-15&&_.z>=-1e-15){var p=s.decodeHeight(r,u),H=s.decodeHeight(r,c),f=s.decodeHeight(r,g);return _.x*p+_.y*H+_.z*f}}}return}(this,n,r):function(e,i,t){for(var n=e._uValues,r=e._vValues,s=e._heightValues,h=e._indices,o=0,d=h.length;o<d;o+=3){var c=h[o],g=h[o+1],m=h[o+2],l=n[c],w=n[g],_=n[m],p=r[c],H=r[g],f=r[m];if(S(i,t,l,p,w,H,_,f)){var I=a.computeBarycentricCoordinates(i,t,l,p,w,H,_,f,v);if(I.x>=-1e-15&&I.y>=-1e-15&&I.z>=-1e-15){var x=I.x*s[c]+I.y*s[g]+I.z*s[m];return u.lerp(e._minimumHeight,e._maximumHeight,x/k)}}}return}(this,n,r)};var I=new t,x=new t,q=new t;return w.prototype.isChildAvailable=function(e,i,t,n){if(!s(e))throw new o("thisX is required.");if(!s(i))throw new o("thisY is required.");if(!s(t))throw new o("childX is required.");if(!s(n))throw new o("childY is required.");var r=2;return t!==2*e&&++r,n!==2*i&&(r-=2),0!=(this._childTileMask&1<<r)},w.prototype.wasCreatedByUpsampling=function(){return this._createdByUpsampling},w});