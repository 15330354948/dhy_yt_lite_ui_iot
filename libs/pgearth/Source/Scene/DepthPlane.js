define(["../Core/BoundingSphere","../Core/Cartesian3","../Core/ComponentDatatype","../Core/defined","../Core/FeatureDetection","../Core/Geometry","../Core/GeometryAttribute","../Core/PrimitiveType","../Renderer/BufferUsage","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArray","../Shaders/DepthPlaneFS","../Shaders/DepthPlaneVS","./SceneMode"],function(e,t,r,o,s,i,a,n,d,p,u,m,h,c,_,l,y,f){"use strict";function v(){this._rs=void 0,this._sp=void 0,this._va=void 0,this._command=void 0,this._mode=void 0,this._useLogDepth=!1}var S=s.supportsTypedArrays()?new Float32Array(12):[],C=new t,g=new t,D=new t,b=new t;return v.prototype.update=function(s){if(this._mode=s.mode,s.mode===f.SCENE3D){var v=s.context,L=s.mapProjection.ellipsoid,w=s.useLogDepth;if(o(this._command)||(this._rs=m.fromCache({cull:{enabled:!0},depthTest:{enabled:!0},colorMask:{red:!1,green:!1,blue:!1,alpha:!1}}),this._command=new p({renderState:this._rs,boundingVolume:new e(t.ZERO,L.maximumRadius),pass:u.OPAQUE,owner:this})),!o(this._sp)||this._useLogDepth!==w){this._useLogDepth=w;var A=new c({sources:[y]}),P=new c({sources:[l]});if(w){P.sources.push("#ifdef GL_EXT_frag_depth \n#extension GL_EXT_frag_depth : enable \n#endif \n\n"),P.defines.push("LOG_DEPTH"),A.defines.push("LOG_DEPTH"),A.defines.push("DISABLE_GL_POSITION_LOG_DEPTH")}this._sp=h.replaceCache({shaderProgram:this._sp,context:v,vertexShaderSource:A,fragmentShaderSource:P,attributeLocations:{position:0}}),this._command.shaderProgram=this._sp}var E=function(e,r){var o=e.radii,s=r.camera.positionWC,i=t.multiplyComponents(e.oneOverRadii,s,C),a=t.magnitude(i),n=t.normalize(i,g),d=t.normalize(t.cross(t.UNIT_Z,i,D),D),p=t.normalize(t.cross(n,d,b),b),u=Math.sqrt(t.magnitudeSquared(i)-1),m=t.multiplyByScalar(n,1/a,C),h=u/a,c=t.multiplyByScalar(d,h,g),_=t.multiplyByScalar(p,h,D),l=t.add(m,_,b);t.subtract(l,c,l),t.multiplyComponents(o,l,l),t.pack(l,S,0);var y=t.subtract(m,_,b);t.subtract(y,c,y),t.multiplyComponents(o,y,y),t.pack(y,S,3);var f=t.add(m,_,b);t.add(f,c,f),t.multiplyComponents(o,f,f),t.pack(f,S,6);var v=t.subtract(m,_,b);return t.add(v,c,v),t.multiplyComponents(o,v,v),t.pack(v,S,9),S}(L,s);if(o(this._va))this._va.getAttribute(0).vertexBuffer.copyFromArrayView(E);else{var R=new i({attributes:{position:new a({componentDatatype:r.FLOAT,componentsPerAttribute:3,values:E})},indices:[0,1,2,2,1,3],primitiveType:n.TRIANGLES});this._va=_.fromGeometry({context:v,geometry:R,attributeLocations:{position:0},bufferUsage:d.DYNAMIC_DRAW}),this._command.vertexArray=this._va}}},v.prototype.execute=function(e,t){this._mode===f.SCENE3D&&this._command.execute(e,t)},v.prototype.isDestroyed=function(){return!1},v.prototype.destroy=function(){this._sp=this._sp&&this._sp.destroy(),this._va=this._va&&this._va.destroy()},v});