define(["../Core/Cartesian3","../Core/Color","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/IndexDatatype","../Core/Matrix4","../Core/PrimitiveType","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArray","../Shaders/ShadowVolumeFS","../Shaders/VectorTileVS","./BlendingState","./PGEarth3DTileFeature","./ClassificationType","./DepthFunction","./Expression","./StencilConstants","./StencilFunction","./StencilOperation","./Vector3DTileBatch"],function(e,t,r,a,s,n,i,o,c,d,_,h,l,f,u,m,p,I,S,v,C,b,E,T,g,A,P,y,R){"use strict";function L(r){r=a(r,a.EMPTY_OBJECT),this._batchTable=r.batchTable,this._batchIds=r.batchIds,this._positions=r.positions,this._vertexBatchIds=r.vertexBatchIds,this._indices=r.indices,this._indexCounts=r.indexCounts,this._indexOffsets=r.indexOffsets,this._batchedIndices=r.batchedIndices,this._boundingVolume=r.boundingVolume,this._boundingVolumes=r.boundingVolumes,this._center=a(r.center,e.ZERO),this._va=void 0,this._sp=void 0,this._spStencil=void 0,this._spPick=void 0,this._uniformMap=void 0,this._vaSwap=void 0,this._rsStencilPreloadPass=void 0,this._rsStencilPreloadPass3DTiles=void 0,this._rsStencilDepthPass=void 0,this._rsStencilDepthPass3DTiles=void 0,this._rsColorPass=void 0,this._rsPickPass=void 0,this._rsWireframe=void 0,this._commands=[],this._commandsIgnoreShow=[],this._pickCommands=[],this._constantColor=t.clone(t.WHITE),this._highlightColor=this._constantColor,this._batchDirty=!0,this._pickCommandsDirty=!0,this._framesSinceLastRebatch=0,this._updatingAllCommands=!1,this._trianglesLength=this._indices.length/3,this._geometryByteLength=this._indices.byteLength+this._positions.byteLength+this._vertexBatchIds.byteLength,this.debugWireframe=!1,this._debugWireframe=this.debugWireframe,this._wireframeDirty=!1,this.forceRebatch=!1,this.classificationType=a(r.classificationType,E.BOTH),this._vertexShaderSource=r._vertexShaderSource,this._fragmentShaderSource=r._fragmentShaderSource,this._attributeLocations=r._attributeLocations,this._uniformMap=r._uniformMap,this._pickId=r._pickId,this._modelMatrix=r._modelMatrix,this._boundingSphere=r._boundingSphere,this._batchIdLookUp={};for(var s=this._batchIds.length,n=0;n<s;++n){var i=this._batchIds[n];this._batchIdLookUp[i]=n}}n(L.prototype,{trianglesLength:{get:function(){return this._trianglesLength}},geometryByteLength:{get:function(){return this._geometryByteLength}}});var D={position:0,a_batchId:1};function x(e){var t=e?P.EQUAL:P.ALWAYS;return{colorMask:{red:!1,green:!1,blue:!1,alpha:!1},stencilTest:{enabled:!0,frontFunction:t,frontOperation:{fail:y.KEEP,zFail:y.DECREMENT_WRAP,zPass:y.DECREMENT_WRAP},backFunction:t,backOperation:{fail:y.KEEP,zFail:y.INCREMENT_WRAP,zPass:y.INCREMENT_WRAP},reference:A.PGEARTH_3D_TILE_MASK,mask:A.PGEARTH_3D_TILE_MASK},stencilMask:A.CLASSIFICATION_MASK,depthTest:{enabled:!1},depthMask:!1}}function N(e){var t=e?P.EQUAL:P.ALWAYS;return{colorMask:{red:!1,green:!1,blue:!1,alpha:!1},stencilTest:{enabled:!0,frontFunction:t,frontOperation:{fail:y.KEEP,zFail:y.KEEP,zPass:y.INCREMENT_WRAP},backFunction:t,backOperation:{fail:y.KEEP,zFail:y.KEEP,zPass:y.DECREMENT_WRAP},reference:A.PGEARTH_3D_TILE_MASK,mask:A.PGEARTH_3D_TILE_MASK},stencilMask:A.CLASSIFICATION_MASK,depthTest:{enabled:!0,func:T.LESS_OR_EQUAL},depthMask:!1}}var w={stencilTest:{enabled:!0,frontFunction:P.NOT_EQUAL,frontOperation:{fail:y.KEEP,zFail:y.KEEP,zPass:y.DECREMENT_WRAP},backFunction:P.NOT_EQUAL,backOperation:{fail:y.KEEP,zFail:y.KEEP,zPass:y.DECREMENT_WRAP},reference:0,mask:A.CLASSIFICATION_MASK},stencilMask:A.CLASSIFICATION_MASK,depthTest:{enabled:!1},depthMask:!1,blending:C.ALPHA_BLEND},M={stencilTest:{enabled:!0,frontFunction:P.NOT_EQUAL,frontOperation:{fail:y.KEEP,zFail:y.KEEP,zPass:y.DECREMENT_WRAP},backFunction:P.NOT_EQUAL,backOperation:{fail:y.KEEP,zFail:y.KEEP,zPass:y.DECREMENT_WRAP},reference:0,mask:A.CLASSIFICATION_MASK},stencilMask:A.CLASSIFICATION_MASK,depthTest:{enabled:!1},depthMask:!1};var k=new c,O=new e;function F(e,t,r,a,s,n,i){for(var o=e.constructor.BYTES_PER_ELEMENT,c=n.length,d=0;d<c;++d){var _=i[n[d]],h=a[_],l=s[_],f=new e.constructor(e.buffer,o*h,l);t.set(f,r),a[_]=r,r+=l}return r}function W(e,t,r,a,s,n,i){for(var o=e.bytesPerIndex,c=n.length,d=0;d<c;++d){var _=i[n[d]],h=a[_],l=s[_];t.copyFromBuffer(e,h*o,r*o,l*o),a[_]=r,r+=l}return r}function B(e,t){return t.color.toRgba()-e.color.toRgba()}function V(e,r){if(!e._batchDirty)return!1;for(var a=e._batchedIndices,n=a.length,i=!1,o={},c=0;c<n;++c){var d=a[c].color.toRgba();if(s(o[d])){i=!0;break}o[d]=!0}return i?i&&!e.forceRebatch&&e._framesSinceLastRebatch<120?void++e._framesSinceLastRebatch:(a.sort(B),r.webgl2?function(e,r){var a=e._indexOffsets,s=e._indexCounts,n=e._batchIdLookUp,i=r.pop(),o=[i],c=e._va.indexBuffer,d=e._vaSwap.indexBuffer,_=W(c,d,0,a,s,i.batchIds,n);for(i.offset=0,i.count=_;r.length>0;){var h=r.pop();if(t.equals(h.color,i.color))_=W(c,d,_,a,s,h.batchIds,n),i.batchIds=i.batchIds.concat(h.batchIds),i.count=_-i.offset;else{var l=_;_=W(c,d,_,a,s,h.batchIds,n),h.offset=l,h.count=_-l,o.push(h),i=h}}var f=e._va;e._va=e._vaSwap,e._vaSwap=f,e._batchedIndices=o}(e,a):function(e,r){var a=e._indices,s=e._indexOffsets,n=e._indexCounts,i=e._batchIdLookUp,o=new a.constructor(a.length),c=r.pop(),d=[c],_=F(a,o,0,s,n,c.batchIds,i);for(c.offset=0,c.count=_;r.length>0;){var h=r.pop();if(t.equals(h.color,c.color))_=F(a,o,_,s,n,h.batchIds,i),c.batchIds=c.batchIds.concat(h.batchIds),c.count=_-c.offset;else{var l=_;_=F(a,o,_,s,n,h.batchIds,i),h.offset=l,h.count=_-l,d.push(h),c=h}}e._va.indexBuffer.copyFromArrayView(o),e._indices=o,e._batchedIndices=d}(e,a),e._framesSinceLastRebatch=0,e._batchDirty=!1,e._pickCommandsDirty=!0,e._wireframeDirty=!0,!0):(e._batchDirty=!1,!1)}L.prototype.createFeatures=function(e,t){for(var r=this._batchIds,a=r.length,s=0;s<a;++s){var n=r[s];t[n]=new b(e,n)}},L.prototype.applyDebugSettings=function(e,t){this._highlightColor=e?t:this._constantColor};var H=new t,K=t.WHITE,z=/\$/;function G(e,t,r,a){var n,i,o=e.classificationType,c=o!==E.PGEARTH_3D_TILE,d=o!==E.TERRAIN,_=t.commandList,h=r.length;for(i=0;i<h;++i)c&&((n=r[i]).pass=f.TERRAIN_CLASSIFICATION,_.push(n)),d&&((n=r[i].derivedCommands.tileset).pass=f.PGEARTH_3D_TILE_CLASSIFICATION,_.push(n));if(t.invertClassification&&s(a))for(h=a.length,i=0;i<h;++i)_.push(a[i])}return L.prototype.applyStyle=function(e,r){if(s(e)){var a=e.color,n=a instanceof g&&!z.test(a.expression);this._updatingAllCommands=n;var i,o=this._batchIds,c=o.length;for(i=0;i<c;++i){var d=r[o[i]];d.color=s(e.color)?e.color.evaluateColor(d,H):K,d.show=!s(e.show)||e.show.evaluate(d)}if(n){var _=this._batchedIndices;for(c=_.length,i=0;i<c;++i)_[i].color=t.clone(t.WHITE);this._updatingAllCommands=!1,this._batchDirty=!0}}else!function(e,r){e._updatingAllCommands=!0;var a,s=e._batchIds,n=s.length;for(a=0;a<n;++a){var i=r[s[a]];i.show=!0,i.color=t.WHITE}var o=e._batchedIndices;for(n=o.length,a=0;a<n;++a)o[a].color=t.clone(t.WHITE);e._updatingAllCommands=!1,e._batchDirty=!0}(this,r)},L.prototype.updateCommands=function(e,r){if(!this._updatingAllCommands){var a=this._batchIdLookUp,n=a[e];if(s(n)){var i,o=this._indexOffsets,c=this._indexCounts,d=o[n],_=c[n],h=this._batchedIndices,l=h.length;for(i=0;i<l;++i){var f=h[i].offset,u=h[i].count;if(d>=f&&d<f+u)break}h.push(new R({color:t.clone(r),offset:d,count:_,batchIds:[e]}));for(var m=[],p=[],I=h[i].batchIds,S=I.length,v=0;v<S;++v){var C=I[v];if(C!==e)o[a[C]]<d?m.push(C):p.push(C)}0!==p.length&&h.push(new R({color:t.clone(h[i].color),offset:d+_,count:h[i].offset+h[i].count-(d+_),batchIds:p})),0!==m.length?(h[i].count=d-h[i].offset,h[i].batchIds=m):h.splice(i,1),this._batchDirty=!0}}},L.prototype.update=function(e){var t,n=e.context;!function(e,t){if(!s(e._va)){var a=_.createVertexBuffer({context:t,typedArray:e._positions,usage:h.STATIC_DRAW}),n=_.createVertexBuffer({context:t,typedArray:e._vertexBatchIds,usage:h.STATIC_DRAW}),i=_.createIndexBuffer({context:t,typedArray:e._indices,usage:h.DYNAMIC_DRAW,indexDatatype:2===e._indices.BYTES_PER_ELEMENT?o.UNSIGNED_SHORT:o.UNSIGNED_INT}),c=[{index:0,vertexBuffer:a,componentDatatype:r.fromTypedArray(e._positions),componentsPerAttribute:3},{index:1,vertexBuffer:n,componentDatatype:r.fromTypedArray(e._vertexBatchIds),componentsPerAttribute:1}];e._va=new I({context:t,attributes:c,indexBuffer:i}),t.webgl2&&(e._vaSwap=new I({context:t,attributes:c,indexBuffer:_.createIndexBuffer({context:t,sizeInBytes:i.sizeInBytes,usage:h.DYNAMIC_DRAW,indexDatatype:i.indexDatatype})})),e._batchedPositions=void 0,e._transferrableBatchIds=void 0,e._vertexBatchIds=void 0,e._verticesPromise=void 0}}(this,n),function(e,t){if(!s(e._sp)){var r=e._batchTable,n=a(e._attributeLocations,D),i=e._pickId,o=e._vertexShaderSource,c=e._fragmentShaderSource;if(s(o))return e._sp=m.fromCache({context:t,vertexShaderSource:o,fragmentShaderSource:c,attributeLocations:n}),e._spStencil=e._sp,c=(c=p.replaceMain(c,"czm_non_pick_main"))+"void main() \n{ \n    czm_non_pick_main(); \n    gl_FragColor = "+i+"; \n} \n",void(e._spPick=m.fromCache({context:t,vertexShaderSource:o,fragmentShaderSource:c,attributeLocations:n}));var d=r.getVertexShaderCallback(!1,"a_batchId",void 0)(v),_=r.getFragmentShaderCallback()(S,!1,void 0);i=r.getPickId();var h=new p({sources:[d]}),l=new p({defines:["VECTOR_TILE"],sources:[_]});e._sp=m.fromCache({context:t,vertexShaderSource:h,fragmentShaderSource:l,attributeLocations:n}),h=new p({sources:[v]}),l=new p({defines:["VECTOR_TILE"],sources:[S]}),e._spStencil=m.fromCache({context:t,vertexShaderSource:h,fragmentShaderSource:l,attributeLocations:n}),_=(_=p.replaceMain(_,"czm_non_pick_main"))+"\nvoid main() \n{ \n    czm_non_pick_main(); \n    gl_FragColor = "+i+"; \n} \n";var f=new p({sources:[d]}),u=new p({defines:["VECTOR_TILE"],sources:[_]});e._spPick=m.fromCache({context:t,vertexShaderSource:f,fragmentShaderSource:u,attributeLocations:n})}}(this,n),s((t=this)._rsStencilPreloadPass)||(t._rsStencilPreloadPass=u.fromCache(x(!1)),t._rsStencilPreloadPass3DTiles=u.fromCache(x(!0)),t._rsStencilDepthPass=u.fromCache(N(!1)),t._rsStencilDepthPass3DTiles=u.fromCache(N(!0)),t._rsColorPass=u.fromCache(w),t._rsPickPass=u.fromCache(M)),function(e,t){if(!s(e._uniformMap)){var r={u_modifiedModelViewProjection:function(){var r=t.uniformState.view,a=t.uniformState.projection;return c.clone(r,k),c.multiplyByPoint(k,e._center,O),c.setTranslation(k,O,k),c.multiply(a,k,k),k},u_highlightColor:function(){return e._highlightColor}};e._uniformMap=e._batchTable.getUniformMapCallback()(r)}}(this,n);var i=e.passes;i.render&&(function(e,t){var r=V(e,t),n=e._commands,i=e._batchedIndices,o=i.length,d=3*o;if(!s(n)||r||n.length!==d){n.length=d;for(var _=e._va,h=e._sp,u=a(e._modelMatrix,c.IDENTITY),m=e._uniformMap,p=e._boundingVolume,I=0;I<o;++I){var S=i[I].offset,v=i[I].count,C=n[3*I];s(C)||(C=n[3*I]=new l({owner:e})),C.vertexArray=_,C.modelMatrix=u,C.offset=S,C.count=v,C.renderState=e._rsStencilPreloadPass,C.shaderProgram=h,C.uniformMap=m,C.boundingVolume=p,C.cull=!1,C.pass=f.TERRAIN_CLASSIFICATION;var b=l.shallowClone(C,C.derivedCommands.tileset);b.renderState=e._rsStencilPreloadPass3DTiles,b.pass=f.PGEARTH_3D_TILE_CLASSIFICATION,C.derivedCommands.tileset=b;var E=n[3*I+1];s(E)||(E=n[3*I+1]=new l({owner:e})),E.vertexArray=_,E.modelMatrix=u,E.offset=S,E.count=v,E.renderState=e._rsStencilDepthPass,E.shaderProgram=h,E.uniformMap=m,E.boundingVolume=p,E.cull=!1,E.pass=f.TERRAIN_CLASSIFICATION;var T=l.shallowClone(E,E.derivedCommands.tileset);T.renderState=e._rsStencilDepthPass3DTiles,T.pass=f.PGEARTH_3D_TILE_CLASSIFICATION,E.derivedCommands.tileset=T;var g=n[3*I+2];s(g)||(g=n[3*I+2]=new l({owner:e})),g.vertexArray=_,g.modelMatrix=u,g.offset=S,g.count=v,g.renderState=e._rsColorPass,g.shaderProgram=h,g.uniformMap=m,g.boundingVolume=p,g.cull=!1,g.pass=f.TERRAIN_CLASSIFICATION;var A=l.shallowClone(g,g.derivedCommands.tileset);A.pass=f.PGEARTH_3D_TILE_CLASSIFICATION,g.derivedCommands.tileset=A}e._commandsDirty=!0}}(this,n),function(e,t){if(e.classificationType!==E.TERRAIN&&t.invertClassification&&(!s(e._commandsIgnoreShow)||e._commandsDirty)){for(var r=e._commands,a=e._commandsIgnoreShow,n=e._spStencil,i=r.length,o=a.length=i/3*2,c=0,d=0;d<o;d+=2){var _=a[d]=l.shallowClone(r[c],a[d]);_.shaderProgram=n,_.pass=f.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW,(_=a[d+1]=l.shallowClone(r[c+1],a[d+1])).shaderProgram=n,_.pass=f.PGEARTH_3D_TILE_CLASSIFICATION_IGNORE_SHOW,c+=3}e._commandsDirty=!1}}(this,e),function(e){var t=e.debugWireframe===e._debugWireframe;if(!(t=t&&!(e.debugWireframe&&e._wireframeDirty))){var r,a;s(e._rsWireframe)||(e._rsWireframe=u.fromCache({})),e.debugWireframe?(r=e._rsWireframe,a=d.LINES):(r=e._rsColorPass,a=d.TRIANGLES);for(var n=e._commands,i=n.length,o=0;o<i;o+=3){var c=n[o+2];c.renderState=r,c.primitiveType=a}e._debugWireframe=e.debugWireframe,e._wireframeDirty=!1}}(this),this._debugWireframe?function(e,t){for(var r=e.commandList,a=t.length,s=0;s<a;s+=3){var n=t[s+2];n.pass=f.OPAQUE,r.push(n)}}(e,this._commands):G(this,e,this._commands,this._commandsIgnoreShow)),i.pick&&(!function(e){if(e._pickCommandsDirty){var t=e._indexOffsets.length,r=e._pickCommands;r.length=3*t;for(var n=e._va,i=e._spStencil,o=e._spPick,d=a(e._modelMatrix,c.IDENTITY),_=e._uniformMap,h=0;h<t;++h){var u=e._indexOffsets[h],m=e._indexCounts[h],p=s(e._boundingVolumes)?e._boundingVolumes[h]:e.boundingVolume,I=r[3*h];s(I)||(I=r[3*h]=new l({owner:e,pickOnly:!0})),I.vertexArray=n,I.modelMatrix=d,I.offset=u,I.count=m,I.renderState=e._rsStencilPreloadPass,I.shaderProgram=i,I.uniformMap=_,I.boundingVolume=p,I.pass=f.TERRAIN_CLASSIFICATION;var S=l.shallowClone(I,I.derivedCommands.tileset);S.renderState=e._rsStencilPreloadPass3DTiles,S.pass=f.PGEARTH_3D_TILE_CLASSIFICATION,I.derivedCommands.tileset=S;var v=r[3*h+1];s(v)||(v=r[3*h+1]=new l({owner:e,pickOnly:!0})),v.vertexArray=n,v.modelMatrix=d,v.offset=u,v.count=m,v.renderState=e._rsStencilDepthPass,v.shaderProgram=i,v.uniformMap=_,v.boundingVolume=p,v.pass=f.TERRAIN_CLASSIFICATION;var C=l.shallowClone(v,v.derivedCommands.tileset);C.renderState=e._rsStencilDepthPass3DTiles,C.pass=f.PGEARTH_3D_TILE_CLASSIFICATION,v.derivedCommands.tileset=C;var b=r[3*h+2];s(b)||(b=r[3*h+2]=new l({owner:e,pickOnly:!0})),b.vertexArray=n,b.modelMatrix=d,b.offset=u,b.count=m,b.renderState=e._rsPickPass,b.shaderProgram=o,b.uniformMap=_,b.boundingVolume=p,b.pass=f.TERRAIN_CLASSIFICATION;var E=l.shallowClone(b,b.derivedCommands.tileset);E.pass=f.PGEARTH_3D_TILE_CLASSIFICATION,b.derivedCommands.tileset=E}e._pickCommandsDirty=!1}}(this),G(this,e,this._pickCommands))},L.prototype.isDestroyed=function(){return!1},L.prototype.destroy=function(){return this._va=this._va&&this._va.destroy(),this._sp=this._sp&&this._sp.destroy(),this._spPick=this._spPick&&this._spPick.destroy(),this._vaSwap=this._vaSwap&&this._vaSwap.destroy(),i(this)},L});