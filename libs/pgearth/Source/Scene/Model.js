define(["../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/Check","../Core/clone","../Core/Color","../Core/combine","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/DistanceDisplayCondition","../Core/FeatureDetection","../Core/getAbsoluteUri","../Core/getMagic","../Core/getStringFromTypedArray","../Core/IndexDatatype","../Core/isArray","../Core/loadCRN","../Core/loadImageFromTypedArray","../Core/loadKTX","../Core/Math","../Core/Matrix3","../Core/Matrix4","../Core/PixelFormat","../Core/PrimitiveType","../Core/Quaternion","../Core/Resource","../Core/Transforms","../Core/WebGLConstants","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/Sampler","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/Texture","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","../Renderer/VertexArray","../ThirdParty/GltfPipeline/addDefaults","../ThirdParty/GltfPipeline/addPipelineExtras","../ThirdParty/GltfPipeline/ForEach","../ThirdParty/GltfPipeline/getAccessorByteStride","../ThirdParty/GltfPipeline/hasExtension","../ThirdParty/GltfPipeline/numberOfComponentsForType","../ThirdParty/GltfPipeline/parseGlb","../ThirdParty/GltfPipeline/removePipelineExtras","../ThirdParty/GltfPipeline/updateVersion","../ThirdParty/when","./Axis","./BlendingState","./ClippingPlaneCollection","./ColorBlendMode","./DracoLoader","./getClipAndStyleCode","./getClippingFunction","./HeightReference","./JobType","./ModelAnimationCache","./ModelAnimationCollection","./ModelLoadResources","./ModelMaterial","./ModelMesh","./ModelNode","./ModelUtility","./OctahedralProjectedCubeMap","./processModelMaterialsCommon","./processPbrMaterials","./SceneMode","./ShadowMode"],function(e,t,r,i,n,a,o,s,u,c,l,d,h,m,f,p,_,g,v,x,y,S,C,R,b,M,w,E,T,A,P,L,B,I,N,D,O,q,F,U,V,H,z,k,G,K,W,j,Z,J,Y,X,Q,$,ee,te,re,ie,ne,ae,oe,se,ue,ce,le,de,he,me,fe,pe,_e,ge,ve,xe,ye,Se,Ce){"use strict";if(!_.supportsTypedArrays())return{};var Re=new r,be=ge.ModelState,Me=M.EPSILON16;function we(e,t){e._cachedGltf=t}function Ee(e){this._gltf=e.gltf,this.ready=e.ready,this.modelsToLoad=[],this.count=0}h(Ee.prototype,{gltf:{set:function(e){this._gltf=e},get:function(){return this._gltf}}}),Ee.prototype.makeReady=function(e){this.gltf=e;for(var t=this.modelsToLoad,r=t.length,i=0;i<r;++i){var n=t[i];n.isDestroyed()||we(n,this)}this.modelsToLoad=void 0,this.ready=!0};var Te={},Ae={};function Pe(i){var n,a=(i=l(i,l.EMPTY_OBJECT)).cacheKey;if(this._cacheKey=a,this._cachedGltf=void 0,this._releaseGltfJson=l(i.releaseGltfJson,!1),d(a)&&d(Te[a])&&Te[a].ready)++(n=Te[a]).count;else{var o=i.gltf;if(d(o)){if(o instanceof ArrayBuffer&&(o=new Uint8Array(o)),o instanceof Uint8Array)n=new Ee({gltf:Q(o),ready:!0});else n=new Ee({gltf:i.gltf,ready:!0});n.count=1,d(a)&&(Te[a]=n)}}we(this,n);var u=l(i.basePath,"");this._resource=L.createIfNeeded(u),this.show=l(i.show,!0),this.silhouetteColor=l(i.silhouetteColor,s.RED),this._silhouetteColor=new s,this._silhouetteColorPreviousAlpha=1,this._normalAttributeName=void 0,this.silhouetteSize=l(i.silhouetteSize,0),this.modelMatrix=E.clone(l(i.modelMatrix,E.IDENTITY)),this._modelMatrix=E.clone(this.modelMatrix),this._clampedModelMatrix=void 0,this.scale=l(i.scale,1),this._scale=this.scale,this.minimumPixelSize=l(i.minimumPixelSize,0),this._minimumPixelSize=this.minimumPixelSize,this.maximumScale=i.maximumScale,this._maximumScale=this.maximumScale,this.id=i.id,this._id=i.id,this.heightReference=l(i.heightReference,ce.NONE),this._heightReference=this.heightReference,this._heightChanged=!1,this._removeUpdateHeightCallback=void 0;var c=i.scene;this._scene=c,d(c)&&d(c.terrainProviderChanged)&&(this._terrainProviderChangedCallback=c.terrainProviderChanged.addEventListener(function(){this._heightChanged=!0},this)),this._pickObject=i.pickObject,this._allowPicking=l(i.allowPicking,!0),this._ready=!1,this._readyPromise=te.defer(),this.activeAnimations=new he(this),this.clampAnimations=l(i.clampAnimations,!0),this._defaultTexture=void 0,this._incrementallyLoadTextures=l(i.incrementallyLoadTextures,!0),this._asynchronous=l(i.asynchronous,!0),this.shadows=l(i.shadows,Ce.ENABLED),this._shadows=this.shadows,this.color=l(i.color,s.WHITE),this._color=new s,this._colorPreviousAlpha=1,this.colorBlendMode=l(i.colorBlendMode,ae.HIGHLIGHT),this.colorBlendAmount=l(i.colorBlendAmount,.5),this._colorShadingEnabled=!1,this._clippingPlanes=void 0,this.clippingPlanes=i.clippingPlanes,this._clippingPlanesState=0,this.clippingPlanesOriginMatrix=void 0,this.debugShowBoundingVolume=l(i.debugShowBoundingVolume,!1),this._debugShowBoundingVolume=!1,this.debugWireframe=l(i.debugWireframe,!1),this._debugWireframe=!1,this._distanceDisplayCondition=i.distanceDisplayCondition,this._addBatchIdToGeneratedShaders=i.addBatchIdToGeneratedShaders,this._precreatedAttributes=i.precreatedAttributes,this._vertexShaderLoaded=i.vertexShaderLoaded,this._fragmentShaderLoaded=i.fragmentShaderLoaded,this._uniformMapLoaded=i.uniformMapLoaded,this._pickIdLoaded=i.pickIdLoaded,this._ignoreCommands=l(i.ignoreCommands,!1),this._requestType=i.requestType,this._upAxis=l(i.upAxis,re.Y),this._gltfForwardAxis=re.Z,this._forwardAxis=i.forwardAxis,this.cull=l(i.cull,!0),this.opaquePass=l(i.opaquePass,q.OPAQUE),this._computedModelMatrix=new E,this._clippingPlaneModelViewMatrix=E.clone(E.IDENTITY),this._initialRadius=void 0,this._boundingSphere=void 0,this._scaledBoundingSphere=new e,this._state=be.NEEDS_LOAD,this._loadResources=void 0,this._mode=void 0,this._perNodeShowDirty=!1,this._pgEarthAnimationsDirty=!1,this._dirty=!1,this._maxDirtyNumber=0,this._runtime={animations:void 0,articulationsByName:void 0,articulationsByStageKey:void 0,stagesByKey:void 0,rootNodes:void 0,nodes:void 0,nodesByName:void 0,skinnedNodes:void 0,meshesByName:void 0,materialsByName:void 0,materialsById:void 0},this._uniformMaps={},this._extensionsUsed=void 0,this._extensionsRequired=void 0,this._quantizedUniforms={},this._programPrimitives={},this._rendererResources={buffers:{},vertexArrays:{},programs:{},sourceShaders:{},silhouettePrograms:{},textures:{},samplers:{},renderStates:{}},this._cachedRendererResources=void 0,this._loadRendererResourcesFromCache=!1,this._dequantizeInShader=l(i.dequantizeInShader,!0),this._decodedData={},this._cachedGeometryByteLength=0,this._cachedTexturesByteLength=0,this._geometryByteLength=0,this._texturesByteLength=0,this._trianglesLength=0,this._sourceTechniques={},this._sourcePrograms={},this._quantizedVertexShaders={},this._nodeCommands=[],this._pickIds=[],this._rtcCenter=void 0,this._rtcCenterEye=void 0,this._rtcCenter3D=void 0,this._rtcCenter2D=void 0,this._sourceVersion=void 0,this._sourceKHRTechniquesWebGL=void 0,this._imageBasedLightingFactor=new t(1,1),t.clone(i.imageBasedLightingFactor,this._imageBasedLightingFactor),this._lightColor=r.clone(i.lightColor),this._luminanceAtZenith=void 0,this.luminanceAtZenith=l(i.luminanceAtZenith,.5),this._sphericalHarmonicCoefficients=i.sphericalHarmonicCoefficients,this._specularEnvironmentMaps=i.specularEnvironmentMaps,this._shouldUpdateSpecularMapAtlas=!0,this._specularEnvironmentMapAtlas=void 0,this._useDefaultSphericalHarmonics=!1,this._useDefaultSpecularMaps=!1,this._shouldRegenerateShaders=!1}function Le(e){return e.stencilBuffer}function Be(e){return!s.equals(e.color,s.WHITE)||e.colorBlendMode!==ae.HIGHLIGHT}function Ie(e){var t=e._clippingPlanes;return d(t)&&t.enabled&&0!==t.length}function Ne(e,t,r){if(e._state!==be.LOADED)throw new f("The model is not loaded.  Use Model.readyPromise or wait for Model.ready to be true.");if(!d(r))throw new f("name is required.");return e._runtime[t][r]}h(Pe.prototype,{gltf:{get:function(){return d(this._cachedGltf)?this._cachedGltf.gltf:void 0}},releaseGltfJson:{get:function(){return this._releaseGltfJson}},cacheKey:{get:function(){return this._cacheKey}},basePath:{get:function(){return this._resource.url}},boundingSphere:{get:function(){if(this._state!==be.LOADED)throw new f("The model is not loaded.  Use Model.readyPromise or wait for Model.ready to be true.");var e=this.modelMatrix;this.heightReference!==ce.NONE&&this._clampedModelMatrix&&(e=this._clampedModelMatrix);var t=E.getScale(e,Re),i=d(this.maximumScale)?Math.min(this.maximumScale,this.scale):this.scale;r.multiplyByScalar(t,i,t);var n=this._scaledBoundingSphere;return n.center=r.multiplyComponents(this._boundingSphere.center,t,n.center),n.radius=r.maximumComponent(t)*this._initialRadius,d(this._rtcCenter)&&r.add(this._rtcCenter,n.center,n.center),n}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},asynchronous:{get:function(){return this._asynchronous}},allowPicking:{get:function(){return this._allowPicking}},incrementallyLoadTextures:{get:function(){return this._incrementallyLoadTextures}},pendingTextureLoads:{get:function(){return d(this._loadResources)?this._loadResources.pendingTextureLoads:0}},dirty:{get:function(){return this._dirty}},distanceDisplayCondition:{get:function(){return this._distanceDisplayCondition},set:function(e){if(d(e)&&e.far<=e.near)throw new f("far must be greater than near");this._distanceDisplayCondition=p.clone(e,this._distanceDisplayCondition)}},extensionsUsed:{get:function(){return d(this._extensionsUsed)||(this._extensionsUsed=ge.getUsedExtensions(this.gltf)),this._extensionsUsed}},extensionsRequired:{get:function(){return d(this._extensionsRequired)||(this._extensionsRequired=ge.getRequiredExtensions(this.gltf)),this._extensionsRequired}},upAxis:{get:function(){return this._upAxis}},forwardAxis:{get:function(){return d(this._forwardAxis)?this._forwardAxis:this._gltfForwardAxis}},trianglesLength:{get:function(){return this._trianglesLength}},geometryByteLength:{get:function(){return this._geometryByteLength}},texturesByteLength:{get:function(){return this._texturesByteLength}},cachedGeometryByteLength:{get:function(){return this._cachedGeometryByteLength}},cachedTexturesByteLength:{get:function(){return this._cachedTexturesByteLength}},clippingPlanes:{get:function(){return this._clippingPlanes},set:function(e){e!==this._clippingPlanes&&ne.setOwner(e,this,"_clippingPlanes")}},pickIds:{get:function(){return this._pickIds}},imageBasedLightingFactor:{get:function(){return this._imageBasedLightingFactor},set:function(e){a.typeOf.object("imageBasedLightingFactor",e),a.typeOf.number.greaterThanOrEquals("imageBasedLightingFactor.x",e.x,0),a.typeOf.number.lessThanOrEquals("imageBasedLightingFactor.x",e.x,1),a.typeOf.number.greaterThanOrEquals("imageBasedLightingFactor.y",e.y,0),a.typeOf.number.lessThanOrEquals("imageBasedLightingFactor.y",e.y,1);var r=this._imageBasedLightingFactor;e===r||t.equals(e,r)||(this._shouldRegenerateShaders=this._shouldRegenerateShaders||this._imageBasedLightingFactor.x>0&&0===e.x||0===this._imageBasedLightingFactor.x&&e.x>0,this._shouldRegenerateShaders=this._shouldRegenerateShaders||this._imageBasedLightingFactor.y>0&&0===e.y||0===this._imageBasedLightingFactor.y&&e.y>0,t.clone(e,this._imageBasedLightingFactor))}},lightColor:{get:function(){return this._lightColor},set:function(e){var t=this._lightColor;e===t||r.equals(e,t)||(this._shouldRegenerateShaders=this._shouldRegenerateShaders||d(t)&&!d(e)||d(e)&&!d(t),this._lightColor=r.clone(e,t))}},luminanceAtZenith:{get:function(){return this._luminanceAtZenith},set:function(e){var t=this._luminanceAtZenith;e!==t&&(this._shouldRegenerateShaders=this._shouldRegenerateShaders||d(t)&&!d(e)||d(e)&&!d(t),this._luminanceAtZenith=e)}},sphericalHarmonicCoefficients:{get:function(){return this._sphericalHarmonicCoefficients},set:function(e){if(d(e)&&(!S(e)||9!==e.length))throw new f("sphericalHarmonicCoefficients must be an array of 9 Cartesian3 values.");e!==this._sphericalHarmonicCoefficients&&(this._sphericalHarmonicCoefficients=e,this._shouldRegenerateShaders=!0)}},specularEnvironmentMaps:{get:function(){return this._specularEnvironmentMaps},set:function(e){this._shouldUpdateSpecularMapAtlas=this._shouldUpdateSpecularMapAtlas||e!==this._specularEnvironmentMaps,this._specularEnvironmentMaps=e}}}),Pe.silhouetteSupported=function(e){return Le(e.context)},Pe.fromGltf=function(e){if(!d(e)||!d(e.url))throw new f("options.url is required");var t=e.url;e=o(e);var r=L.createIfNeeded(t),i=l(e.basePath,r.clone()),n=L.createIfNeeded(i),a=l(e.cacheKey,Ae[g(r.url)]);d(a)||(a=c(),Ae[g(r.url)]=a),d(e.basePath)&&!d(e.cacheKey)&&(a+=n.url),e.cacheKey=a,e.basePath=n;var s=new Pe(e),u=Te[a];return d(u)?u.ready||(++u.count,u.modelsToLoad.push(s)):((u=new Ee({ready:!1})).count=1,u.modelsToLoad.push(s),we(s,u),Te[a]=u,d(r.headers.Accept)||(r.headers.Accept="model/gltf-binary,model/gltf+json;q=0.8,application/json;q=0.2,*/*;q=0.01"),r.fetchArrayBuffer().then(function(e){var t=new Uint8Array(e);if("glTF"===v(t)){var r=Q(t);u.makeReady(r)}else{var i=x(t);u.makeReady(JSON.parse(i))}}).otherwise(ge.getFailedLoadFunction(s,"model",r.url))),s},Pe._gltfCache=Te,Pe.prototype.getNode=function(e){var t=Ne(this,"nodesByName",e);return d(t)?t.publicNode:void 0},Pe.prototype.getMesh=function(e){return Ne(this,"meshesByName",e)},Pe.prototype.getMaterial=function(e){return Ne(this,"materialsByName",e)},Pe.prototype.setArticulationStage=function(e,t){a.typeOf.number("value",t);var r=Ne(this,"stagesByKey",e),i=Ne(this,"articulationsByStageKey",e);d(r)&&d(i)&&(t=M.clamp(t,r.minimumValue,r.maximumValue),M.equalsEpsilon(r.currentValue,t,Me)||(r.currentValue=t,i.isDirty=!0))};var De=new r,Oe=new w;function qe(e,t){a.typeOf.object("stage",e),a.typeOf.object("result",t);var r,i=e.currentValue,n=De;switch(e.type){case"xRotate":r=w.fromRotationX(M.toRadians(i),Oe),E.multiplyByMatrix3(t,r,t);break;case"yRotate":r=w.fromRotationY(M.toRadians(i),Oe),E.multiplyByMatrix3(t,r,t);break;case"zRotate":r=w.fromRotationZ(M.toRadians(i),Oe),E.multiplyByMatrix3(t,r,t);break;case"xTranslate":n.x=i,n.y=0,n.z=0,E.multiplyByTranslation(t,n,t);break;case"yTranslate":n.x=0,n.y=i,n.z=0,E.multiplyByTranslation(t,n,t);break;case"zTranslate":n.x=0,n.y=0,n.z=i,E.multiplyByTranslation(t,n,t);break;case"xScale":n.x=i,n.y=1,n.z=1,E.multiplyByScale(t,n,t);break;case"yScale":n.x=1,n.y=i,n.z=1,E.multiplyByScale(t,n,t);break;case"zScale":n.x=1,n.y=1,n.z=i,E.multiplyByScale(t,n,t);break;case"uniformScale":E.multiplyByUniformScale(t,i,t)}return t}var Fe=new E;function Ue(e,t){return function(r){var i=e._loadResources,n=new Uint8Array(r);--i.pendingBufferLoads,e.gltf.buffers[t].extras._pipeline.source=n}}function Ve(e,t){return function(r){var i=e._loadResources;--i.pendingTextureLoads,i.texturesToCreate.enqueue({id:t,image:r,bufferView:r.bufferView,width:r.width,height:r.height,internalFormat:r.internalFormat})}}Pe.prototype.applyArticulations=function(){var e=this._runtime.articulationsByName;for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];if(r.isDirty){r.isDirty=!1;for(var i=r.nodes.length,n=0;n<i;++n){for(var a=r.nodes[n],o=E.clone(a.originalMatrix,Fe),s=r.stages.length,u=0;u<s;++u){o=qe(r.stages[u],o)}a.matrix=o}}}};var He=/(^data:image\/ktx)|(\.ktx$)/i,ze=/(^data:image\/crn)|(\.crn$)/i;var ke=new E;var Ge=function(){this.id=void 0,this.model=void 0,this.context=void 0};function Ke(e,t,r){var i=t._loadResources,n=t.gltf.bufferViews[e];d(n)||(n=i.createdBufferViews[e]);var a=N.createVertexBuffer({context:r,typedArray:i.getBuffer(n),usage:D.STATIC_DRAW});a.vertexArrayDestroyable=!1,t._rendererResources.buffers[e]=a,t._geometryByteLength+=a.sizeInBytes}Ge.prototype.set=function(e,t,r){this.id=e,this.model=t,this.context=r},Ge.prototype.execute=function(){Ke(this.id,this.model,this.context)};var We=function(){this.id=void 0,this.componentType=void 0,this.model=void 0,this.context=void 0};function je(e,t,r,i){var n=r._loadResources,a=r.gltf.bufferViews[e];d(a)||(a=n.createdBufferViews[e]);var o=N.createIndexBuffer({context:i,typedArray:n.getBuffer(a),usage:D.STATIC_DRAW,indexDatatype:t});o.vertexArrayDestroyable=!1,r._rendererResources.buffers[e]=o,r._geometryByteLength+=o.sizeInBytes}We.prototype.set=function(e,t,r,i){this.id=e,this.componentType=t,this.model=r,this.context=i},We.prototype.execute=function(){je(this.id,this.componentType,this.model,this.context)};var Ze=new Ge,Je=new We;function Ye(e,t){var r=e._runtime.materialsById[t.material];if(d(r))return r._program}function Xe(e,t,r){var i,n,a,o=r._programPrimitives[t];if(!d(o))return e;for(n in o)if(o.hasOwnProperty(n)&&Ye(r,i=o[n])===t)break;if(r._programPrimitives[t]=void 0,r.extensionsUsed.WEB3D_quantized_attributes)a=ge.modifyShaderForQuantizedAttributes(r.gltf,i,e),r._quantizedUniforms[t]=a.uniforms;else{var s=r._decodedData[n];if(!d(s))return e;a=ge.modifyShaderForDracoQuantizedAttributes(r.gltf,i,e,s.attributes)}return a.shader}function Qe(e,t,r){return d(r)&&(e=r(e,t)),e}var $e=function(){this.programToCreate=void 0,this.model=void 0,this.context=void 0};function et(e,t,r){var i=e.programId,n=e.techniqueId,a=t._sourcePrograms[i],o=t._rendererResources.sourceShaders,s=o[a.vertexShader],u=o[a.fragmentShader],c=t._quantizedVertexShaders,l=t._toClipCoordinatesGLSL[i];if(t.extensionsUsed.WEB3D_quantized_attributes||t._dequantizeInShader){var h=c[i];d(h)||(h=Xe(s,i,t),c[i]=h),s=h}var m=Qe(s,i,t._vertexShaderLoaded),f=Qe(u,i,t._fragmentShaderLoaded);_.isInternetExplorer()||(m=ge.modifyVertexShaderForLogDepth(m,l),f=ge.modifyFragmentShaderForLogDepth(f)),d(t._uniformMapLoaded)||(f="uniform vec4 czm_pickColor;\n"+f);var p=t._imageBasedLightingFactor.x>0||t._imageBasedLightingFactor.y>0;if(p&&(f="#define USE_IBL_LIGHTING \n\n"+f),d(t._lightColor)&&(f="#define USE_CUSTOM_LIGHT_COLOR \n\n"+f),("2.0"!==t._sourceVersion||t._sourceKHRTechniquesWebGL)&&(f=H.replaceMain(f,"non_gamma_corrected_main"),f+="\nvoid main() { \n    non_gamma_corrected_main(); \n    gl_FragColor = czm_gammaCorrect(gl_FragColor); \n} \n"),ve.isSupported(r)){var g=d(t._sphericalHarmonicCoefficients)||t._useDefaultSphericalHarmonics,v=d(t._specularEnvironmentMapAtlas)&&t._specularEnvironmentMapAtlas.ready||t._useDefaultSpecularMaps;(g||v||p)&&(f="uniform mat4 gltf_clippingPlanesMatrix; \n"+f),d(t._sphericalHarmonicCoefficients)?f="#define DIFFUSE_IBL \n#define CUSTOM_SPHERICAL_HARMONICS \nuniform vec3 gltf_sphericalHarmonicCoefficients[9]; \n"+f:t._useDefaultSphericalHarmonics&&(f="#define DIFFUSE_IBL \n"+f),d(t._specularEnvironmentMapAtlas)&&t._specularEnvironmentMapAtlas.ready?f="#define SPECULAR_IBL \n#define CUSTOM_SPECULAR_IBL \nuniform sampler2D gltf_specularMap; \nuniform vec2 gltf_specularMapSize; \nuniform float gltf_maxSpecularLOD; \n"+f:t._useDefaultSpecularMaps&&(f="#define SPECULAR_IBL \n"+f)}d(t._luminanceAtZenith)&&(f="#define USE_SUN_LUMINANCE \nuniform float gltf_luminanceAtZenith;\n"+f),rt(i,n,f,m,t,r)}function tt(e,t,r){var i=e.programId,n=e.techniqueId,a=t._sourcePrograms[i],o=t._rendererResources.sourceShaders,s=t._quantizedVertexShaders,u=t._toClipCoordinatesGLSL[i],c=t.clippingPlanes,l=Ie(t),h=o[a.vertexShader],m=o[a.fragmentShader];(t.extensionsUsed.WEB3D_quantized_attributes||t._dequantizeInShader)&&(h=s[i]);var f=m;Be(t)&&(f=Pe._modifyShaderForColor(f)),l&&(f=function(e,t,r){return e=H.replaceMain(e,"gltf_clip_main"),e+=Pe._getClippingFunction(t,r)+"\n",e+="uniform sampler2D gltf_clippingPlanes; \nuniform mat4 gltf_clippingPlanesMatrix; \nuniform vec4 gltf_clippingPlanesEdgeStyle; \nvoid main() \n{ \n    gltf_clip_main(); \n"+se("gltf_clippingPlanes","gltf_clippingPlanesMatrix","gltf_clippingPlanesEdgeStyle")+"} \n"}(f,c,r));var p=Qe(h,i,t._vertexShaderLoaded),g=Qe(f,i,t._fragmentShaderLoaded);_.isInternetExplorer()||(p=ge.modifyVertexShaderForLogDepth(p,u),g=ge.modifyFragmentShaderForLogDepth(g)),d(t._uniformMapLoaded)||(g="uniform vec4 czm_pickColor;\n"+g);var v=t._imageBasedLightingFactor.x>0||t._imageBasedLightingFactor.y>0;if(v&&(g="#define USE_IBL_LIGHTING \n\n"+g),d(t._lightColor)&&(g="#define USE_CUSTOM_LIGHT_COLOR \n\n"+g),("2.0"!==t._sourceVersion||t._sourceKHRTechniquesWebGL)&&(g=H.replaceMain(g,"non_gamma_corrected_main"),g+="\nvoid main() { \n    non_gamma_corrected_main(); \n    gl_FragColor = czm_gammaCorrect(gl_FragColor); \n} \n"),ve.isSupported(r)){var x=d(t._sphericalHarmonicCoefficients)||t._useDefaultSphericalHarmonics,y=d(t._specularEnvironmentMapAtlas)&&t._specularEnvironmentMapAtlas.ready||t._useDefaultSpecularMaps;!l&&(x||y||v)&&(g="uniform mat4 gltf_clippingPlanesMatrix; \n"+g),d(t._sphericalHarmonicCoefficients)?g="#define DIFFUSE_IBL \n#define CUSTOM_SPHERICAL_HARMONICS \nuniform vec3 gltf_sphericalHarmonicCoefficients[9]; \n"+g:t._useDefaultSphericalHarmonics&&(g="#define DIFFUSE_IBL \n"+g),d(t._specularEnvironmentMapAtlas)&&t._specularEnvironmentMapAtlas.ready?g="#define SPECULAR_IBL \n#define CUSTOM_SPECULAR_IBL \nuniform sampler2D gltf_specularMap; \nuniform vec2 gltf_specularMapSize; \nuniform float gltf_maxSpecularLOD; \n"+g:t._useDefaultSpecularMaps&&(g="#define SPECULAR_IBL \n"+g)}d(t._luminanceAtZenith)&&(g="#define USE_SUN_LUMINANCE \nuniform float gltf_luminanceAtZenith;\n"+g),rt(i,n,g,p,t,r)}function rt(e,t,r,i,n,a){var o=n._sourceTechniques[t],s=ge.createAttributeLocations(o,n._precreatedAttributes);n._rendererResources.programs[e]=V.fromCache({context:a,vertexShaderSource:i,fragmentShaderSource:r,attributeLocations:s})}$e.prototype.set=function(e,t,r){this.programToCreate=e,this.model=t,this.context=r},$e.prototype.execute=function(){et(this.programToCreate,this.model,this.context)};var it=new $e;function nt(e,t){return function(r){e.texturesToCreate.enqueue({id:t.id,image:r,bufferView:void 0}),--e.pendingBufferViewToImage}}var at=function(){this.gltfTexture=void 0,this.model=void 0,this.context=void 0};function ot(e,t,r){var i=t.gltf.textures[e.id],n=t._rendererResources.samplers[i.sampler];d(n)||(n=new U({wrapS:G.REPEAT,wrapT:G.REPEAT}));for(var a=!1,o=t.gltf.materials,s=o.length,u=0;u<s;++u){var c=o[u];if(d(c.extensions)&&d(c.extensions.KHR_techniques_webgl)){var l=c.extensions.KHR_techniques_webgl.values;for(var h in l)if(l.hasOwnProperty(h)&&-1!==h.indexOf("Texture")){var m=l[h];if(m.index===e.id&&d(m.extensions)&&d(m.extensions.KHR_texture_transform)){a=!0;break}}}if(a)break}var f=n.wrapS,p=n.wrapT,_=n.minificationFilter;a&&_!==k.LINEAR&&_!==k.NEAREST&&(_=_===k.NEAREST_MIPMAP_NEAREST||_===k.NEAREST_MIPMAP_LINEAR?k.NEAREST:k.LINEAR,n=new U({wrapS:n.wrapS,wrapT:n.wrapT,textureMinificationFilter:_,textureMagnificationFilter:n.magnificationFilter}));var g,v=e.internalFormat,x=!(d(v)&&T.isCompressedFormat(v)||_!==k.NEAREST_MIPMAP_NEAREST&&_!==k.NEAREST_MIPMAP_LINEAR&&_!==k.LINEAR_MIPMAP_NEAREST&&_!==k.LINEAR_MIPMAP_LINEAR),y=x||f===G.REPEAT||f===G.MIRRORED_REPEAT||p===G.REPEAT||p===G.MIRRORED_REPEAT,S=e.image;if(d(v))g=new z({context:r,source:{arrayBufferView:e.bufferView},width:e.width,height:e.height,pixelFormat:v,sampler:n});else if(d(S)){var C=!M.isPowerOfTwo(S.width)||!M.isPowerOfTwo(S.height);if(y&&C){var R=document.createElement("canvas");R.width=M.nextPowerOfTwo(S.width),R.height=M.nextPowerOfTwo(S.height),R.getContext("2d").drawImage(S,0,0,S.width,S.height,0,0,R.width,R.height),S=R}g=new z({context:r,source:S,pixelFormat:i.internalFormat,pixelDatatype:i.type,sampler:n,flipY:!1}),x&&g.generateMipmap()}d(g)&&(t._rendererResources.textures[e.id]=g,t._texturesByteLength+=g.sizeInBytes)}at.prototype.set=function(e,t,r){this.gltfTexture=e,this.model=t,this.context=r},at.prototype.execute=function(){ot(this.gltfTexture,this.model,this.context)};var st=new at;function ut(e,t){for(var r=e.length,i={},n=0;n<r;++n)for(var a=[e[n]];a.length>0;){var o=a.pop(),s=t[o];d(s)&&(i[o]=o);var u=s.children;if(d(u))for(var c=u.length,l=0;l<c;++l)a.push(u[l])}return i}function ct(e){var t=e._loadResources;if(0===t.pendingBufferLoads&&t.createSkins){t.createSkins=!1;var r=e.gltf,i=r.accessors,n={};Z.skin(r,function(t,r){var a,o=i[t.inverseBindMatrices];E.equals(t.bindShapeMatrix,E.IDENTITY)||(a=E.clone(t.bindShapeMatrix)),n[r]={inverseBindMatrices:de.getSkinInverseBindMatrices(e,o),bindShapeMatrix:a}}),function(e,t){for(var r=e.gltf,i=r.skins,n=r.nodes,a=e._runtime.nodes,o=e._loadResources.skinnedNodesIds,s=o.length,u=0;u<s;++u){var c=o[u],l=a[c],h=n[c],m=t[h.skin];l.inverseBindMatrices=m.inverseBindMatrices,l.bindShapeMatrix=m.bindShapeMatrix;var f=[],p=i[h.skin];d(p.skeleton)&&f.push(p.skeleton);for(var _=ut(f,n),g=i[h.skin].joints,v=g.length,x=0;x<v;++x){var y=a[_[g[x]]];l.joints.push(y)}}}(e,n)}}function lt(e,t,r,i){return function(n){d(i)&&(n=e.clampAnimations?i.clampTime(n):i.wrapTime(n),t[r]=i.evaluate(n,t[r]),t.dirtyNumber=e._maxDirtyNumber)}}function dt(e,t){var r=e._loadResources;if(r.finishedBuffersCreation()&&r.finishedProgramCreation()&&r.createVertexArrays){r.createVertexArrays=!1;var i=e._rendererResources.buffers,n=e._rendererResources.vertexArrays,a=e.gltf,o=a.accessors;Z.mesh(a,function(r,s){Z.meshPrimitive(r,function(r,u){var c,l,h,m=[],f=function(e,t){var r,i,n=e._sourceTechniques,a={},o=e._runtime.materialsById[t.material];if(!d(o))return a;var s=n[o._technique];if(!d(s))return a;var u=s.attributes,c=e._rendererResources.programs[s.program],l=c.vertexAttributes,h=c._attributeLocations;for(r in l)if(l.hasOwnProperty(r)){var m=u[r];d(m)&&(i=h[r],a[m.semantic]=i)}var f=e._precreatedAttributes;if(d(f))for(r in f)f.hasOwnProperty(r)&&(i=h[r],a[r]=i);return a}(e,r),p=e._decodedData[s+".primitive."+u];Z.meshPrimitiveAttribute(r,function(e,t){if(c=f[t],d(c)){if(d(p)){var r=p.attributes;if(r.hasOwnProperty(t)){var n=r[t];return void m.push({index:c,vertexBuffer:i[n.bufferView],componentsPerAttribute:n.componentsPerAttribute,componentDatatype:n.componentDatatype,normalize:n.normalized,offsetInBytes:n.byteOffset,strideInBytes:n.byteStride})}}var s=o[e],u=d(s.normalized)&&s.normalized;m.push({index:c,vertexBuffer:i[s.bufferView],componentsPerAttribute:X(s.type),componentDatatype:s.componentType,normalize:u,offsetInBytes:s.byteOffset,strideInBytes:J(a,s)})}});var _,g=e._precreatedAttributes;if(d(g))for(h in g)g.hasOwnProperty(h)&&(c=f[h],d(c)&&((l=g[h]).index=c,m.push(l)));if(d(r.indices)){var v=o[r.indices].bufferView;d(p)&&(v=p.bufferView),_=i[v]}n[s+".primitive."+u]=new K({context:t,attributes:m,indexBuffer:_})})})}}function ht(e){var t=e._loadResources;t.createRenderStates&&(t.createRenderStates=!1,Z.material(e.gltf,function(t,r){!function(e,t,r){var i=e._rendererResources.renderStates,n=[I.FUNC_ADD,I.FUNC_ADD],a=[I.ONE,I.ONE_MINUS_SRC_ALPHA,I.ONE,I.ONE_MINUS_SRC_ALPHA];d(t.extensions)&&d(t.extensions.KHR_blend)&&(n=t.extensions.KHR_blend.blendEquation,a=t.extensions.KHR_blend.blendFactors);var o=!t.doubleSided,s="BLEND"===t.alphaMode;i[r]=F.fromCache({cull:{enabled:o},depthTest:{enabled:!0},depthMask:!s,blending:{enabled:s,equationRgb:n[0],equationAlpha:n[1],functionSourceRgb:a[0],functionDestinationRgb:a[1],functionSourceAlpha:a[2],functionDestinationAlpha:a[3]}})}(e,t,r)}))}var mt={MODEL:function(e,t,r){return function(){return r.computedMatrix}},VIEW:function(e,t,r){return function(){return e.view}},PROJECTION:function(e,t,r){return function(){return e.projection}},MODELVIEW:function(e,t,r){var i=new E;return function(){return E.multiplyTransformation(e.view,r.computedMatrix,i)}},PGEARTH_RTC_MODELVIEW:function(e,t,r){var i=new E;return function(){return E.multiplyTransformation(e.view,r.computedMatrix,i),E.setTranslation(i,t._rtcCenterEye,i)}},MODELVIEWPROJECTION:function(e,t,r){var i=new E;return function(){return E.multiplyTransformation(e.view,r.computedMatrix,i),E.multiply(e._projection,i,i)}},MODELINVERSE:function(e,t,r){var i=new E;return function(){return E.inverse(r.computedMatrix,i)}},VIEWINVERSE:function(e,t){return function(){return e.inverseView}},PROJECTIONINVERSE:function(e,t,r){return function(){return e.inverseProjection}},MODELVIEWINVERSE:function(e,t,r){var i=new E,n=new E;return function(){return E.multiplyTransformation(e.view,r.computedMatrix,i),E.inverse(i,n)}},MODELVIEWPROJECTIONINVERSE:function(e,t,r){var i=new E,n=new E;return function(){return E.multiplyTransformation(e.view,r.computedMatrix,i),E.multiply(e._projection,i,i),E.inverse(i,n)}},MODELINVERSETRANSPOSE:function(e,t,r){var i=new E,n=new w;return function(){return E.inverse(r.computedMatrix,i),E.getRotation(i,n),w.transpose(n,n)}},MODELVIEWINVERSETRANSPOSE:function(e,t,r){var i=new E,n=new E,a=new w;return function(){return E.multiplyTransformation(e.view,r.computedMatrix,i),E.inverse(i,n),E.getRotation(n,a),w.transpose(a,a)}},VIEWPORT:function(e,t,r){return function(){return e.viewportCartesian4}}};function ft(e,t,r,i,n,a,o){var s,u,c={},h={};return Z.techniqueUniform(r,function(r,m){var f;if(d(i)&&d(i[m]))f=ge.createUniformFunction(r.type,i[m],a,o),c[m]=f.func,h[m]=f;else if(d(r.node))c[m]=function(e,t,r,i){var n=t._runtime.nodes[e];return mt[r](i,t,n)}(r.node,e,r.semantic,n.uniformState);else if(d(r.semantic))if("JOINTMATRIX"===r.semantic)s=m;else if("MORPHWEIGHTS"===r.semantic)u=m;else if("ALPHACUTOFF"===r.semantic){var p=t.alphaMode;if(d(p)&&"MASK"===p){var _=l(t.alphaCutoff,.5);f=ge.createUniformFunction(r.type,_,a,o),c[m]=f.func,h[m]=f}}else c[m]=ge.getGltfSemanticUniforms()[r.semantic](n.uniformState,e);else if(d(r.value)){var g=ge.createUniformFunction(r.type,r.value,a,o);c[m]=g.func,h[m]=g}}),{map:c,values:h,jointMatrixUniformName:s,morphWeightsUniformName:u}}function pt(e){return ge.createUniformsForDracoQuantizedAttributes(e.attributes)}function _t(e,t){var r=Ye(e,t),i=e._quantizedUniforms[r];return ge.createUniformsForQuantizedAttributes(e.gltf,t,i)}function gt(e){return function(){return e}}function vt(e){return function(){return e.computedJointMatrices}}function xt(e){return function(){return e.weights}}function yt(e){return function(){return e.silhouetteColor}}function St(e){return function(){return e.silhouetteSize}}function Ct(e){return function(){return e.color}}var Rt=new E;function bt(e){return function(){var t=e.clippingPlanes;if(!d(t)&&!d(e._sphericalHarmonicCoefficients)&&!d(e._specularEnvironmentMaps))return E.IDENTITY;var r=d(t)?t.modelMatrix:E.IDENTITY;return E.multiply(e._clippingPlaneModelViewMatrix,r,Rt)}}function Mt(e){return function(){var t=e.clippingPlanes;return d(t)&&t.enabled?t.texture:e._defaultTexture}}function wt(e){return function(){var t=e.clippingPlanes;if(!d(t))return s.WHITE.withAlpha(0);var r=s.clone(t.edgeColor);return r.alpha=t.edgeWidth,r}}function Et(e){return function(){return ae.getColorBlend(e.colorBlendMode,e.colorBlendAmount)}}function Tt(e){return function(){return e._imageBasedLightingFactor}}function At(e){return function(){return e._lightColor}}function Pt(e){return function(){return e.luminanceAtZenith}}function Lt(e){return function(){return e._sphericalHarmonicCoefficients}}function Bt(e){return function(){return e._specularEnvironmentMapAtlas.texture}}function It(e){return function(){return e._specularEnvironmentMapAtlas.texture.dimensions}}function Nt(e){return function(){return e._specularEnvironmentMapAtlas.maximumMipmapLevel}}function Dt(e,t){switch(e.mode){case A.TRIANGLES:return t/3;case A.TRIANGLE_STRIP:case A.TRIANGLE_FAN:return Math.max(t-2,0);default:return 0}}function Ot(t,i,n,a,o){for(var s=t._nodeCommands,c=t._pickIds,l=t.allowPicking,h=t._runtime.meshesByName,m=t._rendererResources,f=m.vertexArrays,p=m.programs,_=m.renderStates,g=t._uniformMaps,v=t.gltf,x=v.accessors,S=v.meshes,C=i.mesh,R=S[C],b=R.primitives,M=b.length,w=0;w<M;++w){var T,A=b[w],P=x[A.indices],L=t._runtime.materialsById[A.material]._program,B=t._decodedData[C+".primitive."+w],I=A.attributes.POSITION;if(d(I)){var N=ge.getAccessorMinMax(v,I);T=e.fromCornerPoints(r.fromArray(N.min),r.fromArray(N.max))}var D,F,U=f[C+".primitive."+w];if(d(B))F=B.numberOfIndices,D=0;else if(d(P))F=P.count,D=P.byteOffset/y.getSizeInBytes(P.componentType);else{F=x[A.attributes.POSITION].count,D=0}t._trianglesLength+=Dt(A,F);var V=g[A.material],H=V.uniformMap;if(d(V.jointMatrixUniformName)){var z={};z[V.jointMatrixUniformName]=vt(n),H=u(H,z)}if(d(V.morphWeightsUniformName)){var k={};k[V.morphWeightsUniformName]=xt(n),H=u(H,k)}H=u(H,{gltf_color:Ct(t),gltf_colorBlend:Et(t),gltf_clippingPlanes:Mt(t),gltf_clippingPlanesEdgeStyle:wt(t),gltf_clippingPlanesMatrix:bt(t),gltf_iblFactor:Tt(t),gltf_lightColor:At(t),gltf_sphericalHarmonicCoefficients:Lt(t),gltf_specularMap:Bt(t),gltf_specularMapSize:It(t),gltf_maxSpecularLOD:Nt(t),gltf_luminanceAtZenith:Pt(t)}),d(t._uniformMapLoaded)&&(H=t._uniformMapLoaded(H,L,n));var G={};t.extensionsUsed.WEB3D_quantized_attributes?G=_t(t,A):t._dequantizeInShader&&d(B)&&(G=pt(B)),H=u(H,G);var K=_[A.material],W=K.blending.enabled,j=t._pickObject;d(j)||(j={primitive:t,id:t.id,node:n.publicNode,mesh:h[R.name]});var Z,J=Ce.castShadows(t._shadows),Y=Ce.receiveShadows(t._shadows);if(l&&!d(t._uniformMapLoaded)){Z=a.createPickId(j),c.push(Z);var X={czm_pickColor:gt(Z.color)};H=u(H,X)}l&&(Z=d(t._pickIdLoaded)&&d(t._uniformMapLoaded)?t._pickIdLoaded():"czm_pickColor");var Q,$=new O({boundingVolume:new e,cull:t.cull,modelMatrix:new E,primitiveType:A.mode,vertexArray:U,count:F,offset:D,shaderProgram:p[L],castShadows:J,receiveShadows:Y,uniformMap:H,renderState:K,owner:j,pass:W?q.TRANSLUCENT:t.opaquePass,pickId:Z});o||((Q=O.shallowClone($)).boundingVolume=new e,Q.modelMatrix=new E);var ee={show:!0,boundingSphere:T,command:$,command2D:Q,silhouetteModelCommand:void 0,silhouetteModelCommand2D:void 0,silhouetteColorCommand:void 0,silhouetteColorCommand2D:void 0,translucentCommand:void 0,translucentCommand2D:void 0,programId:L};n.commands.push(ee),s.push(ee)}}function qt(e,t){var i=t.context,n=t.scene3DOnly,a=e._quantizedVertexShaders,o=e._toClipCoordinatesGLSL={},s=e._sourceTechniques,u=e._sourcePrograms,c=e._rendererResources,l=c.sourceShaders;for(var h in e._loadRendererResourcesFromCache&&(l=c.sourceShaders=e._cachedRendererResources.sourceShaders),s)if(s.hasOwnProperty(h)){var m=s[h].program,f=u[m],p=l[f.vertexShader];if(ge.checkSupportedGlExtensions(f.glExtensions,i),e.extensionsUsed.WEB3D_quantized_attributes||e._dequantizeInShader){var _=a[m];d(_)||(_=Xe(p,m,e),a[m]=_),p=_}p=Qe(p,m,e._vertexShaderLoaded),o[m]=ge.toClipCoordinatesGLSL(e.gltf,p)}if(e._loadRendererResourcesFromCache){var g=e._cachedRendererResources;c.buffers=g.buffers,c.vertexArrays=g.vertexArrays,c.programs=g.programs,c.silhouettePrograms=g.silhouettePrograms,c.textures=g.textures,c.samplers=g.samplers,c.renderStates=g.renderStates,d(e._precreatedAttributes)&&dt(e,i),e._cachedGeometryByteLength+=function(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&(t+=e[r].sizeInBytes);return t}(g.buffers),e._cachedTexturesByteLength+=function(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&(t+=e[r].sizeInBytes);return t}(g.textures)}else!function(e,t){var r=e._loadResources;if(0===r.pendingBufferLoads){var i,n=t.context,a=r.vertexBuffersToCreate,o=r.indexBuffersToCreate;if(e.asynchronous){for(;a.length>0&&(Ze.set(a.peek(),e,n),t.jobScheduler.execute(Ze,le.BUFFER));)a.dequeue();for(;o.length>0&&(i=o.peek(),Je.set(i.id,i.componentType,e,n),t.jobScheduler.execute(Je,le.BUFFER));)o.dequeue()}else{for(;a.length>0;)Ke(a.dequeue(),e,n);for(;o.length>0;)je((i=o.dequeue()).id,i.componentType,e,n)}}}(e,t),function(e,t){var r=e._loadResources,i=r.programsToCreate;if(0===r.pendingShaderLoads&&0===r.pendingBufferLoads){var n=t.context;if(e.asynchronous)for(;i.length>0&&(it.set(i.peek(),e,n),t.jobScheduler.execute(it,le.PROGRAM));)i.dequeue();else for(;i.length>0;)et(i.dequeue(),e,n)}}(e,t),function(e){var t=e._loadResources;if(t.createSamplers){t.createSamplers=!1;var r=e._rendererResources.samplers;Z.sampler(e.gltf,function(e,t){r[t]=new U({wrapS:e.wrapS,wrapT:e.wrapT,minificationFilter:e.minFilter,magnificationFilter:e.magFilter})})}}(e),function(e){var t=e._loadResources;if(0===t.pendingBufferLoads)for(;t.texturesToCreateFromBufferView.length>0;){var r=t.texturesToCreateFromBufferView.dequeue(),i=e.gltf,n=i.bufferViews[r.bufferView],a=(i.textures[r.id].source,ge.getFailedLoadFunction(e,"image","id: "+r.id+", bufferView: "+r.bufferView));if("image/ktx"===r.mimeType)b(t.getBuffer(n)).then(Ve(e,r.id)).otherwise(a),++e._loadResources.pendingTextureLoads;else if("image/crn"===r.mimeType)C(t.getBuffer(n)).then(Ve(e,r.id)).otherwise(a),++e._loadResources.pendingTextureLoads;else{var o=nt(t,r);R({uint8Array:t.getBuffer(n),format:r.mimeType,flipY:!1}).then(o).otherwise(a),++t.pendingBufferViewToImage}}}(e),function(e,t){var r=t.context,i=e._loadResources.texturesToCreate;if(e.asynchronous)for(;i.length>0&&(st.set(i.peek(),e,r),t.jobScheduler.execute(st,le.TEXTURE));)i.dequeue();else for(;i.length>0;)ot(i.dequeue(),e,r)}(e,t);ct(e),function(e){var t=e._loadResources;if(t.finishedPendingBufferLoads()&&t.createRuntimeAnimations){t.createRuntimeAnimations=!1,e._runtime.animations=[];var r=e._runtime.nodes,i=e.gltf.accessors;Z.animation(e.gltf,function(t,n){for(var a=t.channels,o=t.samplers,s=Number.MAX_VALUE,u=-Number.MAX_VALUE,c=a.length,l=new Array(c),d=0;d<c;++d){var h=a[d],m=h.target,f=m.path,p=o[h.sampler],_=de.getAnimationParameterValues(e,i[p.input]),g=de.getAnimationParameterValues(e,i[p.output]);s=Math.min(s,_[0]),u=Math.max(u,_[_.length-1]);var v=de.getAnimationSpline(e,n,t,h.sampler,p,_,f,g);l[d]=lt(e,r[m.node],m.path,v)}e._runtime.animations[n]={name:t.name,startTime:s,stopTime:u,channelEvaluators:l}})}}(e),e._loadRendererResourcesFromCache||(dt(e,i),ht(e)),function(e,t){var r=e._loadResources;if(r.finishedProgramCreation()&&r.createUniformMaps){r.createUniformMaps=!1;var i=e.gltf,n=e._sourceTechniques,a=e._uniformMaps,o=e._rendererResources.textures,s=e._defaultTexture;Z.material(i,function(r,i){var u=e._runtime.materialsById[i],c=n[u._technique],l=u._values,d=ft(e,r,c,l,t,o,s),h=a[i];h.uniformMap=d.map,h.values=d.values,h.jointMatrixUniformName=d.jointMatrixUniformName,h.morphWeightsUniformName=d.morphWeightsUniformName})}}(e,i),function(e,t,i){var n=e._loadResources;if(n.finishedEverythingButTextureCreation()&&n.createRuntimeNodes){n.createRuntimeNodes=!1;for(var a=[],o=e._runtime.nodes,s=e.gltf,u=s.nodes,c=s.skins,l=s.scenes[s.scene].nodes,h=l.length,m=[],f={},p=0;p<h;++p){m.push({parentRuntimeNode:void 0,gltfNode:u[l[p]],id:l[p]});for(var _=[];m.length>0;){var g=m.pop();f[g.id]=!0;var v=g.parentRuntimeNode,x=g.gltfNode,y=o[g.id];if(0===y.parents.length)if(d(x.matrix))y.matrix=E.fromColumnMajorArray(x.matrix);else{var S=x.rotation;y.translation=r.fromArray(x.translation),y.rotation=P.unpack(S),y.scale=r.fromArray(x.scale)}d(v)?(v.children.push(y),y.parents.push(v)):a.push(y),d(x.mesh)&&Ot(e,x,y,t,i);var C=x.children;if(d(C))for(var R=C.length,b=0;b<R;b++){var M=C[b];f[M]||m.push({parentRuntimeNode:y,gltfNode:u[M],id:C[b]})}var w=x.skin;if(d(w)&&_.push(c[w].skeleton),0===m.length)for(var T=0;T<_.length;T++){var A=_[T];f[A]||m.push({parentRuntimeNode:void 0,gltfNode:u[A],id:A})}}}e._runtime.rootNodes=a,e._runtime.nodes=o}}(e,i,n)}function Ft(e,t){var r=e.publicNode,i=r.matrix;r.useMatrix&&d(i)?E.clone(i,t):d(e.matrix)?E.clone(e.matrix,t):(E.fromTranslationQuaternionRotationScale(e.translation,e.rotation,e.scale,t),r.setMatrix(t))}var Ut=[],Vt=new i,Ht=new E;var zt=new E;function kt(e){var t,r,i=O.shallowClone(e);return i.pass=q.TRANSLUCENT,i.renderState=(t=e.renderState,(r=o(t,!0)).cull.enabled=!1,r.depthTest.enabled=!0,r.depthMask=!1,r.blending=ie.ALPHA_BLEND,F.fromCache(r)),i}function Gt(e,t,r){var i=t.scene3DOnly,n=e.color.alpha;if(n>0&&n<1){var a=e._nodeCommands,o=a.length;if(!d(a[0].translucentCommand)||r)for(var s=0;s<o;++s){var u=a[s],c=u.command;if(u.translucentCommand=kt(c),!i){var l=u.command2D;u.translucentCommand2D=kt(l)}}}}function Kt(e,t){var r=e._rendererResources.programs;for(var i in r)if(r.hasOwnProperty(i)&&r[i]===t)return i}function Wt(e,t,r){var i=t.vertexShaderSource.sources[0],n=t._attributeLocations,a=e._normalAttributeName;i=H.replaceMain(i,"gltf_silhouette_main"),i+="uniform float gltf_silhouetteSize; \nvoid main() \n{ \n    gltf_silhouette_main(); \n    vec3 n = normalize(czm_normal3D * "+a+"); \n    n.x *= czm_projection[0][0]; \n    n.y *= czm_projection[1][1]; \n    vec4 clip = gl_Position; \n    clip.xy += n.xy * clip.w * gltf_silhouetteSize / czm_viewport.z; \n    gl_Position = clip; \n}";return V.fromCache({context:r.context,vertexShaderSource:i,fragmentShaderSource:"uniform vec4 gltf_silhouetteColor; \nvoid main() \n{ \n    gl_FragColor = czm_gammaCorrect(gltf_silhouetteColor); \n}",attributeLocations:n})}function jt(e,t){return Le(t.context)&&e.silhouetteSize>0&&e.silhouetteColor.alpha>0&&d(e._normalAttributeName)}function Zt(e){return e.color.alpha>0&&e.color.alpha<1}function Jt(e){return 0===e.color.alpha}function Yt(e,t){return Math.floor(e)!==Math.floor(t)||Math.ceil(e)!==Math.ceil(t)}var Xt=0;function Qt(e,t){for(var r=++Xt%255,i=function(e){for(var t=e._nodeCommands,r=t.length,i=0;i<r;++i)if(t[i].command.pass===q.TRANSLUCENT)return!0;return!1}(e)||Zt(e)||e.silhouetteColor.alpha<1,n=e._rendererResources.silhouettePrograms,a=t.scene3DOnly,s=e._nodeCommands,c=s.length,l=0;l<c;++l){var h=s[l],m=h.command,f=Zt(e)?h.translucentCommand:m,p=O.shallowClone(f),_=o(f.renderState);_.stencilTest={enabled:!0,frontFunction:I.ALWAYS,backFunction:I.ALWAYS,reference:r,mask:-1,frontOperation:{fail:I.KEEP,zFail:I.KEEP,zPass:I.REPLACE},backOperation:{fail:I.KEEP,zFail:I.KEEP,zPass:I.REPLACE}},Jt(e)&&(_.colorMask={red:!1,green:!1,blue:!1,alpha:!1},_.depthMask=!1),_=F.fromCache(_),p.renderState=_,h.silhouetteModelCommand=p;var g=O.shallowClone(m);(_=o(m.renderState,!0)).depthTest.enabled=!0,_.cull.enabled=!1,i&&(g.pass=q.TRANSLUCENT,_.depthMask=!1,_.blending=ie.ALPHA_BLEND),_.stencilTest={enabled:!0,frontFunction:I.NOTEQUAL,backFunction:I.NOTEQUAL,reference:r,mask:-1,frontOperation:{fail:I.KEEP,zFail:I.KEEP,zPass:I.KEEP},backOperation:{fail:I.KEEP,zFail:I.KEEP,zPass:I.KEEP}},_=F.fromCache(_);var v=m.shaderProgram,x=Kt(e,v),y=n[x];d(y)||(y=Wt(e,v,t),n[x]=y);var S=u(m.uniformMap,{gltf_silhouetteColor:yt(e),gltf_silhouetteSize:St(e)});if(g.renderState=_,g.shaderProgram=y,g.uniformMap=S,g.castShadows=!1,g.receiveShadows=!1,h.silhouetteColorCommand=g,!a){var C=h.command2D,R=O.shallowClone(p);R.boundingVolume=C.boundingVolume,R.modelMatrix=C.modelMatrix,h.silhouetteModelCommand2D=R;var b=O.shallowClone(g);R.boundingVolume=C.boundingVolume,R.modelMatrix=C.modelMatrix,h.silhouetteColorCommand2D=b}}}function $t(e,t,r){if(jt(e,t)){var i=e._nodeCommands,n=Yt(e.color.alpha,e._colorPreviousAlpha)||Yt(e.silhouetteColor.alpha,e._silhouetteColorPreviousAlpha)||!d(i[0].silhouetteModelCommand);e._colorPreviousAlpha=e.color.alpha,e._silhouetteColorPreviousAlpha=e.silhouetteColor.alpha,(n||r)&&Qt(e,t)}}var er=new e;var tr=new r,rr=new n;function ir(e,t){var i=e.scale;if(0!==e.minimumPixelSize){var n=t.context,a=Math.max(n.drawingBufferWidth,n.drawingBufferHeight),o=d(e._clampedModelMatrix)?e._clampedModelMatrix:e.modelMatrix;if(tr.x=o[12],tr.y=o[13],tr.z=o[14],d(e._rtcCenter)&&r.add(e._rtcCenter,tr,tr),e._mode!==Se.SCENE3D){var s=t.mapProjection,u=s.ellipsoid.cartesianToCartographic(tr,rr);s.project(u,tr),r.fromElements(tr.z,tr.x,tr.y,tr)}var c=e.boundingSphere.radius,l=function(e,t,r){return er.center=e,er.radius=t,r.camera.getPixelSize(er,r.context.drawingBufferWidth,r.context.drawingBufferHeight)}(tr,c,t),h=1/l;Math.min(h*(2*c),a)<e.minimumPixelSize&&(i=e.minimumPixelSize*l/(2*e._initialRadius))}return d(e.maximumScale)?Math.min(e.maximumScale,i):i}function nr(e){d(e._cacheKey)&&d(e._cachedGltf)&&0==--e._cachedGltf.count&&delete Te[e._cacheKey],e._cachedGltf=void 0}function ar(e,t){this.buffers=void 0,this.vertexArrays=void 0,this.programs=void 0,this.sourceShaders=void 0,this.silhouettePrograms=void 0,this.textures=void 0,this.samplers=void 0,this.renderStates=void 0,this.ready=!1,this.context=e,this.cacheKey=t,this.count=0}function or(e){for(var t in e)e.hasOwnProperty(t)&&e[t].destroy()}function sr(e,t,r){return function(i){if(e.heightReference===ce.RELATIVE_TO_GROUND){var n=t.cartesianToCartographic(i,rr);n.height+=r.height,t.cartographicToCartesian(n,i)}var a=e._clampedModelMatrix;E.clone(e.modelMatrix,a),a[12]=i.x,a[13]=i.y,a[14]=i.z,e._heightChanged=!0}}ar.prototype.release=function(){if(0==--this.count)return d(this.cacheKey)&&delete this.context.cache.modelRendererResourceCache[this.cacheKey],or((e=this).buffers),or(e.vertexArrays),or(e.programs),or(e.silhouettePrograms),or(e.textures),m(this);var e};var ur=new r,cr=new n;function lr(e,t){e.programs!==t.programs&&or(e.programs),e.silhouettePrograms!==t.silhouettePrograms&&or(e.silhouettePrograms)}return Pe.prototype.update=function(t){if(t.mode!==Se.MORPHING)if(_.supportsWebP.initialized){var a=_.supportsWebP(),s=t.context;if(this._defaultTexture=s.defaultTexture,this._state===be.NEEDS_LOAD&&d(this.gltf)){var u,c=this.cacheKey;if(d(c)){s.cache.modelRendererResourceCache=l(s.cache.modelRendererResourceCache,{});var h=s.cache.modelRendererResourceCache;if(u=h[this.cacheKey],d(u)){if(!u.ready)return;++u.count,this._loadRendererResourcesFromCache=!0}else(u=new ar(s,c)).count=1,h[this.cacheKey]=u;this._cachedRendererResources=u}else(u=new ar(s)).count=1,this._cachedRendererResources=u;if(this._state=be.LOADING,this._state!==be.FAILED){var m=this.gltf.extensions;if(d(m)&&d(m.PGEARTH_RTC)){var p=r.fromArray(m.PGEARTH_RTC.center);if(!r.equals(p,r.ZERO)){this._rtcCenter3D=p;var g=t.mapProjection,v=g.ellipsoid.cartesianToCartographic(this._rtcCenter3D),y=g.project(v);r.fromElements(y.z,y.x,y.y,y),this._rtcCenter2D=y,this._rtcCenterEye=new r,this._rtcCenter=this._rtcCenter3D}}j(this.gltf),this._loadResources=new me,this._loadRendererResourcesFromCache||ge.parseBuffers(this,Ue)}}var S=this._loadResources,R=this._incrementallyLoadTextures,w=!1;if(this._state===be.LOADING){if(0===S.pendingBufferLoads){if(!S.initialized){if(t.brdfLutGenerator.update(t),ge.checkSupportedExtensions(this.extensionsRequired,a),ge.updateForwardAxis(this),!d(this.gltf.extras.sourceVersion)){var T=this.gltf;T.extras.sourceVersion=ge.getAssetVersion(T),T.extras.sourceKHRTechniquesWebGL=d(ge.getUsedExtensions(T).KHR_techniques_webgl),this._sourceVersion=T.extras.sourceVersion,this._sourceKHRTechniquesWebGL=T.extras.sourceKHRTechniquesWebGL,ee(T),W(T);var P={addBatchIdToGeneratedShaders:this._addBatchIdToGeneratedShaders};xe(T,P),ye(T,P)}this._sourceVersion=this.gltf.extras.sourceVersion,this._sourceKHRTechniquesWebGL=this.gltf.extras.sourceKHRTechniquesWebGL,this._dequantizeInShader=this._dequantizeInShader&&oe.hasExtension(this),function(e){var t=e.gltf,r=e._loadResources;Z.buffer(t,function(e,t){r.buffers[t]=e.extras._pipeline.source})}(this),function(e){var t={},r={},i={};e._runtime.articulationsByName=t,e._runtime.articulationsByStageKey=r,e._runtime.stagesByKey=i;var n=e.gltf;if(Y(n,"AGI_articulations")&&d(n.extensions)&&d(n.extensions.AGI_articulations)){var a=n.extensions.AGI_articulations.articulations;if(d(a))for(var s=a.length,u=0;u<s;++u){var c=o(a[u]);c.nodes=[],c.isDirty=!0,t[c.name]=c;for(var l=c.stages.length,h=0;h<l;++h){var m=c.stages[h];m.currentValue=m.initialValue;var f=c.name+" "+m.name;r[f]=c,i[f]=m}}}}(this),function(e){var t=e.gltf;if(Y(t,"KHR_techniques_webgl")){var r=e._sourcePrograms,i=e._sourceTechniques,n=t.extensions.KHR_techniques_webgl.programs;Z.technique(t,function(e,t){i[t]=o(e);var a=e.program;d(r[a])||(r[a]=o(n[a]))})}}(this),this._loadRendererResourcesFromCache||(function(e){var t=e.gltf.bufferViews,r=e._loadResources.vertexBuffersToCreate;Z.bufferView(e.gltf,function(e,t){e.target===I.ARRAY_BUFFER&&r.enqueue(t)});var i=e._loadResources.indexBuffersToCreate,n={};Z.accessor(e.gltf,function(e){var r=e.bufferView;d(r)&&(t[r].target!==I.ELEMENT_ARRAY_BUFFER||d(n[r])||(n[r]=!0,i.enqueue({id:r,componentType:e.componentType})))})}(this),function(e){var t=e.gltf,r=t.buffers,i=t.bufferViews,n=e._rendererResources.sourceShaders;Z.shader(t,function(t,a){if(d(t.bufferView)){var o=t.bufferView,s=i[o],u=s.buffer,c=r[u],l=x(c.extras._pipeline.source,s.byteOffset,s.byteLength);n[a]=l}else if(d(t.extras._pipeline.source))n[a]=t.extras._pipeline.source;else{++e._loadResources.pendingShaderLoads;var h=e._resource.getDerivedResource({url:t.uri});h.fetchText().then(function(e,t,r){return function(i){var n=e._loadResources;n.shaders[r]={source:i,type:t,bufferView:void 0},--n.pendingShaderLoads,e._rendererResources.sourceShaders[r]=i}}(e,t.type,a)).otherwise(ge.getFailedLoadFunction(e,"shader",h.url))}})}(this),function(e){var t=e._sourceTechniques;for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];e._loadResources.programsToCreate.enqueue({programId:i.program,techniqueId:r})}}(this),function(e,t,r){var i,n=e.gltf,a=n.images;Z.texture(n,function(n,o){var s=n.source;d(n.extensions)&&d(n.extensions.EXT_texture_webp)&&r&&(s=n.extensions.EXT_texture_webp.source);var u=a[s],c=u.extras,l=u.bufferView,h=u.mimeType;if(i=u.uri,d(c)&&d(c.compressedImage3DTiles)){var m=c.compressedImage3DTiles.crunch,f=c.compressedImage3DTiles.s3tc,p=c.compressedImage3DTiles.pvrtc1,_=c.compressedImage3DTiles.etc1;t.s3tc&&d(m)?(h=m.mimeType,d(m.bufferView)?l=m.bufferView:i=m.uri):t.s3tc&&d(f)?(h=f.mimeType,d(f.bufferView)?l=f.bufferView:i=f.uri):t.pvrtc&&d(p)?(h=p.mimeType,d(p.bufferView)?l=p.bufferView:i=p.uri):t.etc1&&d(_)&&(h=_.mimeType,d(_.bufferView)?l=_.bufferView:i=_.uri)}if(d(l))e._loadResources.texturesToCreateFromBufferView.enqueue({id:o,image:void 0,bufferView:l,mimeType:h});else{++e._loadResources.pendingTextureLoads;var g=e._resource.getDerivedResource({url:i});(He.test(i)?b(g):ze.test(i)?C(g):g.fetchImage()).then(Ve(e,o)).otherwise(ge.getFailedLoadFunction(e,"image",g.url))}})}(this,s,a)),function(e){var t=e.gltf,r=e._sourceTechniques,i={},n={},a=e._uniformMaps;Z.material(t,function(t,s){a[s]={uniformMap:void 0,values:void 0,jointMatrixUniformName:void 0,morphWeightsUniformName:void 0};var u=new fe(e,t,s);if(d(t.extensions)&&d(t.extensions.KHR_techniques_webgl)){var c=t.extensions.KHR_techniques_webgl.technique;u._technique=c,u._program=r[c].program,Z.materialValue(t,function(e,t){d(u._values)||(u._values={}),u._values[t]=o(e)})}i[t.name]=u,n[s]=u}),e._runtime.materialsByName=i,e._runtime.materialsById=n}(this),function(e){var t={},r=e._runtime.materialsById;Z.mesh(e.gltf,function(i,n){t[i.name]=new pe(i,r,n),(d(e.extensionsUsed.WEB3D_quantized_attributes)||e._dequantizeInShader)&&Z.meshPrimitive(i,function(t,r){var i=Ye(e,t),a=e._programPrimitives[i];d(a)||(a={},e._programPrimitives[i]=a),a[n+".primitive."+r]=t})}),e._runtime.meshesByName=t}(this),function(e){var t={},r={},i=[],n=e._loadResources.skinnedNodesIds,a=e._runtime.articulationsByName;Z.node(e.gltf,function(o,s){var u={matrix:void 0,translation:void 0,rotation:void 0,scale:void 0,computedShow:!0,transformToRoot:new E,computedMatrix:new E,dirtyNumber:0,commands:[],inverseBindMatrices:void 0,bindShapeMatrix:void 0,joints:[],computedJointMatrices:[],jointName:o.jointName,weights:[],children:[],parents:[],publicNode:void 0};if(u.publicNode=new _e(e,o,u,s,ge.getTransform(o)),t[s]=u,r[o.name]=u,d(o.skin)&&(n.push(s),i.push(u)),d(o.extensions)&&d(o.extensions.AGI_articulations)){var c=o.extensions.AGI_articulations.articulationName;if(d(c)){var l=E.clone(u.publicNode.originalMatrix,ke),h=a[c];h.nodes.push(u.publicNode);for(var m=h.stages.length,f=0;f<m;++f)l=qe(h.stages[f],l);u.publicNode.matrix=l}}}),e._runtime.nodes=t,e._runtime.nodesByName=r,e._runtime.skinnedNodes=i}(this),oe.parse(this,s),S.initialized=!0}S.finishedDecoding()||oe.decodeModel(this,s).otherwise(ge.getFailedLoadFunction(this,"model",this.basePath)),S.finishedDecoding()&&!S.resourcesParsed&&(this._boundingSphere=ge.computeBoundingSphere(this),this._initialRadius=this._boundingSphere.radius,oe.cacheDataForModel(this),S.resourcesParsed=!0),S.resourcesParsed&&0===S.pendingShaderLoads&&qt(this,t)}(S.finished()||R&&S.finishedEverythingButTextureCreation())&&(this._state=be.LOADED,w=!0)}if(d(S)&&this._state===be.LOADED&&(R&&!w&&qt(this,t),S.finished())){this._loadResources=void 0;var L=this._rendererResources,N=this._cachedRendererResources;N.buffers=L.buffers,N.vertexArrays=L.vertexArrays,N.programs=L.programs,N.sourceShaders=L.sourceShaders,N.silhouettePrograms=L.silhouettePrograms,N.textures=L.textures,N.samplers=L.samplers,N.renderStates=L.renderStates,N.ready=!0,this._normalAttributeName=ge.getAttributeOrUniformBySemantic(this.gltf,"NORMAL"),d(this._precreatedAttributes)&&(N.vertexArrays={}),this.releaseGltfJson&&nr(this)}var D=ve.isSupported(s);if(this._shouldUpdateSpecularMapAtlas&&D){if(this._shouldUpdateSpecularMapAtlas=!1,this._specularEnvironmentMapAtlas=this._specularEnvironmentMapAtlas&&this._specularEnvironmentMapAtlas.destroy(),this._specularEnvironmentMapAtlas=void 0,d(this._specularEnvironmentMaps)){this._specularEnvironmentMapAtlas=new ve(this._specularEnvironmentMaps);var O=this;this._specularEnvironmentMapAtlas.readyPromise.then(function(){O._shouldRegenerateShaders=!0})}this._shouldRegenerateShaders=!0}d(this._specularEnvironmentMapAtlas)&&this._specularEnvironmentMapAtlas.update(t);var q=!d(this._specularEnvironmentMapAtlas)&&d(t.specularEnvironmentMaps)&&!this._useDefaultSpecularMaps,F=!d(t.specularEnvironmentMaps)&&this._useDefaultSpecularMaps,U=!d(this._sphericalHarmonicCoefficients)&&d(t.sphericalHarmonicCoefficients)&&!this._useDefaultSphericalHarmonics,V=!d(t.sphericalHarmonicCoefficients)&&this._useDefaultSphericalHarmonics;this._shouldRegenerateShaders=this._shouldRegenerateShaders||q||F||U||V,this._useDefaultSpecularMaps=!d(this._specularEnvironmentMapAtlas)&&d(t.specularEnvironmentMaps),this._useDefaultSphericalHarmonics=!d(this._sphericalHarmonicCoefficients)&&d(t.sphericalHarmonicCoefficients);var H=jt(this,t),z=Zt(this),k=Jt(this),G=!d(this.distanceDisplayCondition)||function(e,t){var i,n=e.distanceDisplayCondition,a=n.near*n.near,o=n.far*n.far;if(t.mode===Se.SCENE2D)i=.5*(t.camera.frustum.right-t.camera.frustum.left),i*=i;else{var s=E.getTranslation(e.modelMatrix,ur);if(t.mode===Se.COLUMBUS_VIEW){var u=t.mapProjection,c=u.ellipsoid.cartesianToCartographic(s,cr);s=u.project(c,s),r.fromElements(s.z,s.x,s.y,s)}i=r.distanceSquared(s,t.camera.positionWC)}return i>=a&&i<=o}(this,t),K=this.show&&G&&0!==this.scale&&(!k||H);if(K&&this._state===be.LOADED||w){var J=this.activeAnimations.update(t)||this._pgEarthAnimationsDirty;this._pgEarthAnimationsDirty=!1,this._dirty=!1;var X=this.modelMatrix,Q=t.mode!==this._mode;this._mode=t.mode;var $=!E.equals(this._modelMatrix,X)||this._scale!==this.scale||this._minimumPixelSize!==this.minimumPixelSize||0!==this.minimumPixelSize||this._maximumScale!==this.maximumScale||this._heightReference!==this.heightReference||this._heightChanged||Q;if($||w){E.clone(X,this._modelMatrix),function(e){d(e._removeUpdateHeightCallback)&&(e._removeUpdateHeightCallback(),e._removeUpdateHeightCallback=void 0);var t=e._scene;if(d(t)&&d(t.globe)&&e.heightReference!==ce.NONE){var r=t.globe,i=r.ellipsoid,a=e.modelMatrix;tr.x=a[12],tr.y=a[13],tr.z=a[14];var o=i.cartesianToCartographic(tr);d(e._clampedModelMatrix)||(e._clampedModelMatrix=E.clone(a,new E));var s=r._surface;e._removeUpdateHeightCallback=s.updateHeight(o,sr(e,i,o));var u=r.getHeight(o);if(d(u)){var c=sr(e,i,o);n.clone(o,rr),rr.height=u,i.cartographicToCartesian(rr,tr),c(tr)}}else{if(e.heightReference!==ce.NONE)throw new f("Height reference is not supported without a scene and globe.");e._clampedModelMatrix=void 0}}(this),d(this._clampedModelMatrix)&&(X=this._clampedModelMatrix),this._scale=this.scale,this._minimumPixelSize=this.minimumPixelSize,this._maximumScale=this.maximumScale,this._heightReference=this.heightReference,this._heightChanged=!1;var te=ir(this,t),ie=this._computedModelMatrix;E.multiplyByUniformScale(X,te,ie),this._upAxis===re.Y?E.multiplyTransformation(ie,re.Y_UP_TO_Z_UP,ie):this._upAxis===re.X&&E.multiplyTransformation(ie,re.X_UP_TO_Z_UP,ie),this.forwardAxis===re.Z&&E.multiplyTransformation(ie,re.Z_UP_TO_X_UP,ie)}(J||$||w)&&(function(t,n,a,o){var s=t._maxDirtyNumber,u=t._runtime.rootNodes,c=u.length,l=Ut,h=t._computedModelMatrix;if(t._mode!==Se.SCENE3D&&!t._ignoreCommands){var m=E.getColumn(h,3,Vt);if(i.equals(m,i.UNIT_W)){var f=t.boundingSphere.center,p=B.wgs84To2DModelMatrix(o,f,Ht);h=E.multiply(p,h,Ht),d(t._rtcCenter)&&(E.setTranslation(h,i.UNIT_W,h),t._rtcCenter=t._rtcCenter2D)}else h=B.basisTo2D(o,h,Ht),t._rtcCenter=t._rtcCenter3D}for(var _=0;_<c;++_){var g=u[_];for(Ft(g,g.transformToRoot),l.push(g);l.length>0;){var v=(g=l.pop()).transformToRoot,x=g.commands;if(g.dirtyNumber===s||n||a){var y=E.multiplyTransformation(h,v,g.computedMatrix),S=x.length;if(S>0)for(var C=0;C<S;++C){var R=x[C],b=R.command;E.clone(y,b.modelMatrix),e.transform(R.boundingSphere,b.modelMatrix,b.boundingVolume),d(t._rtcCenter)&&r.add(t._rtcCenter,b.boundingVolume.center,b.boundingVolume.center),b=R.command2D,d(b)&&t._mode===Se.SCENE2D&&(E.clone(y,b.modelMatrix),b.modelMatrix[13]-=2*M.sign(b.modelMatrix[13])*M.PI*o.ellipsoid.maximumRadius,e.transform(R.boundingSphere,b.modelMatrix,b.boundingVolume))}}var w=g.children;if(d(w))for(var T=w.length,A=0;A<T;++A){var P=w[A];P.dirtyNumber=Math.max(P.dirtyNumber,g.dirtyNumber),(P.dirtyNumber===s||a)&&(Ft(P,P.transformToRoot),E.multiplyTransformation(v,P.transformToRoot,P.transformToRoot)),l.push(P)}}}++t._maxDirtyNumber}(this,$,w,t.mapProjection),this._dirty=!0,(J||w)&&function(e){for(var t=e._runtime.skinnedNodes,r=t.length,i=0;i<r;++i){var n=t[i];zt=E.inverseTransformation(n.transformToRoot,zt);for(var a=n.computedJointMatrices,o=n.joints,s=n.bindShapeMatrix,u=n.inverseBindMatrices,c=u.length,l=0;l<c;++l)d(a[l])||(a[l]=new E),a[l]=E.multiplyTransformation(zt,o[l].transformToRoot,a[l]),a[l]=E.multiplyTransformation(a[l],u[l],a[l]),d(s)&&(a[l]=E.multiplyTransformation(a[l],s,a[l]))}}(this)),this._perNodeShowDirty&&(this._perNodeShowDirty=!1,function(e){for(var t=e._runtime.rootNodes,r=t.length,i=Ut,n=0;n<r;++n){var a=t[n];for(a.computedShow=a.publicNode.show,i.push(a);i.length>0;){for(var o=(a=i.pop()).computedShow,s=a.commands,u=s.length,c=0;c<u;++c)s[c].show=o;var l=a.children;if(d(l))for(var h=l.length,m=0;m<h;++m){var f=l[m];f.computedShow=o&&f.publicNode.show,i.push(f)}}}}(this)),function(e,t){var r=e.id;if(e._id!==r){e._id=r;for(var i=e._pickIds,n=i.length,a=0;a<n;++a)i[a].object.id=r}}(this),function(e){if(e._debugWireframe!==e.debugWireframe){e._debugWireframe=e.debugWireframe;for(var t=e.debugWireframe?A.LINES:A.TRIANGLES,r=e._nodeCommands,i=r.length,n=0;n<i;++n)r[n].command.primitiveType=t}}(this),function(e){if(e.debugShowBoundingVolume!==e._debugShowBoundingVolume){e._debugShowBoundingVolume=e.debugShowBoundingVolume;for(var t=e.debugShowBoundingVolume,r=e._nodeCommands,i=r.length,n=0;n<i;++n)r[n].command.debugShowBoundingVolume=t}}(this),function(e){if(e.shadows!==e._shadows){e._shadows=e.shadows;for(var t=Ce.castShadows(e.shadows),r=Ce.receiveShadows(e.shadows),i=e._nodeCommands,n=i.length,a=0;a<n;a++){var o=i[a];o.command.castShadows=t,o.command.receiveShadows=r}}}(this),function(e,t){var r=e._clippingPlanes;d(r)&&r.owner===e&&r.enabled&&r.update(t)}(this,t);var ne=this._clippingPlanes,ae=0,se=d(ne)&&ne.enabled&&ne.length>0,ue=d(this._sphericalHarmonicCoefficients)||this._useDefaultSphericalHarmonics,le=d(this._specularEnvironmentMapAtlas)&&this._specularEnvironmentMapAtlas.ready||this._useDefaultSpecularMaps;if(se||ue||le){var de=l(this.clippingPlanesOriginMatrix,X);E.multiply(s.uniformState.view3D,de,this._clippingPlaneModelViewMatrix)}se&&(ae=ne.clippingPlanesState);var he=this._shouldRegenerateShaders;he=he||this._clippingPlanesState!==ae,this._clippingPlanesState=ae;var Re=Be(this);Re!==this._colorShadingEnabled&&(this._colorShadingEnabled=Re,he=!0),he?function(e,t){var r,i=e._rendererResources,n=e._cachedRendererResources;if(lr(i,n),Ie(e)||Be(e)||e._shouldRegenerateShaders){e._shouldRegenerateShaders=!1,i.programs={},i.silhouettePrograms={};var a,o={},s=e._sourceTechniques;for(var u in s)s.hasOwnProperty(u)&&(a=s[u],r=a.program,o[r]||(o[r]=!0,tt({programId:r,techniqueId:u},e,t.context)))}else i.programs=n.programs,i.silhouettePrograms=n.silhouettePrograms;for(var c=i.programs,l=e._nodeCommands,h=l.length,m=0;m<h;++m){var f=l[m];r=f.programId;var p=c[r];f.command.shaderProgram=p,d(f.command2D)&&(f.command2D.shaderProgram=p)}Gt(e,t,!0),$t(e,t,!0)}(this,t):(Gt(this,t,!1),$t(this,t,!1))}if(w){var Me=this;t.afterRender.push(function(){Me._ready=!0,Me._readyPromise.resolve(Me)})}else if(K&&!this._ignoreCommands){var we,Ee,Te,Ae=t.commandList,Pe=t.passes,Le=this._nodeCommands,Ne=Le.length,De=t.mapProjection.ellipsoid.maximumRadius*M.PI;if(Pe.render||Pe.pick&&this.allowPicking){for(we=0;we<Ne;++we)if((Ee=Le[we]).show){var Oe=z?Ee.translucentCommand:Ee.command;if(Oe=H?Ee.silhouetteModelCommand:Oe,Ae.push(Oe),Te=Ee.command.boundingVolume,t.mode===Se.SCENE2D&&(Te.center.y+Te.radius>De||Te.center.y-Te.radius<De)){var Fe=z?Ee.translucentCommand2D:Ee.command2D;Fe=H?Ee.silhouetteModelCommand2D:Fe,Ae.push(Fe)}}if(H&&!Pe.pick)for(we=0;we<Ne;++we)(Ee=Le[we]).show&&(Ae.push(Ee.silhouetteColorCommand),Te=Ee.command.boundingVolume,t.mode===Se.SCENE2D&&(Te.center.y+Te.radius>De||Te.center.y-Te.radius<De)&&Ae.push(Ee.silhouetteColorCommand2D))}}}else _.supportsWebP.initialize()},Pe.prototype.isDestroyed=function(){return!1},Pe.prototype.destroy=function(){d(this._precreatedAttributes)&&or(this._rendererResources.vertexArrays),d(this._removeUpdateHeightCallback)&&(this._removeUpdateHeightCallback(),this._removeUpdateHeightCallback=void 0),d(this._terrainProviderChangedCallback)&&(this._terrainProviderChangedCallback(),this._terrainProviderChangedCallback=void 0),d(this._cachedRendererResources)&&lr(this._rendererResources,this._cachedRendererResources),this._rendererResources=void 0,this._cachedRendererResources=this._cachedRendererResources&&this._cachedRendererResources.release(),oe.destroyCachedDataForModel(this);for(var e=this._pickIds,t=e.length,r=0;r<t;++r)e[r].destroy();nr(this),this._quantizedVertexShaders=void 0;var i=this._clippingPlanes;return d(i)&&!i.isDestroyed()&&i.owner===this&&i.destroy(),this._clippingPlanes=void 0,this._specularEnvironmentMapAtlas=this._specularEnvironmentMapAtlas&&this._specularEnvironmentMapAtlas.destroy(),m(this)},Pe._getClippingFunction=ue,Pe._modifyShaderForColor=function(e){return e=H.replaceMain(e,"gltf_blend_main"),e+="uniform vec4 gltf_color; \nuniform float gltf_colorBlend; \nvoid main() \n{ \n    gltf_blend_main(); \n    gl_FragColor.rgb = mix(gl_FragColor.rgb, gltf_color.rgb, gltf_colorBlend); \n    float highlight = ceil(gltf_colorBlend); \n    gl_FragColor.rgb *= mix(gltf_color.rgb, vec3(1.0), highlight); \n    gl_FragColor.a *= gltf_color.a; \n} \n"},Object.defineProperties(Pe.prototype,{_cachedGltf:{set:function(e){this._vtxf_cachedGltf=e,this._vtxf_cachedGltf&&this._vtxf_cachedGltf._gltf&&fixGltf(this._vtxf_cachedGltf._gltf)},get:function(){return this._vtxf_cachedGltf}}}),Pe});var fixGltf=function(e){if(e.extensionsUsed){var t=e.extensionsUsed&&e.extensionsUsed.indexOf("KHR_technique_webgl"),r=e.extensionsRequired&&e.extensionsRequired.indexOf("KHR_technique_webgl");if(-1!==t){e.extensionsRequired.splice(r,1,"KHR_techniques_webgl"),e.extensionsUsed.splice(t,1,"KHR_techniques_webgl"),e.extensions=e.extensions||{},e.extensions.KHR_techniques_webgl={},e.extensions.KHR_techniques_webgl.programs=e.programs,e.extensions.KHR_techniques_webgl.shaders=e.shaders,e.extensions.KHR_techniques_webgl.techniques=e.techniques;var i=e.extensions.KHR_techniques_webgl.techniques;e.materials.forEach(function(t,r){e.materials[r].extensions||(e.materials[r].extensions={KHR_technique_webgl:{}}),e.materials[r].extensions.KHR_technique_webgl.values=e.materials[r].values,e.materials[r].extensions.KHR_techniques_webgl=e.materials[r].extensions.KHR_technique_webgl;var n=e.materials[r].extensions.KHR_techniques_webgl;for(var a in n.technique||(n.technique=e.materials[r].technique),n.values){var o=i[n.technique].uniforms;for(var s in o)if(o[s]===a){n.values[s]=n.values[a],delete n.values[a];break}}}),i.forEach(function(e){for(var t in e.attributes){var r=e.attributes[t];e.attributes[t]=e.parameters[r]}for(var i in e.uniforms){r=e.uniforms[i];e.uniforms[i]=e.parameters[r]}})}}};