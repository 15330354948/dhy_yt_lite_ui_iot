define(["../Core/AssociativeArray","../Core/Cartesian3","../Core/Color","../Core/defined","../Core/destroyObject","../Core/DeveloperError","../Core/DistanceDisplayCondition","../Core/NearFarScalar","../Scene/createBillboardPointCallback","../Scene/HeightReference","./BoundingSphereState","./Property"],function(e,i,t,o,n,r,l,a,s,u,d,c){"use strict";var h=t.WHITE,p=t.BLACK,f=new t,g=new i,v=new t,C=new a,_=new a,D=new l;function y(e){this.entity=e,this.pointPrimitive=void 0,this.billboard=void 0,this.color=void 0,this.outlineColor=void 0,this.pixelSize=void 0,this.outlineWidth=void 0}function m(i,t){if(!o(i))throw new r("entityCluster is required.");if(!o(t))throw new r("entityCollection is required.");t.collectionChanged.addEventListener(m.prototype._onCollectionChanged,this),this._cluster=i,this._entityCollection=t,this._items=new e,this._onCollectionChanged(t,t.values,[],[])}function O(e,i,t){if(o(e)){var n=e.pointPrimitive;if(o(n))return e.pointPrimitive=void 0,void t.removePoint(i);var r=e.billboard;o(r)&&(e.billboard=void 0,t.removeBillboard(i))}}return m.prototype.update=function(e){if(!o(e))throw new r("time is required.");for(var n=this._items.values,l=this._cluster,a=0,d=n.length;a<d;a++){var y,m=n[a],b=m.entity,w=b._point,V=m.pointPrimitive,P=m.billboard,S=c.getValueOrDefault(w._heightReference,e,u.NONE),B=b.isShowing&&b.isAvailable(e)&&c.getValueOrDefault(w._show,e,!0);if(B&&(y=c.getValueOrUndefined(b._position,e,g),B=o(y)),B){c.isConstant(b._position)||(l._clusterDirty=!0);var N=!1,q=!1;if(S===u.NONE||o(P)?S!==u.NONE||o(V)||(o(P)&&(O(m,b,l),P=void 0),(V=l.getPoint(b)).id=b,m.pointPrimitive=V):(o(V)&&(O(m,b,l),V=void 0),(P=l.getBillboard(b)).id=b,P.image=void 0,m.billboard=P,N=!0,q=i.equals(P.position,y)&&P.heightReference===S),o(V))V.show=!0,V.position=y,V.scaleByDistance=c.getValueOrUndefined(w._scaleByDistance,e,C),V.translucencyByDistance=c.getValueOrUndefined(w._translucencyByDistance,e,_),V.color=c.getValueOrDefault(w._color,e,h,f),V.outlineColor=c.getValueOrDefault(w._outlineColor,e,p,v),V.outlineWidth=c.getValueOrDefault(w._outlineWidth,e,0),V.pixelSize=c.getValueOrDefault(w._pixelSize,e,1),V.distanceDisplayCondition=c.getValueOrUndefined(w._distanceDisplayCondition,e,D),V.disableDepthTestDistance=c.getValueOrDefault(w._disableDepthTestDistance,e,0);else if(o(P)){P.show=!0,P.position=y,P.scaleByDistance=c.getValueOrUndefined(w._scaleByDistance,e,C),P.translucencyByDistance=c.getValueOrUndefined(w._translucencyByDistance,e,_),P.distanceDisplayCondition=c.getValueOrUndefined(w._distanceDisplayCondition,e,D),P.disableDepthTestDistance=c.getValueOrDefault(w._disableDepthTestDistance,e,0),P.heightReference=S;var E=c.getValueOrDefault(w._color,e,h,f),W=c.getValueOrDefault(w._outlineColor,e,p,v),x=Math.round(c.getValueOrDefault(w._outlineWidth,e,0)),U=Math.max(1,Math.round(c.getValueOrDefault(w._pixelSize,e,1)));if(x>0?(P.scale=1,N=N||x!==m.outlineWidth||U!==m.pixelSize||!t.equals(E,m.color)||!t.equals(W,m.outlineColor)):(P.scale=U/50,U=50,N=N||x!==m.outlineWidth||!t.equals(E,m.color)||!t.equals(W,m.outlineColor)),N){m.color=t.clone(E,m.color),m.outlineColor=t.clone(W,m.outlineColor),m.pixelSize=U,m.outlineWidth=x;var z=E.alpha,A=E.toCssColorString(),T=W.toCssColorString(),I=JSON.stringify([A,U,T,x]);P.setImage(I,s(z,A,T,x,U))}q&&P._updateClamping()}}else O(m,b,l)}return!0},m.prototype.getBoundingSphere=function(e,t){if(!o(e))throw new r("entity is required.");if(!o(t))throw new r("result is required.");var n=this._items.get(e.id);if(!o(n)||!o(n.pointPrimitive)&&!o(n.billboard))return d.FAILED;if(o(n.pointPrimitive))t.center=i.clone(n.pointPrimitive.position,t.center);else{var l=n.billboard;if(!o(l._clampedPosition))return d.PENDING;t.center=i.clone(l._clampedPosition,t.center)}return t.radius=0,d.DONE},m.prototype.isDestroyed=function(){return!1},m.prototype.destroy=function(){this._entityCollection.collectionChanged.removeEventListener(m.prototype._onCollectionChanged,this);for(var e=this._entityCollection.values,i=0;i<e.length;i++)this._cluster.removePoint(e[i]);return n(this)},m.prototype._onCollectionChanged=function(e,i,t,n){var r,l,a=this._items,s=this._cluster;for(r=i.length-1;r>-1;r--)l=i[r],o(l._point)&&o(l._position)&&a.set(l.id,new y(l));for(r=n.length-1;r>-1;r--)l=n[r],o(l._point)&&o(l._position)?a.contains(l.id)||a.set(l.id,new y(l)):(O(a.get(l.id),l,s),a.remove(l.id));for(r=t.length-1;r>-1;r--)l=t[r],O(a.get(l.id),l,s),a.remove(l.id)},m});