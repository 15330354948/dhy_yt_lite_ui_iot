define(["../Core/BoundingRectangle","../Core/Color","../Core/defined","../Core/destroyObject","../Core/PixelFormat","../Renderer/ClearCommand","../Renderer/Framebuffer","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/ShaderSource","../Renderer/Sampler","../Renderer/Texture","../Renderer/TextureWrap","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Shaders/PostProcessStages/DepthViewPacked","../Shaders/PostProcessStages/PassThrough","../Shaders/PostProcessStages/PassThroughDepth","./StencilConstants","./StencilFunction","./StencilOperation"],function(e,t,r,o,p,i,n,a,u,h,s,m,d,_,c,f,l,D,T,C,x){"use strict";function y(){this._colorTexture=void 0,this._depthStencilTexture=void 0,this._globeDepthTexture=void 0,this._tempGlobeDepthTexture=void 0,this._tempCopyDepthTexture=void 0,this.framebuffer=void 0,this._copyDepthFramebuffer=void 0,this._tempCopyDepthFramebuffer=void 0,this._updateDepthFramebuffer=void 0,this._clearColorCommand=void 0,this._copyColorCommand=void 0,this._copyDepthCommand=void 0,this._tempCopyDepthCommand=void 0,this._updateDepthCommand=void 0,this._viewport=new e,this._rs=void 0,this._rsUpdate=void 0,this._useScissorTest=!1,this._scissorRectangle=void 0,this._useLogDepth=void 0,this._useHdr=void 0,this._debugGlobeDepthViewportCommand=void 0}function b(e){e._colorTexture=e._colorTexture&&!e._colorTexture.isDestroyed()&&e._colorTexture.destroy(),e._depthStencilTexture=e._depthStencilTexture&&!e._depthStencilTexture.isDestroyed()&&e._depthStencilTexture.destroy(),e._globeDepthTexture=e._globeDepthTexture&&!e._globeDepthTexture.isDestroyed()&&e._globeDepthTexture.destroy()}function g(e){e.framebuffer=e.framebuffer&&!e.framebuffer.isDestroyed()&&e.framebuffer.destroy(),e._copyDepthFramebuffer=e._copyDepthFramebuffer&&!e._copyDepthFramebuffer.isDestroyed()&&e._copyDepthFramebuffer.destroy()}function w(e){e._tempCopyDepthFramebuffer=e._tempCopyDepthFramebuffer&&!e._tempCopyDepthFramebuffer.isDestroyed()&&e._tempCopyDepthFramebuffer.destroy(),e._updateDepthFramebuffer=e._updateDepthFramebuffer&&!e._updateDepthFramebuffer.isDestroyed()&&e._updateDepthFramebuffer.destroy(),e._tempGlobeDepthTexture=e._tempGlobeDepthTexture&&!e._tempGlobeDepthTexture.isDestroyed()&&e._tempGlobeDepthTexture.destroy()}function S(e,t,o,i,u){var h=e._colorTexture,f=!r(h)||h.width!==o||h.height!==i||u!==e._useHdr;r(e.framebuffer)&&!f||(b(e),g(e),function(e,t,r,o,i){var n=i?t.halfFloatingPointTexture?a.HALF_FLOAT:a.FLOAT:a.UNSIGNED_BYTE;e._colorTexture=new m({context:t,width:r,height:o,pixelFormat:p.RGBA,pixelDatatype:n,sampler:new s({wrapS:d.CLAMP_TO_EDGE,wrapT:d.CLAMP_TO_EDGE,minificationFilter:c.NEAREST,magnificationFilter:_.NEAREST})}),e._depthStencilTexture=new m({context:t,width:r,height:o,pixelFormat:p.DEPTH_STENCIL,pixelDatatype:a.UNSIGNED_INT_24_8}),e._globeDepthTexture=new m({context:t,width:r,height:o,pixelFormat:p.RGBA,pixelDatatype:a.UNSIGNED_BYTE,sampler:new s({wrapS:d.CLAMP_TO_EDGE,wrapT:d.CLAMP_TO_EDGE,minificationFilter:c.NEAREST,magnificationFilter:_.NEAREST})})}(e,t,o,i,u),function(e,t){e.framebuffer=new n({context:t,colorTextures:[e._colorTexture],depthStencilTexture:e._depthStencilTexture,destroyAttachments:!1}),e._copyDepthFramebuffer=new n({context:t,colorTextures:[e._globeDepthTexture],destroyAttachments:!1})}(e,t))}function v(o,p,n,a,h){o._viewport.width=n,o._viewport.height=a;var s=!e.equals(o._viewport,h.viewport),m=s!==o._useScissorTest;o._useScissorTest=s,e.equals(o._scissorRectangle,h.viewport)||(o._scissorRectangle=e.clone(h.viewport,o._scissorRectangle),m=!0),r(o._rs)&&e.equals(o._viewport,o._rs.viewport)&&!m||(o._rs=u.fromCache({viewport:o._viewport,scissorTest:{enabled:o._useScissorTest,rectangle:o._scissorRectangle}}),o._rsUpdate=u.fromCache({viewport:o._viewport,scissorTest:{enabled:o._useScissorTest,rectangle:o._scissorRectangle},stencilTest:{enabled:!0,frontFunction:C.EQUAL,frontOperation:{fail:x.KEEP,zFail:x.KEEP,zPass:x.KEEP},backFunction:C.NEVER,reference:T.PGEARTH_3D_TILE_MASK,mask:T.PGEARTH_3D_TILE_MASK}})),r(o._copyDepthCommand)||(o._copyDepthCommand=p.createViewportQuadCommand(D,{uniformMap:{u_depthTexture:function(){return o._depthStencilTexture}},owner:o})),o._copyDepthCommand.framebuffer=o._copyDepthFramebuffer,o._copyDepthCommand.renderState=o._rs,r(o._copyColorCommand)||(o._copyColorCommand=p.createViewportQuadCommand(l,{uniformMap:{colorTexture:function(){return o._colorTexture}},owner:o})),r(o._tempCopyDepthCommand)||(o._tempCopyDepthCommand=p.createViewportQuadCommand(D,{uniformMap:{u_depthTexture:function(){return o._tempCopyDepthTexture}},owner:o})),o._tempCopyDepthCommand.framebuffer=o._tempCopyDepthFramebuffer,o._tempCopyDepthCommand.renderState=o._rs,r(o._updateDepthCommand)||(o._updateDepthCommand=p.createViewportQuadCommand(l,{uniformMap:{colorTexture:function(){return o._tempGlobeDepthTexture}},owner:o})),o._updateDepthCommand.framebuffer=o._updateDepthFramebuffer,o._updateDepthCommand.renderState=o._rsUpdate,r(o._clearColorCommand)||(o._clearColorCommand=new i({color:new t(0,0,0,0),stencil:0,owner:o})),o._clearColorCommand.framebuffer=o.framebuffer}return y.prototype.executeDebugGlobeDepth=function(e,t,o){!function(e,t,o,p){if(!r(e._debugGlobeDepthViewportCommand)||p!==e._useLogDepth){var i=new h({defines:[p?"LOG_DEPTH":""],sources:["uniform sampler2D u_depthTexture;\nvarying vec2 v_textureCoordinates;\nvoid main()\n{\n    float z_window = czm_unpackDepth(texture2D(u_depthTexture, v_textureCoordinates));\n    z_window = czm_reverseLogDepth(z_window); \n    float n_range = czm_depthRange.near;\n    float f_range = czm_depthRange.far;\n    float z_ndc = (2.0 * z_window - n_range - f_range) / (f_range - n_range);\n    float scale = pow(z_ndc * 0.5 + 0.5, 8.0);\n    gl_FragColor = vec4(mix(vec3(0.0), vec3(1.0), scale), 1.0);\n}\n"]});e._debugGlobeDepthViewportCommand=t.createViewportQuadCommand(i,{uniformMap:{u_depthTexture:function(){return e._globeDepthTexture}},owner:e}),e._useLogDepth=p}e._debugGlobeDepthViewportCommand.execute(t,o)}(this,e,t,o)},y.prototype.update=function(e,t,r,o){var p=r.width,i=r.height;S(this,e,p,i,o),v(this,e,p,i,t),e.uniformState.globeDepthTexture=void 0,this._useHdr=o},y.prototype.executeCopyDepth=function(e,t){r(this._copyDepthCommand)&&(this._copyDepthCommand.execute(e,t),e.uniformState.globeDepthTexture=this._globeDepthTexture)},y.prototype.executeUpdateDepth=function(e,t,o){var i=t.framebuffer.depthStencilTexture;if(o||i!==this._depthStencilTexture){if(r(this._updateDepthCommand)){if(!r(this._updateDepthFramebuffer)||this._updateDepthFramebuffer.depthStencilTexture!==i||this._updateDepthFramebuffer.getColorTexture(0)!==this._globeDepthTexture){var u=this._globeDepthTexture.width,h=this._globeDepthTexture.height;w(this),function(e,t,r,o,i){e._tempGlobeDepthTexture=new m({context:t,width:r,height:o,pixelFormat:p.RGBA,pixelDatatype:a.UNSIGNED_BYTE,sampler:new s({wrapS:d.CLAMP_TO_EDGE,wrapT:d.CLAMP_TO_EDGE,minificationFilter:c.NEAREST,magnificationFilter:_.NEAREST})}),e._tempCopyDepthFramebuffer=new n({context:t,colorTextures:[e._tempGlobeDepthTexture],destroyAttachments:!1}),e._updateDepthFramebuffer=new n({context:t,colorTextures:[e._globeDepthTexture],depthStencilTexture:i.framebuffer.depthStencilTexture,destroyAttachments:!1})}(this,e,u,h,t),v(this,e,u,h,t)}this._tempCopyDepthTexture=i,this._tempCopyDepthCommand.execute(e,t),this._updateDepthCommand.execute(e,t)}}else r(this._copyDepthCommand)&&this._copyDepthCommand.execute(e,t)},y.prototype.executeCopyColor=function(e,t){r(this._copyColorCommand)&&this._copyColorCommand.execute(e,t)},y.prototype.clear=function(e,o,p){var i=this._clearColorCommand;r(i)&&(t.clone(p,i.color),i.execute(e,o))},y.prototype.isDestroyed=function(){return!1},y.prototype.destroy=function(){b(this),g(this),w(this),r(this._copyColorCommand)&&(this._copyColorCommand.shaderProgram=this._copyColorCommand.shaderProgram.destroy()),r(this._copyDepthCommand)&&(this._copyDepthCommand.shaderProgram=this._copyDepthCommand.shaderProgram.destroy());var e=this._debugGlobeDepthViewportCommand;return r(e)&&(e.shaderProgram=e.shaderProgram.destroy()),o(this)},y});