define(["../Core/defaultValue","../Core/defined","../Core/DeveloperError","../Renderer/modernizeShader","../Shaders/Builtin/CzmBuiltins","./AutomaticUniforms"],function(n,e,r,i,o,t){"use strict";function a(n){return(n=n.replace(/\/\/.*/g,"")).replace(/\/\*\*[\s\S]*?\*\//gm,function(n){for(var e=n.match(/\n/gm).length,r="",i=0;i<e;++i)r+="\n";return r})}function u(n,r,i){for(var o,t=0;t<i.length;++t)i[t].name===n&&(o=i[t]);return e(o)||(o={name:n,glslSource:r=a(r),dependsOn:[],requiredBy:[],evaluated:!1},i.push(o)),o}function l(n){var i=[],o=u("main",n,i);!function n(r,i){if(!r.evaluated){r.evaluated=!0;var o=r.glslSource.match(/\bczm_[a-zA-Z0-9_]*/g);e(o)&&null!==o&&(o=o.filter(function(n,e){return o.indexOf(n)===e})).forEach(function(e){if(e!==r.name&&s._czmBuiltinsAndUniforms.hasOwnProperty(e)){var o=u(e,s._czmBuiltinsAndUniforms[e],i);r.dependsOn.push(o),o.requiredBy.push(r),n(o,i)}})}}(o,i),function(n){for(var e=[],i=[];n.length>0;){var o=n.pop();i.push(o),0===o.requiredBy.length&&e.push(o)}for(;e.length>0;){var t=e.shift();n.push(t);for(var a=0;a<t.dependsOn.length;++a){var u=t.dependsOn[a],l=u.requiredBy.indexOf(t);u.requiredBy.splice(l,1),0===u.requiredBy.length&&e.push(u)}}for(var c=[],s=0;s<i.length;++s)0!==i[s].requiredBy.length&&c.push(i[s]);if(0!==c.length){for(var f="A circular dependency was found in the following built-in functions/structs/constants: \n",d=0;d<c.length;++d)f=f+c[d].name+"\n";throw new r(f)}}(i);for(var t="",a=i.length-1;a>=0;--a)t=t+i[a].glslSource+"\n";return t.replace(o.glslSource,"")}function c(n,o,t){var u,c,f,d="",p=n.sources;if(e(p))for(u=0,c=p.length;u<c;++u)d+="\n#line 0\n"+p[u];var h=[];d=(d=(d=(d=a(d)).replace(/#version\s+(.*?)\n/gm,function(n,i){if(e(f)&&f!==i)throw new r("inconsistent versions found: "+f+" and "+i);return f=i,"\n"})).replace(/#extension.*\n/gm,function(n){return h.push(n),"\n"})).replace(/precision\s(lowp|mediump|highp)\s(float|int);/,"");var m=n.pickColorQualifier;e(m)&&(d=s.createPickFragmentShaderSource(d,m));var g="";e(f)&&(g="#version "+f+"\n");var v=h.length;for(u=0;u<v;u++)g+=h[u];o&&(g+="#ifdef GL_FRAGMENT_PRECISION_HIGH\n    precision highp float;\n#else\n    precision mediump float;\n#endif\n\n");var _=n.defines;if(e(_))for(u=0,c=_.length;u<c;++u){var C=_[u];0!==C.length&&(g+="#define "+C+"\n")}return t.webgl2&&(g+="#define OUTPUT_DECLARATION\n\n"),t.textureFloatLinear&&(g+="#define OES_texture_float_linear\n\n"),n.includeBuiltIns&&(g+=l(d)),g+="\n#line 0\n",g+=d,t.webgl2&&(g=i(g,o,!0)),g}function s(i){var o=(i=n(i,n.EMPTY_OBJECT)).pickColorQualifier;if(e(o)&&"uniform"!==o&&"varying"!==o)throw new r("options.pickColorQualifier must be 'uniform' or 'varying'.");this.defines=e(i.defines)?i.defines.slice(0):[],this.sources=e(i.sources)?i.sources.slice(0):[],this.pickColorQualifier=o,this.includeBuiltIns=n(i.includeBuiltIns,!0)}for(var f in s.prototype.clone=function(){return new s({sources:this.sources,defines:this.defines,pickColorQualifier:this.pickColorQualifier,includeBuiltIns:this.includeBuiltIns})},s.replaceMain=function(n,e){return e="void "+e+"()",n.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,e)},s.prototype.createCombinedVertexShader=function(n){return c(this,!1,n)},s.prototype.createCombinedFragmentShader=function(n){return c(this,!0,n)},s._czmBuiltinsAndUniforms={},o)o.hasOwnProperty(f)&&(s._czmBuiltinsAndUniforms[f]=o[f]);for(var d in t)if(t.hasOwnProperty(d)){var p=t[d];"function"==typeof p.getDeclaration&&(s._czmBuiltinsAndUniforms[d]=p.getDeclaration(d))}s.createPickVertexShaderSource=function(n){return s.replaceMain(n,"czm_old_main")+"\nattribute vec4 pickColor; \nvarying vec4 czm_pickColor; \nvoid main() \n{ \n    czm_old_main(); \n    czm_pickColor = pickColor; \n}"},s.createPickFragmentShaderSource=function(n,e){return s.replaceMain(n,"czm_old_main")+"\n"+(e+" vec4 czm_pickColor; \nvoid main() \n{ \n    czm_old_main(); \n    if (gl_FragColor.a == 0.0) { \n       discard; \n    } \n    gl_FragColor = czm_pickColor; \n}")},s.findVarying=function(n,e){for(var r=n.sources,i=e.length,o=0;o<i;++o)for(var t=e[o],a=r.length,u=0;u<a;++u)if(-1!==r[u].indexOf(t))return t};var h=["v_normalEC","v_normal"];s.findNormalVarying=function(n){return s.findVarying(n,h)};var m=["v_positionEC"];return s.findPositionVarying=function(n){return s.findVarying(n,m)},s});