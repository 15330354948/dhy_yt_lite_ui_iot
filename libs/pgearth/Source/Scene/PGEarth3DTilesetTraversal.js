define(["../Core/Cartesian3","../Core/defined","../Core/Intersect","../Core/ManagedArray","../Core/Math","./PGEarth3DTileOptimizationHint","./PGEarth3DTileRefine"],function(e,t,r,i,a,n,o){"use strict";function c(){}function m(e){return e._visible&&e._inRequestVolume}var s={stack:new i,stackMaximumLength:0},u={stack:new i,stackMaximumLength:0},l={stack:new i,stackMaximumLength:0},h={stack:new i,stackMaximumLength:0,ancestorStack:new i,ancestorStackMaximumLength:0},_=2;function d(e){return e._skipLevelOfDetail}function f(e,t){e._emptyTiles.push(t)}function p(e,t,i){if(t.contentVisibility(i)!==r.OUTSIDE){var a=t.content;a.featurePropertiesDirty?(a.featurePropertiesDirty=!1,t.lastStyleTime=0,e._selectedTilesToStyle.push(t)):t._selectedFrame<i.frameNumber-1&&e._selectedTilesToStyle.push(t),t._selectedFrame=i.frameNumber,e._selectedTiles.push(t)}}function v(e,r,i){if(d(e)){var a=r.contentAvailable?r:r._ancestorWithContentAvailable;t(a)?a._shouldSelect=!0:function(e,t,r){var i=l.stack;for(i.push(t);i.length>0;){l.stackMaximumLength=Math.max(l.stackMaximumLength,i.length);for(var a=i.pop().children,n=a.length,o=0;o<n;++o){var c=a[o];m(c)&&(c.contentAvailable?(C(e,c,r),g(e,c,r),p(e,c,r)):c._depth-t._depth<_&&i.push(c))}}}(e,r,i)}else r.contentAvailable&&p(e,r,i)}function S(e,t,r){++e._statistics.visited,t._visitedFrame=r.frameNumber}function g(e,t,r){t._touchedFrame!==r.frameNumber&&(e._cache.touch(t),t._touchedFrame=r.frameNumber)}function M(e,t,r){if(t._requestedFrame!==r.frameNumber&&(L(t)||t.contentExpired)&&function(e,t,r){if(!e.cullRequestsWhileMoving)return!0;var i=t.boundingSphere,a=Math.max(2*i.radius,1),n=r.camera,o=0!==n.positionWCDeltaMagnitude?n.positionWCDeltaMagnitude:n.positionWCDeltaMagnitudeLastFrame;return e.cullRequestsWhileMovingMultiplier*o/a<1}(e,t,r)){var i=r.camera.timeSinceMoved<e.foveatedTimeDelay;t.priorityDeferred&&i||(t._requestedFrame=r.frameNumber,e._requestedTiles.push(t))}}function x(e,t,r){t._updatedVisibilityFrame!==e._updatedVisibilityFrame&&(t.updateVisibility(r),t._updatedVisibilityFrame=e._updatedVisibilityFrame)}function y(e,r,i){if(x(e,r,i),m(r)){var a=r.children.length>0;if(r.hasTilesetContent&&a){var c=r.children[0];return y(e,c,i),void(r._visible=c._visible)}if(!function(e,r,i){var a=r.parent;return!(!t(a)||a.hasTilesetContent||a.refine!==o.ADD)&&r.getScreenSpaceError(i,!0)<=e._maximumScreenSpaceError}(e,r,i)){var s=r.refine===o.REPLACE,u=r._optimChildrenWithinParent===n.USE_OPTIMIZATION;return s&&u&&a&&!function(e,t,r){for(var i=!1,a=t.children,n=a.length,o=0;o<n;++o){var c=a[o];x(e,c,r),i=i||m(c)}return i}(e,r,i)?(++e._statistics.numberOfTilesCulledWithChildrenUnion,void(r._visible=!1)):void 0}r._visible=!1}}function C(e,t,r){y(e,t,r),t.updateExpiration(),t._wasMinPriorityChild=!1,t._priorityHolder=t,function(e,t){e._maximumPriority.distance=Math.max(t._priorityHolder._distanceToCamera,e._maximumPriority.distance),e._minimumPriority.distance=Math.min(t._priorityHolder._distanceToCamera,e._minimumPriority.distance),e._maximumPriority.depth=Math.max(t._depth,e._maximumPriority.depth),e._minimumPriority.depth=Math.min(t._depth,e._minimumPriority.depth),e._maximumPriority.foveatedFactor=Math.max(t._priorityHolder._foveatedFactor,e._maximumPriority.foveatedFactor),e._minimumPriority.foveatedFactor=Math.min(t._priorityHolder._foveatedFactor,e._minimumPriority.foveatedFactor),e._maximumPriority.reverseScreenSpaceError=Math.max(t._priorityReverseScreenSpaceError,e._maximumPriority.reverseScreenSpaceError),e._minimumPriority.reverseScreenSpaceError=Math.min(t._priorityReverseScreenSpaceError,e._minimumPriority.reverseScreenSpaceError)}(e,t),t._shouldSelect=!1,t._finalResolution=!0}function k(e,r){e._ancestorWithContent=void 0,e._ancestorWithContentAvailable=void 0;var i=e.parent;if(t(i)){var a=!L(i)||i._requestedFrame===r.frameNumber;e._ancestorWithContent=a?i:i._ancestorWithContent,e._ancestorWithContentAvailable=i.contentAvailable?i:i._ancestorWithContentAvailable}}function E(e){return e.hasEmptyContent||e.hasTilesetContent}function L(e){return!E(e)&&e.contentUnloaded}function b(e,r){var i=r._ancestorWithContent;return!e.immediatelyLoadDesiredLevelOfDetail&&(r._priorityProgressiveResolutionScreenSpaceErrorLeaf||t(i)&&r._screenSpaceError<i._screenSpaceError/e.skipScreenSpaceErrorFactor&&r._depth>i._depth+e.skipLevels)}function T(e,t){return 0===t._distanceToCamera&&0===e._distanceToCamera?t._centerZDepth-e._centerZDepth:t._distanceToCamera-e._distanceToCamera}function F(e,t,r,i){var a,n=t.refine===o.REPLACE,c=t.children,s=c.length;for(a=0;a<s;++a)C(e,c[a],i);c.sort(T);var u,l=!d(e)&&n&&!E(t),h=!0,_=!1,f=-1,p=Number.MAX_VALUE;for(a=0;a<s;++a){var v;if(m(u=c[a])?(r.push(u),u._foveatedFactor<p&&(f=a,p=u._foveatedFactor),_=!0):(l||e.loadSiblings)&&(u._foveatedFactor<p&&(f=a,p=u._foveatedFactor),M(e,u,i),g(e,u,i)),l)v=!!u._inRequestVolume&&(E(u)?W(e,u,i):u.contentAvailable),h=h&&v}if(_||(h=!1),-1!==f&&!d(e)&&n){var S=c[f];S._wasMinPriorityChild=!0;var x=(t._wasMinPriorityChild||t===e.root)&&p<=t._priorityHolder._foveatedFactor?t._priorityHolder:t;for(x._foveatedFactor=Math.min(S._foveatedFactor,x._foveatedFactor),x._distanceToCamera=Math.min(S._distanceToCamera,x._distanceToCamera),a=0;a<s;++a)(u=c[a])._priorityHolder=x}return h}function P(e,r,i){return!d(e)||!e.immediatelyLoadDesiredLevelOfDetail&&(!t(r._ancestorWithContent)||(0===r._screenSpaceError?r.parent._screenSpaceError>i:r._screenSpaceError>i))}function D(e,t){return 0!==t.children.length&&(t.hasTilesetContent?!t.contentExpired:t._screenSpaceError>e._maximumScreenSpaceError)}function A(e,r,i,a,n){var c=s.stack;for(c.push(r);c.length>0;){s.stackMaximumLength=Math.max(s.stackMaximumLength,c.length);var m=c.pop();k(m,n);var u=P(e,m,i),l=m.refine===o.ADD,h=m.refine===o.REPLACE,_=m.parent,d=!t(_)||_._refines,p=!1;D(e,m)&&(p=F(e,m,c,n)&&d);var x=!p&&d;E(m)?(f(e,m),M(e,m,n),x&&v(e,m,n)):l?(v(e,m,n),M(e,m,n)):h&&(u?(M(e,m,n),x&&v(e,m,n)):x?(v(e,m,n),M(e,m,n)):b(e,m)&&M(e,m,n)),S(e,m,n),g(e,m,n),m._refines=p}}function W(e,t,r){var i=!0,a=u.stack;for(a.push(t);a.length>0;){u.stackMaximumLength=Math.max(u.stackMaximumLength,a.length);var n=a.pop(),o=n.children,c=o.length,s=E(n)&&D(e,n);if(s||n.contentAvailable||(i=!1),C(e,n,r),m(n)||(M(e,n,r),g(e,n,r)),s)for(var l=0;l<c;++l){var h=o[l];a.push(h)}}return i}function R(e,r,i){var a,n=h.stack,c=h.ancestorStack;for(n.push(r);n.length>0||c.length>0;){if(h.stackMaximumLength=Math.max(h.stackMaximumLength,n.length),h.ancestorStackMaximumLength=Math.max(h.ancestorStackMaximumLength,c.length),c.length>0){var s=c.peek();if(s._stackLength===n.length){c.pop(),s!==a&&(s._finalResolution=!1),p(e,s,i);continue}}var u=n.pop();if(t(u)){var l=u.refine===o.ADD,_=u._shouldSelect,d=u.children,f=d.length,v=D(e,u);if(_)if(l)p(e,u,i);else{if(u._selectionDepth=c.length,u._selectionDepth>0&&(e._hasMixedContent=!0),a=u,!v){p(e,u,i);continue}c.push(u),u._stackLength=n.length}if(v)for(var S=0;S<f;++S){var g=d[S];m(g)&&n.push(g)}}}}return c.selectTiles=function(e,t){if(e._requestedTiles.length=0,!e.debugFreezeFrame){e._selectedTiles.length=0,e._selectedTilesToStyle.length=0,e._emptyTiles.length=0,e._hasMixedContent=!1;var r=e.root;if(C(e,r,t),m(r)&&!(r.getScreenSpaceError(t,!0)<=e._maximumScreenSpaceError)){d(e)?e.immediatelyLoadDesiredLevelOfDetail?function(e,t,r){var i=Number.MAX_VALUE,a=e._maximumScreenSpaceError;A(e,t,i,a,r),R(e,t,r)}(e,r,t):function(e,t,r){var i=Math.max(e.baseScreenSpaceError,e.maximumScreenSpaceError),a=e.maximumScreenSpaceError;A(e,t,i,a,r),R(e,t,r)}(e,r,t):function(e,t,r){var i=e._maximumScreenSpaceError,a=e._maximumScreenSpaceError;A(e,t,i,a,r)}(e,r,t),s.stack.trim(s.stackMaximumLength),u.stack.trim(u.stackMaximumLength),l.stack.trim(l.stackMaximumLength),h.stack.trim(h.stackMaximumLength),h.ancestorStack.trim(h.ancestorStackMaximumLength);for(var i=e._requestedTiles,a=i.length,n=0;n<a;++n)i[n].updatePriority()}}},c});