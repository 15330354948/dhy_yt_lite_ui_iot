define(["../../Source/Core/defined","../../Source/Core/DeveloperError","../../Source/Scene/ArcGisMapServerImageryProvider","../../Source/Core/createGuid"],function(e,t,r,i){return function(i){var a=a;if(!e(i.url)||""===i.url)throw new t("url is required");var o=new r(i);return o.id=i.id||a(),o}}),define(["../../Source/Core/Rectangle","../../Source/Core/Ellipsoid","../../Source/Core/GeographicTilingScheme","../../Source/Core/WebMercatorTilingScheme","../../Source/Core/defaultValue","../../Source/Core/defined","../../Source/Core/defineProperties","../../Source/Core/HeightmapTerrainData","../../Source/Core/loadArrayBuffer","../../Source/Core/TerrainProvider","../../Source/Core/Resource","../../Source/Core/getImagePixels","../../Source/Core/DeveloperError","../../Source/Core/Credit","../../Source/Core/Event","../../Source/Core/createGuid","../../Source/ThirdParty/when"],function(e,t,r,i,a,o,n,l,h,u,s,g,c,f,m,d,p){function S(e,t){p(e,function(e){o(e)&&e.ready&&(e.levelZeroMaximumGeometricError=u.getEstimatedLevelZeroGeometricErrorForAHeightmap(e.tilingScheme.ellipsoid,e.heightMapWidth,e.tilingScheme.getNumberOfXTilesAtLevel(0)),o(e.URLtemplateImage)&&(e.getHeightmapTerrainDataImage=function(r,i,a){var n;if(!isNaN(r+i+a)){var h=y(e.URLtemplateImage(r,i,a),r,i,a,t),u={highest:e.highest,lowest:e.lowest,offset:e.offset},s=v(r,i,a,t),g=w(h);o(g)&&(n=p(g,function(t){return C.imageToHeightmapTerrainData(t,u,{width:e.heightMapWidth,height:e.heightMapHeight},e.waterMask,s,e.hasStyledImage)}).otherwise(function(){return new l({buffer:new Uint16Array(e.heightMapWidth*e.heightMapHeight),width:e.heightMapWidth,height:e.heightMapHeight,childTileMask:s,waterMask:new Uint8Array(e.heightMapWidth*e.heightMapHeight),structure:e.formatImage.terrainDataStructure})}))}return n}),o(e.URLtemplateArray)&&(e.getHeightmapTerrainDataArray=function(r,i,a){var n;if(!isNaN(r+i+a)){var u=y(e.URLtemplateArray(r,i,a),r,i,a,t),s={highest:e.highest,lowest:e.lowest,offset:e.offset},g=v(r,i,a,t),c=h(u);o(c)&&(n=p(c,function(t){return C.arrayToHeightmapTerrainData(t,s,{width:e.heightMapWidth,height:e.heightMapHeight},e.formatArray,e.waterMask,g)}).otherwise(function(){return o(e.getHeightmapTerrainDataImage)?e.getHeightmapTerrainDataImage(r,i,a):new l({buffer:new Uint16Array(e.heightMapWidth*e.heightMapHeight),width:e.heightMapWidth,height:e.heightMapHeight,childTileMask:g,waterMask:new Uint8Array(e.heightMapWidth*e.heightMapHeight),structure:e.formatImage.terrainDataStructure})}))}return n}),t.getLevelMaximumGeometricError=function(t){return e.levelZeroMaximumGeometricError/(1<<t)},t.requestTileGeometry=function(t,r,i){var a;return o(e.getHeightmapTerrainDataArray)?a=e.getHeightmapTerrainDataArray(t,r,i):o(e.getHeightmapTerrainDataImage)&&(a=e.getHeightmapTerrainDataImage(t,r,i)),a},n(t,{tilingScheme:{get:function(){return e.tilingScheme}},ready:{get:function(){return e.ready}},hasWaterMask:{get:function(){return e.waterMask}},heightMapHeight:{get:function(){return e.heightMapHeight}},heightMapWidth:{get:function(){return e.heightMapWidth}},getTileDataAvailable:{get:function(){return e.getTileDataAvailable}}})),t._readyPromise.resolve(e.ready)})}function y(e,t,r,i,a){var o=a.tilingScheme.tileXYToNativeRectangle(t,r,i),n=(o.east-o.west)/(a.heightMapWidth-1),l=(o.north-o.south)/(a.heightMapHeight-1);o.west-=.5*n,o.east+=.5*n,o.south-=.5*l,o.north+=.5*l;var h=a.tilingScheme.getNumberOfYTilesAtLevel(i),u=h-r-1;return e.replace("{south}",o.south).replace("{north}",o.north).replace("{west}",o.west).replace("{east}",o.east).replace("{x}",t).replace("{y}",r).replace("{tmsY}",u)}function v(e,t,r,i){var a=0,o=r+1;return a|=i.getTileDataAvailable(2*e,2*t,o)?1:0,a|=i.getTileDataAvailable(2*e+1,2*t,o)?2:0,a|=i.getTileDataAvailable(2*e,2*t+1,o)?4:0,a|=i.getTileDataAvailable(2*e+1,2*t+1,o)?8:0,a}var w=s.fetchImage,M=s.fetchXML,x={},T=function(t,r){var i,a=Math.max(t.west,r.west),o=Math.min(t.east,r.east),n=Math.max(t.south,r.south),l=Math.min(t.north,r.north);return i=o<=a||n>=l?void 0:new e(a,n,o,l),i};x.CRS=[{name:"CRS:84",ellipsoid:t.WGS84,firstAxeIsLatitude:!1,tilingScheme:r,supportedCRS:"urn:ogc:def:crs:OGC:2:84"},{name:"EPSG:4326",ellipsoid:t.WGS84,firstAxeIsLatitude:!0,tilingScheme:r,SupportedCRS:"urn:ogc:def:crs:EPSG::4326"},{name:"EPSG:3857",ellipsoid:t.WGS84,firstAxeIsLatitude:!1,tilingScheme:i,SupportedCRS:"urn:ogc:def:crs:EPSG::3857"},{name:"OSGEO:41001",ellipsoid:t.WGS84,firstAxeIsLatitude:!1,tilingScheme:i,SupportedCRS:"urn:ogc:def:crs:EPSG::3857"}],x.FormatImage=[{format:"image/png",extension:"png"},{format:"image/jpeg",extension:"jpg"},{format:"image/jpeg",extension:"jpeg"},{format:"image/gif",extension:"gif"},{format:"image/png; mode=8bit",extension:"png"}],x.FormatArray=[{format:"image/bil",postProcessArray:function(e,t,r,i,a){var o,n=new DataView(e),l=new ArrayBuffer(t.height*t.width*2),h=new DataView(l);if(l.byteLength===e.byteLength){for(var u,s=0,g=0,c=0;c<l.byteLength;c+=2)if(u=n.getInt16(c,!1)-a,u>i&&u<r)h.setInt16(c,u,!0),g+=u,s++;else{var f=0===s?1:g/s;h.setInt16(c,f,!0)}o=new Int16Array(l)}return o}}],x.WMSParser={},x.TMSParser={},x.WMTSParser={},x.parser=function(e){var t;switch(e=a(e,a.EMPTY_OBJECT),e.service){case"TMS":t=x.TMSParser.generate(e);break;case"WMTS":t=x.WMTSParser.generate(e);break;default:t=x.WMSParser.generate(e)}return t},x.WMSParser.generate=function(e){var t;if(e=a(e,a.EMPTY_OBJECT),o(e.url)){var r=e.url,i=r.lastIndexOf("?");i>-1&&(r=r.substring(0,i));var n=r+"?SERVICE=WMS&REQUEST=GetCapabilities&tiled=true";o(e.proxy)&&(n=e.proxy.getURL(n)),t=p(M(n),function(t){return x.WMSParser.getMetaDatafromXML(t,e)})}else{if(!o(e.xml))throw new c("either description.url or description.xml are required.");t=x.WMSParser.getMetaDatafromXML(e.xml,e)}return t},x.WMSParser.getMetaDatafromXML=function(t,r){if(!(t instanceof XMLDocument))throw new c("xml must be a XMLDocument");if(!o(r.layerName))throw new c("description.layerName is required.");var i={},n=r.layerName,l=a(r.maxLevel,11),h=void 0;i.heightMapWidth=a(r.heightMapWidth,65),i.heightMapHeight=a(r.heightMapHeight,i.heightMapWidth);var u={width:65,height:65},s=void 0;i.formatImage=r.formatImage,i.formatArray=r.formatArray,i.tilingScheme=void 0;var g=void 0,f=void 0;i.ready=!1,i.levelZeroMaximumGeometricError=void 0,i.waterMask=a(r.waterMask,!1),"boolean"!=typeof i.waterMask&&(i.waterMask=!1),i.offset=a(r.offset,0),i.highest=a(r.highest,12e3),i.lowest=a(r.lowest,-500);var m=r.styleName;i.hasStyledImage=a(r.hasStyledImage,"string"==typeof r.styleName);var d=t.querySelector("[version]");null!==d&&(h=d.getAttribute("version"),f=/^1\.[3-9]\./.test(h));var p=t.querySelector("Request>GetMap OnlineResource").getAttribute("xlink:href"),S=p.indexOf("?");S>-1&&(p=p.substring(0,S)),o(r.proxy)&&(p=r.proxy.getURL(p));var y=t.querySelectorAll("Request>GetMap>Format");if(!o(i.formatImage))for(var v=0;v<y.length&&!o(i.formatArray);v++){var w=x.FormatArray.filter(function(e){return e.format===y[v].textContent});w.length>0&&(i.formatArray=w[0])}o(i.formatArray)&&"string"==typeof i.formatArray.format&&"function"==typeof i.formatArray.postProcessArray?i.formatArray.terrainDataStructure={heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1,lowestEncodedHeight:0,highestEncodedHeight:1e4}:i.formatArray=void 0;for(v=0;v<y.length&&!o(i.formatImage);v++){w=x.FormatImage.filter(function(e){return e.format===y[v].textContent});w.length>0&&(i.formatImage=w[0])}o(i.formatImage)&&"string"==typeof i.formatImage.format?i.formatImage.terrainDataStructure={heightScale:1,heightOffset:0,elementsPerHeight:2,stride:4,elementMultiplier:256,isBigEndian:!0,lowestEncodedHeight:0,highestEncodedHeight:1e4}:i.formatImage=void 0;for(var M,C=t.querySelectorAll("Layer[queryable='1'],Layer[queryable='true']"),A=0;A<C.length&&!o(M);A++)if(C[A].querySelector("Name").textContent===n){M=C[A];var I=M.getAttribute("fixedHeight"),b=M.getAttribute("fixedWidth");o(I)&&(I=parseInt(I),i.heightMapHeight=I>0&&I<i.heightMapHeight?I:i.heightMapHeight,u.height=I>0?I:u.height),o(b)&&(b=parseInt(b),i.heightMapWidth=b>0&&b<i.heightMapWidth?b:i.heightMapWidth,u.width=b>0?b:u.width)}if(o(M)&&o(h)){for(var L=!1,R=0;R<x.CRS.length&&!L;R++){var q=x.CRS[R],E=q.name,D=M.querySelector("BoundingBox[SRS='"+E+"'],BoundingBox[CRS='"+E+"']");if(null!==D){var W,P,H,G;s=E,g=q.firstAxeIsLatitude,i.tilingScheme=new q.tilingScheme({ellipsoid:q.ellipsoid}),g&&f?(W=parseFloat(D.getAttribute("miny")),P=parseFloat(D.getAttribute("maxy")),H=parseFloat(D.getAttribute("minx")),G=parseFloat(D.getAttribute("maxx"))):(W=parseFloat(D.getAttribute("minx")),P=parseFloat(D.getAttribute("maxx")),H=parseFloat(D.getAttribute("miny")),G=parseFloat(D.getAttribute("maxy")));var k=new e(W,H,P,G);i.getTileDataAvailable=function(e,t,r){var a=!1,n=i.tilingScheme.tileXYToNativeRectangle(e,t,r);if(r<l){var h=T(k,n);a=o(h)}return a},L=!0}}if(o(m)){for(var O=M.querySelectorAll("Style>Name"),N=!1,F=0;F<O.length&&!N;F++)m===O[F].textContent&&(N=!0);N||(m=void 0)}for(var U=t.querySelectorAll("VendorSpecificCapabilities>TileSet"),_=!1,X=0;X<U.length&&!_;X++){var B=null!==U[X].querySelector("BoundingBox[SRS='"+s+"'],BoundingBox[CRS='"+s+"']"),V=U[X].querySelector("Layers").textContent===n;V&&B&&(u.width=parseInt(U[X].querySelector("Width").textContent),u.height=parseInt(U[X].querySelector("Height").textContent),_=!0)}i.ready=L&&(o(i.formatImage)||o(i.formatArray))&&o(h)}if(i.ready){var Y=p+"?SERVICE=WMS&REQUEST=GetMap&layers="+n+"&version="+h+"&bbox=";if(Y+=f&&g?"{south},{west},{north},{east}":"{west},{south},{east},{north}",Y+="&crs="+s+"&srs="+s,i.formatImage){var j=Y+"&format="+i.formatImage.format+"&width="+u.width+"&height="+u.height;o(m)&&(j+="&styles="+m+"&style="+m),i.URLtemplateImage=function(){return j},i.imageSize=u}if(i.formatArray){var z=Y+"&format="+i.formatArray.format+"&width="+i.heightMapWidth+"&height="+i.heightMapHeight;i.URLtemplateArray=function(){return z}}}return i},x.TMSParser.generate=function(e){var t;if(e=a(e,a.EMPTY_OBJECT),o(e.url))t=M(e.url).then(function(t){return x.TMSParser.parseXML(t,e)});else{if(!o(e.xml))throw new c("either description.url or description.xml are required.");t=x.TMSParser.parseXML(e.xml,e)}return t},x.TMSParser.parseXML=function(e,t){if(!(e instanceof XMLDocument))throw new c("xml must be a XMLDocument");var r;if(null!=e.querySelector("TileMapService")){if(!o(t.layerName))throw new c("layerName is required.");var i=[].slice.apply(e.querySelectorAll("TileMap[title='"+t.layerName+"']")),a=i.map(function(e){var r=e.getAttribute("href");return o(t.proxy)&&(r=t.proxy.getURL(r)),p(M(r),function(e){return x.TMSParser.getMetaDatafromXML(e,t)})}),n=p.all(a).then(function(e){for(var t,r=0;r<e.length&&!o(t);r++)o(e[r])&&(t=e[r]);return t});r=n.then(function(e){return e})}else r=x.TMSParser.getMetaDatafromXML(e,t);return r},x.TMSParser.getMetaDatafromXML=function(t,r){var i={ready:!1};i.heightMapWidth=a(r.heightMapWidth,65),i.heightMapHeight=a(r.heightMapHeight,i.heightMapWidth);var n=a(r.maxLevel,11),l=r.proxy;i.hasStyledImage=a(r.hasStyledImage,"string"==typeof r.styleName),i.waterMask=a(r.waterMask,!1),"boolean"!=typeof i.waterMask&&(i.waterMask=!1),i.offset=a(r.offset,0),i.highest=a(r.highest,12e3),i.lowest=a(r.lowest,-500);var h=t.querySelector("SRS").textContent,u=x.CRS.filter(function(e){return e.name===h});u.length>0&&(i.tilingScheme=new u[0].tilingScheme({ellipsoid:u[0].ellipsoid}));var s=t.querySelector("TileFormat"),g=x.FormatImage.filter(function(e){return e.extension==s.getAttribute("extension")});g.length>0&&(i.formatImage=g[0],i.imageSize={},i.imageSize.width=parseInt(s.getAttribute("width")),i.imageSize.height=parseInt(s.getAttribute("height")));var c=[].slice.call(t.querySelectorAll("TileSets>TileSet")),f=[];if(o(i.formatImage)&&(f=c.map(function(e){var t=e.getAttribute("href")+"/{x}/{tmsY}."+i.formatImage.extension;o(l)&&(t=l.getURL(t));var r=parseInt(e.getAttribute("order"));return{url:t,level:r}}),f.sort(function(e,t){return e.level-t.level}),f.length>0&&(i.tileSets=f)),o(i.tileSets)&&o(i.formatImage)&&o(i.tilingScheme)){i.URLtemplateImage=function(e,t,r){var i="";return r<f.length&&(i=f[r].url),i};var m=t.querySelector("BoundingBox"),d=parseFloat(m.getAttribute("miny")),p=parseFloat(m.getAttribute("maxy")),S=parseFloat(m.getAttribute("minx")),y=parseFloat(m.getAttribute("maxx")),v=new e(S,d,y,p);i.getTileDataAvailable=function(e,t,r){var a=i.tilingScheme.tileXYToNativeRectangle(e,t,r),l=T(v,a);return o(l)&&r<n&&r<f.length},i.ready=!0}else i=void 0;return i},x.WMTSParser.generate=function(e){var t;if(e=a(e,a.EMPTY_OBJECT),o(e.url)){var r=e.url,i=r.lastIndexOf("?");i>-1&&(r=r.substring(0,i));var n=r+"?REQUEST=GetCapabilities";o(e.proxy)&&(n=e.proxy.getURL(n)),t=M(n).then(function(t){return x.WMTSParser.getMetaDatafromXML(t,e)})}else{if(!o(e.xml))throw new c("either description.url or description.xml are required.");t=x.WMTSParser.getMetaDatafromXML(e.xml,e)}return t},x.WMTSParser.getMetaDatafromXML=function(e,t){if(!(e instanceof XMLDocument))throw new c("xml must be a XMLDocument");var r={},i=t.layerName;r.ready=!1,r.heightMapWidth=a(t.heightMapWidth,65),r.heightMapHeight=a(t.heightMapHeight,r.heightMapWidth);var n,l=a(t.maxLevel,12),h=t.proxy,u=t.styleName;r.hasStyledImage=a(t.hasStyledImage,"string"==typeof t.styleName),r.waterMask=a(t.waterMask,!1),"boolean"!=typeof r.waterMask&&(r.waterMask=!1),r.offset=a(t.offset,0),r.highest=a(t.highest,12e3),r.lowest=a(t.lowest,-500);for(var s,g,f,m=[],d=[].slice.call(e.querySelectorAll('Operation[name="GetTile"] HTTP Get')),p=d.map(function(e){var t,r=e.querySelector("Value").textContent;return"KVP"===r&&(t={node:e,type:"KVP"}),"RESTful"===r&&(t={node:e,type:"RESTful"}),t}).filter(function(e){return o(e)}),S=0;S<p.length;S++){var y=p[S];"RESTful"!==y.type||o(g)||(g=y.node.getAttribute("xlink:href"),o(h)&&(g=h.getURL(g))),"KVP"!==y.type||o(s)||(s=y.node.getAttribute("xlink:href"),o(h)&&(s=h.getURL(s)))}var v,w=e.querySelectorAll("Contents>Layer>Identifier");for(S=0;S<w.length&&!o(v);S++)i===w[S].textContent&&(v=w[S].parentNode);if(o(v)){var M,T,C=v.querySelectorAll("Style");for(S=0;S<C.length;S++){var A=C[S].querySelector("Identifier").textContent;null!=C[S].getAttribute("isDefault")&&(M=A),A===u&&(T=A)}o(u)&&u==T||(u=a(M,""));for(var I=[].slice.call(v.querySelectorAll("Format")),b=0;b<x.FormatImage.length&&!o(f);b++){var L=I.filter(function(e){return e.textContent===x.FormatImage[b].format});L.length>0&&(f=x.FormatImage[b])}m=v.querySelectorAll("TileMatrixSetLink")}for(var R=[].slice.call(e.querySelectorAll("TileMatrixSet>Identifier")),q=0;q<m.length&&!r.ready;q++){var E,D,W=m[q],P=W.querySelector("TileMatrixSet").textContent;for(S=0;S<R.length&&!o(E);S++)R[S].textContent===P&&(E=R[S].parentNode);for(var H=E.querySelector("SupportedCRS").textContent,G=0;G<x.CRS.length&&!o(D);G++)x.CRS[G].SupportedCRS===H&&(D=x.CRS[G]);if(o(D)){var k,O=[].slice.call(E.querySelectorAll("TileMatrix"));k=O.map(function(e){var t=e.querySelector("Identifier").textContent,r=parseInt(e.querySelector("MatrixWidth").textContent),i=parseInt(e.querySelector("MatrixHeight").textContent),a=parseInt(e.querySelector("TileWidth").textContent),o=parseInt(e.querySelector("TileHeight").textContent),n=parseFloat(e.querySelector("ScaleDenominator").textContent);return{id:t,maxWidth:r,maxHeight:i,scaleDenominator:n,complete:!1,tileWidth:a,tileHeight:o}}),k.sort(function(e,t){return t.scaleDenominator-e.scaleDenominator}),listTileMatrixLimits=W.querySelectorAll("TileMatrixSetLimits>TileMatrixLimits");for(var N=0;N<k.length;N++)for(var F=k[N],U=0;U<listTileMatrixLimits.length;U++){var _=listTileMatrixLimits[U];F.id===_.querySelector("TileMatrix").textContent&&(F.minTileRow=parseInt(_.querySelector("MinTileRow").textContent),F.maxTileRow=parseInt(_.querySelector("MaxTileRow").textContent),F.minTileCol=parseInt(_.querySelector("MinTileCol").textContent),F.maxTileCol=parseInt(_.querySelector("MaxTileCol").textContent),F.complete=!0,k[N]=F)}if(k.length>0){r.tilingScheme=new D.tilingScheme({ellipsoid:D.ellipsoid,numberOfLevelZeroTilesX:k[0].maxWidth,numberOfLevelZeroTilesY:k[0].maxHeight});var X=v.querySelector("ResourceURL[format='"+f.format+"']");if(null!=X?n=X.getAttribute("template").replace("{TileRow}","{y}").replace("{TileCol}","{x}").replace("{Style}",u).replace("{TileMatrixSet}",P).replace("{layer}",i).replace("{infoFormatExtension}",f.extension):o(s)&&(n=s+"service=WMTS&request=GetTile&version=1.0.0&layer="+i+"&style="+u+"&format="+f.format+"&TileMatrixSet="+P+"&TileMatrix={TileMatrix}&TileRow={y}&TileCol={x}"),o(n)){r.getTileDataAvailable=function(e,t,r){var i=!1;if(r<l&&r<k.length){var a=k[r];i=a.complete?t<=a.maxTileRow&&t>=a.minTileRow&&e<=a.maxTileCol&&e>=a.minTileCol:e<a.maxWidth&&t<a.maxHeight}return i},r.URLtemplateImage=function(e,t,i){var a="";if(r.getTileDataAvailable(e,t,i)){var o=k[i];a=n.replace("{TileMatrix}",o.id)}return a};var B={width:k[0].tileWidth,height:k[0].tileHeight},V=k.filter(function(e){return e.tileWidth!=B.width||e.tileHeight!=B.height});0==V.length&&(r.imageSize=B),r.ready=!0}}}}return r};var C=function(e){if(!o(e))throw new c("description is required.");var t=new m,r=e.url.lastIndexOf("/");e.layerName=e.url.substr(r+1),e.url=e.url.substr(0,r),this.id=e.id||d(),e.heightMapWidth=e.heightMapWidth||65,e.heightMapHeight=e.heightMapHeight||65,e.maxLevel=e.maxLevel||13,e.formatImage=e.formatImage||{format:"image/png",extension:"png"},e.styleName=e.styleName||"grayToColor",e.hasStyledImage=e.hasStyledImage||!0,e.waterMask=e.waterMask||!1;var i=e.credit;"string"==typeof i&&(i=new f(i)),this.ready=!1,this._readyPromise=p.defer(),n(this,{errorEvent:{get:function(){return t}},credit:{get:function(){return i}},hasVertexNormals:{get:function(){return!1}},readyPromise:{get:function(){return this._readyPromise.promise}}});var a=x.parser(e);S(a,this)};return C.arrayToHeightmapTerrainData=function(e,t,r,i,a,n){"number"==typeof r&&(r={width:r,height:r});var h=i.postProcessArray(e,r,t.highest,t.lowest,t.offset);if(!o(h))throw new c("no good size");var u={buffer:h,width:r.width,height:r.height,childTileMask:n,structure:i.terrainDataStructure};if(a){for(var s=new Uint8Array(h.length),g=0;g<h.length;g++)h[g]<=0&&(s[g]=255);u.waterMask=s}return new l(u)},C.imageToHeightmapTerrainData=function(e,t,r,i,a,o){"number"==typeof r&&(r={width:r,height:r});for(var n=g(e,r.width,r.height),h=new Uint8Array(n.length/4),u=new Int16Array(n.length/4),s=0,c=0,f=0;f<n.length;f+=4){var m=n[f],d=n[f+1],p=n[f+2]>128,S=(m<<8|d)-t.offset-32768;S>t.lowest&&S<t.highest&&(p||o)?(u[f/4]=S,c+=S,s++):u[f/4]=0==s?0:c/s}var y={buffer:u,width:r.width,height:r.height,childTileMask:a,structure:{heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1}};if(i){for(h=new Uint8Array(u.length),f=0;f<u.length;f++)u[f]<=0&&(h[f]=255);y.waterMask=h}return new l(y)},C}),define(["../../Source/DataSources/GeoJsonDataSource","../../Source/Core/defined","../../Source/Core/defaultValue","../../Source/Core/DeveloperError","../../Source/Core/createGuid","../_Color"],function(e,t,r,i,a,o){return function(r){if(!t(r.url))throw new i("url is required");r.definitionExpression&&(r.url+="&CQL_FILTER="+encodeURI(r.definitionExpression)),r.fill=o(r.color||"#fff").withAlpha(r.opacity||1),r.stroke=o(r.outline&&r.outline.color||"#FF0000"),r.strokeWidth=r.outline&&r.outline.width||2;var n=new e.load(r.url,r);return n.id=r.id||a(),n.featureReduction=r.featureReduction||!1,n.popupEnabled=r.popupEnabled,r.popupTemplate&&n.then(function(e){var t=e.entities._entities._array;for(var i in t)t[i].popupEnabled=r.popupEnabled,t[i].popupTemplate={title:r.popupTemplate.title,content:r.popupTemplate.content,actions:r.popupTemplate.actions}}),n}}),define(["../../Source/Core/createGuid","../../Source/Core/Check","../../Source/Core/AssociativeArray","../../Source/Core/RuntimeError","../../Source/DataSources/Entity"],function(e,t,r,i,a){function o(t){if(this._items=new r,window.viewer||t||t.viewer){var i=t&&t.viewer,o=window.viewer||i;this.id=t&&t.id||e(),this.collection=o.entities.add(new a),this.items=this._items._array,this.length=this._items.length,Object.defineProperty(this,"show",{set:function(e){this.collection.show=e},get:function(){return this.collection.show}})}else console.error("Map viewer is required")}return o.prototype.findGraphicById=function(e){return t.typeOf.string("id",e),this._items.get(e)},o.prototype.add=function(e){t.typeOf.object("graphic",e);var r=e.id,a=this._items;if(a.contains(r))throw new i("A Graphic with id "+r+" already exist in this collection");return a.set(r,e),this.viewer?(e.parent=this.collection,this.viewer.entities.add(e),this.viewer.scene.requestRender(),e):e},o.prototype.remove=function(e){if(e instanceof a)return this._items.remove(e.id),this.viewer.entities.remove(e)},o.prototype.removeAll=function(){var e=this;this.items.forEach(function(t){e.remove(t)})},o}),define(["../../Source/Oblique/PGPageLOD/PGPageLOD","../../Source/Core/defined","../../Source/Core/DeveloperError","../../Source/Core/createGuid"],function(e,t,r,i){return function(a){if(!t(a.url))throw new r("url is required");var o=new e(a);return o.id=a.id||i(),o.destroy=function(){},o}}),define(["../../Source/Core/createGuid","../../Source/Core/Check","../../Source/Core/AssociativeArray","../../Source/Core/RuntimeError"],function(e,t,r,i){function a(t){this._items=new r,this.id=t&&t.id||e(),this.items=this._items._array,this.length=this._items.length}return a.prototype.findPrimitiveById=function(e){return t.typeOf.string("id",e),this._items.get(e)},a.prototype.add=function(e){t.typeOf.object("primitive",e);var r=e.id,a=this._items;if(a.contains(r))throw new i("A primitive with id "+r+" already exist in this collection");return a.set(r,e),this.viewer?(this.viewer.scene.primitives.add(e),this.viewer.scene.requestRender(),e):e},a.prototype.remove=function(e){if(t.typeOf.object("primitive",e))this._items.remove(e.id);else{if(!t.typeOf.string("primitive",e))throw new Error("type error");this._items.remove(e)}},a}),define(["../../Source/Scene/PGEarth3DTileset","../../Source/Core/defined","../../Source/Core/DeveloperError","../../Source/Core/createGuid"],function(e,t,r,i){return function(a){if(!t(a.url))throw new r("url is required");a.maximumScreenSpaceError=a.maximumScreenSpaceError||2,a.maximumNumberOfLoadedTiles=a.maximumNumberOfLoadedTiles||1e3;var o=new e(a);return o.id=a.id||i(),o}}),define(["../../Source/Scene/WebMapServiceImageryProvider","../../Source/Core/defined","../../Source/Core/createGuid","../../Source/Core/DeveloperError"],function(e,t,r,i){return function(a){if(!t(a.url))throw new i("url is required");a.parameters={format:"image/png",transparent:!0};var o=new e(a);return o.id=a.id||r(),o}}),define(["../../Source/Scene/WebMapTileServiceImageryProvider","../../Source/Core/createGuid","../../Source/Core/defined","../../Source/Core/DeveloperError"],function(e,t,r,i){return function(a){if(!r(a.url))throw new i("url is required");if(!r(a.title))throw new i("title is required");if(!r(a.tileMatrixSet))throw new i("tileMatrixSet is required");a.format=a.format||"image/jpeg",a.style="default",a.tileMatrixSetID=a.tileMatrixSet,a.layer=a.title;var o=new e(a);return o.id=a.id||t(),o}}),define(["../../Source/Core/defined","../../Source/Core/createGuid","../../Source/Core/DeveloperError","../../Source/Scene/UrlTemplateImageryProvider"],function(e,t,r,i){return function(a){if(!e(a.url))throw new r("url is required");var o=new i(a);return o.id=a.id||t(),o}});
