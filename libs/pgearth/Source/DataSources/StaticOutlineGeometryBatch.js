define(["../Core/AssociativeArray","../Core/Cartesian3","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defined","../Core/DistanceDisplayCondition","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/OffsetGeometryInstanceAttribute","../Core/ShowGeometryInstanceAttribute","../Scene/PerInstanceColorAppearance","../Scene/Primitive","./BoundingSphereState","./Property"],function(t,e,i,s,r,o,n,a,h,l,u,d,v){"use strict";var c=new i,p=new o,m=new o,f=e.ZERO,g=new e;function y(e,i,s,r){this.translucent=i,this.width=s,this.shadows=r,this.primitives=e,this.createPrimitive=!1,this.waitingOnCreate=!1,this.primitive=void 0,this.oldPrimitive=void 0,this.geometry=new t,this.updaters=new t,this.updatersWithAttributes=new t,this.attributes=new t,this.itemsToRemove=[],this.subscriptions=new t,this.showsUpdated=new t}function w(e,i,s){this._primitives=e,this._scene=i,this._shadows=s,this._solidBatches=new t,this._translucentBatches=new t}return y.prototype.add=function(t,e){var i=t.id;if(this.createPrimitive=!0,this.geometry.set(i,e),this.updaters.set(i,t),t.hasConstantOutline&&t.outlineColorProperty.isConstant&&v.isConstant(t.distanceDisplayConditionProperty)&&v.isConstant(t.terrainOffsetProperty)){var s=this;this.subscriptions.set(i,t.entity.definitionChanged.addEventListener(function(e,i,r,o){"isShowing"===i&&s.showsUpdated.set(t.id,t)}))}else this.updatersWithAttributes.set(i,t)},y.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);return r(i)&&(i(),this.subscriptions.remove(e),this.showsUpdated.remove(e)),!0}return!1},y.prototype.update=function(t){var d,y=!0,w=0,C=this.primitive,P=this.primitives;if(this.createPrimitive){var _=this.geometry.values;if(_.length>0)r(C)&&(r(this.oldPrimitive)?P.remove(C):this.oldPrimitive=C),C=new u({show:!1,asynchronous:!0,geometryInstances:_,appearance:new l({flat:!0,translucent:this.translucent,renderState:{lineWidth:this.width}}),shadows:this.shadows}),P.add(C),y=!1;else{r(C)&&(P.remove(C),C=void 0);var b=this.oldPrimitive;r(b)&&(P.remove(b),this.oldPrimitive=void 0)}this.attributes.removeAll(),this.primitive=C,this.createPrimitive=!1,this.waitingOnCreate=!0}else if(r(C)&&C.ready){C.show=!0,r(this.oldPrimitive)&&(P.remove(this.oldPrimitive),this.oldPrimitive=void 0);var A=this.updatersWithAttributes.values,D=A.length,O=this.waitingOnCreate;for(d=0;d<D;d++){var B=A[d],S=this.geometry.get(B.id),I=this.attributes.get(S.id.id);if(r(I)||(I=C.getGeometryInstanceAttributes(S.id),this.attributes.set(S.id.id,I)),!B.outlineColorProperty.isConstant||O){var G=B.outlineColorProperty,V=v.getValueOrDefault(G,t,i.WHITE,c);i.equals(I._lastColor,V)||(I._lastColor=i.clone(V,I._lastColor),I.color=s.toValue(V,I.color),(this.translucent&&255===I.color[3]||!this.translucent&&255!==I.color[3])&&(this.itemsToRemove[w++]=B))}var W=B.entity.isShowing&&(B.hasConstantOutline||B.isOutlineVisible(t));W!==(1===I.show[0])&&(I.show=h.toValue(W,I.show));var E=B.distanceDisplayConditionProperty;if(!v.isConstant(E)){var R=v.getValueOrDefault(E,t,m,p);o.equals(R,I._lastDistanceDisplayCondition)||(I._lastDistanceDisplayCondition=o.clone(R,I._lastDistanceDisplayCondition),I.distanceDisplayCondition=n.toValue(R,I.distanceDisplayCondition))}var T=B.terrainOffsetProperty;if(!v.isConstant(T)){var U=v.getValueOrDefault(T,t,f,g);e.equals(U,I._lastOffset)||(I._lastOffset=e.clone(U,I._lastOffset),I.offset=a.toValue(U,I.offset))}}this.updateShows(C),this.waitingOnCreate=!1}else r(C)&&!C.ready&&(y=!1);return this.itemsToRemove.length=w,y},y.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,s=0;s<i;s++){var o=e[s],n=this.geometry.get(o.id),a=this.attributes.get(n.id.id);r(a)||(a=t.getGeometryInstanceAttributes(n.id),this.attributes.set(n.id.id,a));var l=o.entity.isShowing;l!==(1===a.show[0])&&(a.show=h.toValue(l,a.show),n.attributes.show.value[0]=a.show[0])}this.showsUpdated.removeAll()},y.prototype.contains=function(t){return this.updaters.contains(t.id)},y.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return d.PENDING;var s=i.getGeometryInstanceAttributes(t.entity);return!r(s)||!r(s.boundingSphere)||r(s.show)&&0===s.show[0]?d.FAILED:(s.boundingSphere.clone(e),d.DONE)},y.prototype.removeAllPrimitives=function(){var t=this.primitives,e=this.primitive;r(e)&&(t.remove(e),this.primitive=void 0,this.geometry.removeAll(),this.updaters.removeAll());var i=this.oldPrimitive;r(i)&&(t.remove(i),this.oldPrimitive=void 0)},w.prototype.add=function(t,e){var i,s,o=e.createOutlineGeometryInstance(t),n=this._scene.clampLineWidth(e.outlineWidth);255===o.attributes.color.value[3]?(s=(i=this._solidBatches).get(n),r(s)||(s=new y(this._primitives,!1,n,this._shadows),i.set(n,s)),s.add(e,o)):(s=(i=this._translucentBatches).get(n),r(s)||(s=new y(this._primitives,!0,n,this._shadows),i.set(n,s)),s.add(e,o))},w.prototype.remove=function(t){var e,i=this._solidBatches.values,s=i.length;for(e=0;e<s;e++)if(i[e].remove(t))return;var r=this._translucentBatches.values,o=r.length;for(e=0;e<o;e++)if(r[e].remove(t))return},w.prototype.update=function(t){var e,i,s,r,o,n=this._solidBatches.values,a=n.length,h=this._translucentBatches.values,l=h.length,u=!0,d=!1;do{for(d=!1,i=0;i<a;i++){u=(r=n[i]).update(t);var v=(o=r.itemsToRemove).length;if(v>0)for(d=!0,e=0;e<v;e++)s=o[e],r.remove(s),this.add(t,s)}for(i=0;i<l;i++){u=(r=h[i]).update(t);var c=(o=r.itemsToRemove).length;if(c>0)for(d=!0,e=0;e<c;e++)s=o[e],r.remove(s),this.add(t,s)}}while(d);return u},w.prototype.getBoundingSphere=function(t,e){var i,s=this._solidBatches.values,r=s.length;for(i=0;i<r;i++){var o=s[i];if(o.contains(t))return o.getBoundingSphere(t,e)}var n=this._translucentBatches.values,a=n.length;for(i=0;i<a;i++){var h=n[i];if(h.contains(t))return h.getBoundingSphere(t,e)}return d.FAILED},w.prototype.removeAllPrimitives=function(){var t,e=this._solidBatches.values,i=e.length;for(t=0;t<i;t++)e[t].removeAllPrimitives();var s=this._translucentBatches.values,r=s.length;for(t=0;t<r;t++)s[t].removeAllPrimitives()},w});