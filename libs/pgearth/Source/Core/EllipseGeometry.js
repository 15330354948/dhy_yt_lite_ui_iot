define(["./arrayFill","./BoundingSphere","./Cartesian2","./Cartesian3","./Cartographic","./Check","./ComponentDatatype","./defaultValue","./defined","./defineProperties","./DeveloperError","./EllipseGeometryLibrary","./Ellipsoid","./GeographicProjection","./Geometry","./GeometryAttribute","./GeometryAttributes","./GeometryInstance","./GeometryOffsetAttribute","./GeometryPipeline","./IndexDatatype","./Math","./Matrix3","./PrimitiveType","./Quaternion","./Rectangle","./VertexFormat"],function(e,t,r,i,o,n,a,s,u,l,m,c,p,d,y,h,A,f,x,g,_,v,w,b,T,I,N){"use strict";var M=new i,E=new i,P=new i,F=new i,O=new r,S=new w,D=new w,R=new T,L=new i,j=new i,G=new i,V=new o,z=new i,k=new r,C=new r;function B(t,o,n){var s=o.vertexFormat,l=o.center,m=o.semiMajorAxis,p=o.semiMinorAxis,y=o.ellipsoid,f=o.stRotation,g=n?t.length/3*2:t.length/3,_=o.shadowVolume,v=s.st?new Float32Array(2*g):void 0,b=s.normal?new Float32Array(3*g):void 0,I=s.tangent?new Float32Array(3*g):void 0,N=s.bitangent?new Float32Array(3*g):void 0,F=_?new Float32Array(3*g):void 0,B=0,Y=L,H=j,U=G,Q=new d(y),W=Q.project(y.cartesianToCartographic(l,V),z),q=y.scaleToGeodeticSurface(l,M);y.geodeticSurfaceNormal(q,q);var J=S,Z=D;if(0!==f){var K=T.fromAxisAngle(q,f,R);J=w.fromQuaternion(K,J),K=T.fromAxisAngle(q,-f,R),Z=w.fromQuaternion(K,Z)}else J=w.clone(w.IDENTITY,J),Z=w.clone(w.IDENTITY,Z);for(var X=r.fromElements(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,k),$=r.fromElements(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,C),ee=t.length,te=n?ee:0,re=te/3*2,ie=0;ie<ee;ie+=3){var oe=ie+1,ne=ie+2,ae=i.fromArray(t,ie,M);if(s.st){var se=w.multiplyByVector(J,ae,E),ue=Q.project(y.cartesianToCartographic(se,V),P);i.subtract(ue,W,ue),O.x=(ue.x+m)/(2*m),O.y=(ue.y+p)/(2*p),X.x=Math.min(O.x,X.x),X.y=Math.min(O.y,X.y),$.x=Math.max(O.x,$.x),$.y=Math.max(O.y,$.y),n&&(v[B+re]=O.x,v[B+1+re]=O.y),v[B++]=O.x,v[B++]=O.y}(s.normal||s.tangent||s.bitangent||_)&&(Y=y.geodeticSurfaceNormal(ae,Y),_&&(F[ie+te]=-Y.x,F[oe+te]=-Y.y,F[ne+te]=-Y.z),(s.normal||s.tangent||s.bitangent)&&((s.tangent||s.bitangent)&&(H=i.normalize(i.cross(i.UNIT_Z,Y,H),H),w.multiplyByVector(Z,H,H)),s.normal&&(b[ie]=Y.x,b[oe]=Y.y,b[ne]=Y.z,n&&(b[ie+te]=-Y.x,b[oe+te]=-Y.y,b[ne+te]=-Y.z)),s.tangent&&(I[ie]=H.x,I[oe]=H.y,I[ne]=H.z,n&&(I[ie+te]=-H.x,I[oe+te]=-H.y,I[ne+te]=-H.z)),s.bitangent&&(U=i.normalize(i.cross(Y,H,U),U),N[ie]=U.x,N[oe]=U.y,N[ne]=U.z,n&&(N[ie+te]=U.x,N[oe+te]=U.y,N[ne+te]=U.z))))}if(s.st){ee=v.length;for(var le=0;le<ee;le+=2)v[le]=(v[le]-X.x)/($.x-X.x),v[le+1]=(v[le+1]-X.y)/($.y-X.y)}var me=new A;if(s.position){var ce=c.raisePositionsToHeight(t,o,n);me.position=new h({componentDatatype:a.DOUBLE,componentsPerAttribute:3,values:ce})}if(s.st&&(me.st=new h({componentDatatype:a.FLOAT,componentsPerAttribute:2,values:v})),s.normal&&(me.normal=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:b})),s.tangent&&(me.tangent=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:I})),s.bitangent&&(me.bitangent=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:N})),_&&(me.extrudeDirection=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:F})),n&&u(o.offsetAttribute)){var pe=new Uint8Array(g);if(o.offsetAttribute===x.TOP)pe=e(pe,1,0,g/2);else{var de=o.offsetAttribute===x.NONE?0:1;pe=e(pe,de)}me.applyOffset=new h({componentDatatype:a.UNSIGNED_BYTE,componentsPerAttribute:1,values:pe})}return me}function Y(e){var t,r,i,o,n,a=new Array(e*(e+1)*12-6),s=0;for(t=0,i=1,o=0;o<3;o++)a[s++]=i++,a[s++]=t,a[s++]=i;for(o=2;o<e+1;++o){for(i=o*(o+1)-1,t=(o-1)*o-1,a[s++]=i++,a[s++]=t,a[s++]=i,r=2*o,n=0;n<r-1;++n)a[s++]=i,a[s++]=t++,a[s++]=t,a[s++]=i++,a[s++]=t,a[s++]=i;a[s++]=i++,a[s++]=t,a[s++]=i}for(r=2*e,++i,++t,o=0;o<r-1;++o)a[s++]=i,a[s++]=t++,a[s++]=t,a[s++]=i++,a[s++]=t,a[s++]=i;for(a[s++]=i,a[s++]=t++,a[s++]=t,a[s++]=i++,a[s++]=t++,a[s++]=t,++t,o=e-1;o>1;--o){for(a[s++]=t++,a[s++]=t,a[s++]=i,r=2*o,n=0;n<r-1;++n)a[s++]=i,a[s++]=t++,a[s++]=t,a[s++]=i++,a[s++]=t,a[s++]=i;a[s++]=t++,a[s++]=t++,a[s++]=i++}for(o=0;o<3;o++)a[s++]=t++,a[s++]=t,a[s++]=i;return a}var H=new i;var U=new t,Q=new t;function W(o){var n=o.center,s=o.ellipsoid,l=o.semiMajorAxis,m=i.multiplyByScalar(s.geodeticSurfaceNormal(n,M),o.height,M);U.center=i.add(n,m,U.center),U.radius=l,m=i.multiplyByScalar(s.geodeticSurfaceNormal(n,m),o.extrudedHeight,m),Q.center=i.add(n,m,Q.center),Q.radius=l;var p=c.computeEllipsePositions(o,!0,!0),v=p.positions,I=p.numPts,N=p.outerPositions,D=t.union(U,Q),H=B(v,o,!0),W=Y(I),q=W.length;W.length=2*q;for(var J=v.length/3,Z=0;Z<q;Z+=3)W[Z+q]=W[Z+2]+J,W[Z+1+q]=W[Z+1]+J,W[Z+2+q]=W[Z]+J;var K=_.createTypedArray(2*J/3,W),X=new y({attributes:H,indices:K,primitiveType:b.TRIANGLES}),$=function(t,o){var n=o.vertexFormat,s=o.center,l=o.semiMajorAxis,m=o.semiMinorAxis,c=o.ellipsoid,p=o.height,y=o.extrudedHeight,f=o.stRotation,g=t.length/3*2,_=new Float64Array(3*g),v=n.st?new Float32Array(2*g):void 0,b=n.normal?new Float32Array(3*g):void 0,I=n.tangent?new Float32Array(3*g):void 0,N=n.bitangent?new Float32Array(3*g):void 0,D=o.shadowVolume,B=D?new Float32Array(3*g):void 0,Y=0,H=L,U=j,Q=G,W=new d(c),q=W.project(c.cartesianToCartographic(s,V),z),J=c.scaleToGeodeticSurface(s,M);c.geodeticSurfaceNormal(J,J);for(var Z=T.fromAxisAngle(J,f,R),K=w.fromQuaternion(Z,S),X=r.fromElements(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,k),$=r.fromElements(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,C),ee=t.length,te=ee/3*2,re=0;re<ee;re+=3){var ie,oe=re+1,ne=re+2,ae=i.fromArray(t,re,M);if(n.st){var se=w.multiplyByVector(K,ae,E),ue=W.project(c.cartesianToCartographic(se,V),P);i.subtract(ue,q,ue),O.x=(ue.x+l)/(2*l),O.y=(ue.y+m)/(2*m),X.x=Math.min(O.x,X.x),X.y=Math.min(O.y,X.y),$.x=Math.max(O.x,$.x),$.y=Math.max(O.y,$.y),v[Y+te]=O.x,v[Y+1+te]=O.y,v[Y++]=O.x,v[Y++]=O.y}ae=c.scaleToGeodeticSurface(ae,ae),ie=i.clone(ae,E),H=c.geodeticSurfaceNormal(ae,H),D&&(B[re+ee]=-H.x,B[oe+ee]=-H.y,B[ne+ee]=-H.z);var le=i.multiplyByScalar(H,p,F);if(ae=i.add(ae,le,ae),le=i.multiplyByScalar(H,y,le),ie=i.add(ie,le,ie),n.position&&(_[re+ee]=ie.x,_[oe+ee]=ie.y,_[ne+ee]=ie.z,_[re]=ae.x,_[oe]=ae.y,_[ne]=ae.z),n.normal||n.tangent||n.bitangent){Q=i.clone(H,Q);var me=i.fromArray(t,(re+3)%ee,F);i.subtract(me,ae,me);var ce=i.subtract(ie,ae,P);H=i.normalize(i.cross(ce,me,H),H),n.normal&&(b[re]=H.x,b[oe]=H.y,b[ne]=H.z,b[re+ee]=H.x,b[oe+ee]=H.y,b[ne+ee]=H.z),n.tangent&&(U=i.normalize(i.cross(Q,H,U),U),I[re]=U.x,I[oe]=U.y,I[ne]=U.z,I[re+ee]=U.x,I[re+1+ee]=U.y,I[re+2+ee]=U.z),n.bitangent&&(N[re]=Q.x,N[oe]=Q.y,N[ne]=Q.z,N[re+ee]=Q.x,N[oe+ee]=Q.y,N[ne+ee]=Q.z)}}if(n.st){ee=v.length;for(var pe=0;pe<ee;pe+=2)v[pe]=(v[pe]-X.x)/($.x-X.x),v[pe+1]=(v[pe+1]-X.y)/($.y-X.y)}var de=new A;if(n.position&&(de.position=new h({componentDatatype:a.DOUBLE,componentsPerAttribute:3,values:_})),n.st&&(de.st=new h({componentDatatype:a.FLOAT,componentsPerAttribute:2,values:v})),n.normal&&(de.normal=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:b})),n.tangent&&(de.tangent=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:I})),n.bitangent&&(de.bitangent=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:N})),D&&(de.extrudeDirection=new h({componentDatatype:a.FLOAT,componentsPerAttribute:3,values:B})),u(o.offsetAttribute)){var ye=new Uint8Array(g);if(o.offsetAttribute===x.TOP)ye=e(ye,1,0,g/2);else{var he=o.offsetAttribute===x.NONE?0:1;ye=e(ye,he)}de.applyOffset=new h({componentDatatype:a.UNSIGNED_BYTE,componentsPerAttribute:1,values:ye})}return de}(N,o);W=function(e){for(var t=e.length/3,r=_.createTypedArray(t,6*t),i=0,o=0;o<t;o++){var n=o,a=o+t,s=(n+1)%t,u=s+t;r[i++]=n,r[i++]=a,r[i++]=s,r[i++]=s,r[i++]=a,r[i++]=u}return r}(N);var ee=_.createTypedArray(2*N.length/3,W),te=new y({attributes:$,indices:ee,primitiveType:b.TRIANGLES}),re=g.combineInstances([new f({geometry:X}),new f({geometry:te})]);return{boundingSphere:D,attributes:re[0].attributes,indices:re[0].indices}}function q(e,t,r,o,n,a,s){for(var u=c.computeEllipsePositions({center:e,semiMajorAxis:t,semiMinorAxis:r,rotation:o,granularity:n},!1,!0).outerPositions,l=u.length/3,m=new Array(l),p=0;p<l;++p)m[p]=i.fromArray(u,3*p);var d=I.fromCartesianArray(m,a,s);return d.width>v.PI&&(d.north=d.north>0?v.PI_OVER_TWO-v.EPSILON7:d.north,d.south=d.south<0?v.EPSILON7-v.PI_OVER_TWO:d.south,d.east=v.PI,d.west=-v.PI),d}function J(e){var t=(e=s(e,s.EMPTY_OBJECT)).center,r=s(e.ellipsoid,p.WGS84),o=e.semiMajorAxis,a=e.semiMinorAxis,u=s(e.granularity,v.RADIANS_PER_DEGREE),l=s(e.vertexFormat,N.DEFAULT);if(n.defined("options.center",t),n.typeOf.number("options.semiMajorAxis",o),n.typeOf.number("options.semiMinorAxis",a),o<a)throw new m("semiMajorAxis must be greater than or equal to the semiMinorAxis.");if(u<=0)throw new m("granularity must be greater than zero.");var c=s(e.height,0),d=s(e.extrudedHeight,c);this._center=i.clone(t),this._semiMajorAxis=o,this._semiMinorAxis=a,this._ellipsoid=p.clone(r),this._rotation=s(e.rotation,0),this._stRotation=s(e.stRotation,0),this._height=Math.max(d,c),this._granularity=u,this._vertexFormat=N.clone(l),this._extrudedHeight=Math.min(d,c),this._shadowVolume=s(e.shadowVolume,!1),this._workerName="createEllipseGeometry",this._offsetAttribute=e.offsetAttribute,this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0}J.packedLength=i.packedLength+p.packedLength+N.packedLength+9,J.pack=function(e,t,r){return n.defined("value",e),n.defined("array",t),r=s(r,0),i.pack(e._center,t,r),r+=i.packedLength,p.pack(e._ellipsoid,t,r),r+=p.packedLength,N.pack(e._vertexFormat,t,r),r+=N.packedLength,t[r++]=e._semiMajorAxis,t[r++]=e._semiMinorAxis,t[r++]=e._rotation,t[r++]=e._stRotation,t[r++]=e._height,t[r++]=e._granularity,t[r++]=e._extrudedHeight,t[r++]=e._shadowVolume?1:0,t[r]=s(e._offsetAttribute,-1),t};var Z=new i,K=new p,X=new N,$={center:Z,ellipsoid:K,vertexFormat:X,semiMajorAxis:void 0,semiMinorAxis:void 0,rotation:void 0,stRotation:void 0,height:void 0,granularity:void 0,extrudedHeight:void 0,shadowVolume:void 0,offsetAttribute:void 0};return J.unpack=function(e,t,r){n.defined("array",e),t=s(t,0);var o=i.unpack(e,t,Z);t+=i.packedLength;var a=p.unpack(e,t,K);t+=p.packedLength;var l=N.unpack(e,t,X);t+=N.packedLength;var m=e[t++],c=e[t++],d=e[t++],y=e[t++],h=e[t++],A=e[t++],f=e[t++],x=1===e[t++],g=e[t];return u(r)?(r._center=i.clone(o,r._center),r._ellipsoid=p.clone(a,r._ellipsoid),r._vertexFormat=N.clone(l,r._vertexFormat),r._semiMajorAxis=m,r._semiMinorAxis=c,r._rotation=d,r._stRotation=y,r._height=h,r._granularity=A,r._extrudedHeight=f,r._shadowVolume=x,r._offsetAttribute=-1===g?void 0:g,r):($.height=h,$.extrudedHeight=f,$.granularity=A,$.stRotation=y,$.rotation=d,$.semiMajorAxis=m,$.semiMinorAxis=c,$.shadowVolume=x,$.offsetAttribute=-1===g?void 0:g,new J($))},J.computeRectangle=function(e,t){var r=(e=s(e,s.EMPTY_OBJECT)).center,i=s(e.ellipsoid,p.WGS84),o=e.semiMajorAxis,a=e.semiMinorAxis,u=s(e.granularity,v.RADIANS_PER_DEGREE),l=s(e.rotation,0);if(n.defined("options.center",r),n.typeOf.number("options.semiMajorAxis",o),n.typeOf.number("options.semiMinorAxis",a),o<a)throw new m("semiMajorAxis must be greater than or equal to the semiMinorAxis.");if(u<=0)throw new m("granularity must be greater than zero.");return q(r,o,a,l,u,i,t)},J.createGeometry=function(r){if(!(r._semiMajorAxis<=0||r._semiMinorAxis<=0)){var o=r._height,n=r._extrudedHeight,s=!v.equalsEpsilon(o,n,0,v.EPSILON2);r._center=r._ellipsoid.scaleToGeodeticSurface(r._center,r._center);var l,m={center:r._center,semiMajorAxis:r._semiMajorAxis,semiMinorAxis:r._semiMinorAxis,ellipsoid:r._ellipsoid,rotation:r._rotation,height:o,granularity:r._granularity,vertexFormat:r._vertexFormat,stRotation:r._stRotation};if(s)m.extrudedHeight=n,m.shadowVolume=r._shadowVolume,m.offsetAttribute=r._offsetAttribute,l=W(m);else if(l=function(e){var r=e.center;H=i.multiplyByScalar(e.ellipsoid.geodeticSurfaceNormal(r,H),e.height,H),H=i.add(r,H,H);var o=new t(H,e.semiMajorAxis),n=c.computeEllipsePositions(e,!0,!1),a=n.positions,s=n.numPts,u=B(a,e,!1),l=Y(s);return{boundingSphere:o,attributes:u,indices:l=_.createTypedArray(a.length/3,l)}}(m),u(r._offsetAttribute)){var p=l.attributes.position.values.length,d=new Uint8Array(p/3),A=r._offsetAttribute===x.NONE?0:1;e(d,A),l.attributes.applyOffset=new h({componentDatatype:a.UNSIGNED_BYTE,componentsPerAttribute:1,values:d})}return new y({attributes:l.attributes,indices:l.indices,primitiveType:b.TRIANGLES,boundingSphere:l.boundingSphere,offsetAttribute:r._offsetAttribute})}},J.createShadowVolume=function(e,t,r){var i=e._granularity,o=e._ellipsoid,n=t(i,o),a=r(i,o);return new J({center:e._center,semiMajorAxis:e._semiMajorAxis,semiMinorAxis:e._semiMinorAxis,ellipsoid:o,rotation:e._rotation,stRotation:e._stRotation,granularity:i,extrudedHeight:n,height:a,vertexFormat:N.POSITION_ONLY,shadowVolume:!0})},l(J.prototype,{rectangle:{get:function(){return u(this._rectangle)||(this._rectangle=q(this._center,this._semiMajorAxis,this._semiMinorAxis,this._rotation,this._granularity,this._ellipsoid)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){return u(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];for(var r=c.computeEllipsePositions({center:e._center,semiMajorAxis:e._semiMajorAxis,semiMinorAxis:e._semiMinorAxis,rotation:e._rotation,granularity:e._granularity},!1,!0).outerPositions,o=r.length/3,n=new Array(o),a=0;a<o;++a)n[a]=i.fromArray(r,3*a);var s=e._ellipsoid,u=e.rectangle;return y._textureCoordinateRotationPoints(n,t,s,u)}(this)),this._textureCoordinateRotationPoints}}}),J});