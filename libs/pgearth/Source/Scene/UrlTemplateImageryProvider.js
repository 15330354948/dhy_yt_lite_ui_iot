define(["../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/combine","../Core/Credit","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Event","../Core/GeographicProjection","../Core/isArray","../Core/Math","../Core/Rectangle","../Core/Resource","../Core/WebMercatorTilingScheme","../ThirdParty/when","./ImageryProvider"],function(e,t,r,i,n,o,s,a,u,c,h,l,d,g,m,f,v,y){"use strict";var _=/{[^}]+}/g,p={x:function(e,t,r,i){return L(e,"{x}",t)},y:function(e,t,r,i){return L(e,"{y}",r)},z:function(e,t,r,i){return L(e,"{z}",i)},s:function(e,t,r,i){var n=(t+r+i)%e._subdomains.length;return e._subdomains[n]},reverseX:function(e,t,r,i){var n=e.tilingScheme.getNumberOfXTilesAtLevel(i)-t-1;return L(e,"{reverseX}",n)},reverseY:function(e,t,r,i){var n=e.tilingScheme.getNumberOfYTilesAtLevel(i)-r-1;return L(e,"{reverseY}",n)},reverseZ:function(e,t,r,i){var n=e.maximumLevel,o=s(n)&&i<n?n-i-1:i;return L(e,"{reverseZ}",o)},westDegrees:function(e,t,r,i){return T(e,t,r,i),C.west},southDegrees:function(e,t,r,i){return T(e,t,r,i),C.south},eastDegrees:function(e,t,r,i){return T(e,t,r,i),C.east},northDegrees:function(e,t,r,i){return T(e,t,r,i),C.north},westProjected:function(e,t,r,i){return j(e,t,r,i),S.west},southProjected:function(e,t,r,i){return j(e,t,r,i),S.south},eastProjected:function(e,t,r,i){return j(e,t,r,i),S.east},northProjected:function(e,t,r,i){return j(e,t,r,i),S.north},width:function(e,t,r,i){return e.tileWidth},height:function(e,t,r,i){return e.tileHeight}},w=i(p,{i:function(e,t,r,i,n,o,s){return Z(e,t,r,i,n,o),k.x},j:function(e,t,r,i,n,o,s){return Z(e,t,r,i,n,o),k.y},reverseI:function(e,t,r,i,n,o,s){return Z(e,t,r,i,n,o),e.tileWidth-k.x-1},reverseJ:function(e,t,r,i,n,o,s){return Z(e,t,r,i,n,o),e.tileHeight-k.y-1},longitudeDegrees:function(e,t,r,i,n,o,s){return d.toDegrees(n)},latitudeDegrees:function(e,t,r,i,n,o,s){return d.toDegrees(o)},longitudeProjected:function(e,t,r,i,n,o,s){return W(e,t,r,i,n,o),R.x},latitudeProjected:function(e,t,r,i,n,o,s){return W(e,t,r,i,n,o),R.y},format:function(e,t,r,i,n,o,s){return s}});function b(e){if(!s(e))throw new u("options is required.");if(!v.isPromise(e)&&!s(e.url))throw new u("options is required.");this._errorEvent=new c,this._resource=void 0,this._urlSchemeZeroPadding=void 0,this._pickFeaturesResource=void 0,this._tileWidth=void 0,this._tileHeight=void 0,this._maximumLevel=void 0,this._minimumLevel=void 0,this._tilingScheme=void 0,this._rectangle=void 0,this._tileDiscardPolicy=void 0,this._credit=void 0,this._hasAlphaChannel=void 0,this._readyPromise=void 0,this._tags=void 0,this._pickFeaturesTags=void 0,this.enablePickFeatures=!0,this.reinitialize(e)}a(b.prototype,{url:{get:function(){return this._resource.url}},urlSchemeZeroPadding:{get:function(){return this._urlSchemeZeroPadding}},pickFeaturesUrl:{get:function(){return this._pickFeaturesResource.url}},proxy:{get:function(){return this._resource.proxy}},tileWidth:{get:function(){if(!this.ready)throw new u("tileWidth must not be called before the imagery provider is ready.");return this._tileWidth}},tileHeight:{get:function(){if(!this.ready)throw new u("tileHeight must not be called before the imagery provider is ready.");return this._tileHeight}},maximumLevel:{get:function(){if(!this.ready)throw new u("maximumLevel must not be called before the imagery provider is ready.");return this._maximumLevel}},minimumLevel:{get:function(){if(!this.ready)throw new u("minimumLevel must not be called before the imagery provider is ready.");return this._minimumLevel}},tilingScheme:{get:function(){if(!this.ready)throw new u("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme}},rectangle:{get:function(){if(!this.ready)throw new u("rectangle must not be called before the imagery provider is ready.");return this._rectangle}},tileDiscardPolicy:{get:function(){if(!this.ready)throw new u("tileDiscardPolicy must not be called before the imagery provider is ready.");return this._tileDiscardPolicy}},errorEvent:{get:function(){return this._errorEvent}},ready:{get:function(){return s(this._resource)}},readyPromise:{get:function(){return this._readyPromise}},credit:{get:function(){if(!this.ready)throw new u("credit must not be called before the imagery provider is ready.");return this._credit}},hasAlphaChannel:{get:function(){if(!this.ready)throw new u("hasAlphaChannel must not be called before the imagery provider is ready.");return this._hasAlphaChannel}}}),b.prototype.reinitialize=function(e){var t=this;t._readyPromise=v(e).then(function(e){if(!s(e))throw new u("options is required.");if(!s(e.url))throw new u("options.url is required.");var r=e.customTags,a=i(p,r),c=i(w,r),h=m.createIfNeeded(e.url),d=m.createIfNeeded(e.pickFeaturesUrl);t.enablePickFeatures=o(e.enablePickFeatures,t.enablePickFeatures),t._urlSchemeZeroPadding=o(e.urlSchemeZeroPadding,t.urlSchemeZeroPadding),t._tileDiscardPolicy=e.tileDiscardPolicy,t._getFeatureInfoFormats=e.getFeatureInfoFormats,t._subdomains=e.subdomains,l(t._subdomains)?t._subdomains=t._subdomains.slice():s(t._subdomains)&&t._subdomains.length>0?t._subdomains=t._subdomains.split(""):t._subdomains=["a","b","c"],t._tileWidth=o(e.tileWidth,256),t._tileHeight=o(e.tileHeight,256),t._minimumLevel=o(e.minimumLevel,0),t._maximumLevel=e.maximumLevel,t._tilingScheme=o(e.tilingScheme,new f({ellipsoid:e.ellipsoid})),t._rectangle=o(e.rectangle,t._tilingScheme.rectangle),t._rectangle=g.intersection(t._rectangle,t._tilingScheme.rectangle),t._hasAlphaChannel=o(e.hasAlphaChannel,!0);var v=e.credit;return"string"==typeof v&&(v=new n(v)),t._credit=v,t._resource=h,t._tags=a,t._pickFeaturesResource=d,t._pickFeaturesTags=c,!0})},b.prototype.getTileCredits=function(e,t,r){if(!this.ready)throw new u("getTileCredits must not be called before the imagery provider is ready.")},b.prototype.requestImage=function(e,t,r,i){if(!this.ready)throw new u("requestImage must not be called before the imagery provider is ready.");return y.loadImage(this,function(e,t,r,i,n){P=!1,F=!1;var o=e._resource,a=o.getUrlComponent(!0),u=e._tags,c={},h=a.match(_);s(h)&&h.forEach(function(n){var o=n.substring(1,n.length-1);s(u[o])&&(c[o]=u[o](e,t,r,i))});return o.getDerivedResource({request:n,templateValues:c})}(this,e,t,r,i))},b.prototype.pickFeatures=function(e,t,r,i,n){if(!this.ready)throw new u("pickFeatures must not be called before the imagery provider is ready.");if(this.enablePickFeatures&&s(this._pickFeaturesResource)&&0!==this._getFeatureInfoFormats.length){var o=0,a=this;return function u(){if(o>=a._getFeatureInfoFormats.length)return v([]);var c=a._getFeatureInfoFormats[o],h=function(e,t,r,i,n,o,a){P=!1,F=!1,D=!1,x=!1;var u=e._pickFeaturesResource,c=u.getUrlComponent(!0),h=e._pickFeaturesTags,l={},d=c.match(_);return s(d)&&d.forEach(function(u){var c=u.substring(1,u.length-1);s(h[c])&&(l[c]=h[c](e,t,r,i,n,o,a))}),u.getDerivedResource({templateValues:l})}(a,e,t,r,i,n,c.format);return++o,"json"===c.type?h.fetchJson().then(c.callback).otherwise(u):"xml"===c.type?h.fetchXML().then(c.callback).otherwise(u):"text"===c.type||"html"===c.type?h.fetchText().then(c.callback).otherwise(u):h.fetch({responseType:c.format}).then(function(e,t){return e.callback(t)}.bind(void 0,c)).otherwise(u)}()}};var P=!1,C=new g,F=!1,S=new g;var D=!1,k=new e,x=!1;function L(e,t,r){if(e&&e.urlSchemeZeroPadding&&e.urlSchemeZeroPadding.hasOwnProperty(t)){var i=e.urlSchemeZeroPadding[t];if("string"==typeof i){var n=i.length;n>1&&(r=r.length>=n?r:new Array(n-r.toString().length+1).join("0")+r)}}return r}function T(e,t,r,i){P||(e.tilingScheme.tileXYToRectangle(t,r,i,C),C.west=d.toDegrees(C.west),C.south=d.toDegrees(C.south),C.east=d.toDegrees(C.east),C.north=d.toDegrees(C.north),P=!0)}function j(e,t,r,i){F||(e.tilingScheme.tileXYToNativeRectangle(t,r,i,S),F=!0)}var I=new g,R=new t;function Z(e,t,r,i,n,o,s){if(!D){W(e,t,r,i,n,o);var a=R,u=e.tilingScheme.tileXYToNativeRectangle(t,r,i,I);k.x=e.tileWidth*(a.x-u.west)/u.width|0,k.y=e.tileHeight*(u.north-a.y)/u.height|0,D=!0}}var A=new r;function W(e,t,r,i,n,o,s){if(!x){if(e.tilingScheme.projection instanceof h)R.x=d.toDegrees(n),R.y=d.toDegrees(o);else{var a=A;a.longitude=n,a.latitude=o,e.tilingScheme.projection.project(a,R)}x=!0}}return b});