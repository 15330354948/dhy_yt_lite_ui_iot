define(["../Core/BoundingSphere","../Core/Color","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/EncodedCartesian3","../Core/Math","../Core/Matrix4","../Core/PrimitiveType","../Core/WebGLConstants","../Renderer/BufferUsage","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArrayFacade","../Shaders/PointPrimitiveCollectionFS","../Shaders/PointPrimitiveCollectionVS","./BlendingState","./BlendOption","./PointPrimitive","./SceneMode"],function(e,t,i,s,n,r,o,a,h,d,_,p,c,l,u,m,D,T,v,S,f,A,y,C,P,b,E){"use strict";var x=b.SHOW_INDEX,g=b.POSITION_INDEX,N=b.COLOR_INDEX,I=b.OUTLINE_COLOR_INDEX,O=b.OUTLINE_WIDTH_INDEX,B=b.PIXEL_SIZE_INDEX,U=b.SCALE_BY_DISTANCE_INDEX,L=b.TRANSLUCENCY_BY_DISTANCE_INDEX,R=b.DISTANCE_DISPLAY_CONDITION_INDEX,V=b.DISABLE_DEPTH_DISTANCE_INDEX,w=b.NUMBER_OF_PROPERTIES,M={positionHighAndSize:0,positionLowAndOutline:1,compressedAttribute0:2,compressedAttribute1:3,scaleByDistance:4,distanceDisplayConditionAndDisableDepth:5};function W(t){t=s(t,s.EMPTY_OBJECT),this._sp=void 0,this._spTranslucent=void 0,this._rsOpaque=void 0,this._rsTranslucent=void 0,this._vaf=void 0,this._pointPrimitives=[],this._pointPrimitivesToUpdate=[],this._pointPrimitivesToUpdateIndex=0,this._pointPrimitivesRemoved=!1,this._createVertexArray=!1,this._shaderScaleByDistance=!1,this._compiledShaderScaleByDistance=!1,this._shaderTranslucencyByDistance=!1,this._compiledShaderTranslucencyByDistance=!1,this._shaderDistanceDisplayCondition=!1,this._compiledShaderDistanceDisplayCondition=!1,this._shaderDisableDepthDistance=!1,this._compiledShaderDisableDepthDistance=!1,this._propertiesChanged=new Uint32Array(w),this._maxPixelSize=1,this._baseVolume=new e,this._baseVolumeWC=new e,this._baseVolume2D=new e,this._boundingVolume=new e,this._boundingVolumeDirty=!1,this._colorCommands=[],this.modelMatrix=_.clone(s(t.modelMatrix,_.IDENTITY)),this._modelMatrix=_.clone(_.IDENTITY),this.debugShowBoundingVolume=s(t.debugShowBoundingVolume,!1),this.blendOption=s(t.blendOption,P.OPAQUE_AND_TRANSLUCENT),this._blendOption=void 0,this._mode=E.SCENE3D,this._maxTotalPointSize=1,this._buffersUsage=[l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW,l.STATIC_DRAW];var i=this;this._uniforms={u_maxTotalPointSize:function(){return i._maxTotalPointSize}}}function z(e){for(var t=e.length,i=0;i<t;++i)e[i]&&e[i]._destroy()}function Y(e){if(e._pointPrimitivesRemoved){e._pointPrimitivesRemoved=!1;for(var t=[],i=e._pointPrimitives,s=i.length,n=0,r=0;n<s;++n){var o=i[n];o&&(o._index=r++,t.push(o))}e._pointPrimitives=t}}r(W.prototype,{length:{get:function(){return Y(this),this._pointPrimitives.length}}}),W.prototype.add=function(e){var t=new b(e,this);return t._index=this._pointPrimitives.length,this._pointPrimitives.push(t),this._createVertexArray=!0,t},W.prototype.remove=function(e){return!!this.contains(e)&&(this._pointPrimitives[e._index]=null,this._pointPrimitivesRemoved=!0,this._createVertexArray=!0,e._destroy(),!0)},W.prototype.removeAll=function(){z(this._pointPrimitives),this._pointPrimitives=[],this._pointPrimitivesToUpdate=[],this._pointPrimitivesToUpdateIndex=0,this._pointPrimitivesRemoved=!1,this._createVertexArray=!0},W.prototype._updatePointPrimitive=function(e,t){e._dirty||(this._pointPrimitivesToUpdate[this._pointPrimitivesToUpdateIndex++]=e),++this._propertiesChanged[t]},W.prototype.contains=function(e){return n(e)&&e._pointPrimitiveCollection===this},W.prototype.get=function(e){if(!n(e))throw new a("index is required.");return Y(this),this._pointPrimitives[e]},W.prototype.computeNewBuffersUsage=function(){for(var e=this._buffersUsage,t=!1,i=this._propertiesChanged,s=0;s<w;++s){var n=0===i[s]?l.STATIC_DRAW:l.STREAM_DRAW;t=t||e[s]!==n,e[s]=n}return t};var Q=new h;function X(t,i,s,n){var r=n._index,o=n._getActualPosition();t._mode===E.SCENE3D&&(e.expand(t._baseVolume,o,t._baseVolume),t._boundingVolumeDirty=!0),h.fromCartesian(o,Q);var a=n.pixelSize,d=n.outlineWidth;t._maxPixelSize=Math.max(t._maxPixelSize,a+d);var _=s[M.positionHighAndSize],p=Q.high;_(r,p.x,p.y,p.z,a);var c=s[M.positionLowAndOutline],l=Q.low;c(r,l.x,l.y,l.z,d)}var F=65536,H=256;function k(e,i,s,n){var r=n._index,o=n.color,a=n.getPickId(i).color,h=n.outlineColor,d=t.floatToByte(o.red),_=t.floatToByte(o.green),p=t.floatToByte(o.blue),c=d*F+_*H+p;d=t.floatToByte(h.red),_=t.floatToByte(h.green),p=t.floatToByte(h.blue);var l=d*F+_*H+p;d=t.floatToByte(a.red),_=t.floatToByte(a.green),p=t.floatToByte(a.blue);var u=d*F+_*H+p,m=t.floatToByte(o.alpha)*F+t.floatToByte(h.alpha)*H+t.floatToByte(a.alpha);(0,s[M.compressedAttribute0])(r,c,l,u,m)}function q(e,t,i,s){var r=s._index,o=0,a=1,h=1,_=1,p=s.translucencyByDistance;n(p)&&(o=p.near,a=p.nearValue,h=p.far,_=p.farValue,1===a&&1===_||(e._shaderTranslucencyByDistance=!0));var c=s.show&&s.clusterShow;0===s.color.alpha&&0===s.outlineColor.alpha&&(c=!1),a=1===(a=d.clamp(a,0,1))?255:255*a|0;var l=(c?1:0)*H+a,u=_=1===(_=d.clamp(_,0,1))?255:255*_|0;(0,i[M.compressedAttribute1])(r,l,u,o,h)}function G(e,t,i,s){var r=s._index,o=i[M.scaleByDistance],a=0,h=1,d=1,_=1,p=s.scaleByDistance;n(p)&&(a=p.near,h=p.nearValue,d=p.far,_=p.farValue,1===h&&1===_||(e._shaderScaleByDistance=!0)),o(r,a,h,d,_)}function j(e,t,i,s){var r=s._index,o=i[M.distanceDisplayConditionAndDisableDepth],a=0,h=Number.MAX_VALUE,d=s.distanceDisplayCondition;n(d)&&(a=d.near,h=d.far,a*=a,h*=h,e._shaderDistanceDisplayCondition=!0);var _=s.disableDepthTestDistance;(_*=_)>0&&(e._shaderDisableDepthDistance=!0,_===Number.POSITIVE_INFINITY&&(_=-1)),o(r,a,h,_)}function J(e,t,i,s){X(e,0,i,s),k(0,t,i,s),q(e,0,i,s),G(e,0,i,s),j(e,0,i,s)}function Z(t,i,s,r,o,a){var h;r.mode===E.SCENE3D?(h=t._baseVolume,t._boundingVolumeDirty=!0):h=t._baseVolume2D;for(var d=[],_=0;_<s;++_){var p=i[_],c=p.position,l=b._computeActualPosition(c,r,o);n(l)&&(p._setActualPosition(l),a?d.push(l):e.expand(h,l,h))}a&&e.fromPoints(d,h)}var K=[];return W.prototype.update=function(t){Y(this),this._maxTotalPointSize=u.maximumAliasedPointSize,function(e,t){var i=t.mode,s=e._pointPrimitives,n=e._pointPrimitivesToUpdate,r=e._modelMatrix;e._createVertexArray||e._mode!==i||i!==E.SCENE3D&&!_.equals(r,e.modelMatrix)?(e._mode=i,_.clone(e.modelMatrix,r),e._createVertexArray=!0,i!==E.SCENE3D&&i!==E.SCENE2D&&i!==E.COLUMBUS_VIEW||Z(e,s,s.length,t,r,!0)):i===E.MORPHING?Z(e,s,s.length,t,r,!0):i!==E.SCENE2D&&i!==E.COLUMBUS_VIEW||Z(e,n,e._pointPrimitivesToUpdateIndex,t,r,!1)}(this,t);var s,r=this._pointPrimitives.length,o=this._pointPrimitivesToUpdate,a=this._pointPrimitivesToUpdateIndex,h=this._propertiesChanged,d=this._createVertexArray,l=t.context,b=t.passes,W=b.pick;if(d||!W&&this.computeNewBuffersUsage()){this._createVertexArray=!1;for(var z=0;z<w;++z)h[z]=0;if(this._vaf=this._vaf&&this._vaf.destroy(),r>0){this._vaf=function(e,t,s){return new f(e,[{index:M.positionHighAndSize,componentsPerAttribute:4,componentDatatype:i.FLOAT,usage:s[g]},{index:M.positionLowAndShow,componentsPerAttribute:4,componentDatatype:i.FLOAT,usage:s[g]},{index:M.compressedAttribute0,componentsPerAttribute:4,componentDatatype:i.FLOAT,usage:s[N]},{index:M.compressedAttribute1,componentsPerAttribute:4,componentDatatype:i.FLOAT,usage:s[L]},{index:M.scaleByDistance,componentsPerAttribute:4,componentDatatype:i.FLOAT,usage:s[U]},{index:M.distanceDisplayConditionAndDisableDepth,componentsPerAttribute:3,componentDatatype:i.FLOAT,usage:s[R]}],t)}(l,r,this._buffersUsage),s=this._vaf.writers;for(var Q=0;Q<r;++Q){var F=this._pointPrimitives[Q];F._dirty=!1,J(this,l,s,F)}this._vaf.commit()}this._pointPrimitivesToUpdateIndex=0}else if(a>0){var H=K;H.length=0,(h[g]||h[O]||h[B])&&H.push(X),(h[N]||h[I])&&H.push(k),(h[x]||h[L])&&H.push(q),h[U]&&H.push(G),(h[R]||h[V])&&H.push(j);var $=H.length;if(s=this._vaf.writers,a/r>.1){for(var ee=0;ee<a;++ee){var te=o[ee];te._dirty=!1;for(var ie=0;ie<$;++ie)H[ie](this,l,s,te)}this._vaf.commit()}else{for(var se=0;se<a;++se){var ne=o[se];ne._dirty=!1;for(var re=0;re<$;++re)H[re](this,l,s,ne);this._vaf.subCommit(ne._index,1)}this._vaf.endSubCommits()}this._pointPrimitivesToUpdateIndex=0}if(a>1.5*r&&(o.length=r),n(this._vaf)&&n(this._vaf.va)){var oe;this._boundingVolumeDirty&&(this._boundingVolumeDirty=!1,e.transform(this._baseVolume,this.modelMatrix,this._baseVolumeWC));var ae=_.IDENTITY;t.mode===E.SCENE3D?(ae=this.modelMatrix,oe=e.clone(this._baseVolumeWC,this._boundingVolume)):oe=e.clone(this._baseVolume2D,this._boundingVolume),function(e,t,i){var s=t.camera.getPixelSize(i,t.context.drawingBufferWidth,t.context.drawingBufferHeight)*e._maxPixelSize;i.radius+=s}(this,t,oe);var he,de,_e,pe,ce,le,ue=this._blendOption!==this.blendOption;this._blendOption=this.blendOption,ue&&(this._blendOption===P.OPAQUE||this._blendOption===P.OPAQUE_AND_TRANSLUCENT?this._rsOpaque=T.fromCache({depthTest:{enabled:!0,func:c.LEQUAL},depthMask:!0}):this._rsOpaque=void 0,this._blendOption===P.TRANSLUCENT||this._blendOption===P.OPAQUE_AND_TRANSLUCENT?this._rsTranslucent=T.fromCache({depthTest:{enabled:!0,func:c.LEQUAL},depthMask:!1,blending:C.ALPHA_BLEND}):this._rsTranslucent=void 0),this._shaderDisableDepthDistance=this._shaderDisableDepthDistance||0!==t.minimumDisableDepthTestDistance,(ue||this._shaderScaleByDistance&&!this._compiledShaderScaleByDistance||this._shaderTranslucencyByDistance&&!this._compiledShaderTranslucencyByDistance||this._shaderDistanceDisplayCondition&&!this._compiledShaderDistanceDisplayCondition||this._shaderDisableDepthDistance!==this._compiledShaderDisableDepthDistance)&&(he=new S({sources:[y]}),this._shaderScaleByDistance&&he.defines.push("EYE_DISTANCE_SCALING"),this._shaderTranslucencyByDistance&&he.defines.push("EYE_DISTANCE_TRANSLUCENCY"),this._shaderDistanceDisplayCondition&&he.defines.push("DISTANCE_DISPLAY_CONDITION"),this._shaderDisableDepthDistance&&he.defines.push("DISABLE_DEPTH_DISTANCE"),this._blendOption===P.OPAQUE_AND_TRANSLUCENT&&(de=new S({defines:["OPAQUE"],sources:[A]}),this._sp=v.replaceCache({context:l,shaderProgram:this._sp,vertexShaderSource:he,fragmentShaderSource:de,attributeLocations:M}),de=new S({defines:["TRANSLUCENT"],sources:[A]}),this._spTranslucent=v.replaceCache({context:l,shaderProgram:this._spTranslucent,vertexShaderSource:he,fragmentShaderSource:de,attributeLocations:M})),this._blendOption===P.OPAQUE&&(de=new S({sources:[A]}),this._sp=v.replaceCache({context:l,shaderProgram:this._sp,vertexShaderSource:he,fragmentShaderSource:de,attributeLocations:M})),this._blendOption===P.TRANSLUCENT&&(de=new S({sources:[A]}),this._spTranslucent=v.replaceCache({context:l,shaderProgram:this._spTranslucent,vertexShaderSource:he,fragmentShaderSource:de,attributeLocations:M})),this._compiledShaderScaleByDistance=this._shaderScaleByDistance,this._compiledShaderTranslucencyByDistance=this._shaderTranslucencyByDistance,this._compiledShaderDistanceDisplayCondition=this._shaderDistanceDisplayCondition,this._compiledShaderDisableDepthDistance=this._shaderDisableDepthDistance);var me=t.commandList;if(b.render||W){var De=this._colorCommands,Te=this._blendOption===P.OPAQUE,ve=this._blendOption===P.OPAQUE_AND_TRANSLUCENT;pe=(_e=this._vaf.va).length,De.length=pe;var Se=ve?2*pe:pe;for(le=0;le<Se;++le){var fe=Te||ve&&le%2==0;ce=De[le],n(ce)||(ce=De[le]=new m),ce.primitiveType=p.POINTS,ce.pass=fe||!ve?D.OPAQUE:D.TRANSLUCENT,ce.owner=this;var Ae=ve?Math.floor(le/2):le;ce.boundingVolume=oe,ce.modelMatrix=ae,ce.shaderProgram=fe?this._sp:this._spTranslucent,ce.uniformMap=this._uniforms,ce.vertexArray=_e[Ae].va,ce.renderState=fe?this._rsOpaque:this._rsTranslucent,ce.debugShowBoundingVolume=this.debugShowBoundingVolume,ce.pickId="v_pickColor",me.push(ce)}}}},W.prototype.isDestroyed=function(){return!1},W.prototype.destroy=function(){return this._sp=this._sp&&this._sp.destroy(),this._spTranslucent=this._spTranslucent&&this._spTranslucent.destroy(),this._spPick=this._spPick&&this._spPick.destroy(),this._vaf=this._vaf&&this._vaf.destroy(),z(this._pointPrimitives),o(this)},W});