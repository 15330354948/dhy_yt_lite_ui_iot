define(["../Core/arraySlice","../Core/BoundingSphere","../Core/Cartesian3","../Core/Cartesian4","../Core/Math","../Core/Check","../Core/Color","../Core/combine","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/FeatureDetection","../Core/getStringFromTypedArray","../Core/Matrix4","../Core/oneTimeWarning","../Core/OrthographicFrustum","../Core/Plane","../Core/PrimitiveType","../Core/RuntimeError","../Core/Transforms","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArray","../ThirdParty/when","./BlendingState","./PGEarth3DTileBatchTable","./PGEarth3DTileFeature","./PGEarth3DTileFeatureTable","./DracoLoader","./getClipAndStyleCode","./getClippingFunction","./SceneMode","./ShadowMode","./StencilConstants"],function(e,t,r,o,n,i,a,s,d,l,c,_,u,h,m,p,f,y,g,S,v,T,E,A,C,I,b,P,O,N,D,R,B,L,w,z,x,G,M,F,U){"use strict";if(!h.supportsTypedArrays())return{};var q={NEEDS_DECODE:0,DECODING:1,READY:2,FAILED:3};function V(t){i.typeOf.object("options",t),i.typeOf.object("options.arrayBuffer",t.arrayBuffer),this._parsedContent=void 0,this._drawCommand=void 0,this._isTranslucent=!1,this._styleTranslucent=!1,this._constantColor=a.clone(a.DARKGRAY),this._highlightColor=a.clone(a.WHITE),this._pointSize=1,this._rtcCenter=void 0,this._quantizedVolumeScale=void 0,this._quantizedVolumeOffset=void 0,this._styleableShaderAttributes=void 0,this._isQuantized=!1,this._isOctEncoded16P=!1,this._isRGB565=!1,this._hasColors=!1,this._hasNormals=!1,this._hasBatchIds=!1,this._decodingState=q.READY,this._dequantizeInShader=!0,this._isQuantizedDraco=!1,this._isOctEncodedDraco=!1,this._quantizedRange=0,this._octEncodedRange=0,this.backFaceCulling=!1,this._backFaceCulling=!1,this.normalShading=!0,this._normalShading=!0,this._opaqueRenderState=void 0,this._translucentRenderState=void 0,this._mode=void 0,this._ready=!1,this._readyPromise=D.defer(),this._pointsLength=0,this._geometryByteLength=0,this._vertexShaderLoaded=t.vertexShaderLoaded,this._fragmentShaderLoaded=t.fragmentShaderLoaded,this._uniformMapLoaded=t.uniformMapLoaded,this._batchTableLoaded=t.batchTableLoaded,this._pickIdLoaded=t.pickIdLoaded,this._opaquePass=l(t.opaquePass,I.OPAQUE),this._cull=l(t.cull,!0),this.style=void 0,this._style=void 0,this.styleDirty=!1,this.modelMatrix=p.clone(p.IDENTITY),this._modelMatrix=p.clone(p.IDENTITY),this.time=0,this.shadows=F.ENABLED,this._boundingSphere=void 0,this.clippingPlanes=void 0,this.isClipped=!1,this.clippingPlanesDirty=!1,this.clippingPlanesOriginMatrix=void 0,this.attenuation=!1,this._attenuation=!1,this.geometricError=0,this.geometricErrorScale=1,this.maximumAttenuation=this._pointSize,function(t,o){var n=o.arrayBuffer,i=l(o.byteOffset,0),_=new Uint8Array(n),u=new DataView(n);i+=H;var h=u.getUint32(i,!0);if(1!==h)throw new v("Only Point Cloud tile version 1 is supported.  Version "+h+" is not.");i+=H,i+=H;var p=u.getUint32(i,!0);if(0===p)throw new v("Feature table must have a byte length greater than zero");i+=H;var f=u.getUint32(i,!0);i+=H;var y=u.getUint32(i,!0);i+=H;var g=u.getUint32(i,!0),S=m(_,i+=H,p),T=JSON.parse(S);i+=p;var E,A,C=new Uint8Array(n,i,f);if(i+=f,y>0){var I=m(_,i,y);E=JSON.parse(I),i+=y,g>0&&(A=new Uint8Array(n,i,g),i+=g)}var b=new w(T,C),P=b.getGlobalProperty("POINTS_LENGTH");if(b.featuresLength=P,!c(P))throw new v("Feature table global property: POINTS_LENGTH must be defined");var O,N,D,R,L=b.getGlobalProperty("RTC_CENTER",d.FLOAT,3);c(L)&&(t._rtcCenter=r.unpack(L));var z,x,G,M,F,U=!1,V=!1,k=!1,Q=!1,Y=!1,Z=!1,W=!1,j=!1,J=c(T.extensions)?T.extensions["3DTILES_draco_point_compression"]:void 0,K=c(E)&&c(E.extensions)?E.extensions["3DTILES_draco_point_compression"]:void 0;c(K)&&(G=K.properties);if(c(J)){x=J.properties;var X=J.byteOffset,$=J.byteLength;if(!c(x)||!c(X)||!c($))throw new v("Draco properties, byteOffset, and byteLength must be defined");z=e(C,X,X+$),U=c(x.POSITION),V=c(x.RGB)||c(x.RGBA),k=c(x.NORMAL),Q=c(x.BATCH_ID),Z=c(x.RGBA),t._decodingState=q.NEEDS_DECODE}c(z)&&(M={buffer:z,featureTableProperties:x,batchTableProperties:G,properties:s(x,G),dequantizeInShader:t._dequantizeInShader});if(!U)if(c(T.POSITION))O=b.getPropertyArray("POSITION",d.FLOAT,3),U=!0;else if(c(T.POSITION_QUANTIZED)){O=b.getPropertyArray("POSITION_QUANTIZED",d.UNSIGNED_SHORT,3),Y=!0,U=!0;var ee=b.getGlobalProperty("QUANTIZED_VOLUME_SCALE",d.FLOAT,3);if(!c(ee))throw new v("Global property: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");t._quantizedVolumeScale=r.unpack(ee),t._quantizedRange=65535;var te=b.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",d.FLOAT,3);if(!c(te))throw new v("Global property: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");t._quantizedVolumeOffset=r.unpack(te)}V||(c(T.RGBA)?(N=b.getPropertyArray("RGBA",d.UNSIGNED_BYTE,4),Z=!0,V=!0):c(T.RGB)?(N=b.getPropertyArray("RGB",d.UNSIGNED_BYTE,3),V=!0):c(T.RGB565)&&(N=b.getPropertyArray("RGB565",d.UNSIGNED_SHORT,1),W=!0,V=!0));k||(c(T.NORMAL)?(D=b.getPropertyArray("NORMAL",d.FLOAT,3),k=!0):c(T.NORMAL_OCT16P)&&(D=b.getPropertyArray("NORMAL_OCT16P",d.UNSIGNED_BYTE,2),j=!0,k=!0));Q||c(T.BATCH_ID)&&(R=b.getPropertyArray("BATCH_ID",d.UNSIGNED_SHORT,1),Q=!0);if(!U)throw new v("Either POSITION or POSITION_QUANTIZED must be defined.");if(c(T.CONSTANT_RGBA)){var re=b.getGlobalProperty("CONSTANT_RGBA",d.UNSIGNED_BYTE,4);t._constantColor=a.fromBytes(re[0],re[1],re[2],re[3],t._constantColor)}if(Q){var oe=b.getGlobalProperty("BATCH_LENGTH");if(!c(oe))throw new v("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");c(A)&&(A=new Uint8Array(A)),c(t._batchTableLoaded)&&t._batchTableLoaded(oe,E,A)}!Q&&c(A)&&(F=B.getBinaryProperties(P,E,A));t._parsedContent={positions:O,colors:N,normals:D,batchIds:R,styleableProperties:F,draco:M},t._pointsLength=P,t._isQuantized=Y,t._isOctEncoded16P=j,t._isRGB565=W,t._isTranslucent=Z,t._hasColors=V,t._hasNormals=k,t._hasBatchIds=Q}(this,t)}_(V.prototype,{pointsLength:{get:function(){return this._pointsLength}},geometryByteLength:{get:function(){return this._geometryByteLength}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},color:{get:function(){return a.clone(this._highlightColor)},set:function(e){this._highlightColor=a.clone(e,this._highlightColor)}},boundingSphere:{get:function(){if(c(this._drawCommand))return this._drawCommand.boundingVolume},set:function(e){this._boundingSphere=t.clone(e)}}});var H=Uint32Array.BYTES_PER_ELEMENT;var k,Q=new r,Y=new r,Z=new r;function W(e){if(!c(k)){n.setRandomNumberSeed(0),k=new Array(e);for(var t=0;t<e;++t)k[t]=n.nextRandomNumber()}return k}function j(e,t){var r=d.fromTypedArray(e);return r===d.INT||r===d.UNSIGNED_INT||r===d.DOUBLE?(f("Cast pnts property to floats",'Point cloud property "'+t+'" will be casted to a float array because INT, UNSIGNED_INT, and DOUBLE are not valid WebGL vertex attribute types. Some precision may be lost.'),new Float32Array(e)):e}var J=new o,K=new o,X=new a,$=0,ee=1,te=2,re=3,oe=4,ne=new p;function ie(e,o){var i,a,s=o.context,l=e._parsedContent,_=e._pointsLength,u=l.positions,h=l.colors,m=l.normals,f=l.batchIds,y=l.styleableProperties,g=c(y),v=e._isQuantized,T=e._isQuantizedDraco,P=e._isOctEncoded16P,O=e._isOctEncodedDraco,D=e._quantizedRange,B=e._octEncodedRange,L=e._isRGB565,w=e._isTranslucent,z=e._hasColors,x=e._hasNormals,G=e._hasBatchIds,M=[],F={};if(e._styleableShaderAttributes=F,g){var q=oe;for(var V in y)if(y.hasOwnProperty(V)){var H=y[V],k=j(H.typedArray,V);i=H.componentCount,a=d.fromTypedArray(k);var J=E.createVertexBuffer({context:s,typedArray:k,usage:A.STATIC_DRAW});e._geometryByteLength+=J.sizeInBytes;var K={index:q,vertexBuffer:J,componentsPerAttribute:i,componentDatatype:a,normalize:!1,offsetInBytes:0,strideInBytes:0};M.push(K),F[V]={location:q,componentCount:i},++q}}var X,ne,ie,ae=E.createVertexBuffer({context:s,typedArray:u,usage:A.STATIC_DRAW});e._geometryByteLength+=ae.sizeInBytes,z&&(X=E.createVertexBuffer({context:s,typedArray:h,usage:A.STATIC_DRAW}),e._geometryByteLength+=X.sizeInBytes),x&&(ne=E.createVertexBuffer({context:s,typedArray:m,usage:A.STATIC_DRAW}),e._geometryByteLength+=ne.sizeInBytes),G&&(f=j(f,"batchIds"),ie=E.createVertexBuffer({context:s,typedArray:f,usage:A.STATIC_DRAW}),e._geometryByteLength+=ie.sizeInBytes);var se=[];if(a=v?d.UNSIGNED_SHORT:T?D<=255?d.UNSIGNED_BYTE:d.UNSIGNED_SHORT:d.FLOAT,se.push({index:$,vertexBuffer:ae,componentsPerAttribute:3,componentDatatype:a,normalize:!1,offsetInBytes:0,strideInBytes:0}),e._cull&&(e._boundingSphere=v||T?t.fromCornerPoints(r.ZERO,e._quantizedVolumeScale):function(e){for(var o=e.length/3,i=Math.min(o,20),a=W(20),s=Number.MAX_VALUE,d=-Number.MAX_VALUE,l=r.fromElements(s,s,s,Q),c=r.fromElements(d,d,d,Y),_=0;_<i;++_){var u=Math.floor(a[_]*o),h=r.unpack(e,3*u,Z);r.minimumByComponent(l,h,l),r.maximumByComponent(c,h,c)}var m=t.fromCornerPoints(l,c);return m.radius+=n.EPSILON2,m}(u)),z)if(L)se.push({index:ee,vertexBuffer:X,componentsPerAttribute:1,componentDatatype:d.UNSIGNED_SHORT,normalize:!1,offsetInBytes:0,strideInBytes:0});else{var de=w?4:3;se.push({index:ee,vertexBuffer:X,componentsPerAttribute:de,componentDatatype:d.UNSIGNED_BYTE,normalize:!0,offsetInBytes:0,strideInBytes:0})}x&&(P?(i=2,a=d.UNSIGNED_BYTE):O?(i=2,a=B<=255?d.UNSIGNED_BYTE:d.UNSIGNED_SHORT):(i=3,a=d.FLOAT),se.push({index:te,vertexBuffer:ne,componentsPerAttribute:i,componentDatatype:a,normalize:!1,offsetInBytes:0,strideInBytes:0})),G&&se.push({index:re,vertexBuffer:ie,componentsPerAttribute:1,componentDatatype:d.fromTypedArray(f),normalize:!1,offsetInBytes:0,strideInBytes:0}),g&&(se=se.concat(M));var le=new N({context:s,attributes:se}),ce={depthTest:{enabled:!0}};e._opaquePass===I.PGEARTH_3D_TILE&&(ce.stencilTest=U.setPGEarth3DTileBit(),ce.stencilMask=U.PGEARTH_3D_TILE_MASK),e._opaqueRenderState=b.fromCache(ce),e._translucentRenderState=b.fromCache({depthTest:{enabled:!0},depthMask:!1,blending:R.ALPHA_BLEND}),e._drawCommand=new C({boundingVolume:new t,cull:e._cull,modelMatrix:new p,primitiveType:S.POINTS,vertexArray:le,count:_,shaderProgram:void 0,uniformMap:void 0,renderState:w?e._translucentRenderState:e._opaqueRenderState,pass:w?I.TRANSLUCENT:e._opaquePass,owner:e,castShadows:!1,receiveShadows:!1,pickId:e._pickIdLoaded()})}var ae=["POSITION","COLOR","NORMAL","POSITION_ABSOLUTE"];function se(e,t){for(var r=/czm_tiles3d_style_(\w+)/g,o=r.exec(e);null!==o;){var n=o[1];-1===t.indexOf(n)&&t.push(n),o=r.exec(e)}}function de(e,t){for(var r=e.numberOfAttributes,o=0;o<r;++o){var n=e.getAttribute(o);if(n.index===t)return n}}function le(e){for(var t=ae.length,r=0;r<t;++r){var o=ae[r],n="czm_tiles3d_style_"+o,i=o.toLowerCase();e=e.replace(new RegExp(n+"(\\W)","g"),i+"$1")}return e.replace("()","(vec3 position, vec3 position_absolute, vec4 color, vec3 normal)")}function ce(e,t,o){var n,i,d,_,u,h,m=t.context,f=c(o),g=e._isQuantized,S=e._isQuantizedDraco,T=e._isOctEncoded16P,E=e._isOctEncodedDraco,A=e._isRGB565,C=e._isTranslucent,I=e._hasColors,b=e._hasNormals,O=e._hasBatchIds,N=e._backFaceCulling,D=e._normalShading,R=e._drawCommand.vertexArray,B=e.clippingPlanes,L=e._attenuation,w=C;if(f){var z={translucent:!1};_=o.getColorShaderFunction("getColorFromStyle","czm_tiles3d_style_",z),u=o.getShowShaderFunction("getShowFromStyle","czm_tiles3d_style_",z),h=o.getPointSizeShaderFunction("getPointSizeFromStyle","czm_tiles3d_style_",z),c(_)&&z.translucent&&(w=!0)}e._styleTranslucent=w;var F=c(_),U=c(u),q=c(h),V=e.isClipped,H=[];F&&(se(_,H),_=le(_)),U&&(se(u,H),u=le(u)),q&&(se(h,H),h=le(h));var k=H.indexOf("COLOR")>=0,Q=H.indexOf("NORMAL")>=0,Y=H.filter(function(e){return-1===ae.indexOf(e)});if(Q&&!b)throw new v("Style references the NORMAL semantic but the point cloud does not have normals");var Z=e._styleableShaderAttributes;for(i in Z)if(Z.hasOwnProperty(i)){d=Z[i];var W=Y.indexOf(i)>=0;de(R,d.location).enabled=W}var j=I&&(!F||k);I&&(de(R,ee).enabled=j);var oe=b&&(D||N||Q);b&&(de(R,te).enabled=oe);var ie={a_position:$};j&&(ie.a_color=ee),oe&&(ie.a_normal=te),O&&(ie.a_batchId=re);var ce="",_e=Y.length;for(n=0;n<_e;++n){if(d=Z[i=Y[n]],!c(d))throw new v('Style references a property "'+i+'" that does not exist or is not styleable.');var ue=d.componentCount,he="czm_tiles3d_style_"+i;ce+="attribute "+(1===ue?"float":"vec"+ue)+" "+he+"; \n",ie[he]=d.location}!function(e,t){var o=t.context,n=e._isQuantized,i=e._isQuantizedDraco,d=e._isOctEncodedDraco,_={u_pointSizeAndTimeAndGeometricErrorAndDepthMultiplier:function(){var r=J;if(r.x=e._attenuation?e.maximumAttenuation:e._pointSize,r.y=e.time,e._attenuation){var n,i=t.camera.frustum;n=t.mode===M.SCENE2D||i instanceof y?Number.POSITIVE_INFINITY:o.drawingBufferHeight/t.camera.frustum.sseDenominator,r.z=e.geometricError*e.geometricErrorScale,r.w=n}return r},u_highlightColor:function(){return e._highlightColor},u_constantColor:function(){return e._constantColor},u_clippingPlanes:function(){var t=e.clippingPlanes;return e.isClipped?t.texture:o.defaultTexture},u_clippingPlanesEdgeStyle:function(){var t=e.clippingPlanes;if(!c(t))return a.TRANSPARENT;var r=a.clone(t.edgeColor,X);return r.alpha=t.edgeWidth,r},u_clippingPlanesMatrix:function(){var t=e.clippingPlanes;if(!c(t))return p.IDENTITY;var r=l(e.clippingPlanesOriginMatrix,e._modelMatrix);return p.multiply(o.uniformState.view3D,r,ne),p.multiply(ne,t.modelMatrix,ne)}};(n||i||d)&&(_=s(_,{u_quantizedVolumeScaleAndOctEncodedRange:function(){var t=K;if(c(e._quantizedVolumeScale)){var o=r.clone(e._quantizedVolumeScale,t);r.divideByScalar(o,e._quantizedRange,t)}return t.w=e._octEncodedRange,t}})),c(e._uniformMapLoaded)&&(_=e._uniformMapLoaded(_)),e._drawCommand.uniformMap=_}(e,t);var me="attribute vec3 a_position; \nvarying vec4 v_color; \nuniform vec4 u_pointSizeAndTimeAndGeometricErrorAndDepthMultiplier; \nuniform vec4 u_constantColor; \nuniform vec4 u_highlightColor; \n";me+="float u_pointSize; \nfloat u_time; \n",L&&(me+="float u_geometricError; \nfloat u_depthMultiplier; \n"),me+=ce,j&&(me+=C?"attribute vec4 a_color; \n":A?"attribute float a_color; \nconst float SHIFT_RIGHT_11 = 1.0 / 2048.0; \nconst float SHIFT_RIGHT_5 = 1.0 / 32.0; \nconst float SHIFT_LEFT_11 = 2048.0; \nconst float SHIFT_LEFT_5 = 32.0; \nconst float NORMALIZE_6 = 1.0 / 64.0; \nconst float NORMALIZE_5 = 1.0 / 32.0; \n":"attribute vec3 a_color; \n"),oe&&(me+=T||E?"attribute vec2 a_normal; \n":"attribute vec3 a_normal; \n"),O&&(me+="attribute float a_batchId; \n"),(g||S||E)&&(me+="uniform vec4 u_quantizedVolumeScaleAndOctEncodedRange; \n"),F&&(me+=_),U&&(me+=u),q&&(me+=h),me+="void main() \n{ \n    u_pointSize = u_pointSizeAndTimeAndGeometricErrorAndDepthMultiplier.x; \n    u_time = u_pointSizeAndTimeAndGeometricErrorAndDepthMultiplier.y; \n",L&&(me+="    u_geometricError = u_pointSizeAndTimeAndGeometricErrorAndDepthMultiplier.z; \n    u_depthMultiplier = u_pointSizeAndTimeAndGeometricErrorAndDepthMultiplier.w; \n"),me+=j?C?"    vec4 color = a_color; \n":A?"    float compressed = a_color; \n    float r = floor(compressed * SHIFT_RIGHT_11); \n    compressed -= r * SHIFT_LEFT_11; \n    float g = floor(compressed * SHIFT_RIGHT_5); \n    compressed -= g * SHIFT_LEFT_5; \n    float b = compressed; \n    vec3 rgb = vec3(r * NORMALIZE_5, g * NORMALIZE_6, b * NORMALIZE_5); \n    vec4 color = vec4(rgb, 1.0); \n":"    vec4 color = vec4(a_color, 1.0); \n":"    vec4 color = u_constantColor; \n",me+=g||S?"    vec3 position = a_position * u_quantizedVolumeScaleAndOctEncodedRange.xyz; \n":"    vec3 position = a_position; \n",me+="    vec3 position_absolute = vec3(czm_model * vec4(position, 1.0)); \n",oe?(me+=T?"    vec3 normal = czm_octDecode(a_normal); \n":E?"    vec3 normal = czm_octDecode(a_normal, u_quantizedVolumeScaleAndOctEncodedRange.w).zxy; \n":"    vec3 normal = a_normal; \n",me+="    vec3 normalEC = czm_normal * normal; \n"):me+="    vec3 normal = vec3(1.0); \n",F&&(me+="    color = getColorFromStyle(position, position_absolute, color, normal); \n"),U&&(me+="    float show = float(getShowFromStyle(position, position_absolute, color, normal)); \n"),me+=q?"    gl_PointSize = getPointSizeFromStyle(position, position_absolute, color, normal); \n":L?"    vec4 positionEC = czm_modelView * vec4(position, 1.0); \n    float depth = -positionEC.z; \n    gl_PointSize = min((u_geometricError / depth) * u_depthMultiplier, u_pointSize); \n":"    gl_PointSize = u_pointSize; \n",me+="    color = color * u_highlightColor; \n",oe&&D&&(me+="    float diffuseStrength = czm_getLambertDiffuse(czm_sunDirectionEC, normalEC); \n    diffuseStrength = max(diffuseStrength, 0.4); \n    color.xyz *= diffuseStrength; \n"),me+="    v_color = color; \n    gl_Position = czm_modelViewProjection * vec4(position, 1.0); \n",oe&&N&&(me+="    float visible = step(-normalEC.z, 0.0); \n    gl_Position *= visible; \n    gl_PointSize *= visible; \n"),U&&(me+="    gl_Position *= show; \n    gl_PointSize *= show; \n"),me+="} \n";var pe="varying vec4 v_color; \n";V&&(pe+="uniform sampler2D u_clippingPlanes; \nuniform mat4 u_clippingPlanesMatrix; \nuniform vec4 u_clippingPlanesEdgeStyle; \n",pe+="\n",pe+=G(B,m),pe+="\n"),pe+="void main() \n{ \n    gl_FragColor = czm_gammaCorrect(v_color); \n",V&&(pe+=x("u_clippingPlanes","u_clippingPlanesMatrix","u_clippingPlanesEdgeStyle")),pe+="} \n",c(e._vertexShaderLoaded)&&(me=e._vertexShaderLoaded(me)),c(e._fragmentShaderLoaded)&&(pe=e._fragmentShaderLoaded(pe));var fe=e._drawCommand;c(fe.shaderProgram)&&fe.shaderProgram.destroy(),fe.shaderProgram=P.fromCache({context:m,vertexShaderSource:me,fragmentShaderSource:pe,attributeLocations:ie});try{fe.shaderProgram._bind()}catch(e){throw new v("Error generating style shader: this may be caused by a type mismatch, index out-of-bounds, or other syntax error.")}}var _e=new o,ue=new r;return V.prototype.update=function(e){if(!function(e,t){if(e._decodingState===q.READY)return!1;if(e._decodingState===q.NEEDS_DECODE){var o=e._parsedContent,n=o.draco,i=z.decodePointCloud(n,t);c(i)&&(e._decodingState=q.DECODING,i.then(function(t){e._decodingState=q.READY;var i=c(t.POSITION)?t.POSITION.array:void 0,a=c(t.RGB)?t.RGB.array:void 0,s=c(t.RGBA)?t.RGBA.array:void 0,d=c(t.NORMAL)?t.NORMAL.array:void 0,_=c(t.BATCH_ID)?t.BATCH_ID.array:void 0,u=c(i)&&c(t.POSITION.data.quantization),h=c(d)&&c(t.NORMAL.data.quantization);if(u){var m=t.POSITION.data.quantization,p=m.range;e._quantizedVolumeScale=r.fromElements(p,p,p),e._quantizedVolumeOffset=r.unpack(m.minValues),e._quantizedRange=(1<<m.quantizationBits)-1,e._isQuantizedDraco=!0}h&&(e._octEncodedRange=(1<<t.NORMAL.data.quantization.quantizationBits)-1,e._isOctEncodedDraco=!0);var f=o.styleableProperties,y=n.batchTableProperties;for(var g in y)if(y.hasOwnProperty(g)){var S=t[g];c(f)||(f={}),f[g]={typedArray:S.array,componentCount:S.data.componentsPerAttribute}}o.positions=l(i,o.positions),o.colors=l(l(s,a),o.colors),o.normals=l(d,o.normals),o.batchIds=l(_,o.batchIds),o.styleableProperties=f}).otherwise(function(t){e._decodingState=q.FAILED,e._readyPromise.reject(t)}))}return!0}(this,e.context)){var n=!1,i=!p.equals(this._modelMatrix,this.modelMatrix);if(this._mode!==e.mode&&(this._mode=e.mode,i=!0),c(this._drawCommand)||(ie(this,e),i=!0,n=!0,this._ready=!0,this._readyPromise.resolve(this),this._parsedContent=void 0),i){p.clone(this.modelMatrix,this._modelMatrix);var a=this._drawCommand.modelMatrix;if(p.clone(this._modelMatrix,a),c(this._rtcCenter)&&p.multiplyByTranslation(a,this._rtcCenter,a),c(this._quantizedVolumeOffset)&&p.multiplyByTranslation(a,this._quantizedVolumeOffset,a),e.mode!==M.SCENE3D){var s=e.mapProjection,d=p.getColumn(a,3,_e);o.equals(d,o.UNIT_W)||T.basisTo2D(s,a,a)}var _=this._drawCommand.boundingVolume;if(t.clone(this._boundingSphere,_),this._cull){var u=_.center;p.multiplyByPoint(a,u,u);var h=p.getScale(a,ue);_.radius*=r.maximumComponent(h)}}this.clippingPlanesDirty&&(this.clippingPlanesDirty=!1,n=!0),this._attenuation!==this.attenuation&&(this._attenuation=this.attenuation,n=!0),this.backFaceCulling!==this._backFaceCulling&&(this._backFaceCulling=this.backFaceCulling,n=!0),this.normalShading!==this._normalShading&&(this._normalShading=this.normalShading,n=!0),(this._style!==this.style||this.styleDirty)&&(this._style=this.style,this.styleDirty=!1,n=!0),n&&ce(this,e,this._style),this._drawCommand.castShadows=F.castShadows(this.shadows),this._drawCommand.receiveShadows=F.receiveShadows(this.shadows);var m=this._highlightColor.alpha<1||this._constantColor.alpha<1||this._styleTranslucent;this._drawCommand.renderState=m?this._translucentRenderState:this._opaqueRenderState,this._drawCommand.pass=m?I.TRANSLUCENT:this._opaquePass;var f=e.commandList,y=e.passes;(y.render||y.pick)&&f.push(this._drawCommand)}},V.prototype.isDestroyed=function(){return!1},V.prototype.destroy=function(){var e=this._drawCommand;return c(e)&&(e.vertexArray=e.vertexArray&&e.vertexArray.destroy(),e.shaderProgram=e.shaderProgram&&e.shaderProgram.destroy()),u(this)},V});