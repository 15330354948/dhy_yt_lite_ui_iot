define(["../Core/AssociativeArray","../Core/Cartesian3","../Core/defined","../Core/destroyObject","../Core/DeveloperError","../Core/JulianDate","../Core/Matrix3","../Core/Matrix4","../Core/ReferenceFrame","../Core/TimeInterval","../Core/Transforms","../Scene/PolylineCollection","../Scene/SceneMode","./CompositePositionProperty","./ConstantPositionProperty","./MaterialProperty","./Property","./ReferenceProperty","./SampledPositionProperty","./ScaledPositionProperty","./TimeIntervalCollectionPositionProperty"],function(e,t,n,r,i,o,a,s,l,d,c,u,p,h,f,v,y,m,_,g,C){"use strict";var w=new d,T=new d,O=new d;function x(e){this.entity=e,this.polyline=void 0,this.index=void 0,this.updater=void 0}function I(e,t,r,i,a,s,l,c){for(;e instanceof m;)e=e.resolvedProperty;e instanceof _?l=function(e,t,r,i,a,s,l,d,c){var u,p=d;u=e.getValueInReferenceFrame(t,s,c[p]),n(u)&&(c[p++]=u);for(var h,f,v,y=!n(a)||o.lessThanOrEquals(a,t)||o.greaterThanOrEquals(a,r),m=0,_=i.length,g=i[m],C=r,w=!1;m<_;){if(!y&&o.greaterThanOrEquals(g,a)&&(u=e.getValueInReferenceFrame(a,s,c[p]),n(u)&&(c[p++]=u),y=!0),o.greaterThan(g,t)&&o.lessThan(g,C)&&!g.equals(a)&&(u=e.getValueInReferenceFrame(g,s,c[p]),n(u)&&(c[p++]=u)),m<_-1){if(l>0&&!w){var T=i[m+1],O=o.secondsDifference(T,g);(w=O>l)&&(h=Math.ceil(O/l),f=0,v=O/Math.max(h,2),h=Math.max(h-1,1))}if(w&&f<h){g=o.addSeconds(g,v,new o),f++;continue}}w=!1,g=i[++m]}return u=e.getValueInReferenceFrame(r,s,c[p]),n(u)&&(c[p++]=u),p}(e,t,r,e._property._times,i,a,s,l,c):l=e instanceof h?function(e,t,n,r,i,a,s,l){T.start=t,T.stop=n;for(var c=s,u=e.intervals,p=0;p<u.length;p++){var h=u.get(p);if(!d.intersect(h,T,w).isEmpty){var f=h.start,v=h.stop,y=t;o.greaterThan(f,y)&&(y=f);var m=n;o.lessThan(v,m)&&(m=v),c=I(h.data,y,m,r,i,a,c,l)}}return c}(e,t,r,i,a,s,l,c):e instanceof C?function(e,t,r,i,a,s,l,c){O.start=t,O.stop=r;for(var u=l,p=e.intervals,h=0;h<p.length;h++){var f=p.get(h);if(!d.intersect(f,O,w).isEmpty){var v=f.start;f.isStartIncluded||(v=f.isStopIncluded?f.stop:o.addSeconds(f.start,o.secondsDifference(f.stop,f.start)/2,new o));var y=e.getValueInReferenceFrame(v,a,c[u]);n(y)&&(c[u]=y,u++)}}return u}(e,t,r,0,a,0,l,c):e instanceof f||e instanceof g&&y.isConstant(e)?function(e,t,r,i,o,a,s,l){var d=e.getValueInReferenceFrame(t,o,l[s]);return n(d)&&(l[s++]=d),s}(e,t,0,0,a,0,l,c):function(e,t,r,i,a,s,l,d){for(var c,u=0,p=l,h=t,f=Math.max(s,60),v=!n(i)||o.lessThanOrEquals(i,t)||o.greaterThanOrEquals(i,r);o.lessThan(h,r);)!v&&o.greaterThanOrEquals(h,i)&&(v=!0,c=e.getValueInReferenceFrame(i,a,d[p]),n(c)&&(d[p]=c,p++)),c=e.getValueInReferenceFrame(h,a,d[p]),n(c)&&(d[p]=c,p++),u++,h=o.addSeconds(t,f*u,new o);return c=e.getValueInReferenceFrame(r,a,d[p]),n(c)&&(d[p]=c,p++),p}(e,t,r,i,a,s,l,c);return l}function P(e,t,r,i,o,a,s){n(s)||(s=[]);var l=I(e,t,r,i,o,a,0,s);return s.length=l,s}var F=new a;function E(e,t){this._unusedIndexes=[],this._polylineCollection=new u,this._scene=e,this._referenceFrame=t,e.primitives.add(this._polylineCollection)}function V(t,r){if(!n(t))throw new i("scene is required.");if(!n(r))throw new i("entityCollection is required.");r.collectionChanged.addEventListener(V.prototype._onCollectionChanged,this),this._scene=t,this._updaters={},this._entityCollection=r,this._items=new e,this._onCollectionChanged(r,r.values,[],[])}return E.prototype.update=function(e){if(this._referenceFrame===l.INERTIAL){var r=c.computeIcrfToFixedMatrix(e,F);n(r)||(r=c.computeTemeToPseudoFixedMatrix(e,F)),s.fromRotationTranslation(r,t.ZERO,this._polylineCollection.modelMatrix)}},E.prototype.updateObject=function(e,t){var r,i,a=t.entity,s=a._path,l=a._position,d=s._show,c=t.polyline,u=a.isShowing&&(!n(d)||d.getValue(e));if(u){var p=y.getValueOrUndefined(s._leadTime,e),h=y.getValueOrUndefined(s._trailTime,e),f=a._availability,m=n(f),_=n(p),g=n(h);if(u=m||_&&g){if(g&&(r=o.addSeconds(e,-h,new o)),_&&(i=o.addSeconds(e,p,new o)),m){var C=f.start,w=f.stop;g&&!o.greaterThan(C,r)||(r=C),_&&!o.lessThan(w,i)||(i=w)}u=o.lessThan(r,i)}}if(u){if(!n(c)){var T=this._unusedIndexes;if(T.length>0){var O=T.pop();c=this._polylineCollection.get(O),t.index=O}else t.index=this._polylineCollection.length,c=this._polylineCollection.add();c.id=a,t.polyline=c}var x=y.getValueOrDefault(s._resolution,e,60);c.show=!0,c.positions=P(l,r,i,e,this._referenceFrame,x,c.positions.slice()),c.material=v.getValue(e,s._material,c.material),c.width=y.getValueOrDefault(s._width,e,1),c.distanceDisplayCondition=y.getValueOrUndefined(s._distanceDisplayCondition,e,c.distanceDisplayCondition)}else n(c)&&(this._unusedIndexes.push(t.index),t.polyline=void 0,c.show=!1,t.index=void 0)},E.prototype.removeObject=function(e){var t=e.polyline;n(t)&&(this._unusedIndexes.push(e.index),e.polyline=void 0,t.show=!1,t.id=void 0,e.index=void 0)},E.prototype.destroy=function(){return this._scene.primitives.remove(this._polylineCollection),r(this)},V.prototype.update=function(e){if(!n(e))throw new i("time is required.");var t=this._updaters;for(var r in t)t.hasOwnProperty(r)&&t[r].update(e);for(var o=this._items.values,a=0,s=o.length;a<s;a++){var d=o[a],c=d.entity._position,u=d.updater,h=l.FIXED;this._scene.mode===p.SCENE3D&&(h=c.referenceFrame);var f=this._updaters[h];u===f&&n(f)?f.updateObject(e,d):(n(u)&&u.removeObject(d),n(f)||((f=new E(this._scene,h)).update(e),this._updaters[h]=f),d.updater=f,n(f)&&f.updateObject(e,d))}return!0},V.prototype.isDestroyed=function(){return!1},V.prototype.destroy=function(){this._entityCollection.collectionChanged.removeEventListener(V.prototype._onCollectionChanged,this);var e=this._updaters;for(var t in e)e.hasOwnProperty(t)&&e[t].destroy();return r(this)},V.prototype._onCollectionChanged=function(e,t,r,i){var o,a,s,l=this._items;for(o=t.length-1;o>-1;o--)a=t[o],n(a._path)&&n(a._position)&&l.set(a.id,new x(a));for(o=i.length-1;o>-1;o--)a=i[o],n(a._path)&&n(a._position)?l.contains(a.id)||l.set(a.id,new x(a)):(s=l.get(a.id),n(s)&&(n(s.updater)&&s.updater.removeObject(s),l.remove(a.id)));for(o=r.length-1;o>-1;o--)a=r[o],s=l.get(a.id),n(s)&&(n(s.updater)&&s.updater.removeObject(s),l.remove(a.id))},V._subSample=P,V});