define(["../Core/Cartesian2","../Core/clone","../Core/Color","../Core/combine","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/isArray","../Core/loadCRN","../Core/loadKTX","../Core/Matrix2","../Core/Matrix3","../Core/Matrix4","../Core/Resource","../Renderer/CubeMap","../Renderer/Texture","../Shaders/Materials/AspectRampMaterial","../Shaders/Materials/BumpMapMaterial","../Shaders/Materials/CheckerboardMaterial","../Shaders/Materials/DotMaterial","../Shaders/Materials/ElevationContourMaterial","../Shaders/Materials/ElevationRampMaterial","../Shaders/Materials/FadeMaterial","../Shaders/Materials/GridMaterial","../Shaders/Materials/NormalMapMaterial","../Shaders/Materials/PolylineArrowMaterial","../Shaders/Materials/PolylineDashMaterial","../Shaders/Materials/PolylineGlowMaterial","../Shaders/Materials/PolylineOutlineMaterial","../Shaders/Materials/RimLightingMaterial","../Shaders/Materials/SlopeRampMaterial","../Shaders/Materials/StripeMaterial","../Shaders/Materials/Water","../ThirdParty/when"],function(e,a,t,r,i,n,o,s,l,u,c,p,f,m,h,d,y,_,v,g,M,C,w,T,b,I,x,P,D,S,E,O,R,F,A,L,k){"use strict";function N(e){this.type=void 0,this.shaderSource=void 0,this.materials=void 0,this.uniforms=void 0,this._uniforms=void 0,this.translucent=void 0,this._strict=void 0,this._template=void 0,this._count=void 0,this._texturePaths={},this._loadedImages=[],this._loadedCubeMaps=[],this._textures={},this._updateFunctions=[],this._defaultTexture=void 0,function(e,t){var s;e=n(e,n.EMPTY_OBJECT),t._strict=n(e.strict,!1),t._count=n(e.count,0),t._template=a(n(e.fabric,n.EMPTY_OBJECT)),t._template.uniforms=a(n(t._template.uniforms,n.EMPTY_OBJECT)),t._template.materials=a(n(t._template.materials,n.EMPTY_OBJECT)),t.type=o(t._template.type)?t._template.type:i(),t.shaderSource="",t.materials={},t.uniforms={},t._uniforms={},t._translucentFunctions=[];var l=N._materialCache.getMaterial(t.type);if(o(l)){var c=a(l.fabric,!0);t._template=r(t._template,c,!0),s=l.translucent}(function(e){var a=e._template,t=a.uniforms,r=a.materials,i=a.components;if(o(i)&&o(a.source))throw new u("fabric: cannot have source and components in the same template.");z(a,Y,G,!0),z(i,W,G,!0);var n=[];for(var s in r)r.hasOwnProperty(s)&&n.push(s);z(t,n,B,!1)})(t),o(l)||N._materialCache.addMaterial(t.type,t);(function(e){var a=e._template.components,t=e._template.source;if(o(t))e.shaderSource+=t+"\n";else{if(e.shaderSource+="czm_material czm_getMaterial(czm_materialInput materialInput)\n{\n",e.shaderSource+="czm_material material = czm_getDefaultMaterial(materialInput);\n",o(a))for(var r in a)a.hasOwnProperty(r)&&(e.shaderSource+="diffuse"===r||"emission"===r?"material."+r+" = czm_gammaCorrect("+a[r]+"); \n":"alpha"===r?"material.alpha = czm_gammaCorrect(vec4(vec3(0.0), "+a.alpha+")).a; \n":"material."+r+" = "+a[r]+";\n");e.shaderSource+="return material;\n}\n"}})(t),function(e){var a=e._template.uniforms;for(var t in a)a.hasOwnProperty(t)&&j(e,t)}(t),function(e){var a=e._strict,t=e._template.materials;for(var i in t)if(t.hasOwnProperty(i)){var n=new N({strict:a,fabric:t[i],count:e._count});e._count=n._count,e._uniforms=r(e._uniforms,n._uniforms,!0),e.materials[i]=n,e._translucentFunctions=e._translucentFunctions.concat(n._translucentFunctions);var o="czm_getMaterial_"+e._count++;J(n,"czm_getMaterial",o),e.shaderSource=n.shaderSource+e.shaderSource;var s=o+"(materialInput)",l=J(e,i,s);if(0===l&&a)throw new u("strict: shader source does not use material '"+i+"'.")}}(t);var p=0===t._translucentFunctions.length||void 0;if(s=n(s,p),s=n(e.translucent,s),o(s))if("function"==typeof s){t._translucentFunctions.push(function(){return s(t)})}else t._translucentFunctions.push(s)}(e,this),s(this,{type:{value:this.type,writable:!1}}),o(N._uniformList[this.type])||(N._uniformList[this.type]=Object.keys(this._uniforms))}function z(e,a,t,r){if(o(e))for(var i in e)if(e.hasOwnProperty(i)){var n=-1!==a.indexOf(i);(r&&!n||!r&&n)&&t(i,a)}}function G(e,a){for(var t="fabric: property name '"+e+"' is not valid. It should be ",r=0;r<a.length;r++){var i="'"+a[r]+"'";t+=r===a.length-1?"or "+i+".":i+", "}throw new u(t)}function B(e,a){throw new u("fabric: uniforms and materials cannot share the same property '"+e+"'")}N._uniformList={},N.fromType=function(e,a){if(!o(N._materialCache.getMaterial(e)))throw new u("material with type '"+e+"' does not exist.");var t=new N({fabric:{type:e}});if(o(a))for(var r in a)a.hasOwnProperty(r)&&(t.uniforms[r]=a[r]);return t},N.prototype.isTranslucent=function(){if(o(this.translucent))return"function"==typeof this.translucent?this.translucent():this.translucent;for(var e=!0,a=this._translucentFunctions,t=a.length,r=0;r<t;++r){var i=a[r];if(!(e="function"==typeof i?e&&i():e&&i))break}return e},N.prototype.update=function(e){var a,t,r=this._loadedImages,i=r.length;for(a=0;a<i;++a){var n=r[a];t=n.id;var s,l=n.image;s=o(l.internalFormat)?new v({context:e,pixelFormat:l.internalFormat,width:l.width,height:l.height,source:{arrayBufferView:l.bufferView}}):new v({context:e,source:l}),this._textures[t]=s;var u=t+"Dimensions";if(this.uniforms.hasOwnProperty(u)){var c=this.uniforms[u];c.x=s._width,c.y=s._height}}r.length=0;var p=this._loadedCubeMaps;for(i=p.length,a=0;a<i;++a){var f=p[a];t=f.id;var m=f.images,h=new _({context:e,source:{positiveX:m[0],negativeX:m[1],positiveY:m[2],negativeY:m[3],positiveZ:m[4],negativeZ:m[5]}});this._textures[t]=h}p.length=0;var d=this._updateFunctions;for(i=d.length,a=0;a<i;++a)d[a](this,e);var y=this.materials;for(var g in y)y.hasOwnProperty(g)&&y[g].update(e)},N.prototype.isDestroyed=function(){return!1},N.prototype.destroy=function(){var e=this._textures;for(var a in e)if(e.hasOwnProperty(a)){var t=e[a];t!==this._defaultTexture&&t.destroy()}var r=this.materials;for(var i in r)r.hasOwnProperty(i)&&r[i].destroy();return l(this)};var Y=["type","materials","uniforms","components","source"],W=["diffuse","specular","shininess","normal","emission","alpha"];var H={mat2:m,mat3:h,mat4:d},X=/\.ktx$/i,Z=/\.crn$/i;function j(e,a){var t=e._strict,r=e._template.uniforms,i=r[a],n=function(e){var a=e.type;if(!o(a)){var t=typeof e;if("number"===t)a="float";else if("boolean"===t)a="bool";else if("string"===t||e instanceof y||e instanceof HTMLCanvasElement||e instanceof HTMLImageElement)a=/^([rgba]){1,4}$/i.test(e)?"channels":e===N.DefaultCubeMapId?"samplerCube":"sampler2D";else if("object"===t)if(c(e))4!==e.length&&9!==e.length&&16!==e.length||(a="mat"+Math.sqrt(e.length));else{var r=0;for(var i in e)e.hasOwnProperty(i)&&(r+=1);r>=2&&r<=4?a="vec"+r:6===r&&(a="samplerCube")}}return a}(i);if(!o(n))throw new u("fabric: uniform '"+a+"' has invalid type.");if("channels"===n){if(0===J(e,a,i,!1)&&t)throw new u("strict: shader source does not use channels '"+a+"'.")}else{if("sampler2D"===n){var s=a+"Dimensions";(function(e,a,t){return J(e,a,a,t)})(e,s)>0&&(r[s]={type:"ivec3",x:1,y:1},j(e,s))}if(!new RegExp("uniform\\s+"+n+"\\s+"+a+"\\s*;").test(e.shaderSource)){var l="uniform "+n+" "+a+";";e.shaderSource=l+e.shaderSource}var m=a+"_"+e._count++;if(1===J(e,a,m)&&t)throw new u("strict: shader source does not use uniform '"+a+"'.");if(e.uniforms[a]=i,"sampler2D"===n)e._uniforms[m]=function(){return e._textures[a]},e._updateFunctions.push(function(e){var a;return function(t,r){var i=t.uniforms,n=i[e],s=a!==n;a=n;var l,u,c=t._textures[e];if(n instanceof HTMLVideoElement)if(n.readyState>=2){if(s&&o(c)&&(c!==r.defaultTexture&&c.destroy(),c=void 0),!o(c)||c===r.defaultTexture)return c=new v({context:r,source:n}),void(t._textures[e]=c);c.copyFrom(n)}else o(c)||(t._textures[e]=r.defaultTexture);else{if(n instanceof v&&n!==c){t._texturePaths[e]=void 0;var m=t._textures[e];return m!==t._defaultTexture&&m.destroy(),t._textures[e]=n,l=e+"Dimensions",void(i.hasOwnProperty(l)&&((u=i[l]).x=n._width,u.y=n._height))}if(o(c)||(t._texturePaths[e]=void 0,o(t._defaultTexture)||(t._defaultTexture=r.defaultTexture),c=t._textures[e]=t._defaultTexture,l=e+"Dimensions",i.hasOwnProperty(l)&&((u=i[l]).x=c._width,u.y=c._height)),n!==N.DefaultImageId){var h=n instanceof y;if(!o(t._texturePaths[e])||h&&n.url!==t._texturePaths[e].url||!h&&n!==t._texturePaths[e]){if("string"==typeof n||h){var d,_=h?n:y.createIfNeeded(n);d=X.test(n)?f(_):Z.test(n)?p(_):_.fetchImage(),k(d,function(a){t._loadedImages.push({id:e,image:a})})}else(n instanceof HTMLCanvasElement||n instanceof HTMLImageElement)&&t._loadedImages.push({id:e,image:n});t._texturePaths[e]=n}}}}}(a));else if("samplerCube"===n)e._uniforms[m]=function(){return e._textures[a]},e._updateFunctions.push(function(e){return function(a,t){var r=a.uniforms[e];if(r instanceof _){var i=a._textures[e];return i!==a._defaultTexture&&i.destroy(),a._texturePaths[e]=void 0,void(a._textures[e]=r)}if(o(a._textures[e])||(a._texturePaths[e]=void 0,a._textures[e]=t.defaultCubeMap),r!==N.DefaultCubeMapId){var n=r.positiveX+r.negativeX+r.positiveY+r.negativeY+r.positiveZ+r.negativeZ;if(n!==a._texturePaths[e]){var s=[y.createIfNeeded(r.positiveX).fetchImage(),y.createIfNeeded(r.negativeX).fetchImage(),y.createIfNeeded(r.positiveY).fetchImage(),y.createIfNeeded(r.negativeY).fetchImage(),y.createIfNeeded(r.positiveZ).fetchImage(),y.createIfNeeded(r.negativeZ).fetchImage()];k.all(s).then(function(t){a._loadedCubeMaps.push({id:e,images:t})}),a._texturePaths[e]=n}}}}(a));else if(-1!==n.indexOf("mat")){var h=new H[n];e._uniforms[m]=function(){return H[n].fromColumnMajorArray(e.uniforms[a],h)}}else e._uniforms[m]=function(){return e.uniforms[a]}}}function J(e,a,t,r){r=n(r,!0);var i=0,o=new RegExp("([\\w"+(r?".":"")+"])?"+a+"([\\w])?","g");return e.shaderSource=e.shaderSource.replace(o,function(e,a,r){return a||r?e:(i+=1,t)}),i}return N._materialCache={_materials:{},addMaterial:function(e,a){this._materials[e]=a},getMaterial:function(e){return this._materials[e]}},N.DefaultImageId="czm_defaultImage",N.DefaultCubeMapId="czm_defaultCubeMap",N.ColorType="Color",N._materialCache.addMaterial(N.ColorType,{fabric:{type:N.ColorType,uniforms:{color:new t(1,0,0,.5)},components:{diffuse:"color.rgb",alpha:"color.a"}},translucent:function(e){return e.uniforms.color.alpha<1}}),N.ImageType="Image",N._materialCache.addMaterial(N.ImageType,{fabric:{type:N.ImageType,uniforms:{image:N.DefaultImageId,repeat:new e(1,1),color:new t(1,1,1,1)},components:{diffuse:"texture2D(image, fract(repeat * materialInput.st)).rgb * color.rgb",alpha:"texture2D(image, fract(repeat * materialInput.st)).a * color.a"}},translucent:function(e){return e.uniforms.color.alpha<1}}),N.DiffuseMapType="DiffuseMap",N._materialCache.addMaterial(N.DiffuseMapType,{fabric:{type:N.DiffuseMapType,uniforms:{image:N.DefaultImageId,channels:"rgb",repeat:new e(1,1)},components:{diffuse:"texture2D(image, fract(repeat * materialInput.st)).channels"}},translucent:!1}),N.AlphaMapType="AlphaMap",N._materialCache.addMaterial(N.AlphaMapType,{fabric:{type:N.AlphaMapType,uniforms:{image:N.DefaultImageId,channel:"a",repeat:new e(1,1)},components:{alpha:"texture2D(image, fract(repeat * materialInput.st)).channel"}},translucent:!0}),N.SpecularMapType="SpecularMap",N._materialCache.addMaterial(N.SpecularMapType,{fabric:{type:N.SpecularMapType,uniforms:{image:N.DefaultImageId,channel:"r",repeat:new e(1,1)},components:{specular:"texture2D(image, fract(repeat * materialInput.st)).channel"}},translucent:!1}),N.EmissionMapType="EmissionMap",N._materialCache.addMaterial(N.EmissionMapType,{fabric:{type:N.EmissionMapType,uniforms:{image:N.DefaultImageId,channels:"rgb",repeat:new e(1,1)},components:{emission:"texture2D(image, fract(repeat * materialInput.st)).channels"}},translucent:!1}),N.BumpMapType="BumpMap",N._materialCache.addMaterial(N.BumpMapType,{fabric:{type:N.BumpMapType,uniforms:{image:N.DefaultImageId,channel:"r",strength:.8,repeat:new e(1,1)},source:M},translucent:!1}),N.NormalMapType="NormalMap",N._materialCache.addMaterial(N.NormalMapType,{fabric:{type:N.NormalMapType,uniforms:{image:N.DefaultImageId,channels:"rgb",strength:.8,repeat:new e(1,1)},source:P},translucent:!1}),N.GridType="Grid",N._materialCache.addMaterial(N.GridType,{fabric:{type:N.GridType,uniforms:{color:new t(0,1,0,1),cellAlpha:.1,lineCount:new e(8,8),lineThickness:new e(1,1),lineOffset:new e(0,0)},source:x},translucent:function(e){var a=e.uniforms;return a.color.alpha<1||a.cellAlpha<1}}),N.StripeType="Stripe",N._materialCache.addMaterial(N.StripeType,{fabric:{type:N.StripeType,uniforms:{horizontal:!0,evenColor:new t(1,1,1,.5),oddColor:new t(0,0,1,.5),offset:0,repeat:5},source:A},translucent:function(e){var a=e.uniforms;return a.evenColor.alpha<1||a.oddColor.alpha<1}}),N.CheckerboardType="Checkerboard",N._materialCache.addMaterial(N.CheckerboardType,{fabric:{type:N.CheckerboardType,uniforms:{lightColor:new t(1,1,1,.5),darkColor:new t(0,0,0,.5),repeat:new e(5,5)},source:C},translucent:function(e){var a=e.uniforms;return a.lightColor.alpha<1||a.darkColor.alpha<1}}),N.DotType="Dot",N._materialCache.addMaterial(N.DotType,{fabric:{type:N.DotType,uniforms:{lightColor:new t(1,1,0,.75),darkColor:new t(0,1,1,.75),repeat:new e(5,5)},source:w},translucent:function(e){var a=e.uniforms;return a.lightColor.alpha<1||a.darkColor.alpha<1}}),N.WaterType="Water",N._materialCache.addMaterial(N.WaterType,{fabric:{type:N.WaterType,uniforms:{baseWaterColor:new t(.2,.3,.6,1),blendColor:new t(0,1,.699,1),specularMap:N.DefaultImageId,normalMap:N.DefaultImageId,frequency:10,animationSpeed:.01,amplitude:1,specularIntensity:.5,fadeFactor:1},source:L},translucent:function(e){var a=e.uniforms;return a.baseWaterColor.alpha<1||a.blendColor.alpha<1}}),N.RimLightingType="RimLighting",N._materialCache.addMaterial(N.RimLightingType,{fabric:{type:N.RimLightingType,uniforms:{color:new t(1,0,0,.7),rimColor:new t(1,1,1,.4),width:.3},source:R},translucent:function(e){var a=e.uniforms;return a.color.alpha<1||a.rimColor.alpha<1}}),N.FadeType="Fade",N._materialCache.addMaterial(N.FadeType,{fabric:{type:N.FadeType,uniforms:{fadeInColor:new t(1,0,0,1),fadeOutColor:new t(0,0,0,0),maximumDistance:.5,repeat:!0,fadeDirection:{x:!0,y:!0},time:new e(.5,.5)},source:I},translucent:function(e){var a=e.uniforms;return a.fadeInColor.alpha<1||a.fadeOutColor.alpha<1}}),N.PolylineArrowType="PolylineArrow",N._materialCache.addMaterial(N.PolylineArrowType,{fabric:{type:N.PolylineArrowType,uniforms:{color:new t(1,1,1,1)},source:D},translucent:!0}),N.PolylineDashType="PolylineDash",N._materialCache.addMaterial(N.PolylineDashType,{fabric:{type:N.PolylineDashType,uniforms:{color:new t(1,0,1,1),gapColor:new t(0,0,0,0),dashLength:16,dashPattern:255},source:S},translucent:!0}),N.PolylineGlowType="PolylineGlow",N._materialCache.addMaterial(N.PolylineGlowType,{fabric:{type:N.PolylineGlowType,uniforms:{color:new t(0,.5,1,1),glowPower:.25,taperPower:1},source:E},translucent:!0}),N.PolylineOutlineType="PolylineOutline",N._materialCache.addMaterial(N.PolylineOutlineType,{fabric:{type:N.PolylineOutlineType,uniforms:{color:new t(1,1,1,1),outlineColor:new t(1,0,0,1),outlineWidth:1},source:O},translucent:function(e){var a=e.uniforms;return a.color.alpha<1||a.outlineColor.alpha<1}}),N.ElevationContourType="ElevationContour",N._materialCache.addMaterial(N.ElevationContourType,{fabric:{type:N.ElevationContourType,uniforms:{spacing:100,color:new t(1,0,0,1),width:1},source:T},translucent:!1}),N.ElevationRampType="ElevationRamp",N._materialCache.addMaterial(N.ElevationRampType,{fabric:{type:N.ElevationRampType,uniforms:{image:N.DefaultImageId,minimumHeight:0,maximumHeight:1e4},source:b},translucent:!1}),N.SlopeRampMaterialType="SlopeRamp",N._materialCache.addMaterial(N.SlopeRampMaterialType,{fabric:{type:N.SlopeRampMaterialType,uniforms:{image:N.DefaultImageId},source:F},translucent:!1}),N.AspectRampMaterialType="AspectRamp",N._materialCache.addMaterial(N.AspectRampMaterialType,{fabric:{type:N.AspectRampMaterialType,uniforms:{image:N.DefaultImageId},source:g},translucent:!1}),N});