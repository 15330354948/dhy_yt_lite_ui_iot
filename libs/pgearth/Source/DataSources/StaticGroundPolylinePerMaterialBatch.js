define(["../Core/defaultValue","../Core/AssociativeArray","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defined","../Core/DistanceDisplayCondition","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/ShowGeometryInstanceAttribute","../Scene/GroundPolylinePrimitive","../Scene/PolylineColorAppearance","../Scene/PolylineMaterialAppearance","./BoundingSphereState","./ColorMaterialProperty","./MaterialProperty","./Property"],function(t,e,i,r,s,o,a,n,h,l,d,p,u,v,c){"use strict";var y=new i,m=new o,f=new o;function g(t,i,r,s,o){var a;a=r instanceof u?l:d,this.orderedGroundPrimitives=t,this.classificationType=i,this.appearanceType=a,this.materialProperty=r,this.updaters=new e,this.createPrimitive=!0,this.primitive=void 0,this.oldPrimitive=void 0,this.geometry=new e,this.material=void 0,this.updatersWithAttributes=new e,this.attributes=new e,this.invalidated=!1,this.removeMaterialSubscription=r.definitionChanged.addEventListener(g.prototype.onMaterialChanged,this),this.subscriptions=new e,this.showsUpdated=new e,this.zIndex=s,this._asynchronous=o}function P(e,i,r){this._items=[],this._orderedGroundPrimitives=e,this._classificationType=i,this._asynchronous=t(r,!0)}return g.prototype.onMaterialChanged=function(){this.invalidated=!0},g.prototype.isMaterial=function(t){var e=this.materialProperty,i=t.fillMaterialProperty;return i===e||i instanceof u&&e instanceof u||s(e)&&e.equals(i)},g.prototype.add=function(t,e,i){var r=e.id;if(this.updaters.set(r,e),this.geometry.set(r,i),e.hasConstantFill&&e.fillMaterialProperty.isConstant&&c.isConstant(e.distanceDisplayConditionProperty)){var s=this;this.subscriptions.set(r,e.entity.definitionChanged.addEventListener(function(t,i,r,o){"isShowing"===i&&s.showsUpdated.set(e.id,e)}))}else this.updatersWithAttributes.set(r,e);this.createPrimitive=!0},g.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);return s(i)&&(i(),this.subscriptions.remove(e)),!0}return!1},g.prototype.update=function(t){var e,l=!0,p=this.primitive,u=this.orderedGroundPrimitives,g=this.geometry.values;if(this.createPrimitive){if(g.length>0)s(p)&&(s(this.oldPrimitive)?u.remove(p):this.oldPrimitive=p),p=new h({show:!1,asynchronous:this._asynchronous,geometryInstances:g,appearance:new this.appearanceType,classificationType:this.classificationType}),this.appearanceType===d&&(this.material=v.getValue(t,this.materialProperty,this.material),p.appearance.material=this.material),u.add(p,this.zIndex),l=!1;else{s(p)&&(u.remove(p),p=void 0);var P=this.oldPrimitive;s(P)&&(u.remove(P),this.oldPrimitive=void 0)}this.attributes.removeAll(),this.primitive=p,this.createPrimitive=!1}else if(s(p)&&p.ready){p.show=!0,s(this.oldPrimitive)&&(u.remove(this.oldPrimitive),this.oldPrimitive=void 0),this.appearanceType===d&&(this.material=v.getValue(t,this.materialProperty,this.material),this.primitive.appearance.material=this.material);var w=this.updatersWithAttributes.values,C=w.length;for(e=0;e<C;e++){var b=w[e],D=b.entity,_=this.geometry.get(b.id),A=this.attributes.get(_.id.id);if(s(A)||(A=p.getGeometryInstanceAttributes(_.id),this.attributes.set(_.id.id,A)),!b.fillMaterialProperty.isConstant){var S=b.fillMaterialProperty.color,I=c.getValueOrDefault(S,t,i.WHITE,y);i.equals(A._lastColor,I)||(A._lastColor=i.clone(I,A._lastColor),A.color=r.toValue(I,A.color))}var G=D.isShowing&&(b.hasConstantFill||b.isFilled(t));G!==(1===A.show[0])&&(A.show=n.toValue(G,A.show));var M=b.distanceDisplayConditionProperty;if(!c.isConstant(M)){var T=c.getValueOrDefault(M,t,f,m);o.equals(T,A._lastDistanceDisplayCondition)||(A._lastDistanceDisplayCondition=o.clone(T,A._lastDistanceDisplayCondition),A.distanceDisplayCondition=a.toValue(T,A.distanceDisplayCondition))}}this.updateShows(p)}else s(p)&&!p.ready&&(l=!1);return l},g.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,r=0;r<i;r++){var o=e[r],a=o.entity,h=this.geometry.get(o.id),l=this.attributes.get(h.id.id);s(l)||(l=t.getGeometryInstanceAttributes(h.id),this.attributes.set(h.id.id,l));var d=a.isShowing;d!==(1===l.show[0])&&(l.show=n.toValue(d,l.show),h.attributes.show.value[0]=l.show[0])}this.showsUpdated.removeAll()},g.prototype.contains=function(t){return this.updaters.contains(t.id)},g.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return p.PENDING;var r=i.getGeometryInstanceAttributes(t.entity);return!s(r)||!s(r.boundingSphere)||s(r.show)&&0===r.show[0]?p.FAILED:(r.boundingSphere.clone(e),p.DONE)},g.prototype.destroy=function(){var t=this.primitive,e=this.orderedGroundPrimitives;s(t)&&e.remove(t);var i=this.oldPrimitive;s(i)&&e.remove(i),this.removeMaterialSubscription()},P.prototype.add=function(t,e){for(var i=this._items,r=i.length,s=e.createFillGeometryInstance(t),o=c.getValueOrDefault(e.zIndex,0),a=0;a<r;++a){var n=i[a];if(n.isMaterial(e)&&n.zIndex===o)return void n.add(t,e,s)}var h=new g(this._orderedGroundPrimitives,this._classificationType,e.fillMaterialProperty,o,this._asynchronous);h.add(t,e,s),i.push(h)},P.prototype.remove=function(t){for(var e=this._items,i=e.length-1;i>=0;i--){var r=e[i];if(r.remove(t)){0===r.updaters.length&&(e.splice(i,1),r.destroy());break}}},P.prototype.update=function(t){var e,i=this._items;for(e=i.length-1;e>=0;e--){var r=i[e];if(r.invalidated){i.splice(e,1);for(var s=r.updaters.values,o=s.length,a=0;a<o;a++)this.add(t,s[a]);r.destroy()}}var n=!0;for(e=0;e<i.length;e++)n=i[e].update(t)&&n;return n},P.prototype.getBoundingSphere=function(t,e){for(var i=this._items,r=i.length,s=0;s<r;s++){var o=i[s];if(o.contains(t))return o.getBoundingSphere(t,e)}return p.FAILED},P.prototype.removeAllPrimitives=function(){for(var t=this._items,e=t.length,i=0;i<e;i++)t[i].destroy();this._items.length=0},P});