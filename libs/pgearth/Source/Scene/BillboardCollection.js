define(["../Core/AttributeCompression","../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Color","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/EncodedCartesian3","../Core/IndexDatatype","../Core/Math","../Core/Matrix4","../Core/WebGLConstants","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/VertexArrayFacade","../Shaders/BillboardCollectionFS","../Shaders/BillboardCollectionVS","./Billboard","./BlendingState","./BlendOption","./HeightReference","./HorizontalOrigin","./SceneMode","./TextureAtlas","./VerticalOrigin"],function(e,t,i,a,s,r,n,o,d,l,h,_,c,u,p,f,b,x,m,T,A,D,C,S,y,E,v,g,I,O,N,R,B,P,L){"use strict";var U,V,w=g.SHOW_INDEX,M=g.POSITION_INDEX,H=g.PIXEL_OFFSET_INDEX,F=g.EYE_OFFSET_INDEX,G=g.HORIZONTAL_ORIGIN_INDEX,W=g.VERTICAL_ORIGIN_INDEX,z=g.SCALE_INDEX,X=g.IMAGE_INDEX_INDEX,Y=g.COLOR_INDEX,k=g.ROTATION_INDEX,Q=g.ALIGNED_AXIS_INDEX,K=g.SCALE_BY_DISTANCE_INDEX,q=g.TRANSLUCENCY_BY_DISTANCE_INDEX,Z=g.PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX,j=g.DISTANCE_DISPLAY_CONDITION,J=g.DISABLE_DEPTH_DISTANCE,$=g.TEXTURE_COORDINATE_BOUNDS,ee=g.NUMBER_OF_PROPERTIES,te={positionHighAndScale:0,positionLowAndRotation:1,compressedAttribute0:2,compressedAttribute1:3,compressedAttribute2:4,eyeOffset:5,scaleByDistance:6,pixelOffsetScaleByDistance:7,compressedAttribute3:8,textureCoordinateBoundsOrLabelTranslate:9,a_batchId:10},ie={direction:0,positionHighAndScale:1,positionLowAndRotation:2,compressedAttribute0:3,compressedAttribute1:4,compressedAttribute2:5,eyeOffset:6,scaleByDistance:7,pixelOffsetScaleByDistance:8,compressedAttribute3:9,textureCoordinateBoundsOrLabelTranslate:10,a_batchId:11};function ae(e){e=n(e,n.EMPTY_OBJECT),this._scene=e.scene,this._batchTable=e.batchTable,this._textureAtlas=void 0,this._textureAtlasGUID=void 0,this._destroyTextureAtlas=!0,this._sp=void 0,this._spTranslucent=void 0,this._rsOpaque=void 0,this._rsTranslucent=void 0,this._vaf=void 0,this._billboards=[],this._billboardsToUpdate=[],this._billboardsToUpdateIndex=0,this._billboardsRemoved=!1,this._createVertexArray=!1,this._shaderRotation=!1,this._compiledShaderRotation=!1,this._shaderAlignedAxis=!1,this._compiledShaderAlignedAxis=!1,this._shaderScaleByDistance=!1,this._compiledShaderScaleByDistance=!1,this._shaderTranslucencyByDistance=!1,this._compiledShaderTranslucencyByDistance=!1,this._shaderPixelOffsetScaleByDistance=!1,this._compiledShaderPixelOffsetScaleByDistance=!1,this._shaderDistanceDisplayCondition=!1,this._compiledShaderDistanceDisplayCondition=!1,this._shaderDisableDepthDistance=!1,this._compiledShaderDisableDepthDistance=!1,this._shaderClampToGround=!1,this._compiledShaderClampToGround=!1,this._propertiesChanged=new Uint32Array(ee),this._maxSize=0,this._maxEyeOffset=0,this._maxScale=1,this._maxPixelOffset=0,this._allHorizontalCenter=!0,this._allVerticalCenter=!0,this._allSizedInMeters=!0,this._baseVolume=new t,this._baseVolumeWC=new t,this._baseVolume2D=new t,this._boundingVolume=new t,this._boundingVolumeDirty=!1,this._colorCommands=[],this.modelMatrix=p.clone(n(e.modelMatrix,p.IDENTITY)),this._modelMatrix=p.clone(p.IDENTITY),this.debugShowBoundingVolume=n(e.debugShowBoundingVolume,!1),this.blendOption=n(e.blendOption,O.OPAQUE_AND_TRANSLUCENT),this._blendOption=void 0,this._mode=B.SCENE3D,this._buffersUsage=[x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW,x.STATIC_DRAW],this._highlightColor=s.clone(s.WHITE);var i=this;this._uniforms={u_atlas:function(){return i._textureAtlas.texture},u_highlightColor:function(){return i._highlightColor}};var a=this._scene;o(a)&&o(a.terrainProviderChanged)&&(this._removeCallbackFunc=a.terrainProviderChanged.addEventListener(function(){for(var e=this._billboards,t=e.length,i=0;i<t;++i)e[i]._updateClamping()},this))}function se(e){for(var t=e.length,i=0;i<t;++i)e[i]&&e[i]._destroy()}function re(e){if(e._billboardsRemoved){e._billboardsRemoved=!1;for(var t=[],i=e._billboards,a=i.length,s=0,r=0;s<a;++s){var n=i[s];n&&(n._index=r++,t.push(n))}e._billboards=t}}function ne(e){var t=e.cache.billboardCollection_indexBufferBatched;if(o(t))return t;for(var i=new Uint16Array(98298),a=0,s=0;a<98298;a+=6,s+=4)i[a]=s,i[a+1]=s+1,i[a+2]=s+2,i[a+3]=s+0,i[a+4]=s+2,i[a+5]=s+3;return(t=b.createIndexBuffer({context:e,typedArray:i,usage:x.STATIC_DRAW,indexDatatype:c.UNSIGNED_SHORT})).vertexArrayDestroyable=!1,e.cache.billboardCollection_indexBufferBatched=t,t}function oe(e){var t=e.cache.billboardCollection_indexBufferInstanced;return o(t)?t:((t=b.createIndexBuffer({context:e,typedArray:new Uint16Array([0,1,2,0,2,3]),usage:x.STATIC_DRAW,indexDatatype:c.UNSIGNED_SHORT})).vertexArrayDestroyable=!1,e.cache.billboardCollection_indexBufferInstanced=t,t)}function de(e,t,i,a,s){var n=[{index:U.positionHighAndScale,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[M]},{index:U.positionLowAndRotation,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[M]},{index:U.compressedAttribute0,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[H]},{index:U.compressedAttribute1,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[q]},{index:U.compressedAttribute2,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[Y]},{index:U.eyeOffset,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[F]},{index:U.scaleByDistance,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[K]},{index:U.pixelOffsetScaleByDistance,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[Z]},{index:U.compressedAttribute3,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[j]},{index:U.textureCoordinateBoundsOrLabelTranslate,componentsPerAttribute:4,componentDatatype:r.FLOAT,usage:i[$]}];return a&&n.push({index:U.direction,componentsPerAttribute:2,componentDatatype:r.FLOAT,vertexBuffer:function(e){var t=e.cache.billboardCollection_vertexBufferInstanced;return o(t)?t:((t=b.createVertexBuffer({context:e,typedArray:new Float32Array([0,0,1,0,1,1,0,1]),usage:x.STATIC_DRAW})).vertexArrayDestroyable=!1,e.cache.billboardCollection_vertexBufferInstanced=t,t)}(e)}),o(s)&&n.push({index:U.a_batchId,componentsPerAttribute:1,componentDatatyps:r.FLOAT,bufferUsage:x.STATIC_DRAW}),new y(e,n,a?t:4*t,a)}d(ae.prototype,{length:{get:function(){return re(this),this._billboards.length}},textureAtlas:{get:function(){return this._textureAtlas},set:function(e){this._textureAtlas!==e&&(this._textureAtlas=this._destroyTextureAtlas&&this._textureAtlas&&this._textureAtlas.destroy(),this._textureAtlas=e,this._createVertexArray=!0)}},destroyTextureAtlas:{get:function(){return this._destroyTextureAtlas},set:function(e){this._destroyTextureAtlas=e}}}),ae.prototype.add=function(e){var t=new g(e,this);return t._index=this._billboards.length,this._billboards.push(t),this._createVertexArray=!0,t},ae.prototype.remove=function(e){return!!this.contains(e)&&(this._billboards[e._index]=null,this._billboardsRemoved=!0,this._createVertexArray=!0,e._destroy(),!0)},ae.prototype.removeAll=function(){se(this._billboards),this._billboards=[],this._billboardsToUpdate=[],this._billboardsToUpdateIndex=0,this._billboardsRemoved=!1,this._createVertexArray=!0},ae.prototype._updateBillboard=function(e,t){e._dirty||(this._billboardsToUpdate[this._billboardsToUpdateIndex++]=e),++this._propertiesChanged[t]},ae.prototype.contains=function(e){return o(e)&&e._billboardCollection===this},ae.prototype.get=function(e){if(!o(e))throw new h("index is required.");return re(this),this._billboards[e]},ae.prototype.computeNewBuffersUsage=function(){for(var e=this._buffersUsage,t=!1,i=this._propertiesChanged,a=0;a<ee;++a){var s=0===i[a]?x.STATIC_DRAW:x.STREAM_DRAW;t=t||e[a]!==s,e[a]=s}return t};var le=new _;function he(e,i,a,s,r){var n,o=s[U.positionHighAndScale],d=s[U.positionLowAndRotation],l=r._getActualPosition();e._mode===B.SCENE3D&&(t.expand(e._baseVolume,l,e._baseVolume),e._boundingVolumeDirty=!0),_.fromCartesian(l,le);var h=r.scale,c=r.rotation;0!==c&&(e._shaderRotation=!0),e._maxScale=Math.max(e._maxScale,h);var u=le.high,p=le.low;e._instanced?(o(n=r._index,u.x,u.y,u.z,h),d(n,p.x,p.y,p.z,c)):(o((n=4*r._index)+0,u.x,u.y,u.z,h),o(n+1,u.x,u.y,u.z,h),o(n+2,u.x,u.y,u.z,h),o(n+3,u.x,u.y,u.z,h),d(n+0,p.x,p.y,p.z,c),d(n+1,p.x,p.y,p.z,c),d(n+2,p.x,p.y,p.z,c),d(n+3,p.x,p.y,p.z,c))}var _e=new i,ce=32768,ue=65536,pe=4096,fe=256,be=128,xe=32,me=8,Te=4,Ae=1/256,De=0,Ce=2,Se=3,ye=1;function Ee(t,i,a,s,r){var n,d=s[U.compressedAttribute0],l=r.pixelOffset,_=l.x,c=l.y,p=r._translate,f=p.x,b=p.y;t._maxPixelOffset=Math.max(t._maxPixelOffset,Math.abs(_+f),Math.abs(-c+b));var x=r.horizontalOrigin,m=r._verticalOrigin,T=r.show&&r.clusterShow;0===r.color.alpha&&(T=!1),m===L.BASELINE&&(m=L.BOTTOM),t._allHorizontalCenter=t._allHorizontalCenter&&x===R.CENTER,t._allVerticalCenter=t._allVerticalCenter&&m===L.CENTER;var A=0,D=0,C=0,S=0,y=r._imageIndex;if(-1!==y){var E=a[y];if(!o(E))throw new h("Invalid billboard image index: "+y);A=E.x,D=E.y,C=E.width,S=E.height}var v=A+C,g=D+S,I=Math.floor(u.clamp(_,-ce,ce)+ce)*be;I+=(x+1)*xe,I+=(m+1)*me,I+=(T?1:0)*Te;var O=Math.floor(u.clamp(c,-ce,ce)+ce)*fe,N=Math.floor(u.clamp(f,-ce,ce)+ce)*fe,B=(u.clamp(b,-ce,ce)+ce)*Ae,P=Math.floor(B);O+=P,N+=Math.floor((B-P)*fe),_e.x=A,_e.y=D;var V=e.compressTextureCoordinates(_e);_e.x=v;var w=e.compressTextureCoordinates(_e);_e.y=g;var M=e.compressTextureCoordinates(_e);_e.x=A;var H=e.compressTextureCoordinates(_e);t._instanced?d(n=r._index,I,O,N,V):(d((n=4*r._index)+0,I+De,O,N,V),d(n+1,I+Ce,O,N,w),d(n+2,I+Se,O,N,M),d(n+3,I+ye,O,N,H))}function ve(t,i,s,r,d){var l,_=r[U.compressedAttribute1],c=d.alignedAxis;a.equals(c,a.ZERO)||(t._shaderAlignedAxis=!0);var p=0,f=1,b=1,x=1,m=d.translucencyByDistance;o(m)&&(p=m.near,f=m.nearValue,b=m.far,x=m.farValue,1===f&&1===x||(t._shaderTranslucencyByDistance=!0));var T=0,A=d._imageIndex;if(-1!==A){var D=s[A];if(!o(D))throw new h("Invalid billboard image index: "+A);T=D.width}var C=t._textureAtlas.texture.width,S=Math.round(n(d.width,C*T));t._maxSize=Math.max(t._maxSize,S);var y=u.clamp(S,0,ue),E=0;Math.abs(a.magnitudeSquared(c)-1)<u.EPSILON6&&(E=e.octEncodeFloat(c)),f=u.clamp(f,0,1),y=y*fe+(f=1===f?255:255*f|0),x=u.clamp(x,0,1),E=E*fe+(x=1===x?255:255*x|0),t._instanced?_(l=d._index,y,E,p,b):(_((l=4*d._index)+0,y,E,p,b),_(l+1,y,E,p,b),_(l+2,y,E,p,b),_(l+3,y,E,p,b))}function ge(e,t,i,r,d){var l,_=r[U.compressedAttribute2],c=d.color,p=o(e._batchTable)?s.WHITE:d.getPickId(t).color,f=d.sizeInMeters?1:0,b=Math.abs(a.magnitudeSquared(d.alignedAxis)-1)<u.EPSILON6?1:0;e._allSizedInMeters=e._allSizedInMeters&&1===f;var x=0,m=d._imageIndex;if(-1!==m){var T=i[m];if(!o(T))throw new h("Invalid billboard image index: "+m);x=T.height}var A=e._textureAtlas.texture.dimensions,D=Math.round(n(d.height,A.y*x));e._maxSize=Math.max(e._maxSize,D);var C=n(d._labelHorizontalOrigin,-2),S=D*Te+(C+=2),y=s.floatToByte(c.red),E=s.floatToByte(c.green),v=s.floatToByte(c.blue),g=y*ue+E*fe+v;y=s.floatToByte(p.red),E=s.floatToByte(p.green),v=s.floatToByte(p.blue);var I=y*ue+E*fe+v,O=s.floatToByte(c.alpha)*ue+s.floatToByte(p.alpha)*fe;O+=2*f+b,e._instanced?_(l=d._index,g,I,O,S):(_((l=4*d._index)+0,g,I,O,S),_(l+1,g,I,O,S),_(l+2,g,I,O,S),_(l+3,g,I,O,S))}function Ie(t,i,a,s,r){var n,d=s[U.eyeOffset],l=r.eyeOffset,_=l.z;if(r._heightReference!==N.NONE&&(_*=1.005),t._maxEyeOffset=Math.max(t._maxEyeOffset,Math.abs(l.x),Math.abs(l.y),Math.abs(_)),t._instanced){var c=0,u=0,p=r._imageIndex;if(-1!==p){var f=a[p];if(!o(f))throw new h("Invalid billboard image index: "+p);c=f.width,u=f.height}_e.x=c,_e.y=u;var b=e.compressTextureCoordinates(_e);d(n=r._index,l.x,l.y,_,b)}else d((n=4*r._index)+0,l.x,l.y,_,0),d(n+1,l.x,l.y,_,0),d(n+2,l.x,l.y,_,0),d(n+3,l.x,l.y,_,0)}function Oe(e,t,i,a,s){var r,n=a[U.scaleByDistance],d=0,l=1,h=1,_=1,c=s.scaleByDistance;o(c)&&(d=c.near,l=c.nearValue,h=c.far,_=c.farValue,1===l&&1===_||(e._shaderScaleByDistance=!0)),e._instanced?n(r=s._index,d,l,h,_):(n((r=4*s._index)+0,d,l,h,_),n(r+1,d,l,h,_),n(r+2,d,l,h,_),n(r+3,d,l,h,_))}function Ne(e,t,i,a,s){var r,n=a[U.pixelOffsetScaleByDistance],d=0,l=1,h=1,_=1,c=s.pixelOffsetScaleByDistance;o(c)&&(d=c.near,l=c.nearValue,h=c.far,_=c.farValue,1===l&&1===_||(e._shaderPixelOffsetScaleByDistance=!0)),e._instanced?n(r=s._index,d,l,h,_):(n((r=4*s._index)+0,d,l,h,_),n(r+1,d,l,h,_),n(r+2,d,l,h,_),n(r+3,d,l,h,_))}function Re(e,t,i,a,s){var r,d=a[U.compressedAttribute3],l=0,_=Number.MAX_VALUE,c=s.distanceDisplayCondition;o(c)&&(l=c.near,_=c.far,l*=l,_*=_,e._shaderDistanceDisplayCondition=!0);var p,f,b=s.disableDepthTestDistance,x=s.heightReference===N.CLAMP_TO_GROUND&&e._scene.context.depthTexture;if(o(b)||(b=x?5e3:0),b*=b,(x||b>0)&&(e._shaderDisableDepthDistance=!0,b===Number.POSITIVE_INFINITY&&(b=-1)),o(s._labelDimensions))f=s._labelDimensions.x,p=s._labelDimensions.y;else{var m=0,T=0,A=s._imageIndex;if(-1!==A){var D=i[A];if(!o(D))throw new h("Invalid billboard image index: "+A);m=D.height,T=D.width}p=Math.round(n(s.height,e._textureAtlas.texture.dimensions.y*m));var C=e._textureAtlas.texture.width;f=Math.round(n(s.width,C*T))}var S=Math.floor(u.clamp(f,0,pe)),y=Math.floor(u.clamp(p,0,pe)),E=S*pe+y;e._instanced?d(r=s._index,l,_,b,E):(d((r=4*s._index)+0,l,_,b,E),d(r+1,l,_,b,E),d(r+2,l,_,b,E),d(r+3,l,_,b,E))}function Be(e,t,i,a,s){var r;s.heightReference===N.CLAMP_TO_GROUND&&(e._shaderClampToGround=e._scene.context.depthTexture);var n=a[U.textureCoordinateBoundsOrLabelTranslate];if(m.maximumVertexTextureImageUnits>0){var d=0,l=0;return o(s._labelTranslate)&&(d=s._labelTranslate.x,l=s._labelTranslate.y),void(e._instanced?n(r=s._index,d,l,0,0):(n((r=4*s._index)+0,d,l,0,0),n(r+1,d,l,0,0),n(r+2,d,l,0,0),n(r+3,d,l,0,0)))}var _=0,c=0,u=0,p=0,f=s._imageIndex;if(-1!==f){var b=i[f];if(!o(b))throw new h("Invalid billboard image index: "+f);_=b.x,c=b.y,u=b.width,p=b.height}var x=_+u,T=c+p;e._instanced?n(r=s._index,_,c,x,T):(n((r=4*s._index)+0,_,c,x,T),n(r+1,_,c,x,T),n(r+2,_,c,x,T),n(r+3,_,c,x,T))}function Pe(e,t,i,a,s){he(e,0,0,a,s),Ee(e,0,i,a,s),ve(e,0,i,a,s),ge(e,t,i,a,s),Ie(e,0,i,a,s),Oe(e,0,0,a,s),Ne(e,0,0,a,s),Re(e,0,i,a,s),Be(e,0,i,a,s),function(e,t,i,a,s){if(o(e._batchTable)){var r,n=a[U.a_batchId],d=s._batchIndex;e._instanced?n(r=s._index,d):(n(0+(r=4*s._index),d),n(r+1,d),n(r+2,d),n(r+3,d))}}(e,0,0,a,s)}function Le(e,i,a,s,r,n){var d;s.mode===B.SCENE3D?(d=e._baseVolume,e._boundingVolumeDirty=!0):d=e._baseVolume2D;for(var l=[],h=0;h<a;++h){var _=i[h],c=_.position,u=g._computeActualPosition(_,c,s,r);o(u)&&(_._setActualPosition(u),n?l.push(u):t.expand(d,u,d))}n&&t.fromPoints(l,d)}var Ue=[];return ae.prototype.update=function(e){re(this);var i=this._billboards,a=i.length,s=e.context;this._instanced=s.instancedArrays,U=this._instanced?ie:te,V=this._instanced?oe:ne;var r=this._textureAtlas;if(!o(r)){r=this._textureAtlas=new P({context:s});for(var n=0;n<a;++n)i[n]._loadImage()}var d=r.textureCoordinates;if(0!==d.length){!function(e,t){var i=t.mode,a=e._billboards,s=e._billboardsToUpdate,r=e._modelMatrix;e._createVertexArray||e._mode!==i||i!==B.SCENE3D&&!p.equals(r,e.modelMatrix)?(e._mode=i,p.clone(e.modelMatrix,r),e._createVertexArray=!0,i!==B.SCENE3D&&i!==B.SCENE2D&&i!==B.COLUMBUS_VIEW||Le(e,a,a.length,t,r,!0)):i===B.MORPHING?Le(e,a,a.length,t,r,!0):i!==B.SCENE2D&&i!==B.COLUMBUS_VIEW||Le(e,s,e._billboardsToUpdateIndex,t,r,!1)}(this,e),a=(i=this._billboards).length;var l,h=this._billboardsToUpdate,_=this._billboardsToUpdateIndex,c=this._propertiesChanged,u=r.guid,b=this._createVertexArray||this._textureAtlasGUID!==u;this._textureAtlasGUID=u;var x=e.passes,y=x.pick;if(b||!y&&this.computeNewBuffersUsage()){this._createVertexArray=!1;for(var g=0;g<ee;++g)c[g]=0;if(this._vaf=this._vaf&&this._vaf.destroy(),a>0){this._vaf=de(s,a,this._buffersUsage,this._instanced,this._batchTable),l=this._vaf.writers;for(var N=0;N<a;++N){var R=this._billboards[N];R._dirty=!1,Pe(this,s,d,l,R)}this._vaf.commit(V(s))}this._billboardsToUpdateIndex=0}else if(_>0){var L=Ue;L.length=0,(c[M]||c[k]||c[z])&&L.push(he),(c[X]||c[H]||c[G]||c[W]||c[w])&&(L.push(Ee),this._instanced&&L.push(Ie)),(c[X]||c[Q]||c[q])&&(L.push(ve),L.push(ge)),(c[X]||c[Y])&&L.push(ge),c[F]&&L.push(Ie),c[K]&&L.push(Oe),c[Z]&&L.push(Ne),(c[j]||c[J]||c[X]||c[M])&&L.push(Re),(c[X]||c[M])&&L.push(Be);var $=L.length;if(l=this._vaf.writers,_/a>.1){for(var ae=0;ae<_;++ae){var se=h[ae];se._dirty=!1;for(var le=0;le<$;++le)L[le](this,s,d,l,se)}this._vaf.commit(V(s))}else{for(var _e=0;_e<_;++_e){var ce=h[_e];ce._dirty=!1;for(var ue=0;ue<$;++ue)L[ue](this,s,d,l,ce);this._instanced?this._vaf.subCommit(ce._index,1):this._vaf.subCommit(4*ce._index,4)}this._vaf.endSubCommits()}this._billboardsToUpdateIndex=0}if(_>1.5*a&&(h.length=a),o(this._vaf)&&o(this._vaf.va)){var pe;this._boundingVolumeDirty&&(this._boundingVolumeDirty=!1,t.transform(this._baseVolume,this.modelMatrix,this._baseVolumeWC));var fe=p.IDENTITY;e.mode===B.SCENE3D?(fe=this.modelMatrix,pe=t.clone(this._baseVolumeWC,this._boundingVolume)):pe=t.clone(this._baseVolume2D,this._boundingVolume),function(e,t,i){var a=1;e._allSizedInMeters&&0===e._maxPixelOffset||(a=t.camera.getPixelSize(i,t.context.drawingBufferWidth,t.context.drawingBufferHeight));var s=a*e._maxScale*e._maxSize*2;e._allHorizontalCenter&&e._allVerticalCenter&&(s*=.5);var r=a*e._maxPixelOffset+e._maxEyeOffset;i.radius+=s+r}(this,e,pe);var be,xe,me,Te,Ae,De=this._blendOption!==this.blendOption;if(this._blendOption=this.blendOption,De){this._blendOption===O.OPAQUE||this._blendOption===O.OPAQUE_AND_TRANSLUCENT?this._rsOpaque=D.fromCache({depthTest:{enabled:!0,func:f.LESS},depthMask:!0}):this._rsOpaque=void 0;var Ce=this._blendOption===O.TRANSLUCENT;this._blendOption===O.TRANSLUCENT||this._blendOption===O.OPAQUE_AND_TRANSLUCENT?this._rsTranslucent=D.fromCache({depthTest:{enabled:!0,func:Ce?f.LEQUAL:f.LESS},depthMask:Ce,blending:I.ALPHA_BLEND}):this._rsTranslucent=void 0}this._shaderDisableDepthDistance=this._shaderDisableDepthDistance||0!==e.minimumDisableDepthTestDistance;var Se=m.maximumVertexTextureImageUnits>0;if(De||this._shaderRotation!==this._compiledShaderRotation||this._shaderAlignedAxis!==this._compiledShaderAlignedAxis||this._shaderScaleByDistance!==this._compiledShaderScaleByDistance||this._shaderTranslucencyByDistance!==this._compiledShaderTranslucencyByDistance||this._shaderPixelOffsetScaleByDistance!==this._compiledShaderPixelOffsetScaleByDistance||this._shaderDistanceDisplayCondition!==this._compiledShaderDistanceDisplayCondition||this._shaderDisableDepthDistance!==this._compiledShaderDisableDepthDistance||this._shaderClampToGround!==this._compiledShaderClampToGround){be=v,xe=E,Ae=[],o(this._batchTable)&&(Ae.push("VECTOR_TILE"),be=this._batchTable.getVertexShaderCallback(!1,"a_batchId",void 0)(be),xe=this._batchTable.getFragmentShaderCallback(!1,void 0)(xe)),me=new S({defines:Ae,sources:[be]}),this._instanced&&me.defines.push("INSTANCED"),this._shaderRotation&&me.defines.push("ROTATION"),this._shaderAlignedAxis&&me.defines.push("ALIGNED_AXIS"),this._shaderScaleByDistance&&me.defines.push("EYE_DISTANCE_SCALING"),this._shaderTranslucencyByDistance&&me.defines.push("EYE_DISTANCE_TRANSLUCENCY"),this._shaderPixelOffsetScaleByDistance&&me.defines.push("EYE_DISTANCE_PIXEL_OFFSET"),this._shaderDistanceDisplayCondition&&me.defines.push("DISTANCE_DISPLAY_CONDITION"),this._shaderDisableDepthDistance&&me.defines.push("DISABLE_DEPTH_DISTANCE"),this._shaderClampToGround&&(Se?me.defines.push("VERTEX_DEPTH_CHECK"):me.defines.push("FRAGMENT_DEPTH_CHECK"));var ye=o(this._batchTable)?"VECTOR_TILE":"";this._blendOption===O.OPAQUE_AND_TRANSLUCENT&&(Te=new S({defines:["OPAQUE",ye],sources:[xe]}),this._shaderClampToGround&&(Se?Te.defines.push("VERTEX_DEPTH_CHECK"):Te.defines.push("FRAGMENT_DEPTH_CHECK")),this._sp=C.replaceCache({context:s,shaderProgram:this._sp,vertexShaderSource:me,fragmentShaderSource:Te,attributeLocations:U}),Te=new S({defines:["TRANSLUCENT",ye],sources:[xe]}),this._shaderClampToGround&&(Se?Te.defines.push("VERTEX_DEPTH_CHECK"):Te.defines.push("FRAGMENT_DEPTH_CHECK")),this._spTranslucent=C.replaceCache({context:s,shaderProgram:this._spTranslucent,vertexShaderSource:me,fragmentShaderSource:Te,attributeLocations:U})),this._blendOption===O.OPAQUE&&(Te=new S({defines:[ye],sources:[xe]}),this._shaderClampToGround&&(Se?Te.defines.push("VERTEX_DEPTH_CHECK"):Te.defines.push("FRAGMENT_DEPTH_CHECK")),this._sp=C.replaceCache({context:s,shaderProgram:this._sp,vertexShaderSource:me,fragmentShaderSource:Te,attributeLocations:U})),this._blendOption===O.TRANSLUCENT&&(Te=new S({defines:[ye],sources:[xe]}),this._shaderClampToGround&&(Se?Te.defines.push("VERTEX_DEPTH_CHECK"):Te.defines.push("FRAGMENT_DEPTH_CHECK")),this._spTranslucent=C.replaceCache({context:s,shaderProgram:this._spTranslucent,vertexShaderSource:me,fragmentShaderSource:Te,attributeLocations:U})),this._compiledShaderRotation=this._shaderRotation,this._compiledShaderAlignedAxis=this._shaderAlignedAxis,this._compiledShaderScaleByDistance=this._shaderScaleByDistance,this._compiledShaderTranslucencyByDistance=this._shaderTranslucencyByDistance,this._compiledShaderPixelOffsetScaleByDistance=this._shaderPixelOffsetScaleByDistance,this._compiledShaderDistanceDisplayCondition=this._shaderDistanceDisplayCondition,this._compiledShaderDisableDepthDistance=this._shaderDisableDepthDistance,this._compiledShaderClampToGround=this._shaderClampToGround}var Ve=e.commandList;if(x.render||x.pick){var we,Me=this._colorCommands,He=this._blendOption===O.OPAQUE,Fe=this._blendOption===O.OPAQUE_AND_TRANSLUCENT,Ge=this._vaf.va,We=Ge.length,ze=this._uniforms;o(this._batchTable)?(ze=this._batchTable.getUniformMapCallback()(ze),we=this._batchTable.getPickId()):we="v_pickColor",Me.length=We;for(var Xe=Fe?2*We:We,Ye=0;Ye<Xe;++Ye){var ke=Me[Ye];o(ke)||(ke=Me[Ye]=new T);var Qe=He||Fe&&Ye%2==0;ke.pass=Qe||!Fe?A.OPAQUE:A.TRANSLUCENT,ke.owner=this;var Ke=Fe?Math.floor(Ye/2):Ye;ke.boundingVolume=pe,ke.modelMatrix=fe,ke.count=Ge[Ke].indicesCount,ke.shaderProgram=Qe?this._sp:this._spTranslucent,ke.uniformMap=ze,ke.vertexArray=Ge[Ke].va,ke.renderState=Qe?this._rsOpaque:this._rsTranslucent,ke.debugShowBoundingVolume=this.debugShowBoundingVolume,ke.pickId=we,this._instanced&&(ke.count=6,ke.instanceCount=a),Ve.push(ke)}}}}},ae.prototype.isDestroyed=function(){return!1},ae.prototype.destroy=function(){return o(this._removeCallbackFunc)&&(this._removeCallbackFunc(),this._removeCallbackFunc=void 0),this._textureAtlas=this._destroyTextureAtlas&&this._textureAtlas&&this._textureAtlas.destroy(),this._sp=this._sp&&this._sp.destroy(),this._spTranslucent=this._spTranslucent&&this._spTranslucent.destroy(),this._vaf=this._vaf&&this._vaf.destroy(),se(this._billboards),l(this)},ae});