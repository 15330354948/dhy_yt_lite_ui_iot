define(["../Core/defined","../Core/destroyObject","../Core/TerrainQuantization","../Renderer/ShaderProgram","./getClippingFunction","./SceneMode"],function(e,t,r,o,n,s){"use strict";function a(){this.baseVertexShaderSource=void 0,this.baseFragmentShaderSource=void 0,this._shadersByTexturesFlags=[],this.material=void 0}return a.prototype.getShaderProgram=function(t){var a=t.frameState,i=t.surfaceTile,u=t.numberOfDayTextures,d=t.applyBrightness,h=t.applyContrast,c=t.applyHue,l=t.applySaturation,p=t.applyGamma,_=t.applyAlpha,T=t.applySplit,A=t.showReflectiveOcean,f=t.showOceanWaves,C=t.enableLighting,g=t.showGroundAtmosphere,E=t.perFragmentGroundAtmosphere,x=t.hasVertexNormals,P=t.useWebMercatorProjection,S=t.enableFog,v=t.enableClippingPlanes,y=t.clippingPlanes,L=t.clippedByBoundaries,O=t.hasImageryLayerCutout,R=t.colorCorrect,m=t.highlightFillTile,I=t.colorToAlpha,N=0,G="",D=i.renderedMesh.encoding;D.quantization===r.BITS12&&(N=1,G="QUANTIZATION_BITS12");var B=0,H="";e(i.vertexArray)&&e(i.terrainData)&&!i.terrainData._createdByUpsampling||(B=1,H="DISABLE_GL_POSITION_LOG_DEPTH");var F=0,M="";L&&(F=1,M="TILE_LIMIT_RECTANGLE");var b=0,U="";O&&(b=1,U="APPLY_IMAGERY_CUTOUT");var Y=a.mode,V=Y|d<<2|h<<3|c<<4|l<<5|p<<6|_<<7|A<<8|f<<9|C<<10|g<<11|E<<12|x<<13|P<<14|S<<15|N<<16|T<<17|v<<18|B<<19|F<<20|b<<21|R<<22|m<<23|I<<24,W=0;e(y)&&y.length>0&&(W=v?y.clippingPlanesState:0);var w=i.surfaceShader;if(e(w)&&w.numberOfDayTextures===u&&w.flags===V&&w.material===this.material&&w.clippingShaderState===W)return w.shaderProgram;var z=this._shadersByTexturesFlags[u];if(e(z)||(z=this._shadersByTexturesFlags[u]=[]),w=z[V],!e(w)||w.material!==this.material||w.clippingShaderState!==W){var X=this.baseVertexShaderSource.clone(),j=this.baseFragmentShaderSource.clone();0!==W&&j.sources.unshift(n(y,a.context)),X.defines.push(G,H),j.defines.push("TEXTURE_UNITS "+u,M,U),d&&j.defines.push("APPLY_BRIGHTNESS"),h&&j.defines.push("APPLY_CONTRAST"),c&&j.defines.push("APPLY_HUE"),l&&j.defines.push("APPLY_SATURATION"),p&&j.defines.push("APPLY_GAMMA"),_&&j.defines.push("APPLY_ALPHA"),A&&(j.defines.push("SHOW_REFLECTIVE_OCEAN"),X.defines.push("SHOW_REFLECTIVE_OCEAN")),f&&j.defines.push("SHOW_OCEAN_WAVES"),I&&j.defines.push("APPLY_COLOR_TO_ALPHA"),C&&(x?(X.defines.push("ENABLE_VERTEX_LIGHTING"),j.defines.push("ENABLE_VERTEX_LIGHTING")):(X.defines.push("ENABLE_DAYNIGHT_SHADING"),j.defines.push("ENABLE_DAYNIGHT_SHADING"))),g&&(X.defines.push("GROUND_ATMOSPHERE"),j.defines.push("GROUND_ATMOSPHERE"),E&&j.defines.push("PER_FRAGMENT_GROUND_ATMOSPHERE")),X.defines.push("INCLUDE_WEB_MERCATOR_Y"),j.defines.push("INCLUDE_WEB_MERCATOR_Y"),S&&(X.defines.push("FOG"),j.defines.push("FOG")),T&&j.defines.push("APPLY_SPLIT"),v&&j.defines.push("ENABLE_CLIPPING_PLANES"),R&&j.defines.push("COLOR_CORRECT"),m&&j.defines.push("HIGHLIGHT_FILL_TILE");var k="    vec4 computeDayColor(vec4 initialColor, vec3 textureCoordinates)\n    {\n        vec4 color = initialColor;\n";O&&(k+="        vec4 cutoutAndColorResult;\n        bool texelUnclipped;\n");for(var Q=0;Q<u;++Q)k+=O?"        cutoutAndColorResult = u_dayTextureCutoutRectangles["+Q+"];\n        texelUnclipped = v_textureCoordinates.x < cutoutAndColorResult.x || cutoutAndColorResult.z < v_textureCoordinates.x || v_textureCoordinates.y < cutoutAndColorResult.y || cutoutAndColorResult.w < v_textureCoordinates.y;\n        cutoutAndColorResult = sampleAndBlend(\n":"        color = sampleAndBlend(\n",k+="            color,\n            u_dayTextures["+Q+"],\n            u_dayTextureUseWebMercatorT["+Q+"] ? textureCoordinates.xz : textureCoordinates.xy,\n            u_dayTextureTexCoordsRectangle["+Q+"],\n            u_dayTextureTranslationAndScale["+Q+"],\n            "+(_?"u_dayTextureAlpha["+Q+"]":"1.0")+",\n            "+(d?"u_dayTextureBrightness["+Q+"]":"0.0")+",\n            "+(h?"u_dayTextureContrast["+Q+"]":"0.0")+",\n            "+(c?"u_dayTextureHue["+Q+"]":"0.0")+",\n            "+(l?"u_dayTextureSaturation["+Q+"]":"0.0")+",\n            "+(p?"u_dayTextureOneOverGamma["+Q+"]":"0.0")+",\n            "+(T?"u_dayTextureSplit["+Q+"]":"0.0")+",\n            "+(I?"u_colorsToAlpha["+Q+"]":"vec4(0.0)")+"\n        );\n",O&&(k+="        color = czm_branchFreeTernary(texelUnclipped, cutoutAndColorResult, color);\n");k+="        return color;\n    }",j.sources.push(k),X.sources.push(function(e){var t;switch(e){case s.SCENE3D:t="vec4 getPosition(vec3 position, float height, vec2 textureCoordinates) { return getPosition3DMode(position, height, textureCoordinates); }";break;case s.SCENE2D:case s.COLUMBUS_VIEW:t="vec4 getPosition(vec3 position, float height, vec2 textureCoordinates) { return getPositionColumbusViewMode(position, height, textureCoordinates); }";break;case s.MORPHING:t="vec4 getPosition(vec3 position, float height, vec2 textureCoordinates) { return getPositionMorphingMode(position, height, textureCoordinates); }"}return t}(Y)),X.sources.push(function(e){return e?"float get2DYPositionFraction(vec2 textureCoordinates) { return get2DMercatorYPositionFraction(textureCoordinates); }":"float get2DYPositionFraction(vec2 textureCoordinates) { return get2DGeographicYPositionFraction(textureCoordinates); }"}(P));var q=o.fromCache({context:a.context,vertexShaderSource:X,fragmentShaderSource:j,attributeLocations:D.getAttributeLocations()});w=z[V]=new function(e,t,r,o,n){this.numberOfDayTextures=e,this.flags=t,this.material=r,this.shaderProgram=o,this.clippingShaderState=n}(u,V,this.material,q,W)}return i.surfaceShader=w,w.shaderProgram},a.prototype.destroy=function(){var r,o,n=this._shadersByTexturesFlags;for(var s in n)if(n.hasOwnProperty(s)){var a=n[s];if(!e(a))continue;for(r in a)a.hasOwnProperty(r)&&(o=a[r],e(o)&&o.shaderProgram.destroy())}return t(this)},a});