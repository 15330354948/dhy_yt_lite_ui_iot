define(["../Core/arrayFill","../Core/Cartesian2","../Core/Cartesian4","../Core/Check","../Core/clone","../Core/Color","../Core/combine","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/deprecationWarning","../Core/destroyObject","../Core/DeveloperError","../Core/Math","../Core/PixelFormat","../Core/RuntimeError","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/PixelDatatype","../Renderer/RenderState","../Renderer/Sampler","../Renderer/ShaderSource","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","./AttributeType","./BlendingState","./PGEarth3DTileColorBlendMode","./CullFace","./getBinaryAccessor","./StencilConstants","./StencilFunction","./StencilOperation"],function(e,t,r,n,i,a,s,o,l,c,u,f,h,p,_,d,v,y,m,b,T,g,x,C,S,A,L,I,P,D,w,E,R,O,k){"use strict";var N=a.WHITE;function B(n,a,u,f,h){var p;this.featuresLength=a,this._translucentFeaturesLength=0,c(u)&&(p=u.extensions),this._extensions=l(p,{});var _,d,v=function(e){var t={};if(!c(e))return t;for(var r in e)e.hasOwnProperty(r)&&"HIERARCHY"!==r&&"extensions"!==r&&"extras"!==r&&(t[r]=i(e[r],!0));return t}(u);if(this._properties=v,this._batchTableHierarchy=function(t,r,n){if(!c(r))return;var i=t._extensions["3DTILES_batch_table_hierarchy"],a=r.HIERARCHY;c(a)&&(B._deprecationWarning("batchTableHierarchyExtension","The batch table HIERARCHY property has been moved to an extension. Use extensions.3DTILES_batch_table_hierarchy instead."),t._extensions["3DTILES_batch_table_hierarchy"]=a,i=a);if(!c(i))return;return function(t,r){var n,i,a,u,f=t.instancesLength,h=t.classes,p=t.classIds,_=t.parentCounts,d=t.parentIds,v=f;c(p.byteOffset)&&(p.componentType=l(p.componentType,o.UNSIGNED_SHORT),p.type=I.SCALAR,a=E(p),p=a.createArrayBufferView(r.buffer,r.byteOffset+p.byteOffset,f));if(c(_))for(c(_.byteOffset)&&(_.componentType=l(_.componentType,o.UNSIGNED_SHORT),_.type=I.SCALAR,a=E(_),_=a.createArrayBufferView(r.buffer,r.byteOffset+_.byteOffset,f)),u=new Uint16Array(f),v=0,n=0;n<f;++n)u[n]=v,v+=_[n];c(d)&&c(d.byteOffset)&&(d.componentType=l(d.componentType,o.UNSIGNED_SHORT),d.type=I.SCALAR,a=E(d),d=a.createArrayBufferView(r.buffer,r.byteOffset+d.byteOffset,v));var y=h.length;for(n=0;n<y;++n){var m=h[n].length,b=h[n].instances,T=M(m,b,r);h[n].instances=s(T,b)}var g=e(new Array(y),0),x=new Uint16Array(f);for(n=0;n<f;++n)i=p[n],x[n]=g[i],++g[i];var C={classes:h,classIds:p,classIndexes:x,parentCounts:_,parentIndexes:u,parentIds:d};return function(e){var t=U;t.length=0;for(var r=e.classIds.length,n=0;n<r;++n)H(e,n,t)}(C),C}(i,n)}(this,u,f),this._batchTableBinaryProperties=M(a,v,f),this._showAlphaProperties=void 0,this._batchValues=void 0,this._batchValuesDirty=!1,this._batchTexture=void 0,this._defaultTexture=void 0,this._pickTexture=void 0,this._pickIds=[],this._content=n,this._colorChangedCallback=h,a>0){var m=Math.min(a,y.maximumTextureSize),b=Math.ceil(a/y.maximumTextureSize),T=1/m,g=.5*T,x=1/b,C=.5*x;_=new t(m,b),d=new r(T,g,x,C)}this._textureDimensions=_,this._textureStep=d}B._deprecationWarning=f,u(B.prototype,{memorySizeInBytes:{get:function(){var e=0;return c(this._pickTexture)&&(e+=this._pickTexture.sizeInBytes),c(this._batchTexture)&&(e+=this._batchTexture.sizeInBytes),e}}});var U=[];function H(e,t,r){var n=e.parentCounts,i=e.parentIds,a=e.parentIndexes,s=e.classIds.length;if(c(i)){if(t>=s)throw new p("Parent index "+t+" exceeds the total number of instances: "+s);if(r.indexOf(t)>-1)throw new p("Circular dependency detected in the batch table hierarchy.");r.push(t);for(var o=c(n)?n[t]:1,l=c(n)?a[t]:t,u=0;u<o;++u){var f=i[l+u];f!==t&&H(e,f,r)}r.pop(t)}}function M(e,t,r){var n;for(var i in t)if(t.hasOwnProperty(i)){var a=t[i],s=a.byteOffset;if(c(s)){var o=a.componentType,l=a.type;if(!c(o))throw new v("componentType is required.");if(!c(l))throw new v("type is required.");if(!c(r))throw new v("Property "+i+" requires a batch table binary.");var u=E(a),f=u.componentsPerAttribute,h=u.classType,p=u.createArrayBufferView(r.buffer,r.byteOffset+s,e);c(n)||(n={}),n[i]={typedArray:p,componentCount:f,type:h}}}return n}function F(e){var t=e._textureDimensions;return t.x*t.y*4}function V(t){if(!c(t._batchValues)){var r=F(t),n=new Uint8Array(r);e(n,255),t._batchValues=n}return t._batchValues}function z(t){if(!c(t._showAlphaProperties)){var r=2*t.featuresLength,n=new Uint8Array(r);e(n,255),t._showAlphaProperties=n}return t._showAlphaProperties}function G(e,t){if(!c(e)||e<0||e>t)throw new p("batchId is required and between zero and featuresLength - 1 ("+t-NaN)}B.getBinaryProperties=function(e,t,r){return M(e,t,r)},B.prototype.setShow=function(e,t){if(G(e,this.featuresLength),n.typeOf.bool("show",t),!t||c(this._showAlphaProperties)){var r=z(this),i=2*e,a=t?255:0;if(r[i]!==a)r[i]=a,V(this)[4*e+3]=t?r[i+1]:0,this._batchValuesDirty=!0}},B.prototype.setAllShow=function(e){n.typeOf.bool("show",e);for(var t=this.featuresLength,r=0;r<t;++r)this.setShow(r,e)},B.prototype.getShow=function(e){if(G(e,this.featuresLength),!c(this._showAlphaProperties))return!0;var t=2*e;return 255===this._showAlphaProperties[t]};var K=new Array(4);B.prototype.setColor=function(e,t){if(G(e,this.featuresLength),n.typeOf.object("color",t),!a.equals(t,N)||c(this._batchValues)){var r=t.toBytes(K),i=r[3],s=V(this),o=4*e,l=z(this),u=2*e;if(s[o]!==r[0]||s[o+1]!==r[1]||s[o+2]!==r[2]||l[u+1]!==i){s[o]=r[0],s[o+1]=r[1],s[o+2]=r[2];var f=255!==l[u+1],h=0!==l[u];s[o+3]=h?i:0,l[u+1]=i;var p=255!==i;p&&!f?++this._translucentFeaturesLength:!p&&f&&--this._translucentFeaturesLength,this._batchValuesDirty=!0,c(this._colorChangedCallback)&&this._colorChangedCallback(e,t)}}},B.prototype.setAllColor=function(e){n.typeOf.object("color",e);for(var t=this.featuresLength,r=0;r<t;++r)this.setColor(r,e)},B.prototype.getColor=function(e,t){if(G(e,this.featuresLength),n.typeOf.object("result",t),!c(this._batchValues))return a.clone(N,t);var r=this._batchValues,i=4*e,s=this._showAlphaProperties,o=2*e;return a.fromBytes(r[i],r[i+1],r[i+2],s[o+1],t)},B.prototype.getPickColor=function(e){return G(e,this.featuresLength),this._pickIds[e]};var q=new a;function Q(e,t){var r=e.typedArray,n=e.componentCount;return 1===n?r[t]:e.type.unpack(r,t*n)}function X(e,t,r){var n=e.typedArray,i=e.componentCount;1===i?n[t]=r:e.type.pack(r,n,t*i)}B.prototype.applyStyle=function(e){if(!c(e))return this.setAllColor(N),void this.setAllShow(!0);for(var t=this._content,r=this.featuresLength,n=0;n<r;++n){var i=t.getFeature(n),a=c(e.color)?e.color.evaluateColor(i,q):N,s=!c(e.show)||e.show.evaluate(i);this.setColor(n,a),this.setShow(n,s)}};var Y=[],W=[],j=0;function J(e,t,r){var n=e.parentCounts,i=e.parentIds;return c(i)?c(n)?function(e,t,r){var n=e.classIds,i=e.parentCounts,a=e.parentIds,s=e.parentIndexes,o=n.length,l=Y;l.length=Math.max(l.length,o);var u=++j,f=W;for(f.length=0,f.push(t);f.length>0;)if(l[t=f.pop()]!==u){l[t]=u;var h=r(e,t);if(c(h))return h;for(var p=i[t],_=s[t],d=0;d<p;++d){var v=a[_+d];v!==t&&f.push(v)}}}(e,t,r):function(e,t,r){for(var n=!0;n;){var i=r(e,t);if(c(i))return i;var a=e.parentIds[t];n=a!==t,t=a}}(e,t,r):r(e,t)}function Z(e,t){return e=C.replaceMain(e,"tile_main"),t?e+"uniform float tile_colorBlend; \nvoid tile_color(vec4 tile_featureColor) \n{ \n    tile_main(); \n    tile_featureColor = czm_gammaCorrect(tile_featureColor); \n    gl_FragColor.a *= tile_featureColor.a; \n    float highlight = ceil(tile_colorBlend); \n    gl_FragColor.rgb *= mix(tile_featureColor.rgb, vec3(1.0), highlight); \n} \n":e+"void tile_color(vec4 tile_featureColor) \n{ \n    tile_main(); \n} \n"}function $(e,t,r){if(!c(t))return Z(e,r);var n=new RegExp("(uniform|attribute|in)\\s+(vec[34]|sampler2D)\\s+"+t+";"),i=e.match(n);if(!c(i))return Z(e,r);var a=i[0],s=i[2];e=(e=C.replaceMain(e,"tile_main")).replace(a,"");var o;if("vec3"===s||"vec4"===s){var l="vec3"===s?"vec4("+t+", 1.0)":t,u="vec3"===s?"tile_diffuse.xyz":"tile_diffuse";n=new RegExp(t,"g"),e=e.replace(n,u),o="    vec4 source = "+l+"; \n    tile_diffuse = tile_diffuse_final(source, tile_featureColor); \n    tile_main(); \n"}else"sampler2D"===s&&(e=function(e,t){for(var r,n="texture2D("+t,i=0,a=e.indexOf(n,i);a>-1;){for(var s=0,o=a;o<e.length;++o){var l=e.charAt(o);if("("===l)++s;else if(")"===l&&0==--s){r=o+1;break}}var c="tile_diffuse_final("+e.slice(a,r)+", tile_diffuse)";e=e.slice(0,a)+c+e.slice(r),i=a+c.length,a=e.indexOf(n,i)}return e}(e,t),o="    tile_diffuse = tile_featureColor; \n    tile_main(); \n");return e="uniform float tile_colorBlend; \nvec4 tile_diffuse = vec4(1.0); \nbool isWhite(vec3 color) \n{ \n    return all(greaterThan(color, vec3(1.0 - czm_epsilon3))); \n} \nvec4 tile_diffuse_final(vec4 sourceDiffuse, vec4 tileDiffuse) \n{ \n    vec4 blendDiffuse = mix(sourceDiffuse, tileDiffuse, tile_colorBlend); \n    vec4 diffuse = isWhite(tileDiffuse.rgb) ? sourceDiffuse : blendDiffuse; \n    return vec4(diffuse.rgb, sourceDiffuse.a); \n} \n"+a+"\n"+e+"\nvoid tile_color(vec4 tile_featureColor) \n{ \n"+o,r&&(e+="    tile_featureColor = czm_gammaCorrect(tile_featureColor); \n    gl_FragColor.a *= tile_featureColor.a; \n    float highlight = ceil(tile_colorBlend); \n    gl_FragColor.rgb *= mix(tile_featureColor.rgb, vec3(1.0), highlight); \n"),e+="} \n"}B.prototype.isClass=function(e,t){G(e,this.featuresLength),n.typeOf.string("className",t);var r=this._batchTableHierarchy;if(!c(r))return!1;var i=J(r,e,function(e,r){var n=e.classIds[r];if(e.classes[n].name===t)return!0});return c(i)},B.prototype.isExactClass=function(e,t){return n.typeOf.string("className",t),this.getExactClassName(e)===t},B.prototype.getExactClassName=function(e){G(e,this.featuresLength);var t=this._batchTableHierarchy;if(c(t)){var r=t.classIds[e];return t.classes[r].name}},B.prototype.hasProperty=function(e,t){return G(e,this.featuresLength),n.typeOf.string("name",t),c(this._properties[t])||c(this._batchTableHierarchy)&&function(e,t,r){var n=J(e._batchTableHierarchy,t,function(e,t){var n=e.classIds[t],i=e.classes[n].instances;if(c(i[r]))return!0});return c(n)}(this,e,t)},B.prototype.getPropertyNames=function(e,t){G(e,this.featuresLength),(t=c(t)?t:[]).length=0;var r=Object.keys(this._properties);return t.push.apply(t,r),c(this._batchTableHierarchy)&&function(e,t,r){J(e._batchTableHierarchy,t,function(e,t){var n=e.classIds[t],i=e.classes[n].instances;for(var a in i)i.hasOwnProperty(a)&&-1===r.indexOf(a)&&r.push(a)})}(this,e,t),t},B.prototype.getProperty=function(e,t){if(G(e,this.featuresLength),n.typeOf.string("name",t),c(this._batchTableBinaryProperties)){var r=this._batchTableBinaryProperties[t];if(c(r))return Q(r,e)}var a=this._properties[t];if(c(a))return i(a[e],!0);if(c(this._batchTableHierarchy)){var s=function(e,t,r){return J(e._batchTableHierarchy,t,function(e,t){var n=e.classIds[t],a=e.classes[n],s=e.classIndexes[t],o=a.instances[r];if(c(o))return c(o.typedArray)?Q(o,s):i(o[s],!0)})}(this,e,t);if(c(s))return s}},B.prototype.setProperty=function(e,t,r){var a=this.featuresLength;if(G(e,a),n.typeOf.string("name",t),c(this._batchTableBinaryProperties)){var s=this._batchTableBinaryProperties[t];if(c(s))return void X(s,e,r)}if(!c(this._batchTableHierarchy)||!function(e,t,r,n){var a=J(e._batchTableHierarchy,t,function(e,a){var s=e.classIds[a],o=e.classes[s],l=e.classIndexes[a],u=o.instances[r];if(c(u)){if(a!==t)throw new p('Inherited property "'+r+'" is read-only.');return c(u.typedArray)?X(u,l,n):u[l]=i(n,!0),!0}});return c(a)}(this,e,t,r)){var o=this._properties[t];c(o)||(this._properties[t]=new Array(a),o=this._properties[t]),o[e]=i(r,!0)}},B.prototype.getVertexShaderCallback=function(e,t,r){if(0!==this.featuresLength){var n=this;return function(i){var a,s=$(i,r,!1);return y.maximumVertexTextureImageUnits>0?(a="",e&&(a+="uniform bool tile_translucentCommand; \n"),a+="uniform sampler2D tile_batchTexture; \nvarying vec4 tile_featureColor; \nvarying vec2 tile_featureSt; \nvoid main() \n{ \n    vec2 st = computeSt("+t+"); \n    vec4 featureProperties = texture2D(tile_batchTexture, st); \n    tile_color(featureProperties); \n    float show = ceil(featureProperties.a); \n    gl_Position *= show; \n",e&&(a+="    bool isStyleTranslucent = (featureProperties.a != 1.0); \n    if (czm_pass == czm_passTranslucent) \n    { \n        if (!isStyleTranslucent && !tile_translucentCommand) \n        { \n            gl_Position *= 0.0; \n        } \n    } \n    else \n    { \n        if (isStyleTranslucent) \n        { \n            gl_Position *= 0.0; \n        } \n    } \n"),a+="    tile_featureColor = featureProperties; \n    tile_featureSt = st; \n}"):a="varying vec2 tile_featureSt; \nvoid main() \n{ \n    tile_color(vec4(1.0)); \n    tile_featureSt = computeSt("+t+"); \n}",s+"\n"+(1===n._textureDimensions.y?"uniform vec4 tile_textureStep; \nvec2 computeSt(float batchId) \n{ \n    float stepX = tile_textureStep.x; \n    float centerX = tile_textureStep.y; \n    return vec2(centerX + (batchId * stepX), 0.5); \n} \n":"uniform vec4 tile_textureStep; \nuniform vec2 tile_textureDimensions; \nvec2 computeSt(float batchId) \n{ \n    float stepX = tile_textureStep.x; \n    float centerX = tile_textureStep.y; \n    float stepY = tile_textureStep.z; \n    float centerY = tile_textureStep.w; \n    float xId = mod(batchId, tile_textureDimensions.x); \n    float yId = floor(batchId / tile_textureDimensions.x); \n    return vec2(centerX + (xId * stepX), centerY + (yId * stepY)); \n} \n")+a}}},B.prototype.getFragmentShaderCallback=function(e,t){if(0!==this.featuresLength)return function(r){return r=$(r,t,!0),y.maximumVertexTextureImageUnits>0?r+="uniform sampler2D tile_pickTexture; \nvarying vec2 tile_featureSt; \nvarying vec4 tile_featureColor; \nvoid main() \n{ \n    tile_color(tile_featureColor); \n}":(e&&(r+="uniform bool tile_translucentCommand; \n"),r+="uniform sampler2D tile_pickTexture; \nuniform sampler2D tile_batchTexture; \nvarying vec2 tile_featureSt; \nvoid main() \n{ \n    vec4 featureProperties = texture2D(tile_batchTexture, tile_featureSt); \n    if (featureProperties.a == 0.0) { \n        discard; \n    } \n",e&&(r+="    bool isStyleTranslucent = (featureProperties.a != 1.0); \n    if (czm_pass == czm_passTranslucent) \n    { \n        if (!isStyleTranslucent && !tile_translucentCommand) \n        { \n            discard; \n        } \n    } \n    else \n    { \n        if (isStyleTranslucent) \n        { \n            discard; \n        } \n    } \n"),r+="    tile_color(featureProperties); \n} \n"),r}},B.prototype.getClassificationFragmentShaderCallback=function(){if(0!==this.featuresLength)return function(e){return e=C.replaceMain(e,"tile_main"),y.maximumVertexTextureImageUnits>0?e+="uniform sampler2D tile_pickTexture;\nvarying vec2 tile_featureSt; \nvarying vec4 tile_featureColor; \nvoid main() \n{ \n    tile_main(); \n    gl_FragColor = tile_featureColor; \n}":e+="uniform sampler2D tile_batchTexture; \nuniform sampler2D tile_pickTexture;\nvarying vec2 tile_featureSt; \nvoid main() \n{ \n    tile_main(); \n    vec4 featureProperties = texture2D(tile_batchTexture, tile_featureSt); \n    if (featureProperties.a == 0.0) { \n        discard; \n    } \n    gl_FragColor = featureProperties; \n} \n",e}},B.prototype.getUniformMapCallback=function(){if(0!==this.featuresLength){var e=this;return function(t){return s(t,{tile_batchTexture:function(){return l(e._batchTexture,e._defaultTexture)},tile_textureDimensions:function(){return e._textureDimensions},tile_textureStep:function(){return e._textureStep},tile_colorBlend:function(){return function(e){var t=e._content.tileset,r=t.colorBlendMode,n=t.colorBlendAmount;if(r===D.HIGHLIGHT)return 0;if(r===D.REPLACE)return 1;if(r===D.MIX)return _.clamp(n,_.EPSILON4,1);throw new p('Invalid color blend mode "'+r+'".')}(e)},tile_pickTexture:function(){return e._pickTexture}})}}},B.prototype.getPickId=function(){return"texture2D(tile_pickTexture, tile_featureSt)"};var ee={ALL_OPAQUE:0,ALL_TRANSLUCENT:1,OPAQUE_AND_TRANSLUCENT:2};function te(e){var t=m.shallowClone(e),r=t.pass===b.TRANSLUCENT;return t.uniformMap=c(t.uniformMap)?t.uniformMap:{},t.uniformMap.tile_translucentCommand=function(){return r},t}function re(e){var t,r,n=m.shallowClone(e);return n.pass=b.TRANSLUCENT,n.renderState=(t=e.renderState,(r=i(t,!0)).cull.enabled=!1,r.depthTest.enabled=!0,r.depthMask=!1,r.blending=P.ALPHA_BLEND,g.fromCache(r)),n}function ne(e){var t,r,n=m.shallowClone(e);return n.renderState=(t=e.renderState,(r=i(t,!0)).stencilTest=R.setPGEarth3DTileBit(),r.stencilMask=R.PGEARTH_3D_TILE_MASK,g.fromCache(r)),n}function ie(e,t){var r=m.shallowClone(t),n=i(r.renderState,!0);return n.cull.enabled=!0,n.cull.face=w.FRONT,n.colorMask={red:!1,green:!1,blue:!1,alpha:!1},n.polygonOffset={enabled:!0,factor:5,units:5},n.stencilTest=R.setPGEarth3DTileBit(),n.stencilMask=R.PGEARTH_3D_TILE_MASK,r.renderState=g.fromCache(n),r.castShadows=!1,r.receiveShadows=!1,r.shaderProgram=function(e,t){var r=e.shaderCache.getDerivedShaderProgram(t,"zBackfaceLogDepth");if(!c(r)){var n=t.fragmentShaderSource.clone();n.defines=c(n.defines)?n.defines.slice(0):[],n.defines.push("DISABLE_LOG_DEPTH_FRAGMENT_WRITE"),r=e.shaderCache.createDerivedShaderProgram(t,"zBackfaceLogDepth",{vertexShaderSource:t.vertexShaderSource,fragmentShaderSource:n,attributeLocations:t._attributeLocations})}return r}(e,t.shaderProgram),r}function ae(e,t){var r=m.shallowClone(e),n=i(r.renderState,!0);return n.stencilTest.enabled=!0,n.stencilTest.mask=R.SKIP_LOD_MASK,n.stencilTest.reference=R.PGEARTH_3D_TILE_MASK|t<<R.SKIP_LOD_BIT_SHIFT,n.stencilTest.frontFunction=O.GREATER_OR_EQUAL,n.stencilTest.frontOperation.zPass=k.REPLACE,n.stencilTest.backFunction=O.GREATER_OR_EQUAL,n.stencilTest.backOperation.zPass=k.REPLACE,n.stencilMask=R.PGEARTH_3D_TILE_MASK|R.SKIP_LOD_MASK,r.renderState=g.fromCache(n),r}function se(e,t,r){var n=e._textureDimensions;return new S({context:t,pixelFormat:d.RGBA,pixelDatatype:T.UNSIGNED_BYTE,source:{width:n.x,height:n.y,arrayBufferView:r},flipY:!1,sampler:new x({minificationFilter:L.NEAREST,magnificationFilter:A.NEAREST})})}return B.prototype.addDerivedCommands=function(e,t){for(var r,n=e.commandList,i=n.length,a=this._content._tile,s=a._finalResolution,o=a.tileset,l=o._skipLevelOfDetail&&o._hasMixedContent&&e.context.stencilBuffer,u=function(e){var t=e._translucentFeaturesLength;if(0===t)return ee.ALL_OPAQUE;if(t===e.featuresLength)return ee.ALL_TRANSLUCENT;return ee.OPAQUE_AND_TRANSLUCENT}(this),f=t;f<i;++f){var h=n[f],p=h.derivedCommands.tileset;c(p)&&!h.dirty||(p={},h.derivedCommands.tileset=p,p.originalCommand=te(h),h.dirty=!1);var _=p.originalCommand;u!==ee.ALL_OPAQUE&&h.pass!==b.TRANSLUCENT&&(c(p.translucent)||(p.translucent=re(_))),u!==ee.ALL_TRANSLUCENT&&h.pass!==b.TRANSLUCENT&&(c(p.opaque)||(p.opaque=ne(_)),l&&(s||(c(p.zback)||(p.zback=ie(e.context,_)),o._backfaceCommands.push(p.zback)),c(p.stencil)&&a._selectionDepth===(r=p.stencil,void 0,(r.renderState.stencilTest.reference&R.SKIP_LOD_MASK)>>>R.SKIP_LOD_BIT_SHIFT)||(h.renderState.depthMask?p.stencil=ae(_,a._selectionDepth):p.stencil=p.opaque)));var d=l?p.stencil:p.opaque,v=p.translucent;h.pass!==b.TRANSLUCENT?(u===ee.ALL_OPAQUE&&(n[f]=d),u===ee.ALL_TRANSLUCENT&&(n[f]=v),u===ee.OPAQUE_AND_TRANSLUCENT&&(n[f]=d,n.push(v))):n[f]=_}},B.prototype.update=function(e,t){var r=t.context;this._defaultTexture=r.defaultTexture;var n,i,s=t.passes;(s.pick||s.postProcess)&&function(e,t){var r=e.featuresLength;if(!c(e._pickTexture)&&r>0){for(var n=e._pickIds,i=F(e),s=new Uint8Array(i),o=e._content,l=0;l<r;++l){var u=t.createPickId(o.getFeature(l));n.push(u);var f=u.color,h=4*l;s[h]=a.floatToByte(f.red),s[h+1]=a.floatToByte(f.green),s[h+2]=a.floatToByte(f.blue),s[h+3]=a.floatToByte(f.alpha)}e._pickTexture=se(e,t,s),o.tileset._statistics.batchTableByteLength+=e._pickTexture.sizeInBytes}}(this,r),this._batchValuesDirty&&(this._batchValuesDirty=!1,c(this._batchTexture)||(this._batchTexture=se(this,r,this._batchValues),e._statistics.batchTableByteLength+=this._batchTexture.sizeInBytes),i=(n=this)._textureDimensions,n._batchTexture.copyFrom({width:i.x,height:i.y,arrayBufferView:n._batchValues}))},B.prototype.isDestroyed=function(){return!1},B.prototype.destroy=function(){this._batchTexture=this._batchTexture&&this._batchTexture.destroy(),this._pickTexture=this._pickTexture&&this._pickTexture.destroy();for(var e=this._pickIds,t=e.length,r=0;r<t;++r)e[r].destroy();return h(this)},B});