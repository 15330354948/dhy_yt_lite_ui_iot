define(["../../Core/buildModuleUrl","../../Core/Cartesian3","../../Core/Clock","../../Core/defaultValue","../../Core/defined","../../Core/defineProperties","../../Core/destroyObject","../../Core/DeveloperError","../../Core/Ellipsoid","../../Core/FeatureDetection","../../Core/formatError","../../Core/requestAnimationFrame","../../Core/ScreenSpaceEventHandler","../../Scene/createWorldImagery","../../Scene/Globe","../../Scene/Moon","../../Scene/Scene","../../Scene/SceneMode","../../Scene/ShadowMode","../../Scene/SkyAtmosphere","../../Scene/SkyBox","../../Scene/Sun","../getElement"],function(e,t,r,n,i,o,a,s,c,d,h,u,l,p,g,m,v,_,f,w,E,R,C){"use strict";function y(t){return e("Assets/Textures/SkyBox/tycho2t3_80_"+t+".jpg")}function L(e){var t=e._canvas,r=t.clientWidth,i=t.clientHeight,o=e._resolutionScale;e._supportsImageRenderingPixelated||(o*=n(window.devicePixelRatio,1)),e._canvasWidth=r,e._canvasHeight=i,r*=o,i*=o,t.width=r,t.height=i,e._canRender=0!==r&&0!==i}function S(e){var t=e._canvas,r=t.width,n=t.height;if(0!==r&&0!==n){var o=e._scene.camera.frustum;i(o.aspectRatio)?o.aspectRatio=r/n:(o.top=o.right*(n/r),o.bottom=-o.top)}}function P(e,o){if(!i(e))throw new s("container is required.");e=C(e),o=n(o,{});var a=document.createElement("div");a.className="pgEarth-widget",e.appendChild(a);var h=document.createElement("canvas"),u=d.supportsImageRenderingPixelated();this._supportsImageRenderingPixelated=u,u&&(h.style.imageRendering=d.imageRenderingValue()),h.oncontextmenu=function(){return!1},h.onselectstart=function(){return!1},a.appendChild(h);var P=document.createElement("div");P.className="pgEarth-widget-credits";var b=i(o.creditContainer)?C(o.creditContainer):a;b.appendChild(P);var x=i(o.creditViewport)?C(o.creditViewport):a,D=n(o.showRenderLoopErrors,!0);this._element=a,this._container=e,this._canvas=h,this._canvasWidth=0,this._canvasHeight=0,this._creditViewport=x,this._creditContainer=b,this._innerCreditContainer=P,this._canRender=!1,this._renderLoopRunning=!1,this._showRenderLoopErrors=D,this._resolutionScale=1,this._forceResize=!1,this._clock=i(o.clock)?o.clock:new r,L(this);try{var k=new v({canvas:h,contextOptions:o.contextOptions,creditContainer:P,creditViewport:x,mapProjection:o.mapProjection,orderIndependentTranslucency:o.orderIndependentTranslucency,scene3DOnly:n(o.scene3DOnly,!1),terrainExaggeration:o.terrainExaggeration,shadows:o.shadows,mapMode2D:o.mapMode2D,requestRenderMode:o.requestRenderMode,maximumRenderTimeChange:o.maximumRenderTimeChange});this._scene=k,k.camera.constrainedAxis=t.UNIT_Z,S(this);var N=n(k.mapProjection.ellipsoid,c.WGS84),M=o.globe;i(M)||(M=new g(N)),!1!==M&&(k.globe=M,k.globe.shadows=n(o.terrainShadows,f.RECEIVE_ONLY));var z=o.skyBox;i(z)||(z=new E({sources:{positiveX:y("px"),negativeX:y("mx"),positiveY:y("py"),negativeY:y("my"),positiveZ:y("pz"),negativeZ:y("mz")}})),!1!==z&&(k.skyBox=z,k.sun=new R,k.moon=new m);var H=o.skyAtmosphere;i(H)||(H=new w(N)),!1!==H&&(k.skyAtmosphere=H);var T=!1!==o.globe&&o.imageryProvider;i(T)||(T=p()),!1!==T&&k.imageryLayers.addImageryProvider(T),i(o.terrainProvider)&&!1!==o.globe&&(k.terrainProvider=o.terrainProvider),this._screenSpaceEventHandler=new l(h,!1),i(o.sceneMode)&&(o.sceneMode===_.SCENE2D&&this._scene.morphTo2D(0),o.sceneMode===_.COLUMBUS_VIEW&&this._scene.morphToColumbusView(0)),this._useDefaultRenderLoop=void 0,this.useDefaultRenderLoop=n(o.useDefaultRenderLoop,!0),this._targetFrameRate=void 0,this.targetFrameRate=o.targetFrameRate;var V=this;k.renderError.addEventListener(function(e,t){if(V._useDefaultRenderLoop=!1,V._renderLoopRunning=!1,V._showRenderLoopErrors){V.showErrorPanel("An error occurred while rendering.  Rendering has stopped.",void 0,t)}})}catch(e){if(D){this.showErrorPanel("Error constructing PGEarthWidget.",'Visit <a href="http://get.webgl.org">http://get.webgl.org</a> to verify that your web browser and hardware support WebGL.  Consider trying a different web browser or updating your video drivers.  Detailed error information is below:',e)}throw e}}return o(P.prototype,{container:{get:function(){return this._container}},canvas:{get:function(){return this._canvas}},creditContainer:{get:function(){return this._creditContainer}},creditViewport:{get:function(){return this._creditViewport}},scene:{get:function(){return this._scene}},imageryLayers:{get:function(){return this._scene.imageryLayers}},terrainProvider:{get:function(){return this._scene.terrainProvider},set:function(e){this._scene.terrainProvider=e}},camera:{get:function(){return this._scene.camera}},clock:{get:function(){return this._clock}},screenSpaceEventHandler:{get:function(){return this._screenSpaceEventHandler}},targetFrameRate:{get:function(){return this._targetFrameRate},set:function(e){if(e<=0)throw new s("targetFrameRate must be greater than 0, or undefined.");this._targetFrameRate=e}},useDefaultRenderLoop:{get:function(){return this._useDefaultRenderLoop},set:function(e){this._useDefaultRenderLoop!==e&&(this._useDefaultRenderLoop=e,e&&!this._renderLoopRunning&&function(e){e._renderLoopRunning=!0;var t=0;u(function r(n){if(!e.isDestroyed())if(e._useDefaultRenderLoop)try{var o=e._targetFrameRate;if(i(o)){var a=1e3/o,s=n-t;s>a&&(e.resize(),e.render(),t=n-s%a),u(r)}else e.resize(),e.render(),u(r)}catch(t){e._useDefaultRenderLoop=!1,e._renderLoopRunning=!1,e._showRenderLoopErrors&&e.showErrorPanel("An error occurred while rendering.  Rendering has stopped.",void 0,t)}else e._renderLoopRunning=!1})}(this))}},resolutionScale:{get:function(){return this._resolutionScale},set:function(e){if(e<=0)throw new s("resolutionScale must be greater than 0.");this._resolutionScale=e,this._forceResize=!0}}}),P.prototype.showErrorPanel=function(e,t,r){var n=this._element,o=document.createElement("div");o.className="pgEarth-widget-errorPanel";var a=document.createElement("div");a.className="pgEarth-widget-errorPanel-content",o.appendChild(a);var s=document.createElement("div");s.className="pgEarth-widget-errorPanel-header",s.appendChild(document.createTextNode(e)),a.appendChild(s);var c=document.createElement("div");function d(){c.style.maxHeight=Math.max(Math.round(.9*n.clientHeight-100),30)+"px"}if(c.className="pgEarth-widget-errorPanel-scroll",a.appendChild(c),d(),i(window.addEventListener)&&window.addEventListener("resize",d,!1),i(t)){var u=document.createElement("div");u.className="pgEarth-widget-errorPanel-message",u.innerHTML="<p>"+t+"</p>",c.appendChild(u)}var l="(no error details available)";i(r)&&(l=h(r));var p=document.createElement("div");p.className="pgEarth-widget-errorPanel-message",p.appendChild(document.createTextNode(l)),c.appendChild(p);var g=document.createElement("div");g.className="pgEarth-widget-errorPanel-buttonPanel",a.appendChild(g);var m=document.createElement("button");m.setAttribute("type","button"),m.className="pgEarth-button",m.appendChild(document.createTextNode("OK")),m.onclick=function(){i(d)&&i(window.removeEventListener)&&window.removeEventListener("resize",d,!1),n.removeChild(o)},g.appendChild(m),n.appendChild(o),"undefined"!=typeof console&&console.error(e+"\n"+t+"\n"+l)},P.prototype.isDestroyed=function(){return!1},P.prototype.destroy=function(){this._scene=this._scene&&this._scene.destroy(),this._container.removeChild(this._element),this._creditContainer.removeChild(this._innerCreditContainer),a(this)},P.prototype.resize=function(){var e=this._canvas,t=e.clientWidth,r=e.clientHeight;(this._forceResize||this._canvasWidth!==t||this._canvasHeight!==r)&&(this._forceResize=!1,L(this),S(this),this._scene.requestRender())},P.prototype.render=function(){if(this._canRender){this._scene.initializeFrame();var e=this._clock.tick();this._scene.render(e)}else this._clock.tick()},P});