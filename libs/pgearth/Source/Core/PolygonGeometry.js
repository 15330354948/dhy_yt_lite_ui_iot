define(["./ArcType","./arrayFill","./BoundingRectangle","./BoundingSphere","./Cartesian2","./Cartesian3","./Cartographic","./Check","./ComponentDatatype","./defaultValue","./defined","./defineProperties","./DeveloperError","./Ellipsoid","./EllipsoidGeodesic","./EllipsoidRhumbLine","./EllipsoidTangentPlane","./Geometry","./GeometryAttribute","./GeometryInstance","./GeometryOffsetAttribute","./GeometryPipeline","./IndexDatatype","./Math","./Matrix2","./Matrix3","./PolygonGeometryLibrary","./PolygonPipeline","./Quaternion","./Rectangle","./VertexFormat","./WindingOrder"],function(e,t,o,r,i,a,n,s,l,p,c,u,g,h,y,m,d,v,f,_,w,b,T,I,P,A,x,E,O,H,N,D){"use strict";var R=new n,F=new n;function L(e,t,o,r){var i=r.cartesianToCartographic(e,R).height,a=r.cartesianToCartographic(t,F);a.height=i,r.cartographicToCartesian(a,t);var n=r.cartesianToCartographic(o,F);n.height=i-100,r.cartographicToCartesian(n,o)}var G=new o,C=new a,S=new a,B=new a,V=new a,k=new a,M=new a,z=new a,U=new a,Y=new a,W=new i,j=new i,q=new a,Q=new O,K=new A,Z=new A;function J(e){var o=e.vertexFormat,r=e.geometry,n=e.shadowVolume,s=r.attributes.position.values,p=s.length,u=e.wall,g=e.top||u,h=e.bottom||u;if(o.st||o.normal||o.tangent||o.bitangent||n){var y=e.boundingRectangle,m=e.tangentPlane,d=e.ellipsoid,v=e.stRotation,_=e.perPositionHeight,b=W;b.x=y.x,b.y=y.y;var T,P=o.st?new Float32Array(p/3*2):void 0;o.normal&&(T=_&&g&&!u?r.attributes.normal.values:new Float32Array(p));var x=o.tangent?new Float32Array(p):void 0,E=o.bitangent?new Float32Array(p):void 0,H=n?new Float32Array(p):void 0,N=0,D=0,R=S,F=B,G=V,J=!0,X=K,$=Z;if(0!==v){var ee=O.fromAxisAngle(m._plane.normal,v,Q);X=A.fromQuaternion(ee,X),ee=O.fromAxisAngle(m._plane.normal,-v,Q),$=A.fromQuaternion(ee,$)}else X=A.clone(A.IDENTITY,X),$=A.clone(A.IDENTITY,$);var te=0,oe=0;g&&h&&(te=p/2,oe=p/3,p/=2);for(var re=0;re<p;re+=3){var ie=a.fromArray(s,re,q);if(o.st){var ae=A.multiplyByVector(X,ie,C);ae=d.scaleToGeodeticSurface(ae,ae);var ne=m.projectPointOntoPlane(ae,j);i.subtract(ne,b,ne);var se=I.clamp(ne.x/y.width,0,1),le=I.clamp(ne.y/y.height,0,1);h&&(P[N+oe]=se,P[N+1+oe]=le),g&&(P[N]=se,P[N+1]=le),N+=2}if(o.normal||o.tangent||o.bitangent||n){var pe=D+1,ce=D+2;if(u){if(re+3<p){var ue=a.fromArray(s,re+3,k);if(J){var ge=a.fromArray(s,re+p,M);_&&L(ie,ue,ge,d),a.subtract(ue,ie,ue),a.subtract(ge,ie,ge),R=a.normalize(a.cross(ge,ue,R),R),J=!1}a.equalsEpsilon(ue,ie,I.EPSILON10)&&(J=!0)}(o.tangent||o.bitangent)&&(G=d.geodeticSurfaceNormal(ie,G),o.tangent&&(F=a.normalize(a.cross(G,R,F),F)))}else R=d.geodeticSurfaceNormal(ie,R),(o.tangent||o.bitangent)&&(_&&(z=a.fromArray(T,D,z),U=a.cross(a.UNIT_Z,z,U),U=a.normalize(A.multiplyByVector($,U,U),U),o.bitangent&&(Y=a.normalize(a.cross(z,U,Y),Y))),F=a.cross(a.UNIT_Z,R,F),F=a.normalize(A.multiplyByVector($,F,F),F),o.bitangent&&(G=a.normalize(a.cross(R,F,G),G)));o.normal&&(e.wall?(T[D+te]=R.x,T[pe+te]=R.y,T[ce+te]=R.z):h&&(T[D+te]=-R.x,T[pe+te]=-R.y,T[ce+te]=-R.z),(g&&!_||u)&&(T[D]=R.x,T[pe]=R.y,T[ce]=R.z)),n&&(u&&(R=d.geodeticSurfaceNormal(ie,R)),H[D+te]=-R.x,H[pe+te]=-R.y,H[ce+te]=-R.z),o.tangent&&(e.wall?(x[D+te]=F.x,x[pe+te]=F.y,x[ce+te]=F.z):h&&(x[D+te]=-F.x,x[pe+te]=-F.y,x[ce+te]=-F.z),g&&(_?(x[D]=U.x,x[pe]=U.y,x[ce]=U.z):(x[D]=F.x,x[pe]=F.y,x[ce]=F.z))),o.bitangent&&(h&&(E[D+te]=G.x,E[pe+te]=G.y,E[ce+te]=G.z),g&&(_?(E[D]=Y.x,E[pe]=Y.y,E[ce]=Y.z):(E[D]=G.x,E[pe]=G.y,E[ce]=G.z))),D+=3}}o.st&&(r.attributes.st=new f({componentDatatype:l.FLOAT,componentsPerAttribute:2,values:P})),o.normal&&(r.attributes.normal=new f({componentDatatype:l.FLOAT,componentsPerAttribute:3,values:T})),o.tangent&&(r.attributes.tangent=new f({componentDatatype:l.FLOAT,componentsPerAttribute:3,values:x})),o.bitangent&&(r.attributes.bitangent=new f({componentDatatype:l.FLOAT,componentsPerAttribute:3,values:E})),n&&(r.attributes.extrudeDirection=new f({componentDatatype:l.FLOAT,componentsPerAttribute:3,values:H}))}if(e.extrude&&c(e.offsetAttribute)){var he=s.length/3,ye=new Uint8Array(he);if(e.offsetAttribute===w.TOP)g&&h||u?ye=t(ye,1,0,he/2):g&&(ye=t(ye,1));else{var me=e.offsetAttribute===w.NONE?0:1;ye=t(ye,me)}r.attributes.applyOffset=new f({componentDatatype:l.UNSIGNED_BYTE,componentsPerAttribute:1,values:ye})}return r}var X=new n,$=new n,ee={westOverIDL:0,eastOverIDL:0},te=new y;function oe(t,o,r,i,a){if(a=p(a,new H),!c(t)||t.length<3)return a.west=0,a.north=0,a.south=0,a.east=0,a;if(r===e.RHUMB)return H.fromCartesianArray(t,o,a);te.ellipsoid.equals(o)||(te=new y(void 0,void 0,o)),a.west=Number.POSITIVE_INFINITY,a.east=Number.NEGATIVE_INFINITY,a.south=Number.POSITIVE_INFINITY,a.north=Number.NEGATIVE_INFINITY,ee.westOverIDL=Number.POSITIVE_INFINITY,ee.eastOverIDL=Number.NEGATIVE_INFINITY;for(var n,s=1/I.chordLength(i,o.maximumRadius),l=t.length,u=o.cartesianToCartographic(t[0],$),g=X,h=1;h<l;h++)n=g,g=u,u=o.cartesianToCartographic(t[h],n),te.setEndPoints(g,u),ie(te,s,a,ee);return n=g,g=u,u=o.cartesianToCartographic(t[0],n),te.setEndPoints(g,u),ie(te,s,a,ee),a.east-a.west>ee.eastOverIDL-ee.westOverIDL&&(a.west=ee.westOverIDL,a.east=ee.eastOverIDL,a.east>I.PI&&(a.east=a.east-I.TWO_PI),a.west>I.PI&&(a.west=a.west-I.TWO_PI)),a}var re=new n;function ie(e,t,o,r){for(var i=e.surfaceDistance,a=Math.ceil(i*t),n=a>0?i/(a-1):Number.POSITIVE_INFINITY,s=0,l=0;l<a;l++){var p=e.interpolateUsingSurfaceDistance(s,re);s+=n;var c=p.longitude,u=p.latitude;o.west=Math.min(o.west,c),o.east=Math.max(o.east,c),o.south=Math.min(o.south,u),o.north=Math.max(o.north,u);var g=c>=0?c:c+I.TWO_PI;r.westOverIDL=Math.min(r.westOverIDL,g),r.eastOverIDL=Math.max(r.eastOverIDL,g)}}var ae=[];function ne(e,t,o,r,i,a,n,s,l){var p,c={walls:[]};if(a||n){var u,g,h=x.createGeometryFromPositions(e,t,o,i,s,l),y=h.attributes.position.values,m=h.indices;if(a&&n){var v=y.concat(y);u=v.length/3,(g=T.createTypedArray(u,2*m.length)).set(m);var f=m.length,w=u/2;for(p=0;p<f;p+=3){var b=g[p]+w,I=g[p+1]+w,P=g[p+2]+w;g[p+f]=P,g[p+1+f]=I,g[p+2+f]=b}if(h.attributes.position.values=v,i&&s.normal){var A=h.attributes.normal.values;h.attributes.normal.values=new Float32Array(v.length),h.attributes.normal.values.set(A)}h.indices=g}else if(n){for(u=y.length/3,g=T.createTypedArray(u,m.length),p=0;p<m.length;p+=3)g[p]=m[p+2],g[p+1]=m[p+1],g[p+2]=m[p];h.indices=g}c.topAndBottom=new _({geometry:h})}var O=r.outerRing,H=d.fromPoints(O,e),N=H.projectPointsOntoPlane(O,ae),R=E.computeWindingOrder2D(N);R===D.CLOCKWISE&&(O=O.slice().reverse());var F=x.computeWallGeometry(O,e,o,i,l);c.walls.push(new _({geometry:F}));var L=r.holes;for(p=0;p<L.length;p++){var G=L[p];N=(H=d.fromPoints(G,e)).projectPointsOntoPlane(G,ae),(R=E.computeWindingOrder2D(N))===D.COUNTER_CLOCKWISE&&(G=G.slice().reverse()),F=x.computeWallGeometry(G,e,o,i,l),c.walls.push(new _({geometry:F}))}return c}function se(t){if(s.typeOf.object("options",t),s.typeOf.object("options.polygonHierarchy",t.polygonHierarchy),c(t.perPositionHeight)&&t.perPositionHeight&&c(t.height))throw new g("Cannot use both options.perPositionHeight and options.height");if(c(t.arcType)&&t.arcType!==e.GEODESIC&&t.arcType!==e.RHUMB)throw new g("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var o=t.polygonHierarchy,r=p(t.vertexFormat,N.DEFAULT),i=p(t.ellipsoid,h.WGS84),a=p(t.granularity,I.RADIANS_PER_DEGREE),n=p(t.stRotation,0),l=p(t.perPositionHeight,!1),u=l&&c(t.extrudedHeight),y=p(t.height,0),m=p(t.extrudedHeight,y);if(!u){var d=Math.max(y,m);m=Math.min(y,m),y=d}this._vertexFormat=N.clone(r),this._ellipsoid=h.clone(i),this._granularity=a,this._stRotation=n,this._height=y,this._extrudedHeight=m,this._closeTop=p(t.closeTop,!0),this._closeBottom=p(t.closeBottom,!0),this._polygonHierarchy=o,this._perPositionHeight=l,this._perPositionHeightExtrude=u,this._shadowVolume=p(t.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=t.offsetAttribute,this._arcType=p(t.arcType,e.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=x.computeHierarchyPackedLength(o)+h.packedLength+N.packedLength+12}se.fromPositions=function(e){return e=p(e,p.EMPTY_OBJECT),s.defined("options.positions",e.positions),new se({polygonHierarchy:{positions:e.positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},se.pack=function(e,t,o){return s.typeOf.object("value",e),s.defined("array",t),o=p(o,0),o=x.packPolygonHierarchy(e._polygonHierarchy,t,o),h.pack(e._ellipsoid,t,o),o+=h.packedLength,N.pack(e._vertexFormat,t,o),o+=N.packedLength,t[o++]=e._height,t[o++]=e._extrudedHeight,t[o++]=e._granularity,t[o++]=e._stRotation,t[o++]=e._perPositionHeightExtrude?1:0,t[o++]=e._perPositionHeight?1:0,t[o++]=e._closeTop?1:0,t[o++]=e._closeBottom?1:0,t[o++]=e._shadowVolume?1:0,t[o++]=p(e._offsetAttribute,-1),t[o++]=e._arcType,t[o]=e.packedLength,t};var le=h.clone(h.UNIT_SPHERE),pe=new N,ce={polygonHierarchy:{}};return se.unpack=function(e,t,o){s.defined("array",e),t=p(t,0);var r=x.unpackPolygonHierarchy(e,t);t=r.startingIndex,delete r.startingIndex;var i=h.unpack(e,t,le);t+=h.packedLength;var a=N.unpack(e,t,pe);t+=N.packedLength;var n=e[t++],l=e[t++],u=e[t++],g=e[t++],y=1===e[t++],m=1===e[t++],d=1===e[t++],v=1===e[t++],f=1===e[t++],_=e[t++],w=e[t++],b=e[t];return c(o)||(o=new se(ce)),o._polygonHierarchy=r,o._ellipsoid=h.clone(i,o._ellipsoid),o._vertexFormat=N.clone(a,o._vertexFormat),o._height=n,o._extrudedHeight=l,o._granularity=u,o._stRotation=g,o._perPositionHeightExtrude=y,o._perPositionHeight=m,o._closeTop=d,o._closeBottom=v,o._shadowVolume=f,o._offsetAttribute=-1===_?void 0:_,o._arcType=w,o.packedLength=b,o},se.computeRectangle=function(t,o){s.typeOf.object("options",t),s.typeOf.object("options.polygonHierarchy",t.polygonHierarchy);var r=p(t.granularity,I.RADIANS_PER_DEGREE),i=p(t.arcType,e.GEODESIC);if(i!==e.GEODESIC&&i!==e.RHUMB)throw new g("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var a=t.polygonHierarchy,n=p(t.ellipsoid,h.WGS84);return oe(a.positions,n,i,r,o)},se.createGeometry=function(e){var o=e._vertexFormat,i=e._ellipsoid,a=e._granularity,n=e._stRotation,s=e._polygonHierarchy,p=e._perPositionHeight,u=e._closeTop,g=e._closeBottom,h=e._arcType,y=s.positions;if(!(y.length<3)){var m=d.fromPoints(y,i),P=x.polygonsFromHierarchy(s,m.projectPointsOntoPlane.bind(m),!p,i),A=P.hierarchy,O=P.polygons;if(0!==A.length){y=A[0].outerRing;var H,N=x.computeBoundingRectangle(m.plane.normal,m.projectPointOntoPlane.bind(m),y,n,G),D=[],R=e._height,F=e._extrudedHeight,L={perPositionHeight:p,vertexFormat:o,geometry:void 0,tangentPlane:m,boundingRectangle:N,ellipsoid:i,stRotation:n,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:h};if(e._perPositionHeightExtrude||!I.equalsEpsilon(R,F,0,I.EPSILON2))for(L.extrude=!0,L.top=u,L.bottom=g,L.shadowVolume=e._shadowVolume,L.offsetAttribute=e._offsetAttribute,H=0;H<O.length;H++){var C,S=ne(i,O[H],a,A[H],p,u,g,o,h);u&&g?(C=S.topAndBottom,L.geometry=x.scaleToGeodeticHeightExtruded(C.geometry,R,F,i,p)):u?((C=S.topAndBottom).geometry.attributes.position.values=E.scaleToGeodeticHeight(C.geometry.attributes.position.values,R,i,!p),L.geometry=C.geometry):g&&((C=S.topAndBottom).geometry.attributes.position.values=E.scaleToGeodeticHeight(C.geometry.attributes.position.values,F,i,!0),L.geometry=C.geometry),(u||g)&&(L.wall=!1,C.geometry=J(L),D.push(C));var B=S.walls;L.wall=!0;for(var V=0;V<B.length;V++){var k=B[V];L.geometry=x.scaleToGeodeticHeightExtruded(k.geometry,R,F,i,p),k.geometry=J(L),D.push(k)}}else for(H=0;H<O.length;H++){var M=new _({geometry:x.createGeometryFromPositions(i,O[H],a,p,o,h)});if(M.geometry.attributes.position.values=E.scaleToGeodeticHeight(M.geometry.attributes.position.values,R,i,!p),L.geometry=M.geometry,M.geometry=J(L),c(e._offsetAttribute)){var z=M.geometry.attributes.position.values.length,U=new Uint8Array(z/3),Y=e._offsetAttribute===w.NONE?0:1;t(U,Y),M.geometry.attributes.applyOffset=new f({componentDatatype:l.UNSIGNED_BYTE,componentsPerAttribute:1,values:U})}D.push(M)}var W=b.combineInstances(D)[0];W.attributes.position.values=new Float64Array(W.attributes.position.values),W.indices=T.createTypedArray(W.attributes.position.values.length/3,W.indices);var j=W.attributes,q=r.fromVertices(j.position.values);return o.position||delete j.position,new v({attributes:j,indices:W.indices,primitiveType:W.primitiveType,boundingSphere:q,offsetAttribute:e._offsetAttribute})}}},se.createShadowVolume=function(e,t,o){var r=e._granularity,i=e._ellipsoid,a=t(r,i),n=o(r,i);return new se({polygonHierarchy:e._polygonHierarchy,ellipsoid:i,stRotation:e._stRotation,granularity:r,perPositionHeight:!1,extrudedHeight:a,height:n,vertexFormat:N.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},u(se.prototype,{rectangle:{get:function(){if(!c(this._rectangle)){var e=this._polygonHierarchy.positions;this._rectangle=oe(e,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return c(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];var o=e._ellipsoid,r=e._polygonHierarchy.positions,i=e.rectangle;return v._textureCoordinateRotationPoints(r,t,o,i)}(this)),this._textureCoordinateRotationPoints}}}),se});