define(["../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Event","../Core/Math","../Core/Rectangle","../ThirdParty/when","./ImageryLayer"],function(e,r,t,o,i,n,a,s,l,h){"use strict";function y(){this._layers=[],this.layerAdded=new n,this.layerRemoved=new n,this.layerMoved=new n,this.layerShownOrHidden=new n}function u(e,t){if(!r(t))throw new i("layer is required.");var o=e.indexOf(t);if(-1===o)throw new i("layer is not in this collection.");return o}function p(e,r,t){var o=e._layers;if((r=a.clamp(r,0,o.length-1))!==(t=a.clamp(t,0,o.length-1))){var i=o[r];o[r]=o[t],o[t]=i,e._update(),e.layerMoved.raiseEvent(i,t,r)}}t(y.prototype,{length:{get:function(){return this._layers.length}}}),y.prototype.add=function(e,t){var o=r(t);if(!r(e))throw new i("layer is required.");if(o){if(t<0)throw new i("index must be greater than or equal to zero.");if(t>this._layers.length)throw new i("index must be less than or equal to the number of layers.")}o?this._layers.splice(t,0,e):(t=this._layers.length,this._layers.push(e)),this._update(),this.layerAdded.raiseEvent(e,t)},y.prototype.addImageryProvider=function(e,t){if(!r(e))throw new i("imageryProvider is required.");var o=new h(e);return this.add(o,t),o},y.prototype.remove=function(r,t){t=e(t,!0);var o=this._layers.indexOf(r);return-1!==o&&(this._layers.splice(o,1),this._update(),this.layerRemoved.raiseEvent(r,o),t&&r.destroy(),!0)},y.prototype.removeAll=function(r){r=e(r,!0);for(var t=this._layers,o=0,i=t.length;o<i;o++){var n=t[o];this.layerRemoved.raiseEvent(n,o),r&&n.destroy()}this._layers=[]},y.prototype.contains=function(e){return-1!==this.indexOf(e)},y.prototype.indexOf=function(e){return this._layers.indexOf(e)},y.prototype.get=function(e){if(!r(e))throw new i("index is required.","index");return this._layers[e]},y.prototype.raise=function(e){var r=u(this._layers,e);p(this,r,r+1)},y.prototype.lower=function(e){var r=u(this._layers,e);p(this,r,r-1)},y.prototype.raiseToTop=function(e){var r=u(this._layers,e);r!==this._layers.length-1&&(this._layers.splice(r,1),this._layers.push(e),this._update(),this.layerMoved.raiseEvent(e,this._layers.length-1,r))},y.prototype.lowerToBottom=function(e){var r=u(this._layers,e);0!==r&&(this._layers.splice(r,1),this._layers.splice(0,0,e),this._update(),this.layerMoved.raiseEvent(e,0,r))};var d=new s;return y.prototype.pickImageryLayerFeatures=function(e,t){var o=t.globe.pick(e,t);if(r(o)){for(var i,n=t.globe.ellipsoid.cartesianToCartographic(o),h=t.globe._surface._tilesToRender,y=0;!r(i)&&y<h.length;++y){var u=h[y];s.contains(u.rectangle,n)&&(i=u)}if(r(i)){for(var p=i.data.imagery,c=[],f=[],g=p.length-1;g>=0;--g){var v=p[g],_=v.readyImagery;if(r(_)){var w=_.imageryLayer.imageryProvider;if(r(w.pickFeatures)&&s.contains(_.rectangle,n)){var m=d;if(m.west=a.lerp(i.rectangle.west,i.rectangle.east,v.textureCoordinateRectangle.x-1/1024),m.east=a.lerp(i.rectangle.west,i.rectangle.east,v.textureCoordinateRectangle.z+1/1024),m.south=a.lerp(i.rectangle.south,i.rectangle.north,v.textureCoordinateRectangle.y-1/1024),m.north=a.lerp(i.rectangle.south,i.rectangle.north,v.textureCoordinateRectangle.w+1/1024),s.contains(m,n)){var x=w.pickFeatures(_.x,_.y,_.level,n.longitude,n.latitude);r(x)&&(c.push(x),f.push(_.imageryLayer))}}}}if(0!==c.length)return l.all(c,function(e){for(var t=[],o=0;o<e.length;++o){var i=e[o],a=f[o];if(r(i)&&i.length>0)for(var s=0;s<i.length;++s){var l=i[s];l.imageryLayer=a,r(l.position)||(l.position=n),t.push(l)}}return t})}}},y.prototype.queueReprojectionCommands=function(e){for(var r=this._layers,t=0,o=r.length;t<o;++t)r[t].queueReprojectionCommands(e)},y.prototype.cancelReprojections=function(){for(var e=this._layers,r=0,t=e.length;r<t;++r)e[r].cancelReprojections()},y.prototype.isDestroyed=function(){return!1},y.prototype.destroy=function(){return this.removeAll(!0),o(this)},y.prototype._update=function(){var e,t,o,i,n=!0,a=this._layers;for(o=0,i=a.length;o<i;++o)(t=a[o])._layerIndex=o,t.show?(t._isBaseLayer=n,n=!1):t._isBaseLayer=!1,t.show!==t._show&&(r(t._show)&&(r(e)||(e=[]),e.push(t)),t._show=t.show);if(r(e))for(o=0,i=e.length;o<i;++o)t=e[o],this.layerShownOrHidden.raiseEvent(t,t._layerIndex,t.show)},y});