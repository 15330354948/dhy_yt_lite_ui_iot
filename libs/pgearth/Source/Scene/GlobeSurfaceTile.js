define(["../Core/BoundingSphere","../Core/Cartesian3","../Core/Cartesian4","../Core/defined","../Core/defineProperties","../Core/IndexDatatype","../Core/IntersectionTests","../Core/OrientedBoundingBox","../Core/PixelFormat","../Core/Request","../Core/RequestState","../Core/RequestType","../Core/TileProviderError","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/PixelDatatype","../Renderer/Sampler","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","../Renderer/VertexArray","./ImageryState","./QuadtreeTileLoadState","./SceneMode","./TerrainState","./TileBoundingRegion","../ThirdParty/when"],function(e,r,t,a,i,n,o,s,d,l,u,c,f,h,v,y,p,g,x,D,E,S,A,T,m,I,C,w){"use strict";function R(){this.imagery=[],this.waterMaskTexture=void 0,this.waterMaskTranslationAndScale=new t(0,0,1,1),this.terrainData=void 0,this.vertexArray=void 0,this.orientedBoundingBox=void 0,this.boundingVolumeSourceTile=void 0,this.tileBoundingRegion=void 0,this.occludeePointInScaledSpace=new r,this.terrainState=I.UNLOADED,this.mesh=void 0,this.fill=void 0,this.pickBoundingSphere=new e,this.surfaceShader=void 0,this.isClipped=!0,this.clippedByBoundaries=!1}function M(e,t,i,n,o,s){if(e.decodePosition(n,o,s),a(t)&&t!==m.SCENE3D){var d=i.ellipsoid.cartesianToCartographic(s);i.project(d,s),r.fromElements(s.z,s.x,s.y,s)}return s}i(R.prototype,{eligibleForUnloading:{get:function(){for(var e=this.terrainState,r=!(e===I.RECEIVING||e===I.TRANSFORMING),t=this.imagery,i=0,n=t.length;r&&i<n;++i){var o=t[i];r=!a(o.loadingImagery)||o.loadingImagery.state!==A.TRANSITIONING}return r}},renderedMesh:{get:function(){return a(this.vertexArray)?this.mesh:a(this.fill)?this.fill.mesh:void 0}}});var N=new r,B=new r,L=new r,k=new r;return R.prototype.pick=function(e,t,i,n,s){var d=this.renderedMesh;if(a(d))for(var l=d.vertices,u=d.indices,c=d.encoding,f=u.length,h=0;h<f;h+=3){var v=u[h],y=u[h+1],p=u[h+2],g=M(c,t,i,l,v,N),x=M(c,t,i,l,y,B),D=M(c,t,i,l,p,L),E=o.rayTriangle(e,g,x,D,n,k);if(a(E))return r.clone(E,s)}},R.prototype.freeResources=function(){a(this.waterMaskTexture)&&(--this.waterMaskTexture.referenceCount,0===this.waterMaskTexture.referenceCount&&this.waterMaskTexture.destroy(),this.waterMaskTexture=void 0),this.terrainData=void 0,this.terrainState=I.UNLOADED,this.mesh=void 0,this.fill=this.fill&&this.fill.destroy();for(var e=this.imagery,r=0,t=e.length;r<t;++r)e[r].freeResources();this.imagery.length=0,this.freeVertexArray()},R.prototype.freeVertexArray=function(){R._freeVertexArray(this.vertexArray),this.vertexArray=void 0,R._freeVertexArray(this.wireframeVertexArray),this.wireframeVertexArray=void 0},R.initialize=function(e,r,t){var i=e.data;a(i)||(i=e.data=new R),e.state===T.START&&(!function(e,r,t){var i=r.getTileDataAvailable(e.x,e.y,e.level);if(!a(i)&&a(e.parent)){var n=e.parent,o=n.data;a(o)&&a(o.terrainData)&&(i=o.terrainData.isChildAvailable(n.x,n.y,e.x,e.y))}!1===i&&(e.data.terrainState=I.FAILED);for(var s=0,d=t.length;s<d;++s){var l=t.get(s);l.show&&l._createTileImagerySkeletons(e,r)}}(e,r,t),e.state=T.LOADING)},R.processStateMachine=function(e,i,n,o,h,v){R.initialize(e,n,o);var S=e.data;if(e.state===T.LOADING&&function(e,i,n,o,h){var v=e.data,S=e.parent;if(v.terrainState===I.FAILED&&void 0!==S){var A=void 0!==S.data&&void 0!==S.data.terrainData&&!1!==S.data.terrainData.canUpsample;A||R.processStateMachine(S,i,n,o,!0)}v.terrainState===I.FAILED&&function(e,r,t,i,n,o,s){var d=r.parent;if(!d)return void(r.state=T.FAILED);var l=d.data.terrainData,u=d.x,c=d.y,f=d.level;if(!a(l))return;var h=l.upsample(i.tilingScheme,u,c,f,n,o,s);if(!a(h))return;e.terrainState=I.RECEIVING,w(h,function(r){e.terrainData=r,e.terrainState=I.RECEIVED},function(){e.terrainState=I.FAILED})}(v,e,0,n,e.x,e.y,e.level);v.terrainState===I.UNLOADED&&function(e,r,t,i,n){function o(r){e.terrainData=r,e.terrainState=I.RECEIVED,e.request=void 0}function s(){if(e.request.state===u.CANCELLED)return e.terrainData=void 0,e.terrainState=I.UNLOADED,void(e.request=void 0);e.terrainState=I.FAILED,e.request=void 0;var a="Failed to obtain terrain tile X: "+t+" Y: "+i+" Level: "+n+".";r._requestError=f.handleError(r._requestError,r,r.errorEvent,a,t,i,n,d)}function d(){var d=new l({throttle:!1,throttleByServer:!0,type:c.TERRAIN});e.request=d;var u=r.requestTileGeometry(t,i,n,d);a(u)?(e.terrainState=I.RECEIVING,w(u,o,s)):(e.terrainState=I.UNLOADED,e.request=void 0)}d()}(v,n,e.x,e.y,e.level);v.terrainState===I.RECEIVED&&function(e,t,i,n,o,d){var l=i.tilingScheme,u=e.terrainData.createMesh(l,n,o,d,t.terrainExaggeration);if(!a(u))return;e.terrainState=I.TRANSFORMING,w(u,function(t){e.mesh=t,e.orientedBoundingBox=s.clone(t.orientedBoundingBox,e.orientedBoundingBox),e.occludeePointInScaledSpace=r.clone(t.occludeePointInScaledSpace,e.occludeePointInScaledSpace),e.terrainState=I.TRANSFORMED},function(){e.terrainState=I.FAILED})}(v,i,n,e.x,e.y,e.level);v.terrainState===I.TRANSFORMED&&function(e,r,t,a,i,n,o){e.vertexArray=R._createVertexArrayForMesh(r,e.mesh),e.terrainState=I.READY,e.fill=e.fill&&e.fill.destroy(o)}(v,i.context,0,e.x,e.y,e.level,h);if(v.terrainState>=I.RECEIVED&&void 0===v.waterMaskTexture&&n.hasWaterMask){var m=v.terrainData;if(void 0!==m.waterMask)!function(e,r){var i,n=r.terrainData.waterMask,o=function(e){var r=e.cache.tile_waterMaskData;if(!a(r)){var t=g.create({context:e,pixelFormat:d.LUMINANCE,pixelDatatype:y.UNSIGNED_BYTE,source:{arrayBufferView:new Uint8Array([255]),width:1,height:1}});t.referenceCount=1;var i=new p({wrapS:E.CLAMP_TO_EDGE,wrapT:E.CLAMP_TO_EDGE,minificationFilter:D.LINEAR,magnificationFilter:x.LINEAR});r={allWaterTexture:t,sampler:i,destroy:function(){this.allWaterTexture.destroy()}},e.cache.tile_waterMaskData=r}return r}(e),s=n.length;if(1===s){if(0===n[0])return;i=o.allWaterTexture}else{var l=Math.sqrt(s);(i=g.create({context:e,pixelFormat:d.LUMINANCE,pixelDatatype:y.UNSIGNED_BYTE,source:{width:l,height:l,arrayBufferView:n},sampler:o.sampler,flipY:!1})).referenceCount=0}++i.referenceCount,r.waterMaskTexture=i,t.fromElements(0,0,1,1,r.waterMaskTranslationAndScale)}(i.context,v);else{var C=v._findAncestorTileWithTerrainData(e);a(C)&&a(C.data.waterMaskTexture)&&(v.waterMaskTexture=C.data.waterMaskTexture,++v.waterMaskTexture.referenceCount,v._computeWaterMaskTranslationAndScale(e,C,v.waterMaskTranslationAndScale))}}}(e,i,n,o,h),!v){var A=e.renderable;e.renderable=a(S.vertexArray);var m=S.terrainState===I.READY;e.upsampledFromParent=a(S.terrainData)&&S.terrainData.wasCreatedByUpsampling();var C=S.processImagery(e,n,i);if(m&&C){var M=e._loadedCallbacks,N={};for(var B in M)M.hasOwnProperty(B)&&(M[B](e)||(N[B]=M[B]));e._loadedCallbacks=N,e.state=T.DONE}A&&(e.renderable=!0)}},R.prototype.processImagery=function(e,r,t,i){var n,o,s=e.data,d=e.upsampledFromParent,l=e.renderable,u=!0,c=s.imagery;for(n=0,o=c.length;n<o;++n){var f=c[n];if(a(f.loadingImagery)){if(f.loadingImagery.state===A.PLACEHOLDER){var h=f.loadingImagery.imageryLayer;if(h.imageryProvider.ready){f.freeResources(),c.splice(n,1),h._createTileImagerySkeletons(e,r,n),--n,o=c.length;continue}d=!1}var v=f.processStateMachine(e,t,i);u=u&&v,l=l&&(v||a(f.readyImagery)),d=d&&a(f.loadingImagery)&&(f.loadingImagery.state===A.FAILED||f.loadingImagery.state===A.INVALID)}else d=!1}return e.upsampledFromParent=d,e.renderable=l,u},R._createVertexArrayForMesh=function(e,r){var t=r.vertices,i=h.createVertexBuffer({context:e,typedArray:t,usage:v.STATIC_DRAW}),o=r.encoding.getAttributes(i),s=r.indices.indexBuffers||{},d=s[e.id];if(!a(d)||d.isDestroyed()){var l=r.indices;(d=h.createIndexBuffer({context:e,typedArray:l,usage:v.STATIC_DRAW,indexDatatype:n.fromSizeInBytes(l.BYTES_PER_ELEMENT)})).vertexArrayDestroyable=!1,d.referenceCount=1,s[e.id]=d,r.indices.indexBuffers=s}else++d.referenceCount;return new S({context:e,attributes:o,indexBuffer:d})},R._freeVertexArray=function(e){if(a(e)){var r=e.indexBuffer;e.destroy(),a(r)&&!r.isDestroyed()&&a(r.referenceCount)&&(--r.referenceCount,0===r.referenceCount&&r.destroy())}},R.prototype._findAncestorTileWithTerrainData=function(e){for(var r=e.parent;a(r)&&(!a(r.data)||!a(r.data.terrainData)||r.data.terrainData.wasCreatedByUpsampling());)r=r.parent;return r},R.prototype._computeWaterMaskTranslationAndScale=function(e,r,t){var a=r.rectangle,i=e.rectangle,n=i.width,o=i.height,s=n/a.width,d=o/a.height;return t.x=s*(i.west-a.west)/n,t.y=d*(i.south-a.south)/o,t.z=s,t.w=d,t},R});