define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/Color","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/DistanceDisplayCondition","../Core/Matrix4","../Core/NearFarScalar","../Core/Resource","./HeightReference","./HorizontalOrigin","./SceneMode","./SceneTransforms","./VerticalOrigin"],function(i,e,t,s,n,a,o,r,h,c,l,_,u,d,f,g,p,m,D,v){"use strict";function I(i,s){if(i=r(i,r.EMPTY_OBJECT),h(i.disableDepthTestDistance)&&i.disableDepthTestDistance<0)throw new l("disableDepthTestDistance must be greater than or equal to 0.0.");var n=i.translucencyByDistance,c=i.pixelOffsetScaleByDistance,u=i.scaleByDistance,f=i.distanceDisplayCondition;if(h(n)){if(n.far<=n.near)throw new l("translucencyByDistance.far must be greater than translucencyByDistance.near.");n=d.clone(n)}if(h(c)){if(c.far<=c.near)throw new l("pixelOffsetScaleByDistance.far must be greater than pixelOffsetScaleByDistance.near.");c=d.clone(c)}if(h(u)){if(u.far<=u.near)throw new l("scaleByDistance.far must be greater than scaleByDistance.near.");u=d.clone(u)}if(h(f)){if(f.far<=f.near)throw new l("distanceDisplayCondition.far must be greater than distanceDisplayCondition.near.");f=_.clone(f)}this._show=r(i.show,!0),this._position=t.clone(r(i.position,t.ZERO)),this._actualPosition=t.clone(this._position),this._pixelOffset=e.clone(r(i.pixelOffset,e.ZERO)),this._translate=new e(0,0),this._eyeOffset=t.clone(r(i.eyeOffset,t.ZERO)),this._heightReference=r(i.heightReference,g.NONE),this._verticalOrigin=r(i.verticalOrigin,v.CENTER),this._horizontalOrigin=r(i.horizontalOrigin,p.CENTER),this._scale=r(i.scale,1),this._color=a.clone(r(i.color,a.WHITE)),this._rotation=r(i.rotation,0),this._alignedAxis=t.clone(r(i.alignedAxis,t.ZERO)),this._width=i.width,this._height=i.height,this._scaleByDistance=u,this._translucencyByDistance=n,this._pixelOffsetScaleByDistance=c,this._sizeInMeters=r(i.sizeInMeters,!1),this._distanceDisplayCondition=f,this._disableDepthTestDistance=i.disableDepthTestDistance,this._id=i.id,this._collection=r(i.collection,s),this._pickId=void 0,this._pickPrimitive=r(i._pickPrimitive,this),this._billboardCollection=s,this._dirty=!1,this._index=-1,this._batchIndex=void 0,this._imageIndex=-1,this._imageIndexPromise=void 0,this._imageId=void 0,this._image=void 0,this._imageSubRegion=void 0,this._imageWidth=void 0,this._imageHeight=void 0,this._labelDimensions=void 0,this._labelHorizontalOrigin=void 0,this._labelTranslate=void 0;var D=i.image,I=i.imageId;h(D)&&(h(I)||(I="string"==typeof D?D:h(D.src)?D.src:o()),this._imageId=I,this._image=D),h(i.imageSubRegion)&&(this._imageId=I,this._imageSubRegion=i.imageSubRegion),h(this._billboardCollection._textureAtlas)&&this._loadImage(),this._actualClampedPosition=void 0,this._removeCallbackFunc=void 0,this._mode=m.SCENE3D,this._clusterShow=!0,this._updateClamping()}var C=I.SHOW_INDEX=0,w=I.POSITION_INDEX=1,y=I.PIXEL_OFFSET_INDEX=2,O=I.EYE_OFFSET_INDEX=3,b=I.HORIZONTAL_ORIGIN_INDEX=4,E=I.VERTICAL_ORIGIN_INDEX=5,S=I.SCALE_INDEX=6,T=I.IMAGE_INDEX_INDEX=7,N=I.COLOR_INDEX=8,R=I.ROTATION_INDEX=9,P=I.ALIGNED_AXIS_INDEX=10,x=I.SCALE_BY_DISTANCE_INDEX=11,B=I.TRANSLUCENCY_BY_DISTANCE_INDEX=12,q=I.PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX=13,A=I.DISTANCE_DISPLAY_CONDITION=14,k=I.DISABLE_DEPTH_DISTANCE=15;function X(i,e){var t=i._billboardCollection;h(t)&&(t._updateBillboard(i,e),i._dirty=!0)}I.TEXTURE_COORDINATE_BOUNDS=16,I.NUMBER_OF_PROPERTIES=17,c(I.prototype,{show:{get:function(){return this._show},set:function(i){if(!h(i))throw new l("value is required.");this._show!==i&&(this._show=i,X(this,C))}},position:{get:function(){return this._position},set:function(i){if(!h(i))throw new l("value is required.");var e=this._position;t.equals(e,i)||(t.clone(i,e),t.clone(i,this._actualPosition),this._updateClamping(),X(this,w))}},heightReference:{get:function(){return this._heightReference},set:function(i){if(!h(i))throw new l("value is required.");i!==this._heightReference&&(this._heightReference=i,this._updateClamping(),X(this,w))}},pixelOffset:{get:function(){return this._pixelOffset},set:function(i){if(!h(i))throw new l("value is required.");var t=this._pixelOffset;e.equals(t,i)||(e.clone(i,t),X(this,y))}},scaleByDistance:{get:function(){return this._scaleByDistance},set:function(i){if(h(i)&&i.far<=i.near)throw new l("far distance must be greater than near distance.");var e=this._scaleByDistance;d.equals(e,i)||(this._scaleByDistance=d.clone(i,e),X(this,x))}},translucencyByDistance:{get:function(){return this._translucencyByDistance},set:function(i){if(h(i)&&i.far<=i.near)throw new l("far distance must be greater than near distance.");var e=this._translucencyByDistance;d.equals(e,i)||(this._translucencyByDistance=d.clone(i,e),X(this,B))}},pixelOffsetScaleByDistance:{get:function(){return this._pixelOffsetScaleByDistance},set:function(i){if(h(i)&&i.far<=i.near)throw new l("far distance must be greater than near distance.");var e=this._pixelOffsetScaleByDistance;d.equals(e,i)||(this._pixelOffsetScaleByDistance=d.clone(i,e),X(this,q))}},eyeOffset:{get:function(){return this._eyeOffset},set:function(i){if(!h(i))throw new l("value is required.");var e=this._eyeOffset;t.equals(e,i)||(t.clone(i,e),X(this,O))}},horizontalOrigin:{get:function(){return this._horizontalOrigin},set:function(i){if(!h(i))throw new l("value is required.");this._horizontalOrigin!==i&&(this._horizontalOrigin=i,X(this,b))}},verticalOrigin:{get:function(){return this._verticalOrigin},set:function(i){if(!h(i))throw new l("value is required.");this._verticalOrigin!==i&&(this._verticalOrigin=i,X(this,E))}},scale:{get:function(){return this._scale},set:function(i){if(!h(i))throw new l("value is required.");this._scale!==i&&(this._scale=i,X(this,S))}},color:{get:function(){return this._color},set:function(i){if(!h(i))throw new l("value is required.");var e=this._color;a.equals(e,i)||(a.clone(i,e),X(this,N))}},rotation:{get:function(){return this._rotation},set:function(i){if(!h(i))throw new l("value is required.");this._rotation!==i&&(this._rotation=i,X(this,R))}},alignedAxis:{get:function(){return this._alignedAxis},set:function(i){if(!h(i))throw new l("value is required.");var e=this._alignedAxis;t.equals(e,i)||(t.clone(i,e),X(this,P))}},width:{get:function(){return r(this._width,this._imageWidth)},set:function(i){this._width!==i&&(this._width=i,X(this,T))}},height:{get:function(){return r(this._height,this._imageHeight)},set:function(i){this._height!==i&&(this._height=i,X(this,T))}},sizeInMeters:{get:function(){return this._sizeInMeters},set:function(i){this._sizeInMeters!==i&&(this._sizeInMeters=i,X(this,N))}},distanceDisplayCondition:{get:function(){return this._distanceDisplayCondition},set:function(i){if(!_.equals(i,this._distanceDisplayCondition)){if(h(i)&&i.far<=i.near)throw new l("far distance must be greater than near distance.");this._distanceDisplayCondition=_.clone(i,this._distanceDisplayCondition),X(this,A)}}},disableDepthTestDistance:{get:function(){return this._disableDepthTestDistance},set:function(i){if(this._disableDepthTestDistance!==i){if(h(i)&&i<0)throw new l("disableDepthTestDistance must be greater than or equal to 0.0.");this._disableDepthTestDistance=i,X(this,k)}}},id:{get:function(){return this._id},set:function(i){this._id=i,h(this._pickId)&&(this._pickId.object.id=i)}},pickPrimitive:{get:function(){return this._pickPrimitive},set:function(i){this._pickPrimitive=i,h(this._pickId)&&(this._pickId.object.primitive=i)}},pickId:{get:function(){return this._pickId}},image:{get:function(){return this._imageId},set:function(i){h(i)?"string"==typeof i?this.setImage(i,i):i instanceof f?this.setImage(i.url,i):h(i.src)?this.setImage(i.src,i):this.setImage(o(),i):(this._imageIndex=-1,this._imageSubRegion=void 0,this._imageId=void 0,this._image=void 0,this._imageIndexPromise=void 0,X(this,T))}},ready:{get:function(){return-1!==this._imageIndex}},_clampedPosition:{get:function(){return this._actualClampedPosition},set:function(i){this._actualClampedPosition=t.clone(i,this._actualClampedPosition),X(this,w)}},clusterShow:{get:function(){return this._clusterShow},set:function(i){this._clusterShow!==i&&(this._clusterShow=i,X(this,C))}}}),I.prototype.getPickId=function(i){return h(this._pickId)||(this._pickId=i.createPickId({primitive:this._pickPrimitive,collection:this._collection,id:this._id})),this._pickId},I.prototype._updateClamping=function(){I._updateClamping(this._billboardCollection,this)};var z=new n,F=new t;I._updateClamping=function(i,e){var s=i._scene;if(h(s)&&h(s.globe)){var a=s.globe,o=a.ellipsoid,r=a._surface,c=s.frameState.mode,_=c!==e._mode;if(e._mode=c,(e._heightReference===g.NONE||_)&&h(e._removeCallbackFunc)&&(e._removeCallbackFunc(),e._removeCallbackFunc=void 0,e._clampedPosition=void 0),e._heightReference!==g.NONE&&h(e._position)){var u=o.cartesianToCartographic(e._position);if(h(u)){h(e._removeCallbackFunc)&&e._removeCallbackFunc(),e._removeCallbackFunc=r.updateHeight(u,f),n.clone(u,z);var d=a.getHeight(u);h(d)&&(z.height=d),o.cartographicToCartesian(z,F),f(F)}else e._actualClampedPosition=void 0}}else if(e._heightReference!==g.NONE)throw new l("Height reference is not supported without a scene and globe.");function f(i){if(e._heightReference===g.RELATIVE_TO_GROUND)if(e._mode===m.SCENE3D){var s=o.cartesianToCartographic(i,z);s.height+=u.height,o.cartographicToCartesian(s,i)}else i.x+=u.height;e._clampedPosition=t.clone(i,e._clampedPosition)}},I.prototype._loadImage=function(){var e,t=this._billboardCollection._textureAtlas,s=this._imageId,n=this._image,a=this._imageSubRegion;if(h(n)&&(e=t.addImage(s,n)),h(a)&&(e=t.addSubRegion(s,a)),this._imageIndexPromise=e,h(e)){var o=this;e.then(function(e){if(o._imageId===s&&o._image===n&&i.equals(o._imageSubRegion,a)){var r=t.textureCoordinates[e];o._imageWidth=t.texture.width*r.width,o._imageHeight=t.texture.height*r.height,o._imageIndex=e,o._ready=!0,o._image=void 0,o._imageIndexPromise=void 0,X(o,T)}}).otherwise(function(i){console.error("Error loading image for billboard: "+i),o._imageIndexPromise=void 0})}},I.prototype.setImage=function(i,e){if(!h(i))throw new l("id is required.");if(!h(e))throw new l("image is required.");this._imageId!==i&&(this._imageIndex=-1,this._imageSubRegion=void 0,this._imageId=i,this._image=e,h(this._billboardCollection._textureAtlas)&&this._loadImage())},I.prototype.setImageSubRegion=function(e,t){if(!h(e))throw new l("id is required.");if(!h(t))throw new l("subRegion is required.");this._imageId===e&&i.equals(this._imageSubRegion,t)||(this._imageIndex=-1,this._imageId=e,this._imageSubRegion=i.clone(t),h(this._billboardCollection._textureAtlas)&&this._loadImage())},I.prototype._setTranslate=function(i){if(!h(i))throw new l("value is required.");var t=this._translate;e.equals(t,i)||(e.clone(i,t),X(this,y))},I.prototype._getActualPosition=function(){return h(this._clampedPosition)?this._clampedPosition:this._actualPosition},I.prototype._setActualPosition=function(i){h(this._clampedPosition)||t.clone(i,this._actualPosition),X(this,w)};var H=new s;I._computeActualPosition=function(i,e,t,s){return h(i._clampedPosition)?(t.mode!==i._mode&&i._updateClamping(),i._clampedPosition):t.mode===m.SCENE3D?e:(u.multiplyByPoint(s,e,H),D.computeActualWgs84Position(t,H))};var L=new t;I._computeScreenSpacePosition=function(i,t,s,n,a,o){var r=u.multiplyByPoint(i,t,L),c=D.wgs84WithEyeOffsetToWindowCoordinates(a,r,s,o);if(h(c))return e.add(c,n,c),c};var M=new e(0,0);return I.prototype.computeScreenSpacePosition=function(i,t){var s=this._billboardCollection;if(h(t)||(t=new e),!h(s))throw new l("Billboard must be in a collection.  Was it removed?");if(!h(i))throw new l("scene is required.");e.clone(this._pixelOffset,M),e.add(M,this._translate,M);var n=s.modelMatrix,a=this._position;if(h(this._clampedPosition)&&(a=this._clampedPosition,i.mode!==m.SCENE3D)){var o=i.mapProjection,r=o.ellipsoid,c=o.unproject(a,z);a=r.cartographicToCartesian(c,L),n=u.IDENTITY}return I._computeScreenSpacePosition(n,a,this._eyeOffset,M,i,t)},I.getScreenSpaceBoundingBox=function(e,t,s){var n=e.width,a=e.height,o=e.scale;n*=o,a*=o;var r=t.x;e.horizontalOrigin===p.RIGHT?r-=n:e.horizontalOrigin===p.CENTER&&(r-=.5*n);var c=t.y;return e.verticalOrigin===v.BOTTOM||e.verticalOrigin===v.BASELINE?c-=a:e.verticalOrigin===v.CENTER&&(c-=.5*a),h(s)||(s=new i),s.x=r,s.y=c,s.width=n,s.height=a,s},I.prototype.equals=function(s){return this===s||h(s)&&this._id===s._id&&t.equals(this._position,s._position)&&this._imageId===s._imageId&&this._show===s._show&&this._scale===s._scale&&this._verticalOrigin===s._verticalOrigin&&this._horizontalOrigin===s._horizontalOrigin&&this._heightReference===s._heightReference&&i.equals(this._imageSubRegion,s._imageSubRegion)&&a.equals(this._color,s._color)&&e.equals(this._pixelOffset,s._pixelOffset)&&e.equals(this._translate,s._translate)&&t.equals(this._eyeOffset,s._eyeOffset)&&d.equals(this._scaleByDistance,s._scaleByDistance)&&d.equals(this._translucencyByDistance,s._translucencyByDistance)&&d.equals(this._pixelOffsetScaleByDistance,s._pixelOffsetScaleByDistance)&&_.equals(this._distanceDisplayCondition,s._distanceDisplayCondition)&&this._disableDepthTestDistance===s._disableDepthTestDistance},I.prototype._destroy=function(){h(this._customData)&&(this._billboardCollection._scene.globe._surface.removeTileCustomData(this._customData),this._customData=void 0),h(this._removeCallbackFunc)&&(this._removeCallbackFunc(),this._removeCallbackFunc=void 0),this.image=void 0,this._pickId=this._pickId&&this._pickId.destroy(),this._billboardCollection=void 0},I});