define(["../../Core/Rectangle","../../Core/Ellipsoid","../../Core/GeographicTilingScheme","../../Core/WebMercatorTilingScheme","../../Core/defaultValue","../../Core/defined","../../Core/defineProperties","../../Core/HeightmapTerrainData","../../Core/TerrainProvider","../../Core/getImagePixels","../../Core/DeveloperError","../../Core/Credit","../../Core/Event","../../Core/createGuid","../../ThirdParty/when","../../Core/Resource"],function(e,t,r,a,i,n,o,l,h,g,s,u,m,f,c,p){var d={},y=function(t,r){var a=Math.max(t.west,r.west),i=Math.min(t.east,r.east),n=Math.max(t.south,r.south),o=Math.min(t.north,r.north);return i<=a||n>=o?void 0:new e(a,n,i,o)};d.CRS=[{name:"CRS:84",ellipsoid:t.WGS84,firstAxeIsLatitude:!1,tilingScheme:r,supportedCRS:"urn:ogc:def:crs:OGC:2:84"},{name:"EPSG:4326",ellipsoid:t.WGS84,firstAxeIsLatitude:!0,tilingScheme:r,SupportedCRS:"urn:ogc:def:crs:EPSG::4326"},{name:"EPSG:3857",ellipsoid:t.WGS84,firstAxeIsLatitude:!1,tilingScheme:a,SupportedCRS:"urn:ogc:def:crs:EPSG::3857"},{name:"OSGEO:41001",ellipsoid:t.WGS84,firstAxeIsLatitude:!1,tilingScheme:a,SupportedCRS:"urn:ogc:def:crs:EPSG::3857"}],d.FormatImage=[{format:"image/png",extension:"png"},{format:"image/jpeg",extension:"jpg"},{format:"image/jpeg",extension:"jpeg"},{format:"image/gif",extension:"gif"},{format:"image/png; mode=8bit",extension:"png"}],d.FormatArray=[{format:"image/bil",postProcessArray:function(e,t,r,a,i){var n,o=new DataView(e),l=new ArrayBuffer(t.height*t.width*2),h=new DataView(l);if(l.byteLength===e.byteLength){for(var g,s=0,u=0,m=0;m<l.byteLength;m+=2)if((g=o.getInt16(m,!1)-i)>a&&g<r)h.setInt16(m,g,!0),u+=g,s++;else{var f=0===s?1:u/s;h.setInt16(m,f,!0)}n=new Int16Array(l)}return n}}],d.WMSParser={},d.TMSParser={},d.WMTSParser={},d.parser=function(e){var t;switch((e=i(e,i.EMPTY_OBJECT)).service){case"TMS":t=d.TMSParser.generate(e);break;case"WMTS":t=d.WMTSParser.generate(e);break;default:t=d.WMSParser.generate(e)}return t},d.WMSParser.generate=function(e){var t;if(e=i(e,i.EMPTY_OBJECT),n(e.url)){var r=e.url,a=r.lastIndexOf("?");a>-1&&(r=r.substring(0,a));var o=r+"?SERVICE=WMS&REQUEST=GetCapabilities";n(e.proxy)&&(o=e.proxy.getURL(o)),o=e.url+"/xml?serviceName="+e.layerName,t=c(p.fetchXML({url:o}),function(t){return d.WMSParser.getMetaDatafromXML(t,e)})}else{if(!n(e.xml))throw new s("either description.url or description.xml are required.");t=d.WMSParser.getMetaDatafromXML(e.xml,e)}return t},d.WMSParser.getMetaDatafromXML=function(t,r){if(!(t instanceof XMLDocument))throw new s("xml must be a XMLDocument");if(!n(r.layerName))throw new s("description.layerName is required.");var a={},o=r.layerName,l=i(r.maxLevel,11),h=void 0;a.heightMapWidth=i(r.heightMapWidth,65),a.heightMapHeight=i(r.heightMapHeight,a.heightMapWidth);var g={width:65,height:65},u=void 0;a.formatImage=r.formatImage,a.formatArray=r.formatArray,a.tilingScheme=void 0;var m=void 0,c=void 0;a.ready=!1,a.levelZeroMaximumGeometricError=void 0,a.waterMask=i(r.waterMask,!1),"boolean"!=typeof a.waterMask&&(a.waterMask=!1),a.offset=i(r.offset,0),a.highest=i(r.highest,12e3),a.lowest=i(r.lowest,-500);var p=r.styleName;a.hasStyledImage=i(r.hasStyledImage,"string"==typeof r.styleName);var M=t.querySelector("[version]");null!==M&&(h=M.getAttribute("version"),c=/^1\.[3-9]\./.test(h));var S=r.url,v=S.indexOf("?");v>-1&&(S=S.substring(0,v)),n(r.proxy)&&(S=r.proxy.getURL(S));var x=t.querySelectorAll("Request>GetMap>Format");if(!n(a.formatImage))for(var w=0;w<x.length&&!n(a.formatArray);w++){(T=d.FormatArray.filter(function(e){return e.format===x[w].textContent})).length>0&&(a.formatArray=T[0])}n(a.formatArray)&&"string"==typeof a.formatArray.format&&"function"==typeof a.formatArray.postProcessArray?a.formatArray.terrainDataStructure={heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1,lowestEncodedHeight:0,highestEncodedHeight:1e4}:a.formatArray=void 0;for(w=0;w<x.length&&!n(a.formatImage);w++){var T;(T=d.FormatImage.filter(function(e){return e.format===x[w].textContent})).length>0&&(a.formatImage=T[0])}n(a.formatImage)&&"string"==typeof a.formatImage.format?a.formatImage.terrainDataStructure={heightScale:1,heightOffset:0,elementsPerHeight:2,stride:4,elementMultiplier:256,isBigEndian:!0,lowestEncodedHeight:0,highestEncodedHeight:1e4}:a.formatImage=void 0;for(var A,I=t.querySelectorAll("Layer[queryable='1'],Layer[queryable='true']"),C=0;C<I.length&&!n(A);C++)if(I[C].querySelector("Name").textContent===o){var b=(A=I[C]).getAttribute("fixedHeight"),L=A.getAttribute("fixedWidth");n(b)&&(b=parseInt(b),a.heightMapHeight=b>0&&b<a.heightMapHeight?b:a.heightMapHeight,g.height=b>0?b:g.height),n(L)&&(L=parseInt(L),a.heightMapWidth=L>0&&L<a.heightMapWidth?L:a.heightMapWidth,g.width=L>0?L:g.width)}if(n(A)&&n(h)){for(var W=!1,R=0;R<d.CRS.length&&!W;R++){var H=d.CRS[R],q=H.name,D=A.querySelector("BoundingBox[SRS='"+q+"'],BoundingBox[CRS='"+q+"']");if(null!==D){var P,E,k,N;u=q,m=H.firstAxeIsLatitude,a.tilingScheme=new H.tilingScheme({ellipsoid:H.ellipsoid}),m&&c?(P=parseFloat(D.getAttribute("miny")),E=parseFloat(D.getAttribute("maxy")),k=parseFloat(D.getAttribute("minx")),N=parseFloat(D.getAttribute("maxx"))):(P=parseFloat(D.getAttribute("minx")),E=parseFloat(D.getAttribute("maxx")),k=parseFloat(D.getAttribute("miny")),N=parseFloat(D.getAttribute("maxy")));var X=new e(P,k,E,N);a.getTileDataAvailable=function(e,t,r){var i=!1,o=a.tilingScheme.tileXYToNativeRectangle(e,t,r);if(r<l){var h=y(X,o);i=n(h)}return i},W=!0}}if(n(p)){for(var F=A.querySelectorAll("Style>Name"),G=!1,U=0;U<F.length&&!G;U++)p===F[U].textContent&&(G=!0);G||(p=void 0)}for(var B=t.querySelectorAll("VendorSpecificCapabilities>TileSet"),O=!1,Y=0;Y<B.length&&!O;Y++){var V=null!==B[Y].querySelector("BoundingBox[SRS='"+u+"'],BoundingBox[CRS='"+u+"']");B[Y].querySelector("Layers").textContent===o&&V&&(g.width=parseInt(B[Y].querySelector("Width").textContent),g.height=parseInt(B[Y].querySelector("Height").textContent),O=!0)}a.ready=W&&(n(a.formatImage)||n(a.formatArray))&&n(h)}if(a.ready){var _=S+"/"+o+"?request=GetMap&bbox=",z=f();if(_+=c&&m?"{south},{west},{north},{east}":"{west},{south},{east},{north}",_+="&uuid="+z,a.formatImage){var Z=_;n(p)&&(Z+="&styles="+p+"&style="+p),a.URLtemplateImage=function(){return Z},a.imageSize=g}if(a.formatArray){var j=_+"&format="+a.formatArray.format+"&width="+a.heightMapWidth+"&height="+a.heightMapHeight;a.URLtemplateArray=function(){return j}}}return a},d.TMSParser.generate=function(e){var t;if(e=i(e,i.EMPTY_OBJECT),n(e.url))t=loadXML(e.url).then(function(t){return d.TMSParser.parseXML(t,e)});else{if(!n(e.xml))throw new s("either description.url or description.xml are required.");t=d.TMSParser.parseXML(e.xml,e)}return t},d.TMSParser.parseXML=function(e,t){if(!(e instanceof XMLDocument))throw new s("xml must be a XMLDocument");var r;if(null!=e.querySelector("TileMapService")){if(!n(t.layerName))throw new s("layerName is required.");var a=[].slice.apply(e.querySelectorAll("TileMap[title='"+t.layerName+"']")).map(function(e){var r=e.getAttribute("href");return n(t.proxy)&&(r=t.proxy.getURL(r)),c(loadXML(r),function(e){return d.TMSParser.getMetaDatafromXML(e,t)})});r=c.all(a).then(function(e){for(var t,r=0;r<e.length&&!n(t);r++)n(e[r])&&(t=e[r]);return t}).then(function(e){return e})}else r=d.TMSParser.getMetaDatafromXML(e,t);return r},d.TMSParser.getMetaDatafromXML=function(t,r){var a={ready:!1};a.heightMapWidth=i(r.heightMapWidth,65),a.heightMapHeight=i(r.heightMapHeight,a.heightMapWidth);var o=i(r.maxLevel,11),l=r.proxy;a.hasStyledImage=i(r.hasStyledImage,"string"==typeof r.styleName),a.waterMask=i(r.waterMask,!1),"boolean"!=typeof a.waterMask&&(a.waterMask=!1),a.offset=i(r.offset,0),a.highest=i(r.highest,12e3),a.lowest=i(r.lowest,-500);var h=t.querySelector("SRS").textContent,g=d.CRS.filter(function(e){return e.name===h});g.length>0&&(a.tilingScheme=new g[0].tilingScheme({ellipsoid:g[0].ellipsoid}));var s=t.querySelector("TileFormat"),u=d.FormatImage.filter(function(e){return e.extension==s.getAttribute("extension")});u.length>0&&(a.formatImage=u[0],a.imageSize={},a.imageSize.width=parseInt(s.getAttribute("width")),a.imageSize.height=parseInt(s.getAttribute("height")));var m=[].slice.call(t.querySelectorAll("TileSets>TileSet")),f=[];if(n(a.formatImage)&&((f=m.map(function(e){var t=e.getAttribute("href")+"/{x}/{tmsY}."+a.formatImage.extension;return n(l)&&(t=l.getURL(t)),{url:t,level:parseInt(e.getAttribute("order"))}})).sort(function(e,t){return e.level-t.level}),f.length>0&&(a.tileSets=f)),n(a.tileSets)&&n(a.formatImage)&&n(a.tilingScheme)){a.URLtemplateImage=function(e,t,r){var a="";return r<f.length&&(a=f[r].url),a};var c=t.querySelector("BoundingBox"),p=parseFloat(c.getAttribute("miny")),M=parseFloat(c.getAttribute("maxy")),S=parseFloat(c.getAttribute("minx")),v=parseFloat(c.getAttribute("maxx")),x=new e(S,p,v,M);a.getTileDataAvailable=function(e,t,r){var i=a.tilingScheme.tileXYToNativeRectangle(e,t,r),l=y(x,i);return n(l)&&r<o&&r<f.length},a.ready=!0}else a=void 0;return a},d.WMTSParser.generate=function(e){var t;if(e=i(e,i.EMPTY_OBJECT),n(e.url)){var r=e.url,a=r.lastIndexOf("?");a>-1&&(r=r.substring(0,a));var o=r+"?REQUEST=GetCapabilities";n(e.proxy)&&(o=e.proxy.getURL(o)),t=loadXML(o).then(function(t){return d.WMTSParser.getMetaDatafromXML(t,e)})}else{if(!n(e.xml))throw new s("either description.url or description.xml are required.");t=d.WMTSParser.getMetaDatafromXML(e.xml,e)}return t},d.WMTSParser.getMetaDatafromXML=function(e,t){if(!(e instanceof XMLDocument))throw new s("xml must be a XMLDocument");var r={},a=t.layerName;r.ready=!1,r.heightMapWidth=i(t.heightMapWidth,65),r.heightMapHeight=i(t.heightMapHeight,r.heightMapWidth);var o,l=i(t.maxLevel,12),h=t.proxy,g=t.styleName;r.hasStyledImage=i(t.hasStyledImage,"string"==typeof t.styleName),r.waterMask=i(t.waterMask,!1),"boolean"!=typeof r.waterMask&&(r.waterMask=!1),r.offset=i(t.offset,0),r.highest=i(t.highest,12e3),r.lowest=i(t.lowest,-500);for(var u,m,f,c=[],p=[].slice.call(e.querySelectorAll('Operation[name="GetTile"] HTTP Get')).map(function(e){var t,r=e.querySelector("Value").textContent;return"KVP"===r&&(t={node:e,type:"KVP"}),"RESTful"===r&&(t={node:e,type:"RESTful"}),t}).filter(function(e){return n(e)}),y=0;y<p.length;y++){var M=p[y];"RESTful"!==M.type||n(m)||(m=M.node.getAttribute("xlink:href"),n(h)&&(m=h.getURL(m))),"KVP"!==M.type||n(u)||(u=M.node.getAttribute("xlink:href"),n(h)&&(u=h.getURL(u)))}var S,v=e.querySelectorAll("Contents>Layer>Identifier");for(y=0;y<v.length&&!n(S);y++)a===v[y].textContent&&(S=v[y].parentNode);if(n(S)){var x,w,T=S.querySelectorAll("Style");for(y=0;y<T.length;y++){var A=T[y].querySelector("Identifier").textContent;null!=T[y].getAttribute("isDefault")&&(x=A),A===g&&(w=A)}n(g)&&g==w||(g=i(x,""));for(var I=[].slice.call(S.querySelectorAll("Format")),C=0;C<d.FormatImage.length&&!n(f);C++){I.filter(function(e){return e.textContent===d.FormatImage[C].format}).length>0&&(f=d.FormatImage[C])}c=S.querySelectorAll("TileMatrixSetLink")}for(var b=[].slice.call(e.querySelectorAll("TileMatrixSet>Identifier")),L=0;L<c.length&&!r.ready;L++){var W,R,H=c[L],q=H.querySelector("TileMatrixSet").textContent;for(y=0;y<b.length&&!n(W);y++)b[y].textContent===q&&(W=b[y].parentNode);for(var D=W.querySelector("SupportedCRS").textContent,P=0;P<d.CRS.length&&!n(R);P++)d.CRS[P].SupportedCRS===D&&(R=d.CRS[P]);if(n(R)){var E,k=[].slice.call(W.querySelectorAll("TileMatrix"));(E=k.map(function(e){var t=e.querySelector("Identifier").textContent,r=parseInt(e.querySelector("MatrixWidth").textContent),a=parseInt(e.querySelector("MatrixHeight").textContent),i=parseInt(e.querySelector("TileWidth").textContent),n=parseInt(e.querySelector("TileHeight").textContent);return{id:t,maxWidth:r,maxHeight:a,scaleDenominator:parseFloat(e.querySelector("ScaleDenominator").textContent),complete:!1,tileWidth:i,tileHeight:n}})).sort(function(e,t){return t.scaleDenominator-e.scaleDenominator}),listTileMatrixLimits=H.querySelectorAll("TileMatrixSetLimits>TileMatrixLimits");for(var N=0;N<E.length;N++)for(var X=E[N],F=0;F<listTileMatrixLimits.length;F++){var G=listTileMatrixLimits[F];X.id===G.querySelector("TileMatrix").textContent&&(X.minTileRow=parseInt(G.querySelector("MinTileRow").textContent),X.maxTileRow=parseInt(G.querySelector("MaxTileRow").textContent),X.minTileCol=parseInt(G.querySelector("MinTileCol").textContent),X.maxTileCol=parseInt(G.querySelector("MaxTileCol").textContent),X.complete=!0,E[N]=X)}if(E.length>0){r.tilingScheme=new R.tilingScheme({ellipsoid:R.ellipsoid,numberOfLevelZeroTilesX:E[0].maxWidth,numberOfLevelZeroTilesY:E[0].maxHeight});var U=S.querySelector("ResourceURL[format='"+f.format+"']");if(null!=U?o=U.getAttribute("template").replace("{TileRow}","{y}").replace("{TileCol}","{x}").replace("{Style}",g).replace("{TileMatrixSet}",q).replace("{layer}",a).replace("{infoFormatExtension}",f.extension):n(u)&&(o=u+"service=WMTS&request=GetTile&version=1.0.0&layer="+a+"&style="+g+"&format="+f.format+"&TileMatrixSet="+q+"&TileMatrix={TileMatrix}&TileRow={y}&TileCol={x}"),n(o)){r.getTileDataAvailable=function(e,t,r){var a=!1;if(r<l&&r<E.length){var i=E[r];a=i.complete?t<=i.maxTileRow&&t>=i.minTileRow&&e<=i.maxTileCol&&e>=i.minTileCol:e<i.maxWidth&&t<i.maxHeight}return a},r.URLtemplateImage=function(e,t,a){var i="";if(r.getTileDataAvailable(e,t,a)){var n=E[a];i=o.replace("{TileMatrix}",n.id)}return i};var B={width:E[0].tileWidth,height:E[0].tileHeight};0==E.filter(function(e){return e.tileWidth!=B.width||e.tileHeight!=B.height}).length&&(r.imageSize=B),r.ready=!0}}}}return r};var M=function(e){if(!n(e))throw new s("description is required.");var t=new m,r=e.url.lastIndexOf("/");e.layerName=e.url.substr(r+1),e.url=e.url.substr(0,r),this.id=e.id||f(),e.heightMapWidth=e.heightMapWidth||65,e.heightMapHeight=e.heightMapHeight||65,e.maxLevel=e.maxLevel||13,e.formatImage=e.formatImage||{format:"image/png",extension:"png"},e.styleName=e.styleName||"grayToColor",e.hasStyledImage=e.hasStyledImage||!0,e.waterMask=e.waterMask||!1;var a=e.credit;"string"==typeof a&&(a=new u(a)),this.ready=!1,this._readyPromise=c.defer(),o(this,{errorEvent:{get:function(){return t}},credit:{get:function(){return a}},hasVertexNormals:{get:function(){return!1}},readyPromise:{get:function(){return this._readyPromise.promise}}}),S(d.parser(e),this)};function S(e,t){c(e,function(e){n(e)&&e.ready&&(e.levelZeroMaximumGeometricError=h.getEstimatedLevelZeroGeometricErrorForAHeightmap(e.tilingScheme.ellipsoid,e.heightMapWidth,e.tilingScheme.getNumberOfXTilesAtLevel(0)),n(e.URLtemplateImage)&&(e.getHeightmapTerrainDataImage=function(r,a,i){var o;if(!isNaN(r+a+i)){var h=v(e.URLtemplateImage(r,a,i),r,a,i,t),g={highest:e.highest,lowest:e.lowest,offset:e.offset},s=x(r,a,i,t),u=p.fetchImage({url:h});n(u)&&(o=c(u,function(t){return M.imageToHeightmapTerrainData(t,g,{width:e.heightMapWidth,height:e.heightMapHeight},e.waterMask,s,e.hasStyledImage)}).otherwise(function(){return new l({buffer:new Uint16Array(e.heightMapWidth*e.heightMapHeight),width:e.heightMapWidth,height:e.heightMapHeight,childTileMask:s,waterMask:new Uint8Array(e.heightMapWidth*e.heightMapHeight),structure:e.formatImage.terrainDataStructure})}))}return o}),n(e.URLtemplateArray)&&(e.getHeightmapTerrainDataArray=function(r,a,i){var o;if(!isNaN(r+a+i)){var h=v(e.URLtemplateArray(r,a,i),r,a,i,t),g={highest:e.highest,lowest:e.lowest,offset:e.offset},s=x(r,a,i,t),u=p.fetchArrayBuffer({url:h});n(u)&&(o=c(u,function(t){return M.arrayToHeightmapTerrainData(t,g,{width:e.heightMapWidth,height:e.heightMapHeight},e.formatArray,e.waterMask,s)}).otherwise(function(){return n(e.getHeightmapTerrainDataImage)?e.getHeightmapTerrainDataImage(r,a,i):new l({buffer:new Uint16Array(e.heightMapWidth*e.heightMapHeight),width:e.heightMapWidth,height:e.heightMapHeight,childTileMask:s,waterMask:new Uint8Array(e.heightMapWidth*e.heightMapHeight),structure:e.formatImage.terrainDataStructure})}))}return o}),t.getLevelMaximumGeometricError=function(t){return e.levelZeroMaximumGeometricError/(1<<t)},t.requestTileGeometry=function(t,r,a){var i;return n(e.getHeightmapTerrainDataArray)?i=e.getHeightmapTerrainDataArray(t,r,a):n(e.getHeightmapTerrainDataImage)&&(i=e.getHeightmapTerrainDataImage(t,r,a)),i},o(t,{tilingScheme:{get:function(){return e.tilingScheme}},ready:{get:function(){return e.ready}},hasWaterMask:{get:function(){return e.waterMask}},heightMapHeight:{get:function(){return e.heightMapHeight}},heightMapWidth:{get:function(){return e.heightMapWidth}},getTileDataAvailable:{get:function(){return e.getTileDataAvailable}}})),t._readyPromise.resolve(e.ready)})}function v(e,t,r,a,i){var n=i.tilingScheme.tileXYToNativeRectangle(t,r,a),o=(n.east-n.west)/(i.heightMapWidth-1),l=(n.north-n.south)/(i.heightMapHeight-1);n.west-=.5*o,n.east+=.5*o,n.south-=.5*l,n.north+=.5*l;var h=i.tilingScheme.getNumberOfYTilesAtLevel(a)-r-1;return e.replace("{south}",n.south).replace("{north}",n.north).replace("{west}",n.west).replace("{east}",n.east).replace("{x}",t).replace("{y}",r).replace("{tmsY}",h)}function x(e,t,r,a){var i=0,n=r+1;return i|=a.getTileDataAvailable(2*e,2*t,n)?1:0,i|=a.getTileDataAvailable(2*e+1,2*t,n)?2:0,i|=a.getTileDataAvailable(2*e,2*t+1,n)?4:0,i|=a.getTileDataAvailable(2*e+1,2*t+1,n)?8:0}return M.arrayToHeightmapTerrainData=function(e,t,r,a,i,o){"number"==typeof r&&(r={width:r,height:r});var h=a.postProcessArray(e,r,t.highest,t.lowest,t.offset);if(!n(h))throw new s("no good size");var g={buffer:h,width:r.width,height:r.height,childTileMask:o,structure:a.terrainDataStructure};if(i){for(var u=new Uint8Array(h.length),m=0;m<h.length;m++)h[m]<=0&&(u[m]=255);g.waterMask=u}return new l(g)},M.imageToHeightmapTerrainData=function(e,t,r,a,i,n){"number"==typeof r&&(r={width:r,height:r});for(var o=g(e,r.width,r.height),h=new Uint8Array(o.length/4),s=new Int16Array(o.length/4),u=0,m=0,f=0;f<o.length;f+=4){var c=o[f],p=o[f+1],d=o[f+2]>128,y=(c<<8|p)-t.offset-32768;y>t.lowest&&y<t.highest&&(d||n)?(s[f/4]=y,m+=y,u++):s[f/4]=0==u?0:m/u}var M={buffer:s,width:r.width,height:r.height,childTileMask:i,structure:{heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1}};if(a){for(h=new Uint8Array(s.length),f=0;f<s.length;f++)s[f]<=0&&(h[f]=255);M.waterMask=h}return new l(M)},M});