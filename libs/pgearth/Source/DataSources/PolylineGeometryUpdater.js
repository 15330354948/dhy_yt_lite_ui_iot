define(["../Core/ArcType","../Core/BoundingSphere","../Core/Check","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/DistanceDisplayCondition","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/Event","../Core/GeometryInstance","../Core/GroundPolylineGeometry","../Core/Iso8601","../Core/oneTimeWarning","../Core/PolylineGeometry","../Core/PolylinePipeline","../Core/ShowGeometryInstanceAttribute","../DataSources/Entity","../Scene/ClassificationType","../Scene/GroundPolylinePrimitive","../Scene/PolylineCollection","../Scene/PolylineColorAppearance","../Scene/PolylineMaterialAppearance","../Scene/ShadowMode","./BoundingSphereState","./ColorMaterialProperty","./ConstantProperty","./MaterialProperty","./Property"],function(e,t,i,r,n,o,s,a,l,d,h,y,p,u,c,_,g,f,m,v,P,C,w,E,T,D,M,I,O,V,b,G){"use strict";var U=new V(0),A={},S=new r,F=new O(r.WHITE),N=new V(!0),x=new V(M.DISABLED),L=new V(new h),z=new V(C.BOTH);function B(e,t){if(!s(e))throw new d("entity is required");if(!s(t))throw new d("scene is required");this._entity=e,this._scene=t,this._entitySubscription=e.definitionChanged.addEventListener(B.prototype._onEntityPropertyChanged,this),this._fillEnabled=!1,this._dynamic=!1,this._geometryChanged=new p,this._showProperty=void 0,this._materialProperty=void 0,this._shadowsProperty=void 0,this._distanceDisplayConditionProperty=void 0,this._classificationTypeProperty=void 0,this._depthFailMaterialProperty=void 0,this._geometryOptions=new function(){this.vertexFormat=void 0,this.positions=void 0,this.width=void 0,this.arcType=void 0,this.granularity=void 0},this._groundGeometryOptions=new function(){this.positions=void 0,this.width=void 0,this.arcType=void 0,this.granularity=void 0},this._id="polyline-"+e.id,this._clampToGround=!1,this._supportsPolylinesOnTerrain=P.supportsPolylinesOnTerrain(t),this._zIndex=0,this._onEntityPropertyChanged(e,"polyline",e.polyline,void 0)}a(B.prototype,{id:{get:function(){return this._id}},entity:{get:function(){return this._entity}},fillEnabled:{get:function(){return this._fillEnabled}},hasConstantFill:{get:function(){return!this._fillEnabled||!s(this._entity.availability)&&G.isConstant(this._showProperty)}},fillMaterialProperty:{get:function(){return this._materialProperty}},depthFailMaterialProperty:{get:function(){return this._depthFailMaterialProperty}},outlineEnabled:{value:!1},hasConstantOutline:{value:!0},outlineColorProperty:{value:void 0},shadowsProperty:{get:function(){return this._shadowsProperty}},distanceDisplayConditionProperty:{get:function(){return this._distanceDisplayConditionProperty}},classificationTypeProperty:{get:function(){return this._classificationTypeProperty}},isDynamic:{get:function(){return this._dynamic}},isClosed:{value:!1},geometryChanged:{get:function(){return this._geometryChanged}},arcType:{get:function(){return this._arcType}},clampToGround:{get:function(){return this._clampToGround&&this._supportsPolylinesOnTerrain}},zIndex:{get:function(){return this._zIndex}}}),B.prototype.isOutlineVisible=function(e){return!1},B.prototype.isFilled=function(e){var t=this._entity,i=this._fillEnabled&&t.isAvailable(e)&&this._showProperty.getValue(e);return o(i,!1)},B.prototype.createFillGeometryInstance=function(e){if(!s(e))throw new d("time is required.");if(!this._fillEnabled)throw new d("This instance does not represent a filled geometry.");var t,i=this._entity,o=i.isAvailable(e),a=new v(o&&i.isShowing&&this._showProperty.getValue(e)),l=this._distanceDisplayConditionProperty.getValue(e),h={show:a,distanceDisplayCondition:y.fromDistanceDisplayCondition(l)};return this._materialProperty instanceof O&&(s(this._materialProperty.color)&&(this._materialProperty.color.isConstant||o)&&(t=this._materialProperty.color.getValue(e,S)),s(t)||(t=r.WHITE),h.color=n.fromColor(t)),this.clampToGround?new u({id:i,geometry:new c(this._groundGeometryOptions),attributes:h}):(s(this._depthFailMaterialProperty)&&this._depthFailMaterialProperty instanceof O&&(s(this._depthFailMaterialProperty.color)&&(this._depthFailMaterialProperty.color.isConstant||o)&&(t=this._depthFailMaterialProperty.color.getValue(e,S)),s(t)||(t=r.WHITE),h.depthFailColor=n.fromColor(t)),new u({id:i,geometry:new f(this._geometryOptions),attributes:h}))},B.prototype.createOutlineGeometryInstance=function(e){throw new d("This instance does not represent an outlined geometry.")},B.prototype.isDestroyed=function(){return!1},B.prototype.destroy=function(){this._entitySubscription(),l(this)},B.prototype._onEntityPropertyChanged=function(e,t,i,r){if("availability"===t||"polyline"===t){var n=this._entity.polyline;if(s(n)){var a=n.positions,l=n.show;if(s(l)&&l.isConstant&&!l.getValue(_.MINIMUM_VALUE)||!s(a))this._fillEnabled&&(this._fillEnabled=!1,this._geometryChanged.raiseEvent(this));else{var d=n.zIndex,h=o(n.material,F),y=h instanceof O;this._materialProperty=h,this._depthFailMaterialProperty=n.depthFailMaterial,this._showProperty=o(l,N),this._shadowsProperty=o(n.shadows,x),this._distanceDisplayConditionProperty=o(n.distanceDisplayCondition,L),this._classificationTypeProperty=o(n.classificationType,z),this._fillEnabled=!0,this._zIndex=o(d,U);var p=n.width,u=n.arcType,c=n.clampToGround,f=n.granularity;if(a.isConstant&&G.isConstant(p)&&G.isConstant(u)&&G.isConstant(f)&&G.isConstant(c)&&G.isConstant(d)){var m,v=this._geometryOptions,P=a.getValue(_.MINIMUM_VALUE,v.positions);if(!s(P)||P.length<2)return void(this._fillEnabled&&(this._fillEnabled=!1,this._geometryChanged.raiseEvent(this)));m=y&&(!s(this._depthFailMaterialProperty)||this._depthFailMaterialProperty instanceof O)?T.VERTEX_FORMAT:D.VERTEX_FORMAT,v.vertexFormat=m,v.positions=P,v.width=s(p)?p.getValue(_.MINIMUM_VALUE):void 0,v.arcType=s(u)?u.getValue(_.MINIMUM_VALUE):void 0,v.granularity=s(f)?f.getValue(_.MINIMUM_VALUE):void 0;var C=this._groundGeometryOptions;C.positions=P,C.width=v.width,C.arcType=v.arcType,C.granularity=v.granularity,this._clampToGround=!!s(c)&&c.getValue(_.MINIMUM_VALUE),!this._clampToGround&&s(d)&&g("Entity polylines must have clampToGround: true when using zIndex.  zIndex will be ignored."),this._dynamic=!1,this._geometryChanged.raiseEvent(this)}else this._dynamic||(this._dynamic=!0,this._geometryChanged.raiseEvent(this))}}else this._fillEnabled&&(this._fillEnabled=!1,this._geometryChanged.raiseEvent(this))}},B.prototype.createDynamicUpdater=function(e,t){if(i.defined("primitives",e),i.defined("groundPrimitives",t),!this._dynamic)throw new d("This instance does not represent dynamic geometry.");return new R(e,t,this)};var H={positions:void 0,granularity:void 0,height:void 0,ellipsoid:void 0};function R(e,t,i){this._line=void 0,this._primitives=e,this._groundPrimitives=t,this._groundPolylinePrimitive=void 0,this._material=void 0,this._geometryUpdater=i,this._positions=[]}function W(e){if(s(e._line))return e._line;var t=e._geometryUpdater._scene.id,i=A[t],r=e._primitives;!s(i)||i.isDestroyed()?(i=new E,A[t]=i,r.add(i)):r.contains(i)||r.add(i);var n=i.add();return n.id=e._geometryUpdater._entity,e._line=n,n}return R.prototype.update=function(t){var i=this._geometryUpdater,r=i._entity,n=r.polyline,o=n.positions,a=G.getValueOrUndefined(o,t,this._positions);i._clampToGround=G.getValueOrDefault(n._clampToGround,t,!1),i._groundGeometryOptions.positions=a,i._groundGeometryOptions.width=G.getValueOrDefault(n._width,t,1),i._groundGeometryOptions.arcType=G.getValueOrDefault(n._arcType,t,e.GEODESIC),i._groundGeometryOptions.granularity=G.getValueOrDefault(n._granularity,t,9999);var l=this._groundPrimitives;if(s(this._groundPolylinePrimitive)&&(l.remove(this._groundPolylinePrimitive),this._groundPolylinePrimitive=void 0),i.clampToGround){if(!r.isShowing||!r.isAvailable(t)||!G.getValueOrDefault(n._show,t,!0))return;if(!s(a)||a.length<2)return;var d,h=i.fillMaterialProperty;if(h instanceof O)d=new T;else{var y=b.getValue(t,h,this._material);d=new D({material:y,translucent:y.isTranslucent()}),this._material=y}return this._groundPolylinePrimitive=l.add(new w({geometryInstances:i.createFillGeometryInstance(t),appearance:d,classificationType:i.classificationTypeProperty.getValue(t),asynchronous:!1}),G.getValueOrUndefined(i.zIndex,t)),void(s(this._line)&&(this._line.show=!1))}var p=W(this);if(r.isShowing&&r.isAvailable(t)&&G.getValueOrDefault(n._show,t,!0))if(!s(a)||a.length<2)p.show=!1;else{var u=e.GEODESIC;u=G.getValueOrDefault(n._arcType,t,u);var c=i._scene.globe;u!==e.NONE&&s(c)&&(H.ellipsoid=c.ellipsoid,H.positions=a,H.granularity=G.getValueOrUndefined(n._granularity,t),H.height=m.extractHeights(a,c.ellipsoid),a=m.generateCartesianArc(H)),p.show=!0,p.positions=a.slice(),p.material=b.getValue(t,i.fillMaterialProperty,p.material),p.width=G.getValueOrDefault(n._width,t,1),p.distanceDisplayCondition=G.getValueOrUndefined(n._distanceDisplayCondition,t,p.distanceDisplayCondition)}else p.show=!1},R.prototype.getBoundingSphere=function(e){if(i.defined("result",e),this._geometryUpdater.clampToGround){var r=this._groundPolylinePrimitive;if(s(r)&&r.show&&r.ready){var n=r.getGeometryInstanceAttributes(this._geometryUpdater._entity);if(s(n)&&s(n.boundingSphere))return t.clone(n.boundingSphere,e),I.DONE}return s(r)&&!r.ready?I.PENDING:I.DONE}var o=W(this);return o.show&&o.positions.length>0?(t.fromPoints(o.positions,e),I.DONE):I.FAILED},R.prototype.isDestroyed=function(){return!1},R.prototype.destroy=function(){var e=this._geometryUpdater._scene.id,t=A[e];s(t)&&(t.remove(this._line),0===t.length&&(this._primitives.removeAndDestroy(t),delete A[e])),s(this._groundPolylinePrimitive)&&this._groundPrimitives.remove(this._groundPolylinePrimitive),l(this)},B});