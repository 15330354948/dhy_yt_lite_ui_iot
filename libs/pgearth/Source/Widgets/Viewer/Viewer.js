define(["../../Core/BoundingSphere","../../Core/Ellipsoid","../../Core/Cartesian3","../../Core/Cartesian2","../../Core/Cartographic","../../Core/Clock","../../Core/defaultValue","../../Core/defined","../../Core/defineProperties","../../Core/destroyObject","../../Core/DeveloperError","../../Core/Event","../../Core/EventHelper","../../Core/HeadingPitchRange","../../Core/isArray","../../Core/Matrix4","../../Core/Rectangle","../../Core/ScreenSpaceEventType","../../DataSources/BoundingSphereState","../../DataSources/ConstantPositionProperty","../../DataSources/DataSourceCollection","../../DataSources/DataSourceDisplay","../../DataSources/Entity","../../DataSources/EntityView","../../DataSources/Property","../../Scene/PGEarth3DTileset","../../Scene/computeFlyToLocationForRectangle","../../Scene/ImageryLayer","../../Scene/SceneMode","../../Scene/TimeDynamicPointCloud","../../ThirdParty/knockout","../../ThirdParty/when","../Animation/Animation","../Animation/AnimationViewModel","../BaseLayerPicker/BaseLayerPicker","../BaseLayerPicker/createDefaultImageryProviderViewModels","../BaseLayerPicker/createDefaultTerrainProviderViewModels","../PGEarthWidget/PGEarthWidget","../ClockViewModel","../FullscreenButton/FullscreenButton","../Geocoder/Geocoder","../getElement","../HomeButton/HomeButton","../InfoBox/InfoBox","../NavigationHelpButton/NavigationHelpButton","../ProjectionPicker/ProjectionPicker","../SceneModePicker/SceneModePicker","../SelectionIndicator/SelectionIndicator","../subscribeAndEvaluate","../Timeline/Timeline","../VRButton/VRButton","../../DataSources/PolylineDashMaterialProperty","../../Core/Color","../../extends/widgets/navigation/viewerPGEarthNavigationMixin"],function(e,t,i,o,n,r,a,s,c,d,l,h,u,p,m,g,_,f,v,y,E,k,S,w,C,T,P,B,b,D,x,M,I,L,V,z,R,A,H,W,N,O,F,j,U,G,q,Y,K,J,Z,Q,X,$){"use strict";var ee=new e;function te(e){var t=e.clock;t.currentTime=e.timeJulian,t.shouldAnimate=!1}function ie(e,t){var i=e.scene.pick(t.position);if(s(i)){var o=a(i.id,i.primitive.id);if(o instanceof S)return o}if(s(e.scene.globe))return function(e,t){var i=e.scene,o=i.camera.getPickRay(t),n=i.imageryLayers.pickImageryLayerFeatures(o,i);if(!s(n))return;var r=new S({id:"Loading...",description:"Loading feature information..."}),a=i.globe.pick(o,i);if(s(a)&&e.infoBox){var c=i.globe.ellipsoid.cartesianToCartographic(a),d=e.scene.globe.ellipsoid.cartographicToCartesian(c,ne);re(e,d),"lightLine"===e.infoBox._className&&ae(e,t)}return M(n,function(i){if(e.selectedEntity===r)if(s(i)&&0!==i.length&&0!==Object.keys(i[0].data.properties).length){var o=i[0],n=new S({id:o.name,description:o.description});if(s(o.position)){var a=e.scene.globe.ellipsoid.cartographicToCartesian(o.position,ne);n.position=new y(a),re(e,a)}e.selectedEntity=n,setTimeout(function(){e.infoBox&&"lightLine"===e.infoBox._className&&ae(e,t)},20)}else e.selectedEntity=void 0},function(){e.selectedEntity===r&&(e.selectedEntity=void 0)}),r}(e,t.position)}function oe(e,t,i){if(s(i)){var o=i.clock;s(o)&&(o.getValue(t),s(e)&&(e.updateFromClock(),e.zoomTo(o.startTime,o.stopTime)))}}var ne=new i;function re(e,t){e.scene.postRender.addEventListener(function(){var i=e.scene.cartesianToCanvasCoordinates(t);if(s(i)&&e.infoBox){var o=e._infoBox._container;"lightLine"===e.infoBox._className?(o.style.top=i.y+"px",o.style.left=i.x+"px"):(o.style.top=i.y-o.clientHeight-16+"px",o.style.left=i.x-o.children[0].offsetWidth/2+"px")}})}function ae(e,t){var i=window.innerWidth,o=(window.innerHeight,document.getElementsByClassName("property-content")[0]);o.removeAttribute("style");var n=o.clientHeight,r=!1,a=!1;t.x+440>i&&(r=!0),t.y<240&&(a=!0);var s="";r?(s="left-",s+=a?"bottom-pop":"top-pop"):(s="right-",a?s+="bottom-pop":s=""),n>window.innerHeight-t.y+247&&(r?o.setAttribute("style","transform:translate(-457px, -255px)"):o.setAttribute("style","transform:translate(0, -255px)"));var c=document.getElementsByClassName("light-line-pop")[0];c.classList.remove("left-top-pop","left-bottom-pop","right-bottom-pop"),s&&c.classList.add(s)}function se(e,t){if(!s(e))throw new l("container is required.");e=O(e),t=a(t,a.EMPTY_OBJECT);var i=!(s(t.globe)&&!1===t.globe||s(t.baseLayerPicker)&&!1===t.baseLayerPicker);if(!i&&s(t.selectedImageryProviderViewModel))throw new l("options.selectedImageryProviderViewModel is not available when not using the BaseLayerPicker widget. Either specify options.imageryProvider instead or set options.baseLayerPicker to true.");if(!i&&s(t.selectedTerrainProviderViewModel))throw new l("options.selectedTerrainProviderViewModel is not available when not using the BaseLayerPicker widget. Either specify options.terrainProvider instead or set options.baseLayerPicker to true.");var o=this,n=document.createElement("div");n.className="pgEarth-viewer",e.appendChild(n);var c=document.createElement("div");c.className="pgEarth-viewer-pgEarthWidgetContainer",n.appendChild(c);var d=document.createElement("div");d.className="pgEarth-viewer-bottom",n.appendChild(d);var p,g,v=a(t.scene3DOnly,!1),y=!1;s(t.clockViewModel)?p=(g=t.clockViewModel).clock:(p=new r,g=new H(p),y=!0),s(t.shouldAnimate)&&(p.shouldAnimate=t.shouldAnimate);var S=new A(c,{imageryProvider:!i&&!s(t.imageryProvider)&&void 0,clock:p,skyBox:t.skyBox,skyAtmosphere:t.skyAtmosphere,sceneMode:t.sceneMode,mapProjection:t.mapProjection,globe:t.globe,orderIndependentTranslucency:t.orderIndependentTranslucency,contextOptions:t.contextOptions,useDefaultRenderLoop:t.useDefaultRenderLoop,targetFrameRate:t.targetFrameRate,showRenderLoopErrors:t.showRenderLoopErrors,creditContainer:s(t.creditContainer)?t.creditContainer:d,creditViewport:t.creditViewport,scene3DOnly:v,terrainExaggeration:t.terrainExaggeration,shadows:t.shadows,terrainShadows:t.terrainShadows,mapMode2D:t.mapMode2D,requestRenderMode:t.requestRenderMode,maximumRenderTimeChange:t.maximumRenderTimeChange}),w=t.dataSources,T=!1;s(w)||(w=new E,T=!0);var P,B=S.scene,b=new k({scene:B,dataSourceCollection:w}),D=new u;if(D.add(p.onTick,se.prototype._onTick,this),D.add(B.morphStart,se.prototype._clearTrackedObject,this),!s(t.selectionIndicator)||t.selectionIndicator,!s(t.infoBox)||!1!==t.infoBox){var M=document.createElement("div");M.className="pgEarth-viewer-infoBoxContainer",n.appendChild(M);var Y=t.infoBox&&a(t.infoBox.className,"lightLine")||"lightLine",Q=(P=new j(M,Y)).viewModel;D.add(Q.cameraClicked,se.prototype._onInfoBoxCameraClicked,this),D.add(Q.closeClicked,se.prototype._onInfoBoxClockClicked,this)}var X,ee,oe,ne,re,ae,ce,de,le,he,ue,pe,me,ge,_e,fe=document.createElement("div");if(fe.className="pgEarth-viewer-toolbar",n.appendChild(fe),!s(t.geocoder)||!1!==t.geocoder){var ve,ye=document.createElement("div");ye.className="pgEarth-viewer-geocoderContainer",fe.appendChild(ye),s(t.geocoder)&&"boolean"!=typeof t.geocoder&&(ve=m(t.geocoder)?t.geocoder:[t.geocoder]),X=new N({container:ye,geocoderServices:ve,scene:B}),D.add(X.viewModel.search.beforeExecute,se.prototype._clearObjects,this)}if(s(t.homeButton)&&!1===t.homeButton||(ee=new F(fe,B),s(X)&&D.add(ee.viewModel.command.afterExecute,function(){var e=X.viewModel;e.searchText="",e.isSearchInProgress&&e.search()}),D.add(ee.viewModel.command.beforeExecute,se.prototype._clearTrackedObject,this)),!0===t.sceneModePicker&&v)throw new l("options.sceneModePicker is not available when options.scene3DOnly is set to true.");if(v||s(t.sceneModePicker)&&!1===t.sceneModePicker||(oe=new q(fe,B)),t.projectionPicker&&(ne=new G(fe,B)),i){var Ee=a(t.imageryProviderViewModels,z()),ke=a(t.terrainProviderViewModels,R());re=new V(fe,{globe:B.globe,imageryProviderViewModels:Ee,selectedImageryProviderViewModel:t.selectedImageryProviderViewModel,terrainProviderViewModels:ke,selectedTerrainProviderViewModel:t.selectedTerrainProviderViewModel}),ae=fe.getElementsByClassName("pgEarth-baseLayerPicker-dropDown")[0]}if(s(t.imageryProvider)&&!1!==t.imageryProvider&&(i&&(re.viewModel.selectedImagery=void 0),B.imageryLayers.removeAll(),B.imageryLayers.addImageryProvider(t.imageryProvider)),s(t.terrainProvider)&&(i&&(re.viewModel.selectedTerrain=void 0),B.terrainProvider=t.terrainProvider),!s(t.navigationHelpButton)||!1!==t.navigationHelpButton){var Se=!0;try{if(s(window.localStorage)){var we=window.localStorage.getItem("pgEarth-hasSeenNavHelp");s(we)&&Boolean(we)?Se=!1:window.localStorage.setItem("pgEarth-hasSeenNavHelp","true")}}catch(e){}ce=new U({container:fe,instructionsInitiallyVisible:a(t.navigationInstructionsInitiallyVisible,Se)})}if(!s(t.animation)||!1!==t.animation){var Ce=document.createElement("div");Ce.className="pgEarth-viewer-animationContainer",n.appendChild(Ce),de=new I(Ce,new L(g))}if(!s(t.timeline)||!1!==t.timeline){var Te=document.createElement("div");Te.className="pgEarth-viewer-timelineContainer",n.appendChild(Te),(le=new J(Te,p)).addEventListener("settime",te,!1),le.zoomTo(p.startTime,p.stopTime)}if(s(t.fullscreenButton)&&!1===t.fullscreenButton||((pe=document.createElement("div")).className="pgEarth-viewer-fullscreenContainer",n.appendChild(pe),he=new W(pe,t.fullscreenElement),ue=K(he.viewModel,"isFullscreenEnabled",function(e){pe.style.display=e?"block":"none",s(le)&&(le.container.style.right=pe.clientWidth+"px",le.resize())})),t.vrButton){var Pe=document.createElement("div");Pe.className="pgEarth-viewer-vrContainer",n.appendChild(Pe),me=new Z(Pe,B,t.fullScreenElement),ge=K(me.viewModel,"isVREnabled",function(e){Pe.style.display=e?"block":"none",s(he)&&(Pe.style.right=pe.clientWidth+"px"),s(le)&&(le.container.style.right=Pe.clientWidth+"px",le.resize())}),_e=K(me.viewModel,"isVRMode",function(e){!function(e,t){var i=e._geocoder,o=e._homeButton,n=e._sceneModePicker,r=e._projectionPicker,a=e._baseLayerPicker,c=e._animation,d=e._timeline,l=e._fullscreenButton,h=e._infoBox,u=e._selectionIndicator,p=t?"hidden":"visible";if(s(i)&&(i.container.style.visibility=p),s(o)&&(o.container.style.visibility=p),s(n)&&(n.container.style.visibility=p),s(r)&&(r.container.style.visibility=p),s(a)&&(a.container.style.visibility=p),s(c)&&(c.container.style.visibility=p),s(d)&&(d.container.style.visibility=p),s(l)&&l.viewModel.isFullscreenEnabled&&(l.container.style.visibility=p),s(h)&&(h.container.style.visibility=p),s(u)&&(u.container.style.visibility=p),e._container){var m=t||!s(l)?0:l.container.clientWidth;e._vrButton.container.style.right=m+"px",e.forceResize()}}(o,e)})}this._baseLayerPickerDropDown=ae,this._fullscreenSubscription=ue,this._vrSubscription=ge,this._vrModeSubscription=_e,this._dataSourceChangedListeners={},this._automaticallyTrackDataSourceClocks=a(t.automaticallyTrackDataSourceClocks,!0),this._container=e,this._bottomContainer=d,this._element=n,this._pgEarthWidget=S,this._selectionIndicator=void 0,this._infoBox=P,this._dataSourceCollection=w,this._destroyDataSourceCollection=T,this._dataSourceDisplay=b,this._clockViewModel=g,this._destroyClockViewModel=y,this._toolbar=fe,this._homeButton=ee,this._sceneModePicker=oe,this._projectionPicker=ne,this._baseLayerPicker=re,this._navigationHelpButton=ce,this._animation=de,this._timeline=le,this._fullscreenButton=he,this._vrButton=me,this._geocoder=X,this._eventHelper=D,this._lastWidth=0,this._lastHeight=0,this._allowDataSourcesToSuspendAnimation=!0,this._entityView=void 0,this._enableInfoOrSelection=s(P)||s(void 0),this._clockTrackedDataSource=void 0,this._trackedEntity=void 0,this._needTrackedEntityUpdate=!1,this._selectedEntity=void 0,this._clockTrackedDataSource=void 0,this._forceResize=!1,this._zoomIsFlight=!1,this._zoomTarget=void 0,this._zoomPromise=void 0,this._zoomOptions=void 0,this._selectedEntityChanged=new h,this._trackedEntityChanged=new h,x.track(this,["_trackedEntity","_selectedEntity","_clockTrackedDataSource"]),D.add(w.dataSourceAdded,se.prototype._onDataSourceAdded,this),D.add(w.dataSourceRemoved,se.prototype._onDataSourceRemoved,this),D.add(B.postUpdate,se.prototype.resize,this),D.add(B.postRender,se.prototype._postRender,this);for(var Be=w.length,be=0;be<Be;be++)this._dataSourceAdded(w,w.get(be));this._dataSourceAdded(void 0,b.defaultDataSource),D.add(w.dataSourceAdded,se.prototype._dataSourceAdded,this),D.add(w.dataSourceRemoved,se.prototype._dataSourceRemoved,this),S.screenSpaceEventHandler.setInputAction(function(e){o.selectedEntity=ie(o,e)},f.LEFT_CLICK),S.screenSpaceEventHandler.setInputAction(function(e){var t=ie(o,e);s(t)?C.getValueOrUndefined(t.position,o.clock.currentTime)?o.trackedEntity=t:o.zoomTo(t):s(o.trackedEntity)&&(o.trackedEntity=void 0)},f.LEFT_DOUBLE_CLICK);var De={};De.defaultResetView=_.fromDegrees(90,17,130,45),De.enableCompass=!0,De.enableZoomControls=!0,De.enableDistanceLegend=!0,De.enableCompassOuterRing=!0;new $(this,De)}function ce(e,t,i,o){if(!s(t))throw new l("zoomTarget is required.");le(e);var n=M.defer();return e._zoomPromise=n,e._zoomIsFlight=o,e._zoomOptions=i,M(t,function(t){if(e._zoomPromise===n)if(t instanceof B)t.getViewableRectangle().then(function(t){return P(t,e.scene)}).then(function(t){e._zoomPromise===n&&(e._zoomTarget=t)});else if(t instanceof T)e._zoomTarget=t;else if(t instanceof D)e._zoomTarget=t;else if(t.isLoading&&s(t.loadingEvent))var i=t.loadingEvent.addEventListener(function(){i(),e._zoomPromise===n&&(e._zoomTarget=t.entities.values.slice(0))});else m(t)?e._zoomTarget=t.slice(0):(t=a(t.values,t),s(t.entities)&&(t=t.entities.values),m(t)?e._zoomTarget=t.slice(0):e._zoomTarget=[t])}),e.scene.requestRender(),n.promise}function de(e){e._zoomPromise=void 0,e._zoomTarget=void 0,e._zoomOptions=void 0}function le(e){var t=e._zoomPromise;s(t)&&(de(e),t.resolve(!1))}return c(se.prototype,{container:{get:function(){return this._container}},bottomContainer:{get:function(){return this._bottomContainer}},pgEarthWidget:{get:function(){return this._pgEarthWidget}},selectionIndicator:{get:function(){return this._selectionIndicator}},infoBox:{get:function(){return this._infoBox}},geocoder:{get:function(){return this._geocoder}},homeButton:{get:function(){return this._homeButton}},sceneModePicker:{get:function(){return this._sceneModePicker}},projectionPicker:{get:function(){return this._projectionPicker}},baseLayerPicker:{get:function(){return this._baseLayerPicker}},navigationHelpButton:{get:function(){return this._navigationHelpButton}},animation:{get:function(){return this._animation}},timeline:{get:function(){return this._timeline}},fullscreenButton:{get:function(){return this._fullscreenButton}},vrButton:{get:function(){return this._vrButton}},dataSourceDisplay:{get:function(){return this._dataSourceDisplay}},entities:{get:function(){return this._dataSourceDisplay.defaultDataSource.entities}},dataSources:{get:function(){return this._dataSourceCollection}},canvas:{get:function(){return this._pgEarthWidget.canvas}},scene:{get:function(){return this._pgEarthWidget.scene}},shadows:{get:function(){return this.scene.shadowMap.enabled},set:function(e){this.scene.shadowMap.enabled=e}},terrainShadows:{get:function(){return this.scene.globe.shadows},set:function(e){this.scene.globe.shadows=e}},shadowMap:{get:function(){return this.scene.shadowMap}},imageryLayers:{get:function(){return this.scene.imageryLayers}},terrainProvider:{get:function(){return this.scene.terrainProvider},set:function(e){this.scene.terrainProvider=e}},camera:{get:function(){return this.scene.camera}},postProcessStages:{get:function(){return this.scene.postProcessStages}},clock:{get:function(){return this._clockViewModel.clock}},clockViewModel:{get:function(){return this._clockViewModel}},screenSpaceEventHandler:{get:function(){return this._pgEarthWidget.screenSpaceEventHandler}},targetFrameRate:{get:function(){return this._pgEarthWidget.targetFrameRate},set:function(e){this._pgEarthWidget.targetFrameRate=e}},useDefaultRenderLoop:{get:function(){return this._pgEarthWidget.useDefaultRenderLoop},set:function(e){this._pgEarthWidget.useDefaultRenderLoop=e}},resolutionScale:{get:function(){return this._pgEarthWidget.resolutionScale},set:function(e){this._pgEarthWidget.resolutionScale=e,this._forceResize=!0}},allowDataSourcesToSuspendAnimation:{get:function(){return this._allowDataSourcesToSuspendAnimation},set:function(e){this._allowDataSourcesToSuspendAnimation=e}},trackedEntity:{get:function(){return this._trackedEntity},set:function(e){if(this._trackedEntity!==e){this._trackedEntity=e,le(this);var t=this.scene,i=t.mode;s(e)&&s(e.position)?this._needTrackedEntityUpdate=!0:(this._needTrackedEntityUpdate=!1,i!==b.COLUMBUS_VIEW&&i!==b.SCENE2D||(t.screenSpaceCameraController.enableTranslate=!0),i!==b.COLUMBUS_VIEW&&i!==b.SCENE3D||(t.screenSpaceCameraController.enableTilt=!0),this._entityView=void 0,this.camera.lookAtTransform(g.IDENTITY)),this._trackedEntityChanged.raiseEvent(e),this.scene.requestRender()}}},selectedEntity:{get:function(){return this._selectedEntity},set:function(e){if(this._selectedEntity!==e){this._selectedEntity=e;var t=s(this._selectionIndicator)?this._selectionIndicator.viewModel:void 0;s(e)?s(t)&&t.animateAppear():s(t)&&t.animateDepart(),this._selectedEntityChanged.raiseEvent(e)}}},selectedEntityChanged:{get:function(){return this._selectedEntityChanged}},trackedEntityChanged:{get:function(){return this._trackedEntityChanged}},clockTrackedDataSource:{get:function(){return this._clockTrackedDataSource},set:function(e){this._clockTrackedDataSource!==e&&(this._clockTrackedDataSource=e,oe(this._timeline,this.clock,e))}}}),se.prototype.extend=function(e,t){if(!s(e))throw new l("mixin is required.");e(this,t)},se.prototype.resize=function(){var e=this._pgEarthWidget,t=this._container,i=t.clientWidth,o=t.clientHeight,n=s(this._animation),r=s(this._timeline);if(this._forceResize||i!==this._lastWidth||o!==this._lastHeight){e.resize(),this._forceResize=!1;var a=o-125,c=this._baseLayerPickerDropDown;if(s(c)&&(c.style.maxHeight=a+"px"),s(this._geocoder))this._geocoder.searchSuggestionsContainer.style.maxHeight=a+"px";s(this._infoBox)&&(this._infoBox.viewModel.maxHeight=a);var d,l=this._timeline,h=0,u=0,p=0;if(n&&"hidden"!==window.getComputedStyle(this._animation.container).visibility){var m=this._lastWidth;d=this._animation.container,i>900?(h=169,m<=900&&(d.style.width="169px",d.style.height="112px",this._animation.resize())):i>=600?(h=136,(m<600||m>900)&&(d.style.width="136px",d.style.height="90px",this._animation.resize())):(h=106,(m>600||0===m)&&(d.style.width="106px",d.style.height="70px",this._animation.resize())),u=h+5}if(r&&"hidden"!==window.getComputedStyle(this._timeline.container).visibility){var g=this._fullscreenButton,_=this._vrButton,f=l.container,v=f.style;p=f.clientHeight+3,v.left=h+"px";var y=0;s(g)&&(y+=g.container.clientWidth),s(_)&&(y+=_.container.clientWidth),v.right=y+"px",l.resize()}this._bottomContainer.style.left=u+"px",this._bottomContainer.style.bottom=p+"px",this._lastWidth=i,this._lastHeight=o}},se.prototype.forceResize=function(){this._lastWidth=0,this.resize()},se.prototype.render=function(){this._pgEarthWidget.render()},se.prototype.isDestroyed=function(){return!1},se.prototype.destroy=function(){var e;this.screenSpaceEventHandler.removeInputAction(f.LEFT_CLICK),this.screenSpaceEventHandler.removeInputAction(f.LEFT_DOUBLE_CLICK);var t=this.dataSources,i=t.length;for(e=0;e<i;e++)this._dataSourceRemoved(t,t.get(e));return this._dataSourceRemoved(void 0,this._dataSourceDisplay.defaultDataSource),this._container.removeChild(this._element),this._element.removeChild(this._toolbar),this._eventHelper.removeAll(),s(this._geocoder)&&(this._geocoder=this._geocoder.destroy()),s(this._homeButton)&&(this._homeButton=this._homeButton.destroy()),s(this._sceneModePicker)&&(this._sceneModePicker=this._sceneModePicker.destroy()),s(this._projectionPicker)&&(this._projectionPicker=this._projectionPicker.destroy()),s(this._baseLayerPicker)&&(this._baseLayerPicker=this._baseLayerPicker.destroy()),s(this._animation)&&(this._element.removeChild(this._animation.container),this._animation=this._animation.destroy()),s(this._timeline)&&(this._timeline.removeEventListener("settime",te,!1),this._element.removeChild(this._timeline.container),this._timeline=this._timeline.destroy()),s(this._fullscreenButton)&&(this._fullscreenSubscription.dispose(),this._element.removeChild(this._fullscreenButton.container),this._fullscreenButton=this._fullscreenButton.destroy()),s(this._vrButton)&&(this._vrSubscription.dispose(),this._vrModeSubscription.dispose(),this._element.removeChild(this._vrButton.container),this._vrButton=this._vrButton.destroy()),s(this._infoBox)&&(this._element.removeChild(this._infoBox.container),this._infoBox=this._infoBox.destroy()),s(this._selectionIndicator)&&(this._element.removeChild(this._selectionIndicator.container),this._selectionIndicator=this._selectionIndicator.destroy()),this._destroyClockViewModel&&(this._clockViewModel=this._clockViewModel.destroy()),this._dataSourceDisplay=this._dataSourceDisplay.destroy(),this._pgEarthWidget=this._pgEarthWidget.destroy(),this._destroyDataSourceCollection&&(this._dataSourceCollection=this._dataSourceCollection.destroy()),d(this)},se.prototype._dataSourceAdded=function(e,t){t.entities.collectionChanged.addEventListener(se.prototype._onEntityCollectionChanged,this)},se.prototype._dataSourceRemoved=function(e,t){var i=t.entities;i.collectionChanged.removeEventListener(se.prototype._onEntityCollectionChanged,this),s(this.trackedEntity)&&i.getById(this.trackedEntity.id)===this.trackedEntity&&(this.trackedEntity=void 0),s(this.selectedEntity)&&i.getById(this.selectedEntity.id)===this.selectedEntity&&(this.selectedEntity=void 0)},se.prototype._onTick=function(e){var t=e.currentTime,o=this._dataSourceDisplay.update(t);this._allowDataSourcesToSuspendAnimation&&(this._clockViewModel.canAnimate=o);var n,r=this._entityView;if(s(r)){var c=this._trackedEntity;this._dataSourceDisplay.getBoundingSphere(c,!1,ee)===v.DONE&&r.update(t,ee)}var d=!1,l=this.selectedEntity,h=s(l)&&this._enableInfoOrSelection;h&&l.isShowing&&l.isAvailable(t)&&(this._dataSourceDisplay.getBoundingSphere(l,!0,ee)!==v.FAILED?n=ee.center:s(l.position)&&(n=l.position.getValue(t,n)),d=s(n));var u=s(this._selectionIndicator)?this._selectionIndicator.viewModel:void 0;s(u)&&(u.position=i.clone(n,u.position),u.showSelection=h&&d,u.update());var p=s(this._infoBox)?this._infoBox.viewModel:void 0;s(p)&&(p.showInfo=h&&l._description,p.enableCamera=d,p.isCameraTracking=this.trackedEntity===this.selectedEntity,h?(p.titleText=a(l.name,l.id),p.description=C.getValueOrDefault(l.description,t,"")):(p.titleText="",p.description=""))},se.prototype._onEntityCollectionChanged=function(e,t,i){for(var o=i.length,n=0;n<o;n++){var r=i[n];this.trackedEntity===r&&(this.trackedEntity=void 0),this.selectedEntity===r&&(this.selectedEntity=void 0)}},se.prototype._onInfoBoxCameraClicked=function(e){if(e.isCameraTracking&&this.trackedEntity===this.selectedEntity)this.trackedEntity=void 0;else{var t=this.selectedEntity.position;s(t)?this.trackedEntity=this.selectedEntity:this.zoomTo(this.selectedEntity)}},se.prototype._clearTrackedObject=function(){this.trackedEntity=void 0},se.prototype._onInfoBoxClockClicked=function(e){this.selectedEntity=void 0},se.prototype._clearObjects=function(){this.trackedEntity=void 0,this.selectedEntity=void 0},se.prototype._onDataSourceChanged=function(e){this.clockTrackedDataSource===e&&oe(this.timeline,this.clock,e)},se.prototype._onDataSourceAdded=function(e,t){this._automaticallyTrackDataSourceClocks&&(this.clockTrackedDataSource=t);var i=t.entities.id,o=this._eventHelper.add(t.changedEvent,se.prototype._onDataSourceChanged,this);this._dataSourceChangedListeners[i]=o},se.prototype._onDataSourceRemoved=function(e,t){var i=this.clockTrackedDataSource===t,o=t.entities.id;if(this._dataSourceChangedListeners[o](),this._dataSourceChangedListeners[o]=void 0,i){var n=e.length;this._automaticallyTrackDataSourceClocks&&n>0?this.clockTrackedDataSource=e.get(n-1):this.clockTrackedDataSource=void 0}},se.prototype.zoomTo=function(e,t){return ce(this,e,{offset:t},!1)},se.prototype.flyTo=function(e,t){return ce(this,e,t,!0)},se.prototype._postRender=function(){!function(t){var i=t._zoomTarget;if(!s(i)||t.scene.mode===b.MORPHING)return;var o,r,c=t.scene,d=c.camera,l=t._zoomPromise,h=a(t._zoomOptions,{});if(i instanceof T)return i.readyPromise.then(function(){var e=i.boundingSphere;s(h.offset)||(h.offset=new p(0,-.5,e.radius)),o={offset:h.offset,duration:h.duration,maximumHeight:h.maximumHeight,complete:function(){l.resolve(!0)},cancel:function(){l.resolve(!1)}},t._zoomIsFlight?d.flyToBoundingSphere(i.boundingSphere,o):(d.viewBoundingSphere(e,h.offset),d.lookAtTransform(g.IDENTITY),l.resolve(!0)),de(t)});if(i instanceof D)return i.readyPromise.then(function(){var e=i.boundingSphere;s(h.offset)||(h.offset=new p(0,-.5,e.radius)),o={offset:h.offset,duration:h.duration,maximumHeight:h.maximumHeight,complete:function(){l.resolve(!0)},cancel:function(){l.resolve(!1)}},t._zoomIsFlight?d.flyToBoundingSphere(e,o):(d.viewBoundingSphere(e,h.offset),d.lookAtTransform(g.IDENTITY),l.resolve(!0)),de(t)});if(i instanceof n)return o={destination:c.mapProjection.ellipsoid.cartographicToCartesian(i),duration:h.duration,maximumHeight:h.maximumHeight,complete:function(){l.resolve(!0)},cancel:function(){l.resolve(!1)}},t._zoomIsFlight?d.flyTo(o):(d.setView(o),l.resolve(!0)),void de(t);for(var u=i,m=[],_=0,f=u.length;_<f;_++){var y=t._dataSourceDisplay.getBoundingSphere(u[_],!1,ee);if(y===v.PENDING)return;y!==v.FAILED&&m.push(e.clone(ee))}if(0===m.length)return void le(t);t.trackedEntity=void 0,r=e.fromBoundingSpheres(m),t._zoomIsFlight?(de(t),d.flyToBoundingSphere(r,{duration:h.duration,maximumHeight:h.maximumHeight,complete:function(){l.resolve(!0)},cancel:function(){l.resolve(!1)},offset:h.offset})):(d.viewBoundingSphere(r,h.offset),d.lookAtTransform(g.IDENTITY),de(t),l.resolve(!0))}(this),function(e){if(!e._needTrackedEntityUpdate)return;var t=e._trackedEntity,i=e.clock.currentTime,o=C.getValueOrUndefined(t.position,i);if(!s(o))return;var n=e.scene,r=e._dataSourceDisplay.getBoundingSphere(t,!1,ee);if(r===v.PENDING)return;var a=n.mode;a!==b.COLUMBUS_VIEW&&a!==b.SCENE2D||(n.screenSpaceCameraController.enableTranslate=!1);a!==b.COLUMBUS_VIEW&&a!==b.SCENE3D||(n.screenSpaceCameraController.enableTilt=!1);var c=r!==v.FAILED?ee:void 0;e._entityView=new w(t,n,n.mapProjection.ellipsoid),e._entityView.update(i,c),e._needTrackedEntityUpdate=!1}(this)},se});