define(["../../Core/Cartesian3","../../Core/Cartographic","../../Core/Color","../../Core/defineProperties","../../Core/Math","../../Scene/BlendOption","../../Scene/HorizontalOrigin","../../Scene/LabelCollection","../../Scene/LabelStyle","../../Scene/PointPrimitiveCollection","../../Scene/VerticalOrigin","../../DataSources/CallbackProperty","../../DataSources/PolylineGlowMaterialProperty","../../DataSources/PolylineOutlineMaterialProperty","./support/MeasureStatus","./support/MeasureUnit","./support/PickGlobe","../../Core/ScreenSpaceEventHandler","../../Core/ScreenSpaceEventType"],function(t,e,i,s,o,n,r,a,l,h,d,u,c,p,E,D,_,g,f){"use strict";function w(s){this.viewer=s,this.scene=s.scene,this._enable=!1,this.startDraw=!1,this._vertical=0,this._horizon=0,this._slantDistance=0,this._measureUnit=D.METER,this.startPoint=new t(0,0,0),this.endPoint=new t(0,0,0),this.eMeasureStatus=E.M_NONE,this._pointCollection=new h({blendOption:n.TRANSLUCENT}),this._labelCollection=new a({blendOption:n.TRANSLUCENT,depthMask:!1}),this.startEllipsoid=this._pointCollection.add({name:"",position:this.startPoint,pixelSize:5,color:i.RED,disableDepthTestDistance:1e4}),this.endEllipsoid=this._pointCollection.add({name:"",position:this.endPoint,pixelSize:5,color:i.RED,disableDepthTestDistance:1e4}),this.midEllipsoid=this._pointCollection.add({name:"",position:t.ZERO,pixelSize:5,color:i.RED,disableDepthTestDistance:1e4}),this.entity1=this._labelCollection.add({show:!0,showBackground:!0,font:"36px KaiTi",fillColor:i.WHITE,outlineColor:i.BACK,outlineWidth:5,style:l.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}),this.entity2=this._labelCollection.add({show:!0,showBackground:!0,font:"36px KaiTi",fillColor:i.WHITE,outlineColor:i.BACK,outlineWidth:5,style:l.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5}),this.entity3=this._labelCollection.add({show:!0,showBackground:!0,font:"36px KaiTi",fillColor:i.WHITE,outlineColor:i.BACK,outlineWidth:5,style:l.FILL_AND_OUTLINE,horizontalOrigin:r.CENTER,verticalOrigin:d.BASELINE,disableDepthTestDistance:1e4,scale:.5});var w=this;this.triangleLine=s.entities.add({name:"",polyline:{positions:new u(function(){var i=[];if(w.eMeasureStatus==E.M_END||w.eMeasureStatus==E.M_MEASUREING){var s=e.fromCartesian(w.startPoint),n=e.fromCartesian(w.endPoint);if(void 0!=s&&void 0!=n)if(n.height>s.height){var r=o.toDegrees(s.longitude),a=o.toDegrees(s.latitude);i.push(w.startPoint,t.fromDegrees(r,a,n.height),w.endPoint,w.startPoint)}else{r=o.toDegrees(n.longitude),a=o.toDegrees(n.latitude);i.push(w.startPoint,t.fromDegrees(r,a,s.height),w.endPoint,w.startPoint)}}return i},!1),followSurface:!1,width:3,material:new c({glowPower:.5,color:i.YELLOW}),depthFailMaterial:new p({color:i.RED,outlineWidth:2,outlineColor:i.BLACK})}}),this.scene.primitives.add(this),this.pickGlobe=new _(this.viewer),this.clickDraw=new g(this.scene.canvas),this.clickDraw.setInputAction(function(t){w._enable=!0,w.addPoint3D(t)},f.LEFT_CLICK),this.moveDraw=new g(this.scene.canvas),this.moveDraw.setInputAction(function(t){w.addPointTemp(t)},f.MOUSE_MOVE)}function C(i){var s=e.fromCartesian(i.endPoint),n=o.toDegrees(s.longitude),r=o.toDegrees(s.latitude),a=s.height,l=e.fromCartesian(i.startPoint),h=o.toDegrees(l.longitude),d=o.toDegrees(l.latitude),u=l.height,c=t.distance(i.startPoint,t.fromDegrees(h,d,a)),p=t.distance(i.endPoint,t.fromDegrees(h,d,a)),E=t.distance(i.startPoint,i.endPoint);a>u?(i.entity1.position=t.fromDegrees(h,d,(u+a)/2),i.entity2.position=t.fromDegrees((h+n)/2,(d+r)/2,a)):(i.entity1.position=t.fromDegrees(n,r,(u+a)/2),i.entity2.position=t.fromDegrees((h+n)/2,(d+r)/2,u)),i._vertical=c.toFixed(2),i.entity1.show=!0,2==i._measureUnit?i.entity1.text=c.toFixed(2)+"米":3==i._measureUnit&&(i.entity1.text=(c/1e3).toFixed(2)+"千米"),i.entity2.show=!0,i._horizon=p.toFixed(2),2==i._measureUnit?i.entity2.text=p.toFixed(2)+"米":3==i._measureUnit&&(i.entity2.text=(p/1e3).toFixed(2)+"千米"),i.entity3.position=t.fromDegrees((h+n)/2,(d+r)/2,(a+u)/2),i.entity3.show=!0,i._slantDistance=E.toFixed(2),2==i._measureUnit?i.entity3.text=E.toFixed(2)+"米":3==i._measureUnit&&(i.entity3.text=(E/1e3).toFixed(2)+"千米")}return s(w.prototype,{enable:{get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t)}},vertical:{get:function(){return this._vertical}},horizon:{get:function(){return this._horizon}},slantDistance:{get:function(){return this._slantDistance}},unit:{get:function(){return this._measureUnit},set:function(t){switch(t){case 2:this._measureUnit=D.METER;break;case 3:this._measureUnit=D.KILOMETER;break;default:this._measureUnit=D.METER}}}}),w.prototype.addPoint3D=function(t){if(this._enable&&this.eMeasureStatus!=E.M_END){if(this.eMeasureStatus==E.M_NONE){this.eMeasureStatus=E.M_BEGIN;var e=this.pickGlobe.pickGlobe(t.position);if(void 0==e)return;this.startPoint=this.startEllipsoid.position=e}this.eMeasureStatus==E.M_MEASUREING&&(this.eMeasureStatus=E.M_END),this.eMeasureStatus==E.M_END&&(C(this),this._enable=!1)}},w.prototype.addPointTemp=function(i){if(this._enable&&(this.eMeasureStatus==E.M_BEGIN&&(this.endEllipsoid.show=!0,this.startEllipsoid.show=!0,this.midEllipsoid.show=!0,this.entity1.show=!0,this.entity2.show=!0,this.entity3.show=!0,this.triangleLine.show=!0,this.eMeasureStatus=E.M_MEASUREING),this.eMeasureStatus==E.M_MEASUREING)){var s=this.pickGlobe.pickGlobe(i.endPosition);if(void 0==s)return;this.endPoint=this.endEllipsoid.position=s,this.midEllipsoid.position=function(i){if(i.eMeasureStatus==E.M_END||i.eMeasureStatus==E.M_MEASUREING){var s=e.fromCartesian(i.startPoint),n=e.fromCartesian(i.endPoint);if(void 0!=s&&void 0!=n){if(n.height>s.height){var r=o.toDegrees(s.longitude),a=o.toDegrees(s.latitude);return t.fromDegrees(r,a,n.height)}return r=o.toDegrees(n.longitude),a=o.toDegrees(n.latitude),t.fromDegrees(r,a,s.height)}}}(this),this.eMeasureStatus=E.M_MEASUREING,C(this)}},w.prototype.clear=function(){this._enable=!1,this.endEllipsoid.show=!1,this.startEllipsoid.show=!1,this.midEllipsoid.show=!1,this.entity1.show=!1,this.entity2.show=!1,this.entity3.show=!1,this.triangleLine.show=!1,this.eMeasureStatus=E.M_NONE,this.clickDraw&&!this.clickDraw.isDestroyed()&&this.clickDraw.destroy(),this.moveDraw&&!this.moveDraw.isDestroyed()&&this.moveDraw.destroy()},w.prototype.update=function(t){this._pointCollection.update(t),this._labelCollection.update(t)},w.prototype._destroy=function(){this._pointCollection=this._pointCollection.destroy(),this._labelCollection=this._labelCollection.destroy()},w});