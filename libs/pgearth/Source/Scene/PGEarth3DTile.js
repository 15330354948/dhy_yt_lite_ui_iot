define(["../Core/BoundingSphere","../Core/Cartesian3","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/CullingVolume","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/deprecationWarning","../Core/destroyObject","../Core/Ellipsoid","../Core/getMagic","../Core/Intersect","../Core/JulianDate","../Core/Math","../Core/Matrix3","../Core/Matrix4","../Core/OrientedBoundingBox","../Core/OrthographicFrustum","../Core/Rectangle","../Core/Request","../Core/RequestScheduler","../Core/RequestState","../Core/RequestType","../Core/Resource","../Core/RuntimeError","../Core/Transforms","../ThirdParty/when","./PGEarth3DTileContentFactory","./PGEarth3DTileContentState","./PGEarth3DTileOptimizationHint","./PGEarth3DTilePass","./PGEarth3DTileRefine","./Empty3DTileContent","./SceneMode","./TileBoundingRegion","./TileBoundingSphere","./TileOrientedBoundingBox"],function(e,t,i,n,o,r,s,u,a,c,d,l,h,m,p,_,g,f,y,v,V,b,S,C,E,R,D,P,T,w,B,x,I,q,L,A,O,M){"use strict";function F(e,t,n,o){this._tileset=e,this._header=n;var r=n.content;this.transform=s(n.transform)?g.unpack(n.transform):g.clone(g.IDENTITY);var u,a,c,d,l,h,p,_,f=s(o)?o.computedTransform:e.modelMatrix,y=g.multiply(f,this.transform,new g),v=s(o)?o._initialTransform:g.IDENTITY;if(this._initialTransform=g.multiply(v,this.transform,new g),this.computedTransform=y,this._boundingVolume=this.createBoundingVolume(n.boundingVolume,y),this._boundingVolume2D=void 0,s(r)&&s(r.boundingVolume)&&(u=this.createBoundingVolume(r.boundingVolume,y)),this._contentBoundingVolume=u,this._contentBoundingVolume2D=void 0,s(n.viewerRequestVolume)&&(a=this.createBoundingVolume(n.viewerRequestVolume,y)),this._viewerRequestVolume=a,this.geometricError=n.geometricError,s(this.geometricError)||(this.geometricError=s(o)?o.geometricError:e._geometricError,F._deprecationWarning("geometricErrorUndefined","Required property geometricError is undefined for this tile. Using parent's geometric error instead.")),s(n.refine)?("replace"!==n.refine&&"add"!==n.refine||F._deprecationWarning("lowercase-refine",'This tile uses a lowercase refine "'+n.refine+'". Instead use "'+n.refine.toUpperCase()+'".'),c="REPLACE"===n.refine.toUpperCase()?I.REPLACE:I.ADD):c=s(o)?o.refine:I.REPLACE,this.refine=c,this.children=[],this.parent=o,t=E.createIfNeeded(t),s(r)){var V=r.uri;s(r.url)&&(F._deprecationWarning("contentUrl",'This tileset JSON uses the "content.url" property which has been deprecated. Use "content.uri" instead.'),V=r.url),l=!1,h=w.UNLOADED,p=t.getDerivedResource({url:V}),_=b.getServerKey(p.getUrlComponent())}else d=new q(e,this),l=!0,h=w.READY;this._content=d,this._contentResource=p,this._contentState=h,this._contentReadyToProcessPromise=void 0,this._contentReadyPromise=void 0,this._expiredContent=void 0,this._serverKey=_,this.hasEmptyContent=l,this.hasTilesetContent=!1,this.cacheNode=void 0;var S,C,R=n.expire;s(R)&&(S=R.duration,s(R.date)&&(C=m.fromIso8601(R.date))),this.expireDuration=S,this.expireDate=C,this.lastStyleTime=0,this._optimChildrenWithinParent=B.NOT_COMPUTED,this.clippingPlanesDirty=!1,this.priorityDeferred=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._screenSpaceErrorProgressiveResolution=0,this._visibilityPlaneMask=0,this._visible=!1,this._inRequestVolume=!1,this._finalResolution=!0,this._depth=0,this._stackLength=0,this._selectionDepth=0,this._updatedVisibilityFrame=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._ancestorWithContent=void 0,this._ancestorWithContentAvailable=void 0,this._refines=!1,this._shouldSelect=!1,this._isClipped=!0,this._clippingPlanesState=0,this._debugBoundingVolume=void 0,this._debugContentBoundingVolume=void 0,this._debugViewerRequestVolume=void 0,this._debugColor=i.fromRandom({alpha:1}),this._debugColorizeTiles=!1,this._priority=0,this._priorityHolder=this,this._priorityProgressiveResolution=!1,this._priorityProgressiveResolutionScreenSpaceErrorLeaf=!1,this._priorityReverseScreenSpaceError=0,this._foveatedFactor=0,this._wasMinPriorityChild=!1,this._loadTimestamp=new m,this._commandsLength=0,this._color=void 0,this._colorDirty=!1,this._request=void 0}F._deprecationWarning=a,u(F.prototype,{tileset:{get:function(){return this._tileset}},content:{get:function(){return this._content}},boundingVolume:{get:function(){return this._boundingVolume}},contentBoundingVolume:{get:function(){return r(this._contentBoundingVolume,this._boundingVolume)}},boundingSphere:{get:function(){return this._boundingVolume.boundingSphere}},extras:{get:function(){return this._header.extras}},color:{get:function(){return s(this._color)||(this._color=new i),i.clone(this._color)},set:function(e){this._color=i.clone(e,this._color),this._colorDirty=!0}},contentAvailable:{get:function(){return this.contentReady&&!this.hasEmptyContent&&!this.hasTilesetContent||s(this._expiredContent)&&!this.contentFailed}},contentReady:{get:function(){return this._contentState===w.READY}},contentUnloaded:{get:function(){return this._contentState===w.UNLOADED}},contentExpired:{get:function(){return this._contentState===w.EXPIRED}},contentFailed:{get:function(){return this._contentState===w.FAILED}},contentReadyToProcessPromise:{get:function(){if(s(this._contentReadyToProcessPromise))return this._contentReadyToProcessPromise.promise}},contentReadyPromise:{get:function(){if(s(this._contentReadyPromise))return this._contentReadyPromise.promise}},commandsLength:{get:function(){return this._commandsLength}}});var N=new t;var W=new m;F.prototype.getScreenSpaceError=function(e,t,i){var n=this._tileset,o=r(i,1),u=s(this.parent)?this.parent.geometricError:n._geometricError,a=t?u:this.geometricError;if(0===a)return 0;var c,d=e.camera,l=d.frustum,h=e.context,m=h.drawingBufferWidth,_=h.drawingBufferHeight*o;if(e.mode===L.SCENE2D||l instanceof y){s(l._offCenterFrustum)&&(l=l._offCenterFrustum),c=a/(Math.max(l.top-l.bottom,l.right-l.left)/Math.max(m,_))}else{var g=Math.max(this._distanceToCamera,p.EPSILON7);if(c=a*_/(g*d.frustum.sseDenominator),n.dynamicScreenSpaceError){var f=n._dynamicScreenSpaceErrorComputedDensity,v=n.dynamicScreenSpaceErrorFactor;c-=p.fog(g,f)*v}}return c},F.prototype.updateVisibility=function(e){var i=this.parent,n=this._tileset,r=s(i)?i.computedTransform:n.modelMatrix,u=s(i)?i._visibilityPlaneMask:o.MASK_INDETERMINATE;this.updateTransform(r),this._distanceToCamera=this.distanceToTile(e),this._centerZDepth=this.distanceToTileCenter(e),this._screenSpaceError=this.getScreenSpaceError(e,!1),this._screenSpaceErrorProgressiveResolution=this.getScreenSpaceError(e,!1,n.progressiveResolutionHeightFraction),this._visibilityPlaneMask=this.visibility(e,u),this._visible=this._visibilityPlaneMask!==o.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(e),this._priorityReverseScreenSpaceError=function(e,t){var i=t.parent,n=!s(i)||e._skipLevelOfDetail&&0!==t._screenSpaceError&&!i.hasTilesetContent?t._screenSpaceError:i._screenSpaceError;return e.root._screenSpaceError-n}(n,this),this._priorityProgressiveResolution=function(e,t){if(e.progressiveResolutionHeightFraction<=0||e.progressiveResolutionHeightFraction>.5)return!1;var i=t._screenSpaceErrorProgressiveResolution>e._maximumScreenSpaceError;t._priorityProgressiveResolutionScreenSpaceErrorLeaf=!1;var n=t.parent,o=e._maximumScreenSpaceError,r=t._screenSpaceErrorProgressiveResolution<=o,u=s(n)&&n._screenSpaceErrorProgressiveResolution>o;return r&&u&&(t._priorityProgressiveResolutionScreenSpaceErrorLeaf=!0,i=!0),i}(n,this),this.priorityDeferred=function(e,i){var n=e._tileset,o=i.camera,r=e.boundingSphere,u=r.radius,a=t.multiplyByScalar(o.directionWC,e._centerZDepth,N),c=t.add(o.positionWC,a,N),d=t.subtract(c,r.center,N);if(t.magnitude(d)>u){var l=t.normalize(d,N),h=t.multiplyByScalar(l,u,N),m=t.add(r.center,h,N),_=t.subtract(m,o.positionWC,N),g=t.normalize(_,N);e._foveatedFactor=1-Math.abs(t.dot(o.directionWC,g))}else e._foveatedFactor=0;var f=e.refine===I.REPLACE,y=n._skipLevelOfDetail;if(f&&!y||!n.foveatedScreenSpaceError||1===n.foveatedConeSize||e._priorityProgressiveResolution&&f&&y||n._pass===x.PRELOAD_FLIGHT||n._pass===x.PRELOAD)return!1;var v=1-Math.cos(.5*o.frustum.fov),V=n.foveatedConeSize*v;if(e._foveatedFactor<=V)return!1;var b=v-V,S=p.clamp((e._foveatedFactor-V)/b,0,1),C=n.foveatedInterpolationCallback(n.foveatedMinimumScreenSpaceErrorRelaxation,n.maximumScreenSpaceError,S),E=0===e._screenSpaceError&&s(e.parent)?.5*e.parent._screenSpaceError:e._screenSpaceError;return n.maximumScreenSpaceError-C<=E}(this,e)},F.prototype.updateExpiration=function(){if(s(this.expireDate)&&this.contentReady&&!this.hasEmptyContent){var e=m.now(W);m.lessThan(this.expireDate,e)&&(this._contentState=w.EXPIRED,this._expiredContent=this._content)}},F.prototype.requestContent=function(){var e=this,t=this._tileset;if(this.hasEmptyContent)return!1;var i=this._contentResource.clone(),n=this.contentExpired;n&&i.setQueryParameters({expired:this.expireDate.toString()});var o,r=new V({throttle:!0,throttleByServer:!0,type:C.TILES3D,priorityFunction:(o=this,function(){return o._priority}),serverKey:this._serverKey});this._request=r,i.request=r;var u=i.fetchArrayBuffer();if(!s(u))return!1;var a=this._contentState;this._contentState=w.LOADING,this._contentReadyToProcessPromise=P.defer(),this._contentReadyPromise=P.defer(),n&&(this.expireDate=void 0);var c=function(e){return function(t){e._contentState=w.FAILED,e._contentReadyPromise.reject(t),e._contentReadyToProcessPromise.reject(t)}}(this);return u.then(function(i){if(!e.isDestroyed()){var n,o=new Uint8Array(i),r=l(o),u=T[r];return t._disableSkipLevelOfDetail=t._disableSkipLevelOfDetail||"vctr"===r||"geom"===r,s(u)?n=u(t,e,e._contentResource,i,0):(n=T.json(t,e,e._contentResource,i,0),e.hasTilesetContent=!0),e._content=n,e._contentState=w.PROCESSING,e._contentReadyToProcessPromise.resolve(n),n.readyPromise.then(function(t){e.isDestroyed()?c():(!function(e){if(s(e.expireDuration)){var t=m.now(W);m.addSeconds(t,e.expireDuration,t),s(e.expireDate)?m.lessThan(e.expireDate,t)&&m.clone(t,e.expireDate):e.expireDate=m.clone(t)}}(e),e._selectedFrame=0,e.lastStyleTime=0,m.now(e._loadTimestamp),e._contentState=w.READY,e._contentReadyPromise.resolve(t))})}c()}).otherwise(function(i){if(r.state===S.CANCELLED)return e._contentState=a,--t.statistics.numberOfPendingRequests,void++t.statistics.numberOfAttemptedRequests;c(i)}),!0},F.prototype.unloadContent=function(){this.hasEmptyContent||this.hasTilesetContent||(this._content=this._content&&this._content.destroy(),this._contentState=w.UNLOADED,this._contentReadyToProcessPromise=void 0,this._contentReadyPromise=void 0,this.lastStyleTime=0,this.clippingPlanesDirty=0===this._clippingPlanesState,this._clippingPlanesState=0,this._debugColorizeTiles=!1,this._debugBoundingVolume=this._debugBoundingVolume&&this._debugBoundingVolume.destroy(),this._debugContentBoundingVolume=this._debugContentBoundingVolume&&this._debugContentBoundingVolume.destroy(),this._debugViewerRequestVolume=this._debugViewerRequestVolume&&this._debugViewerRequestVolume.destroy())};var U=new e;function k(t,i){if(i.mode!==L.SCENE3D&&!s(t._boundingVolume2D)){var n=t._boundingVolume.boundingSphere,o=e.projectTo2D(n,i.mapProjection,U);t._boundingVolume2D=new O(o.center,o.radius)}return i.mode!==L.SCENE3D?t._boundingVolume2D:t._boundingVolume}F.prototype.visibility=function(e,t){var i=e.cullingVolume,n=k(this,e),r=this._tileset,u=r.clippingPlanes;if(s(u)&&u.enabled){var a=u.computeIntersectionWithBoundingVolume(n,r.clippingPlanesOriginMatrix);if(this._isClipped=a!==h.INSIDE,a===h.OUTSIDE)return o.MASK_OUTSIDE}return i.computeVisibilityWithPlaneMask(n,t)},F.prototype.contentVisibility=function(t){if(!s(this._contentBoundingVolume))return h.INSIDE;if(this._visibilityPlaneMask===o.MASK_INSIDE)return h.INSIDE;var i=t.cullingVolume,n=function(t,i){if(i.mode!==L.SCENE3D&&!s(t._contentBoundingVolume2D)){var n=t._contentBoundingVolume.boundingSphere,o=e.projectTo2D(n,i.mapProjection,U);t._contentBoundingVolume2D=new O(o.center,o.radius)}return i.mode!==L.SCENE3D?t._contentBoundingVolume2D:t._contentBoundingVolume}(this,t),r=this._tileset,u=r.clippingPlanes;if(s(u)&&u.enabled){var a=u.computeIntersectionWithBoundingVolume(n,r.clippingPlanesOriginMatrix);if(this._isClipped=a!==h.INSIDE,a===h.OUTSIDE)return h.OUTSIDE}return i.computeVisibility(n)},F.prototype.distanceToTile=function(e){return k(this,e).distanceToCamera(e)};var z=new t;F.prototype.distanceToTileCenter=function(e){var i=k(this,e).boundingVolume,n=t.subtract(i.center,e.camera.positionWC,z);return t.dot(e.camera.directionWC,n)},F.prototype.insideViewerRequestVolume=function(e){var t=this._viewerRequestVolume;return!s(t)||0===t.distanceToCamera(e)};var H=new _,G=new t,K=new _,Y=new t,j=new v,Z=new f,J=new g;function X(e,t,i,n){if(!g.equalsEpsilon(t,i,p.EPSILON8))return function(e,t,i,n){var o=v.unpack(e,0,j),r=e[4],u=e[5],a=f.fromRectangle(o,r,u,d.WGS84,Z),c=a.center,l=a.halfAxes;t=g.multiplyTransformation(t,g.inverseTransformation(i,J),J),c=g.multiplyByPoint(t,c,c);var h=g.getRotation(t,H);return l=_.multiply(h,l,l),s(n)&&n instanceof M?(n.update(c,l),n):new M(c,l)}(e,t,i,n);if(s(n))return n;var o=v.unpack(e,0,j);return new A({rectangle:o,minimumHeight:e[4],maximumHeight:e[5]})}F.prototype.createBoundingVolume=function(e,i,n){if(!s(e))throw new R("boundingVolume must be defined");if(s(e.box))return function(e,i,n){var o=t.fromElements(e[0],e[1],e[2],Y),r=_.fromArray(e,3,K);o=g.multiplyByPoint(i,o,o);var u=g.getRotation(i,H);return r=_.multiply(u,r,r),s(n)?(n.update(o,r),n):new M(o,r)}(e.box,i,n);if(s(e.region))return X(e.region,i,this._initialTransform,n);if(s(e.sphere))return function(e,i,n){var o=t.fromElements(e[0],e[1],e[2],Y),r=e[3];o=g.multiplyByPoint(i,o,o);var u=g.getScale(i,G);return r*=t.maximumComponent(u),s(n)?(n.update(o,r),n):new O(o,r)}(e.sphere,i,n);throw new R("boundingVolume must contain a sphere, region, or box")},F.prototype.updateTransform=function(e){e=r(e,g.IDENTITY);var t=g.multiply(e,this.transform,J);if(!g.equals(t,this.computedTransform)){g.clone(t,this.computedTransform);var i=this._header,n=this._header.content;this._boundingVolume=this.createBoundingVolume(i.boundingVolume,this.computedTransform,this._boundingVolume),s(this._contentBoundingVolume)&&(this._contentBoundingVolume=this.createBoundingVolume(n.boundingVolume,this.computedTransform,this._contentBoundingVolume)),s(this._viewerRequestVolume)&&(this._viewerRequestVolume=this.createBoundingVolume(i.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)),this._debugBoundingVolume=this._debugBoundingVolume&&this._debugBoundingVolume.destroy(),this._debugContentBoundingVolume=this._debugContentBoundingVolume&&this._debugContentBoundingVolume.destroy(),this._debugViewerRequestVolume=this._debugViewerRequestVolume&&this._debugViewerRequestVolume.destroy()}},F.prototype.update=function(e,t){var o=t.commandList.length;!function(e,t){var i=t.clippingPlanes,n=0;s(i)&&e._isClipped&&i.enabled&&(n=i.clippingPlanesState),n!==e._clippingPlanesState&&(e._clippingPlanesState=n,e.clippingPlanesDirty=!0)}(this,e),function(e,t,o){if(o.passes.render){var r=s(e._header.content)&&s(e._header.content.boundingVolume),u=e.hasEmptyContent||e.hasTilesetContent,a=t.debugShowBoundingVolume||t.debugShowContentBoundingVolume&&!r;if(a){var c;c=e._finalResolution?u?i.DARKGRAY:i.WHITE:i.YELLOW,s(e._debugBoundingVolume)||(e._debugBoundingVolume=e._boundingVolume.createDebugVolume(c)),e._debugBoundingVolume.update(o);var d=e._debugBoundingVolume.getGeometryInstanceAttributes("outline");d.color=n.toValue(c,d.color)}else!a&&s(e._debugBoundingVolume)&&(e._debugBoundingVolume=e._debugBoundingVolume.destroy());t.debugShowContentBoundingVolume&&r?(s(e._debugContentBoundingVolume)||(e._debugContentBoundingVolume=e._contentBoundingVolume.createDebugVolume(i.BLUE)),e._debugContentBoundingVolume.update(o)):!t.debugShowContentBoundingVolume&&s(e._debugContentBoundingVolume)&&(e._debugContentBoundingVolume=e._debugContentBoundingVolume.destroy()),t.debugShowViewerRequestVolume&&s(e._viewerRequestVolume)?(s(e._debugViewerRequestVolume)||(e._debugViewerRequestVolume=e._viewerRequestVolume.createDebugVolume(i.YELLOW)),e._debugViewerRequestVolume.update(o)):!t.debugShowViewerRequestVolume&&s(e._debugViewerRequestVolume)&&(e._debugViewerRequestVolume=e._debugViewerRequestVolume.destroy());var l=t.debugColorizeTiles&&!e._debugColorizeTiles||s(t._heatmap.tilePropertyName),h=!t.debugColorizeTiles&&e._debugColorizeTiles;l?(t._heatmap.colorize(e,o),e._debugColorizeTiles=!0,e.color=e._debugColor):h&&(e._debugColorizeTiles=!1,e.color=i.WHITE),e._colorDirty&&(e._colorDirty=!1,e._content.applyDebugSettings(!0,e._color)),h&&t.makeStyleDirty()}}(this,e,t),function(e,t,i){var n=e._content,o=e._expiredContent;if(s(o)){if(!e.contentReady)return void o.update(t,i);e._expiredContent.destroy(),e._expiredContent=void 0}n.update(t,i)}(this,e,t),this._commandsLength=t.commandList.length-o,this.clippingPlanesDirty=!1};var Q=[];function $(e,t,i){var n=e*Math.pow(10,t);return parseInt(n)*Math.pow(10,i)}function ee(e,t,i){return Math.max(p.normalize(e,t,i)-p.EPSILON7,0)}return F.prototype.process=function(e,t){var i=t.commandList;t.commandList=Q,this._content.update(e,t),Q.length=0,t.commandList=i},F.prototype.updatePriority=function(){var e=this.tileset,t=e.preferLeaves,i=e._minimumPriority,n=e._maximumPriority,o=Math.pow(10,8),r=Math.pow(10,9),s=Math.pow(10,10),u=ee(this._depth,i.depth,n.depth);u=t?1-u:u;var a=$(!e._skipLevelOfDetail&&this.refine===I.REPLACE?ee(this._priorityHolder._distanceToCamera,i.distance,n.distance):ee(this._priorityReverseScreenSpaceError,i.reverseScreenSpaceError,n.reverseScreenSpaceError),4,0),c=this._priorityProgressiveResolution?0:o,d=$(ee(this._priorityHolder._foveatedFactor,i.foveatedFactor,n.foveatedFactor),4,4),l=this.priorityDeferred?r:0,h=e._pass===x.PRELOAD_FLIGHT?0:s;this._priority=u+a+c+d+l+h},F.prototype.isDestroyed=function(){return!1},F.prototype.destroy=function(){return this._content=this._content&&this._content.destroy(),this._expiredContent=this._expiredContent&&!this._expiredContent.isDestroyed()&&this._expiredContent.destroy(),this._debugBoundingVolume=this._debugBoundingVolume&&this._debugBoundingVolume.destroy(),this._debugContentBoundingVolume=this._debugContentBoundingVolume&&this._debugContentBoundingVolume.destroy(),this._debugViewerRequestVolume=this._debugViewerRequestVolume&&this._debugViewerRequestVolume.destroy(),c(this)},F});