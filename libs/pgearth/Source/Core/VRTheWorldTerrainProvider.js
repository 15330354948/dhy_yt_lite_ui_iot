define(["../ThirdParty/when","./Credit","./defaultValue","./defined","./defineProperties","./DeveloperError","./Ellipsoid","./Event","./GeographicTilingScheme","./getImagePixels","./HeightmapTerrainData","./Math","./Rectangle","./Resource","./TerrainProvider","./TileProviderError"],function(e,t,r,i,n,a,o,s,l,h,u,g,c,m,d,f){"use strict";function p(e,t){this.rectangle=e,this.maxLevel=t}function v(n){if(n=r(n,r.EMPTY_OBJECT),!i(n.url))throw new a("options.url is required.");var h=m.createIfNeeded(n.url);this._resource=h,this._errorEvent=new s,this._ready=!1,this._readyPromise=e.defer(),this._terrainDataStructure={heightScale:.001,heightOffset:-1e3,elementsPerHeight:3,stride:4,elementMultiplier:256,isBigEndian:!0,lowestEncodedHeight:0,highestEncodedHeight:16777215};var u=n.credit;"string"==typeof u&&(u=new t(u)),this._credit=u,this._tilingScheme=void 0,this._rectangles=[];var v,_=this,y=r(n.ellipsoid,o.WGS84);function E(e){var t=e.getElementsByTagName("SRS")[0].textContent;if("EPSG:4326"===t){_._tilingScheme=new l({ellipsoid:y});var r=e.getElementsByTagName("TileFormat")[0];_._heightmapWidth=parseInt(r.getAttribute("width"),10),_._heightmapHeight=parseInt(r.getAttribute("height"),10),_._levelZeroMaximumGeometricError=d.getEstimatedLevelZeroGeometricErrorForAHeightmap(y,Math.min(_._heightmapWidth,_._heightmapHeight),_._tilingScheme.getNumberOfXTilesAtLevel(0));for(var i=e.getElementsByTagName("DataExtent"),n=0;n<i.length;++n){var a=i[n],o=g.toRadians(parseFloat(a.getAttribute("minx"))),s=g.toRadians(parseFloat(a.getAttribute("miny"))),h=g.toRadians(parseFloat(a.getAttribute("maxx"))),u=g.toRadians(parseFloat(a.getAttribute("maxy"))),m=parseInt(a.getAttribute("maxlevel"),10);_._rectangles.push(new p(new c(o,s,h,u),m))}_._ready=!0,_._readyPromise.resolve(!0)}else T("SRS "+t+" is not supported.")}function T(e){var t=r(e,"An error occurred while accessing "+_._resource.url+".");v=f.handleError(v,_,_._errorEvent,t,void 0,void 0,void 0,w)}function w(){e(_._resource.fetchXML(),E,T)}w()}n(v.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){return this._credit}},tilingScheme:{get:function(){if(!this.ready)throw new a("requestTileGeometry must not be called before ready returns true.");return this._tilingScheme}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},hasWaterMask:{get:function(){return!1}},hasVertexNormals:{get:function(){return!1}}}),v.prototype.requestTileGeometry=function(t,r,n,o){if(!this.ready)throw new a("requestTileGeometry must not be called before ready returns true.");var s=this._tilingScheme.getNumberOfYTilesAtLevel(n),l=this._resource.getDerivedResource({url:n+"/"+t+"/"+(s-r-1)+".tif",queryParameters:{pgEarth:!0},request:o}).fetchImage({preferImageBitmap:!0});if(i(l)){var g=this;return e(l).then(function(e){return new u({buffer:h(e),width:g._heightmapWidth,height:g._heightmapHeight,childTileMask:function(e,t,r,n){for(var a=e._tilingScheme,o=e._rectangles,s=a.tileXYToRectangle(t,r,n),l=0,h=0;h<o.length&&15!==l;++h){var u=o[h];if(!(u.maxLevel<=n)){var g=u.rectangle,m=c.intersection(g,s,_);i(m)&&(y(a,g,2*t,2*r,n+1)&&(l|=4),y(a,g,2*t+1,2*r,n+1)&&(l|=8),y(a,g,2*t,2*r+1,n+1)&&(l|=1),y(a,g,2*t+1,2*r+1,n+1)&&(l|=2))}}return l}(g,t,r,n),structure:g._terrainDataStructure})})}},v.prototype.getLevelMaximumGeometricError=function(e){if(!this.ready)throw new a("requestTileGeometry must not be called before ready returns true.");return this._levelZeroMaximumGeometricError/(1<<e)};var _=new c;function y(e,t,r,n,a){var o=e.tileXYToRectangle(r,n,a);return i(c.intersection(o,t,_))}return v.prototype.getTileDataAvailable=function(e,t,r){},v.prototype.loadTileDataAvailability=function(e,t,r){},v});