define(["./arrayFill","./arrayRemoveDuplicates","./BoundingSphere","./Cartesian3","./Cartographic","./Check","./ComponentDatatype","./CornerType","./CorridorGeometryLibrary","./defaultValue","./defined","./defineProperties","./Ellipsoid","./Geometry","./GeometryAttribute","./GeometryAttributes","./GeometryOffsetAttribute","./IndexDatatype","./Math","./PolygonPipeline","./PrimitiveType","./Rectangle","./VertexFormat"],function(t,e,r,a,i,o,n,s,l,d,u,h,g,f,m,c,p,v,y,A,b,_,w){"use strict";var T=new a,N=new a,E=new a,P=new a,F=new a,I=new a,O=new a,x=new a;function M(t,e){for(var r=0;r<t.length;r++)t[r]=e.scaleToGeodeticSurface(t[r],t[r]);return t}function D(t,e,r,i,o,n){var s=t.normals,d=t.tangents,u=t.bitangents,h=a.normalize(a.cross(r,e,O),O);n.normal&&l.addAttribute(s,e,i,o),n.tangent&&l.addAttribute(d,h,i,o),n.bitangent&&l.addAttribute(u,r,i,o)}function S(t,e,r){var i,o,s,d=t.positions,h=t.corners,g=t.endPositions,f=t.lefts,p=t.normals,A=new c,b=0,_=0,w=0;for(o=0;o<d.length;o+=2)b+=s=d[o].length-3,w+=2*s,_+=d[o+1].length-3;for(b+=3,_+=3,o=0;o<h.length;o++){i=h[o];var F=h[o].leftPositions;u(F)?(b+=s=F.length,w+=s):(_+=s=h[o].rightPositions.length,w+=s)}var M,S=u(g);S&&(b+=M=g[0].length-3,_+=M,w+=6*(M/=3));var V,L,k,G,R,C,H=b+_,z=new Float64Array(H),U={normals:e.normal?new Float32Array(H):void 0,tangents:e.tangent?new Float32Array(H):void 0,bitangents:e.bitangent?new Float32Array(H):void 0},B=0,Y=H-1,W=T,q=N,J=M/2,j=v.createTypedArray(H/3,w),K=0;if(S){C=E,R=P;var Q=g[0];for(W=a.fromArray(p,0,W),q=a.fromArray(f,0,q),o=0;o<J;o++)C=a.fromArray(Q,3*(J-1-o),C),R=a.fromArray(Q,3*(J+o),R),l.addAttribute(z,R,B),l.addAttribute(z,C,void 0,Y),D(U,W,q,B,Y,e),G=(L=B/3)+1,k=(V=(Y-2)/3)-1,j[K++]=V,j[K++]=L,j[K++]=k,j[K++]=k,j[K++]=L,j[K++]=G,B+=3,Y-=3}var X,Z,$=0,tt=0,et=d[$++],rt=d[$++];for(z.set(et,B),z.set(rt,Y-rt.length+1),q=a.fromArray(f,tt,q),s=rt.length-3,o=0;o<s;o+=3)X=r.geodeticSurfaceNormal(a.fromArray(et,o,O),O),Z=r.geodeticSurfaceNormal(a.fromArray(rt,s-o,x),x),D(U,W=a.normalize(a.add(X,Z,W),W),q,B,Y,e),G=(L=B/3)+1,k=(V=(Y-2)/3)-1,j[K++]=V,j[K++]=L,j[K++]=k,j[K++]=k,j[K++]=L,j[K++]=G,B+=3,Y-=3;for(X=r.geodeticSurfaceNormal(a.fromArray(et,s,O),O),Z=r.geodeticSurfaceNormal(a.fromArray(rt,s,x),x),W=a.normalize(a.add(X,Z,W),W),tt+=3,o=0;o<h.length;o++){var at,it,ot,nt=(i=h[o]).leftPositions,st=i.rightPositions,lt=I,dt=E,ut=P;if(W=a.fromArray(p,tt,W),u(nt)){for(D(U,W,q,void 0,Y,e),Y-=3,it=G,ot=k,at=0;at<nt.length/3;at++)lt=a.fromArray(nt,3*at,lt),j[K++]=it,j[K++]=ot-at-1,j[K++]=ot-at,l.addAttribute(z,lt,void 0,Y),dt=a.fromArray(z,3*(ot-at-1),dt),ut=a.fromArray(z,3*it,ut),D(U,W,q=a.normalize(a.subtract(dt,ut,q),q),void 0,Y,e),Y-=3;lt=a.fromArray(z,3*it,lt),dt=a.subtract(a.fromArray(z,3*ot,dt),lt,dt),ut=a.subtract(a.fromArray(z,3*(ot-at),ut),lt,ut),D(U,W,q=a.normalize(a.add(dt,ut,q),q),B,void 0,e),B+=3}else{for(D(U,W,q,B,void 0,e),B+=3,it=k,ot=G,at=0;at<st.length/3;at++)lt=a.fromArray(st,3*at,lt),j[K++]=it,j[K++]=ot+at,j[K++]=ot+at+1,l.addAttribute(z,lt,B),dt=a.fromArray(z,3*it,dt),ut=a.fromArray(z,3*(ot+at),ut),D(U,W,q=a.normalize(a.subtract(dt,ut,q),q),B,void 0,e),B+=3;lt=a.fromArray(z,3*it,lt),dt=a.subtract(a.fromArray(z,3*(ot+at),dt),lt,dt),ut=a.subtract(a.fromArray(z,3*ot,ut),lt,ut),D(U,W,q=a.normalize(a.negate(a.add(ut,dt,q),q),q),void 0,Y,e),Y-=3}for(et=d[$++],rt=d[$++],et.splice(0,3),rt.splice(rt.length-3,3),z.set(et,B),z.set(rt,Y-rt.length+1),s=rt.length-3,tt+=3,q=a.fromArray(f,tt,q),at=0;at<rt.length;at+=3)X=r.geodeticSurfaceNormal(a.fromArray(et,at,O),O),Z=r.geodeticSurfaceNormal(a.fromArray(rt,s-at,x),x),D(U,W=a.normalize(a.add(X,Z,W),W),q,B,Y,e),L=(G=B/3)-1,V=(k=(Y-2)/3)+1,j[K++]=V,j[K++]=L,j[K++]=k,j[K++]=k,j[K++]=L,j[K++]=G,B+=3,Y-=3;B-=3,Y+=3}if(D(U,W=a.fromArray(p,p.length-3,W),q,B,Y,e),S){B+=3,Y-=3,C=E,R=P;var ht=g[1];for(o=0;o<J;o++)C=a.fromArray(ht,3*(M-o-1),C),R=a.fromArray(ht,3*o,R),l.addAttribute(z,C,void 0,Y),l.addAttribute(z,R,B),D(U,W,q,B,Y,e),L=(G=B/3)-1,V=(k=(Y-2)/3)+1,j[K++]=V,j[K++]=L,j[K++]=k,j[K++]=k,j[K++]=L,j[K++]=G,B+=3,Y-=3}if(A.position=new m({componentDatatype:n.DOUBLE,componentsPerAttribute:3,values:z}),e.st){var gt,ft,mt=new Float32Array(H/3*2),ct=0;if(S){b/=3,_/=3;var pt,vt=Math.PI/(M+1);ft=1/(b-M+1),gt=1/(_-M+1);var yt=M/2;for(o=yt+1;o<M+1;o++)pt=y.PI_OVER_TWO+vt*o,mt[ct++]=gt*(1+Math.cos(pt)),mt[ct++]=.5*(1+Math.sin(pt));for(o=1;o<_-M+1;o++)mt[ct++]=o*gt,mt[ct++]=0;for(o=M;o>yt;o--)pt=y.PI_OVER_TWO-o*vt,mt[ct++]=1-gt*(1+Math.cos(pt)),mt[ct++]=.5*(1+Math.sin(pt));for(o=yt;o>0;o--)pt=y.PI_OVER_TWO-vt*o,mt[ct++]=1-ft*(1+Math.cos(pt)),mt[ct++]=.5*(1+Math.sin(pt));for(o=b-M;o>0;o--)mt[ct++]=o*ft,mt[ct++]=1;for(o=1;o<yt+1;o++)pt=y.PI_OVER_TWO+vt*o,mt[ct++]=ft*(1+Math.cos(pt)),mt[ct++]=.5*(1+Math.sin(pt))}else{for(ft=1/((b/=3)-1),gt=1/((_/=3)-1),o=0;o<_;o++)mt[ct++]=o*gt,mt[ct++]=0;for(o=b;o>0;o--)mt[ct++]=(o-1)*ft,mt[ct++]=1}A.st=new m({componentDatatype:n.FLOAT,componentsPerAttribute:2,values:mt})}return e.normal&&(A.normal=new m({componentDatatype:n.FLOAT,componentsPerAttribute:3,values:U.normals})),e.tangent&&(A.tangent=new m({componentDatatype:n.FLOAT,componentsPerAttribute:3,values:U.tangents})),e.bitangent&&(A.bitangent=new m({componentDatatype:n.FLOAT,componentsPerAttribute:3,values:U.bitangents})),{attributes:A,indices:j}}function V(t,e,r){r[e++]=t[0],r[e++]=t[1],r[e++]=t[2];for(var a=3;a<t.length;a+=3){var i=t[a],o=t[a+1],n=t[a+2];r[e++]=i,r[e++]=o,r[e++]=n,r[e++]=i,r[e++]=o,r[e++]=n}return r[e++]=t[0],r[e++]=t[1],r[e++]=t[2],r}function L(e,r){var i=new w({position:r.position,normal:r.normal||r.bitangent||e.shadowVolume,tangent:r.tangent,bitangent:r.normal||r.bitangent,st:r.st}),o=e.ellipsoid,s=S(l.computePositions(e),i,o),d=e.height,h=e.extrudedHeight,g=s.attributes,f=s.indices,c=g.position.values,y=c.length,b=new Float64Array(6*y),_=new Float64Array(y);_.set(c);var O,x=new Float64Array(4*y);x=V(c=A.scaleToGeodeticHeight(c,d,o),0,x),x=V(_=A.scaleToGeodeticHeight(_,h,o),2*y,x),b.set(c),b.set(_,y),b.set(x,2*y),g.position.values=b,g=function(t,e){if(!(e.normal||e.tangent||e.bitangent||e.st))return t;var r,i,o=t.position.values;(e.normal||e.bitangent)&&(r=t.normal.values,i=t.bitangent.values);var n,s=t.position.values.length/18,d=3*s,u=2*s,h=2*d;if(e.normal||e.bitangent||e.tangent){var g=e.normal?new Float32Array(6*d):void 0,f=e.tangent?new Float32Array(6*d):void 0,m=e.bitangent?new Float32Array(6*d):void 0,c=T,p=N,v=E,y=P,A=F,b=I,_=h;for(n=0;n<d;n+=3){var w=_+h;c=a.fromArray(o,n,c),p=a.fromArray(o,n+d,p),v=a.fromArray(o,(n+3)%d,v),p=a.subtract(p,c,p),v=a.subtract(v,c,v),y=a.normalize(a.cross(p,v,y),y),e.normal&&(l.addAttribute(g,y,w),l.addAttribute(g,y,w+3),l.addAttribute(g,y,_),l.addAttribute(g,y,_+3)),(e.tangent||e.bitangent)&&(b=a.fromArray(r,n,b),e.bitangent&&(l.addAttribute(m,b,w),l.addAttribute(m,b,w+3),l.addAttribute(m,b,_),l.addAttribute(m,b,_+3)),e.tangent&&(A=a.normalize(a.cross(b,y,A),A),l.addAttribute(f,A,w),l.addAttribute(f,A,w+3),l.addAttribute(f,A,_),l.addAttribute(f,A,_+3))),_+=6}if(e.normal){for(g.set(r),n=0;n<d;n+=3)g[n+d]=-r[n],g[n+d+1]=-r[n+1],g[n+d+2]=-r[n+2];t.normal.values=g}else t.normal=void 0;if(e.bitangent?(m.set(i),m.set(i,d),t.bitangent.values=m):t.bitangent=void 0,e.tangent){var O=t.tangent.values;f.set(O),f.set(O,d),t.tangent.values=f}}if(e.st){var x=t.st.values,M=new Float32Array(6*u);M.set(x),M.set(x,u);for(var D=2*u,S=0;S<2;S++){for(M[D++]=x[0],M[D++]=x[1],n=2;n<u;n+=2){var V=x[n],L=x[n+1];M[D++]=V,M[D++]=L,M[D++]=V,M[D++]=L}M[D++]=x[0],M[D++]=x[1]}t.st.values=M}return t}(g,r);var M=y/3;if(e.shadowVolume){var D=g.normal.values;y=D.length;var L=new Float32Array(6*y);for(O=0;O<y;O++)D[O]=-D[O];L.set(D,y),L=V(D,4*y,L),g.extrudeDirection=new m({componentDatatype:n.FLOAT,componentsPerAttribute:3,values:L}),r.normal||(g.normal=void 0)}if(u(e.offsetAttribute)){var k=new Uint8Array(6*M);if(e.offsetAttribute===p.TOP)k=t(k,1,0,M),k=t(k,1,2*M,4*M);else{var G=e.offsetAttribute===p.NONE?0:1;k=t(k,G)}g.applyOffset=new m({componentDatatype:n.UNSIGNED_BYTE,componentsPerAttribute:1,values:k})}var R=f.length,C=M+M,H=v.createTypedArray(b.length/3,2*R+3*C);H.set(f);var z,U,B,Y,W=R;for(O=0;O<R;O+=3){var q=f[O],J=f[O+1],j=f[O+2];H[W++]=j+M,H[W++]=J+M,H[W++]=q+M}for(O=0;O<C;O+=2)B=(z=O+C)+1,Y=(U=z+C)+1,H[W++]=z,H[W++]=U,H[W++]=B,H[W++]=B,H[W++]=U,H[W++]=Y;return{attributes:g,indices:H}}var k=new a,G=new a,R=new i;function C(t,e,r,i,o,n){var s=a.subtract(e,t,k);a.normalize(s,s);var l=r.geodeticSurfaceNormal(t,G),d=a.cross(s,l,k);a.multiplyByScalar(d,i,d);var u=o.latitude,h=o.longitude,g=n.latitude,f=n.longitude;a.add(t,d,G),r.cartesianToCartographic(G,R);var m=R.latitude,c=R.longitude;u=Math.min(u,m),h=Math.min(h,c),g=Math.max(g,m),f=Math.max(f,c),a.subtract(t,d,G),r.cartesianToCartographic(G,R),m=R.latitude,c=R.longitude,u=Math.min(u,m),h=Math.min(h,c),g=Math.max(g,m),f=Math.max(f,c),o.latitude=u,o.longitude=h,n.latitude=g,n.longitude=f}var H=new a,z=new a,U=new i,B=new i;function Y(t,r,i,o,n){t=M(t,r);var l=e(t,a.equalsEpsilon),d=l.length;if(d<2||i<=0)return new _;var h,g,f=.5*i;if(U.latitude=Number.POSITIVE_INFINITY,U.longitude=Number.POSITIVE_INFINITY,B.latitude=Number.NEGATIVE_INFINITY,B.longitude=Number.NEGATIVE_INFINITY,o===s.ROUNDED){var m=l[0];a.subtract(m,l[1],H),a.normalize(H,H),a.multiplyByScalar(H,f,H),a.add(m,H,z),r.cartesianToCartographic(z,R),h=R.latitude,g=R.longitude,U.latitude=Math.min(U.latitude,h),U.longitude=Math.min(U.longitude,g),B.latitude=Math.max(B.latitude,h),B.longitude=Math.max(B.longitude,g)}for(var c=0;c<d-1;++c)C(l[c],l[c+1],r,f,U,B);var p=l[d-1];a.subtract(p,l[d-2],H),a.normalize(H,H),a.multiplyByScalar(H,f,H),a.add(p,H,z),C(p,z,r,f,U,B),o===s.ROUNDED&&(r.cartesianToCartographic(z,R),h=R.latitude,g=R.longitude,U.latitude=Math.min(U.latitude,h),U.longitude=Math.min(U.longitude,g),B.latitude=Math.max(B.latitude,h),B.longitude=Math.max(B.longitude,g));var v=u(n)?n:new _;return v.north=B.latitude,v.south=U.latitude,v.east=B.longitude,v.west=U.longitude,v}function W(t){var e=(t=d(t,d.EMPTY_OBJECT)).positions,r=t.width;o.defined("options.positions",e),o.defined("options.width",r);var i=d(t.height,0),n=d(t.extrudedHeight,i);this._positions=e,this._ellipsoid=g.clone(d(t.ellipsoid,g.WGS84)),this._vertexFormat=w.clone(d(t.vertexFormat,w.DEFAULT)),this._width=r,this._height=Math.max(i,n),this._extrudedHeight=Math.min(i,n),this._cornerType=d(t.cornerType,s.ROUNDED),this._granularity=d(t.granularity,y.RADIANS_PER_DEGREE),this._shadowVolume=d(t.shadowVolume,!1),this._workerName="createCorridorGeometry",this._offsetAttribute=t.offsetAttribute,this._rectangle=void 0,this.packedLength=1+e.length*a.packedLength+g.packedLength+w.packedLength+7}W.pack=function(t,e,r){o.defined("value",t),o.defined("array",e),r=d(r,0);var i=t._positions,n=i.length;e[r++]=n;for(var s=0;s<n;++s,r+=a.packedLength)a.pack(i[s],e,r);return g.pack(t._ellipsoid,e,r),r+=g.packedLength,w.pack(t._vertexFormat,e,r),r+=w.packedLength,e[r++]=t._width,e[r++]=t._height,e[r++]=t._extrudedHeight,e[r++]=t._cornerType,e[r++]=t._granularity,e[r++]=t._shadowVolume?1:0,e[r]=d(t._offsetAttribute,-1),e};var q=g.clone(g.UNIT_SPHERE),J=new w,j={positions:void 0,ellipsoid:q,vertexFormat:J,width:void 0,height:void 0,extrudedHeight:void 0,cornerType:void 0,granularity:void 0,shadowVolume:void 0,offsetAttribute:void 0};return W.unpack=function(t,e,r){o.defined("array",t),e=d(e,0);for(var i=t[e++],n=new Array(i),s=0;s<i;++s,e+=a.packedLength)n[s]=a.unpack(t,e);var l=g.unpack(t,e,q);e+=g.packedLength;var h=w.unpack(t,e,J);e+=w.packedLength;var f=t[e++],m=t[e++],c=t[e++],p=t[e++],v=t[e++],y=1===t[e++],A=t[e];return u(r)?(r._positions=n,r._ellipsoid=g.clone(l,r._ellipsoid),r._vertexFormat=w.clone(h,r._vertexFormat),r._width=f,r._height=m,r._extrudedHeight=c,r._cornerType=p,r._granularity=v,r._shadowVolume=y,r._offsetAttribute=-1===A?void 0:A,r):(j.positions=n,j.width=f,j.height=m,j.extrudedHeight=c,j.cornerType=p,j.granularity=v,j.shadowVolume=y,j.offsetAttribute=-1===A?void 0:A,new W(j))},W.computeRectangle=function(t,e){var r=(t=d(t,d.EMPTY_OBJECT)).positions,a=t.width;return o.defined("options.positions",r),o.defined("options.width",a),Y(r,d(t.ellipsoid,g.WGS84),a,d(t.cornerType,s.ROUNDED),e)},W.createGeometry=function(i){var o=i._positions,s=i._width,d=i._ellipsoid;o=M(o,d);var h=e(o,a.equalsEpsilon);if(!(h.length<2||s<=0)){var g,c=i._height,v=i._extrudedHeight,_=!y.equalsEpsilon(c,v,0,y.EPSILON2),w=i._vertexFormat,T={ellipsoid:d,positions:h,width:s,cornerType:i._cornerType,granularity:i._granularity,saveAttributes:!0};if(_)T.height=c,T.extrudedHeight=v,T.shadowVolume=i._shadowVolume,T.offsetAttribute=i._offsetAttribute,g=L(T,w);else if((g=S(l.computePositions(T),w,d)).attributes.position.values=A.scaleToGeodeticHeight(g.attributes.position.values,c,d),u(i._offsetAttribute)){var N=i._offsetAttribute===p.NONE?0:1,E=g.attributes.position.values.length,P=new Uint8Array(E/3);t(P,N),g.attributes.applyOffset=new m({componentDatatype:n.UNSIGNED_BYTE,componentsPerAttribute:1,values:P})}var F=g.attributes,I=r.fromVertices(F.position.values,void 0,3);return w.position||(g.attributes.position.values=void 0),new f({attributes:F,indices:g.indices,primitiveType:b.TRIANGLES,boundingSphere:I,offsetAttribute:i._offsetAttribute})}},W.createShadowVolume=function(t,e,r){var a=t._granularity,i=t._ellipsoid,o=e(a,i),n=r(a,i);return new W({positions:t._positions,width:t._width,cornerType:t._cornerType,ellipsoid:i,granularity:a,extrudedHeight:o,height:n,vertexFormat:w.POSITION_ONLY,shadowVolume:!0})},h(W.prototype,{rectangle:{get:function(){return u(this._rectangle)||(this._rectangle=Y(this._positions,this._ellipsoid,this._width,this._cornerType)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){return[0,0,0,1,1,0]}}}),W});