define(["../ThirdParty/protobuf-minimal","../ThirdParty/when","./buildModuleUrl","./Check","./Credit","./defaultValue","./defined","./defineProperties","./GoogleEarthEnterpriseTileInformation","./isBitSet","./loadAndExecuteScript","./Math","./Request","./Resource","./RuntimeError","./TaskProcessor"],function(e,r,t,n,o,i,a,u,s,l,f,h,d,c,g,v){"use strict";var y=function(e){for(var r=e.length,t=new ArrayBuffer(r),n=new Uint8Array(t),o=0;o<r;++o)n[o]=e.charCodeAt(o);return t}('Eô½\vyâjE",ÍqøIFgQ\0B%Æèa,f)\bÆ4Üjb%y\nwmiÖðk¡½NuàA[ß@V\fÙ»r|3SîOlÔq°{ÀEVZ­wUe\v3*¬l5Å0sø3>mF8J´Ýð.ÝuÚDt"úa"\f3"So¯9D\v9Ù9L¹¿«\\P_"uxéqh;ÁÄð<VqH\'UfYNeu£aF}a?A\0×´4MÎF°Õ¸\'{Ü+»Mg0ÈÑö\\Pú[/Fn5/\'C.ë\n\f^¥se4ål.jC\'c#U©?q{gC}:¯ÍâTUýKÆâ/(íË\\Æ-f§;/*"N°k.Ý\r}}GºC²²+>Mª>}æÎIÆæx\fa1-¤O¥~q ì\r1èN\v\0nPh}=\b\r¦n£h$[kó#ó¶s³\r\v@ÀØQ]ú".jßI\0¹ wUÆïj¿{GLîÜÜF©­S+S4ÿYä8è1N¹XFkË-#p\x005"Ï1²&/çÃu-6,rt°#G·ÓÑ&7râ\0DÏÚ3-Þ`i#i*|ÍKQ\rT9w.)ê¦P¢joP\\>TûïP[\vEm(w7ÛJfJo åpâ¹q~\fmI-zþrÇòY0»]såÉ êxì ðB|G`°½&·q¶ÇÑ3=Ó«îcÈ+S D\\qÆÌD2O<ÊÀ)=RÓaX©}e´ÜÏ\rô=ñ\b©BÚ#\tØ¿^PIøMÀËGLO÷{+ØÅ1;µoÜl\rÑÛ?âéÚ_ÔâFaZÞUÏ¤\0¾ýÎgñJiæ HØ]~®q N®ÀV©<rçvì)IÖ]-ãÛ6©;fjÕ¶=P^R¹KÇsWxÉô.YoÐKW>\'\'Ç`Û;íSD>?mw¢\në?R¨ÆU^1I7ôÅ&-©¿\'TÚÃj å*x°Öprªh½÷_H±~ÀXL?fù>áeÀp§Ï8i¯ðVldI\'­xtOÂÞV9\0Úw\vË-û5Oõ\bQ`Á\nZGM&30xÚÀFGâ[y`In7gS\n>éìF9²ñ4\rÆSuná\fYÙÞ){II¥wy¾IV.6ç\v:»Ob{ÒM1/½8{¨O!áìFpv})"x\nÝ\\ÚÞQÏðüYRe|3ßóHÚ»*uÛ`²Ôüíì5¨ÿ(1-ÈÜF|["');function p(u){n.defined("resourceOrUrl",u);var s=u;"string"==typeof s||s instanceof c||(n.typeOf.string("resourceOrUrl.url",u.url),s=u.url);var l=c.createIfNeeded(s);l.appendForwardSlash(),this._resource=l,this.imageryPresent=!0,this.protoImagery=void 0,this.terrainPresent=!0,this.negativeAltitudeExponentBias=32,this.negativeAltitudeThreshold=h.EPSILON12,this.providers={},this.key=void 0,this._quadPacketVersion=1,this._tileInfo={},this._subtreePromises={};var d=this;this._readyPromise=function(r){var n=r._resource.getDerivedResource({url:"dbRoot.v5",queryParameters:{output:"proto"}});if(!a(P)){var u=t("ThirdParty/google-earth-dbroot-parser.js"),s=window.pgEarthGoogleEarthDbRootParser;P=f(u).then(function(){b=window.pgEarthGoogleEarthDbRootParser(e),a(s)?window.pgEarthGoogleEarthDbRootParser=s:delete window.pgEarthGoogleEarthDbRootParser})}return P.then(function(){return n.fetchArrayBuffer()}).then(function(e){var t=b.EncryptedDbRootProto.decode(new Uint8Array(e)),n=t.encryptionData,o=n.byteOffset,i=o+n.byteLength,a=r.key=n.buffer.slice(o,i);n=t.dbrootData,o=n.byteOffset,i=o+n.byteLength;var u=n.buffer.slice(o,i);return I.scheduleTask({buffer:u,type:"DbRoot",key:a},[u])}).then(function(e){var t=b.DbRootProto.decode(new Uint8Array(e.buffer));if(r.imageryPresent=i(t.imageryPresent,r.imageryPresent),r.protoImagery=t.protoImagery,r.terrainPresent=i(t.terrainPresent,r.terrainPresent),a(t.endSnippet)&&a(t.endSnippet.model)){var n=t.endSnippet.model;r.negativeAltitudeExponentBias=i(n.negativeAltitudeExponentBias,r.negativeAltitudeExponentBias),r.negativeAltitudeThreshold=i(n.compressedNegativeAltitudeThreshold,r.negativeAltitudeThreshold)}a(t.databaseVersion)&&(r._quadPacketVersion=i(t.databaseVersion.quadtreeVersion,r._quadPacketVersion));for(var u=r.providers,s=i(t.providerInfo,[]),l=s.length,f=0;f<l;++f){var h=s[f],d=h.copyrightString;a(d)&&(u[h.providerId]=new o(d.value))}}).otherwise(function(){console.log("Failed to retrieve "+n.url+". Using defaults."),r.key=y})}(this).then(function(){return d.getQuadTreePacket("",d._quadPacketVersion)}).then(function(){return!0}).otherwise(function(e){var t="An error occurred while accessing "+m(d,"",1).url+".";return r.reject(new g(t))})}u(p.prototype,{url:{get:function(){return this._resource.url}},proxy:{get:function(){return this._resource.proxy}},resource:{get:function(){return this._resource}},readyPromise:{get:function(){return this._readyPromise}}}),p.tileXYToQuadKey=function(e,r,t){for(var n="",o=t;o>=0;--o){var i=1<<o,a=0;l(r,i)?l(e,i)&&(a|=1):(a|=2,l(e,i)||(a|=1)),n+=a}return n},p.quadKeyToTileXY=function(e){for(var r=0,t=0,n=e.length-1,o=n;o>=0;--o){var i=1<<o,a=+e[n-o];l(a,2)?l(a,1)||(r|=i):(t|=i,l(a,1)&&(r|=i))}return{x:r,y:t,level:n}},p.prototype.isValid=function(e){var r=this.getTileInformationFromQuadKey(e);if(a(r))return null!==r;for(var t,n=!0,o=e;o.length>1;){if(t=o.substring(o.length-1),o=o.substring(0,o.length-1),r=this.getTileInformationFromQuadKey(o),a(r)){r.hasSubtree()||r.hasChild(parseInt(t))||(n=!1);break}if(null===r){n=!1;break}}return n};var b,P,I=new v("decodeGoogleEarthEnterprisePacket",Number.POSITIVE_INFINITY);function m(e,r,t,n){return e._resource.getDerivedResource({url:"flatfile?q2-0"+r+"-q."+t.toString(),request:n})}return p.prototype.getQuadTreePacket=function(e,r,t){r=i(r,1);var n=m(this,e=i(e,""),r,t).fetchArrayBuffer();if(a(n)){var o=this._tileInfo,u=this.key;return n.then(function(r){return I.scheduleTask({buffer:r,quadKey:e,type:"Metadata",key:u},[r]).then(function(r){var t,n=-1;if(""!==e){n=e.length+1;var i=r[e];(t=o[e])._bits|=i._bits,delete r[e]}var a=Object.keys(r);a.sort(function(e,r){return e.length-r.length});for(var u=a.length,l=0;l<u;++l){var f=a[l];if(null!==r[f]){var h=s.clone(r[f]),d=f.length;if(d===n)h.setParent(t);else if(d>1){var c=o[f.substring(0,f.length-1)];h.setParent(c)}o[f]=h}else o[f]=null}})})}},p.prototype.populateSubtree=function(e,t,n,o){return function e(t,n,o){var i=t._tileInfo;var u=n;var s=i[u];if(a(s)&&(!s.hasSubtree()||s.hasChildren()))return s;for(;void 0===s&&u.length>1;)u=u.substring(0,u.length-1),s=i[u];var l;var f=t._subtreePromises;var h=f[u];if(a(h))return h.then(function(){return l=new d({throttle:o.throttle,throttleByServer:o.throttleByServer,type:o.type,priorityFunction:o.priorityFunction}),e(t,n,l)});if(!a(s)||!s.hasSubtree())return r.reject(new g("Couldn't load metadata for tile "+n));h=t.getQuadTreePacket(u,s.cnodeVersion,o);if(!a(h))return;f[u]=h;return h.then(function(){return l=new d({throttle:o.throttle,throttleByServer:o.throttleByServer,type:o.type,priorityFunction:o.priorityFunction}),e(t,n,l)}).always(function(){delete f[u]})}(this,p.tileXYToQuadKey(e,t,n),o)},p.prototype.getTileInformation=function(e,r,t){var n=p.tileXYToQuadKey(e,r,t);return this._tileInfo[n]},p.prototype.getTileInformationFromQuadKey=function(e){return this._tileInfo[e]},p});