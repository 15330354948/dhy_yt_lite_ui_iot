define(["../Core/AssociativeArray","../Core/Cartesian3","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defined","../Core/DistanceDisplayCondition","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/OffsetGeometryInstanceAttribute","../Core/ShowGeometryInstanceAttribute","../Scene/Primitive","./BoundingSphereState","./ColorMaterialProperty","./MaterialProperty","./Property"],function(t,e,i,r,a,s,o,n,h,l,p,d,u,v){"use strict";var c=new s,y=new s,m=e.ZERO,f=new e;function g(e,i,r,a,s,o,n){this.primitives=e,this.appearanceType=i,this.materialProperty=r,this.depthFailAppearanceType=a,this.depthFailMaterialProperty=s,this.closed=o,this.shadows=n,this.updaters=new t,this.createPrimitive=!0,this.primitive=void 0,this.oldPrimitive=void 0,this.geometry=new t,this.material=void 0,this.depthFailMaterial=void 0,this.updatersWithAttributes=new t,this.attributes=new t,this.invalidated=!1,this.removeMaterialSubscription=r.definitionChanged.addEventListener(g.prototype.onMaterialChanged,this),this.subscriptions=new t,this.showsUpdated=new t}g.prototype.onMaterialChanged=function(){this.invalidated=!0},g.prototype.isMaterial=function(t){var e=this.materialProperty,i=t.fillMaterialProperty,r=this.depthFailMaterialProperty,s=t.depthFailMaterialProperty;if(i===e&&s===r)return!0;var o=a(e)&&e.equals(i);return o=(!a(r)&&!a(s)||a(r)&&r.equals(s))&&o},g.prototype.add=function(t,e){var i=e.id;if(this.updaters.set(i,e),this.geometry.set(i,e.createFillGeometryInstance(t)),e.hasConstantFill&&e.fillMaterialProperty.isConstant&&v.isConstant(e.distanceDisplayConditionProperty)&&v.isConstant(e.terrainOffsetProperty)){var r=this;this.subscriptions.set(i,e.entity.definitionChanged.addEventListener(function(t,i,a,s){"isShowing"===i&&r.showsUpdated.set(e.id,e)}))}else this.updatersWithAttributes.set(i,e);this.createPrimitive=!0},g.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);return a(i)&&(i(),this.subscriptions.remove(e),this.showsUpdated.remove(e)),!0}return!1};var P=new i;function w(t,e,i,r,a){this._items=[],this._primitives=t,this._appearanceType=e,this._depthFailAppearanceType=i,this._closed=r,this._shadows=a}return g.prototype.update=function(t){var p,g=!0,w=this.primitive,C=this.primitives,F=this.geometry.values;if(this.createPrimitive){if(F.length>0){var M;a(w)&&(a(this.oldPrimitive)?C.remove(w):this.oldPrimitive=w),this.material=u.getValue(t,this.materialProperty,this.material),a(this.depthFailMaterialProperty)&&(this.depthFailMaterial=u.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial),M=new this.depthFailAppearanceType({material:this.depthFailMaterial,translucent:this.depthFailMaterial.isTranslucent(),closed:this.closed})),w=new l({show:!1,asynchronous:!0,geometryInstances:F,appearance:new this.appearanceType({material:this.material,translucent:this.material.isTranslucent(),closed:this.closed}),depthFailAppearance:M,shadows:this.shadows}),C.add(w),g=!1}else{a(w)&&(C.remove(w),w=void 0);var b=this.oldPrimitive;a(b)&&(C.remove(b),this.oldPrimitive=void 0)}this.attributes.removeAll(),this.primitive=w,this.createPrimitive=!1}else if(a(w)&&w.ready){w.show=!0,a(this.oldPrimitive)&&(C.remove(this.oldPrimitive),this.oldPrimitive=void 0),this.material=u.getValue(t,this.materialProperty,this.material),this.primitive.appearance.material=this.material,!a(this.depthFailAppearanceType)||this.depthFailMaterialProperty instanceof d||(this.depthFailMaterial=u.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial),this.primitive.depthFailAppearance.material=this.depthFailMaterial);var A=this.updatersWithAttributes.values,_=A.length;for(p=0;p<_;p++){var D=A[p],S=D.entity,I=this.geometry.get(D.id),T=this.attributes.get(I.id.id);if(a(T)||(T=w.getGeometryInstanceAttributes(I.id),this.attributes.set(I.id.id,T)),a(this.depthFailAppearanceType)&&this.depthFailMaterialProperty instanceof d&&!D.depthFailMaterialProperty.isConstant){var V=D.depthFailMaterialProperty.color,O=v.getValueOrDefault(V,t,i.WHITE,P);i.equals(T._lastDepthFailColor,O)||(T._lastDepthFailColor=i.clone(O,T._lastDepthFailColor),T.depthFailColor=r.toValue(O,T.depthFailColor))}var G=S.isShowing&&(D.hasConstantFill||D.isFilled(t));G!==(1===T.show[0])&&(T.show=h.toValue(G,T.show));var E=D.distanceDisplayConditionProperty;if(!v.isConstant(E)){var q=v.getValueOrDefault(E,t,y,c);s.equals(q,T._lastDistanceDisplayCondition)||(T._lastDistanceDisplayCondition=s.clone(q,T._lastDistanceDisplayCondition),T.distanceDisplayCondition=o.toValue(q,T.distanceDisplayCondition))}var U=D.terrainOffsetProperty;if(!v.isConstant(U)){var W=v.getValueOrDefault(U,t,m,f);e.equals(W,T._lastOffset)||(T._lastOffset=e.clone(W,T._lastOffset),T.offset=n.toValue(W,T.offset))}}this.updateShows(w)}else a(w)&&!w.ready&&(g=!1);return g},g.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,r=0;r<i;r++){var s=e[r],o=s.entity,n=this.geometry.get(s.id),l=this.attributes.get(n.id.id);a(l)||(l=t.getGeometryInstanceAttributes(n.id),this.attributes.set(n.id.id,l));var p=o.isShowing;p!==(1===l.show[0])&&(l.show=h.toValue(p,l.show),n.attributes.show.value[0]=l.show[0])}this.showsUpdated.removeAll()},g.prototype.contains=function(t){return this.updaters.contains(t.id)},g.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return p.PENDING;var r=i.getGeometryInstanceAttributes(t.entity);return!a(r)||!a(r.boundingSphere)||a(r.show)&&0===r.show[0]?p.FAILED:(r.boundingSphere.clone(e),p.DONE)},g.prototype.destroy=function(){var t=this.primitive,e=this.primitives;a(t)&&e.remove(t);var i=this.oldPrimitive;a(i)&&e.remove(i),this.removeMaterialSubscription()},w.prototype.add=function(t,e){for(var i=this._items,r=i.length,a=0;a<r;a++){var s=i[a];if(s.isMaterial(e))return void s.add(t,e)}var o=new g(this._primitives,this._appearanceType,e.fillMaterialProperty,this._depthFailAppearanceType,e.depthFailMaterialProperty,this._closed,this._shadows);o.add(t,e),i.push(o)},w.prototype.remove=function(t){for(var e=this._items,i=e.length-1;i>=0;i--){var r=e[i];if(r.remove(t)){0===r.updaters.length&&(e.splice(i,1),r.destroy());break}}},w.prototype.update=function(t){var e,i=this._items;for(e=i.length-1;e>=0;e--){var r=i[e];if(r.invalidated){i.splice(e,1);for(var a=r.updaters.values,s=a.length,o=0;o<s;o++)this.add(t,a[o]);r.destroy()}}var n=!0;for(e=0;e<i.length;e++)n=i[e].update(t)&&n;return n},w.prototype.getBoundingSphere=function(t,e){for(var i=this._items,r=i.length,a=0;a<r;a++){var s=i[a];if(s.contains(t))return s.getBoundingSphere(t,e)}return p.FAILED},w.prototype.removeAllPrimitives=function(){for(var t=this._items,e=t.length,i=0;i<e;i++)t[i].destroy();this._items.length=0},w});