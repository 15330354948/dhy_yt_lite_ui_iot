define(["../Core/AttributeCompression","../Core/binarySearch","../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/defined","../Core/HeightmapTerrainData","../Core/Math","../Core/DeveloperError","../Core/OrientedBoundingBox","../Core/Queue","../Core/Rectangle","../Core/TileEdge","../Core/TerrainEncoding","../Core/TerrainMesh","../Core/WebMercatorProjection","./GlobeSurfaceTile","./TileSelectionResult"],function(e,t,r,s,a,i,o,h,n,l,d,c,u,T,g,m,v,f,w,S){"use strict";function M(e){this.tile=e,this.frameLastUpdated=void 0,this.westMeshes=[],this.westTiles=[],this.southMeshes=[],this.southTiles=[],this.eastMeshes=[],this.eastTiles=[],this.northMeshes=[],this.northTiles=[],this.southwestMesh=void 0,this.southwestTile=void 0,this.southeastMesh=void 0,this.southeastTile=void 0,this.northwestMesh=void 0,this.northwestTile=void 0,this.northeastMesh=void 0,this.northeastTile=void 0,this.changedThisFrame=!0,this.visitedFrame=void 0,this.enqueuedFrame=void 0,this.mesh=void 0,this.vertexArray=void 0,this.waterMaskTexture=void 0,this.waterMaskTranslationAndScale=new i}M.prototype.update=function(e,t,r){this.changedThisFrame&&(_(e,t,this.tile,r),this.changedThisFrame=!1)},M.prototype.destroy=function(e){h(this.vertexArray)&&(h(e)?e.push(this.vertexArray):w._freeVertexArray(this.vertexArray,e),this.vertexArray=void 0),h(this.waterMaskTexture)&&(--this.waterMaskTexture.referenceCount,0===this.waterMaskTexture.referenceCount&&this.waterMaskTexture.destroy(),this.waterMaskTexture=void 0)};var E=new u;function x(e,t,r,s,a,i,o,n,c){if(void 0!==s){for(var u=s;u&&(u._lastSelectionResultFrame!==a||S.wasKicked(u._lastSelectionResult)||S.originalResult(u._lastSelectionResult)===S.CULLED);){if(o)return;var T=u.parent;if(i>=g.NORTHWEST&&void 0!==T)switch(i){case g.NORTHWEST:u=u===T.northwestChild?T:void 0;break;case g.NORTHEAST:u=u===T.northeastChild?T:void 0;break;case g.SOUTHWEST:u=u===T.southwestChild?T:void 0;break;case g.SOUTHEAST:u=u===T.southeastChild?T:void 0}else u=T}if(void 0!==u)if(u._lastSelectionResult!==S.RENDERED){if(S.originalResult(s._lastSelectionResult)!==S.CULLED)switch(i){case g.WEST:x(e,t,r,s.northwestChild,a,i,!0,n,c),x(e,t,r,s.southwestChild,a,i,!0,n,c);break;case g.EAST:x(e,t,r,s.southeastChild,a,i,!0,n,c),x(e,t,r,s.northeastChild,a,i,!0,n,c);break;case g.SOUTH:x(e,t,r,s.southwestChild,a,i,!0,n,c),x(e,t,r,s.southeastChild,a,i,!0,n,c);break;case g.NORTH:x(e,t,r,s.northeastChild,a,i,!0,n,c),x(e,t,r,s.northwestChild,a,i,!0,n,c);break;case g.NORTHWEST:x(e,t,r,s.northwestChild,a,i,!0,n,c);break;case g.NORTHEAST:x(e,t,r,s.northeastChild,a,i,!0,n,c);break;case g.SOUTHWEST:x(e,t,r,s.southwestChild,a,i,!0,n,c);break;case g.SOUTHEAST:x(e,t,r,s.southeastChild,a,i,!0,n,c);break;default:throw new d("Invalid edge")}}else{if(h(u.data.vertexArray))return;!function(e,t,r,s,a,i,o,n){var d=s.data;if(void 0===d.fill)d.fill=new M(s);else if(d.fill.visitedFrame===i)return;d.fill.enqueuedFrame!==i&&(d.fill.enqueuedFrame=i,d.fill.changedThisFrame=!1,o.enqueue(s));!function(e,t,r,s,a,i){var o,n,d,c,u,T,m,v=s.data.fill,f=r.data.fill;h(f)?(f.visitedFrame=t.frameNumber,f.changedThisFrame&&(_(e,t,r,i),f.changedThisFrame=!1),o=r.data.fill.mesh):o=r.data.mesh;switch(a){case g.WEST:n=v.westMeshes,d=v.westTiles;break;case g.SOUTH:n=v.southMeshes,d=v.southTiles;break;case g.EAST:n=v.eastMeshes,d=v.eastTiles;break;case g.NORTH:n=v.northMeshes,d=v.northTiles;break;case g.NORTHWEST:return v.changedThisFrame=v.changedThisFrame||v.northwestMesh!==o,v.northwestMesh=o,void(v.northwestTile=r);case g.NORTHEAST:return v.changedThisFrame=v.changedThisFrame||v.northeastMesh!==o,v.northeastMesh=o,void(v.northeastTile=r);case g.SOUTHWEST:return v.changedThisFrame=v.changedThisFrame||v.southwestMesh!==o,v.southwestMesh=o,void(v.southwestTile=r);case g.SOUTHEAST:return v.changedThisFrame=v.changedThisFrame||v.southeastMesh!==o,v.southeastMesh=o,void(v.southeastTile=r)}if(r.level<=s.level)return v.changedThisFrame=v.changedThisFrame||n[0]!==o||1!==n.length,n[0]=o,d[0]=r,n.length=1,void(d.length=1);var w,S=r.rectangle,M=s.rectangle;switch(a){case g.WEST:for(w=(M.north-M.south)*l.EPSILON5,c=0;c<d.length&&(T=d[c],m=T.rectangle,!l.greaterThan(S.north,m.south,w));++c);for(u=c;u<d.length&&(T=d[u],m=T.rectangle,!l.greaterThanOrEquals(S.south,m.north,w));++u);break;case g.SOUTH:for(w=(M.east-M.west)*l.EPSILON5,c=0;c<d.length&&(T=d[c],m=T.rectangle,!l.lessThan(S.west,m.east,w));++c);for(u=c;u<d.length&&(T=d[u],m=T.rectangle,!l.lessThanOrEquals(S.east,m.west,w));++u);break;case g.EAST:for(w=(M.north-M.south)*l.EPSILON5,c=0;c<d.length&&(T=d[c],m=T.rectangle,!l.lessThan(S.south,m.north,w));++c);for(u=c;u<d.length&&(T=d[u],m=T.rectangle,!l.lessThanOrEquals(S.north,m.south,w));++u);break;case g.NORTH:for(w=(M.east-M.west)*l.EPSILON5,c=0;c<d.length&&(T=d[c],m=T.rectangle,!l.greaterThan(S.east,m.west,w));++c);for(u=c;u<d.length&&(T=d[u],m=T.rectangle,!l.greaterThanOrEquals(S.west,m.east,w));++u);}u-c==1?(v.changedThisFrame=v.changedThisFrame||n[c]!==o,n[c]=o,d[c]=r):(v.changedThisFrame=!0,n.splice(c,u-c,o),d.splice(c,u-c,r))}(e,t,r,s,a,n)}(e,t,r,u,i,a,n,c)}}}M.updateFillTiles=function(e,t,r,s){var a=e._quadtree,i=a._levelZeroTiles,o=a._lastSelectionFrameNumber,n=E;n.clear();for(var l=0;l<t.length;++l){var d=t[l];h(d.data.vertexArray)&&n.enqueue(t[l])}for(var c=n.dequeue();void 0!==c;){var u=c.findTileToWest(i),T=c.findTileToSouth(i),m=c.findTileToEast(i),v=c.findTileToNorth(i);x(e,r,c,u,o,g.EAST,!1,n,s),x(e,r,c,T,o,g.NORTH,!1,n,s),x(e,r,c,m,o,g.WEST,!1,n,s),x(e,r,c,v,o,g.SOUTH,!1,n,s);var f=u.findTileToNorth(i),w=u.findTileToSouth(i),S=m.findTileToNorth(i),M=m.findTileToSouth(i);x(e,r,c,f,o,g.SOUTHEAST,!1,n,s),x(e,r,c,S,o,g.SOUTHWEST,!1,n,s),x(e,r,c,w,o,g.NORTHEAST,!1,n,s),x(e,r,c,M,o,g.NORTHWEST,!1,n,s),c=n.dequeue()}};var N=new o,O=new o,C=new a,H=new a,A=new s,y=new s,b=new s;function I(){this.height=0,this.encodedNormal=new s}function W(e,t,r,s,a,i,o,n,l){if(h(a))return a;var d;if(h(i)&&h(o))d=.5*(i.height+o.height);else if(h(i))d=i.height;else if(h(o))d=o.height;else if(h(n))d=n.height;else{var c=e.tile.data.tileBoundingRegion,u=0,T=0;h(c)&&(u=c.minimumHeight,T=c.maximumHeight),d=.5*(u+T)}return X(e,t,r,s,d,l),l}var p={minimumHeight:0,maximumHeight:0},k=new I,R=new I,F=new I,L=new I,P="undefined"!=typeof Uint8Array?new Uint8Array(81):void 0;function _(t,i,o,l){w.initialize(o,t.terrainProvider,t._imageryLayers);var d=o.data,u=d.fill,T=o.rectangle,S=o.tilingScheme.ellipsoid,M=Y(u,S,0,1,u.northwestTile,u.northwestMesh,u.northTiles,u.northMeshes,u.westTiles,u.westMeshes,F),E=Y(u,S,0,0,u.southwestTile,u.southwestMesh,u.westTiles,u.westMeshes,u.southTiles,u.southMeshes,k),x=Y(u,S,1,0,u.southeastTile,u.southeastMesh,u.southTiles,u.southMeshes,u.eastTiles,u.eastMeshes,R),C=Y(u,S,1,1,u.northeastTile,u.northeastMesh,u.eastTiles,u.eastMeshes,u.northTiles,u.northMeshes,L);C=W(u,S,1,1,C,x=W(u,S,1,1,x,E=W(u,S,0,0,E,M=W(u,S,0,1,M,E,C,x,F),x,C,k),C,M,R),M,E,L);var y,I,_=E.height,q=x.height,D=M.height,B=C.height,V=Math.min(_,q,D,B),z=Math.max(_,q,D,B),G=.5*(V+z),X=t.getLevelMaximumGeometricError(o.level),j=S.maximumRadius-X,Q=4*Math.acos(j/S.maximumRadius);if(Q*=1.5,T.width>Q&&z-V<=X){var Z=new n({width:9,height:9,buffer:P,structure:{heightOffset:z}});u.mesh=Z._createMeshSync(o.tilingScheme,o.x,o.y,o.level,1)}else{var J=new m(void 0,void 0,void 0,void 0,!0,!0),$=O;$.longitude=.5*(T.east+T.west),$.latitude=.5*(T.north+T.south),$.height=G,J.center=S.cartographicToCartesian($,J.center);var te,re=5;for(y=0,I=(te=u.westMeshes).length;y<I;++y)re+=te[y].eastIndicesNorthToSouth.length;for(y=0,I=(te=u.southMeshes).length;y<I;++y)re+=te[y].northIndicesWestToEast.length;for(y=0,I=(te=u.eastMeshes).length;y<I;++y)re+=te[y].westIndicesSouthToNorth.length;for(y=0,I=(te=u.northMeshes).length;y<I;++y)re+=te[y].southIndicesEastToWest.length;var se=p;se.minimumHeight=V,se.maximumHeight=z;var ae=J.getStride(),ie=new Float32Array(re*ae),oe=0,he=oe,ne=oe=K(u,S,J,ie,oe=U(S,T,J,ie,oe,0,1,M.height,M.encodedNormal,1,se),u.westTiles,u.westMeshes,g.EAST,se),le=oe=K(u,S,J,ie,oe=U(S,T,J,ie,oe,0,0,E.height,E.encodedNormal,0,se),u.southTiles,u.southMeshes,g.NORTH,se),de=oe=K(u,S,J,ie,oe=U(S,T,J,ie,oe,1,0,x.height,x.encodedNormal,0,se),u.eastTiles,u.eastMeshes,g.WEST,se);oe=K(u,S,J,ie,oe=U(S,T,J,ie,oe,1,1,C.height,C.encodedNormal,1,se),u.northTiles,u.northMeshes,g.SOUTH,se),V=se.minimumHeight,z=se.maximumHeight;var ce=c.fromRectangle(T,V,z,o.tilingScheme.ellipsoid),ue=f.geodeticLatitudeToMercatorAngle(T.south),Te=1/(f.geodeticLatitudeToMercatorAngle(T.north)-ue),ge=(f.geodeticLatitudeToMercatorAngle($.latitude)-ue)*Te;S.geodeticSurfaceNormalCartographic(N,H);var me=e.octEncode(H,A),ve=oe;J.encode(ie,oe*ae,ce.center,s.fromElements(.5,.5,b),G,me,ge);var fe,we=++oe,Se=3*(we-1),Me=Se*(we<256?1:2);if((ie.length-we*ae)*Float32Array.BYTES_PER_ELEMENT>=Me){var Ee=we*ae*Float32Array.BYTES_PER_ELEMENT;fe=we<256?new Uint8Array(ie.buffer,Ee,Se):new Uint16Array(ie.buffer,Ee,Se)}else fe=we<256?new Uint8Array(Se):new Uint16Array(Se);ie=new Float32Array(ie.buffer,0,we*ae);var xe=0;for(y=0;y<we-2;++y)fe[xe++]=ve,fe[xe++]=y,fe[xe++]=y+1;fe[xe++]=ve,fe[xe++]=y,fe[xe++]=0;var Ne=[];for(y=ne;y>=he;--y)Ne.push(y);var Oe=[];for(y=le;y>=ne;--y)Oe.push(y);var Ce=[];for(y=de;y>=le;--y)Ce.push(y);var He=[];for(He.push(0),y=ve-1;y>=de;--y)He.push(y);u.mesh=new v(J.center,ie,fe,V,z,r.fromOrientedBoundingBox(ce),function(e,t,r,s,i){var o=e.quadtree._occluders.ellipsoid,h=o.ellipsoid,n=ee;return a.fromRadians(r.west,r.south,s,h,n[0]),a.fromRadians(r.east,r.south,s,h,n[1]),a.fromRadians(r.west,r.north,s,h,n[2]),a.fromRadians(r.east,r.north,s,h,n[3]),o.computeHorizonCullingPoint(t,n,i)}(t,ce.center,T,z),J.getStride(),ce,J,i.terrainExaggeration,Ne,Oe,Ce,He)}var Ae=i.context;h(u.vertexArray)&&(h(l)?l.push(u.vertexArray):w._freeVertexArray(u.vertexArray)),u.vertexArray=w._createVertexArrayForMesh(Ae,u.mesh),d.processImagery(o,t.terrainProvider,i,!0);var ye=u.waterMaskTexture;if(u.waterMaskTexture=void 0,t.terrainProvider.hasWaterMask){var be=d._findAncestorTileWithTerrainData(o);h(be)&&h(be.data.waterMaskTexture)&&(u.waterMaskTexture=be.data.waterMaskTexture,++u.waterMaskTexture.referenceCount,d._computeWaterMaskTranslationAndScale(o,be,u.waterMaskTranslationAndScale))}h(ye)&&(--ye.referenceCount,0===ye.referenceCount&&ye.destroy())}function U(e,t,r,s,a,i,o,h,n,d,c){var u=N;u.longitude=l.lerp(t.west,t.east,i),u.latitude=l.lerp(t.south,t.north,o),u.height=h;var T=e.cartographicToCartesian(u,C),g=y;return g.x=i,g.y=o,r.encode(s,a*r.getStride(),T,g,h,n,d),c.minimumHeight=Math.min(c.minimumHeight,h),c.maximumHeight=Math.max(c.maximumHeight,h),a+1}var q=new T;function D(e,t,r,s){var a=e.rectangle,i=t.rectangle;0===t.x&&1===r.x&&e.x===e.tilingScheme.getNumberOfXTilesAtLevel(e.level)-1?((a=T.clone(e.rectangle,q)).west-=l.TWO_PI,a.east-=l.TWO_PI):0===e.x&&0===r.x&&t.x===t.tilingScheme.getNumberOfXTilesAtLevel(t.level)-1&&((a=T.clone(e.rectangle,q)).west+=l.TWO_PI,a.east+=l.TWO_PI);var o=a.east-a.west,h=(i.west-a.west)/o,n=(i.east-a.west)/o,d=a.north-a.south,c=(i.south-a.south)/d,u=(i.north-a.south)/d,g=(r.x-h)/(n-h),m=(r.y-c)/(u-c);return Math.abs(g)<Math.EPSILON5?g=0:Math.abs(g-1)<Math.EPSILON5&&(g=1),Math.abs(m)<Math.EPSILON5?m=0:Math.abs(m-1)<Math.EPSILON5&&(m=1),s.x=g,s.y=m,s}var B=new s;function V(e,t,r,s,a){var i=e.encoding,o=e.vertices;if(a.height=i.decodeHeight(o,t),i.hasVertexNormals)i.getOctEncodedNormal(o,t,a.encodedNormal);else{var h=a.encodedNormal;h.x=0,h.y=0}}var z=new s,G=new a;function X(t,r,s,a,i,o){o.height=i;var h=r.geodeticSurfaceNormalCartographic(N,C);e.octEncode(h,o.encodedNormal)}function Y(e,t,r,s,a,i,o,n,l,d,c){var u;return $(e,t,n,o,!1,r,s,c)||$(e,t,d,l,!0,r,s,c)?c:J(a,i)?(V(i,0===r?0===s?i.eastIndicesNorthToSouth[0]:i.southIndicesEastToWest[0]:0===s?i.northIndicesWestToEast[0]:i.westIndicesSouthToNorth[0],0,0,c),c):(u=0===r?0===s?j(e.westMeshes,e.westTiles,g.EAST,e.southMeshes,e.southTiles,g.NORTH,r,s):j(e.northMeshes,e.northTiles,g.SOUTH,e.westMeshes,e.westTiles,g.EAST,r,s):0===s?j(e.southMeshes,e.southTiles,g.NORTH,e.eastMeshes,e.eastTiles,g.WEST,r,s):j(e.eastMeshes,e.eastTiles,g.WEST,e.northMeshes,e.northTiles,g.SOUTH,r,s),h(u)?(X(0,t,0,0,u,c),c):void 0)}function j(e,t,r,s,a,i,o,n){var l=Z(e,t,!1,r,o,n),d=Z(s,a,!0,i,o,n);return h(l)&&h(d)?.5*(l+d):h(l)?l:d}function K(e,t,r,s,a,i,o,h,n){for(var l=0;l<i.length;++l)a=Q(e,t,r,s,a,i[l],o[l],h,n);return a}function Q(e,t,r,s,a,i,o,h,n){var d=i.rectangle;h===g.EAST&&0===e.tile.x?((d=T.clone(i.rectangle,q)).west-=l.TWO_PI,d.east-=l.TWO_PI):h===g.WEST&&0===i.x&&((d=T.clone(i.rectangle,q)).west+=l.TWO_PI,d.east+=l.TWO_PI);var c,u,m,v,w=e.tile.rectangle;switch(a>0&&(r.decodeTextureCoordinates(s,a-1,b),c=b.x,u=b.y),h){case g.WEST:m=o.westIndicesSouthToNorth,v=!1;break;case g.NORTH:m=o.northIndicesWestToEast,v=!0;break;case g.EAST:m=o.eastIndicesNorthToSouth,v=!1;break;case g.SOUTH:m=o.southIndicesEastToWest,v=!0}var S,M,E=i,x=e.tile,N=o.encoding,O=o.vertices,H=r.getStride();N.hasWebMercatorT&&(S=f.geodeticLatitudeToMercatorAngle(w.south),M=1/(f.geodeticLatitudeToMercatorAngle(w.north)-S));for(var y=0;y<m.length;++y){var I=m[y],W=N.decodeTextureCoordinates(O,I,b);D(E,x,W,W);var p=W.x,k=W.y,R=v?p:k;if(!(R<0||R>1)&&!(Math.abs(p-c)<l.EPSILON5&&Math.abs(k-u)<l.EPSILON5)){var F=Math.abs(p)<l.EPSILON5||Math.abs(p-1)<l.EPSILON5,L=Math.abs(k)<l.EPSILON5||Math.abs(k-1)<l.EPSILON5;if(!F||!L){var P,_=N.decodePosition(O,I,C),U=N.decodeHeight(O,I);N.hasVertexNormals?P=N.getOctEncodedNormal(O,I,A):((P=A).x=0,P.y=0);var B=k;if(N.hasWebMercatorT){var V=l.lerp(w.south,w.north,k);B=(f.geodeticLatitudeToMercatorAngle(V)-S)*M}r.encode(s,a*H,_,W,U,P,B),n.minimumHeight=Math.min(n.minimumHeight,U),n.maximumHeight=Math.max(n.maximumHeight,U),++a}}}return a}function Z(e,t,r,s,a,i){var o,n,l;r?(o=0,n=e.length,l=1):(o=e.length-1,n=-1,l=-1);for(var d=o;d!==n;d+=l){var c=e[d];if(J(t[d],c)){var u;switch(s){case g.WEST:u=c.westIndicesSouthToNorth;break;case g.SOUTH:u=c.southIndicesEastToWest;break;case g.EAST:u=c.eastIndicesNorthToSouth;break;case g.NORTH:u=c.northIndicesWestToEast}var T=u[r?0:u.length-1];if(h(T))return c.encoding.decodeHeight(c.vertices,T)}}}function J(e,t){return h(t)&&(!h(e.data.fill)||!e.data.fill.changedThisFrame)}function $(r,s,i,o,h,n,d,c){var u,T,g,m,v,f=o[h?0:i.length-1],w=i[h?0:i.length-1];if(J(f,w)&&(0===n?0===d?(u=h?w.northIndicesWestToEast:w.eastIndicesNorthToSouth,T=h,g=h):(u=h?w.eastIndicesNorthToSouth:w.southIndicesEastToWest,T=!h,g=!1):0===d?(u=h?w.westIndicesSouthToNorth:w.northIndicesWestToEast,T=!h,g=!0):(u=h?w.southIndicesEastToWest:w.westIndicesSouthToNorth,T=h,g=!h),u.length>0)){v=u[m=h?0:u.length-1],w.encoding.decodeTextureCoordinates(w.vertices,v,b);var S=D(f,r.tile,b,b);if(S.x===n&&S.y===d)return V(w,v,0,0,c),!0;if(!((m=t(u,T?n:d,function(e,t){w.encoding.decodeTextureCoordinates(w.vertices,e,b);var s=D(f,r.tile,b,b);return g?T?s.x-n:s.y-d:T?n-s.x:d-s.y}))<0))return V(w,u[m],0,0,c),!0;if((m=~m)>0&&m<u.length)return function(t,r,s,i,o,h,n,d,c,u){var T,g=i.encoding,m=i.vertices,v=D(r,s,g.decodeTextureCoordinates(m,o,b),b),f=D(r,s,g.decodeTextureCoordinates(m,h,y),y);T=c?(n-v.x)/(f.x-v.x):(d-v.y)/(f.y-v.y);var w,S=g.decodeHeight(m,o),M=g.decodeHeight(m,h),E=s.rectangle;if(N.longitude=l.lerp(E.west,E.east,n),N.latitude=l.lerp(E.south,E.north,d),u.height=N.height=l.lerp(S,M,T),g.hasVertexNormals){var x=g.getOctEncodedNormal(m,o,B),O=g.getOctEncodedNormal(m,h,z),H=e.octDecode(x.x,x.y,C),A=e.octDecode(O.x,O.y,G);w=a.lerp(H,A,T,C),a.normalize(w,w),e.octEncode(w,u.encodedNormal)}else w=t.geodeticSurfaceNormalCartographic(N,C),e.octEncode(w,u.encodedNormal)}(s,f,r.tile,w,u[m-1],u[m],n,d,T,c),!0}return!1}var ee=[new a,new a,new a,new a];return M});