define(["../../Core/binarySearch","../../Core/ClockRange","../../Core/ClockStep","../../Core/defined","../../Core/defineProperties","../../Core/DeveloperError","../../Core/JulianDate","../../ThirdParty/knockout","../../ThirdParty/sprintf","../createCommand","../ToggleButtonViewModel"],function(e,t,i,r,o,n,l,a,u,s,c){"use strict";var h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=15,m=105;function g(e,t){return e-t}function p(t,i){var r=e(i,t,g);return r<0?~r:r}function f(e){if(!r(e))throw new n("clockViewModel is required.");var o=this;this._clockViewModel=e,this._allShuttleRingTicks=[],this._dateFormatter=f.defaultDateFormatter,this._timeFormatter=f.defaultTimeFormatter,this.shuttleRingDragging=!1,this.snapToTicks=!1,a.track(this,["_allShuttleRingTicks","_dateFormatter","_timeFormatter","shuttleRingDragging","snapToTicks"]),this._sortedFilteredPositiveTicks=[],this.setShuttleRingTicks(f.defaultTicks),this.timeLabel=void 0,a.defineProperty(this,"timeLabel",function(){return o._timeFormatter(o._clockViewModel.currentTime,o)}),this.dateLabel=void 0,a.defineProperty(this,"dateLabel",function(){return o._dateFormatter(o._clockViewModel.currentTime,o)}),this.multiplierLabel=void 0,a.defineProperty(this,"multiplierLabel",function(){var e=o._clockViewModel;if(e.clockStep===i.SYSTEM_CLOCK)return"Today";var t=e.multiplier;return t%1==0?t.toFixed(0)+"x":t.toFixed(3).replace(/0{0,3}$/,"")+"x"}),this.shuttleRingAngle=void 0,a.defineProperty(this,"shuttleRingAngle",{get:function(){return function(e,t,r){if(r.clockStep===i.SYSTEM_CLOCK)return d;if(Math.abs(e)<=1)return e*d;var o=t[t.length-1];e>o?e=o:e<-o&&(e=-o);var n,l=d,a=m;return e>0?(n=(Math.log(o)-0)/(a-l),(Math.log(e)-0)/n+l):(n=(Math.log(-t[0])-0)/(a-l),-((Math.log(Math.abs(e))-0)/n+l))}(e.multiplier,o._allShuttleRingTicks,e)},set:function(e){e=Math.max(Math.min(e,m),-m);var t=o._allShuttleRingTicks,r=o._clockViewModel;if(r.clockStep=i.SYSTEM_CLOCK_MULTIPLIER,Math.abs(e)!==m){var n=function(e,t){if(Math.abs(e)<=d)return e/d;var i,r=d,o=m;return e>0?(i=(Math.log(t[t.length-1])-0)/(o-r),Math.exp(0+i*(e-r))):(i=(Math.log(-t[0])-0)/(o-r),-Math.exp(0+i*(Math.abs(e)-r)))}(e,t);if(o.snapToTicks)n=t[p(n,t)];else if(0!==n){var l=Math.abs(n);if(l>100){var a=l.toFixed(0).length-2,u=Math.pow(10,a);n=Math.round(n/u)*u|0}else l>d?n=Math.round(n):l>1?n=+n.toFixed(1):l>0&&(n=+n.toFixed(2))}r.multiplier=n}else r.multiplier=e>0?t[t.length-1]:t[0]}}),this._canAnimate=void 0,a.defineProperty(this,"_canAnimate",function(){var e=o._clockViewModel,i=e.clockRange;if(o.shuttleRingDragging||i===t.UNBOUNDED)return!0;var r=e.multiplier,n=e.currentTime,a=e.startTime,u=!1;if(i===t.LOOP_STOP)u=l.greaterThan(n,a)||n.equals(a)&&r>0;else{var s=e.stopTime;u=l.greaterThan(n,a)&&l.lessThan(n,s)||n.equals(a)&&r>0||n.equals(s)&&r<0}return u||(e.shouldAnimate=!1),u}),this._isSystemTimeAvailable=void 0,a.defineProperty(this,"_isSystemTimeAvailable",function(){var e=o._clockViewModel;if(e.clockRange===t.UNBOUNDED)return!0;var i=e.systemTime;return l.greaterThanOrEquals(i,e.startTime)&&l.lessThanOrEquals(i,e.stopTime)}),this._isAnimating=void 0,a.defineProperty(this,"_isAnimating",function(){return o._clockViewModel.shouldAnimate&&(o._canAnimate||o.shuttleRingDragging)});var u=s(function(){var e=o._clockViewModel;e.shouldAnimate?e.shouldAnimate=!1:o._canAnimate&&(e.shouldAnimate=!0)});this._pauseViewModel=new c(u,{toggled:a.computed(function(){return!o._isAnimating}),tooltip:"Pause"});var h=s(function(){var e=o._clockViewModel,t=e.multiplier;t>0&&(e.multiplier=-t),e.shouldAnimate=!0});this._playReverseViewModel=new c(h,{toggled:a.computed(function(){return o._isAnimating&&e.multiplier<0}),tooltip:"Play Reverse"});var g=s(function(){var e=o._clockViewModel,t=e.multiplier;t<0&&(e.multiplier=-t),e.shouldAnimate=!0});this._playForwardViewModel=new c(g,{toggled:a.computed(function(){return o._isAnimating&&e.multiplier>0&&e.clockStep!==i.SYSTEM_CLOCK}),tooltip:"Play Forward"});var _=s(function(){o._clockViewModel.clockStep=i.SYSTEM_CLOCK},a.getObservable(this,"_isSystemTimeAvailable"));this._playRealtimeViewModel=new c(_,{toggled:a.computed(function(){return e.clockStep===i.SYSTEM_CLOCK}),tooltip:a.computed(function(){return o._isSystemTimeAvailable?"Today (real-time)":"Current time not in range"})}),this._slower=s(function(){var e=o._clockViewModel,t=o._allShuttleRingTicks,i=p(e.multiplier,t)-1;i>=0&&(e.multiplier=t[i])}),this._faster=s(function(){var e=o._clockViewModel,t=o._allShuttleRingTicks,i=p(e.multiplier,t)+1;i<t.length&&(e.multiplier=t[i])})}return f.defaultDateFormatter=function(e,t){var i=l.toGregorianDate(e);return h[i.month-1]+" "+i.day+" "+i.year},f.defaultTicks=[.001,.002,.005,.01,.02,.05,.1,.25,.5,1,2,5,10,15,30,60,120,300,600,900,1800,3600,7200,14400,21600,43200,86400,172800,345600,604800],f.defaultTimeFormatter=function(e,t){var i=l.toGregorianDate(e),r=Math.round(i.millisecond);return Math.abs(t._clockViewModel.multiplier)<1?u("%02d:%02d:%02d.%03d",i.hour,i.minute,i.second,r):u("%02d:%02d:%02d UTC",i.hour,i.minute,i.second)},f.prototype.getShuttleRingTicks=function(){return this._sortedFilteredPositiveTicks.slice(0)},f.prototype.setShuttleRingTicks=function(e){if(!r(e))throw new n("positiveTicks is required.");var t,i,o,l={},a=this._sortedFilteredPositiveTicks;for(a.length=0,t=0,i=e.length;t<i;++t)o=e[t],l.hasOwnProperty(o)||(l[o]=!0,a.push(o));a.sort(g);var u=[];for(t=(i=a.length)-1;t>=0;--t)0!==(o=a[t])&&u.push(-o);Array.prototype.push.apply(u,a),this._allShuttleRingTicks=u},o(f.prototype,{slower:{get:function(){return this._slower}},faster:{get:function(){return this._faster}},clockViewModel:{get:function(){return this._clockViewModel}},pauseViewModel:{get:function(){return this._pauseViewModel}},playReverseViewModel:{get:function(){return this._playReverseViewModel}},playForwardViewModel:{get:function(){return this._playForwardViewModel}},playRealtimeViewModel:{get:function(){return this._playRealtimeViewModel}},dateFormatter:{get:function(){return this._dateFormatter},set:function(e){if("function"!=typeof e)throw new n("dateFormatter must be a function");this._dateFormatter=e}},timeFormatter:{get:function(){return this._timeFormatter},set:function(e){if("function"!=typeof e)throw new n("timeFormatter must be a function");this._timeFormatter=e}}}),f._maxShuttleRingAngle=m,f._realtimeShuttleRingAngle=d,f});