define(["../Core/BoundingSphere","../Core/BoxOutlineGeometry","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/combine","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Event","../Core/GeometryInstance","../Core/GeometryPipeline","../Core/IndexDatatype","../Core/Intersect","../Core/Math","../Core/Matrix4","../Core/OrientedBoundingBox","../Core/OrthographicFrustum","../Core/PrimitiveType","../Core/Rectangle","../Core/SphereOutlineGeometry","../Core/TerrainMesh","../Core/TerrainQuantization","../Core/Visibility","../Core/WebMercatorProjection","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/VertexArray","./BlendingState","./ImageryState","./TileBoundingRegion","./TileSelectionResult","./ClippingPlaneCollection","./DepthFunction","./GlobeSurfaceTile","./ImageryLayer","./PerInstanceColorAppearance","./Primitive","./QuadtreeTileLoadState","./SceneMode","./ShadowMode","./TerrainFillMesh","./TerrainState","../extends/core/ExpendUtil"],function(e,r,t,i,a,n,o,s,d,l,u,h,c,m,g,p,y,f,v,_,T,x,S,C,w,E,A,L,I,R,P,b,D,M,O,H,B,N,F,V,G,U,W,q,z,k,j,Y,Q,X,Z,J,K){"use strict";function $(e){if(!u(e))throw new m("options is required.");if(!u(e.terrainProvider))throw new m("options.terrainProvider is required.");if(!u(e.imageryLayers))throw new m("options.imageryLayers is required.");if(!u(e.surfaceShaderSet))throw new m("options.surfaceShaderSet is required.");this.lightingFadeOutDistance=65e5,this.lightingFadeInDistance=9e6,this.hasWaterMask=!1,this.oceanNormalMap=void 0,this.zoomedOutOceanSpecularIntensity=.5,this.enableLighting=!1,this.showGroundAtmosphere=!1,this.shadows=X.RECEIVE_ONLY,this.fillHighlightColor=void 0,this.hueShift=0,this.saturationShift=0,this.brightnessShift=0,this._quadtree=void 0,this._terrainProvider=e.terrainProvider,this._imageryLayers=e.imageryLayers,this._surfaceShaderSet=e.surfaceShaderSet,this._renderState=void 0,this._blendRenderState=void 0,this._errorEvent=new g,this._imageryLayers.layerAdded.addEventListener($.prototype._onLayerAdded,this),this._imageryLayers.layerRemoved.addEventListener($.prototype._onLayerRemoved,this),this._imageryLayers.layerMoved.addEventListener($.prototype._onLayerMoved,this),this._imageryLayers.layerShownOrHidden.addEventListener($.prototype._onLayerShownOrHidden,this),this._imageryLayersUpdatedEvent=new g,this._layerOrderChanged=!1,this._tilesToRenderByTextureCount=[],this._drawCommands=[],this._uniformMaps=[],this._usedDrawCommands=0,this._vertexArraysToDestroy=[],this._debug={wireframe:!1,boundingSphereTile:void 0},this._baseColor=void 0,this._firstPassInitialColor=void 0,this.baseColor=new o(0,0,.5,1),this._clippingPlanes=void 0,this.cartographicLimitRectangle=w.clone(w.MAX_VALUE),this._hasLoadedTilesThisFrame=!1,this._hasFillTilesThisFrame=!1}function ee(e,r){var t=e.loadingImagery;u(t)||(t=e.readyImagery);var i=r.loadingImagery;return u(i)||(i=r.readyImagery),t.imageryLayer._layerIndex-i.imageryLayer._layerIndex}h($.prototype,{baseColor:{get:function(){return this._baseColor},set:function(e){if(!u(e))throw new m("value is required.");this._baseColor=e,this._firstPassInitialColor=a.fromColor(e,this._firstPassInitialColor)}},quadtree:{get:function(){return this._quadtree},set:function(e){if(!u(e))throw new m("value is required.");this._quadtree=e}},ready:{get:function(){return this._terrainProvider.ready&&(0===this._imageryLayers.length||this._imageryLayers.get(0).imageryProvider.ready)}},tilingScheme:{get:function(){return this._terrainProvider.tilingScheme}},errorEvent:{get:function(){return this._errorEvent}},imageryLayersUpdatedEvent:{get:function(){return this._imageryLayersUpdatedEvent}},terrainProvider:{get:function(){return this._terrainProvider},set:function(e){if(this._terrainProvider!==e){if(!u(e))throw new m("terrainProvider is required.");this._terrainProvider=e,u(this._quadtree)&&this._quadtree.invalidateAllTiles()}}},clippingPlanes:{get:function(){return this._clippingPlanes},set:function(e){U.setOwner(e,this,"_clippingPlanes")}}}),$.prototype.update=function(e){this._imageryLayers._update()},$.prototype.initialize=function(e){this._imageryLayers.queueReprojectionCommands(e),this._layerOrderChanged&&(this._layerOrderChanged=!1,this._quadtree.forEachLoadedTile(function(e){e.data.imagery.sort(ee)})),function(e,r){var t=r.creditDisplay;e._terrainProvider.ready&&u(e._terrainProvider.credit)&&t.addCredit(e._terrainProvider.credit);for(var i=e._imageryLayers,a=0,n=i.length;a<n;++a){var o=i.get(a).imageryProvider;o.ready&&u(o.credit)&&t.addCredit(o.credit)}}(this,e);for(var r=this._vertexArraysToDestroy,t=r.length,i=0;i<t;++i)q._freeVertexArray(r[i]);r.length=0},$.prototype.beginUpdate=function(e){for(var r=this._tilesToRenderByTextureCount,t=0,i=r.length;t<i;++t){var a=r[t];u(a)&&(a.length=0)}var n=this._clippingPlanes;u(n)&&n.enabled&&n.update(e),this._usedDrawCommands=0,this._hasLoadedTilesThisFrame=!1,this._hasFillTilesThisFrame=!1},$.prototype.endUpdate=function(e){u(this._renderState)||(this._renderState=H.fromCache({cull:{enabled:!0},depthTest:{enabled:!0,func:W.LESS}}),this._blendRenderState=H.fromCache({cull:{enabled:!0},depthTest:{enabled:!0,func:W.LESS_OR_EQUAL},blending:N.ALPHA_BLEND})),this._hasFillTilesThisFrame&&this._hasLoadedTilesThisFrame&&Z.updateFillTiles(this,this._quadtree._tilesToRender,e,this._vertexArraysToDestroy);for(var r=this._tilesToRenderByTextureCount,t=0,i=r.length;t<i;++t){var a=r[t];if(u(a))for(var n=0,o=a.length;n<o;++n)Ae(this,a[n],e)}},$.prototype.updateForPick=function(e){for(var r=this._drawCommands,t=0,i=this._usedDrawCommands;t<i;++t)e.commandList.push(r[t])},$.prototype.cancelReprojections=function(){this._imageryLayers.cancelReprojections()},$.prototype.getLevelMaximumGeometricError=function(e){return this._terrainProvider.getLevelMaximumGeometricError(e)},$.prototype.loadTile=function(e,r){var t,i=r.data,a=!0;u(i)&&(a=i.boundingVolumeSourceTile!==r||r._lastSelectionResult===G.CULLED_BUT_NEEDED,t=i.terrainState),q.processStateMachine(r,e,this.terrainProvider,this._imageryLayers,this._vertexArraysToDestroy,a),i=r.data,a&&t!==r.data.terrainState&&this.computeTileVisibility(r,e,this.quadtree.occluders)&&i.boundingVolumeSourceTile===r&&(a=!1,q.processStateMachine(r,e,this.terrainProvider,this._imageryLayers,this._vertexArraysToDestroy,a))};var re=new e,te=new w,ie=new w,ae=new n;function ne(e,r){if(r.west<r.east)return r;var t=w.clone(r,ie);return w.center(e,ae).longitude>0?t.east=_.PI:t.west=-_.PI,t}$.prototype.computeTileVisibility=function(r,t,a){var n=this.computeDistanceToTile(r,t);if(r._distance=n,t.fog.enabled&&_.fog(n,t.fog.density)>=1)return I.NONE;var o=r.data,s=o.tileBoundingRegion;if(void 0===o.boundingVolumeSourceTile)return I.PARTIAL;var d=t.cullingVolume,l=o.orientedBoundingBox;!u(l)&&u(o.renderedMesh)&&(l=o.renderedMesh.boundingSphere3D),o.clippedByBoundaries=!1;var h=ne(r.rectangle,this.cartographicLimitRectangle),c=w.simpleIntersection(h,r.rectangle,te);if(!u(c))return I.NONE;w.equals(c,r.rectangle)||(o.clippedByBoundaries=!0),t.mode!==Q.SCENE3D&&(l=re,e.fromRectangleWithHeights2D(r.rectangle,t.mapProjection,s.minimumHeight,s.maximumHeight,l),i.fromElements(l.center.z,l.center.x,l.center.y,l.center),t.mode===Q.MORPHING&&u(o.renderedMesh)&&(l=e.union(o.renderedMesh.boundingSphere3D,l,l)));var m=this._clippingPlanes;if(u(m)&&m.enabled&&u(l)){var g=m.computeIntersectionWithBoundingVolume(l);if(r.isClipped=g!==v.INSIDE,g===v.OUTSIDE)return I.NONE}var p=v.INTERSECTING;if(u(l)&&(p=d.computeVisibility(l))===v.OUTSIDE)return I.NONE;var y=t.mode===Q.SCENE3D&&t.camera.frustum instanceof S;if(t.mode===Q.SCENE3D&&!y&&u(a)){var f=o.occludeePointInScaledSpace;return u(f)?a.ellipsoid.isScaledSpacePointVisible(f)?p:I.NONE:p}return p},$.prototype.canRefine=function(e){return!!u(e.data.terrainData)||void 0!==this.terrainProvider.getTileDataAvailable(2*e.x,2*e.y,e.level+1)};var oe=[],se=[];$.prototype.canRenderWithoutLosingDetail=function(e,r){var t=e.data,i=oe;i.length=this._imageryLayers.length;var a,n,o,s=!1,d=!1;for(u(t)&&(s=t.terrainState===J.READY,d=!0,a=t.imagery),n=0,o=i.length;n<o;++n)i[n]=d;if(u(a))for(n=0,o=a.length;n<o;++n){var l=a[n],h=l.loadingImagery,c=!u(h)||h.state===F.FAILED||h.state===F.INVALID,m=(l.loadingImagery||l.readyImagery).imageryLayer._layerIndex;i[m]=c&&i[m]}var g=this.quadtree._lastSelectionFrameNumber,p=se;for(p.length=0,p.push(e.southwestChild,e.southeastChild,e.northwestChild,e.northeastChild);p.length>0;){var y=p.pop(),f=y._lastSelectionResultFrame===g?y._lastSelectionResult:G.NONE;if(f===G.RENDERED){var v=y.data;if(!u(v))continue;if(!s&&y.data.terrainState===J.READY)return!1;var _=y.data.imagery;for(n=0,o=_.length;n<o;++n){var T=_[n],x=T.loadingImagery,S=!u(x)||x.state===F.FAILED||x.state===F.INVALID,C=(T.loadingImagery||T.readyImagery).imageryLayer._layerIndex;if(S&&!i[C])return!1}}else f===G.REFINED&&p.push(y.southwestChild,y.southeastChild,y.northwestChild,y.northeastChild)}return!0};var de=new i;$.prototype.computeTileLoadPriority=function(e,r){var t=e.data;if(void 0===t)return 0;var a=t.orientedBoundingBox;if(void 0===a)return 0;var n=r.camera.positionWC,o=r.camera.directionWC,s=i.subtract(a.center,n,de),d=i.magnitude(s);return d<_.EPSILON5?0:(i.divideByScalar(s,d,s),(1-i.dot(s,o))*e._distance)};var le=new T,ue=new T,he=new a,ce=new a,me=new i,ge=new i,pe=new i,ye=new i;$.prototype.showTileThisFrame=function(e,r){for(var t=0,i=e.data.imagery,a=0,n=i.length;a<n;++a){var o=i[a];u(o.readyImagery)&&0!==o.readyImagery.imageryLayer.alpha&&++t}var s=this._tilesToRenderByTextureCount[t];u(s)||(s=[],this._tilesToRenderByTextureCount[t]=s),s.push(e);var d=e.data;u(d.vertexArray)?this._hasLoadedTilesThisFrame=!0:this._hasFillTilesThisFrame=!0;var l=this._debug;++l.tilesRendered,l.texturesRendered+=t};var fe=[new i,new i,new i,new i];$.prototype.computeDistanceToTile=function(e,r){var t=function(e,r,t){var i=e.data;void 0===i&&(i=e.data=new q);void 0===i.tileBoundingRegion&&(i.tileBoundingRegion=new V({computeBoundingVolumes:!1,rectangle:e.rectangle,ellipsoid:e.tilingScheme.ellipsoid,minimumHeight:0,maximumHeight:0}));var a=i.terrainData,n=i.mesh,o=i.tileBoundingRegion;if(void 0!==n&&void 0!==n.minimumHeight&&void 0!==n.maximumHeight)return o.minimumHeight=n.minimumHeight,o.maximumHeight=n.maximumHeight,e;if(void 0!==a&&void 0!==a._minimumHeight&&void 0!==a._maximumHeight)return o.minimumHeight=a._minimumHeight*t.terrainExaggeration,o.maximumHeight=a._maximumHeight*t.terrainExaggeration,e;o.minimumHeight=Number.NaN,o.maximumHeight=Number.NaN;var s=e.parent;for(;void 0!==s;){var d=s.data;if(void 0!==d){var l=d.mesh;if(void 0!==l&&void 0!==l.minimumHeight&&void 0!==l.maximumHeight)return o.minimumHeight=l.minimumHeight,o.maximumHeight=l.maximumHeight,s;var u=d.terrainData;if(void 0!==u&&void 0!==u._minimumHeight&&void 0!==u._maximumHeight)return o.minimumHeight=u._minimumHeight*t.terrainExaggeration,o.maximumHeight=u._maximumHeight*t.terrainExaggeration,s}s=s.parent}return}(e,this.terrainProvider,r),a=e.data,n=a.tileBoundingRegion;if(void 0===t)return 9999999999;if(a.boundingVolumeSourceTile!==t){a.boundingVolumeSourceTile=t;var o=e.rectangle;u(o)&&o.width<_.PI_OVER_TWO+_.EPSILON5&&(a.orientedBoundingBox=x.fromRectangle(e.rectangle,n.minimumHeight,n.maximumHeight,e.tilingScheme.ellipsoid,a.orientedBoundingBox),a.occludeePointInScaledSpace=function(e,r,t,a,n){var o=e.quadtree._occluders.ellipsoid,s=o.ellipsoid,d=fe;return i.fromRadians(t.west,t.south,a,s,d[0]),i.fromRadians(t.east,t.south,a,s,d[1]),i.fromRadians(t.west,t.north,a,s,d[2]),i.fromRadians(t.east,t.north,a,s,d[3]),o.computeHorizonCullingPoint(r,d,n)}(this,a.orientedBoundingBox.center,e.rectangle,n.maximumHeight,a.occludeePointInScaledSpace))}var s=n.minimumHeight,d=n.maximumHeight;if(a.boundingVolumeSourceTile!==e){var l=r.camera.positionCartographic.height;Math.abs(l-s)>Math.abs(l-d)?(n.minimumHeight=s,n.maximumHeight=s):(n.minimumHeight=d,n.maximumHeight=d)}var h=n.distanceToCamera(r);return n.minimumHeight=s,n.maximumHeight=d,h},$.prototype.isDestroyed=function(){return!1},$.prototype.destroy=function(){return this._tileProvider=this._tileProvider&&this._tileProvider.destroy(),this._clippingPlanes=this._clippingPlanes&&this._clippingPlanes.destroy(),c(this)},$.prototype._onLayerAdded=function(e,r){if(e.show){var t=this._terrainProvider,i=this,a=e.imageryProvider,n=this._imageryLayersUpdatedEvent;a._reload=function(){e._imageryCache={},i._quadtree.forEachLoadedTile(function(r){if(!u(r._loadedCallbacks[e._layerIndex])){var i,a=r.data.imagery,n=a.length,o=-1,s=0;for(i=0;i<n;++i){var d=a[i];if(l(d.readyImagery,d.loadingImagery).imageryLayer===e)-1===o&&(o=i),++s;else if(-1!==o)break}if(-1!==o){var h=o+s;e._createTileImagerySkeletons(r,t,h)&&(r._loadedCallbacks[e._layerIndex]=function(e,r,t){return function(i){var a,n,o,s=-1,d=i.data.imagery,h=d.length;for(o=0;o<h;++o)if(a=d[o],(n=l(a.readyImagery,a.loadingImagery)).imageryLayer===r){s=o;break}if(-1!==s){var c=s+e;if(a=d[c],n=u(a)?l(a.readyImagery,a.loadingImagery):void 0,!u(n)||n.imageryLayer!==r)return!r._createTileImagerySkeletons(i,t,c);for(o=s;o<c;++o)d[o].freeResources();d.splice(s,e)}return!0}}(s,e,t),r.state=Y.LOADING)}}})},this._quadtree.forEachLoadedTile(function(r){e._createTileImagerySkeletons(r,t)&&(r.state=Y.LOADING,0===r.level||r._lastSelectionResultFrame===i.quadtree._lastSelectionFrameNumber&&r._lastSelectionResult===G.RENDERED||(r.renderable=!1))}),this._layerOrderChanged=!0,n.raiseEvent()}},$.prototype._onLayerRemoved=function(e,r){this._quadtree.forEachLoadedTile(function(r){for(var t=r.data.imagery,i=-1,a=0,n=0,o=t.length;n<o;++n){var s=t[n],d=s.loadingImagery;if(u(d)||(d=s.readyImagery),d.imageryLayer===e)-1===i&&(i=n),s.freeResources(),++a;else if(-1!==i)break}-1!==i&&t.splice(i,a)}),u(e.imageryProvider)&&(e.imageryProvider._reload=void 0),this._imageryLayersUpdatedEvent.raiseEvent()},$.prototype._onLayerMoved=function(e,r,t){this._layerOrderChanged=!0,this._imageryLayersUpdatedEvent.raiseEvent()},$.prototype._onLayerShownOrHidden=function(e,r,t){t?this._onLayerAdded(e,r):this._onLayerRemoved(e,r)};var ve,_e,Te,xe=new T;function Se(e,r){return{u_initialColor:function(){return this.properties.initialColor},u_fillHighlightColor:function(){return this.properties.fillHighlightColor},u_zoomedOutOceanSpecularIntensity:function(){return this.properties.zoomedOutOceanSpecularIntensity},u_oceanNormalMap:function(){return this.properties.oceanNormalMap},u_lightingFadeDistance:function(){return this.properties.lightingFadeDistance},u_nightFadeDistance:function(){return this.properties.nightFadeDistance},u_center3D:function(){return this.properties.center3D},u_tileRectangle:function(){return this.properties.tileRectangle},u_modifiedModelView:function(){var r=e.context.uniformState.view,t=T.multiplyByPoint(r,this.properties.rtc,ge);return T.setTranslation(r,t,le),le},u_modifiedModelViewProjection:function(){var r=e.context.uniformState.view,t=e.context.uniformState.projection,i=T.multiplyByPoint(r,this.properties.rtc,ge);return T.setTranslation(r,i,ue),T.multiply(t,ue,ue),ue},u_dayTextures:function(){return this.properties.dayTextures},u_dayTextureTranslationAndScale:function(){return this.properties.dayTextureTranslationAndScale},u_dayTextureTexCoordsRectangle:function(){return this.properties.dayTextureTexCoordsRectangle},u_dayTextureUseWebMercatorT:function(){return this.properties.dayTextureUseWebMercatorT},u_dayTextureAlpha:function(){return this.properties.dayTextureAlpha},u_dayTextureBrightness:function(){return this.properties.dayTextureBrightness},u_dayTextureContrast:function(){return this.properties.dayTextureContrast},u_dayTextureHue:function(){return this.properties.dayTextureHue},u_dayTextureSaturation:function(){return this.properties.dayTextureSaturation},u_dayTextureOneOverGamma:function(){return this.properties.dayTextureOneOverGamma},u_dayIntensity:function(){return this.properties.dayIntensity},u_southAndNorthLatitude:function(){return this.properties.southAndNorthLatitude},u_southMercatorYAndOneOverHeight:function(){return this.properties.southMercatorYAndOneOverHeight},u_waterMask:function(){return this.properties.waterMask},u_waterMaskTranslationAndScale:function(){return this.properties.waterMaskTranslationAndScale},u_minMaxHeight:function(){return this.properties.minMaxHeight},u_scaleAndBias:function(){return this.properties.scaleAndBias},u_dayTextureSplit:function(){return this.properties.dayTextureSplit},u_dayTextureCutoutRectangles:function(){return this.properties.dayTextureCutoutRectangles},u_clippingPlanes:function(){var t=r._clippingPlanes;return u(t)&&u(t.texture)?t.texture:e.context.defaultTexture},u_cartographicLimitRectangle:function(){return this.properties.localizedCartographicLimitRectangle},u_clippingPlanesMatrix:function(){var t=r._clippingPlanes;return u(t)?T.multiply(e.context.uniformState.view,t.modelMatrix,xe):T.IDENTITY},u_clippingPlanesEdgeStyle:function(){var e=this.properties.clippingPlanesEdgeColor;return e.alpha=this.properties.clippingPlanesEdgeWidth,e},u_minimumBrightness:function(){return e.fog.minimumBrightness},u_hsbShift:function(){return this.properties.hsbShift},u_colorsToAlpha:function(){return this.properties.colorsToAlpha},properties:{initialColor:new a(0,0,.5,1),fillHighlightColor:new o(0,0,0,0),zoomedOutOceanSpecularIntensity:.5,oceanNormalMap:void 0,lightingFadeDistance:new t(65e5,9e6),nightFadeDistance:new t(1e7,4e7),hsbShift:new i,center3D:void 0,rtc:new i,modifiedModelView:new T,tileRectangle:new a,dayTextures:[],dayTextureTranslationAndScale:[],dayTextureTexCoordsRectangle:[],dayTextureUseWebMercatorT:[],dayTextureAlpha:[],dayTextureBrightness:[],dayTextureContrast:[],dayTextureHue:[],dayTextureSaturation:[],dayTextureOneOverGamma:[],dayTextureSplit:[],dayTextureCutoutRectangles:[],dayIntensity:0,colorsToAlpha:[],southAndNorthLatitude:new t,southMercatorYAndOneOverHeight:new t,waterMask:void 0,waterMaskTranslationAndScale:new a,minMaxHeight:new t,scaleAndBias:new T,clippingPlanesEdgeColor:o.clone(o.WHITE),clippingPlanesEdgeWidth:0,localizedCartographicLimitRectangle:new a}}}function Ce(e,r,t){var i,a,n=t.data;if(u(n.vertexArray)?(i=n.mesh,a=n.vertexArray):u(n.fill)&&u(n.fill.vertexArray)&&(i=n.fill.mesh,a=n.fill.vertexArray),u(i)&&u(a)){if(u(n.wireframeVertexArray)){if(n.wireframeVertexArray.mesh===i)return;n.wireframeVertexArray.destroy(),n.wireframeVertexArray=void 0}n.wireframeVertexArray=function(e,r,t){var i={indices:t.indices,primitiveType:C.TRIANGLES};y.toWireframe(i);var a=i.indices,n=P.createIndexBuffer({context:e,typedArray:a,usage:b.STATIC_DRAW,indexDatatype:f.fromSizeInBytes(a.BYTES_PER_ELEMENT)});return new B({context:e,attributes:r._attributes,indexBuffer:n})}(e,a,i),n.wireframeVertexArray.mesh=i}}!function(){var e,t,a=new p({geometry:r.fromDimensions({dimensions:new i(2,2,2)})}),n=new p({geometry:new E({radius:1})}),o=new T;function d(e){return new j({geometryInstances:e,appearance:new k({translucent:!1,flat:!0}),asynchronous:!1})}ve=function(r,i){return r===e?t:(Te(),e=r,o=T.fromRotationTranslation(r.halfAxes,r.center,o),a.modelMatrix=o,a.attributes.color=s.fromColor(i),t=d(a))},_e=function(r,i){return r===e?t:(Te(),e=r,o=T.fromTranslation(r.center,o),o=T.multiplyByUniformScale(o,r.radius,o),n.modelMatrix=o,n.attributes.color=s.fromColor(i),t=d(n))},Te=function(){u(t)&&(t.destroy(),t=void 0,e=void 0)}}();var we=new a(0,0,0,0),Ee={frameState:void 0,surfaceTile:void 0,numberOfDayTextures:void 0,applyBrightness:void 0,applyContrast:void 0,applyHue:void 0,applySaturation:void 0,applyGamma:void 0,applyAlpha:void 0,applySplit:void 0,showReflectiveOcean:void 0,showOceanWaves:void 0,enableLighting:void 0,showGroundAtmosphere:void 0,perFragmentGroundAtmosphere:void 0,hasVertexNormals:void 0,useWebMercatorProjection:void 0,enableFog:void 0,enableClippingPlanes:void 0,clippingPlanes:void 0,clippedByBoundaries:void 0,hasImageryLayerCutout:void 0,colorCorrect:void 0,colorToAlpha:void 0};function Ae(r,t,s){var l=t.data;u(l.vertexArray)||(void 0===l.fill&&(l.fill=new Z(t)),l.fill.update(r,s));var h=s.creditDisplay,c=l.terrainData;if(u(c)&&u(c.credits))for(var g=c.credits,p=0,y=g.length;p<y;++p)h.addCredit(g[p]);var f=D.maximumTextureImageUnits,v=l.waterMaskTexture,S=l.waterMaskTranslationAndScale;!u(v)&&u(l.fill)&&(v=l.fill.waterMaskTexture,S=l.fill.waterMaskTranslationAndScale);var E=r.hasWaterMask&&u(v),A=r.oceanNormalMap,I=E&&u(A),P=r.terrainProvider.ready&&r.terrainProvider.hasVertexNormals,b=s.fog.enabled,H=r.showGroundAtmosphere,B=X.castShadows(r.shadows),N=X.receiveShadows(r.shadows),F=r.hueShift,V=r.saturationShift,G=r.brightnessShift,U=!(_.equalsEpsilon(F,0,_.EPSILON7)&&_.equalsEpsilon(V,0,_.EPSILON7)&&_.equalsEpsilon(G,0,_.EPSILON7)),W=!1;if(H){var q,k=s.mode,j=s.camera;q=k===Q.SCENE2D||k===Q.COLUMBUS_VIEW?j.positionCartographic.height:i.magnitude(j.positionWC);var Y=r.nightFadeOutDistance;k!==Q.SCENE3D&&(Y-=s.mapProjection.ellipsoid.maximumRadius),W=q>Y}E&&--f,I&&--f;var J=l.renderedMesh,$=J.center,ee=J.encoding,re=he,ie=0,ae=0,oe=0,se=0,de=!1;if(s.mode!==Q.SCENE3D){var le=s.mapProjection,ue=le.project(w.southwest(t.rectangle),pe),ge=le.project(w.northeast(t.rectangle),ye);if(re.x=ue.x,re.y=ue.y,re.z=ge.x,re.w=ge.y,s.mode!==Q.MORPHING&&(($=me).x=0,$.y=.5*(re.z+re.x),$.z=.5*(re.w+re.y),re.x-=$.y,re.y-=$.z,re.z-=$.y,re.w-=$.z),s.mode===Q.SCENE2D&&ee.quantization===L.BITS12){var fe=1/(Math.pow(2,12)-1)*.5,xe=(re.z-re.x)*fe,Ae=(re.w-re.y)*fe;re.x-=xe,re.y-=Ae,re.z+=xe,re.w+=Ae}le instanceof R&&(ie=t.rectangle.south,ae=t.rectangle.north,oe=R.geodeticLatitudeToMercatorAngle(ie),se=1/(R.geodeticLatitudeToMercatorAngle(ae)-oe),de=!0)}var Le=Ee;Le.frameState=s,Le.surfaceTile=l,Le.showReflectiveOcean=E,Le.showOceanWaves=I,Le.enableLighting=r.enableLighting,Le.showGroundAtmosphere=H,Le.perFragmentGroundAtmosphere=W,Le.hasVertexNormals=P,Le.useWebMercatorProjection=de,Le.clippedByBoundaries=l.clippedByBoundaries;var Ie=l.imagery,Re=0,Pe=Ie.length,be=r._renderState,De=r._blendRenderState,Me=be,Oe=r._firstPassInitialColor,He=s.context;u(r._debug.boundingSphereTile)||Te();do{var Be,Ne,Fe=0;if(r._drawCommands.length<=r._usedDrawCommands?((Be=new M).owner=t,Be.cull=!1,Be.boundingVolume=new e,Be.orientedBoundingBox=void 0,Ne=Se(s,r),r._drawCommands.push(Be),r._uniformMaps.push(Ne)):(Be=r._drawCommands[r._usedDrawCommands],Ne=r._uniformMaps[r._usedDrawCommands]),Be.owner=t,++r._usedDrawCommands,t===r._debug.boundingSphereTile){var Ve=l.orientedBoundingBox;u(Ve)?ve(Ve,o.RED).update(s):u(J)&&u(J.boundingSphere3D)&&_e(J.boundingSphere3D,o.RED).update(s)}var Ge=Ne.properties;a.clone(Oe,Ge.initialColor),Ge.oceanNormalMap=A,Ge.lightingFadeDistance.x=r.lightingFadeOutDistance,Ge.lightingFadeDistance.y=r.lightingFadeInDistance,Ge.nightFadeDistance.x=r.nightFadeOutDistance,Ge.nightFadeDistance.y=r.nightFadeInDistance,Ge.zoomedOutOceanSpecularIntensity=r.zoomedOutOceanSpecularIntensity;var Ue=!u(l.vertexArray)&&u(r.fillHighlightColor)&&r.fillHighlightColor.alpha>0;Ue&&o.clone(r.fillHighlightColor,Ge.fillHighlightColor),Ge.center3D=J.center,i.clone($,Ge.rtc),a.clone(re,Ge.tileRectangle),Ge.southAndNorthLatitude.x=ie,Ge.southAndNorthLatitude.y=ae,Ge.southMercatorYAndOneOverHeight.x=oe,Ge.southMercatorYAndOneOverHeight.y=se;var We=ce,qe=ne(t.rectangle,r.cartographicLimitRectangle);i.fromElements(F,V,G,Ge.hsbShift);var ze=t.rectangle,ke=1/ze.width,je=1/ze.height;We.x=(qe.west-ze.west)*ke,We.y=(qe.south-ze.south)*je,We.z=(qe.east-ze.west)*ke,We.w=(qe.north-ze.south)*je,a.clone(We,Ge.localizedCartographicLimitRectangle);var Ye=b&&_.fog(t._distance,s.fog.density)>_.EPSILON3;U=U&&(Ye||H);for(var Qe=!1,Xe=!1,Ze=!1,Je=!1,Ke=!1,$e=!1,er=!1,rr=!1,tr=!1;Fe<f&&Re<Pe;){var ir=Ie[Re],ar=ir.readyImagery;if(++Re,u(ar)&&0!==ar.imageryLayer.alpha){var nr=ir.useWebMercatorT?ar.textureWebMercator:ar.texture;if(!u(nr))throw new m("readyImagery is not actually ready!");var or=ar.imageryLayer;u(ir.textureTranslationAndScale)||(ir.textureTranslationAndScale=or._calculateTextureTranslationAndScale(t,ir)),Ge.dayTextures[Fe]=nr,Ge.dayTextureTranslationAndScale[Fe]=ir.textureTranslationAndScale,Ge.dayTextureTexCoordsRectangle[Fe]=ir.textureCoordinateRectangle,Ge.dayTextureUseWebMercatorT[Fe]=ir.useWebMercatorT,Ge.dayTextureAlpha[Fe]=or.alpha,$e=$e||1!==Ge.dayTextureAlpha[Fe],Ge.dayTextureBrightness[Fe]=or.brightness,Qe=Qe||Ge.dayTextureBrightness[Fe]!==z.DEFAULT_BRIGHTNESS,Ge.dayTextureContrast[Fe]=or.contrast,Xe=Xe||Ge.dayTextureContrast[Fe]!==z.DEFAULT_CONTRAST,Ge.dayTextureHue[Fe]=or.hue,Ze=Ze||Ge.dayTextureHue[Fe]!==z.DEFAULT_HUE,Ge.dayTextureSaturation[Fe]=or.saturation,Je=Je||Ge.dayTextureSaturation[Fe]!==z.DEFAULT_SATURATION,Ge.dayTextureOneOverGamma[Fe]=1/or.gamma,Ke=Ke||Ge.dayTextureOneOverGamma[Fe]!==1/z.DEFAULT_GAMMA,Ge.dayTextureSplit[Fe]=or.splitDirection,er=er||0!==Ge.dayTextureSplit[Fe];var sr=Ge.dayTextureCutoutRectangles[Fe];if(u(sr)||(sr=Ge.dayTextureCutoutRectangles[Fe]=new a),a.clone(a.ZERO,sr),u(or.cutoutRectangle)){var dr=ne(ze,or.cutoutRectangle),lr=w.simpleIntersection(dr,ze,te);rr=u(lr)||rr,sr.x=(dr.west-ze.west)*ke,sr.y=(dr.south-ze.south)*je,sr.z=(dr.east-ze.west)*ke,sr.w=(dr.north-ze.south)*je}var ur=Ge.colorsToAlpha[Fe];u(ur)||(ur=Ge.colorsToAlpha[Fe]=new a);var hr=u(or.colorToAlpha)&&or.colorToAlphaThreshold>0;if(tr=tr||hr,hr){var cr=or.colorToAlpha;ur.x=cr.red,ur.y=cr.green,ur.z=cr.blue,ur.w=or.colorToAlphaThreshold}else ur.w=-1;if(u(ar.credits))for(var mr=ar.credits,gr=0,pr=mr.length;gr<pr;++gr)h.addCredit(mr[gr]);++Fe}}Ge.dayTextures.length=Fe,Ge.waterMask=v,a.clone(S,Ge.waterMaskTranslationAndScale),Ge.minMaxHeight.x=ee.minimumHeight,Ge.minMaxHeight.y=ee.maximumHeight,T.clone(ee.matrix,Ge.scaleAndBias);var yr=r._clippingPlanes,fr=u(yr)&&yr.enabled&&t.isClipped;fr&&(Ge.clippingPlanesEdgeColor=o.clone(yr.edgeColor,Ge.clippingPlanesEdgeColor),Ge.clippingPlanesEdgeWidth=yr.edgeWidth),u(r.uniformMap)&&(Ne=d(Ne,r.uniformMap)),Le.numberOfDayTextures=Fe,Le.applyBrightness=Qe,Le.applyContrast=Xe,Le.applyHue=Ze,Le.applySaturation=Je,Le.applyGamma=Ke,Le.applyAlpha=$e,Le.applySplit=er,Le.enableFog=Ye,Le.enableClippingPlanes=fr,Le.clippingPlanes=yr,Le.hasImageryLayerCutout=rr,Le.colorCorrect=U,Le.highlightFillTile=Ue,Le.colorToAlpha=tr,Be.shaderProgram=r._surfaceShaderSet.getShaderProgram(Le),Be.castShadows=B,Be.receiveShadows=N,Be.renderState=Me,Be.primitiveType=C.TRIANGLES,Be.vertexArray=l.vertexArray||l.fill.vertexArray,Be.uniformMap=Ne;var vr=n.fromCartesian(s.camera.position).height;Be.pass=K.underEarth.enable&&vr<4e5?O.TRANSLUCENT:O.GLOBE,r._debug.wireframe&&(Ce(He,0,t),u(l.wireframeVertexArray)&&(Be.vertexArray=l.wireframeVertexArray,Be.primitiveType=C.LINES));var _r=Be.boundingVolume,Tr=Be.orientedBoundingBox;if(s.mode!==Q.SCENE3D){var xr=l.tileBoundingRegion;e.fromRectangleWithHeights2D(t.rectangle,s.mapProjection,xr.minimumHeight,xr.maximumHeight,_r),i.fromElements(_r.center.z,_r.center.x,_r.center.y,_r.center),s.mode===Q.MORPHING&&(_r=e.union(J.boundingSphere3D,_r,_r))}else Be.boundingVolume=e.clone(J.boundingSphere3D,_r),Be.orientedBoundingBox=x.clone(l.orientedBoundingBox,Tr);Be.dirty=!0,s.commandList.push(Be),Me=De,Oe=we}while(Re<Pe)}return $});