define(["../Core/Cartographic","../Core/Cartesian2","../Core/Cartesian3","../Core/Math","../Core/Check","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/EncodedCartesian3","../Core/GeometryInstanceAttribute","../Core/Matrix4","../Core/Rectangle","../Core/Transforms","../Renderer/ShaderSource","../Scene/PerInstanceColorAppearance","../Shaders/ShadowVolumeAppearanceFS"],function(e,t,n,r,i,o,s,a,u,h,l,p,c,d,E,C,_){"use strict";var f={eastMostYhighDefine:"",eastMostYlowDefine:"",westMostYhighDefine:"",westMostYlowDefine:""};function m(e,t,n){i.typeOf.bool("extentsCulling",e),i.typeOf.bool("planarExtents",t),i.typeOf.object("appearance",n);var r=new y;r.requiresTextureCoordinates=e,r.requiresEC=!n.flat;var o=new y;if(o.requiresTextureCoordinates=e,n instanceof C)r.requiresNormalEC=!n.flat;else{var s=n.material.shaderSource+"\n"+n.fragmentShaderSource;r.normalEC=-1!==s.indexOf("materialInput.normalEC")||-1!==s.indexOf("czm_getDefaultMaterial"),r.positionToEyeEC=-1!==s.indexOf("materialInput.positionToEyeEC"),r.tangentToEyeMatrix=-1!==s.indexOf("materialInput.tangentToEyeMatrix"),r.st=-1!==s.indexOf("materialInput.st")}this._colorShaderDependencies=r,this._pickShaderDependencies=o,this._appearance=n,this._extentsCulling=e,this._planarExtents=t}m.prototype.createFragmentShader=function(e){i.typeOf.bool("columbusView2D",e);var t=this._appearance,n=this._colorShaderDependencies,r=[];e||this._planarExtents||r.push("SPHERICAL"),n.requiresEC&&r.push("REQUIRES_EC"),n.requiresWC&&r.push("REQUIRES_WC"),n.requiresTextureCoordinates&&r.push("TEXTURE_COORDINATES"),this._extentsCulling&&r.push("CULL_FRAGMENTS"),n.requiresNormalEC&&r.push("NORMAL_EC"),t instanceof C&&r.push("PER_INSTANCE_COLOR"),n.normalEC&&r.push("USES_NORMAL_EC"),n.positionToEyeEC&&r.push("USES_POSITION_TO_EYE_EC"),n.tangentToEyeMatrix&&r.push("USES_TANGENT_TO_EYE"),n.st&&r.push("USES_ST"),t.flat&&r.push("FLAT");var o="";return t instanceof C||(o=t.material.shaderSource),new E({defines:r,sources:[o,_]})},m.prototype.createPickFragmentShader=function(e){i.typeOf.bool("columbusView2D",e);var t=this._pickShaderDependencies,n=["PICK"];return e||this._planarExtents||n.push("SPHERICAL"),t.requiresEC&&n.push("REQUIRES_EC"),t.requiresWC&&n.push("REQUIRES_WC"),t.requiresTextureCoordinates&&n.push("TEXTURE_COORDINATES"),this._extentsCulling&&n.push("CULL_FRAGMENTS"),new E({defines:n,sources:[_],pickColorQualifier:"varying"})},m.prototype.createVertexShader=function(e,t,n,r){return i.defined("defines",e),i.typeOf.string("vertexShaderSource",t),i.typeOf.bool("columbusView2D",n),i.defined("mapProjection",r),w(this._colorShaderDependencies,this._planarExtents,n,e,t,this._appearance,r)},m.prototype.createPickVertexShader=function(e,t,n,r){return i.defined("defines",e),i.typeOf.string("vertexShaderSource",t),i.typeOf.bool("columbusView2D",n),i.defined("mapProjection",r),w(this._pickShaderDependencies,this._planarExtents,n,e,t,void 0,r)};var x=new n,T=new e,g={high:0,low:0};function w(e,t,n,i,o,s,u){var l=i.slice();if(""===f.eastMostYhighDefine){var p=T;p.longitude=r.PI,p.latitude=0,p.height=0;var c=u.project(p,x),d=h.encode(c.x,g);f.eastMostYhighDefine="EAST_MOST_X_HIGH "+d.high.toFixed((d.high+"").length+1),f.eastMostYlowDefine="EAST_MOST_X_LOW "+d.low.toFixed((d.low+"").length+1);var _=T;_.longitude=-r.PI,_.latitude=0,_.height=0;var m=u.project(_,x);d=h.encode(m.x,g),f.westMostYhighDefine="WEST_MOST_X_HIGH "+d.high.toFixed((d.high+"").length+1),f.westMostYlowDefine="WEST_MOST_X_LOW "+d.low.toFixed((d.low+"").length+1)}return n&&(l.push(f.eastMostYhighDefine),l.push(f.eastMostYlowDefine),l.push(f.westMostYhighDefine),l.push(f.westMostYlowDefine)),a(s)&&s instanceof C&&l.push("PER_INSTANCE_COLOR"),e.requiresTextureCoordinates&&(l.push("TEXTURE_COORDINATES"),t||n||l.push("SPHERICAL"),n&&l.push("COLUMBUS_VIEW_2D")),new E({defines:l,sources:[o]})}function y(){this._requiresEC=!1,this._requiresWC=!1,this._requiresNormalEC=!1,this._requiresTextureCoordinates=!1,this._usesNormalEC=!1,this._usesPositionToEyeEC=!1,this._usesTangentToEyeMat=!1,this._usesSt=!1}function S(e,n,r){return Math.abs((n.y-e.y)*r.x-(n.x-e.x)*r.y+n.x*e.y-n.y*e.x)/t.distance(n,e)}u(y.prototype,{requiresEC:{get:function(){return this._requiresEC},set:function(e){this._requiresEC=e||this._requiresEC}},requiresWC:{get:function(){return this._requiresWC},set:function(e){this._requiresWC=e||this._requiresWC,this.requiresEC=this._requiresWC}},requiresNormalEC:{get:function(){return this._requiresNormalEC},set:function(e){this._requiresNormalEC=e||this._requiresNormalEC,this.requiresEC=this._requiresNormalEC}},requiresTextureCoordinates:{get:function(){return this._requiresTextureCoordinates},set:function(e){this._requiresTextureCoordinates=e||this._requiresTextureCoordinates,this.requiresWC=this._requiresTextureCoordinates}},normalEC:{set:function(e){this.requiresNormalEC=e,this._usesNormalEC=e},get:function(){return this._usesNormalEC}},tangentToEyeMatrix:{set:function(e){this.requiresWC=e,this.requiresNormalEC=e,this._usesTangentToEyeMat=e},get:function(){return this._usesTangentToEyeMat}},positionToEyeEC:{set:function(e){this.requiresEC=e,this._usesPositionToEyeEC=e},get:function(){return this._usesPositionToEyeEC}},st:{set:function(e){this.requiresTextureCoordinates=e,this._usesSt=e},get:function(){return this._usesSt}}});var O=[new t,new t,new t,new t];function v(e,n){var r=O,i=t.unpack(n,0,r[0]),s=t.unpack(n,2,r[1]),a=t.unpack(n,4,r[2]);e.uMaxVmax=new l({componentDatatype:o.FLOAT,componentsPerAttribute:4,normalize:!1,value:[s.x,s.y,a.x,a.y]});var u=1/S(i,s,a),h=1/S(i,a,s);e.uvMinAndExtents=new l({componentDatatype:o.FLOAT,componentsPerAttribute:4,normalize:!1,value:[i.x,i.y,u,h]})}var A=new e,I=new n,N=new n,D=new n,M={high:0,low:0};function P(e,t,n){var r=A;r.height=0,r.longitude=e.west,r.latitude=e.south;var i=t.project(r,I);r.latitude=e.north;var s=t.project(r,N);r.longitude=e.east,r.latitude=e.south;var a=t.project(r,D),u=[0,0,0,0],p=[0,0,0,0],c=h.encode(i.x,M);u[0]=c.high,p[0]=c.low,c=h.encode(i.y,M),u[1]=c.high,p[1]=c.low,c=h.encode(s.y,M),u[2]=c.high,p[2]=c.low,c=h.encode(a.x,M),u[3]=c.high,p[3]=c.low,n.planes2D_HIGH=new l({componentDatatype:o.FLOAT,componentsPerAttribute:4,normalize:!1,value:u}),n.planes2D_LOW=new l({componentDatatype:o.FLOAT,componentsPerAttribute:4,normalize:!1,value:p})}var q=new p,b=new p,R=new n,L=new e,F=[new e,new e,new e,new e,new e,new e,new e,new e];var W=new n,H=new n,Y=new h;m.getPlanarTextureCoordinateAttributes=function(t,r,a,u,E){i.typeOf.object("boundingRectangle",t),i.defined("textureCoordinateRotationPoints",r),i.typeOf.object("ellipsoid",a),i.typeOf.object("projection",u);var C=I,_=W,f=H;!function(t,r,i,o,s,a){var u=c.center(t,L);u.height=i;var h=e.toCartesian(u,r,R),l=d.eastNorthUpToFixedFrame(h,r,q),E=p.inverse(l,b),C=t.west,_=t.east,f=t.north,m=t.south,x=F;x[0].latitude=m,x[0].longitude=C,x[1].latitude=f,x[1].longitude=C,x[2].latitude=f,x[2].longitude=_,x[3].latitude=m,x[3].longitude=_;var T=.5*(C+_),g=.5*(f+m);x[4].latitude=m,x[4].longitude=T,x[5].latitude=f,x[5].longitude=T,x[6].latitude=g,x[6].longitude=C,x[7].latitude=g,x[7].longitude=_;for(var w=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,S=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,v=0;v<8;v++){x[v].height=i;var A=e.toCartesian(x[v],r,R);p.multiplyByPoint(E,A,A),A.z=0,w=Math.min(w,A.x),y=Math.max(y,A.x),S=Math.min(S,A.y),O=Math.max(O,A.y)}var I=o;I.x=w,I.y=S,I.z=0,p.multiplyByPoint(l,I,I);var N=s;N.x=y,N.y=S,N.z=0,p.multiplyByPoint(l,N,N),n.subtract(N,I,s);var D=a;D.x=w,D.y=O,D.z=0,p.multiplyByPoint(l,D,D),n.subtract(D,I,a)}(t,a,s(E,0),C,_,f);var m={};v(m,r);var x=h.fromCartesian(C,Y);return m.southWest_HIGH=new l({componentDatatype:o.FLOAT,componentsPerAttribute:3,normalize:!1,value:n.pack(x.high,[0,0,0])}),m.southWest_LOW=new l({componentDatatype:o.FLOAT,componentsPerAttribute:3,normalize:!1,value:n.pack(x.low,[0,0,0])}),m.eastward=new l({componentDatatype:o.FLOAT,componentsPerAttribute:3,normalize:!1,value:n.pack(_,[0,0,0])}),m.northward=new l({componentDatatype:o.FLOAT,componentsPerAttribute:3,normalize:!1,value:n.pack(f,[0,0,0])}),P(t,u,m),m};var j=new n;function U(t,n,i,o){var s=A;s.latitude=t,s.longitude=n,s.height=0;var a=e.toCartesian(s,i,j),u=Math.sqrt(a.x*a.x+a.y*a.y),h=r.fastApproximateAtan2(u,a.z),l=r.fastApproximateAtan2(a.x,a.y);return o.x=h,o.y=l,o}var z=new t;return m.getSphericalExtentGeometryInstanceAttributes=function(e,t,n,s){i.typeOf.object("boundingRectangle",e),i.defined("textureCoordinateRotationPoints",t),i.typeOf.object("ellipsoid",n),i.typeOf.object("projection",s);var a=U(e.south,e.west,n,z),u=a.x,h=a.y,p=U(e.north,e.east,n,z),c=p.x,d=p.y,E=0;h>d&&(E=r.PI-h,h=-r.PI,d+=E),u-=r.EPSILON5,h-=r.EPSILON5,c+=r.EPSILON5;var C=1/((d+=r.EPSILON5)-h),_=1/(c-u),f={sphericalExtents:new l({componentDatatype:o.FLOAT,componentsPerAttribute:4,normalize:!1,value:[u,h,_,C]}),longitudeRotation:new l({componentDatatype:o.FLOAT,componentsPerAttribute:1,normalize:!1,value:[E]})};return v(f,t),P(e,s,f),f},m.hasAttributesForTextureCoordinatePlanes=function(e){return a(e.southWest_HIGH)&&a(e.southWest_LOW)&&a(e.northward)&&a(e.eastward)&&a(e.planes2D_HIGH)&&a(e.planes2D_LOW)&&a(e.uMaxVmax)&&a(e.uvMinAndExtents)},m.hasAttributesForSphericalExtents=function(e){return a(e.sphericalExtents)&&a(e.longitudeRotation)&&a(e.planes2D_HIGH)&&a(e.planes2D_LOW)&&a(e.uMaxVmax)&&a(e.uvMinAndExtents)},m.shouldUseSphericalCoordinates=function(e){return i.typeOf.object("rectangle",e),function(e){return Math.max(e.width,e.height)>m.MAX_WIDTH_FOR_PLANAR_EXTENTS}(e)},m.MAX_WIDTH_FOR_PLANAR_EXTENTS=r.toRadians(1),m});