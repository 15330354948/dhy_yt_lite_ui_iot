define(["../Core/Cartesian3","../Core/Check","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DistanceDisplayCondition","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/EllipsoidGeometry","../Core/EllipsoidOutlineGeometry","../Core/GeometryInstance","../Core/GeometryOffsetAttribute","../Core/Iso8601","../Core/OffsetGeometryInstanceAttribute","../Core/Matrix4","../Core/ShowGeometryInstanceAttribute","../Scene/HeightReference","../Scene/MaterialAppearance","../Scene/PerInstanceColorAppearance","../Scene/Primitive","../Scene/SceneMode","./heightReferenceOnEntityPropertyChanged","./ColorMaterialProperty","./DynamicGeometryUpdater","./GeometryUpdater","./MaterialProperty","./Property"],function(t,e,i,o,s,r,n,a,l,h,d,u,p,c,f,_,y,m,v,C,g,O,P,w,V,M,D,b){"use strict";var A=new w(i.WHITE),U=t.ZERO,I=new t,S=new t,E=new i,x=new t(1,1,1);function N(t,e){M.call(this,{entity:t,scene:e,geometryOptions:new function(t){this.id=t,this.vertexFormat=void 0,this.radii=void 0,this.stackPartitions=void 0,this.slicePartitions=void 0,this.subdivisions=void 0,this.offsetAttribute=void 0}(t),geometryPropertyName:"ellipsoid",observedPropertyNames:["availability","position","orientation","ellipsoid"]}),this._onEntityPropertyChanged(t,"ellipsoid",t.ellipsoid,void 0)}function G(e,i,o){V.call(this,e,i,o),this._scene=e._scene,this._modelMatrix=new _,this._attributes=void 0,this._outlineAttributes=void 0,this._lastSceneMode=void 0,this._lastShow=void 0,this._lastOutlineShow=void 0,this._lastOutlineWidth=void 0,this._lastOutlineColor=void 0,this._lastOffset=new t,this._material={}}return r(Object.create)&&(N.prototype=Object.create(M.prototype),N.prototype.constructor=N),n(N.prototype,{terrainOffsetProperty:{get:function(){return this._terrainOffsetProperty}}}),N.prototype.createFillGeometryInstance=function(t,s,n){e.defined("time",t);var a,d,p=this._entity,c=p.isAvailable(t),_=new y(c&&p.isShowing&&this._showProperty.getValue(t)&&this._fillProperty.getValue(t)),m=this._distanceDisplayConditionProperty.getValue(t),v={show:_,distanceDisplayCondition:l.fromDistanceDisplayCondition(m),color:void 0,offset:void 0};this._materialProperty instanceof w&&(r(this._materialProperty.color)&&(this._materialProperty.color.isConstant||c)&&(d=this._materialProperty.color.getValue(t,E)),r(d)||(d=i.WHITE),a=o.fromColor(d),v.color=a);return r(this._options.offsetAttribute)&&(v.offset=f.fromCartesian3(b.getValueOrDefault(this._terrainOffsetProperty,t,U,I))),new u({id:p,geometry:new h(this._options),modelMatrix:s?void 0:p.computeModelMatrixForHeightReference(t,p.ellipsoid.heightReference,.5*this._options.radii.z,this._scene.mapProjection.ellipsoid,n),attributes:v})},N.prototype.createOutlineGeometryInstance=function(t,s,n){e.defined("time",t);var a=this._entity,h=a.isAvailable(t),p=b.getValueOrDefault(this._outlineColorProperty,t,i.BLACK,E),c=this._distanceDisplayConditionProperty.getValue(t),_={show:new y(h&&a.isShowing&&this._showProperty.getValue(t)&&this._showOutlineProperty.getValue(t)),color:o.fromColor(p),distanceDisplayCondition:l.fromDistanceDisplayCondition(c),offset:void 0};return r(this._options.offsetAttribute)&&(_.offset=f.fromCartesian3(b.getValueOrDefault(this._terrainOffsetProperty,t,U,I))),new u({id:a,geometry:new d(this._options),modelMatrix:s?void 0:a.computeModelMatrixForHeightReference(t,a.ellipsoid.heightReference,.5*this._options.radii.z,this._scene.mapProjection.ellipsoid,n),attributes:_})},N.prototype._computeCenter=function(t,e){return b.getValueOrUndefined(this._entity.position,t,e)},N.prototype._isHidden=function(t,e){return!r(t.position)||!r(e.radii)||M.prototype._isHidden.call(this,t,e)},N.prototype._isDynamic=function(t,e){return!(t.position.isConstant&&b.isConstant(t.orientation)&&e.radii.isConstant&&b.isConstant(e.stackPartitions)&&b.isConstant(e.slicePartitions)&&b.isConstant(e.outlineWidth)&&b.isConstant(e.subdivisions))},N.prototype._setStaticOptions=function(t,e){var i=b.getValueOrDefault(e.heightReference,c.MINIMUM_VALUE,m.NONE),o=this._options;o.vertexFormat=this._materialProperty instanceof w?C.VERTEX_FORMAT:v.MaterialSupport.TEXTURED.vertexFormat,o.radii=e.radii.getValue(c.MINIMUM_VALUE,o.radii),o.stackPartitions=b.getValueOrUndefined(e.stackPartitions,c.MINIMUM_VALUE),o.slicePartitions=b.getValueOrUndefined(e.slicePartitions,c.MINIMUM_VALUE),o.subdivisions=b.getValueOrUndefined(e.subdivisions,c.MINIMUM_VALUE),o.offsetAttribute=i!==m.NONE?p.ALL:void 0},N.prototype._onEntityPropertyChanged=P,N.DynamicGeometryUpdater=G,r(Object.create)&&(G.prototype=Object.create(V.prototype),G.prototype.constructor=G),G.prototype.update=function(n){e.defined("time",n);var h=this._entity,d=h.ellipsoid;if(!h.isShowing||!h.isAvailable(n)||!b.getValueOrDefault(d.show,n,!0))return r(this._primitive)&&(this._primitive.show=!1),void(r(this._outlinePrimitive)&&(this._outlinePrimitive.show=!1));var u=b.getValueOrUndefined(d.radii,n,S),c=r(u)?h.computeModelMatrixForHeightReference(n,d.heightReference,.5*u.z,this._scene.mapProjection.ellipsoid,this._modelMatrix):void 0;if(!r(c)||!r(u))return r(this._primitive)&&(this._primitive.show=!1),void(r(this._outlinePrimitive)&&(this._outlinePrimitive.show=!1));var P=b.getValueOrDefault(d.fill,n,!0),w=b.getValueOrDefault(d.outline,n,!1),V=b.getValueOrClonedDefault(d.outlineColor,n,i.BLACK,E),M=D.getValue(n,s(d.material,A),this._material),N=b.getValueOrUndefined(d.stackPartitions,n),G=b.getValueOrUndefined(d.slicePartitions,n),R=b.getValueOrUndefined(d.subdivisions,n),L=b.getValueOrDefault(d.outlineWidth,n,1),F=b.getValueOrDefault(d.heightReference,n,m.NONE),W=F!==m.NONE?p.ALL:void 0,k=this._scene.mode,H=k===O.SCENE3D&&F===m.NONE,j=this._options,T=this._geometryUpdater.shadowsProperty.getValue(n),z=this._geometryUpdater.distanceDisplayConditionProperty.getValue(n),q=b.getValueOrDefault(this._geometryUpdater.terrainOffsetProperty,n,U,I);if(!H||this._lastSceneMode!==k||!r(this._primitive)||j.stackPartitions!==N||j.slicePartitions!==G||j.subdivisions!==R||this._lastOutlineWidth!==L||j.offsetAttribute!==W){var B=this._primitives;B.removeAndDestroy(this._primitive),B.removeAndDestroy(this._outlinePrimitive),this._primitive=void 0,this._outlinePrimitive=void 0,this._lastSceneMode=k,this._lastOutlineWidth=L,j.stackPartitions=N,j.slicePartitions=G,j.subdivisions=R,j.offsetAttribute=W,j.radii=H?x:u;var K=new v({material:M,translucent:M.isTranslucent(),closed:!0});j.vertexFormat=K.vertexFormat;var X=this._geometryUpdater.createFillGeometryInstance(n,H,this._modelMatrix);this._primitive=B.add(new g({geometryInstances:X,appearance:K,asynchronous:!1,shadows:T}));var Z=this._geometryUpdater.createOutlineGeometryInstance(n,H,this._modelMatrix);this._outlinePrimitive=B.add(new g({geometryInstances:Z,appearance:new C({flat:!0,translucent:255!==Z.attributes.color.value[3],renderState:{lineWidth:this._geometryUpdater._scene.clampLineWidth(L)}}),asynchronous:!1,shadows:T})),this._lastShow=P,this._lastOutlineShow=w,this._lastOutlineColor=i.clone(V,this._lastOutlineColor),this._lastDistanceDisplayCondition=z,this._lastOffset=t.clone(q,this._lastOffset)}else if(this._primitive.ready){var J=this._primitive,Q=this._outlinePrimitive;J.show=!0,Q.show=!0,J.appearance.material=M;var Y=this._attributes;r(Y)||(Y=J.getGeometryInstanceAttributes(h),this._attributes=Y),P!==this._lastShow&&(Y.show=y.toValue(P,Y.show),this._lastShow=P);var $=this._outlineAttributes;r($)||($=Q.getGeometryInstanceAttributes(h),this._outlineAttributes=$),w!==this._lastOutlineShow&&($.show=y.toValue(w,$.show),this._lastOutlineShow=w),i.equals(V,this._lastOutlineColor)||($.color=o.toValue(V,$.color),i.clone(V,this._lastOutlineColor)),a.equals(z,this._lastDistanceDisplayCondition)||(Y.distanceDisplayCondition=l.toValue(z,Y.distanceDisplayCondition),$.distanceDisplayCondition=l.toValue(z,$.distanceDisplayCondition),a.clone(z,this._lastDistanceDisplayCondition)),t.equals(q,this._lastOffset)||(Y.offset=f.toValue(q,Y.offset),$.offset=f.toValue(q,Y.offset),t.clone(q,this._lastOffset))}H&&(u.x=Math.max(u.x,.001),u.y=Math.max(u.y,.001),u.z=Math.max(u.z,.001),c=_.multiplyByScale(c,u,c),this._primitive.modelMatrix=c,this._outlinePrimitive.modelMatrix=c)},N});