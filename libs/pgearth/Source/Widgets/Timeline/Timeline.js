define(["../../Core/ClockRange","../../Core/defined","../../Core/destroyObject","../../Core/DeveloperError","../../Core/JulianDate","../getElement","./TimelineHighlightRange","./TimelineTrack"],function(t,e,i,n,s,o,a,r){"use strict";var h=1e12,c={none:0,scrub:1,slide:2,zoom:3,touchOnly:4},l={none:0,scrub:1,slideZoom:2,singleTap:3,ignore:4},u=[.001,.002,.005,.01,.02,.05,.1,.25,.5,1,2,5,10,15,30,60,120,300,600,900,1800,3600,7200,14400,21600,43200,86400,172800,345600,604800,1296e3,2592e3,5184e3,7776e3,15552e3,31536e3,63072e3,126144e3,15768e4,31536e4,63072e4,126144e4,15768e5,31536e5,63072e5,126144e5,15768e6,31536e6],d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function _(t,i){if(!e(t))throw new n("container is required.");if(!e(i))throw new n("clock is required.");t=o(t),this.container=t;var a,r=document.createElement("div");r.className="pgEarth-timeline-main",t.appendChild(r),this._topDiv=r,this._endJulian=void 0,this._epochJulian=void 0,this._lastXPos=void 0,this._scrubElement=void 0,this._startJulian=void 0,this._timeBarSecondsSpan=void 0,this._clock=i,this._scrubJulian=i.currentTime,this._mainTicSpan=-1,this._mouseMode=c.none,this._touchMode=l.none,this._touchState={centerX:0,spanX:0},this._mouseX=0,this._timelineDrag=0,this._timelineDragLocation=void 0,this._lastHeight=void 0,this._lastWidth=void 0,this._topDiv.innerHTML='<div class="pgEarth-timeline-bar"></div><div class="pgEarth-timeline-trackContainer"><canvas class="pgEarth-timeline-tracks" width="10" height="1"></canvas></div><div class="pgEarth-timeline-needle"></div><span class="pgEarth-timeline-ruler"></span>',this._timeBarEle=this._topDiv.childNodes[0],this._trackContainer=this._topDiv.childNodes[1],this._trackListEle=this._topDiv.childNodes[1].childNodes[0],this._needleEle=this._topDiv.childNodes[2],this._rulerEle=this._topDiv.childNodes[3],this._context=this._trackListEle.getContext("2d"),this._trackList=[],this._highlightRanges=[],this.zoomTo(i.startTime,i.stopTime),this._onMouseDown=(a=this,function(t){a._mouseMode!==c.touchOnly&&(0===t.button?(a._mouseMode=c.scrub,a._scrubElement&&(a._scrubElement.style.backgroundPosition="-16px 0"),a._onMouseMove(t)):(a._mouseX=t.clientX,2===t.button?a._mouseMode=c.zoom:a._mouseMode=c.slide)),t.preventDefault()}),this._onMouseUp=function(t){return function(e){t._mouseMode=c.none,t._scrubElement&&(t._scrubElement.style.backgroundPosition="0 0"),t._timelineDrag=0,t._timelineDragLocation=void 0}}(this),this._onMouseMove=function(t){return function(e){var i;if(t._mouseMode===c.scrub){e.preventDefault();var n=e.clientX-t._topDiv.getBoundingClientRect().left;n<0?(t._timelineDragLocation=0,t._timelineDrag=-.01*t._timeBarSecondsSpan):n>t._topDiv.clientWidth?(t._timelineDragLocation=t._topDiv.clientWidth,t._timelineDrag=.01*t._timeBarSecondsSpan):(t._timelineDragLocation=void 0,t._setTimeBarTime(n,n*t._timeBarSecondsSpan/t._topDiv.clientWidth))}else if(t._mouseMode===c.slide){if(i=t._mouseX-e.clientX,t._mouseX=e.clientX,0!==i){var o=i*t._timeBarSecondsSpan/t._topDiv.clientWidth;t.zoomTo(s.addSeconds(t._startJulian,o,new s),s.addSeconds(t._endJulian,o,new s))}}else t._mouseMode===c.zoom&&(i=t._mouseX-e.clientX,t._mouseX=e.clientX,0!==i&&t.zoomFrom(Math.pow(1.01,i)))}}(this),this._onMouseWheel=function(t){return function(e){var i=e.wheelDeltaY||e.wheelDelta||-e.detail;h=Math.max(Math.min(Math.abs(i),h),1),i/=h,t.zoomFrom(Math.pow(1.05,-i))}}(this),this._onTouchStart=function(t){return function(e){var i,n,o=e.touches.length,a=t._topDiv.getBoundingClientRect().left;e.preventDefault(),t._mouseMode=c.touchOnly,1===o?(i=s.secondsDifference(t._scrubJulian,t._startJulian),n=Math.round(i*t._topDiv.clientWidth/t._timeBarSecondsSpan+a),Math.abs(e.touches[0].clientX-n)<50?(t._touchMode=l.scrub,t._scrubElement&&(t._scrubElement.style.backgroundPosition=1===o?"-16px 0":"0 0")):(t._touchMode=l.singleTap,t._touchState.centerX=e.touches[0].clientX-a)):2===o?(t._touchMode=l.slideZoom,t._touchState.centerX=.5*(e.touches[0].clientX+e.touches[1].clientX)-a,t._touchState.spanX=Math.abs(e.touches[0].clientX-e.touches[1].clientX)):t._touchMode=l.ignore}}(this),this._onTouchMove=function(t){return function(i){var n,o,a,r,h,u,d=1,_=t._topDiv.getBoundingClientRect().left;t._touchMode===l.singleTap&&(t._touchMode=l.slideZoom),t._mouseMode=c.touchOnly,t._touchMode===l.scrub?(i.preventDefault(),1===i.changedTouches.length&&(o=i.changedTouches[0].clientX-_)>=0&&o<=t._topDiv.clientWidth&&t._setTimeBarTime(o,o*t._timeBarSecondsSpan/t._topDiv.clientWidth)):t._touchMode===l.slideZoom&&(2===(a=i.touches.length)?(r=.5*(i.touches[0].clientX+i.touches[1].clientX)-_,h=Math.abs(i.touches[0].clientX-i.touches[1].clientX)):1===a&&(r=i.touches[0].clientX-_,h=0),e(r)&&(h>0&&t._touchState.spanX>0?(d=t._touchState.spanX/h,u=s.addSeconds(t._startJulian,(t._touchState.centerX*t._timeBarSecondsSpan-r*t._timeBarSecondsSpan*d)/t._topDiv.clientWidth,new s)):(n=t._touchState.centerX-r,u=s.addSeconds(t._startJulian,n*t._timeBarSecondsSpan/t._topDiv.clientWidth,new s)),t.zoomTo(u,s.addSeconds(u,t._timeBarSecondsSpan*d,new s)),t._touchState.centerX=r,t._touchState.spanX=h))}}(this),this._onTouchEnd=function(t){return function(e){var i=e.touches.length,n=t._topDiv.getBoundingClientRect().left;t._touchMode===l.singleTap?(t._touchMode=l.scrub,t._onTouchMove(e)):t._touchMode===l.scrub&&t._onTouchMove(e),t._mouseMode=c.touchOnly,1!==i?t._touchMode=i>0?l.ignore:l.none:t._touchMode===l.slideZoom&&(t._touchState.centerX=e.touches[0].clientX-n),t._scrubElement&&(t._scrubElement.style.backgroundPosition="0 0")}}(this);var u=this._timeBarEle;document.addEventListener("mouseup",this._onMouseUp,!1),document.addEventListener("mousemove",this._onMouseMove,!1),u.addEventListener("mousedown",this._onMouseDown,!1),u.addEventListener("DOMMouseScroll",this._onMouseWheel,!1),u.addEventListener("mousewheel",this._onMouseWheel,!1),u.addEventListener("touchstart",this._onTouchStart,!1),u.addEventListener("touchmove",this._onTouchMove,!1),u.addEventListener("touchend",this._onTouchEnd,!1),u.addEventListener("touchcancel",this._onTouchEnd,!1),this._topDiv.oncontextmenu=function(){return!1},i.onTick.addEventListener(this.updateFromClock,this),this.updateFromClock()}function m(t){return t<10?"0"+t.toString():t.toString()}return _.prototype.addEventListener=function(t,e,i){this._topDiv.addEventListener(t,e,i)},_.prototype.removeEventListener=function(t,e,i){this._topDiv.removeEventListener(t,e,i)},_.prototype.isDestroyed=function(){return!1},_.prototype.destroy=function(){this._clock.onTick.removeEventListener(this.updateFromClock,this),document.removeEventListener("mouseup",this._onMouseUp,!1),document.removeEventListener("mousemove",this._onMouseMove,!1);var t=this._timeBarEle;t.removeEventListener("mousedown",this._onMouseDown,!1),t.removeEventListener("DOMMouseScroll",this._onMouseWheel,!1),t.removeEventListener("mousewheel",this._onMouseWheel,!1),t.removeEventListener("touchstart",this._onTouchStart,!1),t.removeEventListener("touchmove",this._onTouchMove,!1),t.removeEventListener("touchend",this._onTouchEnd,!1),t.removeEventListener("touchcancel",this._onTouchEnd,!1),this.container.removeChild(this._topDiv),i(this)},_.prototype.addHighlightRange=function(t,e,i){var n=new a(t,e,i);return this._highlightRanges.push(n),this.resize(),n},_.prototype.addTrack=function(t,e,i,n){var s=new r(t,e,i,n);return this._trackList.push(s),this._lastHeight=void 0,this.resize(),s},_.prototype.zoomTo=function(i,o){if(!e(i))throw new n("startTime is required.");if(!e(o))throw new n("stopTime is required");if(s.lessThanOrEquals(o,i))throw new n("Start time must come before end time.");if(this._startJulian=i,this._endJulian=o,this._timeBarSecondsSpan=s.secondsDifference(o,i),this._clock&&this._clock.clockRange!==t.UNBOUNDED){var a=this._clock.startTime,r=this._clock.stopTime,h=s.secondsDifference(r,a),c=s.secondsDifference(a,this._startJulian),l=s.secondsDifference(r,this._endJulian);this._timeBarSecondsSpan>=h?(this._timeBarSecondsSpan=h,this._startJulian=this._clock.startTime,this._endJulian=this._clock.stopTime):c>0?(this._endJulian=s.addSeconds(this._endJulian,c,new s),this._startJulian=a,this._timeBarSecondsSpan=s.secondsDifference(this._endJulian,this._startJulian)):l<0&&(this._startJulian=s.addSeconds(this._startJulian,l,new s),this._endJulian=r,this._timeBarSecondsSpan=s.secondsDifference(this._endJulian,this._startJulian))}this._makeTics();var u=document.createEvent("Event");u.initEvent("setzoom",!0,!0),u.startJulian=this._startJulian,u.endJulian=this._endJulian,u.epochJulian=this._epochJulian,u.totalSpan=this._timeBarSecondsSpan,u.mainTicSpan=this._mainTicSpan,this._topDiv.dispatchEvent(u)},_.prototype.zoomFrom=function(t){var e=s.secondsDifference(this._scrubJulian,this._startJulian);t>1||e<0||e>this._timeBarSecondsSpan?e=.5*this._timeBarSecondsSpan:e+=e-.5*this._timeBarSecondsSpan;var i=this._timeBarSecondsSpan-e;this.zoomTo(s.addSeconds(this._startJulian,e-e*t,new s),s.addSeconds(this._endJulian,i*t-i,new s))},_.prototype.makeLabel=function(t){var e=s.toGregorianDate(t),i=e.millisecond,n=" UTC";if(i>0&&this._timeBarSecondsSpan<3600){for(n=Math.floor(i).toString();n.length<3;)n="0"+n;n="."+n}return d[e.month-1]+" "+e.day+" "+e.year+" "+m(e.hour)+":"+m(e.minute)+":"+m(e.second)+n},_.prototype.smallestTicInPixels=7,_.prototype._makeTics=function(){var t,e=this._timeBarEle,i=s.secondsDifference(this._scrubJulian,this._startJulian),n=Math.round(i*this._topDiv.clientWidth/this._timeBarSecondsSpan),o=n-8,a=this;this._needleEle.style.left=n.toString()+"px";var r="",h=0,c=this._timeBarSecondsSpan;c<.01?(c=.01,this._timeBarSecondsSpan=.01,this._endJulian=s.addSeconds(this._startJulian,.01,new s)):c>31536e6&&(c=31536e6,this._timeBarSecondsSpan=31536e6,this._endJulian=s.addSeconds(this._startJulian,31536e6,new s));var l=this._timeBarEle.clientWidth;l<10&&(l=10);var d,_=this._startJulian,m=Math.min(c/l*1e-5,.4),p=s.toGregorianDate(_);d=c>31536e4?s.fromDate(new Date(Date.UTC(100*Math.floor(p.year/100),0))):c>31536e3?s.fromDate(new Date(Date.UTC(10*Math.floor(p.year/10),0))):c>86400?s.fromDate(new Date(Date.UTC(p.year,0))):s.fromDate(new Date(Date.UTC(p.year,p.month,p.day)));var v=s.secondsDifference(this._startJulian,s.addSeconds(d,m,new s)),f=v+c;function S(t){return Math.floor(v/t)*t}function g(t,e){return Math.ceil(t/e+.5)*e}function E(t){return(t-v)/c}function M(t,e){return t-e*Math.round(t/e)}this._epochJulian=d,this._rulerEle.innerHTML=this.makeLabel(s.addSeconds(this._endJulian,-.01,new s));var D=this._rulerEle.offsetWidth+20;D<30&&(D=180);var T=h;h-=1e-10;var J={startTime:v,startJulian:_,epochJulian:d,duration:c,timeBarWidth:l,getAlpha:E};this._highlightRanges.forEach(function(t){r+=t.render(J)});var b=0,k=0,L=0,y=D/l;y>1&&(y=1),y*=this._timeBarSecondsSpan;var w,B=-1,X=-1,C=u.length;for(w=0;w<C;++w){var W=u[w];if(++B,b=W,W>y&&W>h)break;X<0&&l*(W/this._timeBarSecondsSpan)>=this.smallestTicInPixels&&(X=B)}if(B>0){for(;B>0;)if(--B,Math.abs(M(b,u[B]))<1e-5){u[B]>=h&&(k=u[B]);break}if(X>=0)for(;X<B;){if(Math.abs(M(k,u[X]))<1e-5&&u[X]>=h){L=u[X];break}++X}}(h=T)>1e-10&&L<1e-5&&Math.abs(h-b)>1e-10&&(L=h,h<=b+1e-10&&(k=0));var x,z=-999999;if(l*(L/this._timeBarSecondsSpan)>=3)for(t=S(L);t<=f;t=g(t,L))r+='<span class="pgEarth-timeline-ticTiny" style="left: '+Math.round(l*E(t)).toString()+'px;"></span>';if(l*(k/this._timeBarSecondsSpan)>=3)for(t=S(k);t<=f;t=g(t,k))r+='<span class="pgEarth-timeline-ticSub" style="left: '+Math.round(l*E(t)).toString()+'px;"></span>';if(l*(b/this._timeBarSecondsSpan)>=2){this._mainTicSpan=b,f+=b,t=S(b);for(var R=s.computeTaiMinusUtc(d);t<=f;){var U=s.addSeconds(_,t-v,new s);if(b>2.1){var H=s.computeTaiMinusUtc(U);Math.abs(H-R)>.1&&(t+=H-R,U=s.addSeconds(_,t-v,new s))}var O=Math.round(l*E(t)),N=this.makeLabel(U);this._rulerEle.innerHTML=N,(x=this._rulerEle.offsetWidth)<10&&(x=D);var P=O-(x/2-1);P>z?(z=P+x+5,r+='<span class="pgEarth-timeline-ticMain" style="left: '+O.toString()+'px;"></span><span class="pgEarth-timeline-ticLabel" style="left: '+P.toString()+'px;">'+N+"</span>"):r+='<span class="pgEarth-timeline-ticSub" style="left: '+O.toString()+'px;"></span>',t=g(t,b)}}else this._mainTicSpan=-1;r+='<span class="pgEarth-timeline-icon16" style="left:'+o+'px;bottom:0;background-position: 0 0;"></span>',e.innerHTML=r,this._scrubElement=e.lastChild,this._context.clearRect(0,0,this._trackListEle.width,this._trackListEle.height),J.y=0,this._trackList.forEach(function(t){t.render(a._context,J),J.y+=t.height})},_.prototype.updateFromClock=function(){this._scrubJulian=this._clock.currentTime;var t=this._scrubElement;if(e(this._scrubElement)){var i=s.secondsDifference(this._scrubJulian,this._startJulian),n=Math.round(i*this._topDiv.clientWidth/this._timeBarSecondsSpan);this._lastXPos!==n&&(this._lastXPos=n,t.style.left=n-8+"px",this._needleEle.style.left=n+"px")}e(this._timelineDragLocation)&&(this._setTimeBarTime(this._timelineDragLocation,this._timelineDragLocation*this._timeBarSecondsSpan/this._topDiv.clientWidth),this.zoomTo(s.addSeconds(this._startJulian,this._timelineDrag,new s),s.addSeconds(this._endJulian,this._timelineDrag,new s)))},_.prototype._setTimeBarTime=function(t,e){if(t=Math.round(t),this._scrubJulian=s.addSeconds(this._startJulian,e,new s),this._scrubElement){var i=t-8;this._scrubElement.style.left=i.toString()+"px",this._needleEle.style.left=t.toString()+"px"}var n=document.createEvent("Event");n.initEvent("settime",!0,!0),n.clientX=t,n.timeSeconds=e,n.timeJulian=this._scrubJulian,n.clock=this._clock,this._topDiv.dispatchEvent(n)},_.prototype.resize=function(){var t=this.container.clientWidth,e=this.container.clientHeight;if(t!==this._lastWidth||e!==this._lastHeight){this._trackContainer.style.height=e+"px";var i=1;this._trackList.forEach(function(t){i+=t.height}),this._trackListEle.style.height=i.toString()+"px",this._trackListEle.width=this._trackListEle.clientWidth,this._trackListEle.height=i,this._makeTics(),this._lastXPos=void 0,this._lastWidth=t,this._lastHeight=e}},_});