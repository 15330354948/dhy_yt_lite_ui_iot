define(["../Core/ArcType","../Core/AssociativeArray","../Core/BoundingRectangle","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/ClockRange","../Core/ClockStep","../Core/Color","../Core/createGuid","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Ellipsoid","../Core/Event","../Core/getExtensionFromUri","../Core/getFilenameFromUri","../Core/HeadingPitchRange","../Core/HeadingPitchRoll","../Core/Iso8601","../Core/JulianDate","../Core/Math","../Core/NearFarScalar","../Core/objectToQuery","../Core/oneTimeWarning","../Core/PinBuilder","../Core/PolygonHierarchy","../Core/queryToObject","../Core/Rectangle","../Core/Resource","../Core/RuntimeError","../Core/TimeInterval","../Core/TimeIntervalCollection","../Scene/HeightReference","../Scene/HorizontalOrigin","../Scene/LabelStyle","../Scene/SceneMode","../ThirdParty/Autolinker","../ThirdParty/Uri","../ThirdParty/when","../ThirdParty/zip","./BillboardGraphics","./CompositePositionProperty","./DataSource","./DataSourceClock","./Entity","./EntityCluster","./EntityCollection","./KmlCamera","./KmlLookAt","./KmlTour","./KmlTourFlyTo","./KmlTourWait","./LabelGraphics","./PathGraphics","./PolygonGraphics","./PolylineGraphics","./PositionPropertyArray","./RectangleGraphics","./ReferenceProperty","./SampledPositionProperty","./ScaledPositionProperty","./TimeIntervalCollectionProperty","./WallGraphics"],function(e,t,r,o,n,i,a,l,s,d,m,c,u,p,v,f,g,h,k,x,w,y,M,T,b,L,C,E,S,_,I,N,R,O,P,U,A,D,W,F,K,B,G,V,H,q,z,j,X,Q,$,Y,J,Z,ee,te,re,oe,ne,ie,ae,le,se,de,me){"use strict";if("undefined"==typeof DOMParser)return{};var ce={avi:"video/x-msvideo",bmp:"image/bmp",bz2:"application/x-bzip2",chm:"application/vnd.ms-htmlhelp",css:"text/css",csv:"text/csv",doc:"application/msword",dvi:"application/x-dvi",eps:"application/postscript",flv:"video/x-flv",gif:"image/gif",gz:"application/x-gzip",htm:"text/html",html:"text/html",ico:"image/vnd.microsoft.icon",jnlp:"application/x-java-jnlp-file",jpeg:"image/jpeg",jpg:"image/jpeg",m3u:"audio/x-mpegurl",m4v:"video/mp4",mathml:"application/mathml+xml",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mp4v:"video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",odp:"application/vnd.oasis.opendocument.presentation",ods:"application/vnd.oasis.opendocument.spreadsheet",odt:"application/vnd.oasis.opendocument.text",ogg:"application/ogg",pdf:"application/pdf",png:"image/png",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",ps:"application/postscript",qt:"video/quicktime",rdf:"application/rdf+xml",rss:"application/rss+xml",rtf:"application/rtf",svg:"image/svg+xml",swf:"application/x-shockwave-flash",text:"text/plain",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",xml:"application/xml",zip:"application/zip",detectFromFilename:function(e){var t=e.toLowerCase();return t=g(t),ce[t]}},ue=new DOMParser,pe=new W({stripPrefix:!1,twitter:!1,email:!1,replaceFn:function(e,t){if(!t.protocolUrlMatch)return!1}}),ve=32,fe=2414016,ge=1,he=16093e3,ke=.1;function xe(e){var t,r,o,n={xsi:"http://www.w3.org/2001/XMLSchema-instance"};for(var i in n)n.hasOwnProperty(i)&&(o="xmlns:"+i+"=",RegExp("[< ]"+i+":").test(e)&&-1===e.indexOf(o)&&(c(t)||(t=e.substr(0,e.indexOf("<kml")+4),r=e.substr(t.length)),t+=" "+o+'"'+n[i]+'"'));return c(t)&&(e=t+r),e}function we(e){for(var t,r,o,n=e.indexOf("xmlns:"),i=e.indexOf(">",n);-1!==n&&n<i;)t=e.slice(n,e.indexOf('"',n)),r=n,-1!==(n=e.indexOf(t,n+1))?(o=e.indexOf('"',e.indexOf('"',n)+1),n=(e=e.slice(0,n-1)+e.slice(o+1,e.length)).indexOf("xmlns:",r-1)):n=e.indexOf("xmlns:",r+1);return e}function ye(e,t,r){var o=m(ce.detectFromFilename(e.filename),"application/octet-stream");e.getData(new B.Data64URIWriter(o),function(o){t[e.filename]=o,r.resolve()})}function Me(e,t,r,o){for(var n=o.keys,i=new F("."),a=e.querySelectorAll(t),l=0;l<a.length;l++){var s=a[l],d=s.getAttribute(r),m=new F(d).resolve(i).toString(),c=n.indexOf(m);if(-1!==c){var u=n[c];s.setAttribute(r,o[u]),"a"===t&&null===s.getAttribute("download")&&s.setAttribute("download",u)}}}function Te(e,t,r,o){for(var n=e.querySelectorAll(t),i=0;i<n.length;i++){var a=n[i],l=Fe(a.getAttribute(r),o);a.setAttribute(r,l.url)}}function be(e,t,r){var o=Re(e,"id");o=c(o)&&0!==o.length?o:d(),c(r)&&(o=r+o);var n=t.getById(o);return c(n)&&(o=d(),c(r)&&(o=r+o)),n=t.add(new z({id:o})),c(n.kml)||(n.addProperty("kml"),n.kml=new function(){this.author={name:void 0,uri:void 0,email:void 0},this.link={href:void 0,hreflang:void 0,rel:void 0,type:void 0,title:void 0,length:void 0},this.address=void 0,this.phoneNumber=void 0,this.snippet=void 0,this.extendedData=void 0}),n}function Le(e,t){return"absolute"===e||"relativeToGround"===e||"relativeToSeaFloor"===t}function Ce(e,t){if(!c(e))return n.fromDegrees(0,0,0,t);var r=e.match(/[^\s,\n]+/g);if(!c(r))return n.fromDegrees(0,0,0,t);var o=parseFloat(r[0]),i=parseFloat(r[1]),a=parseFloat(r[2]);return o=isNaN(o)?0:o,i=isNaN(i)?0:i,a=isNaN(a)?0:a,n.fromDegrees(o,i,a,t)}function Ee(e,t){if(c(e)){var r=e.textContent.match(/[^\s\n]+/g);if(c(r)){for(var o=r.length,n=new Array(o),i=0,a=0;a<o;a++)n[i++]=Ce(r[a],t);return n}}}var Se=[null,void 0,"http://www.opengis.net/kml/2.2","http://earth.google.com/kml/2.2","http://earth.google.com/kml/2.1","http://earth.google.com/kml/2.0"],_e=["http://www.google.com/kml/ext/2.2"],Ie={kml:Se,gx:_e,atom:["http://www.w3.org/2005/Atom"],kmlgx:Se.concat(_e)};function Ne(e,t){if(c(e)){var r=e.getAttribute(t);if(null!==r){var o=parseFloat(r);return isNaN(o)?void 0:o}}}function Re(e,t){if(c(e)){var r=e.getAttribute(t);return null!==r?r:void 0}}function Oe(e,t,r){if(c(e))for(var o=e.childNodes,n=o.length,i=0;i<n;i++){var a=o[i];if(a.localName===t&&-1!==r.indexOf(a.namespaceURI))return a}}function Pe(e,t,r){if(c(e)){for(var o=[],n=e.getElementsByTagNameNS("*",t),i=n.length,a=0;a<i;a++){var l=n[a];l.localName===t&&-1!==r.indexOf(l.namespaceURI)&&o.push(l)}return o}}function Ue(e,t,r){if(!c(e))return[];for(var o=[],n=e.childNodes,i=n.length,a=0;a<i;a++){var l=n[a];l.localName===t&&-1!==r.indexOf(l.namespaceURI)&&o.push(l)}return o}function Ae(e,t,r){var o=Oe(e,t,r);if(c(o)){var n=parseFloat(o.textContent);return isNaN(n)?void 0:n}}function De(e,t,r){var o=Oe(e,t,r);if(c(o))return o.textContent.trim()}function We(e,t,r){var o=Oe(e,t,r);if(c(o)){var n=o.textContent.trim();return"1"===n||/^true$/i.test(n)}}function Fe(e,t,r){if(c(e)){var o;if(c(r)){var n=r[e];if(c(n))o=new I({url:n});else{var i=new F(t.getUrlComponent());n=r[new F(e).resolve(i)],c(n)&&(o=new I({url:n}))}}return c(o)||(o=t.getDerivedResource({url:e})),o}}var Ke={maximumRed:void 0,red:void 0,maximumGreen:void 0,green:void 0,maximumBlue:void 0,blue:void 0};function Be(e,t){if(c(e)&&!/^\s*$/gm.test(e)){"#"===e[0]&&(e=e.substring(1));var r=parseInt(e.substring(0,2),16)/255,o=parseInt(e.substring(2,4),16)/255,n=parseInt(e.substring(4,6),16)/255,i=parseInt(e.substring(6,8),16)/255;return t?(i>0?(Ke.maximumRed=i,Ke.red=void 0):(Ke.maximumRed=void 0,Ke.red=0),n>0?(Ke.maximumGreen=n,Ke.green=void 0):(Ke.maximumGreen=void 0,Ke.green=0),o>0?(Ke.maximumBlue=o,Ke.blue=void 0):(Ke.maximumBlue=void 0,Ke.blue=0),Ke.alpha=r,s.fromRandom(Ke)):new s(i,n,o,r)}}function Ge(e,t,r){var o=De(e,t,r);if(c(o))return Be(o,"random"===De(e,"colorMode",r))}function Ve(){var e=new G;return e.width=ve,e.height=ve,e.scaleByDistance=new T(fe,ge,he,ke),e.pixelOffsetScaleByDistance=new T(fe,ge,he,ke),e}function He(){var e=new re;return e.outline=!0,e.outlineColor=s.WHITE,e}function qe(){var e=new ee;return e.translucencyByDistance=new T(3e6,1,5e6,0),e.pixelOffset=new o(17,0),e.horizontalOrigin=U.LEFT,e.font="16px sans-serif",e.style=A.FILL_AND_OUTLINE,e}function ze(e,t,r,o,n){var i=De(e,"href",Ie.kml);if(c(i)&&0!==i.length){if(0===i.indexOf("root://icons/palette-")){var a=i.charAt(21),l=m(Ae(e,"x",Ie.gx),0),s=m(Ae(e,"y",Ie.gx),0);l=Math.min(l/32,7),i="https://maps.google.com/mapfiles/kml/pal"+a+"/icon"+(8*(s=7-Math.min(s/32,7))+l)+".png"}var d=Fe(i,r,o);if(n){var u=De(e,"refreshMode",Ie.kml),p=De(e,"viewRefreshMode",Ie.kml);"onInterval"===u||"onExpire"===u?L("kml-refreshMode-"+u,"KML - Unsupported Icon refreshMode: "+u):"onStop"!==p&&"onRegion"!==p||L("kml-refreshMode-"+p,"KML - Unsupported Icon viewRefreshMode: "+p);var v=m(De(e,"viewBoundScale",Ie.kml),1),f="onStop"===p?"BBOX=[bboxWest],[bboxSouth],[bboxEast],[bboxNorth]":"",g=m(De(e,"viewFormat",Ie.kml),f),h=De(e,"httpQuery",Ie.kml);c(g)&&d.setQueryParameters(S(vt(g))),c(h)&&d.setQueryParameters(S(vt(h)));var k=t._ellipsoid;return xt(d,t._camera,t._canvas,v,t._lastCameraView.bbox,k),d}return d}}function je(e,t,i,a,l){var s=Ae(t,"scale",Ie.kml),d=Ae(t,"heading",Ie.kml),u=Ge(t,"color",Ie.kml),p=Oe(t,"Icon",Ie.kml),v=ze(p,e,a,l,!1);c(p)&&!c(v)&&(v=!1);var f,g,h=Ae(p,"x",Ie.gx),k=Ae(p,"y",Ie.gx),x=Ae(p,"w",Ie.gx),w=Ae(p,"h",Ie.gx),y=Oe(t,"hotSpot",Ie.kml),T=Ne(y,"x"),b=Ne(y,"y"),L=Re(y,"xunits"),C=Re(y,"yunits"),E=i.billboard;c(E)||(E=Ve(),i.billboard=E),E.image=v,E.scale=s,E.color=u,(c(h)||c(k)||c(x)||c(w))&&(E.imageSubRegion=new r(h,k,x,w)),c(d)&&0!==d&&(E.rotation=M.toRadians(-d),E.alignedAxis=n.UNIT_Z),s=m(s,1),c(T)&&("pixels"===L?f=-T*s:"insetPixels"===L?f=(T-ve)*s:"fraction"===L&&(f=-T*ve*s),f+=.5*ve*s),c(b)&&("pixels"===C?g=b*s:"insetPixels"===C?g=(-b+ve)*s:"fraction"===C&&(g=b*ve*s),g-=.5*ve*s),(c(f)||c(g))&&(E.pixelOffset=new o(f,g))}function Xe(e,t,r,o,n){for(var i=0,a=t.childNodes.length;i<a;i++){var l=t.childNodes.item(i);if("IconStyle"===l.localName)je(e,l,r,o,n);else if("LabelStyle"===l.localName){var d=r.label;c(d)||(d=qe(),r.label=d),d.scale=m(Ae(l,"scale",Ie.kml),d.scale),d.fillColor=m(Ge(l,"color",Ie.kml),d.fillColor),d.text=r.name}else if("LineStyle"===l.localName){var u=r.polyline;c(u)||(u=new oe,r.polyline=u),u.width=Ae(l,"width",Ie.kml),u.material=Ge(l,"color",Ie.kml),c(Ge(l,"outerColor",Ie.gx))&&L("kml-gx:outerColor","KML - gx:outerColor is not supported in a LineStyle"),c(Ae(l,"outerWidth",Ie.gx))&&L("kml-gx:outerWidth","KML - gx:outerWidth is not supported in a LineStyle"),c(Ae(l,"physicalWidth",Ie.gx))&&L("kml-gx:physicalWidth","KML - gx:physicalWidth is not supported in a LineStyle"),c(We(l,"labelVisibility",Ie.gx))&&L("kml-gx:labelVisibility","KML - gx:labelVisibility is not supported in a LineStyle")}else if("PolyStyle"===l.localName){var p=r.polygon;c(p)||(p=He(),r.polygon=p),p.material=m(Ge(l,"color",Ie.kml),p.material),p.fill=m(We(l,"fill",Ie.kml),p.fill),p.outline=m(We(l,"outline",Ie.kml),p.outline)}else if("BalloonStyle"===l.localName){var v=m(Be(De(l,"bgColor",Ie.kml)),s.WHITE),f=m(Be(De(l,"textColor",Ie.kml)),s.BLACK),g=De(l,"text",Ie.kml);r.addProperty("balloonStyle"),r.balloonStyle={bgColor:v,textColor:f,text:g}}else if("ListStyle"===l.localName){var h=De(l,"listItemType",Ie.kml);"radioFolder"!==h&&"checkOffOnly"!==h||L("kml-listStyle-"+h,"KML - Unsupported ListStyle with listItemType: "+h)}}}function Qe(e,t,r){return t.fetchXML().then(function(o){return $e(e,o,r,t,!0)})}function $e(e,t,r,o,n,i){var a,l,s,d,m=Pe(t,"Style",Ie.kml);if(c(m)){var u=m.length;for(a=0;a<u;a++)l=Re(d=m[a],"id"),c(l)&&(l="#"+l,n&&c(o)&&(l=o.getUrlComponent()+l),c(r.getById(l))||(s=new z({id:l}),r.add(s),Xe(e,d,s,o,i)))}var p=Pe(t,"StyleMap",Ie.kml);if(c(p)){var v=p.length;for(a=0;a<v;a++){var f=p[a];if(l=Re(f,"id"),c(l))for(var g=Ue(f,"Pair",Ie.kml),h=0;h<g.length;h++){var k=g[h],x=De(k,"key",Ie.kml);if("normal"===x){if(l="#"+l,n&&c(o)&&(l=o.getUrlComponent()+l),!c(r.getById(l))){s=r.getOrCreateEntity(l);var w=De(k,"styleUrl",Ie.kml);if(c(w)){"#"!==w[0]&&(w="#"+w),n&&c(o)&&(w=o.getUrlComponent()+w);var y=r.getById(w);c(y)&&s.merge(y)}else Xe(e,d=Oe(k,"Style",Ie.kml),s,o,i)}}else L("kml-styleMap-"+x,"KML - Unsupported StyleMap key: "+x)}}}var M=[],T=t.getElementsByTagName("styleUrl"),b=T.length;for(a=0;a<b;a++){var C=T[a].textContent;if("#"!==C[0]){var E=C.split("#");if(2===E.length){var S=E[0],_=o.getDerivedResource({url:S});M.push(Qe(e,_,r))}}}return M}function Ye(e,t,r){var o=new ae(e,t.id,["position"]),n=new se(t.position);t.polyline=c(r.polyline)?r.polyline.clone():new oe,t.polyline.positions=new ne([o,n])}function Je(e,t){return!c(e)&&!c(t)||"clampToGround"===e?P.CLAMP_TO_GROUND:"relativeToGround"===e?P.RELATIVE_TO_GROUND:"absolute"===e?P.NONE:"clampToSeaFloor"===t?(L("kml-gx:altitudeMode-clampToSeaFloor","KML - <gx:altitudeMode>:clampToSeaFloor is currently not supported, using <kml:altitudeMode>:clampToGround."),P.CLAMP_TO_GROUND):"relativeToSeaFloor"===t?(L("kml-gx:altitudeMode-relativeToSeaFloor","KML - <gx:altitudeMode>:relativeToSeaFloor is currently not supported, using <kml:altitudeMode>:relativeToGround."),P.RELATIVE_TO_GROUND):(c(e)?L("kml-altitudeMode-unknown","KML - Unknown <kml:altitudeMode>:"+e+", using <kml:altitudeMode>:CLAMP_TO_GROUND."):L("kml-gx:altitudeMode-unknown","KML - Unknown <gx:altitudeMode>:"+t+", using <kml:altitudeMode>:CLAMP_TO_GROUND."),P.CLAMP_TO_GROUND)}function Ze(e,t,r,n){var i=t.label;c(i)||(i=c(r.label)?r.label.clone():qe(),t.label=i),i.text=t.name;var a=t.billboard;c(a)||(a=c(r.billboard)?r.billboard.clone():Ve(),t.billboard=a),c(a.image)?a.image.getValue()||(a.image=void 0):a.image=e._pinBuilder.fromColor(s.YELLOW,64);var l=1;c(a.scale)&&(0!==(l=a.scale.getValue())?i.pixelOffset=new o(16*l+1,0):(i.pixelOffset=void 0,i.horizontalOrigin=void 0)),c(n)&&e._clampToGround&&(a.heightReference=n,i.heightReference=n)}function et(e,t){var r=e.path;c(r)||((r=new te).leadTime=0,e.path=r);var o=t.polyline;c(o)&&(r.material=o.material,r.width=o.width)}function tt(t,r,o,n,i){var a=Oe(o,"coordinates",Ie.kml),l=De(o,"altitudeMode",Ie.kml),d=De(o,"altitudeMode",Ie.gx),u=We(o,"extrude",Ie.kml),p=We(o,"tessellate",Ie.kml),v=Le(l,d),f=Ae(o,"drawOrder",Ie.gx),g=t._ellipsoid,h=Ee(a,g),k=i.polyline;if(v&&u){var x=new me;n.wall=x,x.positions=h;var y=i.polygon;c(y)&&(x.fill=y.fill,x.material=y.material),x.outline=!0,c(k)?(x.outlineColor=c(k.material)?k.material.color:s.WHITE,x.outlineWidth=k.width):c(y)&&(x.outlineColor=c(y.material)?y.material.color:s.WHITE)}else if(t._clampToGround&&!v&&p){var M=new oe;M.clampToGround=!0,n.polyline=M,M.positions=h,c(k)?(M.material=c(k.material)?k.material.color.getValue(w.MINIMUM_VALUE):s.WHITE,M.width=m(k.width,1)):(M.material=s.WHITE,M.width=1),M.zIndex=f}else c(f)&&L("kml-gx:drawOrder","KML - gx:drawOrder is not supported in LineStrings when clampToGround is false"),k=c(k)?k.clone():new oe,n.polyline=k,k.positions=function(e,t,r,o){if(c(e)){if("relativeToSeaFloor"===r||"absolute"===t||"relativeToGround"===t)return e;(c(t)&&"clampToGround"!==t||c(r)&&"clampToSeaFloor"!==r)&&L("kml-altitudeMode-unknown","KML - Unknown altitudeMode: "+m(t,r));for(var n=e.length,i=0;i<n;i++){var a=e[i];o.scaleToGeodeticSurface(a,a)}return e}}(h,l,d,g),p&&!v||(k.arcType=e.NONE);return!0}function rt(e,t,r,o,n,i,a,l,s){var d=e[0],u=e[e.length-1],p=new le;p.addSamples(e,t),r.intervals.addInterval(new R({start:d,stop:u,isStartIncluded:s,isStopIncluded:s,data:function(e,t,r){return"relativeToSeaFloor"===r||"absolute"===t||"relativeToGround"===t?e:((c(t)&&"clampToGround"!==t||c(r)&&"clampToSeaFloor"!==r)&&L("kml-altitudeMode-unknown","KML - Unknown altitudeMode: "+m(t,r)),new se(e))}(p,a,l)})),o.addInterval(new R({start:d,stop:u,isStartIncluded:s,isStopIncluded:s})),n.intervals.addInterval(new R({start:d,stop:u,isStartIncluded:s,isStopIncluded:s,data:i}))}var ot={Point:function(e,t,r,o,n){var i=De(r,"coordinates",Ie.kml),a=De(r,"altitudeMode",Ie.kml),l=De(r,"altitudeMode",Ie.gx),s=We(r,"extrude",Ie.kml),d=Ce(i,e._ellipsoid);return o.position=d,Ze(e,o,n,Je(a,l)),s&&Le(a,l)&&Ye(t,o,n),!0},LineString:tt,LinearRing:tt,Polygon:function(e,t,r,o,n){var i=Oe(Oe(r,"outerBoundaryIs",Ie.kml),"LinearRing",Ie.kml),a=Oe(i,"coordinates",Ie.kml),l=e._ellipsoid,d=Ee(a,l),m=We(r,"extrude",Ie.kml),u=Le(De(r,"altitudeMode",Ie.kml),De(r,"altitudeMode",Ie.gx)),p=c(n.polygon)?n.polygon.clone():He(),v=n.polyline;if(c(v)&&(p.outlineColor=c(v.material)?v.material.color:s.WHITE,p.outlineWidth=v.width),o.polygon=p,u?(p.perPositionHeight=!0,p.extrudedHeight=m?0:void 0):e._clampToGround||(p.height=0),c(d)){for(var f=new E(d),g=Ue(r,"innerBoundaryIs",Ie.kml),h=0;h<g.length;h++){i=Ue(g[h],"LinearRing",Ie.kml);for(var k=0;k<i.length;k++)d=Ee(a=Oe(i[k],"coordinates",Ie.kml),l),c(d)&&f.holes.push(new E(d))}p.hierarchy=f}return!0},Track:function(e,t,r,o,n){var i=De(r,"altitudeMode",Ie.kml),a=De(r,"altitudeMode",Ie.gx),l=Ue(r,"coord",Ie.gx),s=Ue(r,"angles",Ie.gx),d=Ue(r,"when",Ie.kml),m=We(r,"extrude",Ie.kml),c=Le(i,a),u=e._ellipsoid;s.length>0&&L("kml-gx:angles","KML - gx:angles are not supported in gx:Tracks");for(var p=Math.min(l.length,d.length),v=[],f=[],g=0;g<p;g++){var h=Ce(l[g].textContent,u);v.push(h),f.push(y.fromIso8601(d[g].textContent))}var k=new le;return k.addSamples(f,v),o.position=k,Ze(e,o,n,Je(i,a)),et(o,n),o.availability=new O,d.length>0&&o.availability.addInterval(new R({start:f[0],stop:f[f.length-1]})),c&&m&&Ye(t,o,n),!0},MultiTrack:function(e,t,r,o,n){for(var i,a,l,s=We(r,"interpolate",Ie.gx),d=Ue(r,"Track",Ie.gx),m=!1,u=new de,p=new O,v=new V,f=e._ellipsoid,g=0,h=d.length;g<h;g++){var k=d[g],x=Ue(k,"when",Ie.kml),w=Ue(k,"coord",Ie.gx),M=De(k,"altitudeMode",Ie.kml),T=De(k,"altitudeMode",Ie.gx),b=Le(M,T),L=We(k,"extrude",Ie.kml),C=Math.min(w.length,x.length),E=[];i=[];for(var S=0;S<C;S++){var _=Ce(w[S].textContent,f);E.push(_),i.push(y.fromIso8601(x[S].textContent))}s&&(c(a)&&rt([a,i[0]],[l,E[0]],v,p,u,!1,"absolute",void 0,!1),a=i[C-1],l=E[E.length-1]),rt(i,E,v,p,u,b&&L,M,T,!0),m=m||b&&L}return o.availability=p,o.position=v,Ze(e,o,n),et(o,n),m&&(Ye(t,o,n),o.polyline.show=u),!0},MultiGeometry:function(e,t,r,o,n,i){for(var a=r.childNodes,l=!1,s=0,d=a.length;s<d;s++){var m=a.item(s),u=ot[m.localName];if(c(u)){var p=be(m,t,i);p.parent=o,p.name=o.name,p.availability=o.availability,p.description=o.description,p.kml=o.kml,u(e,t,m,p,n)&&(l=!0)}}return l},Model:function(e,t,r,o,n){return L("kml-unsupportedGeometry","KML - Unsupported geometry: "+r.localName),!1}};var nt=document.createElement("div");function it(e,t,r,o,n,i,a,l,d){var u=be(r,o,d),p=u.kml,v=function(e,t,r,o,n){for(var i,a=new z,l=-1,s=t.childNodes,d=s.length,m=0;m<d;m++){var u=s[m];"Style"!==u.localName&&"StyleMap"!==u.localName||(l=m)}if(-1!==l){var p=s[l];if("Style"===p.localName)Xe(e,p,a,o,n);else for(var v=Ue(p,"Pair",Ie.kml),f=0;f<v.length;f++){var g=v[f],h=De(g,"key",Ie.kml);if("normal"===h){var k=De(g,"styleUrl",Ie.kml);c(k)?(i=r.getById(k),c(i)||(i=r.getById("#"+k)),c(i)&&a.merge(i)):Xe(e,Oe(g,"Style",Ie.kml),a,o,n)}else L("kml-styleMap-"+h,"KML - Unsupported StyleMap key: "+h)}}var x=De(t,"styleUrl",Ie.kml);if(c(x)){var w=x;if("#"!==x[0]&&-1!==x.indexOf("#")){var y=x.split("#"),M=y[0];w=o.getDerivedResource({url:M}).getUrlComponent()+"#"+y[1]}i=r.getById(w),c(i)||(i=r.getById("#"+w)),c(i)&&a.merge(i)}return a}(e,r,n,i,a),f=De(r,"name",Ie.kml);u.name=f,u.parent=t;var g=function(e){var t=Oe(e,"TimeSpan",Ie.kmlgx);if(c(t)){var r,o=Oe(t,"begin",Ie.kmlgx),n=c(o)?y.fromIso8601(o.textContent):void 0,i=Oe(t,"end",Ie.kmlgx),a=c(i)?y.fromIso8601(i.textContent):void 0;if(c(n)&&c(a)){if(y.lessThan(a,n)){var l=n;n=a,a=l}(r=new O).addInterval(new R({start:n,stop:a}))}else c(n)?(r=new O).addInterval(new R({start:n,stop:w.MAXIMUM_VALUE})):c(a)&&(r=new O).addInterval(new R({start:w.MINIMUM_VALUE,stop:a}));return r}}(r);c(g)||(g=function(e){var t=Oe(e,"TimeStamp",Ie.kmlgx),r=De(t,"when",Ie.kmlgx);if(c(t)&&c(r)&&0!==r.length){var o=y.fromIso8601(r),n=new O;return n.addInterval(new R({start:o,stop:w.MAXIMUM_VALUE})),n}}(r)),u.availability=g,bt(u);var h=We(r,"visibility",Ie.kml);u.show=function e(t){return!t||t.show&&e(t.parent)}(t)&&m(h,!0);var k=Oe(r,"author",Ie.atom),x=p.author;x.name=De(k,"name",Ie.atom),x.uri=De(k,"uri",Ie.atom),x.email=De(k,"email",Ie.atom);var M=Oe(r,"link",Ie.atom),T=p.link;T.href=Re(M,"href"),T.hreflang=Re(M,"hreflang"),T.rel=Re(M,"rel"),T.type=Re(M,"type"),T.title=Re(M,"title"),T.length=Re(M,"length"),p.address=De(r,"address",Ie.kml),p.phoneNumber=De(r,"phoneNumber",Ie.kml),p.snippet=De(r,"Snippet",Ie.kml),function(e,t){var r=Oe(e,"ExtendedData",Ie.kml);if(c(r)){c(Oe(r,"SchemaData",Ie.kml))&&L("kml-schemaData","KML - SchemaData is unsupported"),c(Re(r,"xmlns:prefix"))&&L("kml-extendedData","KML - ExtendedData with xmlns:prefix is unsupported");var o={},n=Ue(r,"Data",Ie.kml);if(c(n))for(var i=n.length,a=0;a<i;a++){var l=n[a],s=Re(l,"name");c(s)&&(o[s]={displayName:De(l,"displayName",Ie.kml),value:De(l,"value",Ie.kml)})}t.kml.extendedData=o}}(r,u),function(e,t,r,o,n){var i,a,l,d,u=t.kml,p=u.extendedData,v=De(e,"description",Ie.kml),f=m(t.balloonStyle,r.balloonStyle),g=s.WHITE,h=s.BLACK,k=v;if(c(f)&&(g=m(f.bgColor,s.WHITE),h=m(f.textColor,s.BLACK),k=m(f.text,v)),c(k)){if(k=(k=(k=(k=(k=(k=k.replace("$[name]",m(t.name,""))).replace("$[description]",m(v,""))).replace("$[address]",m(u.address,""))).replace("$[Snippet]",m(u.snippet,""))).replace("$[id]",t.id)).replace("$[geDirections]",""),c(p)){var x=k.match(/\$\[.+?\]/g);if(null!==x)for(i=0;i<x.length;i++){var w=x[i],y=w.substr(2,w.length-3),M=/\/displayName$/.test(y);d=p[y=y.replace(/\/displayName$/,"")],c(d)&&(d=M?d.displayName:d.value),c(d)&&(k=k.replace(w,m(d,"")))}}}else if(c(p)&&(l=Object.keys(p)).length>0){for(k='<table class="pgEarth-infoBox-defaultTable pgEarth-infoBox-defaultTable-lighter"><tbody>',i=0;i<l.length;i++)d=p[a=l[i]],k+="<tr><th>"+m(d.displayName,a)+"</th><td>"+m(d.value,"")+"</td></tr>";k+="</tbody></table>"}if(c(k)){k=pe.link(k),nt.innerHTML=k;var T=nt.querySelectorAll("a");for(i=0;i<T.length;i++)T[i].setAttribute("target","_blank");c(o)&&o.keys.length>1&&(Me(nt,"a","href",o),Me(nt,"img","src",o)),Te(nt,"a","href",n),Te(nt,"img","src",n);var b='<div class="pgEarth-infoBox-description-lighter" style="';b+="overflow:auto;",b+="word-wrap:break-word;",b+="background-color:"+g.toCssColorString()+";",b+="color:"+h.toCssColorString()+";",b+='">',b+=nt.innerHTML+"</div>",nt.innerHTML="",t.description=b}}(r,u,v,a,i);var b=e._ellipsoid;return ct(r,u,b),mt(r,u,b),c(Oe(r,"Region",Ie.kml))&&L("kml-region","KML - Placemark Regions are unsupported"),{entity:u,styleEntity:v}}var at={Document:lt,Folder:function(e,t,r,o,n,i,a,l,s){var d=it(e,t,r,o,n,i,a,0,s);lt(e,d.entity,r,o,n,i,a,l,s)},Placemark:function(e,t,r,o,n,i,a,l,s){for(var d=it(e,t,r,o,n,i,a,0,s),m=d.entity,u=d.styleEntity,p=!1,v=r.childNodes,f=0,g=v.length;f<g&&!p;f++){var h=v.item(f),k=ot[h.localName];c(k)&&(k(e,o,h,m,u,m.id),p=!0)}p||(m.merge(u),Ze(e,m,u))},NetworkLink:function(e,t,r,o,n,i,a,l,s){var u=it(e,t,r,o,n,i,a,0,s).entity,p=Oe(r,"Link",Ie.kml);c(p)||(p=Oe(r,"Url",Ie.kml));if(c(p)){var v,f,g=De(p,"href",Ie.kml);if(c(g)){var h=g;if(g=Fe(g,i,a),/^data:/.test(g.getUrlComponent()))/\.kmz/i.test(i.getUrlComponent())||(h=i.getDerivedResource({url:h}));else{h=g.clone(),v=De(p,"viewRefreshMode",Ie.kml),f=m(De(p,"viewBoundScale",Ie.kml),1);var k="onStop"===v?"BBOX=[bboxWest],[bboxSouth],[bboxEast],[bboxNorth]":"",x=m(De(p,"viewFormat",Ie.kml),k),w=De(p,"httpQuery",Ie.kml);c(x)&&g.setQueryParameters(S(vt(x))),c(w)&&g.setQueryParameters(S(vt(w)));var M=e._ellipsoid;xt(g,e._camera,e._canvas,f,e._lastCameraView.bbox,M)}var T={sourceUri:h,uriResolver:a,context:u.id},b=new X,C=Mt(e,b,g,T).then(function(t){var r=e._entityCollection,o=b.values;r.suspendEvents();for(var n=0;n<o.length;n++){var i=o[n];c(i.parent)||(i.parent=u,bt(i)),r.add(i)}r.resumeEvents();var a=De(p,"refreshMode",Ie.kml),l=m(Ae(p,"refreshInterval",Ie.kml),0);if("onInterval"===a&&l>0||"onExpire"===a||"onStop"===v){var s=Oe(t,"NetworkLinkControl",Ie.kml),h=c(s),k=y.now(),x={id:d(),href:g,cookie:{},lastUpdated:k,updating:!1,entity:u,viewBoundScale:f,needsUpdate:!1,cameraUpdateTime:k},w=0;if(h&&(x.cookie=S(m(De(s,"cookie",Ie.kml),"")),w=m(Ae(s,"minRefreshPeriod",Ie.kml),0)),"onInterval"===a)h&&(l=Math.max(w,l)),x.refreshMode=pt.INTERVAL,x.time=l;else if("onExpire"===a){var M;if(h&&(M=De(s,"expires",Ie.kml)),c(M))try{var T=y.fromIso8601(M),C=y.secondsDifference(T,k);C>0&&C<w&&y.addSeconds(k,w,T),x.refreshMode=pt.EXPIRE,x.time=T}catch(e){L("kml-refreshMode-onInterval-onExpire","KML - NetworkLinkControl expires is not a valid date")}else L("kml-refreshMode-onExpire","KML - refreshMode of onExpire requires the NetworkLinkControl to have an expires element")}else e._camera?(x.refreshMode=pt.STOP,x.time=m(Ae(p,"viewRefreshTime",Ie.kml),0)):L("kml-refrehMode-onStop-noCamera","A NetworkLink with viewRefreshMode=onStop requires a camera be passed in when creating the KmlDataSource");c(x.refreshMode)&&e._networkLinks.set(x.id,x)}else"onRegion"===v&&L("kml-refrehMode-onRegion","KML - Unsupported viewRefreshMode: onRegion")}).otherwise(function(t){L("An error occured during loading "+g.url),e._error.raiseEvent(e,t)});l.push(C)}}},GroundOverlay:function(e,t,r,o,n,i,a,l,s){var d,m=it(e,t,r,o,n,i,a,0,s).entity,u=!1,p=e._ellipsoid,v=Ee(Oe(r,"LatLonQuad",Ie.gx),p),f=Ae(r,"drawOrder",Ie.kml);if(c(v))(d=He()).hierarchy=new E(v),d.zIndex=f,m.polygon=d,u=!0;else{(d=new ie).zIndex=f,m.rectangle=d;var g=Oe(r,"LatLonBox",Ie.kml);if(c(g)){var h=Ae(g,"west",Ie.kml),k=Ae(g,"south",Ie.kml),x=Ae(g,"east",Ie.kml),w=Ae(g,"north",Ie.kml);c(h)&&(h=M.negativePiToPi(M.toRadians(h))),c(k)&&(k=M.clampToLatitudeRange(M.toRadians(k))),c(x)&&(x=M.negativePiToPi(M.toRadians(x))),c(w)&&(w=M.clampToLatitudeRange(M.toRadians(w))),d.coordinates=new _(h,k,x,w);var y=Ae(g,"rotation",Ie.kml);if(c(y)){var T=M.toRadians(y);d.rotation=T,d.stRotation=T}}}var b=Oe(r,"Icon",Ie.kml),C=ze(b,e,i,a,!0);if(c(C)){u&&L("kml-gx:LatLonQuad","KML - gx:LatLonQuad Icon does not support texture projection.");var S=Ae(b,"x",Ie.gx),I=Ae(b,"y",Ie.gx),N=Ae(b,"w",Ie.gx),R=Ae(b,"h",Ie.gx);(c(S)||c(I)||c(N)||c(R))&&L("kml-groundOverlay-xywh","KML - gx:x, gx:y, gx:w, gx:h aren't supported for GroundOverlays"),d.material=C,d.material.color=Ge(r,"color",Ie.kml),d.material.transparent=!0}else d.material=Ge(r,"color",Ie.kml);var O=De(r,"altitudeMode",Ie.kml);c(O)?"absolute"===O?(d.height=Ae(r,"altitude",Ie.kml),d.zIndex=void 0):"clampToGround"!==O&&L("kml-altitudeMode-unknown","KML - Unknown altitudeMode: "+O):"relativeToSeaFloor"===(O=De(r,"altitudeMode",Ie.gx))?(L("kml-altitudeMode-relativeToSeaFloor","KML - altitudeMode relativeToSeaFloor is currently not supported, treating as absolute."),d.height=Ae(r,"altitude",Ie.kml),d.zIndex=void 0):"clampToSeaFloor"===O?L("kml-altitudeMode-clampToSeaFloor","KML - altitudeMode clampToSeaFloor is currently not supported, treating as clampToGround."):c(O)&&L("kml-altitudeMode-unknown","KML - Unknown altitudeMode: "+O)},PhotoOverlay:ut,ScreenOverlay:ut,Tour:function(e,t,r,o,n,i,a,l,s){var d=De(r,"name",Ie.kml),m=Re(r,"id"),u=new Y(d,m),p=Oe(r,"Playlist",Ie.gx);if(p)for(var v=e._ellipsoid,f=p.childNodes,g=0;g<f.length;g++){var h=f[g];if(h.localName){var k=st[h.localName];k?k(u,h,v):console.log("Unknown KML Tour playlist entry type "+h.localName)}}c(e.kmlTours)||(e.kmlTours=[]);e.kmlTours.push(u)}};function lt(e,t,r,o,n,i,a,l,s){for(var d=Object.keys(at),m=d.length,c=0;c<m;c++)for(var u=d[c],p=at[u],v=r.childNodes,f=v.length,g=0;g<f;g++){var h=v[g];h.localName!==u||-1===Ie.kml.indexOf(h.namespaceURI)&&-1===Ie.gx.indexOf(h.namespaceURI)||p(e,t,h,o,n,i,a,l,s)}}var st={FlyTo:function(e,t,r){var o=Ae(t,"duration",Ie.gx),n=De(t,"flyToMode",Ie.gx),i={kml:{}};ct(t,i,r),mt(t,i,r);var a=i.kml.lookAt||i.kml.camera,l=new J(o,n,a);e.addPlaylistEntry(l)},Wait:function(e,t){var r=Ae(t,"duration",Ie.gx);e.addPlaylistEntry(new Z(r))},SoundCue:dt,AnimatedUpdate:dt,TourControl:dt};function dt(e,t){L("KML Tour unsupported node "+t.localName)}function mt(e,t,r){var o=Oe(e,"Camera",Ie.kml);if(c(o)){var i=m(Ae(o,"longitude",Ie.kml),0),a=m(Ae(o,"latitude",Ie.kml),0),l=m(Ae(o,"altitude",Ie.kml),0),s=m(Ae(o,"heading",Ie.kml),0),d=m(Ae(o,"tilt",Ie.kml),0),u=m(Ae(o,"roll",Ie.kml),0),p=n.fromDegrees(i,a,l,r),v=x.fromDegrees(s,d-90,u);t.kml.camera=new Q(p,v)}}function ct(e,t,r){var o=Oe(e,"LookAt",Ie.kml);if(c(o)){var i=m(Ae(o,"longitude",Ie.kml),0),a=m(Ae(o,"latitude",Ie.kml),0),l=m(Ae(o,"altitude",Ie.kml),0),s=Ae(o,"heading",Ie.kml),d=Ae(o,"tilt",Ie.kml),u=m(Ae(o,"range",Ie.kml),0);d=M.toRadians(m(d,0)),s=M.toRadians(m(s,0));var p=new k(s,d-M.PI_OVER_TWO,u),v=n.fromDegrees(i,a,l,r);t.kml.lookAt=new $(v,p)}}function ut(e,t,r,o,n,i,a,l,s){e._unsupportedNode.raiseEvent(e,t,r,o,n,i,a),L("kml-unsupportedFeature-"+r.nodeName,"KML - Unsupported feature: "+r.nodeName)}var pt={INTERVAL:0,EXPIRE:1,STOP:2};function vt(e){if(!c(e)||0===e.length)return"";var t=e[0];return"&"!==t&&"?"!==t||(e=e.substring(1)),e}var ft=new _,gt=new i,ht=new o,kt=new n;function xt(e,t,r,o,i,a){function l(e){return e<-M.PI_OVER_TWO?-M.PI_OVER_TWO:e>M.PI_OVER_TWO?M.PI_OVER_TWO:e}function s(e){return e>M.PI?e-M.TWO_PI:e<-M.PI?e+M.TWO_PI:e}var d=b(e.queryParameters);if(d=d.replace(/%5B/g,"[").replace(/%5D/g,"]"),c(t)&&t._mode!==D.MORPHING){var u,p;if(i=m(i,ft),c(r)&&(ht.x=.5*r.clientWidth,ht.y=.5*r.clientHeight,u=t.pickEllipsoid(ht,a,kt)),c(u)?p=a.cartesianToCartographic(u,gt):(p=_.center(i,gt),u=a.cartographicToCartesian(p)),c(o)&&!M.equalsEpsilon(o,1,M.EPSILON9)){var v=i.width*o*.5,f=i.height*o*.5;i=new _(s(p.longitude-v),l(p.latitude-f),s(p.longitude+v),l(p.latitude+f))}d=(d=(d=(d=d.replace("[bboxWest]",M.toDegrees(i.west).toString())).replace("[bboxSouth]",M.toDegrees(i.south).toString())).replace("[bboxEast]",M.toDegrees(i.east).toString())).replace("[bboxNorth]",M.toDegrees(i.north).toString());var g=M.toDegrees(p.longitude).toString(),h=M.toDegrees(p.latitude).toString();d=(d=(d=(d=(d=(d=(d=(d=d.replace("[lookatLon]",g)).replace("[lookatLat]",h)).replace("[lookatTilt]",M.toDegrees(t.pitch).toString())).replace("[lookatHeading]",M.toDegrees(t.heading).toString())).replace("[lookatRange]",n.distance(t.positionWC,u))).replace("[lookatTerrainLon]",g)).replace("[lookatTerrainLat]",h)).replace("[lookatTerrainAlt]",p.height.toString()),a.cartesianToCartographic(t.positionWC,gt),d=(d=(d=d.replace("[cameraLon]",M.toDegrees(gt.longitude).toString())).replace("[cameraLat]",M.toDegrees(gt.latitude).toString())).replace("[cameraAlt]",M.toDegrees(gt.height).toString());var k=t.frustum,x=k.aspectRatio,w="",y="";if(c(x)){var T=M.toDegrees(k.fov);x>1?(w=T,y=T/x):(y=T,w=T*x)}d=(d=d.replace("[horizFov]",w.toString())).replace("[vertFov]",y.toString())}else d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=(d=d.replace("[bboxWest]","-180")).replace("[bboxSouth]","-90")).replace("[bboxEast]","180")).replace("[bboxNorth]","90")).replace("[lookatLon]","")).replace("[lookatLat]","")).replace("[lookatRange]","")).replace("[lookatTilt]","")).replace("[lookatHeading]","")).replace("[lookatTerrainLon]","")).replace("[lookatTerrainLat]","")).replace("[lookatTerrainAlt]","")).replace("[cameraLon]","")).replace("[cameraLat]","")).replace("[cameraAlt]","")).replace("[horizFov]","")).replace("[vertFov]","");d=(d=(d=(d=(d=(d=c(r)?(d=d.replace("[horizPixels]",r.clientWidth)).replace("[vertPixels]",r.clientHeight):(d=d.replace("[horizPixels]","")).replace("[vertPixels]","")).replace("[terrainEnabled]","1")).replace("[clientVersion]","1")).replace("[kmlVersion]","2.2")).replace("[clientName]","PGEarth")).replace("[language]","English"),e.setQueryParameters(S(d))}function wt(e,t,r,o,n,i){t.removeAll();var a=[],l=r.documentElement,s=De("Document"===l.localName?l:Oe(l,"Document",Ie.kml),"name",Ie.kml);c(s)||(s=h(o.getUrlComponent())),c(e._name)||(e._name=s);var d=new X(e);return K.all($e(e,r,d,o,!1,n)).then(function(){var l=r.documentElement;if("kml"===l.localName)for(var s=l.childNodes,m=0;m<s.length;m++){var u=s[m];if(c(at[u.localName])){l=u;break}}return t.suspendEvents(),function(e,t,r,o,n,i,a,l,s){var d=at[t.localName];c(d)?d(e,r,t,o,n,i,a,l,s):ut(e,r,t,o,n,i,a)}(e,l,void 0,t,d,o,n,a,i),t.resumeEvents(),K.all(a).then(function(){return r.documentElement})})}function yt(e,t,r,o){var n=K.defer();return B.createReader(new B.BlobReader(r),function(r){r.getEntries(function(i){for(var a,l,s=[],d={},m=0;m<i.length;m++){var u=i[m];if(!u.directory){var p=K.defer();s.push(p.promise),/\.kml$/i.test(u.filename)?c(a)&&/\//i.test(u.filename)?ye(u,d,p):(c(a)&&ye(a,d,l),a=u,l=p):ye(u,d,p)}}c(a)&&function(e,t,r){e.getData(new B.TextWriter,function(e){e=we(e=xe(e)),t.kml=ue.parseFromString(e,"application/xml"),r.resolve()})}(a,d,l),K.all(s).then(function(){if(r.close(),c(d.kml))return d.keys=Object.keys(d),wt(e,t,d.kml,o,d);n.reject(new N("KMZ file does not contain a KML document."))}).then(n.resolve).otherwise(n.reject)})},function(e){n.reject(e)}),n.promise}function Mt(e,t,r,o){var n=(o=m(o,m.EMPTY_OBJECT)).sourceUri,i=o.uriResolver,a=o.context,l=r;return"string"==typeof r||r instanceof I?(l=(r=I.createIfNeeded(r)).fetchBlob(),n=m(n,r.clone())):n=m(n,I.DEFAULT.clone()),n=I.createIfNeeded(n),K(l).then(function(r){return r instanceof Blob?(o=r,l=o.slice(0,Math.min(4,o.size)),s=K.defer(),d=new FileReader,d.addEventListener("load",function(){s.resolve(1347093252===new DataView(d.result).getUint32(0,!1))}),d.addEventListener("error",function(){s.reject(d.error)}),d.readAsArrayBuffer(l),s.promise).then(function(o){return o?yt(e,t,r,n):(l=r,s=K.defer(),d=new FileReader,d.addEventListener("load",function(){s.resolve(d.result)}),d.addEventListener("error",function(){s.reject(d.error)}),d.readAsText(l),s.promise).then(function(r){var o,l;r=we(r=xe(r));try{o=ue.parseFromString(r,"application/xml")}catch(e){l=e.toString()}if(c(l)||o.body||"parsererror"===o.documentElement.tagName){var s=c(l)?l:o.documentElement.firstChild.nodeValue;throw s||(s=o.body.innerText),new N(s)}return wt(e,t,o,n,i,a)});var l,s,d}):wt(e,t,r,n,i,a);var o,l,s,d}).otherwise(function(t){return e._error.raiseEvent(e,t),console.log(t),K.reject(t)})}function Tt(e){var r=(e=m(e,{})).camera,o=e.canvas;if(!c(r))throw new p("options.camera is required.");if(!c(o))throw new p("options.canvas is required.");this._changed=new f,this._error=new f,this._loading=new f,this._refresh=new f,this._unsupportedNode=new f,this._clock=void 0,this._entityCollection=new X(this),this._name=void 0,this._isLoading=!1,this._pinBuilder=new C,this._networkLinks=new t,this._entityCluster=new j,this._canvas=o,this._camera=r,this._lastCameraView={position:c(r)?n.clone(r.positionWC):void 0,direction:c(r)?n.clone(r.directionWC):void 0,up:c(r)?n.clone(r.upWC):void 0,bbox:c(r)?r.computeViewRectangle():_.clone(_.MAX_VALUE)},this._ellipsoid=m(e.ellipsoid,v.WGS84)}function bt(e){var t=e.parent;if(c(t)){var r=t.availability;if(c(r)){var o=e.availability;c(o)?o.intersect(r):e.availability=r}}}Tt.load=function(e,t){return new Tt(t=m(t,m.EMPTY_OBJECT)).load(e,t)},u(Tt.prototype,{name:{get:function(){return this._name},set:function(e){this._name!==e&&(this._name=e,this._changed.raiseEvent(this))}},clock:{get:function(){return this._clock}},entities:{get:function(){return this._entityCollection}},isLoading:{get:function(){return this._isLoading}},changedEvent:{get:function(){return this._changed}},errorEvent:{get:function(){return this._error}},loadingEvent:{get:function(){return this._loading}},refreshEvent:{get:function(){return this._refresh}},unsupportedNodeEvent:{get:function(){return this._unsupportedNode}},show:{get:function(){return this._entityCollection.show},set:function(e){this._entityCollection.show=e}},clustering:{get:function(){return this._entityCluster},set:function(e){if(!c(e))throw new p("value must be defined.");this._entityCluster=e}}}),Tt.prototype.load=function(e,t){if(!c(e))throw new p("data is required.");t=m(t,{}),H.setLoading(this,!0);var r=this._name;this._name=void 0,this._clampToGround=m(t.clampToGround,!1);var o=this;return Mt(this,this._entityCollection,e,t).then(function(){var e,t,n=o._entityCollection.computeAvailability(),i=n.start,s=n.stop,d=y.equals(i,w.MINIMUM_VALUE),m=y.equals(s,w.MAXIMUM_VALUE);d&&m||(d&&((t=new Date).setHours(0,0,0,0),i=y.fromDate(t)),m&&((t=new Date).setHours(24,0,0,0),s=y.fromDate(t)),(e=new q).startTime=i,e.stopTime=s,e.currentTime=y.clone(i),e.clockRange=a.LOOP_STOP,e.clockStep=l.SYSTEM_CLOCK_MULTIPLIER,e.multiplier=Math.round(Math.min(Math.max(y.secondsDifference(s,i)/60,1),31556900)));var c=!1;return e!==o._clock&&(o._clock=e,c=!0),r!==o._name&&(c=!0),c&&o._changed.raiseEvent(o),H.setLoading(o,!1),o}).otherwise(function(e){return H.setLoading(o,!1),o._error.raiseEvent(o,e),console.log(e),K.reject(e)})};var Lt=new t;return Tt.prototype.update=function(e){var r=this._networkLinks;if(0===r.length)return!0;var o=y.now(),i=this;Lt.removeAll();var a=!1,l=this._lastCameraView,s=this._camera;!c(s)||s.positionWC.equalsEpsilon(l.position,M.EPSILON7)&&s.directionWC.equalsEpsilon(l.direction,M.EPSILON7)&&s.upWC.equalsEpsilon(l.up,M.EPSILON7)||(l.position=n.clone(s.positionWC),l.direction=n.clone(s.directionWC),l.up=n.clone(s.upWC),l.bbox=s.computeViewRectangle(),a=!0);var d=new t,u=!1;return r.values.forEach(function(e){var t=e.entity;if(!Lt.contains(t.id)){if(!e.updating){var r=!1;if(e.refreshMode===pt.INTERVAL?y.secondsDifference(o,e.lastUpdated)>e.time&&(r=!0):e.refreshMode===pt.EXPIRE?y.greaterThan(o,e.time)&&(r=!0):e.refreshMode===pt.STOP&&(a&&(e.needsUpdate=!0,e.cameraUpdateTime=o),e.needsUpdate&&y.secondsDifference(o,e.cameraUpdateTime)>=e.time&&(r=!0)),r){!function e(t){for(var r=t._children,o=r.length,n=0;n<o;++n){var i=r[n];Lt.set(i.id,i),e(i)}}(t),e.updating=!0;var n=new X,s=e.href.clone();s.setQueryParameters(e.cookie);var p=m(i._ellipsoid,v.WGS84);xt(s,i._camera,i._canvas,e.viewBoundScale,l.bbox,p),Mt(i,n,s,{context:t.id}).then(function(e,t,r,o,n){return function(i){if(o.contains(t.id)){var a=!1,l=Oe(i,"NetworkLinkControl",Ie.kml),s=0;if(c(l)){if(c(Oe(l,"Update",Ie.kml)))return L("kml-networkLinkControl-update","KML - NetworkLinkControl updates aren't supported."),t.updating=!1,void o.remove(t.id);t.cookie=S(m(De(l,"cookie",Ie.kml),"")),s=m(Ae(l,"minRefreshPeriod",Ie.kml),0)}var d=y.now(),u=t.refreshMode;if(u===pt.INTERVAL)c(l)&&(t.time=Math.max(s,t.time));else if(u===pt.EXPIRE){var p;if(c(l)&&(p=De(l,"expires",Ie.kml)),c(p))try{var v=y.fromIso8601(p),f=y.secondsDifference(v,d);f>0&&f<s&&y.addSeconds(d,s,v),t.time=v}catch(e){L("kml-networkLinkControl-expires","KML - NetworkLinkControl expires is not a valid date"),a=!0}else L("kml-refreshMode-onExpire","KML - refreshMode of onExpire requires the NetworkLinkControl to have an expires element"),a=!0}var g=t.entity,h=e._entityCollection,k=r.values;h.suspendEvents();var x,M=h.values.slice();for(x=0;x<M.length;++x){var T=M[x];T.parent===g&&(T.parent=void 0,O(T))}for(h.resumeEvents(),h.suspendEvents(),x=0;x<k.length;x++){var b=k[x];c(b.parent)||(b.parent=g,bt(b)),h.add(b)}h.resumeEvents(),a?o.remove(t.id):t.lastUpdated=d;var C=h.computeAvailability(),E=C.start,_=C.stop,I=y.equals(E,w.MINIMUM_VALUE),N=y.equals(_,w.MAXIMUM_VALUE);if(!I||!N){var R=e._clock;R.startTime===E&&R.stopTime===_||(R.startTime=E,R.stopTime=_,e._changed.raiseEvent(e))}t.updating=!1,t.needsUpdate=!1,e._refresh.raiseEvent(e,n.getUrlComponent(!0))}function O(e){h.remove(e);for(var t=e._children,r=t.length,o=0;o<r;++o)O(t[o])}}}(i,e,n,d,s)).otherwise(function(t){var r="NetworkLink "+e.href+" refresh failed: "+t;console.log(r),i._error.raiseEvent(i,r)}),u=!0}}d.set(e.id,e)}}),u&&(this._networkLinks=d,this._changed.raiseEvent(this)),!0},Tt});