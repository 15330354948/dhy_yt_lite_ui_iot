define(["../../Core/Check","../../Core/Color","../../Core/defined","../../Core/defineProperties","../../Core/destroyObject","../../Core/ScreenSpaceEventHandler","../../Core/ScreenSpaceEventType","../../Scene/PGEarth3DTileColorBlendMode","../../Scene/PGEarth3DTileFeature","../../Scene/PGEarth3DTilePass","../../Scene/PGEarth3DTileset","../../Scene/PGEarth3DTileStyle","../../Scene/PerformanceDisplay","../../ThirdParty/knockout"],function(e,t,i,r,s,n,o,l,a,c,u,h,d,g){"use strict";function p(e,t){t?e._eventHandler.setInputAction(function(t){var r=e._scene.pick(t.endPosition);i(r)&&r.primitive instanceof u&&(e.tileset=r.primitive)},o.MOUSE_MOVE):(e._eventHandler.removeInputAction(o.MOUSE_MOVE),e.picking=e.picking)}var f={maximumFractionDigits:3};function m(e){var t=e/1048576;return t<1?t.toLocaleString(void 0,f):Math.round(t).toLocaleString()}function S(e,t){if(!i(e))return"";var r=t?e._statisticsPerPass[c.PICK]:e._statisticsPerPass[c.RENDER],s='<ul class="pgEarth-pgEarthInspector-statistics">';return s+="<li><strong>Visited: </strong>"+r.visited.toLocaleString()+"</li><li><strong>Selected: </strong>"+r.selected.toLocaleString()+"</li><li><strong>Commands: </strong>"+r.numberOfCommands.toLocaleString()+"</li>",s+="</ul>",t||(s+='<ul class="pgEarth-pgEarthInspector-statistics">',s+="<li><strong>Requests: </strong>"+r.numberOfPendingRequests.toLocaleString()+"</li><li><strong>Attempted: </strong>"+r.numberOfAttemptedRequests.toLocaleString()+"</li><li><strong>Processing: </strong>"+r.numberOfTilesProcessing.toLocaleString()+"</li><li><strong>Content Ready: </strong>"+r.numberOfTilesWithContentReady.toLocaleString()+"</li><li><strong>Total: </strong>"+r.numberOfTilesTotal.toLocaleString()+"</li>",s+="</ul>",s+='<ul class="pgEarth-pgEarthInspector-statistics">',s+="<li><strong>Features Selected: </strong>"+r.numberOfFeaturesSelected.toLocaleString()+"</li><li><strong>Features Loaded: </strong>"+r.numberOfFeaturesLoaded.toLocaleString()+"</li><li><strong>Points Selected: </strong>"+r.numberOfPointsSelected.toLocaleString()+"</li><li><strong>Points Loaded: </strong>"+r.numberOfPointsLoaded.toLocaleString()+"</li><li><strong>Triangles Selected: </strong>"+r.numberOfTrianglesSelected.toLocaleString()+"</li>",s+="</ul>",s+='<ul class="pgEarth-pgEarthInspector-statistics">',s+="<li><strong>Tiles styled: </strong>"+r.numberOfTilesStyled.toLocaleString()+"</li><li><strong>Features styled: </strong>"+r.numberOfFeaturesStyled.toLocaleString()+"</li>",s+="</ul>",s+='<ul class="pgEarth-pgEarthInspector-statistics">',s+="<li><strong>Children Union Culled: </strong>"+r.numberOfTilesCulledWithChildrenUnion.toLocaleString()+"</li>",s+="</ul>",s+='<ul class="pgEarth-pgEarthInspector-statistics">',s+="<li><strong>Geometry Memory (MB): </strong>"+m(r.geometryByteLength)+"</li><li><strong>Texture Memory (MB): </strong>"+m(r.texturesByteLength)+"</li><li><strong>Batch Table Memory (MB): </strong>"+m(r.batchTableByteLength)+"</li>",s+="</ul>"),s}var y=[{text:"Highlight",value:l.HIGHLIGHT},{text:"Replace",value:l.REPLACE},{text:"Mix",value:l.MIX}],b=new t(1,1,0,.4),v=new t,_=new t;function E(t,r){e.typeOf.object("scene",t),e.typeOf.object("performanceContainer",r);var s=this,c=t.canvas;this._eventHandler=new n(c),this._scene=t,this._performanceContainer=r,this._canvas=c,this._performanceDisplay=new d({container:r}),this._statisticsText="",this._pickStatisticsText="",this._editorError="",this.performance=!1,this.showStatistics=!0,this.showPickStatistics=!0,this.inspectorVisible=!0,this.tilesetVisible=!1,this.displayVisible=!1,this.updateVisible=!1,this.loggingVisible=!1,this.styleVisible=!1,this.tileDebugLabelsVisible=!1,this.optimizationVisible=!1,this.styleString="{}",this._tileset=void 0,this._feature=void 0,this._tile=void 0,g.track(this,["performance","inspectorVisible","_statisticsText","_pickStatisticsText","_editorError","showPickStatistics","showStatistics","tilesetVisible","displayVisible","updateVisible","loggingVisible","styleVisible","optimizationVisible","tileDebugLabelsVisible","styleString","_feature","_tile"]),this._properties=g.observable({}),this.properties=[],g.defineProperty(this,"properties",function(){var e=[],t=s._properties();for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e});var h=g.observable();g.defineProperty(this,"dynamicScreenSpaceError",{get:function(){return h()},set:function(e){h(e),i(s._tileset)&&(s._tileset.dynamicScreenSpaceError=e)}}),this.dynamicScreenSpaceError=!1;var f=g.observable();g.defineProperty(this,"colorBlendMode",{get:function(){return f()},set:function(e){f(e),i(s._tileset)&&(s._tileset.colorBlendMode=e,s._scene.requestRender())}}),this.colorBlendMode=l.HIGHLIGHT;var m=g.observable();g.defineProperty(this,"picking",{get:function(){return m()},set:function(e){m(e),e?s._eventHandler.setInputAction(function(e){var r=t.pick(e.endPosition);if(r instanceof a?(s.feature=r,s.tile=r.content.tile):i(r)&&i(r.content)?(s.feature=void 0,s.tile=r.content.tile):(s.feature=void 0,s.tile=void 0),i(s._tileset)){var n;if(L&&i(r)&&i(r.content))t.pickPositionSupported&&(n=t.pickPosition(e.endPosition),i(n)&&(s._tileset.debugPickPosition=n)),s._tileset.debugPickedTile=r.content.tile;else s._tileset.debugPickedTile=void 0;s._scene.requestRender()}},o.MOUSE_MOVE):(s.feature=void 0,s.tile=void 0,s._eventHandler.removeInputAction(o.MOUSE_MOVE))}}),this.picking=!0;var S=g.observable();g.defineProperty(this,"colorize",{get:function(){return S()},set:function(e){S(e),i(s._tileset)&&(s._tileset.debugColorizeTiles=e,s._scene.requestRender())}}),this.colorize=!1;var y=g.observable();g.defineProperty(this,"wireframe",{get:function(){return y()},set:function(e){y(e),i(s._tileset)&&(s._tileset.debugWireframe=e,s._scene.requestRender())}}),this.wireframe=!1;var b=g.observable();g.defineProperty(this,"showBoundingVolumes",{get:function(){return b()},set:function(e){b(e),i(s._tileset)&&(s._tileset.debugShowBoundingVolume=e,s._scene.requestRender())}}),this.showBoundingVolumes=!1;var v=g.observable();g.defineProperty(this,"showContentBoundingVolumes",{get:function(){return v()},set:function(e){v(e),i(s._tileset)&&(s._tileset.debugShowContentBoundingVolume=e,s._scene.requestRender())}}),this.showContentBoundingVolumes=!1;var _=g.observable();g.defineProperty(this,"showRequestVolumes",{get:function(){return _()},set:function(e){_(e),i(s._tileset)&&(s._tileset.debugShowViewerRequestVolume=e,s._scene.requestRender())}}),this.showRequestVolumes=!1;var E=g.observable();g.defineProperty(this,"freezeFrame",{get:function(){return E()},set:function(e){E(e),i(s._tileset)&&(s._tileset.debugFreezeFrame=e,s._scene.debugShowFrustumPlanes=e,s._scene.requestRender())}}),this.freezeFrame=!1;var L=g.observable();g.defineProperty(this,"showOnlyPickedTileDebugLabel",{get:function(){return L()},set:function(e){L(e),i(s._tileset)&&(s._tileset.debugPickedTileLabelOnly=e,s._scene.requestRender())}}),this.showOnlyPickedTileDebugLabel=!1;var P=g.observable();g.defineProperty(this,"showGeometricError",{get:function(){return P()},set:function(e){P(e),i(s._tileset)&&(s._tileset.debugShowGeometricError=e,s._scene.requestRender())}}),this.showGeometricError=!1;var D=g.observable();g.defineProperty(this,"showRenderingStatistics",{get:function(){return D()},set:function(e){D(e),i(s._tileset)&&(s._tileset.debugShowRenderingStatistics=e,s._scene.requestRender())}}),this.showRenderingStatistics=!1;var w=g.observable();g.defineProperty(this,"showMemoryUsage",{get:function(){return w()},set:function(e){w(e),i(s._tileset)&&(s._tileset.debugShowMemoryUsage=e,s._scene.requestRender())}}),this.showMemoryUsage=!1;var k=g.observable();g.defineProperty(this,"showUrl",{get:function(){return k()},set:function(e){k(e),i(s._tileset)&&(s._tileset.debugShowUrl=e,s._scene.requestRender())}}),this.showUrl=!1;var V=g.observable();g.defineProperty(this,"maximumScreenSpaceError",{get:function(){return V()},set:function(e){e=Number(e),isNaN(e)||(V(e),i(s._tileset)&&(s._tileset.maximumScreenSpaceError=e))}}),this.maximumScreenSpaceError=16;var R=g.observable();g.defineProperty(this,"dynamicScreenSpaceErrorDensity",{get:function(){return R()},set:function(e){e=Number(e),isNaN(e)||(R(e),i(s._tileset)&&(s._tileset.dynamicScreenSpaceErrorDensity=e))}}),this.dynamicScreenSpaceErrorDensity=.00278,this.dynamicScreenSpaceErrorDensitySliderValue=void 0,g.defineProperty(this,"dynamicScreenSpaceErrorDensitySliderValue",{get:function(){return Math.pow(R(),1/6)},set:function(e){R(Math.pow(e,6))}});var C=g.observable();g.defineProperty(this,"dynamicScreenSpaceErrorFactor",{get:function(){return C()},set:function(e){e=Number(e),isNaN(e)||(C(e),i(s._tileset)&&(s._tileset.dynamicScreenSpaceErrorFactor=e))}}),this.dynamicScreenSpaceErrorFactor=4;var T,O=(T=this,function(e){var t=T._scene.pick(e.position);i(t)&&t.primitive instanceof u&&(T.tileset=t.primitive),T.pickActive=!1}),N=g.observable();g.defineProperty(this,"pickActive",{get:function(){return N()},set:function(e){N(e),e?s._eventHandler.setInputAction(O,o.LEFT_CLICK):s._eventHandler.removeInputAction(o.LEFT_CLICK)}});var x=g.observable();g.defineProperty(this,"pointCloudShading",{get:function(){return x()},set:function(e){x(e),i(s._tileset)&&(s._tileset.pointCloudShading.attenuation=e)}}),this.pointCloudShading=!1;var M=g.observable();g.defineProperty(this,"geometricErrorScale",{get:function(){return M()},set:function(e){e=Number(e),isNaN(e)||(M(e),i(s._tileset)&&(s._tileset.pointCloudShading.geometricErrorScale=e))}}),this.geometricErrorScale=1;var F=g.observable();g.defineProperty(this,"maximumAttenuation",{get:function(){return F()},set:function(e){e=Number(e),isNaN(e)||(F(e),i(s._tileset)&&(s._tileset.pointCloudShading.maximumAttenuation=0===e?void 0:e))}}),this.maximumAttenuation=0;var q=g.observable();g.defineProperty(this,"baseResolution",{get:function(){return q()},set:function(e){e=Number(e),isNaN(e)||(q(e),i(s._tileset)&&(s._tileset.pointCloudShading.baseResolution=0===e?void 0:e))}}),this.baseResolution=0;var B=g.observable();g.defineProperty(this,"eyeDomeLighting",{get:function(){return B()},set:function(e){B(e),i(s._tileset)&&(s._tileset.pointCloudShading.eyeDomeLighting=e)}}),this.eyeDomeLighting=!1;var A=g.observable();g.defineProperty(this,"eyeDomeLightingStrength",{get:function(){return A()},set:function(e){e=Number(e),isNaN(e)||(A(e),i(s._tileset)&&(s._tileset.pointCloudShading.eyeDomeLightingStrength=e))}}),this.eyeDomeLightingStrength=1;var I=g.observable();g.defineProperty(this,"eyeDomeLightingRadius",{get:function(){return I()},set:function(e){e=Number(e),isNaN(e)||(I(e),i(s._tileset)&&(s._tileset.pointCloudShading.eyeDomeLightingRadius=e))}}),this.eyeDomeLightingRadius=1,this.pickActive=!1;var H=g.observable();g.defineProperty(this,"skipLevelOfDetail",{get:function(){return H()},set:function(e){H(e),i(s._tileset)&&(s._tileset.skipLevelOfDetail=e)}}),this.skipLevelOfDetail=!0;var U=g.observable();g.defineProperty(this,"skipScreenSpaceErrorFactor",{get:function(){return U()},set:function(e){e=Number(e),isNaN(e)||(U(e),i(s._tileset)&&(s._tileset.skipScreenSpaceErrorFactor=e))}}),this.skipScreenSpaceErrorFactor=16;var z=g.observable();g.defineProperty(this,"baseScreenSpaceError",{get:function(){return z()},set:function(e){e=Number(e),isNaN(e)||(z(e),i(s._tileset)&&(s._tileset.baseScreenSpaceError=e))}}),this.baseScreenSpaceError=1024;var G=g.observable();g.defineProperty(this,"skipLevels",{get:function(){return G()},set:function(e){e=Number(e),isNaN(e)||(G(e),i(s._tileset)&&(s._tileset.skipLevels=e))}}),this.skipLevels=1;var K=g.observable();g.defineProperty(this,"immediatelyLoadDesiredLevelOfDetail",{get:function(){return K()},set:function(e){K(e),i(s._tileset)&&(s._tileset.immediatelyLoadDesiredLevelOfDetail=e)}}),this.immediatelyLoadDesiredLevelOfDetail=!1;var j=g.observable();g.defineProperty(this,"loadSiblings",{get:function(){return j()},set:function(e){j(e),i(s._tileset)&&(s._tileset.loadSiblings=e)}}),this.loadSiblings=!1,this._style=void 0,this._shouldStyle=!1,this._definedProperties=["properties","dynamicScreenSpaceError","colorBlendMode","picking","colorize","wireframe","showBoundingVolumes","showContentBoundingVolumes","showRequestVolumes","freezeFrame","maximumScreenSpaceError","dynamicScreenSpaceErrorDensity","baseScreenSpaceError","skipScreenSpaceErrorFactor","skipLevelOfDetail","skipLevels","immediatelyLoadDesiredLevelOfDetail","loadSiblings","dynamicScreenSpaceErrorDensitySliderValue","dynamicScreenSpaceErrorFactor","pickActive","showOnlyPickedTileDebugLabel","showGeometricError","showRenderingStatistics","showMemoryUsage","showUrl","pointCloudShading","geometricErrorScale","maximumAttenuation","baseResolution","eyeDomeLighting","eyeDomeLightingStrength","eyeDomeLightingRadius"],this._removePostRenderEvent=t.postRender.addEventListener(function(){s._update()}),i(this._tileset)||p(this,!0)}function L(e){if(e.featuresLength>0)return!0;var t=e.innerContents;if(i(t)){for(var r=t.length,s=0;s<r;++s)if(!L(t[s]))return!1;return!0}return!1}return r(E.prototype,{scene:{get:function(){return this._scene}},performanceContainer:{get:function(){return this._performanceContainer}},statisticsText:{get:function(){return this._statisticsText}},pickStatisticsText:{get:function(){return this._pickStatisticsText}},colorBlendModes:{get:function(){return y}},editorError:{get:function(){return this._editorError}},tileset:{get:function(){return this._tileset},set:function(e){if(this._tileset=e,this._style=void 0,this.styleString="{}",this.feature=void 0,this.tile=void 0,i(e)){var t=this;e.readyPromise.then(function(e){t.isDestroyed()||t._properties(e.properties)});for(var r=["colorize","wireframe","showBoundingVolumes","showContentBoundingVolumes","showRequestVolumes","freezeFrame","showOnlyPickedTileDebugLabel","showGeometricError","showRenderingStatistics","showMemoryUsage","showUrl"],s=r.length,n=0;n<s;++n){var o=r[n];this[o]=this[o]}this.maximumScreenSpaceError=e.maximumScreenSpaceError,this.dynamicScreenSpaceError=e.dynamicScreenSpaceError,this.dynamicScreenSpaceErrorDensity=e.dynamicScreenSpaceErrorDensity,this.dynamicScreenSpaceErrorFactor=e.dynamicScreenSpaceErrorFactor,this.colorBlendMode=e.colorBlendMode,this.skipLevelOfDetail=e.skipLevelOfDetail,this.skipScreenSpaceErrorFactor=e.skipScreenSpaceErrorFactor,this.baseScreenSpaceError=e.baseScreenSpaceError,this.skipLevels=e.skipLevels,this.immediatelyLoadDesiredLevelOfDetail=e.immediatelyLoadDesiredLevelOfDetail,this.loadSiblings=e.loadSiblings;var l=e.pointCloudShading;this.pointCloudShading=l.attenuation,this.geometricErrorScale=l.geometricErrorScale,this.maximumAttenuation=l.maximumAttenuation?l.maximumAttenuation:0,this.baseResolution=l.baseResolution?l.baseResolution:0,this.eyeDomeLighting=l.eyeDomeLighting,this.eyeDomeLightingStrength=l.eyeDomeLightingStrength,this.eyeDomeLightingRadius=l.eyeDomeLightingRadius,this._scene.requestRender()}else this._properties({});this._statisticsText=S(e,!1),this._pickStatisticsText=S(e,!0),p(this,!1)}},feature:{get:function(){return this._feature},set:function(e){if(this._feature!==e){var r=this._feature;i(r)&&!r.content.isDestroyed()&&(!this.colorize&&i(this._style)?r.color=i(this._style.color)?this._style.color.evaluateColor(r,v):t.WHITE:r.color=_,this._scene.requestRender()),i(e)&&(t.clone(e.color,_),e.color=b,this._scene.requestRender()),this._feature=e}}},tile:{get:function(){return this._tile},set:function(e){if(this._tile!==e){var r=this._tile;!i(r)||r.isDestroyed()||L(r.content)||(r.color=_,this._scene.requestRender()),i(e)&&!L(e.content)&&(t.clone(e.color,_),e.color=b,this._scene.requestRender()),this._tile=e}}}}),E.prototype.togglePickTileset=function(){this.pickActive=!this.pickActive},E.prototype.toggleInspector=function(){this.inspectorVisible=!this.inspectorVisible},E.prototype.toggleTileset=function(){this.tilesetVisible=!this.tilesetVisible},E.prototype.toggleDisplay=function(){this.displayVisible=!this.displayVisible},E.prototype.toggleUpdate=function(){this.updateVisible=!this.updateVisible},E.prototype.toggleLogging=function(){this.loggingVisible=!this.loggingVisible},E.prototype.toggleStyle=function(){this.styleVisible=!this.styleVisible},E.prototype.toggleTileDebugLabels=function(){this.tileDebugLabelsVisible=!this.tileDebugLabelsVisible},E.prototype.toggleOptimization=function(){this.optimizationVisible=!this.optimizationVisible},E.prototype.trimTilesCache=function(){i(this._tileset)&&this._tileset.trimLoadedTiles()},E.prototype.compileStyle=function(){var e=this._tileset;if(i(e)&&this.styleString!==JSON.stringify(e.style)){this._editorError="";try{0===this.styleString.length&&(this.styleString="{}"),this._style=new h(JSON.parse(this.styleString)),this._shouldStyle=!0,this._scene.requestRender()}catch(e){this._editorError=e.toString()}this.feature=this._feature,this.tile=this._tile}},E.prototype.styleEditorKeyPress=function(e,t){if(9===t.keyCode){t.preventDefault();var i,r=t.target,s=r.selectionStart,n=r.selectionEnd,o=n,l=r.value.slice(s,n).split("\n"),a=l.length;if(t.shiftKey)for(i=0;i<a;++i)" "===l[i][0]&&(" "===l[i][1]?(l[i]=l[i].substr(2),o-=2):(l[i]=l[i].substr(1),o-=1));else for(i=0;i<a;++i)l[i]="  "+l[i],o+=2;var c=l.join("\n");r.value=r.value.slice(0,s)+c+r.value.slice(n),r.selectionStart=s!==n?s:o,r.selectionEnd=o}else!t.ctrlKey||10!==t.keyCode&&13!==t.keyCode||this.compileStyle();return!0},E.prototype._update=function(){var e=this._tileset;if(this.performance&&this._performanceDisplay.update(),i(e)){if(e.isDestroyed())return this.tile=void 0,this.feature=void 0,void(this.tileset=void 0);var t=e.style;this._style!==e.style&&(this._shouldStyle?(e.style=this._style,this._shouldStyle=!1):(this._style=t,this.styleString=JSON.stringify(t.style,null,"  ")))}this.showStatistics&&(this._statisticsText=S(e,!1),this._pickStatisticsText=S(e,!0))},E.prototype.isDestroyed=function(){return!1},E.prototype.destroy=function(){this._eventHandler.destroy(),this._removePostRenderEvent();var e=this;return this._definedProperties.forEach(function(t){g.getObservable(e,t).dispose()}),s(this)},E.getStatistics=S,E});