define(["../ThirdParty/when","./Cartesian2","./defined","./DeveloperError","./sampleTerrain"],function(e,i,r,t,n){"use strict";var a=new i;return function i(o,u){if(!r(o))throw new t("terrainProvider is required.");if(!r(u))throw new t("positions is required.");return o.readyPromise.then(function(){var l=[],s=[],h=o.availability;if(!r(h))throw new t("sampleTerrainMostDetailed requires a terrain provider that has tile availability.");for(var f=[],v=0;v<u.length;++v){var p=u[v],c=h.computeMaximumLevelAtPosition(p);if(s[v]=c,0===c){o.tilingScheme.positionToTileXY(p,1,a);var d=o.loadTileDataAvailability(a.x,a.y,1);r(d)&&f.push(d)}var m=l[c];r(m)||(l[c]=m=[]),m.push(p)}return e.all(f).then(function(){return e.all(l.map(function(e,i){if(r(e))return n(o,i,e)}))}).then(function(){for(var e=[],r=0;r<u.length;++r){var t=u[r];h.computeMaximumLevelAtPosition(t)!==s[r]&&e.push(t)}if(e.length>0)return i(o,e)}).then(function(){return u})})}});