define(["../ThirdParty/Uri","../ThirdParty/when","./AttributeCompression","./BoundingSphere","./Cartesian2","./Cartesian3","./Credit","./defaultValue","./defined","./defineProperties","./DeveloperError","./Event","./GeographicTilingScheme","./getStringFromTypedArray","./HeightmapTerrainData","./IndexDatatype","./Math","./OrientedBoundingBox","./QuantizedMeshTerrainData","./Request","./RequestType","./Resource","./RuntimeError","./TerrainProvider","./TileAvailability","./TileProviderError","./createGuid"],function(e,t,i,r,a,n,s,l,o,h,d,v,u,m,y,c,f,_,g,E,T,p,b,A,M,x,S){"use strict";function w(e){if(!o(e)||!o(e.url))throw new d("options.url is required.");this._tilingScheme=new u({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1,ellipsoid:e.ellipsoid}),this._heightmapWidth=65,this._levelZeroMaximumGeometricError=A.getEstimatedLevelZeroGeometricErrorForAHeightmap(this._tilingScheme.ellipsoid,this._heightmapWidth,this._tilingScheme.getNumberOfXTilesAtLevel(0)),this._heightmapStructure=void 0,this._hasWaterMask=!1,this._hasVertexNormals=!1,this._requestVertexNormals=l(e.requestVertexNormals,!1),this._requestWaterMask=l(e.requestWaterMask,!1),this._requestMetadata=l(e.requestMetadata,!0),this._errorEvent=new v;var i=e.credit;"string"==typeof i&&(i=new s(i)),this._credit=i,this._availability=void 0;var r=t.defer();this._ready=!1,this._readyPromise=r,this._tileCredits=void 0;var a,n,h,m=this,y=this._layers=[],c="",f=[],_=0;function g(e){var i;if(!e.format)return i="The tile format is not specified in the layer.json file.",void(h=x.handleError(h,m,m._errorEvent,i,void 0,void 0,void 0,w));if(!e.tiles||0===e.tiles.length)return i="The layer.json file does not specify any tile URL templates.",void(h=x.handleError(h,m,m._errorEvent,i,void 0,void 0,void 0,w));var r=!1,s=!1,l=!1,d=!0,v=!1;if("heightmap-1.0"===e.format)v=!0,o(m._heightmapStructure)||(m._heightmapStructure={heightScale:.2,heightOffset:-1e3,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1,lowestEncodedHeight:0,highestEncodedHeight:65535}),s=!0,m._requestWaterMask=!0;else if(0!==e.format.indexOf("quantized-mesh-1."))return i='The tile format "'+e.format+'" is invalid or not supported.',void(h=x.handleError(h,m,m._errorEvent,i,void 0,void 0,void 0,w));var u,T=e.tiles,p=e.maxzoom;_=Math.max(_,p),o(e.extensions)&&-1!==e.extensions.indexOf("octvertexnormals")?r=!0:o(e.extensions)&&-1!==e.extensions.indexOf("vertexnormals")&&(r=!0,d=!1),o(e.extensions)&&-1!==e.extensions.indexOf("watermask")&&(s=!0),o(e.extensions)&&-1!==e.extensions.indexOf("metadata")&&(l=!0);var b,A=e.metadataAvailability,S=e.available;if(o(S)&&!o(A)){b=new M(m._tilingScheme,S.length);for(var L=0;L<S.length;++L){var N=S[L],R=m._tilingScheme.getNumberOfYTilesAtLevel(L);o(f[L])||(f[L]=[]);for(var q=0;q<N.length;++q){var U=N[q],P=R-U.endY-1,k=R-U.startY-1;f[L].push([U.startX,P,U.endX,k]),b.addAvailableTileRange(L,U.startX,P,U.endX,k)}}}else o(A)&&(u=new M(m._tilingScheme,p),b=new M(m._tilingScheme,p),f[0]=[[0,0,1,0]],b.addAvailableTileRange(0,0,0,1,0));m._hasWaterMask=m._hasWaterMask||s,m._hasVertexNormals=m._hasVertexNormals||r,m._hasMetadata=m._hasMetadata||l,o(e.attribution)&&(c.length>0&&(c+=" "),c+=e.attribution),y.push(new function(e){this.resource=e.resource,this.version=e.version,this.isHeightmap=e.isHeightmap,this.tileUrlTemplates=e.tileUrlTemplates,this.availability=e.availability,this.hasVertexNormals=e.hasVertexNormals,this.hasWaterMask=e.hasWaterMask,this.hasMetadata=e.hasMetadata,this.availabilityLevels=e.availabilityLevels,this.availabilityTilesLoaded=e.availabilityTilesLoaded,this.littleEndianExtensionSize=e.littleEndianExtensionSize,this.availabilityTilesLoaded=e.availabilityTilesLoaded,this.availabilityPromiseCache={}}({resource:a,version:e.version,isHeightmap:v,tileUrlTemplates:T,availability:b,hasVertexNormals:r,hasWaterMask:s,hasMetadata:l,availabilityLevels:A,availabilityTilesLoaded:u,littleEndianExtensionSize:d}));var B=e.parentUrl;if(o(B)){if(!o(b))return console.log("A layer.json can't have a parentUrl if it does't have an available array."),t.resolve();(a=a.getDerivedResource({url:B})).appendForwardSlash();var W=(n=a.getDerivedResource({url:"layer.json"})).fetchJson();return t(W,g,E)}return t.resolve()}function E(e){var t="An error occurred while accessing "+n.url+".";h=x.handleError(h,m,m._errorEvent,t,void 0,void 0,void 0,w)}function T(e){g(e).then(function(){if(!o(h)){var e=f.length;if(e>0)for(var t=m._availability=new M(m._tilingScheme,_),i=0;i<e;++i)for(var r=f[i],a=0;a<r.length;++a){var n=r[a];t.addAvailableTileRange(i,n[0],n[1],n[2],n[3])}if(c.length>0){var l=new s(c);o(m._tileCredits)?m._tileCredits.push(l):m._tileCredits=[l]}m._ready=!0,m._readyPromise.resolve(!0)}})}function b(e){o(e)&&404===e.statusCode?T({tilejson:"2.1.0",format:"heightmap-1.0",version:"1.0.0",scheme:"tms",tiles:["{z}/{x}/{y}.terrain?v={version}"]}):E()}function w(){t(n.fetchJson()).then(T).otherwise(b)}t(e.url).then(function(e){var t=p.createIfNeeded(e);t.appendForwardSlash(),t.setQueryParameters({uuid:S()}),n=(a=t).getDerivedResource({url:"layer.json"}),m._tileCredits=t.credits,w()}).otherwise(function(e){r.reject(e)})}var L={OCT_VERTEX_NORMALS:1,WATER_MASK:2,METADATA:4};function N(e){return o(e)&&0!==e.length?{Accept:"application/vnd.quantized-mesh;extensions="+e.join("-")+",application/octet-stream;q=0.9,*/*;q=0.01"}:{Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"}}function R(e,a,s,l,h,d){if(!o(h))return t.reject(new b("Terrain tile doesn't exist"));var v=h.tileUrlTemplates;if(0!==v.length){var u,E,T=e._tilingScheme.getNumberOfYTilesAtLevel(l)-s-1,p=[];e._requestVertexNormals&&h.hasVertexNormals&&p.push(h.littleEndianExtensionSize?"octvertexnormals":"vertexnormals"),e._requestWaterMask&&h.hasWaterMask&&p.push("watermask"),e._requestMetadata&&h.hasMetadata&&p.push("metadata");var A=v[(a+T+l)%v.length],M=h.resource;o(M._ionEndpoint)&&!o(M._ionEndpoint.externalType)?(0!==p.length&&(E={extensions:p.join("-")}),u=N(void 0)):u=N(p);var x=M.getDerivedResource({url:A,templateValues:{version:h.version,z:l,x:a,y:T},queryParameters:E,headers:u,request:d}).fetchArrayBuffer();if(o(x))return x.then(function(t){return o(e._heightmapStructure)?function(e,t,i,r,a,n){var s=new Uint16Array(t,0,e._heightmapWidth*e._heightmapWidth);return new y({buffer:s,childTileMask:new Uint8Array(t,s.byteLength,1)[0],waterMask:new Uint8Array(t,s.byteLength+1,t.byteLength-s.byteLength-1),width:e._heightmapWidth,height:e._heightmapWidth,structure:e._heightmapStructure,credits:e._tileCredits})}(e,t):function(e,t,a,s,l,h,d){var v=d.littleEndianExtensionSize,u=0,y=3*Float64Array.BYTES_PER_ELEMENT,E=4*Float64Array.BYTES_PER_ELEMENT,T=3*Uint16Array.BYTES_PER_ELEMENT,p=Uint16Array.BYTES_PER_ELEMENT,b=3*p,A=new DataView(t),M=new n(A.getFloat64(u,!0),A.getFloat64(u+8,!0),A.getFloat64(u+16,!0));u+=y;var x=A.getFloat32(u,!0);u+=Float32Array.BYTES_PER_ELEMENT;var S=A.getFloat32(u,!0);u+=Float32Array.BYTES_PER_ELEMENT;var w=new r(new n(A.getFloat64(u,!0),A.getFloat64(u+8,!0),A.getFloat64(u+16,!0)),A.getFloat64(u+y,!0));u+=E;var N=new n(A.getFloat64(u,!0),A.getFloat64(u+8,!0),A.getFloat64(u+16,!0));u+=y;var R=A.getUint32(u,!0);u+=Uint32Array.BYTES_PER_ELEMENT;var q=new Uint16Array(t,u,3*R);u+=R*T,R>65536&&(b=3*(p=Uint32Array.BYTES_PER_ELEMENT));var U=q.subarray(0,R),P=q.subarray(R,2*R),k=q.subarray(2*R,3*R);i.zigZagDeltaDecode(U,P,k),u%p!=0&&(u+=p-u%p);var B=A.getUint32(u,!0);u+=Uint32Array.BYTES_PER_ELEMENT;var W=c.createTypedArrayFromArrayBuffer(R,t,u,3*B);u+=B*b;for(var F=0,Y=W.length,V=0;V<Y;++V){var O=W[V];W[V]=F-O,0===O&&++F}var C=A.getUint32(u,!0);u+=Uint32Array.BYTES_PER_ELEMENT;var z=c.createTypedArrayFromArrayBuffer(R,t,u,C);u+=C*p;var D=A.getUint32(u,!0);u+=Uint32Array.BYTES_PER_ELEMENT;var H=c.createTypedArrayFromArrayBuffer(R,t,u,D);u+=D*p;var X=A.getUint32(u,!0);u+=Uint32Array.BYTES_PER_ELEMENT;var j=c.createTypedArrayFromArrayBuffer(R,t,u,X);u+=X*p;var G=A.getUint32(u,!0);u+=Uint32Array.BYTES_PER_ELEMENT;var I,Z,J=c.createTypedArrayFromArrayBuffer(R,t,u,G);for(u+=G*p;u<A.byteLength;){var K=A.getUint8(u,!0);u+=Uint8Array.BYTES_PER_ELEMENT;var Q=A.getUint32(u,v);if(u+=Uint32Array.BYTES_PER_ELEMENT,K===L.OCT_VERTEX_NORMALS&&e._requestVertexNormals)I=new Uint8Array(t,u,2*R);else if(K===L.WATER_MASK&&e._requestWaterMask)Z=new Uint8Array(t,u,Q);else if(K===L.METADATA&&e._requestMetadata){var $=A.getUint32(u,!0);if($>0){var ee=m(new Uint8Array(t),u+Uint32Array.BYTES_PER_ELEMENT,$),te=JSON.parse(ee).available;if(o(te))for(var ie=0;ie<te.length;++ie)for(var re=a+ie+1,ae=te[ie],ne=e._tilingScheme.getNumberOfYTilesAtLevel(re),se=0;se<ae.length;++se){var le=ae[se],oe=ne-le.endY-1,he=ne-le.startY-1;e.availability.addAvailableTileRange(re,le.startX,oe,le.endX,he),d.availability.addAvailableTileRange(re,le.startX,oe,le.endX,he)}}d.availabilityTilesLoaded.addAvailableTileRange(a,s,l,s,l)}u+=Q}var de,ve=5*e.getLevelMaximumGeometricError(a),ue=e._tilingScheme.tileXYToRectangle(s,l,a);return ue.width<f.PI_OVER_TWO+f.EPSILON5&&(de=_.fromRectangle(ue,x,S,e._tilingScheme.ellipsoid)),new g({center:M,minimumHeight:x,maximumHeight:S,boundingSphere:w,orientedBoundingBox:de,horizonOcclusionPoint:N,quantizedVertices:q,encodedNormals:I,indices:W,westIndices:z,southIndices:H,eastIndices:j,northIndices:J,westSkirtHeight:ve,southSkirtHeight:ve,eastSkirtHeight:ve,northSkirtHeight:ve,childTileMask:e.availability.computeChildMaskForTile(a,s,l),waterMask:Z,credits:e._tileCredits})}(e,t,l,a,s,0,h)})}}function q(e,t,i,r){if(0!==r){var a=e.availabilityLevels,n=r%a==0?r-a:(r/a|0)*a,s=1<<r-n;return{level:n,x:t/s|0,y:i/s|0}}}function U(e,t,i,r,a,n){if(!o(a.availabilityLevels))return{result:!1};for(var s,l=function(){delete a.availabilityPromiseCache[s]},h=a.availabilityTilesLoaded,d=a.availability,v=q(a,t,i,r);o(v);){if(d.isTileAvailable(v.level,v.x,v.y)&&!h.isTileAvailable(v.level,v.x,v.y)){var u;if(!n&&(s=v.level+"-"+v.x+"-"+v.y,u=a.availabilityPromiseCache[s],!o(u))){var m=new E({throttle:!0,throttleByServer:!0,type:T.TERRAIN});u=R(e,v.x,v.y,v.level,a,m),o(u)&&(a.availabilityPromiseCache[s]=u,u.then(l))}return{result:!0,promise:u}}v=q(a,v.x,v.y,v.level)}return{result:!1}}return w.prototype.requestTileGeometry=function(e,t,i,r){if(!this._ready)throw new d("requestTileGeometry must not be called before the terrain provider is ready.");var a,n=this._layers,s=n.length;if(1===s)a=n[0];else for(var l=0;l<s;++l){var h=n[l];if(!o(h.availability)||h.availability.isTileAvailable(i,e,t)){a=h;break}}return R(this,e,t,i,a,r)},h(w.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){if(!this._ready)throw new d("credit must not be called before the terrain provider is ready.");return this._credit}},tilingScheme:{get:function(){if(!this._ready)throw new d("tilingScheme must not be called before the terrain provider is ready.");return this._tilingScheme}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},hasWaterMask:{get:function(){if(!this._ready)throw new d("hasWaterMask must not be called before the terrain provider is ready.");return this._hasWaterMask&&this._requestWaterMask}},hasVertexNormals:{get:function(){if(!this._ready)throw new d("hasVertexNormals must not be called before the terrain provider is ready.");return this._hasVertexNormals&&this._requestVertexNormals}},hasMetadata:{get:function(){if(!this._ready)throw new d("hasMetadata must not be called before the terrain provider is ready.");return this._hasMetadata&&this._requestMetadata}},requestVertexNormals:{get:function(){return this._requestVertexNormals}},requestWaterMask:{get:function(){return this._requestWaterMask}},requestMetadata:{get:function(){return this._requestMetadata}},availability:{get:function(){if(!this._ready)throw new d("availability must not be called before the terrain provider is ready.");return this._availability}}}),w.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)},w.prototype.getTileDataAvailable=function(e,t,i){if(o(this._availability)){if(i>this._availability._maximumLevel)return!1;if(this._availability.isTileAvailable(i,e,t))return!0;if(!this._hasMetadata)return!1;for(var r=this._layers,a=r.length,n=0;n<a;++n){if(U(this,e,t,i,r[n],0===n).result)return}return!1}},w.prototype.loadTileDataAvailability=function(e,t,i){if(!(!o(this._availability)||i>this._availability._maximumLevel||this._availability.isTileAvailable(i,e,t))&&this._hasMetadata)for(var r=this._layers,a=r.length,n=0;n<a;++n){var s=U(this,e,t,i,r[n],0===n);if(o(s.promise))return s.promise}},w._getAvailabilityTile=q,w});