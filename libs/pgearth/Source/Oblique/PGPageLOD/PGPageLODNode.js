define(["../../Core/BoundingSphere","../../Core/Cartesian2","../../Core/Cartesian3","../../Core/Cartesian4","../../Core/Color","../../Core/defaultValue","../../Core/defined","../../Core/defineProperties","../../Core/destroyObject","../../Core/getMagic","../../Core/getTimestamp","../../Core/Intersect","../../Core/JulianDate","../../Core/Matrix3","../../Core/Matrix4","../../Core/Rectangle","../../Core/Request","../../Core/RequestState","../../Core/RequestType","../../Core/Resource","../../Core/PixelFormat","../../Core/Plane","../../Core/PrimitiveType","../../Core/IndexDatatype","../../Core/ComponentDatatype","../../Renderer/Buffer","../../Renderer/BufferUsage","../../Renderer/DrawCommand","../../Renderer/Pass","../../Renderer/RenderState","../../Renderer/VertexArray","../../Renderer/ShaderProgram","../../Renderer/Texture","../../Scene/BlendingState","../../Scene/ClippingPlaneCollection","../../Scene/CullFace","../../Scene/Material","../../Scene/ShadowMode","../../Scene/StencilConstants","../../Shaders/PageLODNodeFS","../../Shaders/PageLODNodeVS","../../ThirdParty/when","./PGUtility","./PGELoadStatus","./PGERangeMode","./PGNodeMaterial","./PGMath","../../Core/TaskProcessor"],function(e,t,r,a,s,i,n,o,u,h,d,l,c,p,g,m,f,L,D,_,y,O,v,S,x,b,P,T,C,A,M,R,B,w,N,G,U,E,I,F,V,z,k,H,j,q,W,Z){"use strict";function K(t,r,a,s){this.type="PageLODNode",this.children=[],this.childRanges=[],this.pageLOD=null,this.parent=null,this.root=null,this.strDataPath="",this.bNormalRendered=!1,this.bInFrustumTestOk=!1,this.bdSphere=new e,this.btLoadStatus=H.PG_UNLOAD,this.enRangeMode=0,this.lastAccessFrame=0,this.lastAccessTime=0,this.bHasGeometry=!1,this.arryMaterials=[],this.arryMaterialUsed=[],this.dataBuffer=null,this.distToEyeSquare=0,this.dMemUsed=0,this.frameState=void 0,this._nodeCommands=[],this._distanceToCamera=0,this._bRGB=!0}function Y(e,t){return function(){for(var a=n(e.parent)?e.parent:e,s=a.bdSphere;s.radius<=0&&n(a.parent);)s=a.parent.bdSphere,a=a.parent;return r.distanceSquared(g.multiplyByPoint(e.pageLOD.getLocalViewMatrix(),s.center,new r),t.camera.positionWC)}}function J(){if(!n(te)&&!re){var e=window.indexedDB.open("ModelCacheDB");e.onerror=function(e){console.log(e.currentTarget.error.message)},e.onsuccess=function(e){te=e.target.result},e.onupgradeneeded=function(e){var t=e.target.result;t.objectStoreNames.contains("PageLODStore")||t.createObjectStore("PageLODStore",{keyPath:"url"})},re=!0}return te}function X(e,t,r){var a=new _({url:e.pageLOD.url}),s=a.queryParameters?a.queryParameters.serviceName:"",i=e.strDataPath,o=new f({throttle:!0,throttleByServer:!0,type:D.OTHER,priorityFunction:Y(e,t)});i&&(i=i.replace(".lob","."+e.pageLOD.pageType));var u=new _({url:i,templateValues:{s:e.pageLOD._subdomains[Math.trunc(Math.random()*e.pageLOD._subdomains.length)]},request:o,queryParameters:{serviceName:s,uuid:e.pageLOD._uuid}}).fetchArrayBuffer();n(u)?z(u,function(t){(e.dataBuffer=t,e.setLoadStatus(H.PG_NET_LOADED),r)&&(J().transaction(["PageLODStore"],"readwrite").objectStore("PageLODStore").add({url:i,data:t}).onerror=function(e){console.log(e.currentTarget.error.message)})},function(){if(o.state===L.CANCELLED)return e.dataBuffer=void 0,void e.setLoadStatus(H.PG_UNLOAD);(e.setLoadStatus(H.PG_FAILED),r)&&(J().transaction(["PageLODStore"],"readwrite").objectStore("PageLODStore").add({url:i,data:null}).onerror=function(e){console.log(e.currentTarget.error.message)})}):e.setLoadStatus(H.PG_UNLOAD)}function Q(e,t){return 0===t._distanceToCamera&&0===e._distanceToCamera?0:e._distanceToCamera-t._distanceToCamera}var $=function(e){return function(){return e.modelView}};o(K.prototype,{boundingSphere:{get:function(){return this.bdSphere}},nodeCommands:{get:function(){return this._nodeCommands}}});var ee=new Z("parserLob");K.prototype.setInFrustumTestOk=function(e){this.bInFrustumTestOk=e},K.prototype.isInFrustumTestOk=function(){return this.bInFrustumTestOk},K.prototype.setLoadStatus=function(e){this.btLoadStatus=e},K.prototype.hasGeometry=function(){return this.bHasGeometry},K.prototype.setHasGeometry=function(e){this.bHasGeometry=e},K.prototype.getLoadStatus=function(){return this.btLoadStatus},K.prototype.setLastAccessTime=function(e){this.lastAccessTime=e},K.prototype.getLastAccessTime=function(){return this.lastAccessTime},K.prototype.setLastAccessFrame=function(e){this.lastAccessFrame=e},K.prototype.getLastAccessFrame=function(){return this.lastAccessFrame},K.prototype.addNode=function(e){this.children.push(e),e.pageLOD=this.pageLOD,e.root=this.root,e.parent=this,e._bRGB=this._bRGB,e.frameState=this.frameState},K.prototype.loadTexture=function(e,t,r){if(e.status=H.PG_LOADING,n(e.imgBlob)){var a={};a.arrayBufferView=x.createArrayBufferView(x.BYTE,e.imgBlob,0,e.imgBlob.length),e.texture=new B({context:this.frameState.context,width:e.width,height:e.height,source:a,pixelFormat:e.pixelFormat}),this.pageLOD._texturesByteLength+=e.texture.sizeInBytes,e.imgBlob=null,e.status=H.PG_LOADED}else{var s=new f({throttle:!0,throttleByServer:!0,type:D.OTHER,priorityFunction:Y(this,this._frameState)}),i=new _({url:e.imgUrl,templateValues:{s:this.pageLOD._subdomains[Math.trunc(Math.random()*this.pageLOD._subdomains.length)]},request:s}).fetchImage();if(n(i)){var o=this;z(i,function(t){window.URL.revokeObjectURL(t.src),e.texture=new B({context:o.frameState.context,width:t.width,height:t.height,source:t}),o.pageLOD._texturesByteLength+=e.texture.sizeInBytes,e.bImgBlobUrl&&window.URL.revokeObjectURL(e.imgUrl),e.imgUrl="",e.status=H.PG_LOADED},function(){return s.state===L.CANCELLED?void(e.status=H.PG_UNLOAD):(e.bImgBlobUrl&&window.URL.revokeObjectURL(e.imgUrl),void(e.status=H.PG_FAILED))})}else e.status=H.PG_UNLOAD}};var te=void 0,re=!1;return K.prototype.netLoad=function(e){this.setLoadStatus(H.PG_NET_LOADING);var t=this.strDataPath,r=this,a=this.pageLOD.useStorage&&n(J());if(a){var s=J().transaction(["PageLODStore"]).objectStore("PageLODStore").get(t);s.onerror=function(e){console.log(e.currentTarget.error.message)},s.onsuccess=function(t){var s=t.target.result;n(s)?n(s.data)?(r.dataBuffer=s.data,r.setLoadStatus(H.PG_NET_LOADED)):r.setLoadStatus(H.PG_FAILED):X(r,e,a)}}else X(r,e,a)},K.prototype.load=function(e){if(e.curNodeParseThreadNum>e.maxNodeParseThreadNum)d()-e._lastNodeParseTime>5e3&&(e.curNodeParseThreadNum=0);else if(e._lastNodeParseTime=d(),null!=this.dataBuffer){var t=this.strDataPath.substring(this.strDataPath.lastIndexOf("."),this.strDataPath.length).toLowerCase(),r=!1;(".lobz"==t||this.pageLOD._compress)&&(r=!0),".lobz"!=t&&"BGR"==this.pageLOD._pixelFormat&&(this._bRGB=!1);var a=ee.scheduleTask({dataBuffer:this.dataBuffer,isLobz:r});if(n(a)){this.setLoadStatus(H.PG_LOADING);var i=this;return i.frameState=e,e.curNodeParseThreadNum++,z(a,function(e){var t=e.data;if(null!=t&&void 0!=t){var r,a=i.strDataPath;r=a.substr(0,a.lastIndexOf("/")+1);for(var o=t.arryMaterials.length,u=0;u<o;u++){var h=t.arryMaterials[u],d=new q;""!=h.imgUrl?h.bUrl?d.imgUrl=r+h.imgUrl:d.imgUrl=h.imgUrl:null!=h.imgBlob&&("compressed"==h.eftype?(d.imgBlob=h.imgBlob,d.width=h.width,d.height=h.height,d.pixelFormat=h.pixelFormat,d.imgUrl="compressed"):(d.imgUrl=window.URL.createObjectURL(h.imgBlob),h.imgBlob=null,d.bImgBlobUrl=!0)),d.color=new s(h.diffuseR,h.diffuseG,h.diffuseB),""==d.imgUrl&&(d.status=H.PG_LOADED),i.arryMaterials.push(d)}if(i.parse(t,i.arryMaterials,r),!n(i.parent)&&i.bdSphere.radius<=0)for(o=i.children.length,u=0;u<o;u++){var l=i.children[u];W.expandSphere(i.bdSphere,l.bdSphere)}}t=null,e.data=null,i.dataBuffer=null,i.setLoadStatus(H.PG_LOADED),i.frameState.curNodeParseThreadNum--})}}else this.setLoadStatus(H.PG_LOADED)},K.prototype.parse=function(a,s,i){if(null!=a&&void 0!==a){var o=0,u=a.children.length;for(o=0;o<u;o++){var h=new K;this.addNode(h),h.parse(a.children[o],s,i)}if(this.enRangeMode=a.enRangeMode,a.childRanges.length>0)for(u=a.childRanges.length/2,o=0;o<u;o++){var d=new t;d.x=a.childRanges[2*o],d.y=a.childRanges[2*o+1],this.childRanges.push(d)}if(""==this.strDataPath&&""!=a.strDataPath&&(this.strDataPath=i+a.strDataPath),a.bdSphere.length>0){var l=new r(a.bdSphere[0],a.bdSphere[1],a.bdSphere[2]);if(n(this.pageLOD._srs)&&a.bdSphere[3]>0){l.x+=this.pageLOD._metaOrg[0],l.y+=this.pageLOD._metaOrg[1],l.z+=this.pageLOD._metaOrg[2];var c=this.pageLOD._srs.inverse([l.x,l.y]),p=r.fromDegrees(c[0],c[1],l.z),m=g.inverse(this.pageLOD.m_matLocal,new g);g.multiplyByPoint(m,p,l)}this.bdSphere=new e(l,a.bdSphere[3]),W.expandSphere(this.pageLOD._boundingSphere,this.bdSphere)}this.dMemUsed=0;for(var f=a.nodeMeshes.length,L=g.inverse(this.pageLOD.m_matLocal,new g),D=new e,_=new r,y=new r,O=0;O<f;O++){var v=a.nodeMeshes[O],S=v.verts.length;for(o=0;o<S;o+=3){if((c=new r).x=v.verts[o],c.y=v.verts[o+1],c.z=v.verts[o+2],n(this.pageLOD._srs)){c.x+=this.pageLOD._metaOrg[0],c.y+=this.pageLOD._metaOrg[1],c.z+=this.pageLOD._metaOrg[2];var x=this.pageLOD._srs.inverse([c.x,c.y]);p=r.fromDegrees(x[0],x[1],c.z);g.multiplyByPoint(L,p,c)}0==o&&(c.clone(_),c.clone(y)),_.x>c.x&&(_.x=c.x),_.y>c.y&&(_.y=c.y),_.z>c.z&&(_.z=c.z),y.x<c.x&&(y.x=c.x),y.y<c.y&&(y.y=c.y),y.z<c.z&&(y.z=c.z),v.verts[o]=c.x,v.verts[o+1]=c.y,v.verts[o+2]=c.z}var b=new r(.5*(_.x+y.x),.5*(_.y+y.y),.5*(_.z+y.z)),P=.5*r.distance(_,y),T=new e(b,P),C=this.createCommand(v,s,T);C.mesh=v,this.nodeCommands.push(C),W.expandSphere(D,T)}for(var A=this;""==A.strDataPath&&n(A.parent);)A=A.parent;n(A)&&""!=A.strDataPath&&W.expandSphere(A.bdSphere,D),W.expandSphere(this.pageLOD._boundingSphere,A.bdSphere),a.nodeMeshes=null,this.pageLOD._geometryByteLength+=this.dMemUsed,""==this.strDataPath&&(this.btLoadStatus=H.PG_LOADED)}},K.prototype.createCommand=function(t,r,s){var i,o=this.frameState.context,u=this.createVertexArray(t,r),h=(this.pageLOD.getModelViewMatrix(),this.pageLOD.getLocalViewMatrix());i=e.transform(s,h,i);var d=R.fromCache({context:o,vertexShaderSource:V,fragmentShaderSource:F}),l=A.fromCache({depthTest:{enabled:!0},cull:{enabled:!0,face:G.BACK},blending:w.PRE_MULTIPLIED_ALPHA_BLEND,stencilTest:I.setPGEarth3DTileBit(),stencilMask:I.PGEARTH_3D_TILE_MASK}),c=E.castShadows(this.pageLOD.shadows),p=E.receiveShadows(this.pageLOD.shadows),g=r[t.matIndex],m=this,f={u_texture:function(){return void 0==g.texture?m.pageLOD._defautTexture:g.texture},u_bgColor:function(){return g.color},u_polygonTexture:function(){return void 0==m.pageLOD._polygonDepth?m.pageLOD._defautTexture:m.pageLOD._polygonDepth._colorTexture},u_polygonBounds:function(){return m.pageLOD._flattenBounds},u_bFlatten:function(){return void 0!=m.pageLOD._polygonDepth},u_useClip:function(){for(var e=m.pageLOD._clipPolygons.length,t=0;t<e;++t){var r=m.pageLOD._clipPolygons[t];if(!n(r.show)||r.show)return!0}return!1},u_clipTexture:function(){return n(m.pageLOD._clipFramebuffer)?m.pageLOD._clipFramebuffer.getColorTexture(0):m.pageLOD._defautTexture},u_clipBounds:function(){return n(m.pageLOD._clipBounds)?m.pageLOD._clipBounds:a.ZERO},u_usePit:function(){return m.pageLOD._pitPolygons.length>0},u_pitTexture:function(){return n(m.pageLOD._pitFramebuffer)?m.pageLOD._pitFramebuffer.getColorTexture(0):m.pageLOD._defautTexture},u_pitBounds:function(){return n(m.pageLOD._pitBounds)?m.pageLOD._pitBounds:a.ZERO},u_useColorTable:function(){return n(m.pageLOD._colorTexture)},u_colorTexture:function(){return n(m.pageLOD._colorTexture)?m.pageLOD._colorTexture:m.pageLOD._defautTexture},u_colorRange:function(){return m.pageLOD._colorRange},u_displayMode:function(){return m.pageLOD._displayMode},u_transparency:function(){return m.pageLOD._transparency},u_bRGB:function(){return m._bRGB},u_useOverlay:function(){return n(m.pageLOD._overlayImageLayer)&&m.pageLOD._overlayImageLayer.show},u_overlayBounds:function(){return n(m.pageLOD._overlayBounds)?m.pageLOD._overlayBounds:a.ZERO},u_overlayTexture:function(){return n(m.pageLOD._overlayFramebuffer)?m.pageLOD._overlayFramebuffer.getColorTexture(0):m.pageLOD._defautTexture},u_useClippingPlane:function(){return m.pageLOD._clippingPlanes.length>0},u_clippingPlanes:function(){return m.pageLOD._packedClippingPlanes}};return f.u_modelViewMatrix=$(o.uniformState),new T({boundingVolume:i,modelMatrix:h,primitiveType:v.TRIANGLES,vertexArray:u,shaderProgram:d,castShadows:c,receiveShadows:p,uniformMap:f,renderState:l,pass:C.PGEARTH_3D_TILE})},K.prototype.createVertexArray=function(e,t){var r,a=this.frameState.context,s=[];if(null!=e.verts&&e.matIndex>=0&&e.matIndex<t.length){if(null!=e.indices){var i=e.indices;n(i)&&(r=b.createIndexBuffer({context:a,typedArray:new Uint32Array(i),usage:P.STATIC_DRAW,indexDatatype:S.UNSIGNED_INT})),this.dMemUsed+=2*e.indices.length}var o=x.FLOAT,u=b.createVertexBuffer({context:a,typedArray:x.createTypedArray(o,e.verts),usage:P.STATIC_DRAW});this.dMemUsed+=4*e.verts.length,s.push({index:0,vertexBuffer:u,componentDatatype:o,componentsPerAttribute:3,normalize:!1});for(var h=e.uvs.length,d=0;d<h;d++)if(null!=e.uvs[d]&&void 0!=e.uvs[d]){u=b.createVertexBuffer({context:a,typedArray:x.createTypedArray(o,e.uvs[d]),usage:P.STATIC_DRAW});s.push({index:1,vertexBuffer:u,componentDatatype:o,componentsPerAttribute:2,normalize:!1}),this.dMemUsed+=4*e.uvs[d].length}var l=t[e.matIndex];this.arryMaterialUsed.push(l),this.setHasGeometry(!0),this.pageLOD.addNodeCount(1)}return new M({context:a,attributes:s,indexBuffer:r})},K.prototype.distanceToCamera=function(e,t){return Math.max(0,r.distance(e.center,t.camera.positionWC)-e.radius)},K.prototype.checkInFrustum=function(t){if(this.setInFrustumTestOk(!1),this.bdSphere.radius>0){var r,a=this.pageLOD.getLocalViewMatrix();if(r=e.transform(this.bdSphere,a,r),this._distanceToCamera=this.distanceToCamera(r,t),t.cullingVolume.computeVisibility(r)==l.OUTSIDE)return!1}return this.setInFrustumTestOk(!0),!0},K.prototype.isGrandchildrenSafeDel=function(){if(this.getLoadStatus()!=H.PG_UNLOAD&&this.getLoadStatus()!=H.PG_NET_LOADED&&this.getLoadStatus()!=H.PG_LOADED)return!1;if(this.hasLoadingMaterial())return!1;for(var e=0,t=this.children.length;e<t;e++)if(!this.children[e].isGrandchildrenSafeDel())return!1;return!0},K.prototype.isAllMaterialLoaded=function(){for(var e=0,t=this.arryMaterialUsed.length;e<t;e++)if(this.arryMaterialUsed[e].status!=H.PG_LOADED)return!1;return!0},K.prototype.hasLoadingMaterial=function(){for(var e=0,t=this.arryMaterialUsed.length;e<t;e++)if(this.arryMaterialUsed[e].status!=H.PG_UNLOAD&&this.arryMaterialUsed[e].status!=H.PG_LOADED)return!0;return!1},K.prototype.calcNodeCount=function(){var e=0;this.hasGeometry()&&(e+=1);for(var t=0,r=this.children.length;t<r;t++)e+=this.children[t].calcNodeCount();return e},K.prototype.unloadChildren=function(){var e=0,t=this.children.length;for(e=0;e<t;e++)this.children[e].unloadChildren();for(this.children.splice(0,t),this.childRanges.splice(0,this.childRanges.length),this.arryMaterialUsed.splice(0,this.arryMaterialUsed.length);this.arryMaterials.length>0;){var r=this.arryMaterials.pop();if(null!=r&&void 0!=r.texture){var a=r.texture;null!=a&&void 0!=a&&(this.pageLOD._texturesByteLength-=a.sizeInBytes,a.destroy()),r.texture=null}}for(var s=this._nodeCommands.length-1;s>=0;s--){var i=this._nodeCommands[s];i.vertexArray=i.vertexArray&&i.vertexArray.destroy(),i.shaderProgram=i.shaderProgram&&i.shaderProgram.destroy()}this._nodeCommands=[],this.pageLOD._geometryByteLength-=this.dMemUsed,this.dMemUsed=0,this.bHasGeometry=!1,this.dataBuffer=null,this.setLoadStatus(H.PG_UNLOAD)},K.prototype.checkAllGroupChildLoaded=function(e){for(var t=0,r=this.children.length;t<r;t++){var a=this.children[t];if(null!=a&&a.checkInFrustum(e)&&a.children.length>1){a.setInFrustumTestOk(!0);var s=a.children[0];if(s&&""==s.strDataPath&&!s.isAllMaterialLoaded()){for(var i=s.arryMaterialUsed.length,n=0;n<i;n++){var o=s.arryMaterialUsed[n];o.status==H.PG_UNLOAD&&s.loadTexture(o,this.pageLOD)}return!1}}}return!0},K.prototype.updateBoundingVolume=function(){if(null!=this&&void 0!==this){var t=0,r=this.children.length;for(t=0;t<r;t++)this.children[t].updateBoundingVolume();var a=this.isAllMaterialLoaded();for(r=this.nodeCommands.length,t=0;t<r;t++){var s=this.nodeCommands[t];if(void 0!=s&&a){for(var i=n(this.parent)?this.parent:this,o=i.bdSphere;o.radius<0&&n(i.parent);)o=i.parent.bdSphere,i=i.parent;var u,h=this.pageLOD.getLocalViewMatrix();u=e.transform(o,h,u),s._boundingVolume=u}}}},K.prototype.update=function(e){this.frameState=e;var t=e.camera;if(this.bNormalRendered=!1,!this.checkInFrustum(e))return!1;if(this.setLastAccessTime(this.pageLOD.getLastAccessTime()),this.setLastAccessFrame(this.pageLOD.getLastAccessFrame()),""!=this.strDataPath&&(this.getLoadStatus()==H.PG_UNLOAD&&this.netLoad(e),this.getLoadStatus()==H.PG_NET_LOADED&&this.load(e),this.getLoadStatus()!=H.PG_LOADED))return this.pageLOD.curLoadingNode++,!1;this._timeSinceLoad=Math.max(1e3*c.secondsDifference(c.now(),this.pageLOD._loadTimestamp),0),this._timeSinceLoad;var r=0;this.childRanges.length>0&&(this.enRangeMode==j.RM_DISTANCE_FROM_EYE_POINT?this.bdSphere.radius>0&&(r=W.computeDistFromEye(this.bdSphere.center,this.pageLOD.getModelViewMatrix())):this.enRangeMode==j.RM_PIXEL_SIZE_ON_SCREEN&&this.bdSphere.radius>0&&(r=.5*W.computeSpherePixelSize(this.bdSphere,this.pageLOD.getPixelSizeVector())));var a=this.checkAllGroupChildLoaded(e),s=this.children.length;if(this.children.sort(Q),this.childRanges.length>0){for(var i=0;i<s;i++){var n=this.children[i];if(i<this.childRanges.length){var o=this.childRanges[i];n&&r>=o.x&&r<o.y&&n.update(e)&&(this.bNormalRendered=!0)}else n&&n.update(t)&&(this.bNormalRendered=!0)}!this.bNormalRendered&&s>0&&((n=this.children[0])&&n.update(e)&&(this.bNormalRendered=!0))}else for(i=0;i<s;i++){(n=this.children[i])&&a&&n.update(e)&&(this.bNormalRendered=!0)}var u=!1,h=this.isAllMaterialLoaded();if(!this.bNormalRendered)for(s=this.arryMaterialUsed.length,i=0;i<s;i++){var d=this.arryMaterialUsed[i];d.status==H.PG_UNLOAD&&this.loadTexture(d,this.pageLOD)}for(e.context,this.arryMaterialUsed.length,s=this.nodeCommands.length,i=0;i<s;i++){var l=this.nodeCommands[i];void 0!=l&&(l.mesh.boundingVolume=l._boundingVolume,this.pageLOD.NodeMesh.push(l.mesh),h&&(this.pageLOD._transparency<1?l.pass=C.TRANSLUCENT:l.pass=C.PGEARTH_3D_TILE,this.frameState.commandList.push(l),u=!0))}return u?(this.bNormalRendered=!0,!0):this.bNormalRendered},K});