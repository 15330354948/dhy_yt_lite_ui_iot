define(["../Core/arraySlice","../Core/BoundingSphere","../Core/Cartesian3","../Core/Color","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/Matrix4","../Core/TaskProcessor","../ThirdParty/when","./ClassificationType","./Vector3DTileBatch","./Vector3DTilePrimitive"],function(e,i,t,s,r,o,d,n,a,c,h,_,p,l){"use strict";function f(e){this._boxes=e.boxes,this._boxBatchIds=e.boxBatchIds,this._cylinders=e.cylinders,this._cylinderBatchIds=e.cylinderBatchIds,this._ellipsoids=e.ellipsoids,this._ellipsoidBatchIds=e.ellipsoidBatchIds,this._spheres=e.spheres,this._sphereBatchIds=e.sphereBatchIds,this._modelMatrix=e.modelMatrix,this._batchTable=e.batchTable,this._boundingVolume=e.boundingVolume,this._center=e.center,o(this._center)||(o(this._boundingVolume)?this._center=t.clone(this._boundingVolume.center):this._center=t.clone(t.ZERO)),this._boundingVolumes=void 0,this._batchedIndices=void 0,this._indices=void 0,this._indexOffsets=void 0,this._indexCounts=void 0,this._positions=void 0,this._vertexBatchIds=void 0,this._batchIds=void 0,this._batchTableColors=void 0,this._packedBuffer=void 0,this._ready=!1,this._readyPromise=h.defer(),this._verticesPromise=void 0,this._primitive=void 0,this.debugWireframe=!1,this.forceRebatch=!1,this.classificationType=_.BOTH}d(f.prototype,{trianglesLength:{get:function(){return o(this._primitive)?this._primitive.trianglesLength:0}},geometryByteLength:{get:function(){return o(this._primitive)?this._primitive.geometryByteLength:0}},readyPromise:{get:function(){return this._readyPromise.promise}}}),f.packedBoxLength=a.packedLength+t.packedLength,f.packedCylinderLength=a.packedLength+2,f.packedEllipsoidLength=a.packedLength+t.packedLength,f.packedSphereLength=t.packedLength+1;var u=new c("createVectorTileGeometries"),b=new s;function v(d){if(!o(d._primitive)){if(!o(d._verticesPromise)){var n=d._boxes,c=d._boxBatchIds,h=d._cylinders,_=d._cylinderBatchIds,f=d._ellipsoids,v=d._ellipsoidBatchIds,y=d._spheres,m=d._sphereBatchIds,g=d._batchTableColors,B=d._packedBuffer;if(!o(g)){var I=0;o(d._boxes)&&(n=d._boxes=e(n),I+=(c=d._boxBatchIds=e(c)).length),o(d._cylinders)&&(h=d._cylinders=e(h),I+=(_=d._cylinderBatchIds=e(_)).length),o(d._ellipsoids)&&(f=d._ellipsoids=e(f),I+=(v=d._ellipsoidBatchIds=e(v)).length),o(d._spheres)&&(y=d._sphere=e(y),I+=(m=d._sphereBatchIds=e(m)).length),g=d._batchTableColors=new Uint32Array(I);for(var x=d._batchTable,k=0;k<I;++k){var C=x.getColor(k,b);g[k]=C.toRgba()}B=d._packedBuffer=function(e){var i=new Float64Array(a.packedLength+t.packedLength),s=0;return t.pack(e._center,i,s),s+=t.packedLength,a.pack(e._modelMatrix,i,s),i}(d)}var T=[];o(n)&&T.push(n.buffer,c.buffer),o(h)&&T.push(h.buffer,_.buffer),o(f)&&T.push(f.buffer,v.buffer),o(y)&&T.push(y.buffer,m.buffer),T.push(g.buffer,B.buffer);var L={boxes:o(n)?n.buffer:void 0,boxBatchIds:o(n)?c.buffer:void 0,cylinders:o(h)?h.buffer:void 0,cylinderBatchIds:o(h)?_.buffer:void 0,ellipsoids:o(f)?f.buffer:void 0,ellipsoidBatchIds:o(f)?v.buffer:void 0,spheres:o(y)?y.buffer:void 0,sphereBatchIds:o(y)?m.buffer:void 0,batchTableColors:g.buffer,packedBuffer:B.buffer},w=d._verticesPromise=u.scheduleTask(L,T);if(!o(w))return;w.then(function(e){var t=new Float64Array(e.packedBuffer),r=function(e,t){for(var r=0,o=t[r++],d=t[r++],n=e._boundingVolumes=new Array(d),a=0;a<d;++a)n[a]=i.unpack(t,r),r+=i.packedLength;for(var c=t[r++],h=e._batchedIndices=new Array(c),_=0;_<c;++_){var l=s.unpack(t,r);r+=s.packedLength;for(var f=t[r++],u=t[r++],b=t[r++],v=new Array(b),y=0;y<b;++y)v[y]=t[r++];h[_]=new p({color:l,offset:f,count:u,batchIds:v})}return o}(d,t);d._indices=2===r?new Uint16Array(e.indices):new Uint32Array(e.indices),d._indexOffsets=new Uint32Array(e.indexOffsets),d._indexCounts=new Uint32Array(e.indexCounts),d._positions=new Float32Array(e.positions),d._vertexBatchIds=new Uint16Array(e.vertexBatchIds),d._batchIds=new Uint16Array(e.batchIds),d._ready=!0})}d._ready&&!o(d._primitive)&&(d._primitive=new l({batchTable:d._batchTable,positions:d._positions,batchIds:d._batchIds,vertexBatchIds:d._vertexBatchIds,indices:d._indices,indexOffsets:d._indexOffsets,indexCounts:d._indexCounts,batchedIndices:d._batchedIndices,boundingVolume:d._boundingVolume,boundingVolumes:d._boundingVolumes,center:d._center,pickObject:r(d._pickObject,d)}),d._boxes=void 0,d._boxBatchIds=void 0,d._cylinders=void 0,d._cylinderBatchIds=void 0,d._ellipsoids=void 0,d._ellipsoidBatchIds=void 0,d._spheres=void 0,d._sphereBatchIds=void 0,d._center=void 0,d._modelMatrix=void 0,d._batchTable=void 0,d._boundingVolume=void 0,d._boundingVolumes=void 0,d._batchedIndices=void 0,d._indices=void 0,d._indexOffsets=void 0,d._indexCounts=void 0,d._positions=void 0,d._vertexBatchIds=void 0,d._batchIds=void 0,d._batchTableColors=void 0,d._packedBuffer=void 0,d._verticesPromise=void 0,d._readyPromise.resolve())}}return f.prototype.createFeatures=function(e,i){this._primitive.createFeatures(e,i)},f.prototype.applyDebugSettings=function(e,i){this._primitive.applyDebugSettings(e,i)},f.prototype.applyStyle=function(e,i){this._primitive.applyStyle(e,i)},f.prototype.updateCommands=function(e,i){this._primitive.updateCommands(e,i)},f.prototype.update=function(e){v(this),this._ready&&(this._primitive.debugWireframe=this.debugWireframe,this._primitive.forceRebatch=this.forceRebatch,this._primitive.classificationType=this.classificationType,this._primitive.update(e))},f.prototype.isDestroyed=function(){return!1},f.prototype.destroy=function(){return this._primitive=this._primitive&&this._primitive.destroy(),n(this)},f});