define(["./ApproximateTerrainHeights","./ArcType","./arrayRemoveDuplicates","./BoundingSphere","./Cartesian3","./Cartographic","./Check","./ComponentDatatype","./DeveloperError","./Math","./defaultValue","./defined","./defineProperties","./Ellipsoid","./EllipsoidGeodesic","./EllipsoidRhumbLine","./EncodedCartesian3","./GeographicProjection","./Geometry","./GeometryAttribute","./IntersectionTests","./Matrix3","./Plane","./Quaternion","./Rectangle","./WebMercatorProjection"],function(e,a,n,r,t,i,o,l,s,c,p,u,d,h,w,g,f,v,y,m,E,I,O,k,T,P){"use strict";var S=[v,P],N=S.length,_=Math.cos(c.toRadians(30)),A=Math.cos(c.toRadians(150)),L=0,C=1e3;function D(e){var n=(e=p(e,p.EMPTY_OBJECT)).positions;if(!u(n)||n.length<2)throw new s("At least two positions are required.");if(u(e.arcType)&&e.arcType!==a.GEODESIC&&e.arcType!==a.RHUMB)throw new s("Valid options for arcType are ArcType.GEODESIC and ArcType.RHUMB.");this.width=p(e.width,1),this._positions=n,this.granularity=p(e.granularity,9999),this.loop=p(e.loop,!1),this.arcType=p(e.arcType,a.GEODESIC),this._ellipsoid=h.WGS84,this._projectionIndex=0,this._workerName="createGroundPolylineGeometry",this._scene3DOnly=!1}d(D.prototype,{packedLength:{get:function(){return 1+3*this._positions.length+1+1+1+h.packedLength+1+1}}}),D.setProjectionAndEllipsoid=function(e,a){for(var n=0,r=0;r<N;r++)if(a instanceof S[r]){n=r;break}e._projectionIndex=n,e._ellipsoid=a.ellipsoid};var b=new t,z=new t,x=new t;function M(e,a,n,r,i){var o=U(r,e,0,b),l=U(r,e,n,z),s=U(r,a,0,x),c=H(l,o,z),p=H(s,o,x);return t.cross(p,c,i),t.normalize(i,i)}var F=new i,R=new t,B=new t,j=new t;function q(e,n,r,i,o,l,s,c,p,u,d){if(0!==o){var h;l===a.GEODESIC?h=new w(e,n,s):l===a.RHUMB&&(h=new g(e,n,s));var f=h.surfaceDistance;if(!(f<o))for(var v=M(e,n,i,s,j),y=Math.ceil(f/o),m=f/y,E=m,I=y-1,O=c.length,k=0;k<I;k++){var T=h.interpolateUsingSurfaceDistance(E,F),P=U(s,T,r,R),S=U(s,T,i,B);t.pack(v,c,O),t.pack(P,p,O),t.pack(S,u,O),d.push(T.latitude),d.push(T.longitude),O+=3,E+=m}}}var G=new i;function U(e,a,n,r){return i.clone(a,G),G.height=n,i.toCartesian(G,e,r)}function H(e,a,n){return t.subtract(e,a,n),t.normalize(n,n),n}D.pack=function(e,a,n){o.typeOf.object("value",e),o.defined("array",a);var r=p(n,0),i=e._positions,l=i.length;a[r++]=l;for(var s=0;s<l;++s){var c=i[s];t.pack(c,a,r),r+=3}return a[r++]=e.granularity,a[r++]=e.loop?1:0,a[r++]=e.arcType,h.pack(e._ellipsoid,a,r),r+=h.packedLength,a[r++]=e._projectionIndex,a[r++]=e._scene3DOnly?1:0,a},D.unpack=function(e,a,n){o.defined("array",e);for(var r=p(a,0),i=e[r++],l=new Array(i),s=0;s<i;s++)l[s]=t.unpack(e,r),r+=3;var c=e[r++],d=1===e[r++],w=e[r++],g=h.unpack(e,r);r+=h.packedLength;var f=e[r++],v=1===e[r++];return u(n)||(n=new D({positions:l})),n._positions=l,n.granularity=c,n.loop=d,n.arcType=w,n._ellipsoid=g,n._projectionIndex=f,n._scene3DOnly=v,n};var V=new t,W=new t,Y=new t,Z=new t,X=new O(t.UNIT_X,0),Q=new t,J=0;function K(e,a,n,r,i){var o=H(n,a,Q),l=H(e,a,V),s=H(r,a,W),p=t.cross(o,l,Z);p=t.normalize(p,p);var u=O.fromPointNormal(a,p,X),d=O.getPointDistance(u,r);if(c.equalsEpsilon(d,0,c.EPSILON7))return t.clone(p,i),i;i=t.add(s,l,i),i=t.normalize(i,i);var h=t.cross(o,i,Y);return t.normalize(h,h),t.cross(h,o,i),t.normalize(i,i),t.dot(s,h)<J&&(i=t.negate(i,i)),i}var $=O.fromPointNormal(t.ZERO,t.UNIT_Y),ee=new t,ae=new t,ne=new t,re=new t,te=new t,ie=new t,oe=new i,le=new i,se=new i;D.createGeometry=function(o){var s,p,d,h,w,v,I=!o._scene3DOnly,O=o.loop,k=o._ellipsoid,P=o.granularity,N=o.arcType,A=new S[o._projectionIndex](k),D=L,b=C,z=o._positions,x=z.length;2===x&&(O=!1);var F,R,B,j=new g(void 0,void 0,k),G=[z[0]];for(p=0;p<x-1;p++)d=z[p],h=z[p+1],F=E.lineSegmentPlane(d,h,$,ie),!u(F)||t.equalsEpsilon(F,d,c.EPSILON7)||t.equalsEpsilon(F,h,c.EPSILON7)||(o.arcType===a.GEODESIC?G.push(t.clone(F)):o.arcType===a.RHUMB&&(B=k.cartesianToCartographic(F,oe).longitude,w=k.cartesianToCartographic(d,oe),v=k.cartesianToCartographic(h,le),j.setEndPoints(w,v),R=j.findIntersectionWithLongitude(B,se),F=k.cartographicToCartesian(R,ie),!u(F)||t.equalsEpsilon(F,d,c.EPSILON7)||t.equalsEpsilon(F,h,c.EPSILON7)||G.push(t.clone(F)))),G.push(h);O&&(d=z[x-1],h=z[0],F=E.lineSegmentPlane(d,h,$,ie),!u(F)||t.equalsEpsilon(F,d,c.EPSILON7)||t.equalsEpsilon(F,h,c.EPSILON7)||(o.arcType===a.GEODESIC?G.push(t.clone(F)):o.arcType===a.RHUMB&&(B=k.cartesianToCartographic(F,oe).longitude,w=k.cartesianToCartographic(d,oe),v=k.cartesianToCartographic(h,le),j.setEndPoints(w,v),R=j.findIntersectionWithLongitude(B,se),F=k.cartographicToCartesian(R,ie),!u(F)||t.equalsEpsilon(F,d,c.EPSILON7)||t.equalsEpsilon(F,h,c.EPSILON7)||G.push(t.clone(F)))));var V=G.length,W=new Array(V);for(p=0;p<V;p++){var Y=i.fromCartesian(G[p],k);Y.height=0,W[p]=Y}if(!((V=(W=n(W,i.equalsEpsilon)).length)<2)){var Z=[],X=[],Q=[],J=[],ce=ee,pe=ae,ue=ne,he=re,we=te,ge=W[0],ve=W[1];for(ce=U(k,W[V-1],D,ce),he=U(k,ve,D,he),pe=U(k,ge,D,pe),ue=U(k,ge,b,ue),we=O?K(ce,pe,ue,he,we):M(ge,ve,b,k,we),t.pack(we,X,0),t.pack(pe,Q,0),t.pack(ue,J,0),Z.push(ge.latitude),Z.push(ge.longitude),q(ge,ve,D,b,P,N,k,X,Q,J,Z),p=1;p<V-1;++p){ce=t.clone(pe,ce),pe=t.clone(he,pe);var ye=W[p];U(k,ye,b,ue),U(k,W[p+1],D,he),K(ce,pe,ue,he,we),s=X.length,t.pack(we,X,s),t.pack(pe,Q,s),t.pack(ue,J,s),Z.push(ye.latitude),Z.push(ye.longitude),q(W[p],W[p+1],D,b,P,N,k,X,Q,J,Z)}var Ee=W[V-1],na=W[V-2];if(pe=U(k,Ee,D,pe),ue=U(k,Ee,b,ue),O){var ra=W[0];we=K(ce=U(k,na,D,ce),pe,ue,he=U(k,ra,D,he),we)}else we=M(na,Ee,b,k,we);if(s=X.length,t.pack(we,X,s),t.pack(pe,Q,s),t.pack(ue,J,s),Z.push(Ee.latitude),Z.push(Ee.longitude),O){for(q(Ee,ge,D,b,P,N,k,X,Q,J,Z),s=X.length,p=0;p<3;++p)X[s+p]=X[p],Q[s+p]=Q[p],J[s+p]=J[p];Z.push(ge.latitude),Z.push(ge.longitude)}return function(a,n,i,o,s,p,u){var d,h,w,g,v,E,I=n._ellipsoid,O=i.length/3-1,k=8*O,P=4*k,S=36*O,N=k>65535?new Uint32Array(S):new Uint16Array(S),A=new Float64Array(3*k),L=new Float32Array(P),C=new Float32Array(P),D=new Float32Array(P),b=new Float32Array(P),z=new Float32Array(P);u&&(w=new Float32Array(P),g=new Float32Array(P),v=new Float32Array(P),E=new Float32Array(2*k));var x=p.length/2,M=0,F=ke;F.height=0;var R=Te;R.height=0;var B=Pe,j=Se;if(u)for(h=0,d=1;d<x;d++)F.latitude=p[h],F.longitude=p[h+1],R.latitude=p[h+2],R.longitude=p[h+3],B=n.project(F,B),j=n.project(R,j),M+=t.distance(B,j),h+=2;var q=o.length/3;j=t.unpack(o,0,j);var G,U=0;for(h=3,d=1;d<q;d++)B=t.clone(j,B),j=t.unpack(o,h,j),U+=t.distance(B,j),h+=3;h=3;var V=0,W=0,Y=0,Z=0,X=!1,Q=t.unpack(i,0,_e),J=t.unpack(o,0,Se),K=t.unpack(s,0,Le);if(a){var $=t.unpack(i,i.length-6,Ne);de(K,$,Q,J)&&(K=t.negate(K,K))}var ee=0,ae=0,ne=0;for(d=0;d<O;d++){var re,te,ie,oe,le=t.clone(Q,Ne),se=t.clone(J,Pe),ce=t.clone(K,Ae);if(X&&(ce=t.negate(ce,ce)),Q=t.unpack(i,h,_e),J=t.unpack(o,h,Se),K=t.unpack(s,h,Le),X=de(K,le,Q,J),F.latitude=p[V],F.longitude=p[V+1],R.latitude=p[V+2],R.longitude=p[V+3],u){var pe=Oe(F,R);re=n.project(F,Fe);var ue=H(te=n.project(R,Re),re,Xe);ue.y=Math.abs(ue.y),ie=Be,oe=je,0===pe||t.dot(ue,t.UNIT_Y)>_?(ie=fe(n,F,ce,re,Be),oe=fe(n,R,K,te,je)):1===pe?(oe=fe(n,R,K,te,je),ie.x=0,ie.y=c.sign(F.longitude-Math.abs(R.longitude)),ie.z=0):(ie=fe(n,F,ce,re,Be),oe.x=0,oe.y=c.sign(F.longitude-R.longitude),oe.z=0)}var he=t.distance(se,J),we=f.fromCartesian(le,Ye),ge=t.subtract(Q,le,qe),ve=t.normalize(ge,He),ye=t.subtract(se,le,Ge);ye=t.normalize(ye,ye);var Ee=t.cross(ve,ye,He);Ee=t.normalize(Ee,Ee);var na=t.cross(ye,ce,Ve);na=t.normalize(na,na);var ra=t.subtract(J,Q,Ue);ra=t.normalize(ra,ra);var ta=t.cross(K,ra,We);ta=t.normalize(ta,ta);var ia,oa,la,sa=he/U,ca=ee/U,pa=0,ua=0,da=0;if(u){pa=t.distance(re,te),ia=f.fromCartesian(re,Ze),oa=t.subtract(te,re,Xe);var ha=(la=t.normalize(oa,Qe)).x;la.x=la.y,la.y=-ha,ua=pa/M,da=ae/M}for(G=0;G<8;G++){var wa=Z+4*G,ga=W+2*G,fa=wa+3,va=G<4?1:-1,ya=2===G||3===G||6===G||7===G?1:-1;t.pack(we.high,L,wa),L[fa]=ge.x,t.pack(we.low,C,wa),C[fa]=ge.y,t.pack(na,D,wa),D[fa]=ge.z,t.pack(ta,b,wa),b[fa]=sa*va,t.pack(Ee,z,wa);var ma=ca*ya;0===ma&&ya<0&&(ma=Number.POSITIVE_INFINITY),z[fa]=ma,u&&(w[wa]=ia.high.x,w[wa+1]=ia.high.y,w[wa+2]=ia.low.x,w[wa+3]=ia.low.y,v[wa]=-ie.y,v[wa+1]=ie.x,v[wa+2]=oe.y,v[wa+3]=-oe.x,g[wa]=oa.x,g[wa+1]=oa.y,g[wa+2]=la.x,g[wa+3]=la.y,E[ga]=ua*va,0===(ma=da*ya)&&ya<0&&(ma=Number.POSITIVE_INFINITY),E[ga+1]=ma)}var Ea=xe,Ia=Me,Oa=be,ka=ze,Ta=T.fromCartographicArray(Ce,De),Pa=e.getMinimumMaximumHeights(Ta,I),Sa=Pa.minimumTerrainHeight,Na=Pa.maximumTerrainHeight;ne+=Sa,ne+=Na,me(le,se,Sa,Na,Ea,Oa),me(Q,J,Sa,Na,Ia,ka);var _a=t.multiplyByScalar(Ee,c.EPSILON5,Je);t.add(Ea,_a,Ea),t.add(Ia,_a,Ia),t.add(Oa,_a,Oa),t.add(ka,_a,ka),Ie(Ea,Ia),Ie(Oa,ka),t.pack(Ea,A,Y),t.pack(Ia,A,Y+3),t.pack(ka,A,Y+6),t.pack(Oa,A,Y+9),_a=t.multiplyByScalar(Ee,-2*c.EPSILON5,Je),t.add(Ea,_a,Ea),t.add(Ia,_a,Ia),t.add(Oa,_a,Oa),t.add(ka,_a,ka),Ie(Ea,Ia),Ie(Oa,ka),t.pack(Ea,A,Y+12),t.pack(Ia,A,Y+15),t.pack(ka,A,Y+18),t.pack(Oa,A,Y+21),V+=2,h+=3,W+=16,Y+=24,Z+=32,ee+=he,ae+=pa}h=0;var Aa=0;for(d=0;d<O;d++){for(G=0;G<ea;G++)N[h+G]=$e[G]+Aa;Aa+=8,h+=ea}var La=Ke;r.fromVertices(i,t.ZERO,3,La[0]),r.fromVertices(o,t.ZERO,3,La[1]);var Ca=r.fromBoundingSpheres(La);Ca.radius+=ne/(2*O);var Da={position:new m({componentDatatype:l.DOUBLE,componentsPerAttribute:3,normalize:!1,values:A}),startHiAndForwardOffsetX:aa(L),startLoAndForwardOffsetY:aa(C),startNormalAndForwardOffsetZ:aa(D),endNormalAndTextureCoordinateNormalizationX:aa(b),rightNormalAndTextureCoordinateNormalizationY:aa(z)};u&&(Da.startHiLo2D=aa(w),Da.offsetAndRight2D=aa(g),Da.startEndNormals2D=aa(v),Da.texcoordNormalization2D=new m({componentDatatype:l.FLOAT,componentsPerAttribute:2,normalize:!1,values:E}));return new y({attributes:Da,indices:N,boundingSphere:Ca})}(O,A,Q,J,X,Z,I)}};var ce=new t,pe=new I,ue=new k;function de(e,a,n,r){var i=H(n,a,ce),o=t.dot(i,e);if(o>_||o<A){var l=H(r,n,Q),s=o<A?c.PI_OVER_TWO:-c.PI_OVER_TWO,p=k.fromAxisAngle(l,s,ue),u=I.fromQuaternion(p,pe);return I.multiplyByVector(u,e,e),!0}return!1}var he=new i,we=new t,ge=new t;function fe(e,a,n,r,o){var l=i.toCartesian(a,e._ellipsoid,we),s=t.add(l,n,ge),p=!1,u=e._ellipsoid,d=u.cartesianToCartographic(s,he);Math.abs(a.longitude-d.longitude)>c.PI_OVER_TWO&&(p=!0,s=t.subtract(l,n,ge),d=u.cartesianToCartographic(s,he)),d.height=0;var h=e.project(d,o);return(o=t.subtract(h,r,o)).z=0,o=t.normalize(o,o),p&&t.negate(o,o),o}var ve=new t,ye=new t;function me(e,a,n,r,i,o){var l=t.subtract(a,e,ve);t.normalize(l,l);var s=n-L,c=t.multiplyByScalar(l,s,ye);t.add(e,c,i);var p=r-C;c=t.multiplyByScalar(l,p,ye),t.add(a,c,o)}var Ee=new t;function Ie(e,a){var n=O.getPointDistance($,e),r=O.getPointDistance($,a),i=Ee;c.equalsEpsilon(n,0,c.EPSILON2)?(i=H(a,e,i),t.multiplyByScalar(i,c.EPSILON2,i),t.add(e,i,e)):c.equalsEpsilon(r,0,c.EPSILON2)&&(i=H(e,a,i),t.multiplyByScalar(i,c.EPSILON2,i),t.add(a,i,a))}function Oe(e,a){var n=Math.abs(e.longitude),r=Math.abs(a.longitude);if(c.equalsEpsilon(n,c.PI,c.EPSILON11)){var t=c.sign(a.longitude);return e.longitude=t*(n-c.EPSILON11),1}if(c.equalsEpsilon(r,c.PI,c.EPSILON11)){var i=c.sign(e.longitude);return a.longitude=i*(r-c.EPSILON11),2}return 0}var ke=new i,Te=new i,Pe=new t,Se=new t,Ne=new t,_e=new t,Ae=new t,Le=new t,Ce=[ke,Te],De=new T,be=new t,ze=new t,xe=new t,Me=new t,Fe=new t,Re=new t,Be=new t,je=new t,qe=new t,Ge=new t,Ue=new t,He=new t,Ve=new t,We=new t,Ye=new f,Ze=new f,Xe=new t,Qe=new t,Je=new t,Ke=[new r,new r],$e=[0,2,1,0,3,2,0,7,3,0,4,7,0,5,4,0,1,5,5,7,4,5,6,7,5,2,6,5,1,2,3,6,2,3,7,6],ea=$e.length;function aa(e){return new m({componentDatatype:l.FLOAT,componentsPerAttribute:4,normalize:!1,values:e})}return D._projectNormal=fe,D});