define(["../Core/createGuid","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/Math","./Entity","./EntityCollection"],function(t,e,o,i,n,s,l){"use strict";var r={id:void 0},c=new Array(2);function h(t){for(var e=t.propertyNames,o=e.length,i=0;i<o;i++)t[e[i]]=void 0;t._name=void 0,t._availability=void 0}function d(t,e,o,i){c[0]=o,c[1]=i.id,e[JSON.stringify(c)]=i.definitionChanged.addEventListener(a.prototype._onDefinitionChanged,t)}function p(t,e,o,i){c[0]=o,c[1]=i.id;var n=JSON.stringify(c);e[n](),e[n]=void 0}function u(t){if(t._shouldRecomposite=!0,0===t._suspendCount){var o,i,n,c,u,f,_=t._collections,v=_.length,g=t._collectionsCopy,y=g.length,m=t._composite,C=new l(t),w=t._eventHash;for(o=0;o<y;o++)for((u=g[o]).collectionChanged.removeEventListener(a.prototype._onCollectionChanged,t),n=u.values,f=u.id,c=n.length-1;c>-1;c--)p(0,w,f,i=n[c]);for(o=v-1;o>=0;o--)for((u=_[o]).collectionChanged.addEventListener(a.prototype._onCollectionChanged,t),n=u.values,f=u.id,c=n.length-1;c>-1;c--){d(t,w,f,i=n[c]);var E=C.getById(i.id);e(E)||(E=m.getById(i.id),e(E)?h(E):(r.id=i.id,E=new s(r)),C.add(E)),E.merge(i)}t._collectionsCopy=_.slice(0),m.suspendEvents(),m.removeAll();var B=C.values;for(o=0;o<B.length;o++)m.add(B[o]);m.resumeEvents()}}function a(o,i){this._owner=i,this._composite=new l(this),this._suspendCount=0,this._collections=e(o)?o.slice():[],this._collectionsCopy=[],this._id=t(),this._eventHash={},u(this),this._shouldRecomposite=!1}function f(t,o){if(!e(o))throw new i("collection is required.");var n=t.indexOf(o);if(-1===n)throw new i("collection is not in this composite.");return n}function _(t,e,o){var i=t._collections;if((e=n.clamp(e,0,i.length-1))!==(o=n.clamp(o,0,i.length-1))){var s=i[e];i[e]=i[o],i[o]=s,u(t)}}return o(a.prototype,{collectionChanged:{get:function(){return this._composite._collectionChanged}},id:{get:function(){return this._id}},values:{get:function(){return this._composite.values}},owner:{get:function(){return this._owner}}}),a.prototype.addCollection=function(t,o){var n=e(o);if(!e(t))throw new i("collection is required.");if(n){if(o<0)throw new i("index must be greater than or equal to zero.");if(o>this._collections.length)throw new i("index must be less than or equal to the number of collections.")}n?this._collections.splice(o,0,t):(o=this._collections.length,this._collections.push(t)),u(this)},a.prototype.removeCollection=function(t){var e=this._collections.indexOf(t);return-1!==e&&(this._collections.splice(e,1),u(this),!0)},a.prototype.removeAllCollections=function(){this._collections.length=0,u(this)},a.prototype.containsCollection=function(t){return-1!==this._collections.indexOf(t)},a.prototype.contains=function(t){return this._composite.contains(t)},a.prototype.indexOfCollection=function(t){return this._collections.indexOf(t)},a.prototype.getCollection=function(t){if(!e(t))throw new i("index is required.","index");return this._collections[t]},a.prototype.getCollectionsLength=function(){return this._collections.length},a.prototype.raiseCollection=function(t){var e=f(this._collections,t);_(this,e,e+1)},a.prototype.lowerCollection=function(t){var e=f(this._collections,t);_(this,e,e-1)},a.prototype.raiseCollectionToTop=function(t){var e=f(this._collections,t);e!==this._collections.length-1&&(this._collections.splice(e,1),this._collections.push(t),u(this))},a.prototype.lowerCollectionToBottom=function(t){var e=f(this._collections,t);0!==e&&(this._collections.splice(e,1),this._collections.splice(0,0,t),u(this))},a.prototype.suspendEvents=function(){this._suspendCount++,this._composite.suspendEvents()},a.prototype.resumeEvents=function(){if(0===this._suspendCount)throw new i("resumeEvents can not be called before suspendEvents.");this._suspendCount--,this._shouldRecomposite&&0===this._suspendCount&&(u(this),this._shouldRecomposite=!1),this._composite.resumeEvents()},a.prototype.computeAvailability=function(){return this._composite.computeAvailability()},a.prototype.getById=function(t){return this._composite.getById(t)},a.prototype._onCollectionChanged=function(t,o,i){var n,l,c,u,a=this._collectionsCopy,f=a.length,_=this._composite;_.suspendEvents();var v=i.length,g=this._eventHash,y=t.id;for(n=0;n<v;n++){var m=i[n];p(0,g,y,m);var C=m.id;for(l=f-1;l>=0;l--)c=a[l].getById(C),e(c)&&(e(u)||h(u=_.getById(C)),u.merge(c));e(u)||_.removeById(C),u=void 0}var w=o.length;for(n=0;n<w;n++){var E=o[n];d(this,g,y,E);var B=E.id;for(l=f-1;l>=0;l--)c=a[l].getById(B),e(c)&&(e(u)||(u=_.getById(B),e(u)?h(u):(r.id=B,u=new s(r),_.add(u))),u.merge(c));u=void 0}_.resumeEvents()},a.prototype._onDefinitionChanged=function(t,o,i,n){for(var s=this._collections,l=this._composite,r=s.length,c=t.id,h=l.getById(c),d=h[o],p=!e(d),u=!0,a=r-1;a>=0;a--){var f=s[a].getById(t.id);if(e(f)){var _=f[o];if(e(_)){if(u){if(u=!1,!e(_.merge)||!e(_.clone)){d=_;break}d=_.clone(d)}d.merge(_)}}}p&&-1===h.propertyNames.indexOf(o)&&h.addProperty(o),h[o]=d},a});