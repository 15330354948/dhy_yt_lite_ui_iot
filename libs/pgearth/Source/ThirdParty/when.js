!function(n){"use strict";n(function(){var n,t,r;function e(n,t,r,e){return u(n).then(t,r,e)}function u(n){var t,r,e;return n instanceof o?t=n:f(n)?(r=c(),n.then(function(n){r.resolve(n)},function(n){r.reject(n)},function(n){r.progress(n)}),t=r.promise):(e=n,t=new o(function(n){try{return u(n?n(e):e)}catch(n){return i(n)}})),t}function o(n){this.then=n}function i(n){return new o(function(t,r){try{return r?u(r(n)):i(n)}catch(n){return i(n)}})}function c(){var n,t,e,f,s,h;return n=new o(a),t=[],e=[],f=function(n,r,u){var o,i;return o=c(),i="function"==typeof u?function(n){try{o.progress(u(n))}catch(n){o.progress(n)}}:function(n){o.progress(n)},t.push(function(t){t.then(n,r).then(o.resolve,o.reject,i)}),e.push(i),o.promise},s=function(n){return l(e,n),n},h=function(n){return n=u(n),f=n.then,h=u,s=v,l(t,n),e=t=r,n},{then:a,resolve:p,reject:g,progress:y,promise:n,resolver:{resolve:p,reject:g,progress:y}};function a(n,t,r){return f(n,t,r)}function p(n){return h(n)}function g(n){return h(i(n))}function y(n){return s(n)}}function f(n){return n&&"function"==typeof n.then}function s(n,t,r,u,o){return p(2,arguments),e(n,function(n){var i,f,s,h,a,l,p,g,y,m;if(y=n.length>>>0,i=Math.max(0,Math.min(t,y)),s=[],f=y-i+1,h=[],a=c(),i)for(g=a.progress,p=function(n){h.push(n),--f||(l=p=v,a.reject(h))},l=function(n){s.push(n),--i||(l=p=v,a.resolve(s))},m=0;m<y;++m)m in n&&e(n[m],d,j,g);else a.resolve(s);return a.then(r,u,o);function j(n){p(n)}function d(n){l(n)}})}function h(n,t,r,e){return p(1,arguments),a(n,g).then(t,r,e)}function a(n,t){return e(n,function(n){var r,u,o,i,f,s;if(o=u=n.length>>>0,r=[],s=c(),o)for(i=function(n,u){e(n,t).then(function(n){r[u]=n,--o||s.resolve(r)},s.reject)},f=0;f<u;f++)f in n?i(n[f],f):--o;else s.resolve(r);return s.promise})}function l(n,t){for(var r,e=0;r=n[e++];)r(t)}function p(n,t){for(var r,e=t.length;e>n;)if(null!=(r=t[--e])&&"function"!=typeof r)throw new Error("arg "+e+" must be a function")}function v(){}function g(n){return n}return e.defer=c,e.resolve=u,e.reject=function(n){return e(n,i)},e.join=function(){return a(arguments,g)},e.all=h,e.map=a,e.reduce=function(r,u){var o=t.call(arguments,1);return e(r,function(t){var r;return r=t.length,o[0]=function(n,t,o){return e(n,function(n){return e(t,function(t){return u(n,t,o,r)})})},n.apply(t,o)})},e.any=function(n,t,r,e){return s(n,1,function(n){return t?t(n[0]):n[0]},r,e)},e.some=s,e.chain=function(n,t,r){var u=arguments.length>2;return e(n,function(n){return n=u?r:n,t.resolve(n),n},function(n){return t.reject(n),i(n)},t.progress)},e.isPromise=f,o.prototype={always:function(n,t){return this.then(n,n,t)},otherwise:function(n){return this.then(r,n)},yield:function(n){return this.then(function(){return n})},spread:function(n){return this.then(function(t){return h(t,function(t){return n.apply(r,t)})})}},t=[].slice,n=[].reduce||function(n){var t,r,e,u,o;if(o=0,u=(t=Object(this)).length>>>0,(r=arguments).length<=1)for(;;){if(o in t){e=t[o++];break}if(++o>=u)throw new TypeError}else e=r[1];for(;o<u;++o)o in t&&(e=n(e,t[o],o,t));return e},e})}("function"==typeof define&&define.amd?define:function(n){"object"==typeof exports?module.exports=n():this.when=n()});