define(["../Core/ComponentDatatype","../Core/defined","../Core/IndexDatatype","../Core/RuntimeError","./createTaskProcessorWorker"],function(e,r,t,n,o){"use strict";var a;function i(t,n,o){var i,s=t.num_points(),u=o.num_components(),c=new a.AttributeQuantizationTransform;if(c.InitFromAttribute(o)){for(var y=new Array(u),d=0;d<u;++d)y[d]=c.min_value(d);i={quantizationBits:c.quantization_bits(),minValues:y,range:c.range(),octEncoded:!1}}a.destroy(c),(c=new a.AttributeOctahedronTransform).InitFromAttribute(o)&&(i={quantizationBits:c.quantization_bits(),octEncoded:!0}),a.destroy(c);var f,A=s*u;f=r(i)?function(e,r,t,n,o){var i,s;n.quantizationBits<=8?(s=new a.DracoUInt8Array,i=new Uint8Array(o),r.GetAttributeUInt8ForAllPoints(e,t,s)):(s=new a.DracoUInt16Array,i=new Uint16Array(o),r.GetAttributeUInt16ForAllPoints(e,t,s));for(var u=0;u<o;++u)i[u]=s.GetValue(u);return a.destroy(s),i}(t,n,o,i,A):function(e,r,t,n){var o,i;switch(t.data_type()){case 1:case 11:i=new a.DracoInt8Array,o=new Int8Array(n),r.GetAttributeInt8ForAllPoints(e,t,i);break;case 2:i=new a.DracoUInt8Array,o=new Uint8Array(n),r.GetAttributeUInt8ForAllPoints(e,t,i);break;case 3:i=new a.DracoInt16Array,o=new Int16Array(n),r.GetAttributeInt16ForAllPoints(e,t,i);break;case 4:i=new a.DracoUInt16Array,o=new Uint16Array(n),r.GetAttributeUInt16ForAllPoints(e,t,i);break;case 5:case 7:i=new a.DracoInt32Array,o=new Int32Array(n),r.GetAttributeInt32ForAllPoints(e,t,i);break;case 6:case 8:i=new a.DracoUInt32Array,o=new Uint32Array(n),r.GetAttributeUInt32ForAllPoints(e,t,i);break;case 9:case 10:i=new a.DracoFloat32Array,o=new Float32Array(n),r.GetAttributeFloatForAllPoints(e,t,i)}for(var s=0;s<n;++s)o[s]=i.GetValue(s);return a.destroy(i),o}(t,n,o,A);var l=e.fromTypedArray(f);return{array:f,data:{componentsPerAttribute:u,componentDatatype:l,byteOffset:o.byte_offset(),byteStride:e.getSizeInBytes(l)*u,normalized:o.normalized(),quantization:i}}}function s(e){var r=new a.Decoder,o=["POSITION","NORMAL","COLOR","TEX_COORD"];if(e.dequantizeInShader)for(var s=0;s<o.length;++s)r.SkipAttributeTransform(a[o[s]]);var u=e.bufferView,c=new a.DecoderBuffer;if(c.Init(e.array,u.byteLength),r.GetEncodedGeometryType(c)!==a.TRIANGULAR_MESH)throw new n("Unsupported draco mesh geometry type.");var y=new a.Mesh,d=r.DecodeBufferToMesh(c,y);if(!d.ok()||0===y.ptr)throw new n("Error decoding draco mesh geometry: "+d.error_msg());a.destroy(c);var f={},A=e.compressedAttributes;for(var l in A)if(A.hasOwnProperty(l)){var w=A[l],b=r.GetAttributeByUniqueId(y,w);f[l]=i(y,r,b)}var m={indexArray:function(e,r){for(var n=e.num_points(),o=e.num_faces(),i=new a.DracoInt32Array,s=3*o,u=t.createTypedArray(n,s),c=0,y=0;y<o;++y)r.GetFaceFromMesh(e,y,i),u[c+0]=i.GetValue(0),u[c+1]=i.GetValue(1),u[c+2]=i.GetValue(2),c+=3;return a.destroy(i),{typedArray:u,numberOfIndices:s}}(y,r),attributeData:f};return a.destroy(y),a.destroy(r),m}function u(e){return r(e.primitive)?s(e):function(e){var r=new a.Decoder;e.dequantizeInShader&&(r.SkipAttributeTransform(a.POSITION),r.SkipAttributeTransform(a.NORMAL));var t=new a.DecoderBuffer;if(t.Init(e.buffer,e.buffer.length),r.GetEncodedGeometryType(t)!==a.POINT_CLOUD)throw new n("Draco geometry type must be POINT_CLOUD.");var o=new a.PointCloud,s=r.DecodeBufferToPointCloud(t,o);if(!s.ok()||0===o.ptr)throw new n("Error decoding draco point cloud: "+s.error_msg());a.destroy(t);var u={},c=e.properties;for(var y in c)if(c.hasOwnProperty(y)){var d=c[y],f=r.GetAttributeByUniqueId(o,d);u[y]=i(o,r,f)}return a.destroy(o),a.destroy(r),u}(e)}function c(e){a=e,self.onmessage=o(u),self.postMessage(!0)}return function(e){var t=e.data.webAssemblyConfig;if(r(t))return require([t.modulePath],function(e){r(t.wasmBinaryFile)?(r(e)||(e=self.DracoDecoderModule),e(t).then(function(e){c(e)})):c(e())})}});