define(["../Core/AttributeCompression","../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/defined","../Core/Ellipsoid","../Core/EllipsoidalOccluder","../Core/IndexDatatype","../Core/Intersections2D","../Core/Math","../Core/OrientedBoundingBox","../Core/TerrainEncoding","./createTaskProcessorWorker"],function(e,t,i,n,r,s,o,h,u,d,a,l,f,p){"use strict";var g=32767,c=g/2|0,x=[],v=[],m=[],w=new r,y=new n,C=[],B=[],I=[],A=[],z=[],N=new n,V=new t,b=new l,T=new i,H=new n;function R(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}R.prototype.clone=function(e){return s(e)||(e=new R),e.uBuffer=this.uBuffer,e.vBuffer=this.vBuffer,e.heightBuffer=this.heightBuffer,e.normalBuffer=this.normalBuffer,e.index=this.index,e.first=this.first,e.second=this.second,e.ratio=this.ratio,e},R.prototype.initializeIndexed=function(e,t,i,n,r){this.uBuffer=e,this.vBuffer=t,this.heightBuffer=i,this.normalBuffer=n,this.index=r,this.first=void 0,this.second=void 0,this.ratio=void 0},R.prototype.initializeFromClipResult=function(e,t,i){var n=t+1;return-1!==e[t]?i[e[t]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=i[e[n]],++n,this.second=i[e[n]],++n,this.ratio=e[n],++n),n},R.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},R.prototype.isIndexed=function(){return s(this.index)},R.prototype.getH=function(){return s(this.index)?this.heightBuffer[this.index]:a.lerp(this.first.getH(),this.second.getH(),this.ratio)},R.prototype.getU=function(){return s(this.index)?this.uBuffer[this.index]:a.lerp(this.first.getU(),this.second.getU(),this.ratio)},R.prototype.getV=function(){return s(this.index)?this.vBuffer[this.index]:a.lerp(this.first.getV(),this.second.getV(),this.ratio)};var E=new i,F=-1,O=[new n,new n],U=[new n,new n];function X(t,i){var r=O[++F],s=U[F];return r=e.octDecode(t.first.getNormalX(),t.first.getNormalY(),r),s=e.octDecode(t.second.getNormalX(),t.second.getNormalY(),s),y=n.lerp(r,s,t.ratio,y),n.normalize(y,y),e.octEncode(y,i),--F,i}R.prototype.getNormalX=function(){return s(this.index)?this.normalBuffer[2*this.index]:(E=X(this,E)).x},R.prototype.getNormalY=function(){return s(this.index)?this.normalBuffer[2*this.index+1]:(E=X(this,E)).y};var k=[];function D(e,t,i,n,r,o,h,u,d){if(0!==h.length){for(var a=0,l=0;l<h.length;)l=k[a++].initializeFromClipResult(h,l,u);for(var f=0;f<a;++f){var p=k[f];if(p.isIndexed())p.newIndex=o[p.index],p.uBuffer=e,p.vBuffer=t,p.heightBuffer=i,d&&(p.normalBuffer=n);else{var g=p.getKey();if(s(o[g]))p.newIndex=o[g];else{var c=e.length;e.push(p.getU()),t.push(p.getV()),i.push(p.getH()),d&&(n.push(p.getNormalX()),n.push(p.getNormalY())),p.newIndex=c,o[g]=c}}}3===a?(r.push(k[0].newIndex),r.push(k[1].newIndex),r.push(k[2].newIndex)):4===a&&(r.push(k[0].newIndex),r.push(k[1].newIndex),r.push(k[2].newIndex),r.push(k[0].newIndex),r.push(k[2].newIndex),r.push(k[3].newIndex))}}return k.push(new R),k.push(new R),k.push(new R),k.push(new R),p(function(e,i){var r=e.isEastChild,s=e.isNorthChild,p=r?c:0,E=r?g:c,F=s?c:0,O=s?g:c,U=C,X=B,k=I,K=z;U.length=0,X.length=0,k.length=0,K.length=0;var M=A;M.length=0;var P={},S=e.vertices,Y=e.indices;Y=Y.subarray(0,e.skirtIndex);var W,_,J,L,Z,j=f.clone(e.encoding),q=j.hasVertexNormals,G=e.exaggeration,Q=0,$=e.vertexCountWithoutSkirts,ee=e.minimumHeight,te=e.maximumHeight,ie=new Array($),ne=new Array($),re=new Array($),se=q?new Array(2*$):void 0;for(_=0,J=0;_<$;++_,J+=2){var oe=j.decodeTextureCoordinates(S,_,T);if(W=j.decodeHeight(S,_)/G,L=a.clamp(oe.x*g|0,0,g),Z=a.clamp(oe.y*g|0,0,g),re[_]=a.clamp((W-ee)/(te-ee)*g|0,0,g),L<20&&(L=0),Z<20&&(Z=0),g-L<20&&(L=g),g-Z<20&&(Z=g),ie[_]=L,ne[_]=Z,q){var he=j.getOctEncodedNormal(S,_,H);se[J]=he.x,se[J+1]=he.y}(r&&L>=c||!r&&L<=c)&&(s&&Z>=c||!s&&Z<=c)&&(P[_]=Q,U.push(L),X.push(Z),k.push(re[_]),q&&(K.push(se[J]),K.push(se[J+1])),++Q)}var ue=[];ue.push(new R),ue.push(new R),ue.push(new R);var de,ae=[];for(ae.push(new R),ae.push(new R),ae.push(new R),_=0;_<Y.length;_+=3){var le=Y[_],fe=Y[_+1],pe=Y[_+2],ge=ie[le],ce=ie[fe],xe=ie[pe];ue[0].initializeIndexed(ie,ne,re,se,le),ue[1].initializeIndexed(ie,ne,re,se,fe),ue[2].initializeIndexed(ie,ne,re,se,pe);var ve=d.clipTriangleAtAxisAlignedThreshold(c,r,ge,ce,xe,x);(de=0)>=ve.length||(de=ae[0].initializeFromClipResult(ve,de,ue))>=ve.length||(de=ae[1].initializeFromClipResult(ve,de,ue))>=ve.length||(de=ae[2].initializeFromClipResult(ve,de,ue),D(U,X,k,K,M,P,d.clipTriangleAtAxisAlignedThreshold(c,s,ae[0].getV(),ae[1].getV(),ae[2].getV(),v),ae,q),de<ve.length&&(ae[2].clone(ae[1]),ae[2].initializeFromClipResult(ve,de,ue),D(U,X,k,K,M,P,d.clipTriangleAtAxisAlignedThreshold(c,s,ae[0].getV(),ae[1].getV(),ae[2].getV(),v),ae,q)))}var me=r?-g:0,we=s?-g:0,ye=[],Ce=[],Be=[],Ie=[],Ae=Number.MAX_VALUE,ze=-Ae,Ne=m;Ne.length=0;var Ve=o.clone(e.ellipsoid),be=e.childRectangle,Te=be.north,He=be.south,Re=be.east,Ee=be.west;for(Re<Ee&&(Re+=a.TWO_PI),_=0;_<U.length;++_)(L=Math.round(U[_]))<=p?(ye.push(_),L=0):L>=E?(Be.push(_),L=g):L=2*L+me,U[_]=L,(Z=Math.round(X[_]))<=F?(Ce.push(_),Z=0):Z>=O?(Ie.push(_),Z=g):Z=2*Z+we,X[_]=Z,(W=a.lerp(ee,te,k[_]/g))<Ae&&(Ae=W),W>ze&&(ze=W),k[_]=W,w.longitude=a.lerp(Ee,Re,L/g),w.latitude=a.lerp(He,Te,Z/g),w.height=W,Ve.cartographicToCartesian(w,y),Ne.push(y.x),Ne.push(y.y),Ne.push(y.z);var Fe=t.fromVertices(Ne,n.ZERO,3,V),Oe=l.fromRectangle(be,Ae,ze,Ve,b),Ue=new h(Ve).computeHorizonCullingPointFromVertices(Fe.center,Ne,3,Fe.center,N),Xe=ze-Ae,ke=new Uint16Array(U.length+X.length+k.length);for(_=0;_<U.length;++_)ke[_]=U[_];var De=U.length;for(_=0;_<X.length;++_)ke[De+_]=X[_];for(De+=X.length,_=0;_<k.length;++_)ke[De+_]=g*(k[_]-Ae)/Xe;var Ke,Me=u.createTypedArray(U.length,M);if(q){var Pe=new Uint8Array(K);i.push(ke.buffer,Me.buffer,Pe.buffer),Ke=Pe.buffer}else i.push(ke.buffer,Me.buffer);return{vertices:ke.buffer,encodedNormals:Ke,indices:Me.buffer,minimumHeight:Ae,maximumHeight:ze,westIndices:ye,southIndices:Ce,eastIndices:Be,northIndices:Ie,boundingSphere:Fe,orientedBoundingBox:Oe,horizonOcclusionPoint:Ue}})});