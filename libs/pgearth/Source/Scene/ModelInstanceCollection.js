define(["../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Check","../Core/clone","../Core/Color","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Matrix4","../Core/PrimitiveType","../Core/Resource","../Core/RuntimeError","../Core/Transforms","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/ShaderSource","../ThirdParty/GltfPipeline/ForEach","../ThirdParty/when","./Model","./ModelInstance","./ModelUtility","./SceneMode","./ShadowMode"],function(e,t,r,n,i,o,a,s,d,c,m,u,l,h,f,_,g,p,v,y,w,b,E,x,T,I,C,M,A){"use strict";var B={NEEDS_LOAD:0,LOADING:1,LOADED:2,FAILED:3};function S(n){if(n=s(n,s.EMPTY_OBJECT),!d(n.gltf)&&!d(n.url))throw new u("Either options.gltf or options.url is required.");if(d(n.gltf)&&d(n.url))throw new u("Cannot pass in both options.gltf and options.url.");this.show=s(n.show,!0),this._instancingSupported=!1,this._dynamic=s(n.dynamic,!1),this._allowPicking=s(n.allowPicking,!0),this._ready=!1,this._readyPromise=x.defer(),this._state=B.NEEDS_LOAD,this._dirty=!1,this._cull=s(n.cull,!0),this._opaquePass=s(n.opaquePass,w.OPAQUE),this._instances=function(e,t){for(var r=(t=s(t,[])).length,n=new Array(r),i=0;i<r;++i){var o=t[i],a=o.modelMatrix,d=s(o.batchId,i);n[i]=new I(e,a,d)}return n}(this,n.instances),this._batchTable=n.batchTable,this._model=void 0,this._vertexBufferTypedArray=void 0,this._vertexBuffer=void 0,this._batchIdBuffer=void 0,this._instancedUniformsByProgram=void 0,this._drawCommands=[],this._modelCommands=void 0,this._boundingSphere=function(t){for(var n=t.length,i=new Array(n),o=0;o<n;++o)i[o]=l.getTranslation(t._instances[o]._modelMatrix,new r);return e.fromPoints(i)}(this),this._center=r.clone(this._boundingSphere.center),this._rtcTransform=new l,this._rtcModelView=new l,this._mode=void 0,this.modelMatrix=l.clone(l.IDENTITY),this._modelMatrix=l.clone(this.modelMatrix),this._url=f.createIfNeeded(n.url),this._requestType=n.requestType,this._gltf=n.gltf,this._basePath=f.createIfNeeded(n.basePath),this._asynchronous=n.asynchronous,this._incrementallyLoadTextures=n.incrementallyLoadTextures,this._upAxis=n.upAxis,this._forwardAxis=n.forwardAxis,this.shadows=s(n.shadows,A.ENABLED),this._shadows=this.shadows,this._pickIdLoaded=n.pickIdLoaded,this.debugShowBoundingVolume=s(n.debugShowBoundingVolume,!1),this._debugShowBoundingVolume=!1,this.debugWireframe=s(n.debugWireframe,!1),this._debugWireframe=!1,this._imageBasedLightingFactor=new t(1,1),t.clone(n.imageBasedLightingFactor,this._imageBasedLightingFactor),this.lightColor=n.lightColor,this.luminanceAtZenith=n.luminanceAtZenith,this.sphericalHarmonicCoefficients=n.sphericalHarmonicCoefficients,this.specularEnvironmentMaps=n.specularEnvironmentMaps}c(S.prototype,{allowPicking:{get:function(){return this._allowPicking}},length:{get:function(){return this._instances.length}},activeAnimations:{get:function(){return this._model.activeAnimations}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},imageBasedLightingFactor:{get:function(){return this._imageBasedLightingFactor},set:function(e){n.typeOf.object("imageBasedLightingFactor",e),n.typeOf.number.greaterThanOrEquals("imageBasedLightingFactor.x",e.x,0),n.typeOf.number.lessThanOrEquals("imageBasedLightingFactor.x",e.x,1),n.typeOf.number.greaterThanOrEquals("imageBasedLightingFactor.y",e.y,0),n.typeOf.number.lessThanOrEquals("imageBasedLightingFactor.y",e.y,1),t.clone(e,this._imageBasedLightingFactor)}}});var L=new r,O=new l;function D(e,t,r,n){return function(i,o){var a=i.semantic;if(d(a)&&e.indexOf(a)>-1){if(!(t.indexOf(a)>-1))throw new _('Shader program cannot be optimized for instancing. Uniform "'+o+'" in program "'+r+'" uses unsupported semantic "'+a+'"');n[o]=a}}}function P(e,t){if(d(e._instancedUniformsByProgram))return e._instancedUniformsByProgram[t];var r={};e._instancedUniformsByProgram=r;var n=["MODEL","MODELVIEW","PGEARTH_RTC_MODELVIEW","MODELVIEWPROJECTION","MODELINVERSE","MODELVIEWINVERSE","MODELVIEWPROJECTIONINVERSE","MODELINVERSETRANSPOSE","MODELVIEWINVERSETRANSPOSE"],i=["MODELVIEW","PGEARTH_RTC_MODELVIEW","MODELVIEWPROJECTION","MODELVIEWINVERSETRANSPOSE"],o=e._model._sourceTechniques;for(var a in o)if(o.hasOwnProperty(a)){var s=o[a],c=s.program;if(!d(r[c])){var m={};r[c]=m,E.techniqueUniform(s,D(n,i,t,m))}}return r[t]}function V(e,t){return function(r,n,o){(r=i(r)).czm_instanced_modifiedModelView=function(e,t){return function(){return l.multiply(t.uniformState.view,e._rtcTransform,e._rtcModelView)}}(e,t),r.czm_instanced_nodeTransform=function(e){return function(){return e.computedMatrix}}(o);var a=P(e,n);for(var s in a)a.hasOwnProperty(s)&&delete r[s];return d(e._batchTable)&&(r=e._batchTable.getUniformMapCallback()(r)),r}}function R(e){var t=e._instances,r=e.length,n=e._center,i=e._vertexBufferTypedArray;d(i)||(i=new Float32Array(12*r)),e._dynamic&&(e._vertexBufferTypedArray=i);for(var o=0;o<r;++o){var a=t[o]._modelMatrix,s=l.clone(a,O);s[12]-=n.x,s[13]-=n.y,s[14]-=n.z;var c=12*o;i[c+0]=s[0],i[c+1]=s[4],i[c+2]=s[8],i[c+3]=s[12],i[c+4]=s[1],i[c+5]=s[5],i[c+6]=s[9],i[c+7]=s[13],i[c+8]=s[2],i[c+9]=s[6],i[c+10]=s[10],i[c+11]=s[14]}return i}function z(e,t){var r=e._instancingSupported,n=d(e._batchTable),i=e._allowPicking,s={url:e._url,requestType:e._requestType,gltf:e._gltf,basePath:e._basePath,shadows:e._shadows,cacheKey:void 0,asynchronous:e._asynchronous,allowPicking:i,incrementallyLoadTextures:e._incrementallyLoadTextures,upAxis:e._upAxis,forwardAxis:e._forwardAxis,precreatedAttributes:void 0,vertexShaderLoaded:void 0,fragmentShaderLoaded:void 0,uniformMapLoaded:void 0,pickIdLoaded:e._pickIdLoaded,ignoreCommands:!0,opaquePass:e._opaquePass,imageBasedLightingFactor:e.imageBasedLightingFactor,lightColor:e.lightColor,luminanceAtZenith:e.luminanceAtZenith,sphericalHarmonicCoefficients:e.sphericalHarmonicCoefficients,specularEnvironmentMaps:e.specularEnvironmentMaps};if(n||(e._pickIds=function(e,t){for(var r=e._instances,n=r.length,i=new Array(n),o=0;o<n;++o)i[o]=t.createPickId(r[o]);return i}(e,t)),r){!function(e,t){var r,n=e._instances,i=e.length,a=e._dynamic,s=d(e._batchTable);if(s){var c=new Uint16Array(i);for(r=0;r<i;++r)c[r]=n[r]._instanceId;e._batchIdBuffer=p.createVertexBuffer({context:t,typedArray:c,usage:v.STATIC_DRAW})}if(!s){var m=new Uint8Array(4*i);for(r=0;r<i;++r){var u=e._pickIds[r].color,l=4*r;m[l]=o.floatToByte(u.red),m[l+1]=o.floatToByte(u.green),m[l+2]=o.floatToByte(u.blue),m[l+3]=o.floatToByte(u.alpha)}e._pickIdBuffer=p.createVertexBuffer({context:t,typedArray:m,usage:v.STATIC_DRAW})}var h=R(e);e._vertexBuffer=p.createVertexBuffer({context:t,typedArray:h,usage:a?v.STREAM_DRAW:v.STATIC_DRAW})}(e,t);var c=a.getSizeInBytes(a.FLOAT),m={czm_modelMatrixRow0:{index:0,vertexBuffer:e._vertexBuffer,componentsPerAttribute:4,componentDatatype:a.FLOAT,normalize:!1,offsetInBytes:0,strideInBytes:12*c,instanceDivisor:1},czm_modelMatrixRow1:{index:0,vertexBuffer:e._vertexBuffer,componentsPerAttribute:4,componentDatatype:a.FLOAT,normalize:!1,offsetInBytes:4*c,strideInBytes:12*c,instanceDivisor:1},czm_modelMatrixRow2:{index:0,vertexBuffer:e._vertexBuffer,componentsPerAttribute:4,componentDatatype:a.FLOAT,normalize:!1,offsetInBytes:8*c,strideInBytes:12*c,instanceDivisor:1}};n&&(m.a_batchId={index:0,vertexBuffer:e._batchIdBuffer,componentsPerAttribute:1,componentDatatype:a.UNSIGNED_SHORT,normalize:!1,offsetInBytes:0,strideInBytes:0,instanceDivisor:1}),n||(m.pickColor={index:0,vertexBuffer:e._pickIdBuffer,componentsPerAttribute:4,componentDatatype:a.UNSIGNED_BYTE,normalize:!0,offsetInBytes:0,strideInBytes:0,instanceDivisor:1}),s.precreatedAttributes=m,s.vertexShaderLoaded=function(e){return function(t,r){var n,i,o,a=P(e,r),s=d(e._batchTable),c=b.replaceMain(t,"czm_instancing_main"),m="",u="";for(var l in a)if(a.hasOwnProperty(l)){var h,f=a[l];"MODELVIEW"===f||"PGEARTH_RTC_MODELVIEW"===f?h="czm_instanced_modelView":"MODELVIEWPROJECTION"===f?(h="czm_instanced_modelViewProjection",m+="mat4 czm_instanced_modelViewProjection;\n",u+="czm_instanced_modelViewProjection = czm_projection * czm_instanced_modelView;\n"):"MODELVIEWINVERSETRANSPOSE"===f&&(h="czm_instanced_modelViewInverseTranspose",m+="mat3 czm_instanced_modelViewInverseTranspose;\n",u+="czm_instanced_modelViewInverseTranspose = mat3(czm_instanced_modelView);\n");var _=new RegExp("uniform.*"+l+".*");c=c.replace(_,""),_=new RegExp(l+"\\b","g"),c=c.replace(_,h)}s?(n="attribute float a_batchId;\n",i="",o=""):(n="",i="attribute vec4 pickColor;\nvarying vec4 v_pickColor;\n",o="    v_pickColor = pickColor;\n");var g="uniform mat4 czm_instanced_modifiedModelView;\nuniform mat4 czm_instanced_nodeTransform;\n"+m+"mat4 czm_instanced_modelView;\nattribute vec4 czm_modelMatrixRow0;\nattribute vec4 czm_modelMatrixRow1;\nattribute vec4 czm_modelMatrixRow2;\n"+n+i+c+"void main()\n{\n    mat4 czm_instanced_model = mat4(czm_modelMatrixRow0.x, czm_modelMatrixRow1.x, czm_modelMatrixRow2.x, 0.0, czm_modelMatrixRow0.y, czm_modelMatrixRow1.y, czm_modelMatrixRow2.y, 0.0, czm_modelMatrixRow0.z, czm_modelMatrixRow1.z, czm_modelMatrixRow2.z, 0.0, czm_modelMatrixRow0.w, czm_modelMatrixRow1.w, czm_modelMatrixRow2.w, 1.0);\n    czm_instanced_modelView = czm_instanced_modifiedModelView * czm_instanced_model * czm_instanced_nodeTransform;\n"+u+"    czm_instancing_main();\n"+o+"}\n";if(s){var p=e._model.gltf,v=C.getDiffuseAttributeOrUniform(p,r);g=e._batchTable.getVertexShaderCallback(!0,"a_batchId",v)(g)}return g}}(e),s.fragmentShaderLoaded=function(e){return function(t,r){var n=e._batchTable;if(d(n)){var i=e._model.gltf,o=C.getDiffuseAttributeOrUniform(i,r);t=n.getFragmentShaderCallback(!0,o)(t)}else t="varying vec4 v_pickColor;\n"+t;return t}}(e),s.uniformMapLoaded=V(e,t),d(e._url)&&(s.cacheKey=e._url.getUrlComponent()+"#instanced")}else s.vertexShaderLoaded=function(e){return function(t,r){if(d(e._batchTable)){var n=e._model.gltf,i=C.getDiffuseAttributeOrUniform(n,r);t="uniform float a_batchId\n;"+(t=e._batchTable.getVertexShaderCallback(!0,"a_batchId",i)(t))}return t}}(e),s.fragmentShaderLoaded=function(e){return function(t,r){var n=e._batchTable;if(d(n)){var i=e._model.gltf,o=C.getDiffuseAttributeOrUniform(i,r);t=n.getFragmentShaderCallback(!0,o)(t)}else t="uniform vec4 czm_pickColor;\n"+t;return t}}(e),s.uniformMapLoaded=function(e){return function(t){return d(e._batchTable)&&(t=e._batchTable.getUniformMapCallback()(t)),t}}(e);d(e._url)?e._model=T.fromGltf(s):e._model=new T(s)}function k(e){return function(){return e}}function N(e){return function(){return e}}function F(t){for(var r=t._modelCommands,n=r.length,i=t.length,o=t._rtcTransform,a=t._center,s=0;s<n;++s)for(var d=r[s],c=0;c<i;++c){var m=s*i+c,u=t._drawCommands[m],h=l.clone(t._instances[c]._modelMatrix,O);h[12]-=a.x,h[13]-=a.y,h[14]-=a.z,h=l.multiply(o,h,O);var f=d.modelMatrix,_=u.modelMatrix;l.multiply(h,f,_);var g=d.boundingVolume,p=u.boundingVolume;e.transform(g,h,p)}}function W(e){for(var t=e._nodeCommands,r=t.length,n=[],i=0;i<r;++i){var o=t[i];o.show&&n.push(o.command)}return n}function U(t,r){t._drawCommands=[];var n=W(t._model);r?function(e,t){for(var r=t.length,n=e.length,i=e._boundingSphere,o=e._cull,a=0;a<r;++a){var s=y.shallowClone(t[a]);s.instanceCount=n,s.boundingVolume=i,s.cull=o,d(e._batchTable)?s.pickId=e._batchTable.getPickId():s.pickId="v_pickColor",e._drawCommands.push(s)}}(t,n):(!function(t,r){for(var n=t._instances,o=r.length,a=t.length,s=t._batchTable,c=d(s),m=t._cull,u=0;u<o;++u)for(var h=0;h<a;++h){var f=y.shallowClone(r[u]);if(f.modelMatrix=new l,f.boundingVolume=new e,f.cull=m,f.uniformMap=i(f.uniformMap),c)f.uniformMap.a_batchId=k(n[h]._instanceId);else{var _=t._pickIds[h];f.uniformMap.czm_pickColor=N(_.color)}t._drawCommands.push(f)}}(t,n),F(t))}return S.prototype.expandBoundingSphere=function(t){var r=l.getTranslation(t,L);e.expand(this._boundingSphere,r,this._boundingSphere)},S.prototype.update=function(e){if(e.mode!==M.MORPHING&&this.show&&0!==this.length){var t=e.context;if(this._state===B.NEEDS_LOAD){this._state=B.LOADING,this._instancingSupported=t.instancedArrays,z(this,t);var n=this;this._model.readyPromise.otherwise(function(e){n._state=B.FAILED,n._readyPromise.reject(e)})}var i=this._instancingSupported,o=this._model;if(o.imageBasedLightingFactor=this.imageBasedLightingFactor,o.lightColor=this.lightColor,o.luminanceAtZenith=this.luminanceAtZenith,o.sphericalHarmonicCoefficients=this.sphericalHarmonicCoefficients,o.specularEnvironmentMaps=this.specularEnvironmentMaps,o.update(e),o.ready&&this._state===B.LOADING){this._state=B.LOADED,this._ready=!0;var a=o.boundingSphere.radius+r.magnitude(o.boundingSphere.center);return this._boundingSphere.radius+=a,this._modelCommands=W(o),U(this,i),void this._readyPromise.resolve(this)}if(this._state===B.LOADED){var s,d,c=e.mode!==this._mode,m=this.modelMatrix,u=!l.equals(this._modelMatrix,m);if(c||u){this._mode=e.mode,l.clone(m,this._modelMatrix);var f=l.multiplyByTranslation(this._modelMatrix,this._center,this._rtcTransform);this._mode!==M.SCENE3D&&(f=g.basisTo2D(e.mapProjection,f,f)),l.getTranslation(f,this._boundingSphere.center)}i&&this._dirty&&(this._dynamic=!0,this._dirty=!1,d=R(s=this),s._vertexBuffer.copyFromArrayView(d)),function(e){for(var t=e._nodeCommands,r=t.length,n=0;n<r;n++)if(t[n].command.dirty)return!0;return!1}(o)&&U(this,i),!i&&(o.dirty||this._dirty||c||u)&&F(this),function(e){if(e.shadows!==e._shadows){e._shadows=e.shadows;for(var t=A.castShadows(e.shadows),r=A.receiveShadows(e.shadows),n=e._drawCommands,i=n.length,o=0;o<i;++o){var a=n[o];a.castShadows=t,a.receiveShadows=r}}}(this),function(e){if(e._debugWireframe!==e.debugWireframe){e._debugWireframe=e.debugWireframe;for(var t=e.debugWireframe?h.LINES:h.TRIANGLES,r=e._drawCommands,n=r.length,i=0;i<n;++i)r[i].primitiveType=t}}(this),function(e){if(e.debugShowBoundingVolume!==e._debugShowBoundingVolume){e._debugShowBoundingVolume=e.debugShowBoundingVolume;for(var t=e._drawCommands,r=t.length,n=0;n<r;++n)t[n].debugShowBoundingVolume=e.debugShowBoundingVolume}}(this);var _=e.passes;if(_.render||_.pick)for(var p=e.commandList,v=this._drawCommands,y=v.length,w=0;w<y;++w)p.push(v[w])}}},S.prototype.isDestroyed=function(){return!1},S.prototype.destroy=function(){this._model=this._model&&this._model.destroy();var e=this._pickIds;if(d(e))for(var t=e.length,r=0;r<t;++r)e[r].destroy();return m(this)},S});