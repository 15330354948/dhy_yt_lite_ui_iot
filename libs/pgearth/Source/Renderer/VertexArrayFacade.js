define(["../Core/Check","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/destroyObject","../Core/DeveloperError","../Core/Math","./Buffer","./BufferUsage","./VertexArray"],function(e,t,r,n,i,o,a,s,f,u){"use strict";function v(i,a,s,f){if(e.defined("context",i),!a||0===a.length)throw new o("At least one attribute is required.");var u=v._verifyAttributes(a);s=r(s,0);for(var y,c,p=[],h={},m=u.length,d=0;d<m;++d){var B=u[d];B.vertexBuffer?p.push(B):(y=h[c=B.usage],n(y)||(y=h[c]=[]),y.push(B))}function l(e,r){return t.getSizeInBytes(r.componentDatatype)-t.getSizeInBytes(e.componentDatatype)}for(c in this._allBuffers=[],h)if(h.hasOwnProperty(c)){(y=h[c]).sort(l);var x=v._vertexSizeInBytes(y),_={vertexSizeInBytes:x,vertexBuffer:void 0,usage:y[0].usage,needsCommit:!1,arrayBuffer:void 0,arrayViews:v._createArrayViews(y,x)};this._allBuffers.push(_)}this._size=0,this._instanced=r(f,!1),this._precreated=p,this._context=i,this.writers=void 0,this.va=void 0,this.resize(s)}v._verifyAttributes=function(e){for(var n=[],i=0;i<e.length;++i){var a=e[i],s={index:r(a.index,i),enabled:r(a.enabled,!0),componentsPerAttribute:a.componentsPerAttribute,componentDatatype:r(a.componentDatatype,t.FLOAT),normalize:r(a.normalize,!1),vertexBuffer:a.vertexBuffer,usage:r(a.usage,f.STATIC_DRAW)};if(n.push(s),1!==s.componentsPerAttribute&&2!==s.componentsPerAttribute&&3!==s.componentsPerAttribute&&4!==s.componentsPerAttribute)throw new o("attribute.componentsPerAttribute must be in the range [1, 4].");var u=s.componentDatatype;if(!t.validate(u))throw new o("Attribute must have a valid componentDatatype or not specify it.");if(!f.validate(s.usage))throw new o("Attribute must have a valid usage or not specify it.")}for(var v=new Array(n.length),y=0;y<n.length;++y){var c=n[y].index;if(v[c])throw new o("Index "+c+" is used by more than one attribute.");v[c]=!0}return n},v._vertexSizeInBytes=function(e){for(var r=0,n=e.length,i=0;i<n;++i){var o=e[i];r+=o.componentsPerAttribute*t.getSizeInBytes(o.componentDatatype)}var a=n>0?t.getSizeInBytes(e[0].componentDatatype):0,s=a>0?r%a:0;return r+=0===s?0:a-s},v._createArrayViews=function(e,r){for(var n=[],i=0,o=e.length,a=0;a<o;++a){var s=e[a],f=s.componentDatatype;n.push({index:s.index,enabled:s.enabled,componentsPerAttribute:s.componentsPerAttribute,componentDatatype:f,normalize:s.normalize,offsetInBytes:i,vertexSizeInComponentType:r/t.getSizeInBytes(f),view:void 0}),i+=s.componentsPerAttribute*t.getSizeInBytes(f)}return n},v.prototype.resize=function(e){this._size=e;var t=this._allBuffers;this.writers=[];for(var r=0,n=t.length;r<n;++r){var i=t[r];v._resize(i,this._size),v._appendWriters(this.writers,i)}h(this)},v._resize=function(e,r){if(e.vertexSizeInBytes>0){var i=new ArrayBuffer(r*e.vertexSizeInBytes);if(n(e.arrayBuffer))for(var o=new Uint8Array(i),a=new Uint8Array(e.arrayBuffer),s=a.length,f=0;f<s;++f)o[f]=a[f];for(var u=e.arrayViews,v=u.length,y=0;y<v;++y){var c=u[y];c.view=t.createArrayBufferView(c.componentDatatype,i,c.offsetInBytes)}e.arrayBuffer=i}};var y=[function(e,t,r){return function(n,i){t[n*r]=i,e.needsCommit=!0}},function(e,t,r){return function(n,i,o){var a=n*r;t[a]=i,t[a+1]=o,e.needsCommit=!0}},function(e,t,r){return function(n,i,o,a){var s=n*r;t[s]=i,t[s+1]=o,t[s+2]=a,e.needsCommit=!0}},function(e,t,r){return function(n,i,o,a,s){var f=n*r;t[f]=i,t[f+1]=o,t[f+2]=a,t[f+3]=s,e.needsCommit=!0}}];function c(e,t){if(t.needsCommit&&t.vertexSizeInBytes>0){t.needsCommit=!1;var r=t.vertexBuffer,i=e._size*t.vertexSizeInBytes,o=n(r);if(!o||r.sizeInBytes<i)return o&&r.destroy(),t.vertexBuffer=s.createVertexBuffer({context:e._context,typedArray:t.arrayBuffer,usage:t.usage}),t.vertexBuffer.vertexArrayDestroyable=!1,!0;t.vertexBuffer.copyFromArrayView(t.arrayBuffer)}return!1}function p(e,t,r){if(e.needsCommit&&e.vertexSizeInBytes>0){var n=e.vertexSizeInBytes*t,i=e.vertexSizeInBytes*r;e.vertexBuffer.copyFromArrayView(new Uint8Array(e.arrayBuffer,n,i),n)}}function h(e){var t=e.va;if(n(t)){for(var r=t.length,i=0;i<r;++i)t[i].va.destroy();e.va=void 0}}return v._appendWriters=function(e,t){for(var r=t.arrayViews,n=r.length,i=0;i<n;++i){var o=r[i];e[o.index]=y[o.componentsPerAttribute-1](t,o.view,o.vertexSizeInComponentType)}},v.prototype.commit=function(e){var t,r,i,o=!1,s=this._allBuffers;for(r=0,i=s.length;r<i;++r)o=c(this,t=s[r])||o;if(o||!n(this.va)){h(this);for(var f=this.va=[],y=n(e)?Math.ceil(this._size/(a.SIXTY_FOUR_KILOBYTES-1)):1,p=0;p<y;++p){var m=[];for(r=0,i=s.length;r<i;++r){var d=p*((t=s[r]).vertexSizeInBytes*(a.SIXTY_FOUR_KILOBYTES-1));v._appendAttributes(m,t,d,this._instanced)}m=m.concat(this._precreated),f.push({va:new u({context:this._context,attributes:m,indexBuffer:e}),indicesCount:1.5*(p!==y-1?a.SIXTY_FOUR_KILOBYTES-1:this._size%(a.SIXTY_FOUR_KILOBYTES-1))})}}},v._appendAttributes=function(e,t,r,n){for(var i=t.arrayViews,o=i.length,a=0;a<o;++a){var s=i[a];e.push({index:s.index,enabled:s.enabled,componentsPerAttribute:s.componentsPerAttribute,componentDatatype:s.componentDatatype,normalize:s.normalize,vertexBuffer:t.vertexBuffer,offsetInBytes:r+s.offsetInBytes,strideInBytes:t.vertexSizeInBytes,instanceDivisor:n?1:0})}},v.prototype.subCommit=function(e,t){if(e<0||e>=this._size)throw new o("offsetInVertices must be greater than or equal to zero and less than the vertex array size.");if(e+t>this._size)throw new o("offsetInVertices + lengthInVertices cannot exceed the vertex array size.");for(var r=this._allBuffers,n=0,i=r.length;n<i;++n)p(r[n],e,t)},v.prototype.endSubCommits=function(){for(var e=this._allBuffers,t=0,r=e.length;t<r;++t)e[t].needsCommit=!1},v.prototype.isDestroyed=function(){return!1},v.prototype.destroy=function(){for(var e=this._allBuffers,t=0,r=e.length;t<r;++t){var n=e[t];n.vertexBuffer=n.vertexBuffer&&n.vertexBuffer.destroy()}return h(this),i(this)},v});