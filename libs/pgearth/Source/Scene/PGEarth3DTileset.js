define(["../Core/ApproximateTerrainHeights","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/Check","../Core/Credit","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/deprecationWarning","../Core/destroyObject","../Core/DeveloperError","../Core/DoublyLinkedList","../Core/Ellipsoid","../Core/Event","../Core/JulianDate","../Core/ManagedArray","../Core/Math","../Core/Matrix4","../Core/Resource","../Core/RuntimeError","../Core/Transforms","../Renderer/ClearCommand","../Renderer/Pass","../Renderer/RenderState","../ThirdParty/when","./Axis","./PGEarth3DTile","./PGEarth3DTileColorBlendMode","./PGEarth3DTileContentState","./PGEarth3DTileOptimizations","./PGEarth3DTilePass","./PGEarth3DTilePassState","./PGEarth3DTileRefine","./PGEarth3DTilesetCache","./PGEarth3DTilesetHeatmap","./PGEarth3DTilesetMostDetailedTraversal","./PGEarth3DTilesetStatistics","./PGEarth3DTilesetTraversal","./PGEarth3DTileStyleEngine","./ClippingPlaneCollection","./LabelCollection","./PointCloudEyeDomeLighting","./PointCloudShading","./SceneMode","./ShadowMode","./StencilConstants","./TileBoundingRegion","./TileBoundingSphere","./TileOrientedBoundingBox","../Core/createGuid","../DataSources/GeoJsonDataSource"],function(e,t,i,r,n,s,a,o,l,h,d,u,c,m,g,p,f,_,y,v,b,S,T,E,P,C,L,D,O,x,w,M,A,R,U,F,B,V,G,N,k,q,I,W,H,z,X,Q,J,j,Y,K){"use strict";function Z(i){i=a(i,a.EMPTY_OBJECT),n.defined("options.url",i.url),this._url=void 0,this._basePath=void 0,this._root=void 0,this._asset=void 0,this._properties=void 0,this._geometricError=void 0,this._extensionsUsed=void 0,this._gltfUpAxis=void 0,this._cache=new U,this._processingQueue=[],this._selectedTiles=[],this._emptyTiles=[],this._requestedTiles=[],this._selectedTilesToStyle=[],this._loadTimestamp=void 0,this._timeSinceLoad=0,this._updatedVisibilityFrame=0,this._extras=void 0,this._credits=void 0,this._cullWithChildrenBounds=a(i.cullWithChildrenBounds,!0),this._allTilesAdditive=!0,this._hasMixedContent=!1,this._stencilClearCommand=void 0,this._backfaceCommands=new f,this._maximumScreenSpaceError=a(i.maximumScreenSpaceError,2),this._maximumMemoryUsage=a(i.maximumMemoryUsage,512),this._styleEngine=new N,this._modelMatrix=o(i.modelMatrix)?y.clone(i.modelMatrix):y.clone(y.IDENTITY),this._statistics=new V,this._statisticsLast=new V,this._statisticsPerPass=new Array(M.NUMBER_OF_PASSES);for(var r=0;r<M.NUMBER_OF_PASSES;++r)this._statisticsPerPass[r]=new V;this._requestedTilesInFlight=[],this._maximumPriority={foveatedFactor:-Number.MAX_VALUE,depth:-Number.MAX_VALUE,distance:-Number.MAX_VALUE,reverseScreenSpaceError:-Number.MAX_VALUE},this._minimumPriority={foveatedFactor:Number.MAX_VALUE,depth:Number.MAX_VALUE,distance:Number.MAX_VALUE,reverseScreenSpaceError:Number.MAX_VALUE},this._heatmap=new F(i.debugHeatmapTilePropertyName),this._type="PGEarth3DTileset",this.cullRequestsWhileMoving=a(i.cullRequestsWhileMoving,!0),this.cullRequestsWhileMovingMultiplier=a(i.cullRequestsWhileMovingMultiplier,60),this.progressiveResolutionHeightFraction=_.clamp(a(i.progressiveResolutionHeightFraction,.3),0,.5),this.preferLeaves=a(i.preferLeaves,!1),this._tilesLoaded=!1,this._initialTilesLoaded=!1,this._tileDebugLabels=void 0,this._readyPromise=C.defer(),this._classificationType=i.classificationType,this._ellipsoid=a(i.ellipsoid,m.WGS84),this._initialClippingPlanesOriginMatrix=y.IDENTITY,this._clippingPlanesOriginMatrix=void 0,this._clippingPlanesOriginMatrixDirty=!0,this.preloadWhenHidden=a(i.preloadWhenHidden,!1),this.preloadFlightDestinations=a(i.preloadFlightDestinations,!0),this._pass=void 0,this.dynamicScreenSpaceError=a(i.dynamicScreenSpaceError,!1),this.foveatedScreenSpaceError=a(i.foveatedScreenSpaceError,!0),this._foveatedConeSize=a(i.foveatedConeSize,.1),this._foveatedMinimumScreenSpaceErrorRelaxation=a(i.foveatedMinimumScreenSpaceErrorRelaxation,0),this.foveatedInterpolationCallback=a(i.foveatedInterpolationCallback,_.lerp),this.foveatedTimeDelay=a(i.foveatedTimeDelay,.2),this.dynamicScreenSpaceErrorDensity=.00278,this.dynamicScreenSpaceErrorFactor=4,this.dynamicScreenSpaceErrorHeightFalloff=.25,this._dynamicScreenSpaceErrorComputedDensity=0,this.shadows=a(i.shadows,z.ENABLED),this.show=a(i.show,!0),this.colorBlendMode=O.HIGHLIGHT,this.colorBlendAmount=.5,this.pointCloudShading=new W(i.pointCloudShading),this._pointCloudEyeDomeLighting=new I,this.loadProgress=new g,this.allTilesLoaded=new g,this.initialTilesLoaded=new g,this.tileLoad=new g,this.tileUnload=new g,this.tileFailed=new g,this.tileVisible=new g,this.skipLevelOfDetail=a(i.skipLevelOfDetail,!0),this._skipLevelOfDetail=this.skipLevelOfDetail,this._disableSkipLevelOfDetail=!1,this.baseScreenSpaceError=a(i.baseScreenSpaceError,1024),this.skipScreenSpaceErrorFactor=a(i.skipScreenSpaceErrorFactor,16),this.skipLevels=a(i.skipLevels,1),this.immediatelyLoadDesiredLevelOfDetail=a(i.immediatelyLoadDesiredLevelOfDetail,!1),this.loadSiblings=a(i.loadSiblings,!1),this._clippingPlanes=void 0,this.clippingPlanes=i.clippingPlanes,this._imageBasedLightingFactor=new t(1,1),t.clone(i.imageBasedLightingFactor,this._imageBasedLightingFactor),this.lightColor=i.lightColor,this.luminanceAtZenith=a(i.luminanceAtZenith,.5),this.sphericalHarmonicCoefficients=i.sphericalHarmonicCoefficients,this.specularEnvironmentMaps=i.specularEnvironmentMaps,this.debugFreezeFrame=a(i.debugFreezeFrame,!1),this.debugColorizeTiles=a(i.debugColorizeTiles,!1),this.debugWireframe=a(i.debugWireframe,!1),this.debugShowBoundingVolume=a(i.debugShowBoundingVolume,!1),this.debugShowContentBoundingVolume=a(i.debugShowContentBoundingVolume,!1),this.debugShowViewerRequestVolume=a(i.debugShowViewerRequestVolume,!1),this._tileDebugLabels=void 0,this.debugPickedTileLabelOnly=!1,this.debugPickedTile=void 0,this.debugPickPosition=void 0,this.debugShowGeometricError=a(i.debugShowGeometricError,!1),this.debugShowRenderingStatistics=a(i.debugShowRenderingStatistics,!1),this.debugShowMemoryUsage=a(i.debugShowMemoryUsage,!1),this.debugShowUrl=a(i.debugShowUrl,!1);var l,h=this,d=Y();C(i.url).then(function(e){var t=v.createIfNeeded(e);return t.setQueryParameters({uuid:d}),Z.loadJson(t)}).then(function(t){C(i.url).then(function(e){var i;return(l=v.createIfNeeded(e)).setQueryParameters({uuid:d}),l=l.getDerivedResource({url:t.data}),h._credits=l.credits,"json"===l.extension?i=l.getBaseUri(!0):l.isDataUri&&(i=""),h._url=l.url,h._basePath=i,Z.loadJson(l)}).then(function(t){h._root=h.loadTileset(l,t);var i=o(t.asset.gltfUpAxis)?L.fromName(t.asset.gltfUpAxis):L.Y,r=t.asset;h._asset=r,h._properties=t.properties,h._geometricError=t.geometricError,h._extensionsUsed=t.extensionsUsed,h._gltfUpAxis=i,h._extras=t.extras;var n=r.extras;if(o(n)&&o(n.pgEarth)&&o(n.pgEarth.credits)){var a=n.pgEarth.credits,d=h._credits;o(d)||(d=[],h._credits=d);for(var u=0;u<a.length;++u){var c=a[u];d.push(new s(c.html,c.showOnScreen))}}var m=h._root.createBoundingVolume(t.root.boundingVolume,y.IDENTITY).boundingSphere.center,g=h._ellipsoid.cartesianToCartographic(m);o(g)&&g.height>e._defaultMinTerrainHeight&&(h._initialClippingPlanesOriginMatrix=S.eastNorthUpToFixedFrame(m)),h._clippingPlanesOriginMatrix=y.clone(h._initialClippingPlanesOriginMatrix),h._readyPromise.resolve(h)}).otherwise(function(e){h._readyPromise.reject(e)})})}l(Z.prototype,{asset:{get:function(){if(!this.ready)throw new u("The tileset is not loaded.  Use PGEarth3DTileset.readyPromise or wait for PGEarth3DTileset.ready to be true.");return this._asset}},clippingPlanes:{get:function(){return this._clippingPlanes},set:function(e){k.setOwner(e,this,"_clippingPlanes")}},properties:{get:function(){if(!this.ready)throw new u("The tileset is not loaded.  Use PGEarth3DTileset.readyPromise or wait for PGEarth3DTileset.ready to be true.");return this._properties}},ready:{get:function(){return o(this._root)}},readyPromise:{get:function(){return this._readyPromise.promise}},tilesLoaded:{get:function(){return this._tilesLoaded}},url:{get:function(){return this._url}},basePath:{get:function(){return h("PGEarth3DTileset.basePath","PGEarth3DTileset.basePath has been deprecated. All tiles are relative to the url of the tileset JSON file that contains them. Use the url property instead."),this._basePath}},style:{get:function(){return this._styleEngine.style},set:function(e){this._styleEngine.style=e}},maximumScreenSpaceError:{get:function(){return this._maximumScreenSpaceError},set:function(e){n.typeOf.number.greaterThanOrEquals("maximumScreenSpaceError",e,0),this._maximumScreenSpaceError=e}},maximumMemoryUsage:{get:function(){return this._maximumMemoryUsage},set:function(e){n.typeOf.number.greaterThanOrEquals("value",e,0),this._maximumMemoryUsage=e}},root:{get:function(){if(!this.ready)throw new u("The tileset is not loaded.  Use PGEarth3DTileset.readyPromise or wait for PGEarth3DTileset.ready to be true.");return this._root}},boundingSphere:{get:function(){if(!this.ready)throw new u("The tileset is not loaded.  Use PGEarth3DTileset.readyPromise or wait for PGEarth3DTileset.ready to be true.");return this._root.updateTransform(this._modelMatrix),this._root.boundingSphere}},modelMatrix:{get:function(){return this._modelMatrix},set:function(e){this._modelMatrix=y.clone(e,this._modelMatrix)}},timeSinceLoad:{get:function(){return this._timeSinceLoad}},totalMemoryUsageInBytes:{get:function(){var e=this._statistics;return e.texturesByteLength+e.geometryByteLength+e.batchTableByteLength}},clippingPlanesOriginMatrix:{get:function(){return o(this._clippingPlanesOriginMatrix)?(this._clippingPlanesOriginMatrixDirty&&(y.multiply(this.root.computedTransform,this._initialClippingPlanesOriginMatrix,this._clippingPlanesOriginMatrix),this._clippingPlanesOriginMatrixDirty=!1),this._clippingPlanesOriginMatrix):y.IDENTITY}},styleEngine:{get:function(){return this._styleEngine}},statistics:{get:function(){return this._statistics}},classificationType:{get:function(){return this._classificationType}},ellipsoid:{get:function(){return this._ellipsoid}},foveatedConeSize:{get:function(){return this._foveatedConeSize},set:function(e){n.typeOf.number.greaterThanOrEquals("foveatedConeSize",e,0),n.typeOf.number.lessThanOrEquals("foveatedConeSize",e,1),this._foveatedConeSize=e}},foveatedMinimumScreenSpaceErrorRelaxation:{get:function(){return this._foveatedMinimumScreenSpaceErrorRelaxation},set:function(e){n.typeOf.number.greaterThanOrEquals("foveatedMinimumScreenSpaceErrorRelaxation",e,0),n.typeOf.number.lessThanOrEquals("foveatedMinimumScreenSpaceErrorRelaxation",e,this.maximumScreenSpaceError),this._foveatedMinimumScreenSpaceErrorRelaxation=e}},extras:{get:function(){if(!this.ready)throw new u("The tileset is not loaded.  Use PGEarth3DTileset.readyPromise or wait for PGEarth3DTileset.ready to be true.");return this._extras}},imageBasedLightingFactor:{get:function(){return this._imageBasedLightingFactor},set:function(e){n.typeOf.object("imageBasedLightingFactor",e),n.typeOf.number.greaterThanOrEquals("imageBasedLightingFactor.x",e.x,0),n.typeOf.number.lessThanOrEquals("imageBasedLightingFactor.x",e.x,1),n.typeOf.number.greaterThanOrEquals("imageBasedLightingFactor.y",e.y,0),n.typeOf.number.lessThanOrEquals("imageBasedLightingFactor.y",e.y,1),t.clone(e,this._imageBasedLightingFactor)}}}),Z.loadJson=function(e){return v.createIfNeeded(e).fetchJson()},Z.prototype.makeStyleDirty=function(){this._styleEngine.makeDirty()},Z.prototype.loadTileset=function(e,t,i){var r=t.asset;if(!o(r))throw new b("Tileset must have an asset property.");if("0.0"!==r.version&&"1.0"!==r.version)throw new b("The tileset must be 3D Tiles version 0.0 or 1.0.");var n=this._statistics,s=r.tilesetVersion;o(s)?(this._basePath+="?v="+s,e.setQueryParameters({v:s})):delete e.queryParameters.v;var a=new D(this,e,t.root,i);o(i)&&(i.children.push(a),a._depth=i._depth+1);var l=[];for(l.push(a);l.length>0;){var h=l.pop();++n.numberOfTilesTotal,this._allTilesAdditive=this._allTilesAdditive&&h.refine===R.ADD;var d=h._header.children;if(o(d))for(var u=d.length,c=0;c<u;++c){var m=d[c],g=new D(this,e,m,h);h.children.push(g),g._depth=h._depth+1,l.push(g)}this._cullWithChildrenBounds&&w.checkChildrenWithinParent(h)}return a};var $=new i,ee=new r,te=new y,ie=new i,re=new i,ne=new i;function se(e,t){if(!t.hasEmptyContent){var i=e._statistics,r=t.contentExpired;t.requestContent()?(r&&(t.hasTilesetContent?function(e,t){var i=t,r=me;r.push(t);for(;r.length>0;){for(var n=(t=r.pop()).children,s=n.length,a=0;a<s;++a)r.push(n[a]);t!==i&&(pe(e,t),--e._statistics.numberOfTilesTotal)}i.children=[]}(e,t):(i.decrementLoadCounts(t.content),--i.numberOfTilesWithContentReady)),++i.numberOfPendingRequests,e._requestedTilesInFlight.push(t),t.contentReadyToProcessPromise.then(function(e,t){return function(){e._processingQueue.push(t),--e._statistics.numberOfPendingRequests,++e._statistics.numberOfTilesProcessing}}(e,t)),t.contentReadyPromise.then(function(e,t){return function(){--e._statistics.numberOfTilesProcessing,t.hasTilesetContent||(e._statistics.incrementLoadCounts(t.content),++e._statistics.numberOfTilesWithContentReady,++e._statistics.numberOfLoadedTilesTotal,e._cache.add(t)),e.tileLoad.raiseEvent(t)}}(e,t)).otherwise(function(e,t){return function(i){e._processingQueue.indexOf(t)>=0?--e._statistics.numberOfTilesProcessing:--e._statistics.numberOfPendingRequests;var r=t._contentResource.url,n=o(i.message)?i.message:i.toString();e.tileFailed.numberOfListeners>0?e.tileFailed.raiseEvent({url:r,message:n}):(console.log("A 3D tile failed to load: "+r),console.log("Error: "+n))}}(e,t))):++i.numberOfAttemptedRequests}}function ae(e,t){return e._priority-t._priority}Z.prototype.postPassesUpdate=function(e){this.ready&&(!function(e,t){for(var i=e._requestedTilesInFlight,r=0,n=i.length,s=0;s<n;++s){var a=i[s],o=t.frameNumber-a._touchedFrame>=1;a._contentState===x.LOADING?o?(a._request.cancel(),++r):r>0&&(i[s-r]=a):++r}i.length-=r}(this,e),function(e,t){var i=e._statistics,r=e._statisticsLast,n=i.numberOfPendingRequests,s=i.numberOfTilesProcessing,a=r.numberOfPendingRequests,o=r.numberOfTilesProcessing;V.clone(i,r);var l=n!==a||s!==o;l&&t.afterRender.push(function(){e.loadProgress.raiseEvent(n,s)});e._tilesLoaded=0===i.numberOfPendingRequests&&0===i.numberOfTilesProcessing&&0===i.numberOfAttemptedRequests,l&&e._tilesLoaded&&(t.afterRender.push(function(){e.allTilesLoaded.raiseEvent()}),e._initialTilesLoaded||(e._initialTilesLoaded=!0,t.afterRender.push(function(){e.initialTilesLoaded.raiseEvent()})))}(this,e),this._cache.unloadTiles(this,ge))},Z.prototype.prePassesUpdate=function(e){if(this.ready){!function(e,t){!function(e){for(var t=e._processingQueue,i=t.length,r=0,n=0;n<i;++n){var s=t[n];s._contentState===x.PROCESSING?r>0&&(t[n-r]=s):++r}t.length-=r}(e);for(var i=e._processingQueue,r=i.length,n=0;n<r;++n)i[n].process(e,t)}(this,e);var t=this._clippingPlanes;this._clippingPlanesOriginMatrixDirty=!0,o(t)&&t.enabled&&t.update(e),o(this._loadTimestamp)||(this._loadTimestamp=p.clone(e.time)),this._timeSinceLoad=Math.max(1e3*p.secondsDifference(e.time,this._loadTimestamp),0),this._skipLevelOfDetail=this.skipLevelOfDetail&&!o(this._classificationType)&&!this._disableSkipLevelOfDetail&&!this._allTilesAdditive,this.dynamicScreenSpaceError&&function(e,t){var n,s,a,o,l,h=t.camera,d=e._root,u=d.contentBoundingVolume;if(u instanceof Q)n=i.normalize(h.positionWC,$),s=h.directionWC,a=h.positionCartographic.height,o=u.minimumHeight,l=u.maximumHeight;else{var c=y.inverseTransformation(d.computedTransform,te),m=t.mapProjection.ellipsoid,g=u.boundingVolume,p=y.multiplyByPoint(c,g.center,ie);if(i.magnitude(p)>m.minimumRadius){var f=r.fromCartesian(p,m,ee);n=i.normalize(h.positionWC,$),s=h.directionWC,a=h.positionCartographic.height,o=0,l=2*f.height}else{var v=y.multiplyByPoint(c,h.positionWC,re);if(n=i.UNIT_Z,s=y.multiplyByPointAsVector(c,h.directionWC,ne),s=i.normalize(s,s),a=v.z,u instanceof j){var b=d._header.boundingVolume.box[11];o=p.z-b,l=p.z+b}else if(u instanceof J){var S=g.radius;o=p.z-S,l=p.z+S}}}var T=o+(l-o)*e.dynamicScreenSpaceErrorHeightFalloff,E=l,P=_.clamp((a-T)/(E-T),0,1),C=1-Math.abs(i.dot(s,n));C*=1-P;var L=e.dynamicScreenSpaceErrorDensity;L*=C,e._dynamicScreenSpaceErrorComputedDensity=L}(this,e),e.newFrame&&this._cache.reset()}};var oe=new i,le={maximumFractionDigits:3};function he(e){var t=e/1048576;return t<1?t.toLocaleString(void 0,le):Math.round(t).toLocaleString()}function de(e){var t=e.boundingVolume.boundingVolume,r=t.halfAxes,n=t.radius,s=i.clone(t.center,oe);if(o(r))s.x+=.75*(r[0]+r[3]+r[6]),s.y+=.75*(r[1]+r[4]+r[7]),s.z+=.75*(r[2]+r[5]+r[8]);else if(o(n)){var a=i.normalize(t.center,oe);a=i.multiplyByScalar(a,.75*n,oe),s=i.add(a,t.center,oe)}return s}function ue(e,t,i){var r="",n=0;(t.debugShowGeometricError&&(r+="\nGeometric error: "+e.geometricError,n++),t.debugShowRenderingStatistics)&&(r+="\nCommands: "+e.commandsLength,n++,e.content.pointsLength>0&&(r+="\nPoints: "+e.content.pointsLength,n++),e.content.trianglesLength>0&&(r+="\nTriangles: "+e.content.trianglesLength,n++),r+="\nFeatures: "+e.content.featuresLength,n++);t.debugShowMemoryUsage&&(r+="\nTexture Memory: "+he(e.content.texturesByteLength),r+="\nGeometry Memory: "+he(e.content.geometryByteLength),n+=2),t.debugShowUrl&&(r+="\nUrl: "+e._header.content.uri,n++);var s={text:r.substring(1),position:i,font:19-n+"px sans-serif",showBackground:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY};return t._tileDebugLabels.add(s)}function ce(e,i,r){e._styleEngine.applyStyle(e,i);var n,s,a=e._statistics,l=i.commandList,h=l.length,d=e._selectedTiles,u=d.length,c=e._emptyTiles,m=c.length,g=e.tileVisible,p=e._skipLevelOfDetail&&e._hasMixedContent&&i.context.stencilBuffer&&u>0;e._backfaceCommands.length=0,p&&(o(e._stencilClearCommand)||(e._stencilClearCommand=new T({stencil:0,pass:E.PGEARTH_3D_TILE,renderState:P.fromCache({stencilMask:X.SKIP_LOD_MASK})})),l.push(e._stencilClearCommand));var f=l.length;for(n=0;n<u;++n)s=d[n],r&&g.raiseEvent(s),s.update(e,i),a.incrementSelectionCounts(s.content),++a.selected;for(n=0;n<m;++n)(s=c[n]).update(e,i);var _=l.length-f;if(e._backfaceCommands.trim(),p){var y=e._backfaceCommands.values,v=y.length;for(l.length+=v,n=_-1;n>=0;--n)l[f+v+n]=l[f+n];for(n=0;n<v;++n)l[f+n]=y[n]}_=l.length-h,a.numberOfCommands=_,r&&e.pointCloudShading.attenuation&&e.pointCloudShading.eyeDomeLighting&&_>0&&e._pointCloudEyeDomeLighting.update(i,h,e.pointCloudShading),r&&(e.debugShowGeometricError||e.debugShowRenderingStatistics||e.debugShowMemoryUsage||e.debugShowUrl?(o(e._tileDebugLabels)||(e._tileDebugLabels=new q),function(e,i){var r,n,s=e._selectedTiles,a=s.length,l=e._emptyTiles,h=l.length;if(e._tileDebugLabels.removeAll(),e.debugPickedTileLabelOnly){if(o(e.debugPickedTile)){var d=o(e.debugPickPosition)?e.debugPickPosition:de(e.debugPickedTile);ue(e.debugPickedTile,e,d).pixelOffset=new t(15,-15)}}else{for(r=0;r<a;++r)ue(n=s[r],e,de(n));for(r=0;r<h;++r)(n=l[r]).hasTilesetContent&&ue(n,e,de(n))}e._tileDebugLabels.update(i)}(e,i)):e._tileDebugLabels=e._tileDebugLabels&&e._tileDebugLabels.destroy())}var me=[];function ge(e,t){e.tileUnload.raiseEvent(t),e._statistics.decrementLoadCounts(t.content),--e._statistics.numberOfTilesWithContentReady,t.unloadContent()}function pe(e,t){e._cache.unloadTile(e,t,ge),t.destroy()}function fe(e,t,i,r){if(t.mode===H.MORPHING)return!1;if(!e.ready)return!1;var n=e._statistics;n.clear();var s=r.isRender;++e._updatedVisibilityFrame,function(e){e._heatmap.resetMinimumMaximum(),e._minimumPriority.depth=Number.MAX_VALUE,e._maximumPriority.depth=-Number.MAX_VALUE,e._minimumPriority.foveatedFactor=Number.MAX_VALUE,e._maximumPriority.foveatedFactor=-Number.MAX_VALUE,e._minimumPriority.distance=Number.MAX_VALUE,e._maximumPriority.distance=-Number.MAX_VALUE,e._minimumPriority.reverseScreenSpaceError=Number.MAX_VALUE,e._maximumPriority.reverseScreenSpaceError=-Number.MAX_VALUE}(e);var a=r.traversal.selectTiles(e,t);if(r.requestTiles&&function(e,t){var i=e._requestedTiles,r=i.length;i.sort(ae);for(var n=0;n<r;++n)se(e,i[n])}(e),ce(e,t,s),V.clone(n,i),s){var l=e._credits;if(o(l)&&0!==n.selected)for(var h=l.length,d=0;d<h;++d)t.creditDisplay.addCredit(l[d])}return a}return Z.prototype.trimLoadedTiles=function(){this._cache.trim()},Z.prototype.update=function(e){this.updateForPass(e,e.tilesetPassState)},Z.prototype.updateForPass=function(e,t){n.typeOf.object("frameState",e),n.typeOf.object("tilesetPassState",t);var i=t.pass;if(!(i===M.PRELOAD&&(!this.preloadWhenHidden||this.show)||i===M.PRELOAD_FLIGHT&&(!this.preloadFlightDestinations||!this.show&&!this.preloadWhenHidden)||i===M.REQUEST_RENDER_MODE_DEFER_CHECK&&!this.cullRequestsWhileMoving&&this.foveatedTimeDelay<=0)){var r=e.commandList,s=e.camera,o=e.cullingVolume;t.ready=!1;var l=M.getPassOptions(i),h=l.ignoreCommands,d=a(t.commandList,r),u=d.length;e.commandList=d,e.camera=a(t.camera,s),e.cullingVolume=a(t.cullingVolume,o);var c=this._statisticsPerPass[i];(this.show||h)&&(this._pass=i,t.ready=fe(this,e,c,l)),h&&(d.length=u),e.commandList=r,e.camera=s,e.cullingVolume=o}},Z.prototype.hasExtension=function(e){return!!o(this._extensionsUsed)&&this._extensionsUsed.indexOf(e)>-1},Z.prototype.isDestroyed=function(){return!1},Z.prototype.destroy=function(){if(this._tileDebugLabels=this._tileDebugLabels&&this._tileDebugLabels.destroy(),this._clippingPlanes=this._clippingPlanes&&this._clippingPlanes.destroy(),o(this._root)){var e=me;for(e.push(this._root);e.length>0;){var t=e.pop();t.destroy();for(var i=t.children,r=i.length,n=0;n<r;++n)e.push(i[n])}}return this._root=void 0,d(this)},Z});