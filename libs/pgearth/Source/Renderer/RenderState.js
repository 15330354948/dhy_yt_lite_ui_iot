define(["../Core/BoundingRectangle","../Core/Color","../Core/defaultValue","../Core/defined","../Core/DeveloperError","../Core/WebGLConstants","../Core/WindingOrder","./ContextLimits","./freezeRenderState","../extends/core/ExpendUtil"],function(e,n,t,i,a,r,o,s,l,c){"use strict";function d(e){return e===r.FUNC_ADD||e===r.FUNC_SUBTRACT||e===r.FUNC_REVERSE_SUBTRACT||e===r.MIN||e===r.MAX}function h(e){return e===r.ZERO||e===r.ONE||e===r.SRC_COLOR||e===r.ONE_MINUS_SRC_COLOR||e===r.DST_COLOR||e===r.ONE_MINUS_DST_COLOR||e===r.SRC_ALPHA||e===r.ONE_MINUS_SRC_ALPHA||e===r.DST_ALPHA||e===r.ONE_MINUS_DST_ALPHA||e===r.CONSTANT_COLOR||e===r.ONE_MINUS_CONSTANT_COLOR||e===r.CONSTANT_ALPHA||e===r.ONE_MINUS_CONSTANT_ALPHA||e===r.SRC_ALPHA_SATURATE}function f(e){return e===r.NEVER||e===r.LESS||e===r.EQUAL||e===r.LEQUAL||e===r.GREATER||e===r.NOTEQUAL||e===r.GEQUAL||e===r.ALWAYS}function u(e){return e===r.ZERO||e===r.KEEP||e===r.REPLACE||e===r.INCR||e===r.DECR||e===r.INVERT||e===r.INCR_WRAP||e===r.DECR_WRAP}function p(l){var p,b,g=t(l,{}),T=t(g.cull,{}),S=t(g.polygonOffset,{}),w=t(g.scissorTest,{}),O=t(w.rectangle,{}),v=t(g.depthRange,{}),R=t(g.depthTest,{}),A=t(g.colorMask,{}),C=t(g.blending,{}),E=t(C.color,{}),k=t(g.stencilTest,{}),m=t(k.frontOperation,{}),F=t(k.backOperation,{}),N=t(g.sampleCoverage,{}),_=g.viewport;if(this.frontFace=t(g.frontFace,o.COUNTER_CLOCKWISE),this.cull={enabled:t(c.underEarth.cullFace,t(T.enabled,!1)),face:t(T.face,r.BACK)},this.lineWidth=t(g.lineWidth,1),this.polygonOffset={enabled:t(S.enabled,!1),factor:t(S.factor,0),units:t(S.units,0)},this.scissorTest={enabled:t(w.enabled,!1),rectangle:e.clone(O)},this.depthRange={near:t(v.near,0),far:t(v.far,1)},this.depthTest={enabled:t(R.enabled,!1),func:t(R.func,r.LESS)},this.colorMask={red:t(A.red,!0),green:t(A.green,!0),blue:t(A.blue,!0),alpha:t(A.alpha,!0)},this.depthMask=t(g.depthMask,!0),this.stencilMask=t(g.stencilMask,-1),this.blending={enabled:t(C.enabled,!1),color:new n(t(E.red,0),t(E.green,0),t(E.blue,0),t(E.alpha,0)),equationRgb:t(C.equationRgb,r.FUNC_ADD),equationAlpha:t(C.equationAlpha,r.FUNC_ADD),functionSourceRgb:t(C.functionSourceRgb,r.ONE),functionSourceAlpha:t(C.functionSourceAlpha,r.ONE),functionDestinationRgb:t(C.functionDestinationRgb,r.ZERO),functionDestinationAlpha:t(C.functionDestinationAlpha,r.ZERO)},this.stencilTest={enabled:t(k.enabled,!1),frontFunction:t(k.frontFunction,r.ALWAYS),backFunction:t(k.backFunction,r.ALWAYS),reference:t(k.reference,0),mask:t(k.mask,-1),frontOperation:{fail:t(m.fail,r.KEEP),zFail:t(m.zFail,r.KEEP),zPass:t(m.zPass,r.KEEP)},backOperation:{fail:t(F.fail,r.KEEP),zFail:t(F.zFail,r.KEEP),zPass:t(F.zPass,r.KEEP)}},this.sampleCoverage={enabled:t(N.enabled,!1),value:t(N.value,1),invert:t(N.invert,!1)},this.viewport=i(_)?new e(_.x,_.y,_.width,_.height):void 0,this.lineWidth<s.minimumAliasedLineWidth||this.lineWidth>s.maximumAliasedLineWidth)throw new a("renderState.lineWidth is out of range.  Check minimumAliasedLineWidth and maximumAliasedLineWidth.");if(!o.validate(this.frontFace))throw new a("Invalid renderState.frontFace.");if((p=this.cull.face)!==r.FRONT&&p!==r.BACK&&p!==r.FRONT_AND_BACK)throw new a("Invalid renderState.cull.face.");if(this.scissorTest.rectangle.width<0||this.scissorTest.rectangle.height<0)throw new a("renderState.scissorTest.rectangle.width and renderState.scissorTest.rectangle.height must be greater than or equal to zero.");if(this.depthRange.near>this.depthRange.far)throw new a("renderState.depthRange.near can not be greater than renderState.depthRange.far.");if(this.depthRange.near<0)throw new a("renderState.depthRange.near must be greater than or equal to zero.");if(this.depthRange.far>1)throw new a("renderState.depthRange.far must be less than or equal to one.");if((b=this.depthTest.func)!==r.NEVER&&b!==r.LESS&&b!==r.EQUAL&&b!==r.LEQUAL&&b!==r.GREATER&&b!==r.NOTEQUAL&&b!==r.GEQUAL&&b!==r.ALWAYS)throw new a("Invalid renderState.depthTest.func.");if(this.blending.color.red<0||this.blending.color.red>1||this.blending.color.green<0||this.blending.color.green>1||this.blending.color.blue<0||this.blending.color.blue>1||this.blending.color.alpha<0||this.blending.color.alpha>1)throw new a("renderState.blending.color components must be greater than or equal to zero and less than or equal to one.");if(!d(this.blending.equationRgb))throw new a("Invalid renderState.blending.equationRgb.");if(!d(this.blending.equationAlpha))throw new a("Invalid renderState.blending.equationAlpha.");if(!h(this.blending.functionSourceRgb))throw new a("Invalid renderState.blending.functionSourceRgb.");if(!h(this.blending.functionSourceAlpha))throw new a("Invalid renderState.blending.functionSourceAlpha.");if(!h(this.blending.functionDestinationRgb))throw new a("Invalid renderState.blending.functionDestinationRgb.");if(!h(this.blending.functionDestinationAlpha))throw new a("Invalid renderState.blending.functionDestinationAlpha.");if(!f(this.stencilTest.frontFunction))throw new a("Invalid renderState.stencilTest.frontFunction.");if(!f(this.stencilTest.backFunction))throw new a("Invalid renderState.stencilTest.backFunction.");if(!u(this.stencilTest.frontOperation.fail))throw new a("Invalid renderState.stencilTest.frontOperation.fail.");if(!u(this.stencilTest.frontOperation.zFail))throw new a("Invalid renderState.stencilTest.frontOperation.zFail.");if(!u(this.stencilTest.frontOperation.zPass))throw new a("Invalid renderState.stencilTest.frontOperation.zPass.");if(!u(this.stencilTest.backOperation.fail))throw new a("Invalid renderState.stencilTest.backOperation.fail.");if(!u(this.stencilTest.backOperation.zFail))throw new a("Invalid renderState.stencilTest.backOperation.zFail.");if(!u(this.stencilTest.backOperation.zPass))throw new a("Invalid renderState.stencilTest.backOperation.zPass.");if(i(this.viewport)){if(this.viewport.width<0)throw new a("renderState.viewport.width must be greater than or equal to zero.");if(this.viewport.height<0)throw new a("renderState.viewport.height must be greater than or equal to zero.");if(this.viewport.width>s.maximumViewportWidth)throw new a("renderState.viewport.width must be less than or equal to the maximum viewport width ("+s.maximumViewportWidth.toString()+").  Check maximumViewportWidth.");if(this.viewport.height>s.maximumViewportHeight)throw new a("renderState.viewport.height must be less than or equal to the maximum viewport height ("+s.maximumViewportHeight.toString()+").  Check maximumViewportHeight.")}this.id=0,this._applyFunctions=[]}var b=0,g={};function T(e,n,t){t?e.enable(n):e.disable(n)}function S(e,n){e.frontFace(n.frontFace)}function w(e,n){var t=n.cull,i=t.enabled;T(e,e.CULL_FACE,i),i&&e.cullFace(t.face)}function O(e,n){e.lineWidth(n.lineWidth)}function v(e,n){var t=n.polygonOffset,i=t.enabled;T(e,e.POLYGON_OFFSET_FILL,i),i&&e.polygonOffset(t.factor,t.units)}function R(e,n,t){var a=n.scissorTest,r=i(t.scissorTest)?t.scissorTest.enabled:a.enabled;if(T(e,e.SCISSOR_TEST,r),r){var o=i(t.scissorTest)?t.scissorTest.rectangle:a.rectangle;e.scissor(o.x,o.y,o.width,o.height)}}function A(e,n){var t=n.depthRange;e.depthRange(t.near,t.far)}function C(e,n){var t=n.depthTest,i=t.enabled;T(e,e.DEPTH_TEST,i),i&&e.depthFunc(t.func)}function E(e,n){var t=n.colorMask;e.colorMask(t.red,t.green,t.blue,t.alpha)}function k(e,n){e.depthMask(n.depthMask)}function m(e,n){e.stencilMask(n.stencilMask)}function F(e,n,t){var a=n.blending,r=i(t.blendingEnabled)?t.blendingEnabled:a.enabled;T(e,e.BLEND,r),r&&(!function(e,n){e.blendColor(n.red,n.green,n.blue,n.alpha)}(e,a.color),e.blendEquationSeparate(a.equationRgb,a.equationAlpha),e.blendFuncSeparate(a.functionSourceRgb,a.functionDestinationRgb,a.functionSourceAlpha,a.functionDestinationAlpha))}function N(e,n){var t=n.stencilTest,i=t.enabled;if(T(e,e.STENCIL_TEST,i),i){var a=t.frontFunction,r=t.backFunction,o=t.reference,s=t.mask;e.stencilFunc(a,o,s),e.stencilFuncSeparate(e.BACK,r,o,s),e.stencilFuncSeparate(e.FRONT,a,o,s);var l=t.frontOperation,c=l.fail,d=l.zFail,h=l.zPass;e.stencilOpSeparate(e.FRONT,c,d,h);var f=t.backOperation,u=f.fail,p=f.zFail,b=f.zPass;e.stencilOpSeparate(e.BACK,u,p,b)}}function _(e,n){var t=n.sampleCoverage,i=t.enabled;T(e,e.SAMPLE_COVERAGE,i),i&&e.sampleCoverage(t.value,t.invert)}p.fromCache=function(e){var n=JSON.stringify(e),t=g[n];if(i(t))return++t.referenceCount,t.state;var a=new p(e),r=JSON.stringify(a);return t=g[r],i(t)||(a.id=b++,t={referenceCount:0,state:a=l(a)},g[r]=t),++t.referenceCount,g[n]={referenceCount:1,state:t.state},t.state},p.removeFromCache=function(e){var n=new p(e),t=JSON.stringify(n),a=g[t],r=JSON.stringify(e),o=g[r];i(o)&&(--o.referenceCount,0===o.referenceCount&&(delete g[r],i(a)&&--a.referenceCount)),i(a)&&0===a.referenceCount&&delete g[t]},p.getCache=function(){return g},p.clearCache=function(){g={}};var L=new e;function M(e,n,a){var r=t(n.viewport,a.viewport);i(r)||((r=L).width=a.context.drawingBufferWidth,r.height=a.context.drawingBufferHeight),a.context.uniformState.viewport=r,e.viewport(r.x,r.y,r.width,r.height)}return p.apply=function(e,n,t){S(e,n),w(e,n),O(e,n),v(e,n),A(e,n),C(e,n),E(e,n),k(e,n),m(e,n),N(e,n),_(e,n),R(e,n,t),F(e,n,t),M(e,n,t)},p.partialApply=function(e,n,t,a,r,o){if(n!==t){var s=t._applyFunctions[n.id];i(s)||(s=function(e,n){var t=[];return e.frontFace!==n.frontFace&&t.push(S),e.cull.enabled===n.cull.enabled&&e.cull.face===n.cull.face||t.push(w),e.lineWidth!==n.lineWidth&&t.push(O),e.polygonOffset.enabled===n.polygonOffset.enabled&&e.polygonOffset.factor===n.polygonOffset.factor&&e.polygonOffset.units===n.polygonOffset.units||t.push(v),e.depthRange.near===n.depthRange.near&&e.depthRange.far===n.depthRange.far||t.push(A),e.depthTest.enabled===n.depthTest.enabled&&e.depthTest.func===n.depthTest.func||t.push(C),e.colorMask.red===n.colorMask.red&&e.colorMask.green===n.colorMask.green&&e.colorMask.blue===n.colorMask.blue&&e.colorMask.alpha===n.colorMask.alpha||t.push(E),e.depthMask!==n.depthMask&&t.push(k),e.stencilMask!==n.stencilMask&&t.push(m),e.stencilTest.enabled===n.stencilTest.enabled&&e.stencilTest.frontFunction===n.stencilTest.frontFunction&&e.stencilTest.backFunction===n.stencilTest.backFunction&&e.stencilTest.reference===n.stencilTest.reference&&e.stencilTest.mask===n.stencilTest.mask&&e.stencilTest.frontOperation.fail===n.stencilTest.frontOperation.fail&&e.stencilTest.frontOperation.zFail===n.stencilTest.frontOperation.zFail&&e.stencilTest.backOperation.fail===n.stencilTest.backOperation.fail&&e.stencilTest.backOperation.zFail===n.stencilTest.backOperation.zFail&&e.stencilTest.backOperation.zPass===n.stencilTest.backOperation.zPass||t.push(N),e.sampleCoverage.enabled===n.sampleCoverage.enabled&&e.sampleCoverage.value===n.sampleCoverage.value&&e.sampleCoverage.invert===n.sampleCoverage.invert||t.push(_),t}(n,t),t._applyFunctions[n.id]=s);for(var l=s.length,c=0;c<l;++c)s[c](e,t)}((i(a.scissorTest)?a.scissorTest:n.scissorTest)!==(i(r.scissorTest)?r.scissorTest:t.scissorTest)||o)&&R(e,t,r);var d=i(a.blendingEnabled)?a.blendingEnabled:n.blending.enabled,h=i(r.blendingEnabled)?r.blendingEnabled:t.blending.enabled;(d!==h||h&&n.blending!==t.blending)&&F(e,t,r),n===t&&a===r&&a.context===r.context||M(e,t,r)},p.getState=function(t){if(!i(t))throw new a("renderState is required.");return{frontFace:t.frontFace,cull:{enabled:t.cull.enabled,face:t.cull.face},lineWidth:t.lineWidth,polygonOffset:{enabled:t.polygonOffset.enabled,factor:t.polygonOffset.factor,units:t.polygonOffset.units},scissorTest:{enabled:t.scissorTest.enabled,rectangle:e.clone(t.scissorTest.rectangle)},depthRange:{near:t.depthRange.near,far:t.depthRange.far},depthTest:{enabled:t.depthTest.enabled,func:t.depthTest.func},colorMask:{red:t.colorMask.red,green:t.colorMask.green,blue:t.colorMask.blue,alpha:t.colorMask.alpha},depthMask:t.depthMask,stencilMask:t.stencilMask,blending:{enabled:t.blending.enabled,color:n.clone(t.blending.color),equationRgb:t.blending.equationRgb,equationAlpha:t.blending.equationAlpha,functionSourceRgb:t.blending.functionSourceRgb,functionSourceAlpha:t.blending.functionSourceAlpha,functionDestinationRgb:t.blending.functionDestinationRgb,functionDestinationAlpha:t.blending.functionDestinationAlpha},stencilTest:{enabled:t.stencilTest.enabled,frontFunction:t.stencilTest.frontFunction,backFunction:t.stencilTest.backFunction,reference:t.stencilTest.reference,mask:t.stencilTest.mask,frontOperation:{fail:t.stencilTest.frontOperation.fail,zFail:t.stencilTest.frontOperation.zFail,zPass:t.stencilTest.frontOperation.zPass},backOperation:{fail:t.stencilTest.backOperation.fail,zFail:t.stencilTest.backOperation.zFail,zPass:t.stencilTest.backOperation.zPass}},sampleCoverage:{enabled:t.sampleCoverage.enabled,value:t.sampleCoverage.value,invert:t.sampleCoverage.invert},viewport:i(t.viewport)?e.clone(t.viewport):void 0}},p});