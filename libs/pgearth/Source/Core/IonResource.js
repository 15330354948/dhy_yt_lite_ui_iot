define(["../ThirdParty/Uri","../ThirdParty/when","./Check","./Credit","./defaultValue","./defined","./defineProperties","./Ion","./Resource","./RuntimeError"],function(e,t,n,r,i,o,s,c,a,d){"use strict";function p(t,r){var i;n.defined("endpoint",t),n.defined("endpointResource",r);var s=t.externalType,c=o(s);if(c){if("3DTILES"!==s&&"STK_TERRAIN_SERVER"!==s)throw new d("Ion.createResource does not support external imagery assets; use IonImageryProvider instead.");i={url:t.options.url}}else i={url:t.url,retryAttempts:1,retryCallback:u};a.call(this,i),this._ionEndpoint=t,this._ionEndpointDomain=c?void 0:new e(t.url).authority,this._ionEndpointResource=r,this._ionRoot=void 0,this._pendingPromise=void 0,this._credits=void 0,this._isExternal=c}function u(e,n){var r=i(e._ionRoot,e),s=r._ionEndpointResource;return o(n)&&(401===n.statusCode||n.target instanceof Image)?(o(r._pendingPromise)||(r._pendingPromise=s.fetchJson().then(function(e){return r._ionEndpoint=e,e}).always(function(e){return r._pendingPromise=void 0,e})),r._pendingPromise.then(function(t){return e._ionEndpoint=t,!0})):t.resolve(!1)}return o(Object.create)&&(p.prototype=Object.create(a.prototype),p.prototype.constructor=p),p.fromAssetId=function(e,t){var n=p._createEndpointResource(e,t);return n.fetchJson().then(function(e){return new p(e,n)})},s(p.prototype,{credits:{get:function(){return o(this._ionRoot)?this._ionRoot.credits:o(this._credits)?this._credits:(this._credits=p.getCreditsFromEndpoint(this._ionEndpoint,this._ionEndpointResource),this._credits)}}}),p.getCreditsFromEndpoint=function(e,t){var n=e.attributions.map(r.getIonCredit),i=c.getDefaultTokenCredit(t.queryParameters.access_token);return o(i)&&n.push(r.clone(i)),n},p.prototype.clone=function(e){var t=i(this._ionRoot,this);return o(e)||(e=new p(t._ionEndpoint,t._ionEndpointResource)),(e=a.prototype.clone.call(this,e))._ionRoot=t,e._isExternal=this._isExternal,e},p.prototype.fetchImage=function(e){if(!this._isExternal){var t=e;e={preferBlob:!0},o(t)&&(e.flipY=t.flipY,e.preferImageBitmap=t.preferImageBitmap)}return a.prototype.fetchImage.call(this,e)},p.prototype._makeRequest=function(t){if(this._isExternal||new e(this.url).authority!==this._ionEndpointDomain)return a.prototype._makeRequest.call(this,t);var n="*/*;access_token="+this._ionEndpoint.accessToken,r=n,i=this.headers;return o(i)&&o(i.Accept)&&(r=i.Accept+","+n),o(t.headers)?o(t.headers.Accept)?t.headers.Accept=t.headers.Accept+","+n:t.headers.Accept=r:t.headers={Accept:r},a.prototype._makeRequest.call(this,t)},p._createEndpointResource=function(e,t){n.defined("assetId",e),t=i(t,i.EMPTY_OBJECT);var r=i(t.server,c.defaultServer),s=i(t.accessToken,c.defaultAccessToken);r=a.createIfNeeded(r);var d={url:"v1/assets/"+e+"/endpoint"};return o(s)&&(d.queryParameters={access_token:s}),r.getDerivedResource(d)},p});