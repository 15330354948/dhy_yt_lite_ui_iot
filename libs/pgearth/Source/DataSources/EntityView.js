define(["../Core/Cartesian3","../Core/Check","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/Ellipsoid","../Core/HeadingPitchRange","../Core/JulianDate","../Core/Math","../Core/Matrix3","../Core/Matrix4","../Core/Transforms","../Scene/SceneMode"],function(e,t,i,o,n,s,r,a,l,d,f,u,c){"use strict";var m=new d,h=new d,p=new d,v=new f,y=new e,_=new e,g=new e,E=new e,w=new e,C=new e,x=new a,S=1.25;function D(o,n,r){t.defined("entity",o),t.defined("scene",n),this.entity=o,this.scene=n,this.ellipsoid=i(r,s.WGS84),this.boundingSphere=void 0,this._lastEntity=void 0,this._mode=void 0,this._lastCartesian=new e,this._defaultOffset3D=void 0,this._offset3D=new e}n(D,{defaultOffset3D:{get:function(){return this._defaultOffset3D},set:function(t){this._defaultOffset3D=e.clone(t,new e)}}}),D.defaultOffset3D=new e(-14e3,3500,3500);var O=new r,T=new e;return D.prototype.update=function(i,n){t.defined("time",i);var s=this.scene,r=this.ellipsoid,f=s.mode;if(f!==c.MORPHING){var z=this.entity,V=z.position;if(o(V)){var M=z!==this._lastEntity,R=f!==this._mode,I=s.camera,N=M||R,P=!0;if(M){var F=z.viewFrom,B=o(F);if(!B&&o(n)){O.pitch=-l.PI_OVER_FOUR,O.range=0;var A=V.getValue(i,T);if(o(A)){var b=2-1/Math.max(1,e.magnitude(A)/r.maximumRadius);O.pitch*=b}I.viewBoundingSphere(n,O),this.boundingSphere=n,N=!1,P=!1}else B&&o(F.getValue(i,this._offset3D))||e.clone(D._defaultOffset3D,this._offset3D)}else R||this._mode===c.SCENE2D||e.clone(I.position,this._offset3D);this._lastEntity=z,this._mode=f,function(t,i,n,s,r,f,D){var O=t.scene.mode,T=r.getValue(f,t._lastCartesian);if(o(T)){var z,V,M,R,I,N,P=!1,F=!1;if(O===c.SCENE3D){a.addSeconds(f,.001,x);var B=r.getValue(x,y);if(o(B)||(a.addSeconds(f,-.001,x),B=r.getValue(x,y),F=!0),o(B)){var A,b=u.computeFixedToIcrfMatrix(f,m),L=u.computeFixedToIcrfMatrix(x,h);o(b)&&o(L)?A=d.transpose(b,p):(A=u.computeTemeToPseudoFixedMatrix(f,p),b=d.transpose(A,m),L=u.computeTemeToPseudoFixedMatrix(x,h),d.transpose(L,L));var q=d.multiplyByVector(b,T,w),G=d.multiplyByVector(L,B,C);e.subtract(q,G,E);var U=1e3*e.magnitude(E),Z=l.GRAVITATIONALPARAMETER,k=-Z/(U*U-2*Z/e.magnitude(q));k<0||k>S*D.maximumRadius?(z=_,e.normalize(T,z),e.negate(z,z),M=e.clone(e.UNIT_Z,g),V=e.cross(M,z,y),e.magnitude(V)>l.EPSILON7&&(e.normalize(z,z),e.normalize(V,V),M=e.cross(z,V,g),e.normalize(M,M),P=!0)):e.equalsEpsilon(T,B,l.EPSILON7)||(M=_,e.normalize(q,M),e.normalize(G,G),V=e.cross(M,G,g),F&&(V=e.multiplyByScalar(V,-1,V)),e.equalsEpsilon(V,e.ZERO,l.EPSILON7)||(z=e.cross(V,M,y),d.multiplyByVector(A,z,z),d.multiplyByVector(A,V,V),d.multiplyByVector(A,M,M),e.normalize(z,z),e.normalize(V,V),e.normalize(M,M),P=!0))}}o(t.boundingSphere)&&(T=t.boundingSphere.center),s&&(R=e.clone(i.position,E),I=e.clone(i.direction,w),N=e.clone(i.up,C));var H=v;P?(H[0]=z.x,H[1]=z.y,H[2]=z.z,H[3]=0,H[4]=V.x,H[5]=V.y,H[6]=V.z,H[7]=0,H[8]=M.x,H[9]=M.y,H[10]=M.z,H[11]=0,H[12]=T.x,H[13]=T.y,H[14]=T.z,H[15]=0):u.eastNorthUpToFixedFrame(T,D,H),i._setTransform(H),s&&(e.clone(R,i.position),e.clone(I,i.direction),e.clone(N,i.up),e.cross(I,N,i.right))}if(n){var J=O===c.SCENE2D||e.equals(t._offset3D,e.ZERO)?void 0:t._offset3D;i.lookAtTransform(i.transform,J)}}(this,I,N,P,V,i,r)}}},D});