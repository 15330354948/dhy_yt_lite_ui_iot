define(["../Core/Cartesian3","../Core/Color","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/deprecationWarning","../Core/destroyObject","../Core/DeveloperError","../Core/FeatureDetection","../Core/getStringFromTypedArray","../Core/Matrix4","../Core/RequestType","../Core/RuntimeError","../Core/Transforms","../Renderer/Pass","./Axis","./PGEarth3DTileBatchTable","./PGEarth3DTileFeature","./PGEarth3DTileFeatureTable","./ClassificationModel","./Model","./ModelUtility"],function(e,t,i,r,a,n,o,s,l,h,c,d,u,f,m,g,p,b,_,y,T,C,v){"use strict";if(!h.supportsTypedArrays())return{};function L(t,n,o,s,l){this._tileset=t,this._tile=n,this._resource=o,this._model=void 0,this._batchTable=void 0,this._features=void 0,this._batchIdAttributeName=void 0,this._diffuseAttributeOrUniformName={},this._rtcCenterTransform=void 0,this._contentModelMatrix=void 0,this.featurePropertiesDirty=!1,function(t,n,o){var s=t._tileset,l=t._tile,h=t._resource,m=r(o,0);o=m;var _=new Uint8Array(n),M=new DataView(n);o+=A;var U=M.getUint32(o,!0);if(1!==U)throw new f("Only Batched 3D Model version 1 is supported.  Version "+U+" is not.");o+=A;var x=M.getUint32(o,!0);o+=A;var P=M.getUint32(o,!0);o+=A;var D=M.getUint32(o,!0);o+=A;var E=M.getUint32(o,!0);o+=A;var I,S,O=M.getUint32(o,!0);o+=A,E>=570425344?(o-=2*A,I=P,E=D,O=0,P=0,D=0,L._deprecationWarning("b3dm-legacy-header","This b3dm header is using the legacy format [batchLength] [batchTableByteLength]. The new format is [featureTableJsonByteLength] [featureTableBinaryByteLength] [batchTableJsonByteLength] [batchTableBinaryByteLength] from https://github.com/AnalyticalGraphicsInc/3d-tiles/tree/master/specification/TileFormats/Batched3DModel.")):O>=570425344&&(o-=A,I=E,E=P,O=D,P=0,D=0,L._deprecationWarning("b3dm-legacy-header","This b3dm header is using the legacy format [batchTableJsonByteLength] [batchTableBinaryByteLength] [batchLength]. The new format is [featureTableJsonByteLength] [featureTableBinaryByteLength] [batchTableJsonByteLength] [batchTableBinaryByteLength] from https://github.com/AnalyticalGraphicsInc/3d-tiles/tree/master/specification/TileFormats/Batched3DModel."));if(0===P)S={BATCH_LENGTH:r(I,0)};else{var F=c(_,o,P);S=JSON.parse(F),o+=P}var H=new Uint8Array(n,o,D);o+=D;var N,W,G,k=new y(S,H);if(I=k.getGlobalProperty("BATCH_LENGTH"),k.featuresLength=I,E>0){var J=c(_,o,E);N=JSON.parse(J),o+=E,O>0&&(W=new Uint8Array(n,o,O),W=new Uint8Array(W),o+=O)}a(s.classificationType)&&(G=function(e){return function(t,i){e._model.updateCommands(t,i)}}(t));var R=new b(t,I,N,W,G);t._batchTable=R;var q,V=m+x-o;if(0===V)throw new f("glTF byte length must be greater than 0.");o%4==0?q=new Uint8Array(n,o,V):(L._deprecationWarning("b3dm-glb-unaligned","The embedded glb is not aligned to a 4-byte boundary."),q=new Uint8Array(_.subarray(o,o+V)));var Z={content:t,primitive:s};t._rtcCenterTransform=d.IDENTITY;var j=k.getGlobalProperty("RTC_CENTER",i.FLOAT,3);a(j)&&(t._rtcCenterTransform=d.fromTranslation(e.fromArray(j)));t._contentModelMatrix=d.multiply(l.computedTransform,t._rtcCenterTransform,new d),a(s.classificationType)?t._model=new T({gltf:q,cull:!1,basePath:h,requestType:u.TILES3D,modelMatrix:t._contentModelMatrix,upAxis:s._gltfUpAxis,forwardAxis:p.X,debugWireframe:s.debugWireframe,vertexShaderLoaded:B(t),classificationShaderLoaded:function(e){return function(t){var i=e._batchTable,r=i.getClassificationFragmentShaderCallback();return a(r)?r(t):t}}(t),uniformMapLoaded:R.getUniformMapCallback(),pickIdLoaded:w(t),classificationType:s._classificationType,batchTable:R}):t._model=new C({gltf:q,cull:!1,releaseGltfJson:!0,opaquePass:g.PGEARTH_3D_TILE,basePath:h,requestType:u.TILES3D,modelMatrix:t._contentModelMatrix,upAxis:s._gltfUpAxis,forwardAxis:p.X,shadows:s.shadows,debugWireframe:s.debugWireframe,incrementallyLoadTextures:!1,vertexShaderLoaded:B(t),fragmentShaderLoaded:function(e){return function(t,i){var r=e._batchTable,n=!a(e._tileset.classificationType),o=e._model.gltf;a(o)&&(e._diffuseAttributeOrUniformName[i]=v.getDiffuseAttributeOrUniform(o,i));var s=r.getFragmentShaderCallback(n,e._diffuseAttributeOrUniformName[i]);return a(s)?s(t):t}}(t),uniformMapLoaded:R.getUniformMapCallback(),pickIdLoaded:w(t),addBatchIdToGeneratedShaders:I>0,pickObject:Z,imageBasedLightingFactor:s.imageBasedLightingFactor,lightColor:s.lightColor,luminanceAtZenith:s.luminanceAtZenith,sphericalHarmonicCoefficients:s.sphericalHarmonicCoefficients,specularEnvironmentMaps:s.specularEnvironmentMaps})}(this,s,l)}L._deprecationWarning=o,n(L.prototype,{featuresLength:{get:function(){return this._batchTable.featuresLength}},pointsLength:{get:function(){return 0}},trianglesLength:{get:function(){return this._model.trianglesLength}},geometryByteLength:{get:function(){return this._model.geometryByteLength}},texturesByteLength:{get:function(){return this._model.texturesByteLength}},batchTableByteLength:{get:function(){return this._batchTable.memorySizeInBytes}},innerContents:{get:function(){}},readyPromise:{get:function(){return this._model.readyPromise}},tileset:{get:function(){return this._tileset}},tile:{get:function(){return this._tile}},url:{get:function(){return this._resource.getUrlComponent(!0)}},batchTable:{get:function(){return this._batchTable}}});var A=Uint32Array.BYTES_PER_ELEMENT;function B(e){return function(t,i){var r=e._batchTable,n=!a(e._tileset.classificationType),o=e._model.gltf;a(o)&&(e._batchIdAttributeName=function(e){var t=v.getAttributeOrUniformBySemantic(e,"_BATCHID");return a(t)||(t=v.getAttributeOrUniformBySemantic(e,"BATCHID"),a(t)&&L._deprecationWarning("b3dm-legacy-batchid","The glTF in this b3dm uses the semantic `BATCHID`. Application-specific semantics should be prefixed with an underscore: `_BATCHID`.")),t}(o),e._diffuseAttributeOrUniformName[i]=v.getDiffuseAttributeOrUniform(o,i));var s=r.getVertexShaderCallback(n,e._batchIdAttributeName,e._diffuseAttributeOrUniformName[i]);return a(s)?s(t):t}}function w(e){return function(){return e._batchTable.getPickId()}}L.prototype.hasProperty=function(e,t){return this._batchTable.hasProperty(e,t)},L.prototype.getFeature=function(e){var t=this.featuresLength;if(!a(e)||e<0||e>=t)throw new l("batchId is required and between zero and featuresLength - 1 ("+(t-1)+").");return function(e){var t=e.featuresLength;if(!a(e._features)&&t>0){for(var i=new Array(t),r=0;r<t;++r)i[r]=new _(e,r);e._features=i}}(this),this._features[e]},L.prototype.applyDebugSettings=function(e,i){i=e?i:t.WHITE,0===this.featuresLength?this._model.color=i:this._batchTable.setAllColor(i)};var M=new t;return L.prototype.applyStyle=function(e){if(0===this.featuresLength){var i=a(e)&&a(e.color),r=a(e)&&a(e.show);this._model.color=i?e.color.evaluateColor(void 0,M):t.WHITE,this._model.show=!r||e.show.evaluate(void 0)}else this._batchTable.applyStyle(e)},L.prototype.update=function(e,t){var i=t.commandList.length;this._batchTable.update(e,t),this._contentModelMatrix=d.multiply(this._tile.computedTransform,this._rtcCenterTransform,this._contentModelMatrix),this._model.modelMatrix=this._contentModelMatrix,this._model.shadows=this._tileset.shadows,this._model.imageBasedLightingFactor=this._tileset.imageBasedLightingFactor,this._model.lightColor=this._tileset.lightColor,this._model.luminanceAtZenith=this._tileset.luminanceAtZenith,this._model.sphericalHarmonicCoefficients=this._tileset.sphericalHarmonicCoefficients,this._model.specularEnvironmentMaps=this._tileset.specularEnvironmentMaps,this._model.debugWireframe=this._tileset.debugWireframe;var r=this._tileset.clippingPlanes;this._model.clippingPlanesOriginMatrix=this._tileset.clippingPlanesOriginMatrix,a(r)&&this._tile.clippingPlanesDirty&&(this._model._clippingPlanes=r.enabled&&this._tile._isClipped?r:void 0),a(r)&&a(this._model._clippingPlanes)&&this._model._clippingPlanes!==r&&(this._model._clippingPlanes=r),this._model.update(t),i<t.commandList.length&&(t.passes.render||t.passes.pick)&&!a(e.classificationType)&&this._batchTable.addDerivedCommands(t,i)},L.prototype.isDestroyed=function(){return!1},L.prototype.destroy=function(){return this._model=this._model&&this._model.destroy(),this._batchTable=this._batchTable&&this._batchTable.destroy(),s(this)},L});