define(["../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/clone","../Core/defined","../Core/defineProperties","../Core/Matrix2","../Core/Matrix3","../Core/Matrix4","../Core/Quaternion","../Core/FeatureDetection","../Core/RuntimeError","../Core/WebGLConstants","../Renderer/ShaderSource","../ThirdParty/GltfPipeline/addToArray","../ThirdParty/GltfPipeline/ForEach","../ThirdParty/GltfPipeline/hasExtension","./AttributeType","./Axis"],function(e,n,r,t,i,o,a,u,s,c,f,m,l,_,d,v,h,p,E,g){"use strict";var A={updateForwardAxis:function(e){var n=e.gltf.extras.sourceVersion;(o(n)&&"2.0"!==n||"2.0"!==A.getAssetVersion(e.gltf))&&(e._gltfForwardAxis=g.X)},getAssetVersion:function(e){return o(e.asset)&&o(e.asset.version)?e.asset.version:"1.0"},splitIncompatibleMaterials:function(e){var n=e.accessors,r=e.materials,t={};return h.mesh(e,function(e){h.meshPrimitive(e,function(e){var a,u,s=e.material,c=r[s],f=e.attributes.JOINTS_0;if(o(f)){var m=n[f];a=m.componentType,u=m.type}var l=o(f),_=o(e.attributes.COLOR_0),d=o(e.targets),h=o(e.attributes.NORMAL),p=o(e.attributes.TANGENT),E=o(e.attributes.TEXCOORD_0),g=t[s];if(o(g)){if(g.skinning.skinned!==l||g.skinning.type!==u||g.hasVertexColors!==_||g.hasMorphTargets!==d||g.hasNormals!==h||g.hasTangents!==p||g.hasTexCoords!==E){var A=i(c,!0);s=v(r,A),e.material=s,t[s]={skinning:{skinned:l,componentType:a,type:u},hasVertexColors:_,hasMorphTargets:d,hasNormals:h,hasTangents:p,hasTexCoords:E}}}else t[s]={skinning:{skinned:l,componentType:a,type:u},hasVertexColors:_,hasMorphTargets:d,hasNormals:h,hasTangents:p,hasTexCoords:E}})}),t},getShaderVariable:function(e){return"SCALAR"===e?"float":e.toLowerCase()},ModelState:{NEEDS_LOAD:0,LOADING:1,LOADED:2,FAILED:3},getFailedLoadFunction:function(e,n,r){return function(t){e._state=A.ModelState.FAILED;var i="Failed to load "+n+": "+r;o(t)&&(i+="\n"+t.message),e._readyPromise.reject(new l(i))}},parseBuffers:function(e,n){var r=e._loadResources;h.buffer(e.gltf,function(t,i){if(o(t.extras._pipeline.source))r.buffers[i]=t.extras._pipeline.source;else if(o(n)){var a=e._resource.getDerivedResource({url:t.uri});++r.pendingBufferLoads,a.fetchArrayBuffer().then(n(e,i)).otherwise(A.getFailedLoadFunction(e,"buffer",a.url))}})}},O=new r,T=new r;function b(e,n){return h.techniqueAttribute(e,function(e,r){if(e.semantic===n)return r})}function x(e,n,r,t){return p(e,"KHR_techniques_webgl")?function(e,n){if(!(e.semantic!==r||t&&o(e.node)))return n}:function(e,i){var a=n.parameters[e];if(!(a.semantic!==r||t&&o(a.node)))return i}}A.computeBoundingSphere=function(n){for(var t=n.gltf,i=t.nodes,a=t.meshes,u=t.scenes[t.scene].nodes,s=u.length,f=[],m=new r(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l=new r(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),_=0;_<s;++_){var d=i[u[_]];for(d._transformToRoot=A.getTransform(d),f.push(d);f.length>0;){var v=(d=f.pop())._transformToRoot,h=d.mesh;if(o(h))for(var p=a[h].primitives,E=p.length,b=0;b<E;++b){var x=p[b].attributes.POSITION;if(o(x)){var C=A.getAccessorMinMax(t,x),y=r.fromArray(C.min,0,O),w=r.fromArray(C.max,0,T);o(m)&&o(l)&&(c.multiplyByPoint(v,y,y),c.multiplyByPoint(v,w,w),r.minimumByComponent(m,y,m),r.maximumByComponent(l,w,l))}}var L=d.children;if(o(L))for(var R=L.length,V=0;V<R;++V){var M=i[L[V]];M._transformToRoot=A.getTransform(M),c.multiplyTransformation(v,M._transformToRoot,M._transformToRoot),f.push(M)}delete d._transformToRoot}}var S=e.fromCornerPoints(m,l);return n._forwardAxis===g.Z&&e.transformWithoutScale(S,g.Z_UP_TO_X_UP,S),n._upAxis===g.Y?e.transformWithoutScale(S,g.Y_UP_TO_Z_UP,S):n._upAxis===g.X&&e.transformWithoutScale(S,g.X_UP_TO_Z_UP,S),S},A.ensureSemanticExistence=function(e){return h.mesh(e,function(n){h.meshPrimitive(n,function(n){!function(e,n){var r=e.accessors,t=e.materials,i=e.extensions.KHR_techniques_webgl,a=i.techniques,u=i.programs,s=i.shaders,c=n.targets,f=n.attributes;for(var m in c)if(c.hasOwnProperty(m)){var l=c[m];for(var _ in l)"extras"!==_&&(f[_+"_"+m]=l[_])}var d=a[t[n.material].extensions.KHR_techniques_webgl.technique],v=s[u[d.program].vertexShader];for(var h in f)if(f.hasOwnProperty(h)&&!o(b(d,h))){var p=r[f[h]],E=h.toLowerCase();"_"===E.charAt(0)&&(E=E.slice(1));var g="a_"+E;d.attributes[g]={semantic:h,type:p.componentType};var O=v.extras._pipeline,T=O.source;T="attribute "+A.getShaderVariable(p.type)+" "+g+";\n"+T,O.source=T}}(e,n)})}),e},A.createAttributeLocations=function(e,n){var r={},t=!1,i=1;if(h.techniqueAttribute(e,function(e,n){/pos/i.test(n)&&!t?(r[n]=0,t=!0):r[n]=i++}),o(n))for(var a in n)n.hasOwnProperty(a)&&(r[a]=i++);return r},A.getAccessorMinMax=function(e,n){var r=e.accessors[n],t=r.extensions,i=r.min,a=r.max;if(o(t)){var u=t.WEB3D_quantized_attributes;o(u)&&(i=u.decodedMin,a=u.decodedMax)}return{min:i,max:a}},A.getAttributeOrUniformBySemantic=function(e,n,r,t){return h.technique(e,function(i){if(!o(r)||i.program===r){var a=h.techniqueAttribute(i,x(e,i,n,t));return o(a)?a:h.techniqueUniform(i,x(e,i,n,t))}})},A.getDiffuseAttributeOrUniform=function(e,n){var r=A.getAttributeOrUniformBySemantic(e,"COLOR_0",n);return o(r)||(r=A.getAttributeOrUniformBySemantic(e,"_3DTILESDIFFUSE",n)),r};var C=new r,y=new f,w=new r;function L(e,n,r){n+="(?!\\w)",n=new RegExp(n,"g");var t=e.search(n);return e.replace(n,function(e,n){return t===n?e:r})}function R(e,n){var r=e.accessors[n].extensions;if(o(r))return r.WEB3D_quantized_attributes}function V(e,n,r){var t=n.material,i=e.materials[t];if(p(e,"KHR_techniques_webgl")&&o(i.extensions)&&o(i.extensions.KHR_techniques_webgl)){var a=i.extensions.KHR_techniques_webgl.technique,u=e.extensions.KHR_techniques_webgl.techniques[a];return h.techniqueAttribute(u,function(e,n){if(e.semantic===r)return n})}}function M(e){var n={value:e,clone:function(e,n){return e},func:function(){return n.value}};return n}function S(e){var r={value:n.fromArray(e),clone:n.clone,func:function(){return r.value}};return r}function I(e){var n={value:r.fromArray(e),clone:r.clone,func:function(){return n.value}};return n}function P(e){var n={value:t.fromArray(e),clone:t.clone,func:function(){return n.value}};return n}function D(e){var n={value:u.fromColumnMajorArray(e),clone:u.clone,func:function(){return n.value}};return n}function N(e){var n={value:s.fromColumnMajorArray(e),clone:s.clone,func:function(){return n.value}};return n}function U(e){var n={value:c.fromColumnMajorArray(e),clone:c.clone,func:function(){return n.value}};return n}function q(e,n,r){this._value=void 0,this._textureId=e.index,this._textures=n,this._defaultTexture=r}A.getTransform=function(e,n){return o(e.matrix)?c.fromColumnMajorArray(e.matrix,n):c.fromTranslationQuaternionRotationScale(r.fromArray(e.translation,0,C),f.unpack(e.rotation,0,y),r.fromArray(e.scale,0,w),n)},A.getUsedExtensions=function(e){var n=e.extensionsUsed,r={};if(o(n))for(var t=n.length,i=0;i<t;i++){r[n[i]]=!0}return r},A.getRequiredExtensions=function(e){var n=e.extensionsRequired,r={};if(o(n))for(var t=n.length,i=0;i<t;i++){r[n[i]]=!0}return r},A.supportedExtensions={AGI_articulations:!0,PGEARTH_RTC:!0,EXT_texture_webp:!0,KHR_blend:!0,KHR_binary_glTF:!0,KHR_draco_mesh_compression:!0,KHR_materials_common:!0,KHR_techniques_webgl:!0,KHR_materials_unlit:!0,KHR_materials_pbrSpecularGlossiness:!0,KHR_texture_transform:!0,WEB3D_quantized_attributes:!0},A.checkSupportedExtensions=function(e,n){for(var r in e)if(e.hasOwnProperty(r)){if(!A.supportedExtensions[r])throw new l("Unsupported glTF Extension: "+r);if("EXT_texture_webp"===r&&!1===n)throw new l("Loaded model requires WebP but browser does not support it.")}},A.checkSupportedGlExtensions=function(e,n){if(o(e))for(var r=e.length,t=0;t<r;t++){var i=e[t];if("OES_element_index_uint"!==i)throw new l("Unsupported WebGL Extension: "+i);if(!n.elementIndexUint)throw new l("OES_element_index_uint WebGL extension is not enabled.")}},A.modifyShaderForDracoQuantizedAttributes=function(e,n,r,t){var i={};for(var a in t)if(t.hasOwnProperty(a)){var u=t[a],s=u.quantization;if(!o(s))continue;var c=V(e,n,a);"_"===a.charAt(0)&&(a=a.substring(1));var f="gltf_u_dec_"+a.toLowerCase();if(!o(i[f])){var m,l="gltf_decoded_"+a,_=c.replace("a_","gltf_a_dec_"),v=u.componentsPerAttribute;r=L(r,c,_),r=(m=s.octEncoded?"vec3":v>1?"vec"+v:"float")+" "+_+";\n"+r;var h=3===v&&"COLOR_0"===a;h&&(r=L(r,_,"vec4("+_+", 1.0)"));var p="";if(s.octEncoded){var E=f+"_rangeConstant";r="uniform float "+E+";\n"+r,p="\nvoid main() {\n    "+_+" = czm_octDecode("+c+".xy, "+E+").zxy;\n    "+l+"();\n}\n"}else{var g=f+"_normConstant",A=f+"_min";r="uniform float "+g+";\nuniform "+m+" "+A+";\n"+r,p="\nvoid main() {\n    "+_+" = "+A+" + "+c+(h?".xyz":"")+" * "+g+";\n    "+l+"();\n}\n"}r=d.replaceMain(r,l),r+=p}}return{shader:r}},A.modifyShaderForQuantizedAttributes=function(e,n,r){var t={},i=n.attributes;for(var a in i)if(i.hasOwnProperty(a)){var u=V(e,n,a),s=n.attributes[a];"_"===a.charAt(0)&&(a=a.substring(1));var c="gltf_u_dec_"+a.toLowerCase(),f=c+"_scale",m=c+"_translate";if(!o(t[c])&&!o(t[f])){var l=R(e,s);if(o(l)){var _,v=l.decodeMatrix,h="gltf_decoded_"+a,p=u.replace("a_","gltf_a_dec_"),E=Math.floor(Math.sqrt(v.length));r=L(r,u,p),r=(_=E>2?"vec"+(E-1):"float")+" "+p+";\n"+r;var g="";5===E?(r="uniform vec4 "+m+";\n"+(r="uniform mat4 "+f+";\n"+r),g="\nvoid main() {\n    "+p+" = "+f+" * "+u+" + "+m+";\n    "+h+"();\n}\n",t[f]={mat:4},t[m]={vec:4}):(r="uniform mat"+E+" "+c+";\n"+r,g="\nvoid main() {\n    "+p+" = "+_+"("+c+" * vec"+E+"("+u+",1.0));\n    "+h+"();\n}\n",t[c]={mat:E}),r=d.replaceMain(r,h),r+=g}}}return{shader:r,uniforms:t}},A.toClipCoordinatesGLSL=function(e,n){var r=A.getAttributeOrUniformBySemantic(e,"POSITION"),t=r.replace("a_","gltf_a_dec_");-1!==n.indexOf(t)&&(r=t);var i=A.getAttributeOrUniformBySemantic(e,"MODELVIEWPROJECTION",void 0,!0);if(!o(i)||-1===n.indexOf(i)){var a=A.getAttributeOrUniformBySemantic(e,"PROJECTION",void 0,!0),u=A.getAttributeOrUniformBySemantic(e,"MODELVIEW",void 0,!0);-1!==n.indexOf("czm_instanced_modelView ")?u="czm_instanced_modelView":o(u)||(u=A.getAttributeOrUniformBySemantic(e,"PGEARTH_RTC_MODELVIEW",void 0,!0)),i=a+" * "+u}return i+" * vec4("+r+".xyz, 1.0)"},A.modifyFragmentShaderForLogDepth=function(e){return e=d.replaceMain(e,"czm_depth_main"),e+="\nvoid main() \n{ \n    czm_depth_main(); \n    czm_writeLogDepth(); \n} \n"},A.modifyVertexShaderForLogDepth=function(e,n){return e=d.replaceMain(e,"czm_depth_main"),e+="\nvoid main() \n{ \n    czm_depth_main(); \n    czm_vertexLogDepth("+n+"); \n} \n"},a(q.prototype,{value:{get:function(){if(!o(this._value)){var e=this._textures[this._textureId];if(!o(e))return this._defaultTexture;this._value=e}return this._value},set:function(e){this._value=e}}}),q.prototype.clone=function(e){return e},q.prototype.func=void 0;var F={};function B(e){return[e[20],e[21],e[22],e[23]]}F[_.FLOAT]=M,F[_.FLOAT_VEC2]=S,F[_.FLOAT_VEC3]=I,F[_.FLOAT_VEC4]=P,F[_.INT]=M,F[_.INT_VEC2]=S,F[_.INT_VEC3]=I,F[_.INT_VEC4]=P,F[_.BOOL]=M,F[_.BOOL_VEC2]=S,F[_.BOOL_VEC3]=I,F[_.BOOL_VEC4]=P,F[_.FLOAT_MAT2]=D,F[_.FLOAT_MAT3]=N,F[_.FLOAT_MAT4]=U,F[_.SAMPLER_2D]=function(e,n,r){var t=new q(e,n,r);return t.func=function(){return t.value},t},A.createUniformFunction=function(e,n,r,t){return F[e](n,r,t)},A.createUniformsForDracoQuantizedAttributes=function(e){var n={};for(var r in e)if(e.hasOwnProperty(r)){var t=e[r],i=t.quantization;if(!o(i))continue;"_"===r.charAt(0)&&(r=r.substring(1));var a="gltf_u_dec_"+r.toLowerCase();if(i.octEncoded){var u=a+"_rangeConstant",s=(1<<i.quantizationBits)-1;n[u]=M(s).func;continue}var c=a+"_normConstant",f=i.range/(1<<i.quantizationBits);n[c]=M(f).func;var m=a+"_min";switch(t.componentsPerAttribute){case 1:n[m]=M(i.minValues).func;break;case 2:n[m]=S(i.minValues).func;break;case 3:n[m]=I(i.minValues).func;break;case 4:n[m]=P(i.minValues).func}}return n},A.createUniformsForQuantizedAttributes=function(e,n,r){var t,i=e.accessors,a={},f={},m=n.attributes;for(var l in m)if(m.hasOwnProperty(l)){var _=i[m[l]],d=_.extensions;if("_"===l.charAt(0)&&(l=l.substring(1)),o(d)){var v=d.WEB3D_quantized_attributes;if(o(v)){var h=v.decodeMatrix,p="gltf_u_dec_"+l.toLowerCase();switch(_.type){case E.SCALAR:f[p]=D(h).func,a[p]=!0;break;case E.VEC2:f[p]=N(h).func,a[p]=!0;break;case E.VEC3:f[p]=U(h).func,a[p]=!0;break;case E.VEC4:var g=p+"_scale",A=p+"_translate";f[g]=U((t=h,[t[0],t[1],t[2],t[3],t[5],t[6],t[7],t[8],t[10],t[11],t[12],t[13],t[15],t[16],t[17],t[18]])).func,f[A]=P(B(h)).func,a[g]=!0,a[A]=!0}}}}for(var O in r)if(r.hasOwnProperty(O)&&!a[O]){var T=r[O];o(T.mat)&&(2===T.mat?f[O]=D(u.IDENTITY).func:3===T.mat?f[O]=N(s.IDENTITY).func:4===T.mat&&(f[O]=U(c.IDENTITY).func)),o(T.vec)&&4===T.vec&&(f[O]=P([0,0,0,0]).func)}return f};var z=new r,W={MODEL:function(e,n){return function(){return e.model}},VIEW:function(e,n){return function(){return e.view}},PROJECTION:function(e,n){return function(){return e.projection}},MODELVIEW:function(e,n){return function(){return e.modelView}},PGEARTH_RTC_MODELVIEW:function(e,n){var t=new c;return function(){return o(n._rtcCenter)?(c.getTranslation(e.model,z),r.add(z,n._rtcCenter,z),c.multiplyByPoint(e.view,z,z),c.setTranslation(e.modelView,z,t)):e.modelView}},MODELVIEWPROJECTION:function(e,n){return function(){return e.modelViewProjection}},MODELINVERSE:function(e,n){return function(){return e.inverseModel}},VIEWINVERSE:function(e,n){return function(){return e.inverseView}},PROJECTIONINVERSE:function(e,n){return function(){return e.inverseProjection}},MODELVIEWINVERSE:function(e,n){return function(){return e.inverseModelView}},MODELVIEWPROJECTIONINVERSE:function(e,n){return function(){return e.inverseModelViewProjection}},MODELINVERSETRANSPOSE:function(e,n){return function(){return e.inverseTransposeModel}},MODELVIEWINVERSETRANSPOSE:function(e,n){return function(){return e.normal}},VIEWPORT:function(e,n){return function(){return e.viewportCartesian4}}};return A.getGltfSemanticUniforms=function(){return W},A});