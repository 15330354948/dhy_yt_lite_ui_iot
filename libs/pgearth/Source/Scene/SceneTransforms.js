define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/defined","../Core/DeveloperError","../Core/Math","../Core/Matrix4","../Core/OrthographicFrustum","../Core/OrthographicOffCenterFrustum","../Core/Transforms","./SceneMode"],function(e,t,r,o,i,n,a,s,u,f,m,c,l){"use strict";var w={},d=new o(0,0,0,1),p=new o,x=new e,C=new t,h=new t;w.wgs84ToWindowCoordinates=function(e,t,o){return w.wgs84WithEyeOffsetToWindowCoordinates(e,t,r.ZERO,o)};var g=new o,y=new r;function v(e,t,i,n){var a=i.viewMatrix,s=u.multiplyByVector(a,o.fromElements(e.x,e.y,e.z,1,g),g),f=r.multiplyComponents(t,r.normalize(s,y),y);return s.x+=t.x+f.x,s.y+=t.y+f.y,s.z+=f.z,u.multiplyByVector(i.frustum.projectionMatrix,s,n)}var W=new i(Math.PI,s.PI_OVER_TWO),T=new r,E=new r;w.wgs84WithEyeOffsetToWindowCoordinates=function(e,o,i,g){if(!n(e))throw new a("scene is required.");if(!n(o))throw new a("position is required.");var y=e.frameState,B=w.computeActualWgs84Position(y,o,d);if(n(B)){var S=e.canvas,z=x;z.x=0,z.y=0,z.width=S.clientWidth,z.height=S.clientHeight;var V=e.camera,D=!1;if(y.mode===l.SCENE2D){var L=e.mapProjection,M=W,O=L.project(M,T),P=r.clone(V.position,E),j=V.frustum.clone(),G=u.computeViewportTransformation(z,0,1,new u),_=V.frustum.projectionMatrix,F=V.positionWC.y,N=r.fromElements(s.sign(F)*O.x-F,0,-V.positionWC.x),H=c.pointToGLWindowCoordinates(_,G,N);if(0===F||H.x<=0||H.x>=S.clientWidth)D=!0;else{if(H.x>.5*S.clientWidth){z.width=H.x,V.frustum.right=O.x-F,p=v(B,i,V,p),w.clipToGLWindowCoordinates(z,p,C),z.x+=H.x,V.position.x=-V.position.x;var I=V.frustum.right;V.frustum.right=-V.frustum.left,V.frustum.left=-I,p=v(B,i,V,p),w.clipToGLWindowCoordinates(z,p,h)}else{z.x+=H.x,z.width-=H.x,V.frustum.left=-O.x-F,p=v(B,i,V,p),w.clipToGLWindowCoordinates(z,p,C),z.x=z.x-z.width,V.position.x=-V.position.x;var R=V.frustum.left;V.frustum.left=-V.frustum.right,V.frustum.right=-R,p=v(B,i,V,p),w.clipToGLWindowCoordinates(z,p,h)}r.clone(P,V.position),V.frustum=j.clone(),((g=t.clone(C,g)).x<0||g.x>S.clientWidth)&&(g.x=h.x)}}if(y.mode!==l.SCENE2D||D){if((p=v(B,i,V,p)).z<0&&!(V.frustum instanceof f)&&!(V.frustum instanceof m))return;g=w.clipToGLWindowCoordinates(z,p,g)}return g.y=S.clientHeight-g.y,g}},w.wgs84ToDrawingBufferCoordinates=function(e,t,r){if(r=w.wgs84ToWindowCoordinates(e,t,r),n(r))return w.transformWindowToDrawingBuffer(e,r,r)};var B=new r,S=new i;w.computeActualWgs84Position=function(e,t,o){var i=e.mode;if(i===l.SCENE3D)return r.clone(t,o);var a=e.mapProjection,u=a.ellipsoid.cartesianToCartographic(t,S);if(n(u)){if(a.project(u,B),i===l.COLUMBUS_VIEW)return r.fromElements(B.z,B.x,B.y,o);if(i===l.SCENE2D)return r.fromElements(0,B.x,B.y,o);var f=e.morphTime;return r.fromElements(s.lerp(B.z,t.x,f),s.lerp(B.x,t.y,f),s.lerp(B.y,t.z,f),o)}};var z=new r,V=new r,D=new u;w.clipToGLWindowCoordinates=function(e,o,i){return r.divideByScalar(o,o.w,z),u.computeViewportTransformation(e,0,1,D),u.multiplyByPoint(D,z,V),t.fromCartesian3(V,i)},w.transformWindowToDrawingBuffer=function(e,r,o){var i=e.canvas,n=e.drawingBufferWidth/i.clientWidth,a=e.drawingBufferHeight/i.clientHeight;return t.fromElements(r.x*n,r.y*a,o)};var L=new o,M=new o;return w.drawingBufferToWgs84Coordinates=function(e,t,i,a){var f=e.context.uniformState,m=f.currentFrustum,c=m.x,l=m.y;e.frameState.useLogDepth&&(i=l*(1-c/(i=Math.pow(2,i*s.log2(l+1))-1))/(l-c));var w,d=e._view.passState.viewport,p=o.clone(o.UNIT_W,L);p.x=(t.x-d.x)/d.width*2-1,p.y=(t.y-d.y)/d.height*2-1,p.z=2*i-1,p.w=1;var x=e.camera.frustum;if(n(x.fovy)){var C=1/(w=u.multiplyByVector(f.inverseViewProjection,p,M)).w;r.multiplyByScalar(w,C,w)}else n(x._offCenterFrustum)&&(x=x._offCenterFrustum),(w=M).x=.5*(p.x*(x.right-x.left)+x.left+x.right),w.y=.5*(p.y*(x.top-x.bottom)+x.bottom+x.top),w.z=.5*(p.z*(c-l)-c-l),w.w=1,w=u.multiplyByVector(f.inverseView,w,w);return r.fromCartesian4(w,a)},w});