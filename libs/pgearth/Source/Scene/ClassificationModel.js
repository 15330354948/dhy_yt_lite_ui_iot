define(["../Core/arraySlice","../Core/BoundingSphere","../Core/Cartesian3","../Core/Cartesian4","../Core/Color","../Core/combine","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/FeatureDetection","../Core/IndexDatatype","../Core/Matrix4","../Core/PrimitiveType","../Core/RuntimeError","../Core/Transforms","../Core/WebGLConstants","../ThirdParty/GltfPipeline/addDefaults","../ThirdParty/GltfPipeline/ForEach","../ThirdParty/GltfPipeline/getAccessorByteStride","../ThirdParty/GltfPipeline/numberOfComponentsForType","../ThirdParty/GltfPipeline/parseGlb","../ThirdParty/GltfPipeline/updateVersion","../ThirdParty/when","./Axis","./ClassificationType","./ModelLoadResources","./ModelUtility","./processModelMaterialsCommon","./processPbrMaterials","./SceneMode","./Vector3DTileBatch","./Vector3DTilePrimitive"],function(e,t,i,r,n,o,s,a,d,u,f,h,c,_,m,l,p,g,y,v,b,T,C,x,E,S,A,O,L,I,P,B,M,D,w){"use strict";if(!c.supportsTypedArrays())return{};var R=new i,U=I.ModelState;function V(e){var i=(e=a(e,a.EMPTY_OBJECT)).gltf;if(i instanceof ArrayBuffer&&(i=new Uint8Array(i)),!(i instanceof Uint8Array))throw new p("Only binary glTF is supported as a classifier.");i=x(i),E(i),v(i),P(i),B(i),b.buffer(i,function(e){if(!d(e.extras._pipeline.source))throw new p("Buffer data must be embedded in the binary gltf.")});var r=i.nodes,n=i.meshes,o=r[0].mesh;if(1!==r.length||!d(o))throw new p("Only one node is supported for classification and it must have a mesh.");if(1!==n.length)throw new p("Only one mesh is supported when using b3dm for classification.");var s=n[0].primitives;if(1!==s.length)throw new p("Only one primitive per mesh is supported when using b3dm for classification.");var u=s[0].attributes.POSITION;if(!d(u))throw new p("The mesh must have a position attribute.");var f=s[0].attributes._BATCHID;if(!d(f))throw new p("The mesh must have a batch id attribute.");this._gltf=i,this.show=a(e.show,!0),this.modelMatrix=m.clone(a(e.modelMatrix,m.IDENTITY)),this._modelMatrix=m.clone(this.modelMatrix),this._ready=!1,this._readyPromise=S.defer(),this.debugShowBoundingVolume=a(e.debugShowBoundingVolume,!1),this._debugShowBoundingVolume=!1,this.debugWireframe=a(e.debugWireframe,!1),this._debugWireframe=!1,this._classificationType=e.classificationType,this._vertexShaderLoaded=e.vertexShaderLoaded,this._classificationShaderLoaded=e.classificationShaderLoaded,this._uniformMapLoaded=e.uniformMapLoaded,this._pickIdLoaded=e.pickIdLoaded,this._ignoreCommands=a(e.ignoreCommands,!1),this._upAxis=a(e.upAxis,A.Y),this._batchTable=e.batchTable,this._computedModelMatrix=new m,this._initialRadius=void 0,this._boundingSphere=void 0,this._scaledBoundingSphere=new t,this._state=U.NEEDS_LOAD,this._loadResources=void 0,this._mode=void 0,this._dirty=!1,this._nodeMatrix=new m,this._primitive=void 0,this._extensionsUsed=void 0,this._extensionsRequired=void 0,this._quantizedUniforms=void 0,this._buffers={},this._vertexArray=void 0,this._shaderProgram=void 0,this._uniformMap=void 0,this._geometryByteLength=0,this._trianglesLength=0,this._rtcCenter=void 0,this._rtcCenterEye=void 0,this._rtcCenter3D=void 0,this._rtcCenter2D=void 0}function N(e,t){var i=t._loadResources,r=t.gltf.bufferViews[e],n=i.getBuffer(r);t._buffers[e]=n,t._geometryByteLength+=n.byteLength}function G(e,t,i){var r=i._loadResources,n=i.gltf.bufferViews[e],o={typedArray:r.getBuffer(n),indexDatatype:t};i._buffers[e]=o,i._geometryByteLength+=o.typedArray.byteLength}function W(e,t){return d(t)&&(e=t(e)),e}function q(e){var t=e.gltf,i=I.getAttributeOrUniformBySemantic(t,"POSITION"),r=I.getAttributeOrUniformBySemantic(t,"_BATCHID"),n={};n[i]=0,n[r]=1;var o,s,a=I.getAttributeOrUniformBySemantic(t,"MODELVIEWPROJECTION");if(d(a))o="uniform mat4 "+a+";\n",s=a+" * vec4("+i+", 1.0)";else{var u=I.getAttributeOrUniformBySemantic(t,"PROJECTION"),f=I.getAttributeOrUniformBySemantic(t,"MODELVIEW");d(f)||(f=I.getAttributeOrUniformBySemantic(t,"PGEARTH_RTC_MODELVIEW")),o="uniform mat4 "+f+";\nuniform mat4 "+u+";\n",s=u+" * "+f+" * vec4("+i+", 1.0)"}var h="attribute vec3 "+i+";\nattribute float "+r+";\n"+o+"void main() {\n"+("    vec4 positionInClipCoords = "+s+";\n")+"    gl_Position = czm_depthClampFarPlane(positionInClipCoords);\n}\n";e.extensionsUsed.WEB3D_quantized_attributes&&(h=function(e,t){var i=t.gltf.meshes[0].primitives[0],r=I.modifyShaderForQuantizedAttributes(t.gltf,i,e);return t._quantizedUniforms=r.uniforms,r.shader}(h,e));var c=W(h,e._vertexShaderLoaded),_=W("#ifdef GL_EXT_frag_depth\n#extension GL_EXT_frag_depth : enable\n#endif\nvoid main() \n{ \n    gl_FragColor = vec4(1.0); \n    czm_writeDepthClampedToFarPlane();\n}\n",e._classificationShaderLoaded);c=I.modifyVertexShaderForLogDepth(c,s),_=I.modifyFragmentShaderForLogDepth(_),e._shaderProgram={vertexShaderSource:c,fragmentShaderSource:_,attributeLocations:n}}u(V.prototype,{gltf:{get:function(){return this._gltf}},boundingSphere:{get:function(){if(this._state!==U.LOADED)throw new h("The model is not loaded.  Use ClassificationModel.readyPromise or wait for ClassificationModel.ready to be true.");var e=this.modelMatrix,t=m.getScale(e,R),r=this._scaledBoundingSphere;return r.center=i.multiplyComponents(this._boundingSphere.center,t,r.center),r.radius=i.maximumComponent(t)*this._initialRadius,d(this._rtcCenter)&&i.add(this._rtcCenter,r.center,r.center),r}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},dirty:{get:function(){return this._dirty}},extensionsUsed:{get:function(){return d(this._extensionsUsed)||(this._extensionsUsed=I.getUsedExtensions(this.gltf)),this._extensionsUsed}},extensionsRequired:{get:function(){return d(this._extensionsRequired)||(this._extensionsRequired=I.getRequiredExtensions(this.gltf)),this._extensionsRequired}},upAxis:{get:function(){return this._upAxis}},trianglesLength:{get:function(){return this._trianglesLength}},geometryByteLength:{get:function(){return this._geometryByteLength}},texturesByteLength:{get:function(){return 0}},classificationType:{get:function(){return this._classificationType}}});var F={PROJECTION:function(e,t){return I.getGltfSemanticUniforms().PROJECTION(e,t)},MODELVIEW:function(e,t){return I.getGltfSemanticUniforms().MODELVIEW(e,t)},PGEARTH_RTC_MODELVIEW:function(e,t){return I.getGltfSemanticUniforms().PGEARTH_RTC_MODELVIEW(e,t)},MODELVIEWPROJECTION:function(e,t){return I.getGltfSemanticUniforms().MODELVIEWPROJECTION(e,t)}};function z(r){var a,u,f=r._batchTable,h=r._uniformMap,c=r._vertexArray,p=r.gltf,g=p.accessors,y=p.meshes[0].primitives[0],v=g[y.indices],b=y.attributes.POSITION,T=I.getAccessorMinMax(p,b),C=t.fromCornerPoints(i.fromArray(T.min),i.fromArray(T.max));d(v)?(u=v.count,a=v.byteOffset/_.getSizeInBytes(v.componentType)):(u=g[y.attributes.POSITION].count,a=0);if(r._trianglesLength+=function(e,t){switch(e.mode){case l.TRIANGLES:return t/3;case l.TRIANGLE_STRIP:case l.TRIANGLE_FAN:return Math.max(t-2,0);default:return 0}}(y,u),d(r._uniformMapLoaded)&&(h=r._uniformMapLoaded(h)),r.extensionsUsed.WEB3D_quantized_attributes){var x=function(e,t){return I.createUniformsForQuantizedAttributes(e.gltf,t,e._quantizedUniforms)}(r,y);h=o(h,x)}var E=c.attributes.POSITION,S=E.componentDatatype,A=E.vertexBuffer,O=A.byteOffset,L=A.byteLength/s.getSizeInBytes(S),P=s.createArrayBufferView(S,A.buffer,O,L);S=(E=c.attributes._BATCHID).componentDatatype,O=(A=E.vertexBuffer).byteOffset,L=A.byteLength/s.getSizeInBytes(S);var B,M=s.createArrayBufferView(S,A.buffer,O,L),R=c.indexBuffer.typedArray;B=c.indexBuffer.indexDatatype===_.UNSIGNED_SHORT?new Uint16Array(R.buffer,R.byteOffset,R.byteLength/Uint16Array.BYTES_PER_ELEMENT):new Uint32Array(R.buffer,R.byteOffset,R.byteLength/Uint32Array.BYTES_PER_ELEMENT),P=e(P);var U,V,N,G=[],W=[],q=[],F=[],z=(M=e(M))[(B=e(B,a,a+u))[0]];G.push(z),q.push(0);for(var H=B.length,Y=1;Y<H;++Y)(U=M[B[Y]])!==z&&(N=Y-(V=q[q.length-1]),G.push(U),W.push(N),q.push(Y),F.push(new D({offset:V,count:N,batchIds:[z],color:n.WHITE})),z=U);N=H-(V=q[q.length-1]),W.push(N),F.push(new D({offset:V,count:N,batchIds:[z],color:n.WHITE}));var k=r._shaderProgram,J=k.vertexShaderSource,j=k.fragmentShaderSource,X=k.attributeLocations,Z=d(r._pickIdLoaded)?r._pickIdLoaded():void 0;r._primitive=new w({classificationType:r._classificationType,positions:P,indices:B,indexOffsets:q,indexCounts:W,batchIds:G,vertexBatchIds:M,batchedIndices:F,batchTable:f,boundingVolume:new t,_vertexShaderSource:J,_fragmentShaderSource:j,_attributeLocations:X,_uniformMap:h,_pickId:Z,_modelMatrix:new m,_boundingSphere:C}),r._buffers=void 0,r._vertexArray=void 0,r._shaderProgram=void 0,r._uniformMap=void 0}function H(e,t){var i=t.context;I.checkSupportedGlExtensions(e.gltf.glExtensionsUsed,i),function(e){var t=e._loadResources;if(0===t.pendingBufferLoads){for(var i=t.vertexBuffersToCreate,r=t.indexBuffersToCreate;i.length>0;)N(i.dequeue(),e);for(;r.length>0;){var n=r.dequeue();G(n.id,n.componentType,e)}}}(e),q(e),function(e){if(e._loadResources.finishedBuffersCreation()&&!d(e._vertexArray)){var t,i=e._buffers,r=e.gltf,n=r.accessors,o=r.meshes[0].primitives[0],s={POSITION:0,_BATCHID:1},a={};if(b.meshPrimitiveAttribute(o,function(e,t){var o=s[t];if(d(o)){var u=n[e];a[t]={index:o,vertexBuffer:i[u.bufferView],componentsPerAttribute:C(u.type),componentDatatype:u.componentType,offsetInBytes:u.byteOffset,strideInBytes:T(r,u)}}}),d(o.indices)){var u=n[o.indices];t=i[u.bufferView]}e._vertexArray={attributes:a,indexBuffer:t}}}(e),function(e,t){if(!d(e._uniformMap)){var i={};b.technique(e.gltf,function(r){b.techniqueUniform(r,function(r,n){d(r.semantic)&&d(F[r.semantic])&&(i[n]=F[r.semantic](t.uniformState,e))})}),e._uniformMap=i}}(e,i),function(e){if(e._loadResources.finished()&&!d(e._primitive)){var t=e.gltf.nodes[0];e._nodeMatrix=I.getTransform(t,e._nodeMatrix),z(e)}}(e)}var Y=new r,k=new m;return V.prototype.updateCommands=function(e,t){this._primitive.updateCommands(e,t)},V.prototype.update=function(e){if(e.mode!==M.MORPHING)if(c.supportsWebP.initialized){var n=c.supportsWebP();if(this._state===U.NEEDS_LOAD&&d(this.gltf)&&(this._state=U.LOADING,this._state!==U.FAILED)){var o=this.gltf.extensions;if(d(o)&&d(o.PGEARTH_RTC)){var s=i.fromArray(o.PGEARTH_RTC.center);if(!i.equals(s,i.ZERO)){this._rtcCenter3D=s;var a=e.mapProjection,u=a.ellipsoid.cartesianToCartographic(this._rtcCenter3D),f=a.project(u);i.fromElements(f.z,f.x,f.y,f),this._rtcCenter2D=f,this._rtcCenterEye=new i,this._rtcCenter=this._rtcCenter3D}}this._loadResources=new L,I.parseBuffers(this)}var h=this._loadResources,_=!1;this._state===U.LOADING&&(0===h.pendingBufferLoads&&(I.checkSupportedExtensions(this.extensionsRequired,n),function(e){var t=e.gltf,i=e._loadResources;b.buffer(t,function(e,t){i.buffers[t]=e.extras._pipeline.source})}(this),function(e){var t=e.gltf.bufferViews,i=e._loadResources.vertexBuffersToCreate;b.bufferView(e.gltf,function(e,t){e.target===y.ARRAY_BUFFER&&i.enqueue(t)});var r=e._loadResources.indexBuffersToCreate,n={};b.accessor(e.gltf,function(e){var i=e.bufferView;t[i].target!==y.ELEMENT_ARRAY_BUFFER||d(n[i])||(n[i]=!0,r.enqueue({id:i,componentType:e.componentType}))})}(this),this._boundingSphere=I.computeBoundingSphere(this),this._initialRadius=this._boundingSphere.radius,H(this,e)),h.finished()&&(this._state=U.LOADED,_=!0)),d(h)&&this._state===U.LOADED&&(_||H(this,e),h.finished()&&(this._loadResources=void 0));var l=this.show;if(l&&this._state===U.LOADED||_){this._dirty=!1;var p=this.modelMatrix,v=e.mode!==this._mode;this._mode=e.mode;var T=!m.equals(this._modelMatrix,p)||v;if(T||_){m.clone(p,this._modelMatrix);var C=this._computedModelMatrix;m.clone(p,C),this._upAxis===A.Y?m.multiplyTransformation(C,A.Y_UP_TO_Z_UP,C):this._upAxis===A.X&&m.multiplyTransformation(C,A.X_UP_TO_Z_UP,C)}(T||_)&&(!function(e,n,o,s){var a=e._computedModelMatrix;if(e._mode!==M.SCENE3D&&!e._ignoreCommands){var u=m.getColumn(a,3,Y);if(r.equals(u,r.UNIT_W)){var f=e.boundingSphere.center,h=g.wgs84To2DModelMatrix(s,f,k);a=m.multiply(h,a,k),d(e._rtcCenter)&&(m.setTranslation(a,r.UNIT_W,a),e._rtcCenter=e._rtcCenter2D)}else a=g.basisTo2D(s,a,k),e._rtcCenter=e._rtcCenter3D}var c=e._primitive;(n||o)&&(m.multiplyTransformation(a,e._nodeMatrix,c._modelMatrix),t.transform(c._boundingSphere,c._modelMatrix,c._boundingVolume),d(e._rtcCenter)&&i.add(e._rtcCenter,c._boundingVolume.center,c._boundingVolume.center))}(this,T,_,e.mapProjection),this._dirty=!0)}if(_){var x=this;e.afterRender.push(function(){x._ready=!0,x._readyPromise.resolve(x)})}else l&&!this._ignoreCommands&&(this._primitive.debugShowBoundingVolume=this.debugShowBoundingVolume,this._primitive.debugWireframe=this.debugWireframe,this._primitive.update(e))}else c.supportsWebP.initialize()},V.prototype.isDestroyed=function(){return!1},V.prototype.destroy=function(){return this._primitive=this._primitive&&this._primitive.destroy(),f(this)},V});