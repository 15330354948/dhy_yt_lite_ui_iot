define(["../Core/BoundingRectangle","../Core/Cartesian2","../Core/Cartesian3","../Core/Color","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/DistanceDisplayCondition","../Core/freezeObject","../Core/NearFarScalar","./Billboard","./HeightReference","./HorizontalOrigin","./LabelStyle","./VerticalOrigin"],function(e,t,i,n,s,r,a,l,o,h,c,u,d,f,_,g){"use strict";var p=h({LTR:0,RTL:1,WEAK:2,BRACKETS:3});function b(e){e._rebindAllGlyphs||e._repositionAllGlyphs||e._labelCollection._labelsToUpdate.push(e),e._rebindAllGlyphs=!0}function y(e){e._rebindAllGlyphs||e._repositionAllGlyphs||e._labelCollection._labelsToUpdate.push(e),e._repositionAllGlyphs=!0}function v(e,a){if(e=s(e,s.EMPTY_OBJECT),r(e.disableDepthTestDistance)&&e.disableDepthTestDistance<0)throw new l("disableDepthTestDistance must be greater than 0.0.");var h=e.translucencyByDistance,u=e.pixelOffsetScaleByDistance,p=e.scaleByDistance,b=e.distanceDisplayCondition;if(r(h)){if(h.far<=h.near)throw new l("translucencyByDistance.far must be greater than translucencyByDistance.near.");h=c.clone(h)}if(r(u)){if(u.far<=u.near)throw new l("pixelOffsetScaleByDistance.far must be greater than pixelOffsetScaleByDistance.near.");u=c.clone(u)}if(r(p)){if(p.far<=p.near)throw new l("scaleByDistance.far must be greater than scaleByDistance.near.");p=c.clone(p)}if(r(b)){if(b.far<=b.near)throw new l("distanceDisplayCondition.far must be greater than distanceDisplayCondition.near.");b=o.clone(b)}this._renderedText=void 0,this._text=void 0,this._show=s(e.show,!0),this._font=s(e.font,"30px sans-serif"),this._fillColor=n.clone(s(e.fillColor,n.WHITE)),this._outlineColor=n.clone(s(e.outlineColor,n.BLACK)),this._outlineWidth=s(e.outlineWidth,1),this._showBackground=s(e.showBackground,!1),this._backgroundColor=s(e.backgroundColor,new n(.165,.165,.165,.8)),this._backgroundPadding=s(e.backgroundPadding,new t(7,5)),this._style=s(e.style,_.FILL),this._verticalOrigin=s(e.verticalOrigin,g.BASELINE),this._horizontalOrigin=s(e.horizontalOrigin,f.LEFT),this._pixelOffset=t.clone(s(e.pixelOffset,t.ZERO)),this._eyeOffset=i.clone(s(e.eyeOffset,i.ZERO)),this._position=i.clone(s(e.position,i.ZERO)),this._scale=s(e.scale,1),this._id=e.id,this._translucencyByDistance=h,this._pixelOffsetScaleByDistance=u,this._scaleByDistance=p,this._heightReference=s(e.heightReference,d.NONE),this._distanceDisplayCondition=b,this._disableDepthTestDistance=e.disableDepthTestDistance,this._labelCollection=a,this._glyphs=[],this._backgroundBillboard=void 0,this._batchIndex=void 0,this._rebindAllGlyphs=!0,this._repositionAllGlyphs=!0,this._actualClampedPosition=void 0,this._removeCallbackFunc=void 0,this._mode=void 0,this._clusterShow=!0,this.text=s(e.text,""),this._updateClamping()}function w(e,t){for(var i=/[a-zA-Z0-9]/,n=/[()[\]{}<>]/,s=[],r="",a=p.LTR,l="",o=e.length,h=0;h<o;++h){var c=e.charAt(h);l=t.test(c)?p.RTL:i.test(c)?p.LTR:n.test(c)?p.BRACKETS:p.WEAK,0===h&&(a=l),a===l&&l!==p.BRACKETS?r+=c:(""!==r&&s.push({Type:a,Word:r}),a=l,r=c)}return s.push({Type:l,Word:r}),s}function D(e,t,i){return e.slice(0,t)+i+e.slice(t)}function B(e){switch(e){case"(":return")";case")":return"(";case"[":return"]";case"]":return"[";case"{":return"}";case"}":return"{";case"<":return">";case">":return"<"}}a(v.prototype,{show:{get:function(){return this._show},set:function(e){if(!r(e))throw new l("value is required.");if(this._show!==e){this._show=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i].billboard;r(s)&&(s.show=e)}var a=this._backgroundBillboard;r(a)&&(a.show=e)}}},position:{get:function(){return this._position},set:function(e){if(!r(e))throw new l("value is required.");var t=this._position;if(!i.equals(t,e)){i.clone(e,t);for(var n=this._glyphs,s=0,a=n.length;s<a;s++){var o=n[s].billboard;r(o)&&(o.position=e)}var h=this._backgroundBillboard;r(h)&&(h.position=e),this._updateClamping()}}},heightReference:{get:function(){return this._heightReference},set:function(e){if(!r(e))throw new l("value is required.");if(e!==this._heightReference){this._heightReference=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i].billboard;r(s)&&(s.heightReference=e)}var a=this._backgroundBillboard;r(a)&&(a.heightReference=e),y(this),this._updateClamping()}}},text:{get:function(){return this._text},set:function(e){if(!r(e))throw new l("value is required.");this._text!==e&&(this._text=e,this._renderedText=v.enableRightToLeftDetection?function(e){for(var t=e.split("\n"),i="",n=0;n<t.length;n++){for(var s=t[n],r=C.test(s.charAt(0)),a=w(s,C),l=0,o="",h=0;h<a.length;++h){var c=a[h],u=c.Type===p.BRACKETS?B(c.Word):c.Word.split("").reverse().join("");r?c.Type===p.RTL?(o=u+o,l=0):c.Type===p.LTR?(o=D(o,l,c.Word),l+=c.Word.length):c.Type!==p.WEAK&&c.Type!==p.BRACKETS||(c.Type===p.WEAK&&a[h-1].Type===p.BRACKETS?o=u+o:a[h-1].Type===p.RTL?(o=u+o,l=0):a.length>h+1?a[h+1].Type===p.RTL?(o=u+o,l=0):(o=D(o,l,c.Word),l+=c.Word.length):o=D(o,0,u)):c.Type===p.RTL?o=D(o,l,u):c.Type===p.LTR?(o+=c.Word,l=o.length):c.Type!==p.WEAK&&c.Type!==p.BRACKETS||(h>0&&a[h-1].Type===p.RTL?a.length>h+1?a[h+1].Type===p.RTL?o=D(o,l,u):(o+=c.Word,l=o.length):o+=c.Word:(o+=c.Word,l=o.length))}i+=o,n<t.length-1&&(i+="\n")}return i}(e):e,b(this))}},font:{get:function(){return this._font},set:function(e){if(!r(e))throw new l("value is required.");this._font!==e&&(this._font=e,b(this))}},fillColor:{get:function(){return this._fillColor},set:function(e){if(!r(e))throw new l("value is required.");var t=this._fillColor;n.equals(t,e)||(n.clone(e,t),b(this))}},outlineColor:{get:function(){return this._outlineColor},set:function(e){if(!r(e))throw new l("value is required.");var t=this._outlineColor;n.equals(t,e)||(n.clone(e,t),b(this))}},outlineWidth:{get:function(){return this._outlineWidth},set:function(e){if(!r(e))throw new l("value is required.");this._outlineWidth!==e&&(this._outlineWidth=e,b(this))}},showBackground:{get:function(){return this._showBackground},set:function(e){if(!r(e))throw new l("value is required.");this._showBackground!==e&&(this._showBackground=e,b(this))}},backgroundColor:{get:function(){return this._backgroundColor},set:function(e){if(!r(e))throw new l("value is required.");var t=this._backgroundColor;if(!n.equals(t,e)){n.clone(e,t);var i=this._backgroundBillboard;r(i)&&(i.color=t)}}},backgroundPadding:{get:function(){return this._backgroundPadding},set:function(e){if(!r(e))throw new l("value is required.");var i=this._backgroundPadding;t.equals(i,e)||(t.clone(e,i),y(this))}},style:{get:function(){return this._style},set:function(e){if(!r(e))throw new l("value is required.");this._style!==e&&(this._style=e,b(this))}},pixelOffset:{get:function(){return this._pixelOffset},set:function(e){if(!r(e))throw new l("value is required.");var i=this._pixelOffset;if(!t.equals(i,e)){t.clone(e,i);for(var n=this._glyphs,s=0,a=n.length;s<a;s++){var o=n[s];r(o.billboard)&&(o.billboard.pixelOffset=e)}var h=this._backgroundBillboard;r(h)&&(h.pixelOffset=e)}}},translucencyByDistance:{get:function(){return this._translucencyByDistance},set:function(e){if(r(e)&&e.far<=e.near)throw new l("far distance must be greater than near distance.");var t=this._translucencyByDistance;if(!c.equals(t,e)){this._translucencyByDistance=c.clone(e,t);for(var i=this._glyphs,n=0,s=i.length;n<s;n++){var a=i[n];r(a.billboard)&&(a.billboard.translucencyByDistance=e)}var o=this._backgroundBillboard;r(o)&&(o.translucencyByDistance=e)}}},pixelOffsetScaleByDistance:{get:function(){return this._pixelOffsetScaleByDistance},set:function(e){if(r(e)&&e.far<=e.near)throw new l("far distance must be greater than near distance.");var t=this._pixelOffsetScaleByDistance;if(!c.equals(t,e)){this._pixelOffsetScaleByDistance=c.clone(e,t);for(var i=this._glyphs,n=0,s=i.length;n<s;n++){var a=i[n];r(a.billboard)&&(a.billboard.pixelOffsetScaleByDistance=e)}var o=this._backgroundBillboard;r(o)&&(o.pixelOffsetScaleByDistance=e)}}},scaleByDistance:{get:function(){return this._scaleByDistance},set:function(e){if(r(e)&&e.far<=e.near)throw new l("far distance must be greater than near distance.");var t=this._scaleByDistance;if(!c.equals(t,e)){this._scaleByDistance=c.clone(e,t);for(var i=this._glyphs,n=0,s=i.length;n<s;n++){var a=i[n];r(a.billboard)&&(a.billboard.scaleByDistance=e)}var o=this._backgroundBillboard;r(o)&&(o.scaleByDistance=e)}}},eyeOffset:{get:function(){return this._eyeOffset},set:function(e){if(!r(e))throw new l("value is required.");var t=this._eyeOffset;if(!i.equals(t,e)){i.clone(e,t);for(var n=this._glyphs,s=0,a=n.length;s<a;s++){var o=n[s];r(o.billboard)&&(o.billboard.eyeOffset=e)}var h=this._backgroundBillboard;r(h)&&(h.eyeOffset=e)}}},horizontalOrigin:{get:function(){return this._horizontalOrigin},set:function(e){if(!r(e))throw new l("value is required.");this._horizontalOrigin!==e&&(this._horizontalOrigin=e,y(this))}},verticalOrigin:{get:function(){return this._verticalOrigin},set:function(e){if(!r(e))throw new l("value is required.");if(this._verticalOrigin!==e){this._verticalOrigin=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i];r(s.billboard)&&(s.billboard.verticalOrigin=e)}var a=this._backgroundBillboard;r(a)&&(a.verticalOrigin=e),y(this)}}},scale:{get:function(){return this._scale},set:function(e){if(!r(e))throw new l("value is required.");if(this._scale!==e){this._scale=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i];r(s.billboard)&&(s.billboard.scale=e)}var a=this._backgroundBillboard;r(a)&&(a.scale=e),y(this)}}},distanceDisplayCondition:{get:function(){return this._distanceDisplayCondition},set:function(e){if(r(e)&&e.far<=e.near)throw new l("far must be greater than near");if(!o.equals(e,this._distanceDisplayCondition)){this._distanceDisplayCondition=o.clone(e,this._distanceDisplayCondition);for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i];r(s.billboard)&&(s.billboard.distanceDisplayCondition=e)}var a=this._backgroundBillboard;r(a)&&(a.distanceDisplayCondition=e)}}},disableDepthTestDistance:{get:function(){return this._disableDepthTestDistance},set:function(e){if(this._disableDepthTestDistance!==e){if(r(e)&&e<0)throw new l("disableDepthTestDistance must be greater than 0.0.");this._disableDepthTestDistance=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i];r(s.billboard)&&(s.billboard.disableDepthTestDistance=e)}var a=this._backgroundBillboard;r(a)&&(a.disableDepthTestDistance=e)}}},id:{get:function(){return this._id},set:function(e){if(this._id!==e){this._id=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i];r(s.billboard)&&(s.billboard.id=e)}var a=this._backgroundBillboard;r(a)&&(a.id=e)}}},pickId:{get:function(){if(0!==this._glyphs.length&&r(this._glyphs[0].billboard))return this._glyphs[0].billboard.pickId}},_clampedPosition:{get:function(){return this._actualClampedPosition},set:function(e){this._actualClampedPosition=i.clone(e,this._actualClampedPosition);for(var t=this._glyphs,n=0,s=t.length;n<s;n++){var a=t[n];r(a.billboard)&&(a.billboard._clampedPosition=e)}var l=this._backgroundBillboard;r(l)&&(l._clampedPosition=e)}},clusterShow:{get:function(){return this._clusterShow},set:function(e){if(this._clusterShow!==e){this._clusterShow=e;for(var t=this._glyphs,i=0,n=t.length;i<n;i++){var s=t[i];r(s.billboard)&&(s.billboard.clusterShow=e)}var a=this._backgroundBillboard;r(a)&&(a.clusterShow=e)}}}}),v.prototype._updateClamping=function(){u._updateClamping(this._labelCollection,this)},v.prototype.computeScreenSpacePosition=function(e,i){if(!r(e))throw new l("scene is required.");r(i)||(i=new t);var n=this._labelCollection.modelMatrix,s=r(this._actualClampedPosition)?this._actualClampedPosition:this._position;return u._computeScreenSpacePosition(n,s,this._eyeOffset,this._pixelOffset,e,i)},v.getScreenSpaceBoundingBox=function(t,i,n){var s=0,a=0,l=0,o=0,h=t.scale,c=t._labelCollection._resolutionScale,u=t._backgroundBillboard;if(r(u))s=i.x+u._translate.x/c,a=i.y-u._translate.y/c,l=u.width*h,o=u.height*h,t.verticalOrigin===g.BOTTOM||t.verticalOrigin===g.BASELINE?a-=o:t.verticalOrigin===g.CENTER&&(a-=.5*o);else{s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY;for(var d=0,f=0,_=t._glyphs,p=_.length,b=0;b<p;++b){var y=_[b].billboard;if(r(y)){var v=i.x+y._translate.x/c,w=i.y-y._translate.y/c,D=y.width*h,B=y.height*h;t.verticalOrigin===g.BOTTOM||t.verticalOrigin===g.BASELINE?w-=B:t.verticalOrigin===g.CENTER&&(w-=.5*B),s=Math.min(s,v),a=Math.min(a,w),d=Math.max(d,v+D),f=Math.max(f,w+B)}}l=d-s,o=f-a}return r(n)||(n=new e),n.x=s,n.y=a,n.width=l,n.height=o,n},v.prototype.equals=function(e){return this===e||r(e)&&this._show===e._show&&this._scale===e._scale&&this._outlineWidth===e._outlineWidth&&this._showBackground===e._showBackground&&this._style===e._style&&this._verticalOrigin===e._verticalOrigin&&this._horizontalOrigin===e._horizontalOrigin&&this._heightReference===e._heightReference&&this._renderedText===e._renderedText&&this._font===e._font&&i.equals(this._position,e._position)&&n.equals(this._fillColor,e._fillColor)&&n.equals(this._outlineColor,e._outlineColor)&&n.equals(this._backgroundColor,e._backgroundColor)&&t.equals(this._backgroundPadding,e._backgroundPadding)&&t.equals(this._pixelOffset,e._pixelOffset)&&i.equals(this._eyeOffset,e._eyeOffset)&&c.equals(this._translucencyByDistance,e._translucencyByDistance)&&c.equals(this._pixelOffsetScaleByDistance,e._pixelOffsetScaleByDistance)&&c.equals(this._scaleByDistance,e._scaleByDistance)&&o.equals(this._distanceDisplayCondition,e._distanceDisplayCondition)&&this._disableDepthTestDistance===e._disableDepthTestDistance&&this._id===e._id},v.prototype.isDestroyed=function(){return!1},v.enableRightToLeftDetection=!1;var C=new RegExp("[א-ת؀-ۿݐ-ݿࢠ-ࣿ]");return v});