define(["../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Check","../Core/Color","../Core/defined","../Core/defineProperties","../Core/DeveloperError","../Core/isArray","../Core/Math","../Core/RuntimeError","../ThirdParty/jsep","./ExpressionNodeType"],function(e,t,r,n,a,i,u,o,s,f,l,c,v){"use strict";function h(e,t){var r;n.typeOf.string("expression",e),this._expression=e,e=function(e){var t=e,r="",n=t.indexOf("${");for(;n>=0;){var a,i=t.indexOf("'"),u=t.indexOf('"');if(i>=0&&i<n)a=t.indexOf("'",i+1),r+=t.substr(0,a+1),t=t.substr(a+1),n=t.indexOf("${");else if(u>=0&&u<n)a=t.indexOf('"',u+1),r+=t.substr(0,a+1),t=t.substr(a+1),n=t.indexOf("${");else{r+=t.substr(0,n);var o=t.indexOf("}");if(o<0)throw new l("Unmatched {.");r+="czm_"+t.substr(n+2,o-(n+2)),t=t.substr(o+1),n=t.indexOf("${")}}return r+=t}(function(e){return e.replace(y,w)}(e=function(e,t){if(!i(t))return e;for(var r in t)if(t.hasOwnProperty(r)){var n=new RegExp("\\$\\{"+r+"\\}","g"),a="("+t[r]+")";i(a)&&(e=e.replace(n,a))}return e}(e,t))),c.addBinaryOp("=~",0),c.addBinaryOp("!~",0);try{r=c(e)}catch(e){throw new l(e)}this._runtimeAst=M(this,r)}u(h.prototype,{expression:{get:function(){return this._expression}}});var p={arrayIndex:0,arrayArray:[[]],cartesian2Index:0,cartesian3Index:0,cartesian4Index:0,cartesian2Array:[new e],cartesian3Array:[new t],cartesian4Array:[new r],reset:function(){this.arrayIndex=0,this.cartesian2Index=0,this.cartesian3Index=0,this.cartesian4Index=0},getArray:function(){this.arrayIndex>=this.arrayArray.length&&this.arrayArray.push([]);var e=this.arrayArray[this.arrayIndex++];return e.length=0,e},getCartesian2:function(){return this.cartesian2Index>=this.cartesian2Array.length&&this.cartesian2Array.push(new e),this.cartesian2Array[this.cartesian2Index++]},getCartesian3:function(){return this.cartesian3Index>=this.cartesian3Array.length&&this.cartesian3Array.push(new t),this.cartesian3Array[this.cartesian3Index++]},getCartesian4:function(){return this.cartesian4Index>=this.cartesian4Array.length&&this.cartesian4Array.push(new r),this.cartesian4Array[this.cartesian4Index++]}};h.prototype.evaluate=function(n,i){p.reset();var u=this._runtimeAst.evaluate(n);return i instanceof a&&u instanceof r?a.fromCartesian4(u,i):u instanceof e||u instanceof t||u instanceof r?u.clone(i):u},h.prototype.evaluateColor=function(e,t){p.reset();var r=this._runtimeAst.evaluate(e);return a.fromCartesian4(r,t)},h.prototype.getShaderFunction=function(e,t,r,n){var a=this.getShaderExpression(t,r);return a=n+" "+e+"() \n{ \n    return "+a+"; \n} \n"},h.prototype.getShaderExpression=function(e,t){return this._runtimeAst.getShaderExpression(e,t)};var g=["!","-","+"],_=["+","-","*","/","%","===","!==",">",">=","<","<=","&&","||","!~","=~"],m=/\${(.*?)}/g,y=/\\/g,w="@#%",E=/@#%/g,d=new a,x={abs:b(Math.abs),sqrt:b(Math.sqrt),cos:b(Math.cos),sin:b(Math.sin),tan:b(Math.tan),acos:b(Math.acos),asin:b(Math.asin),atan:b(Math.atan),radians:b(f.toRadians),degrees:b(f.toDegrees),sign:b(f.sign),floor:b(Math.floor),ceil:b(Math.ceil),round:b(Math.round),exp:b(Math.exp),exp2:b(function(e){return Math.pow(2,e)}),log:b(Math.log),log2:b(function(e){return f.log2(e)}),fract:b(function(e){return e-Math.floor(e)}),length:function(n,a){if("number"==typeof a)return Math.abs(a);if(a instanceof e)return e.magnitude(a);if(a instanceof t)return t.magnitude(a);if(a instanceof r)return r.magnitude(a);throw new l('Function "'+n+'" requires a vector or number argument. Argument is '+a+".")},normalize:function(n,a){if("number"==typeof a)return 1;if(a instanceof e)return e.normalize(a,p.getCartesian2());if(a instanceof t)return t.normalize(a,p.getCartesian3());if(a instanceof r)return r.normalize(a,p.getCartesian4());throw new l('Function "'+n+'" requires a vector or number argument. Argument is '+a+".")}},A={atan2:L(Math.atan2,!1),pow:L(Math.pow,!1),min:L(Math.min,!0),max:L(Math.max,!0),distance:function(n,a,i){if("number"==typeof a&&"number"==typeof i)return Math.abs(a-i);if(a instanceof e&&i instanceof e)return e.distance(a,i);if(a instanceof t&&i instanceof t)return t.distance(a,i);if(a instanceof r&&i instanceof r)return r.distance(a,i);throw new l('Function "'+n+'" requires vector or number arguments of matching types. Arguments are '+a+" and "+i+".")},dot:function(n,a,i){if("number"==typeof a&&"number"==typeof i)return a*i;if(a instanceof e&&i instanceof e)return e.dot(a,i);if(a instanceof t&&i instanceof t)return t.dot(a,i);if(a instanceof r&&i instanceof r)return r.dot(a,i);throw new l('Function "'+n+'" requires vector or number arguments of matching types. Arguments are '+a+" and "+i+".")},cross:function(e,r,n){if(r instanceof t&&n instanceof t)return t.cross(r,n,p.getCartesian3());throw new l('Function "'+e+'" requires vec3 arguments. Arguments are '+r+" and "+n+".")}},R={clamp:C(f.clamp,!0),mix:C(f.lerp,!0)};function b(n){return function(a,i){if("number"==typeof i)return n(i);if(i instanceof e)return e.fromElements(n(i.x),n(i.y),p.getCartesian2());if(i instanceof t)return t.fromElements(n(i.x),n(i.y),n(i.z),p.getCartesian3());if(i instanceof r)return r.fromElements(n(i.x),n(i.y),n(i.z),n(i.w),p.getCartesian4());throw new l('Function "'+a+'" requires a vector or number argument. Argument is '+i+".")}}function L(n,a){return function(i,u,o){if(a&&"number"==typeof o){if("number"==typeof u)return n(u,o);if(u instanceof e)return e.fromElements(n(u.x,o),n(u.y,o),p.getCartesian2());if(u instanceof t)return t.fromElements(n(u.x,o),n(u.y,o),n(u.z,o),p.getCartesian3());if(u instanceof r)return r.fromElements(n(u.x,o),n(u.y,o),n(u.z,o),n(u.w,o),p.getCartesian4())}if("number"==typeof u&&"number"==typeof o)return n(u,o);if(u instanceof e&&o instanceof e)return e.fromElements(n(u.x,o.x),n(u.y,o.y),p.getCartesian2());if(u instanceof t&&o instanceof t)return t.fromElements(n(u.x,o.x),n(u.y,o.y),n(u.z,o.z),p.getCartesian3());if(u instanceof r&&o instanceof r)return r.fromElements(n(u.x,o.x),n(u.y,o.y),n(u.z,o.z),n(u.w,o.w),p.getCartesian4());throw new l('Function "'+i+'" requires vector or number arguments of matching types. Arguments are '+u+" and "+o+".")}}function C(n,a){return function(i,u,o,s){if(a&&"number"==typeof s){if("number"==typeof u&&"number"==typeof o)return n(u,o,s);if(u instanceof e&&o instanceof e)return e.fromElements(n(u.x,o.x,s),n(u.y,o.y,s),p.getCartesian2());if(u instanceof t&&o instanceof t)return t.fromElements(n(u.x,o.x,s),n(u.y,o.y,s),n(u.z,o.z,s),p.getCartesian3());if(u instanceof r&&o instanceof r)return r.fromElements(n(u.x,o.x,s),n(u.y,o.y,s),n(u.z,o.z,s),n(u.w,o.w,s),p.getCartesian4())}if("number"==typeof u&&"number"==typeof o&&"number"==typeof s)return n(u,o,s);if(u instanceof e&&o instanceof e&&s instanceof e)return e.fromElements(n(u.x,o.x,s.x),n(u.y,o.y,s.y),p.getCartesian2());if(u instanceof t&&o instanceof t&&s instanceof t)return t.fromElements(n(u.x,o.x,s.x),n(u.y,o.y,s.y),n(u.z,o.z,s.z),p.getCartesian3());if(u instanceof r&&o instanceof r&&s instanceof r)return r.fromElements(n(u.x,o.x,s.x),n(u.y,o.y,s.y),n(u.z,o.z,s.z),n(u.w,o.w,s.w),p.getCartesian4());throw new l('Function "'+i+'" requires vector or number arguments of matching types. Arguments are '+u+", "+o+", and "+s+".")}}function I(e,t,r,n,a){var u,o,s;this._type=e,this._value=t,this._left=r,this._right=n,this._test=a,this.evaluate=void 0,(u=this)._type===v.CONDITIONAL?u.evaluate=u._evaluateConditional:u._type===v.FUNCTION_CALL?"test"===u._value?u.evaluate=u._evaluateRegExpTest:"exec"===u._value?u.evaluate=u._evaluateRegExpExec:"toString"===u._value&&(u.evaluate=u._evaluateToString):u._type===v.UNARY?"!"===u._value?u.evaluate=u._evaluateNot:"-"===u._value?u.evaluate=u._evaluateNegative:"+"===u._value?u.evaluate=u._evaluatePositive:"isNaN"===u._value?u.evaluate=u._evaluateNaN:"isFinite"===u._value?u.evaluate=u._evaluateIsFinite:"isExactClass"===u._value?u.evaluate=u._evaluateIsExactClass:"isClass"===u._value?u.evaluate=u._evaluateIsClass:"getExactClassName"===u._value?u.evaluate=u._evaluateGetExactClassName:"Boolean"===u._value?u.evaluate=u._evaluateBooleanConversion:"Number"===u._value?u.evaluate=u._evaluateNumberConversion:"String"===u._value?u.evaluate=u._evaluateStringConversion:i(x[u._value])&&(u.evaluate=(o=u._value,s=x[o],function(e){var t=this._left.evaluate(e);return s(o,t)})):u._type===v.BINARY?"+"===u._value?u.evaluate=u._evaluatePlus:"-"===u._value?u.evaluate=u._evaluateMinus:"*"===u._value?u.evaluate=u._evaluateTimes:"/"===u._value?u.evaluate=u._evaluateDivide:"%"===u._value?u.evaluate=u._evaluateMod:"==="===u._value?u.evaluate=u._evaluateEqualsStrict:"!=="===u._value?u.evaluate=u._evaluateNotEqualsStrict:"<"===u._value?u.evaluate=u._evaluateLessThan:"<="===u._value?u.evaluate=u._evaluateLessThanOrEquals:">"===u._value?u.evaluate=u._evaluateGreaterThan:">="===u._value?u.evaluate=u._evaluateGreaterThanOrEquals:"&&"===u._value?u.evaluate=u._evaluateAnd:"||"===u._value?u.evaluate=u._evaluateOr:"=~"===u._value?u.evaluate=u._evaluateRegExpMatch:"!~"===u._value?u.evaluate=u._evaluateRegExpNotMatch:i(A[u._value])&&(u.evaluate=function(e){var t=A[e];return function(r){var n=this._left.evaluate(r),a=this._right.evaluate(r);return t(e,n,a)}}(u._value)):u._type===v.TERNARY?u.evaluate=function(e){var t=R[e];return function(r){var n=this._left.evaluate(r),a=this._right.evaluate(r),i=this._test.evaluate(r);return t(e,n,a,i)}}(u._value):u._type===v.MEMBER?"brackets"===u._value?u.evaluate=u._evaluateMemberBrackets:u.evaluate=u._evaluateMemberDot:u._type===v.ARRAY?u.evaluate=u._evaluateArray:u._type===v.VARIABLE?u.evaluate=u._evaluateVariable:u._type===v.VARIABLE_IN_STRING?u.evaluate=u._evaluateVariableString:u._type===v.LITERAL_COLOR?u.evaluate=u._evaluateLiteralColor:u._type===v.LITERAL_VECTOR?u.evaluate=u._evaluateLiteralVector:u._type===v.LITERAL_STRING?u.evaluate=u._evaluateLiteralString:u._type===v.REGEX?u.evaluate=u._evaluateRegExp:u._type===v.BUILTIN_VARIABLE?"tiles3d_tileset_time"===u._value&&(u.evaluate=S):u.evaluate=u._evaluateLiteral}function N(e){return e.replace(E,"\\")}function T(e,t){var r,n,a,u,o=t.arguments,s=o.length;if("MemberExpression"===t.callee.type){r=t.callee.property.name;var f=t.callee.object;if("test"===r||"exec"===r){if("regExp"!==f.callee.name)throw new l(r+" is not a function.");return 0===s?"test"===r?new I(v.LITERAL_BOOLEAN,!1):new I(v.LITERAL_NULL,null):(a=M(e,f),u=M(e,o[0]),new I(v.FUNCTION_CALL,r,a,u))}if("toString"===r)return n=M(e,f),new I(v.FUNCTION_CALL,r,n);throw new l('Unexpected function call "'+r+'".')}if("color"===(r=t.callee.name)){if(0===s)return new I(v.LITERAL_COLOR,r);if(n=M(e,o[0]),i(o[1])){var c=M(e,o[1]);return new I(v.LITERAL_COLOR,r,[n,c])}return new I(v.LITERAL_COLOR,r,[n])}if("rgb"===r||"hsl"===r){if(s<3)throw new l(r+" requires three arguments.");return n=[M(e,o[0]),M(e,o[1]),M(e,o[2])],new I(v.LITERAL_COLOR,r,n)}if("rgba"===r||"hsla"===r){if(s<4)throw new l(r+" requires four arguments.");return n=[M(e,o[0]),M(e,o[1]),M(e,o[2]),M(e,o[3])],new I(v.LITERAL_COLOR,r,n)}if("vec2"===r||"vec3"===r||"vec4"===r){n=new Array(s);for(var h=0;h<s;++h)n[h]=M(e,o[h]);return new I(v.LITERAL_VECTOR,r,n)}if("isNaN"===r||"isFinite"===r)return 0===s?new I(v.LITERAL_BOOLEAN,"isNaN"===r):(n=M(e,o[0]),new I(v.UNARY,r,n));if("isExactClass"===r||"isClass"===r){if(s<1||s>1)throw new l(r+" requires exactly one argument.");return n=M(e,o[0]),new I(v.UNARY,r,n)}if("getExactClassName"===r){if(s>0)throw new l(r+" does not take any argument.");return new I(v.UNARY,r)}if(i(x[r])){if(1!==s)throw new l(r+" requires exactly one argument.");return n=M(e,o[0]),new I(v.UNARY,r,n)}if(i(A[r])){if(2!==s)throw new l(r+" requires exactly two arguments.");return a=M(e,o[0]),u=M(e,o[1]),new I(v.BINARY,r,a,u)}if(i(R[r])){if(3!==s)throw new l(r+" requires exactly three arguments.");a=M(e,o[0]),u=M(e,o[1]);var p=M(e,o[2]);return new I(v.TERNARY,r,a,u,p)}if("Boolean"===r)return 0===s?new I(v.LITERAL_BOOLEAN,!1):(n=M(e,o[0]),new I(v.UNARY,r,n));if("Number"===r)return 0===s?new I(v.LITERAL_NUMBER,0):(n=M(e,o[0]),new I(v.UNARY,r,n));if("String"===r)return 0===s?new I(v.LITERAL_STRING,""):(n=M(e,o[0]),new I(v.UNARY,r,n));if("regExp"===r)return function(e,t){var r=t.arguments;if(0===r.length)return new I(v.LITERAL_REGEX,new RegExp);var n,a=M(e,r[0]);if(r.length>1){var i=M(e,r[1]);if(B(a)&&B(i)){try{n=new RegExp(N(String(a._value)),i._value)}catch(e){throw new l(e)}return new I(v.LITERAL_REGEX,n)}return new I(v.REGEX,a,i)}if(B(a)){try{n=new RegExp(N(String(a._value)))}catch(e){throw new l(e)}return new I(v.LITERAL_REGEX,n)}return new I(v.REGEX,a)}(e,t);throw new l('Unexpected function call "'+r+'".')}function O(e,t){if("Math"===t.object.name)return function(e){var t=e.property.name;return"PI"===t?new I(v.LITERAL_NUMBER,Math.PI):"E"===t?new I(v.LITERAL_NUMBER,Math.E):void 0}(t);if("Number"===t.object.name)return function(e){if("POSITIVE_INFINITY"===e.property.name)return new I(v.LITERAL_NUMBER,Number.POSITIVE_INFINITY)}(t);var r,n=M(e,t.object);return t.computed?(r=M(e,t.property),new I(v.MEMBER,"brackets",n,r)):(r=new I(v.LITERAL_STRING,t.property.name),new I(v.MEMBER,"dot",n,r))}function B(e){return e._type>=v.LITERAL_NULL}function M(e,t){var r,n,a,i;if("Literal"===t.type)r=function(e){var t=typeof e.value;return null===e.value?new I(v.LITERAL_NULL,null):"boolean"===t?new I(v.LITERAL_BOOLEAN,e.value):"number"===t?new I(v.LITERAL_NUMBER,e.value):"string"===t?e.value.indexOf("${")>=0?new I(v.VARIABLE_IN_STRING,e.value):new I(v.LITERAL_STRING,N(e.value)):void 0}(t);else if("CallExpression"===t.type)r=T(e,t);else if("Identifier"===t.type)r=function(e){if(function(e){return"czm_"===e.substr(0,4)}(e.name)){var t=e.name.substr(4);return"tiles3d_"===t.substr(0,8)?new I(v.BUILTIN_VARIABLE,t):new I(v.VARIABLE,t)}if("NaN"===e.name)return new I(v.LITERAL_NUMBER,NaN);if("Infinity"===e.name)return new I(v.LITERAL_NUMBER,1/0);if("undefined"===e.name)return new I(v.LITERAL_UNDEFINED,void 0);throw new l(e.name+" is not defined.")}(t);else if("UnaryExpression"===t.type){n=t.operator;var u=M(e,t.argument);if(!(g.indexOf(n)>-1))throw new l('Unexpected operator "'+n+'".');r=new I(v.UNARY,n,u)}else if("BinaryExpression"===t.type){if(n=t.operator,a=M(e,t.left),i=M(e,t.right),!(_.indexOf(n)>-1))throw new l('Unexpected operator "'+n+'".');r=new I(v.BINARY,n,a,i)}else if("LogicalExpression"===t.type)n=t.operator,a=M(e,t.left),i=M(e,t.right),_.indexOf(n)>-1&&(r=new I(v.BINARY,n,a,i));else if("ConditionalExpression"===t.type){var o=M(e,t.test);a=M(e,t.consequent),i=M(e,t.alternate),r=new I(v.CONDITIONAL,"?",a,i,o)}else if("MemberExpression"===t.type)r=O(e,t);else{if("ArrayExpression"!==t.type)throw"Compound"===t.type?new l("Provide exactly one expression."):new l("Cannot parse expression.");for(var s=[],f=0;f<t.elements.length;f++)s[f]=M(e,t.elements[f]);r=new I(v.ARRAY,s)}return r}function S(e){return i(e)?e.content.tileset.timeSinceLoad:0}function q(e,t){if(i(e))return e.getProperty(t)}function U(e){return"feature"===e._value}function z(e){for(var t=e._left,r=t.length,n=0;n<r;++n)if(t[n]._type!==v.LITERAL_NUMBER)return;var i=t[0]._value,u=t[1]._value,o=t[2]._value,s=4===r?t[3]._value:1;return a.fromHsl(i,u,o,s,d)}function F(e){for(var t=e._left,r=t.length,n=0;n<r;++n)if(t[n]._type!==v.LITERAL_NUMBER)return;var a=d;return a.red=t[0]._value/255,a.green=t[1]._value/255,a.blue=t[2]._value/255,a.alpha=4===r?t[3]._value:1,a}function G(e){return e%1==0?e.toFixed(1):e.toString()}function Y(e){return"vec4("+G(e.red)+", "+G(e.green)+", "+G(e.blue)+", "+G(e.alpha)+")"}function V(e,t,r,n){for(var a=e.length,i=new Array(a),u=0;u<a;++u)i[u]=e[u].getShaderExpression(t,r,n);return i}return I.prototype._evaluateLiteral=function(){return this._value},I.prototype._evaluateLiteralColor=function(e){var t=d,n=this._left;if("color"===this._value)i(n)?n.length>1?(a.fromCssColorString(n[0].evaluate(e),t),t.alpha=n[1].evaluate(e)):a.fromCssColorString(n[0].evaluate(e),t):a.fromBytes(255,255,255,255,t);else if("rgb"===this._value)a.fromBytes(n[0].evaluate(e),n[1].evaluate(e),n[2].evaluate(e),255,t);else if("rgba"===this._value){var u=255*n[3].evaluate(e);a.fromBytes(n[0].evaluate(e),n[1].evaluate(e),n[2].evaluate(e),u,t)}else"hsl"===this._value?a.fromHsl(n[0].evaluate(e),n[1].evaluate(e),n[2].evaluate(e),1,t):"hsla"===this._value&&a.fromHsl(n[0].evaluate(e),n[1].evaluate(e),n[2].evaluate(e),n[3].evaluate(e),t);return r.fromColor(t,p.getCartesian4())},I.prototype._evaluateLiteralVector=function(n){for(var a=p.getArray(),i=this._value,u=this._left,o=u.length,s=0;s<o;++s){var f=u[s].evaluate(n);if("number"==typeof f)a.push(f);else if(f instanceof e)a.push(f.x,f.y);else if(f instanceof t)a.push(f.x,f.y,f.z);else{if(!(f instanceof r))throw new l(i+" argument must be a vector or number. Argument is "+f+".");a.push(f.x,f.y,f.z,f.w)}}var c=a.length,v=parseInt(i.charAt(3));if(0===c)throw new l("Invalid "+i+" constructor. No valid arguments.");if(c<v&&c>1)throw new l("Invalid "+i+" constructor. Not enough arguments.");if(c>v&&o>1)throw new l("Invalid "+i+" constructor. Too many arguments.");if(1===c){var h=a[0];a.push(h,h,h)}return"vec2"===i?e.fromArray(a,0,p.getCartesian2()):"vec3"===i?t.fromArray(a,0,p.getCartesian3()):"vec4"===i?r.fromArray(a,0,p.getCartesian4()):void 0},I.prototype._evaluateLiteralString=function(){return this._value},I.prototype._evaluateVariableString=function(e){for(var t=this._value,r=m.exec(t);null!==r;){var n=r[0],a=q(e,r[1]);i(a)||(a=""),t=t.replace(n,a),r=m.exec(t)}return t},I.prototype._evaluateVariable=function(e){return q(e,this._value)},I.prototype._evaluateMemberDot=function(n){if(U(this._left))return q(n,this._right.evaluate(n));var a=this._left.evaluate(n);if(i(a)){var u=this._right.evaluate(n);if(a instanceof e||a instanceof t||a instanceof r){if("r"===u)return a.x;if("g"===u)return a.y;if("b"===u)return a.z;if("a"===u)return a.w}return a[u]}},I.prototype._evaluateMemberBrackets=function(n){if(U(this._left))return q(n,this._right.evaluate(n));var a=this._left.evaluate(n);if(i(a)){var u=this._right.evaluate(n);if(a instanceof e||a instanceof t||a instanceof r){if(0===u||"r"===u)return a.x;if(1===u||"g"===u)return a.y;if(2===u||"b"===u)return a.z;if(3===u||"a"===u)return a.w}return a[u]}},I.prototype._evaluateArray=function(e){for(var t=[],r=0;r<this._value.length;r++)t[r]=this._value[r].evaluate(e);return t},I.prototype._evaluateNot=function(e){var t=this._left.evaluate(e);if("boolean"!=typeof t)throw new l('Operator "!" requires a boolean argument. Argument is '+t+".");return!t},I.prototype._evaluateNegative=function(n){var a=this._left.evaluate(n);if(a instanceof e)return e.negate(a,p.getCartesian2());if(a instanceof t)return t.negate(a,p.getCartesian3());if(a instanceof r)return r.negate(a,p.getCartesian4());if("number"==typeof a)return-a;throw new l('Operator "-" requires a vector or number argument. Argument is '+a+".")},I.prototype._evaluatePositive=function(n){var a=this._left.evaluate(n);if(!(a instanceof e||a instanceof t||a instanceof r||"number"==typeof a))throw new l('Operator "+" requires a vector or number argument. Argument is '+a+".");return a},I.prototype._evaluateLessThan=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if("number"!=typeof t||"number"!=typeof r)throw new l('Operator "<" requires number arguments. Arguments are '+t+" and "+r+".");return t<r},I.prototype._evaluateLessThanOrEquals=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if("number"!=typeof t||"number"!=typeof r)throw new l('Operator "<=" requires number arguments. Arguments are '+t+" and "+r+".");return t<=r},I.prototype._evaluateGreaterThan=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if("number"!=typeof t||"number"!=typeof r)throw new l('Operator ">" requires number arguments. Arguments are '+t+" and "+r+".");return t>r},I.prototype._evaluateGreaterThanOrEquals=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if("number"!=typeof t||"number"!=typeof r)throw new l('Operator ">=" requires number arguments. Arguments are '+t+" and "+r+".");return t>=r},I.prototype._evaluateOr=function(e){var t=this._left.evaluate(e);if("boolean"!=typeof t)throw new l('Operator "||" requires boolean arguments. First argument is '+t+".");if(t)return!0;var r=this._right.evaluate(e);if("boolean"!=typeof r)throw new l('Operator "||" requires boolean arguments. Second argument is '+r+".");return t||r},I.prototype._evaluateAnd=function(e){var t=this._left.evaluate(e);if("boolean"!=typeof t)throw new l('Operator "&&" requires boolean arguments. First argument is '+t+".");if(!t)return!1;var r=this._right.evaluate(e);if("boolean"!=typeof r)throw new l('Operator "&&" requires boolean arguments. Second argument is '+r+".");return t&&r},I.prototype._evaluatePlus=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);if(i instanceof e&&a instanceof e)return e.add(a,i,p.getCartesian2());if(i instanceof t&&a instanceof t)return t.add(a,i,p.getCartesian3());if(i instanceof r&&a instanceof r)return r.add(a,i,p.getCartesian4());if("string"==typeof a||"string"==typeof i)return a+i;if("number"==typeof a&&"number"==typeof i)return a+i;throw new l('Operator "+" requires vector or number arguments of matching types, or at least one string argument. Arguments are '+a+" and "+i+".")},I.prototype._evaluateMinus=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);if(i instanceof e&&a instanceof e)return e.subtract(a,i,p.getCartesian2());if(i instanceof t&&a instanceof t)return t.subtract(a,i,p.getCartesian3());if(i instanceof r&&a instanceof r)return r.subtract(a,i,p.getCartesian4());if("number"==typeof a&&"number"==typeof i)return a-i;throw new l('Operator "-" requires vector or number arguments of matching types. Arguments are '+a+" and "+i+".")},I.prototype._evaluateTimes=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);if(i instanceof e&&a instanceof e)return e.multiplyComponents(a,i,p.getCartesian2());if(i instanceof e&&"number"==typeof a)return e.multiplyByScalar(i,a,p.getCartesian2());if(a instanceof e&&"number"==typeof i)return e.multiplyByScalar(a,i,p.getCartesian2());if(i instanceof t&&a instanceof t)return t.multiplyComponents(a,i,p.getCartesian3());if(i instanceof t&&"number"==typeof a)return t.multiplyByScalar(i,a,p.getCartesian3());if(a instanceof t&&"number"==typeof i)return t.multiplyByScalar(a,i,p.getCartesian3());if(i instanceof r&&a instanceof r)return r.multiplyComponents(a,i,p.getCartesian4());if(i instanceof r&&"number"==typeof a)return r.multiplyByScalar(i,a,p.getCartesian4());if(a instanceof r&&"number"==typeof i)return r.multiplyByScalar(a,i,p.getCartesian4());if("number"==typeof a&&"number"==typeof i)return a*i;throw new l('Operator "*" requires vector or number arguments. If both arguments are vectors they must be matching types. Arguments are '+a+" and "+i+".")},I.prototype._evaluateDivide=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);if(i instanceof e&&a instanceof e)return e.divideComponents(a,i,p.getCartesian2());if(a instanceof e&&"number"==typeof i)return e.divideByScalar(a,i,p.getCartesian2());if(i instanceof t&&a instanceof t)return t.divideComponents(a,i,p.getCartesian3());if(a instanceof t&&"number"==typeof i)return t.divideByScalar(a,i,p.getCartesian3());if(i instanceof r&&a instanceof r)return r.divideComponents(a,i,p.getCartesian4());if(a instanceof r&&"number"==typeof i)return r.divideByScalar(a,i,p.getCartesian4());if("number"==typeof a&&"number"==typeof i)return a/i;throw new l('Operator "/" requires vector or number arguments of matching types, or a number as the second argument. Arguments are '+a+" and "+i+".")},I.prototype._evaluateMod=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);if(i instanceof e&&a instanceof e)return e.fromElements(a.x%i.x,a.y%i.y,p.getCartesian2());if(i instanceof t&&a instanceof t)return t.fromElements(a.x%i.x,a.y%i.y,a.z%i.z,p.getCartesian3());if(i instanceof r&&a instanceof r)return r.fromElements(a.x%i.x,a.y%i.y,a.z%i.z,a.w%i.w,p.getCartesian4());if("number"==typeof a&&"number"==typeof i)return a%i;throw new l('Operator "%" requires vector or number arguments of matching types. Arguments are '+a+" and "+i+".")},I.prototype._evaluateEqualsStrict=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);return i instanceof e&&a instanceof e||i instanceof t&&a instanceof t||i instanceof r&&a instanceof r?a.equals(i):a===i},I.prototype._evaluateNotEqualsStrict=function(n){var a=this._left.evaluate(n),i=this._right.evaluate(n);return i instanceof e&&a instanceof e||i instanceof t&&a instanceof t||i instanceof r&&a instanceof r?!a.equals(i):a!==i},I.prototype._evaluateConditional=function(e){var t=this._test.evaluate(e);if("boolean"!=typeof t)throw new l("Conditional argument of conditional expression must be a boolean. Argument is "+t+".");return t?this._left.evaluate(e):this._right.evaluate(e)},I.prototype._evaluateNaN=function(e){return isNaN(this._left.evaluate(e))},I.prototype._evaluateIsFinite=function(e){return isFinite(this._left.evaluate(e))},I.prototype._evaluateIsExactClass=function(e){return!!i(e)&&e.isExactClass(this._left.evaluate(e))},I.prototype._evaluateIsClass=function(e){return!!i(e)&&e.isClass(this._left.evaluate(e))},I.prototype._evaluateGetExactClassName=function(e){if(i(e))return e.getExactClassName()},I.prototype._evaluateBooleanConversion=function(e){return Boolean(this._left.evaluate(e))},I.prototype._evaluateNumberConversion=function(e){return Number(this._left.evaluate(e))},I.prototype._evaluateStringConversion=function(e){return String(this._left.evaluate(e))},I.prototype._evaluateRegExp=function(e){var t,r=this._value.evaluate(e),n="";i(this._left)&&(n=this._left.evaluate(e));try{t=new RegExp(r,n)}catch(e){throw new l(e)}return t},I.prototype._evaluateRegExpTest=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if(!(t instanceof RegExp&&"string"==typeof r))throw new l("RegExp.test requires the first argument to be a RegExp and the second argument to be a string. Arguments are "+t+" and "+r+".");return t.test(r)},I.prototype._evaluateRegExpMatch=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if(t instanceof RegExp&&"string"==typeof r)return t.test(r);if(r instanceof RegExp&&"string"==typeof t)return r.test(t);throw new l('Operator "=~" requires one RegExp argument and one string argument. Arguments are '+t+" and "+r+".")},I.prototype._evaluateRegExpNotMatch=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if(t instanceof RegExp&&"string"==typeof r)return!t.test(r);if(r instanceof RegExp&&"string"==typeof t)return!r.test(t);throw new l('Operator "!~" requires one RegExp argument and one string argument. Arguments are '+t+" and "+r+".")},I.prototype._evaluateRegExpExec=function(e){var t=this._left.evaluate(e),r=this._right.evaluate(e);if(!(t instanceof RegExp&&"string"==typeof r))throw new l("RegExp.exec requires the first argument to be a RegExp and the second argument to be a string. Arguments are "+t+" and "+r+".");var n=t.exec(r);return i(n)?n[1]:null},I.prototype._evaluateToString=function(n){var a=this._left.evaluate(n);if(a instanceof RegExp||a instanceof e||a instanceof t||a instanceof r)return String(a);throw new l('Unexpected function call "'+this._value+'".')},I.prototype.getShaderExpression=function(e,t,r){var n,u,f,c,h=this._type,p=this._value;switch(i(this._left)&&(u=s(this._left)?V(this._left,e,t,this):this._left.getShaderExpression(e,t,this)),i(this._right)&&(f=this._right.getShaderExpression(e,t,this)),i(this._test)&&(c=this._test.getShaderExpression(e,t,this)),s(this._value)&&(p=V(this._value,e,t,this)),h){case v.VARIABLE:return e+p;case v.UNARY:if("Boolean"===p)return"bool("+u+")";if("Number"===p)return"float("+u+")";if("round"===p)return"floor("+u+" + 0.5)";if(i(x[p]))return p+"("+u+")";if("isNaN"===p||"isFinite"===p||"String"===p||"isExactClass"===p||"isClass"===p||"getExactClassName"===p)throw new l('Error generating style shader: "'+p+'" is not supported.');return i(x[p])?p+"("+u+")":p+u;case v.BINARY:return"%"===p?"mod("+u+", "+f+")":"==="===p?"("+u+" == "+f+")":"!=="===p?"("+u+" != "+f+")":"atan2"===p?"atan("+u+", "+f+")":i(A[p])?p+"("+u+", "+f+")":"("+u+" "+p+" "+f+")";case v.TERNARY:if(i(R[p]))return p+"("+u+", "+f+", "+c+")";break;case v.CONDITIONAL:return"("+c+" ? "+u+" : "+f+")";case v.MEMBER:return"r"===f||"x"===f||"0.0"===f?u+"[0]":"g"===f||"y"===f||"1.0"===f?u+"[1]":"b"===f||"z"===f||"2.0"===f?u+"[2]":"a"===f||"w"===f||"3.0"===f?u+"[3]":u+"[int("+f+")]";case v.FUNCTION_CALL:throw new l('Error generating style shader: "'+p+'" is not supported.');case v.ARRAY:if(4===p.length)return"vec4("+p[0]+", "+p[1]+", "+p[2]+", "+p[3]+")";if(3===p.length)return"vec3("+p[0]+", "+p[1]+", "+p[2]+")";if(2===p.length)return"vec2("+p[0]+", "+p[1]+")";throw new l("Error generating style shader: Invalid array length. Array length should be 2, 3, or 4.");case v.REGEX:throw new l("Error generating style shader: Regular expressions are not supported.");case v.VARIABLE_IN_STRING:throw new l("Error generating style shader: Converting a variable to a string is not supported.");case v.LITERAL_NULL:throw new l("Error generating style shader: null is not supported.");case v.LITERAL_BOOLEAN:return p?"true":"false";case v.LITERAL_NUMBER:return G(p);case v.LITERAL_STRING:if(i(r)&&r._type===v.MEMBER&&("r"===p||"g"===p||"b"===p||"a"===p||"x"===p||"y"===p||"z"===p||"w"===p))return p;if(n=a.fromCssColorString(p,d),i(n))return function(e){return"vec3("+G(e.red)+", "+G(e.green)+", "+G(e.blue)+")"}(n);throw new l("Error generating style shader: String literals are not supported.");case v.LITERAL_COLOR:var g=u;if("color"===p){if(!i(g))return"vec4(1.0)";if(g.length>1){var _=g[0],m=g[1];return"1.0"!==m&&(t.translucent=!0),"vec4("+_+", "+m+")"}return"vec4("+g[0]+", 1.0)"}if("rgb"===p)return n=F(this),i(n)?Y(n):"vec4("+g[0]+" / 255.0, "+g[1]+" / 255.0, "+g[2]+" / 255.0, 1.0)";if("rgba"===p)return"1.0"!==g[3]&&(t.translucent=!0),n=F(this),i(n)?Y(n):"vec4("+g[0]+" / 255.0, "+g[1]+" / 255.0, "+g[2]+" / 255.0, "+g[3]+")";if("hsl"===p)return n=z(this),i(n)?Y(n):"vec4(czm_HSLToRGB(vec3("+g[0]+", "+g[1]+", "+g[2]+")), 1.0)";if("hsla"===p)return n=z(this),i(n)?(1!==n.alpha&&(t.translucent=!0),Y(n)):("1.0"!==g[3]&&(t.translucent=!0),"vec4(czm_HSLToRGB(vec3("+g[0]+", "+g[1]+", "+g[2]+")), "+g[3]+")");break;case v.LITERAL_VECTOR:if(!i(u))throw new o("left should always be defined for type ExpressionNodeType.LITERAL_VECTOR");for(var y=u.length,w=p+"(",E=0;E<y;++E)w+=u[E],E<y-1&&(w+=", ");return w+=")";case v.LITERAL_REGEX:throw new l("Error generating style shader: Regular expressions are not supported.");case v.LITERAL_UNDEFINED:throw new l("Error generating style shader: undefined is not supported.");case v.BUILTIN_VARIABLE:if("tiles3d_tileset_time"===p)return"u_time"}},h});