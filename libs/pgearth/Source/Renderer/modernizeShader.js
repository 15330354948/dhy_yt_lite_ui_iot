define(["../Core/defined","../Core/DeveloperError"],function(e,r){"use strict";function t(e,r,t){for(var n=new RegExp("(^|[^\\w])("+e+")($|[^\\w])","g"),o=t.length,f=0;f<o;++f){var i=t[f];t[f]=i.replace(n,"$1"+r+"$3")}}function n(e,r){-1===r.indexOf(e)&&r.push(e)}function o(e,r){!function(e,r,t){for(var n=t.length,o=0;o<n;++o){var f=t[o];t[o]=f.replace(e,r)}}(new RegExp("#extension\\s+GL_"+e+"\\s+:\\s+[a-zA-Z0-9]+\\s*$","g"),"",r)}return function(f,i){var a=/#define OUTPUT_DECLARATION/,l=f.split("\n");if(/#version 300 es/g.test(f))return f;var g,s,u=-1;for(g=0;g<l.length;++g)if(s=l[g],a.test(s)){u=g;break}if(-1===u)throw new r("Could not find a #define OUTPUT_DECLARATION!");var v=[];for(g=0;g<10;g++){var c="gl_FragData\\["+g+"\\]",p="czm_out"+g;new RegExp(c,"g").test(f)&&(n(p,v),t(c,p,l),l.splice(u,0,"layout(location = "+g+") out vec4 "+p+";"),u+=1)}(function(e,r){for(var t=new RegExp("(^|[^\\w])("+e+")($|[^\\w])","g"),n=r.length,o=0;o<n;++o){var f=r[o];if(t.test(f))return!0}return!1})("gl_FragColor",l)&&(n("czm_fragColor",v),t("gl_FragColor","czm_fragColor",l),l.splice(u,0,"layout(location = 0) out vec4 czm_fragColor;"),u+=1);var h=function(r,t){for(var n={},o=r.length,f=[],i=0;i<t.length;++i){var a=t[i],l=/(#ifdef|#if)/g.test(a),g=/#else/g.test(a),s=/#endif/g.test(a);if(l)f.push(a);else if(g){var u=f[f.length-1],v=u.replace("ifdef","ifndef");/if/g.test(v)&&(v=v.replace(/(#if\s+)(\S*)([^]*)/,"$1!($2)$3")),f.pop(),f.push(v)}else if(s)f.pop();else if(!/layout/g.test(a))for(var c=0;c<o;++c){var p=r[c];-1!==a.indexOf(p)&&(e(n[p])?n[p]=n[p].filter(function(e){return f.indexOf(e)>=0}):n[p]=f.slice())}}return n}(v,l),d={};for(g=0;g<l.length;g++)for(var x in s=l[g],h)h.hasOwnProperty(x)&&new RegExp("(layout)[^]+(out)[^]+("+x+")[^]+","g").test(s)&&(d[s]=x);for(var _ in d)if(d.hasOwnProperty(_)){var w,C=d[_],E=l.indexOf(_),O=h[C],T=O.length;for(w=0;w<T;w++)l.splice(E,0,O[w]);for(E+=T+1,w=T-1;w>=0;w--)l.splice(E,0,"#endif //"+O[w])}var y=!1;for(g=0;g<l.length;g++)/#version/.test(l[g])&&(l[g]="#version 300 es",y=!0);return y||l.splice(0,0,"#version 300 es"),o("EXT_draw_buffers",l),o("EXT_frag_depth",l),t("texture2D","texture",l),t("texture3D","texture",l),t("textureCube","texture",l),t("gl_FragDepthEXT","gl_FragDepth",l),i?t("varying","in",l):(t("attribute","in",l),t("varying","out",l)),function(e){for(var r="",t=e.length,n=0;n<t;++n)r+=e[n]+"\n";return r}(l)}});