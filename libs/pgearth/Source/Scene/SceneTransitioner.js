define(["../Core/Cartesian3","../Core/Cartographic","../Core/Check","../Core/defined","../Core/destroyObject","../Core/EasingFunction","../Core/Math","../Core/Matrix4","../Core/OrthographicFrustum","../Core/OrthographicOffCenterFrustum","../Core/PerspectiveFrustum","../Core/Ray","../Core/ScreenSpaceEventHandler","../Core/ScreenSpaceEventType","../Core/Transforms","./Camera","./SceneMode"],function(e,t,o,i,r,n,s,c,a,u,p,m,h,d,l,f,_){"use strict";function v(e){o.typeOf.object("scene",e),this._scene=e,this._currentTweens=[],this._morphHandler=void 0,this._morphCancelled=!1,this._completeMorph=void 0,this._morphToOrthographic=!1}v.prototype.completeMorph=function(){i(this._completeMorph)&&this._completeMorph()},v.prototype.morphTo2D=function(t,o){i(this._completeMorph)&&this._completeMorph();var r=this._scene;this._previousMode=r.mode,this._morphToOrthographic=r.camera.frustum instanceof a,this._previousMode!==_.SCENE2D&&this._previousMode!==_.MORPHING&&(this._scene.morphStart.raiseEvent(this,this._previousMode,_.SCENE2D,!0),r._mode=_.MORPHING,r.camera._setTransform(c.IDENTITY),this._previousMode===_.COLUMBUS_VIEW?function(t,o){o*=.5;var r=t._scene,s=r.camera,a=e.clone(s.position,ee),u=e.clone(s.direction,te),p=e.clone(s.up,oe),m=e.negate(e.UNIT_Z,re),h=e.clone(e.UNIT_Y,ne),d=ie;if(o>0)e.clone(e.ZERO,ie),d.z=5*r.mapProjection.ellipsoid.maximumRadius;else{e.clone(a,ie);var l=ce;c.multiplyByPoint(f.TRANSFORM_2D,a,l.origin),c.multiplyByPointAsVector(f.TRANSFORM_2D,u,l.direction);var _=r.globe;if(i(_)){var v=_.pickWorldCoordinates(l,r,ae);i(v)&&(c.multiplyByPoint(f.TRANSFORM_2D_INVERSE,v,d),d.z+=e.distance(a,d))}}var g=se;g.right=.5*d.z,g.left=-g.right,g.top=g.right*(r.drawingBufferHeight/r.drawingBufferWidth),g.bottom=-g.top;var w=ue;w.position=d,w.direction=m,w.up=h,w.frustum=g;var T=Me(w);function M(e,t){e.position.z=t}U(t,T);var R=r.tweens.add({duration:o,easingFunction:n.QUARTIC_OUT,startObject:{time:0},stopObject:{time:1},update:function(t){K(a,d,t.time,s.position),K(u,m,t.time,s.direction),K(p,h,t.time,s.up),e.cross(s.direction,s.up,s.right),e.normalize(s.right,s.right),s._adjustOrthographicFrustum(!0)},complete:function(){$(t,o,w,M,T)}});t._currentTweens.push(R)}(this,t):function(t,o,r){o*=.5;var n=t._scene,s=n.camera,a=me;if(o>0)e.clone(e.ZERO,a.position),a.position.z=5*r.maximumRadius,e.negate(e.UNIT_Z,a.direction),e.clone(e.UNIT_Y,a.up);else{r.cartesianToCartographic(s.positionWC,pe),n.mapProjection.project(pe,a.position),e.negate(e.UNIT_Z,a.direction),e.clone(e.UNIT_Y,a.up);var u=le;e.clone(a.position2D,u.origin);var p=e.clone(s.directionWC,u.direction),m=r.scaleToGeodeticSurface(s.positionWC,_e),h=l.eastNorthUpToFixedFrame(m,r,fe);c.inverseTransformation(h,h),c.multiplyByPointAsVector(h,p,p),c.multiplyByPointAsVector(f.TRANSFORM_2D,p,p);var d=n.globe;if(i(d)){var _=d.pickWorldCoordinates(u,n,de);if(i(_)){var v=e.distance(a.position2D,_);_.x+=v,e.clone(_,a.position2D)}}}function g(e,t){e.position.x=t}c.multiplyByPoint(f.TRANSFORM_2D,a.position,a.position2D),c.multiplyByPointAsVector(f.TRANSFORM_2D,a.direction,a.direction2D),c.multiplyByPointAsVector(f.TRANSFORM_2D,a.up,a.up2D);var w=a.frustum;w.right=.5*a.position.z,w.left=-w.right,w.top=w.right*(n.drawingBufferHeight/n.drawingBufferWidth),w.bottom=-w.top;var T=he;c.multiplyByPoint(f.TRANSFORM_2D_INVERSE,a.position2D,T.position),e.clone(a.direction,T.direction),e.clone(a.up,T.up),T.frustum=w;var M=Me(T);U(t,M),ge(t,o,a,function(){$(t,o,a,g,M)})}(this,t,o),0===t&&i(this._completeMorph)&&this._completeMorph())};var g=new e,w=new e,T=new e,M=new e,R=new e,E=new e,C=new e,O=new t,D=new c,N=new p,y=new a,S={position:void 0,direction:void 0,up:void 0,position2D:void 0,direction2D:void 0,up2D:void 0,frustum:void 0};v.prototype.morphToColumbusView=function(t,o){i(this._completeMorph)&&this._completeMorph();var r=this._scene;if(this._previousMode=r.mode,this._previousMode!==_.COLUMBUS_VIEW&&this._previousMode!==_.MORPHING){this._scene.morphStart.raiseEvent(this,this._previousMode,_.COLUMBUS_VIEW,!0),r.camera._setTransform(c.IDENTITY);var a,u=g,p=w,m=T;if(t>0)u.x=0,u.y=-1,u.z=1,u=e.multiplyByScalar(e.normalize(u,u),5*o.maximumRadius,u),e.negate(e.normalize(u,p),p),e.cross(e.UNIT_X,p,m);else{var h=r.camera;if(this._previousMode===_.SCENE2D)e.clone(h.position,u),u.z=h.frustum.right-h.frustum.left,e.negate(e.UNIT_Z,p),e.clone(e.UNIT_Y,m);else{e.clone(h.positionWC,u),e.clone(h.directionWC,p),e.clone(h.upWC,m);var d=o.scaleToGeodeticSurface(u,C),v=l.eastNorthUpToFixedFrame(d,o,D);c.inverseTransformation(v,v),r.mapProjection.project(o.cartesianToCartographic(u,O),u),c.multiplyByPointAsVector(v,p,p),c.multiplyByPointAsVector(v,m,m)}}this._morphToOrthographic?((a=y).width=r.camera.frustum.right-r.camera.frustum.left,a.aspectRatio=r.drawingBufferWidth/r.drawingBufferHeight):((a=N).aspectRatio=r.drawingBufferWidth/r.drawingBufferHeight,a.fov=s.toRadians(60));var I=S;I.position=u,I.direction=p,I.up=m,I.frustum=a;var A=function(t){return function(o){var r=o._scene;r._mode=_.COLUMBUS_VIEW,r.morphTime=_.getMorphTime(_.COLUMBUS_VIEW),B(o);var n=r.camera;(o._previousModeMode!==_.MORPHING||o._morphCancelled)&&(o._morphCancelled=!1,e.clone(t.position,n.position),e.clone(t.direction,n.direction),e.clone(t.up,n.up),e.cross(n.direction,n.up,n.right),e.normalize(n.right,n.right));var s=n.frustum;r.frameState.useLogDepth&&(s.near=.1,s.far=1e10);var c=i(o._completeMorph);o._completeMorph=void 0,r.camera.update(r.mode),o._scene.morphComplete.raiseEvent(o,o._previousMode,_.COLUMBUS_VIEW,c)}}(I);U(this,A),this._previousMode===_.SCENE2D?function(t,o,i,r){o*=.5;var s=t._scene,c=s.camera,a=e.clone(i.position,X),u=e.clone(i.direction,q),p=e.clone(i.up,J);function m(){c.frustum=i.frustum.clone();var m=e.clone(c.position,Q),h=e.clone(c.direction,Y),d=e.clone(c.up,k);m.z=a.z;var l=s.tweens.add({duration:o,easingFunction:n.QUARTIC_OUT,startObject:{time:0},stopObject:{time:1},update:function(t){K(m,a,t.time,c.position),K(h,u,t.time,c.direction),K(d,p,t.time,c.up),e.cross(c.direction,c.up,c.right),e.normalize(c.right,c.right)},complete:function(){r(t)}});t._currentTweens.push(l)}s._mode=_.MORPHING,t._morphToOrthographic?m():ve(t,0,i,m)}(this,t,I,A):(I.position2D=c.multiplyByPoint(f.TRANSFORM_2D,u,M),I.direction2D=c.multiplyByPointAsVector(f.TRANSFORM_2D,p,R),I.up2D=c.multiplyByPointAsVector(f.TRANSFORM_2D,m,E),r._mode=_.MORPHING,ge(this,t,I,A)),0===t&&i(this._completeMorph)&&this._completeMorph()}};var I={position:new e,direction:new e,up:new e,frustum:void 0},A=new p;function U(e,t){if(e._scene.completeMorphOnUserInput){e._morphHandler=new h(e._scene.canvas,!1);var o=function(){e._morphCancelled=!0,e._scene.camera.cancelFlight(),t(e)};e._completeMorph=o,e._morphHandler.setInputAction(o,d.LEFT_DOWN),e._morphHandler.setInputAction(o,d.MIDDLE_DOWN),e._morphHandler.setInputAction(o,d.RIGHT_DOWN),e._morphHandler.setInputAction(o,d.WHEEL)}}function B(e){for(var t=e._currentTweens,o=0;o<t.length;++o)t[o].cancelTween();e._currentTweens.length=0,e._morphHandler=e._morphHandler&&e._morphHandler.destroy()}v.prototype.morphTo3D=function(t,o){i(this._completeMorph)&&this._completeMorph();var r=this._scene;if(this._previousMode=r.mode,this._previousMode!==_.SCENE3D&&this._previousMode!==_.MORPHING){if(this._scene.morphStart.raiseEvent(this,this._previousMode,_.SCENE3D,!0),r._mode=_.MORPHING,r.camera._setTransform(c.IDENTITY),this._previousMode===_.SCENE2D)!function(t,o,i){o/=3;var r,n,c=t._scene,a=c.camera;o>0?(r=I,e.fromDegrees(0,0,5*i.maximumRadius,i,r.position),e.negate(r.position,r.direction),e.normalize(r.direction,r.direction),e.clone(e.UNIT_Z,r.up)):(a.position.z=a.frustum.right-a.frustum.left,r=V(t,i));t._morphToOrthographic?((n=Z).aspectRatio=c.drawingBufferWidth/c.drawingBufferHeight,n.width=a.frustum.right-a.frustum.left):((n=A).aspectRatio=c.drawingBufferWidth/c.drawingBufferHeight,n.fov=s.toRadians(60));r.frustum=n;var u,p=Te(r);U(t,p),u=t._morphToOrthographic?function(){L(t,o,r,p)}:function(){ve(t,o,r,function(){L(t,o,r,p)})};o>0?(c._mode=_.SCENE2D,a.flyTo({duration:o,destination:e.fromDegrees(0,0,5*i.maximumRadius,i,X),complete:function(){c._mode=_.MORPHING,u()}})):u()}(this,t,o);else{var n,u;t>0?(n=I,e.fromDegrees(0,0,5*o.maximumRadius,o,n.position),e.negate(n.position,n.direction),e.normalize(n.direction,n.direction),e.clone(e.UNIT_Z,n.up)):n=V(this,o);var p=r.camera;p.frustum instanceof a?u=p.frustum.clone():((u=A).aspectRatio=r.drawingBufferWidth/r.drawingBufferHeight,u.fov=s.toRadians(60)),n.frustum=u;var m=Te(n);U(this,m),L(this,t,n,m)}0===t&&i(this._completeMorph)&&this._completeMorph()}},v.prototype.isDestroyed=function(){return!1},v.prototype.destroy=function(){return B(this),r(this)};var P=new t,F=new e,H=new c;function V(e,t){var o=e._scene,i=o.camera,r=I,n=r.position,s=r.direction,a=r.up,u=o.mapProjection.unproject(i.position,P);t.cartographicToCartesian(u,n);var p=t.scaleToGeodeticSurface(n,F),m=l.eastNorthUpToFixedFrame(p,t,H);return c.multiplyByPointAsVector(m,i.direction,s),c.multiplyByPointAsVector(m,i.up,a),r}var j=new e,z=new e,W=new e,b=new e,G=new e,x=new e;function L(t,o,i,r){o*=.5;var s=t._scene,a=s.camera,u=e.clone(a.position,j),p=e.clone(a.direction,z),m=e.clone(a.up,W),h=c.multiplyByPoint(f.TRANSFORM_2D_INVERSE,i.position,b),d=c.multiplyByPointAsVector(f.TRANSFORM_2D_INVERSE,i.direction,G),l=c.multiplyByPointAsVector(f.TRANSFORM_2D_INVERSE,i.up,x);var _=s.tweens.add({duration:o,easingFunction:n.QUARTIC_OUT,startObject:{time:0},stopObject:{time:1},update:function(t){K(u,h,t.time,a.position),K(p,d,t.time,a.direction),K(m,l,t.time,a.up),e.cross(a.direction,a.up,a.right),e.normalize(a.right,a.right)},complete:function(){we(t,s,0,1,o,r)}});t._currentTweens.push(_)}var Z=new a,Q=new e,Y=new e,k=new e,X=new e,q=new e,J=new e;function K(t,o,i,r){return e.lerp(t,o,i,r)}function $(e,t,o,i,r){var c=e._scene,u=c.camera;if(!(u.frustum instanceof a)){var p=u.frustum.fov,m=.5*s.RADIANS_PER_DEGREE,h=o.position.z*Math.tan(.5*p);u.frustum.far=h/Math.tan(.5*m)+1e7;var d=c.tweens.add({duration:t,easingFunction:n.QUARTIC_OUT,startObject:{time:0},stopObject:{time:1},update:function(e){u.frustum.fov=s.lerp(p,m,e.time);var t=h/Math.tan(.5*u.frustum.fov);i(u,t)},complete:function(){u.frustum=o.frustum.clone(),r(e)}});e._currentTweens.push(d)}}var ee=new e,te=new e,oe=new e,ie=new e,re=new e,ne=new e,se=new u,ce=new m,ae=new e,ue={position:void 0,direction:void 0,up:void 0,frustum:void 0};var pe=new t,me={position:new e,direction:new e,up:new e,position2D:new e,direction2D:new e,up2D:new e,frustum:new u},he={position:new e,direction:new e,up:new e,frustum:void 0},de=new e,le=new m,fe=new c,_e=new e;function ve(e,t,o,i){var r=e._scene,c=r.camera,a=c.frustum.right-c.frustum.left;c.frustum=o.frustum.clone();var u=c.frustum.fov,p=.5*s.RADIANS_PER_DEGREE,m=a*Math.tan(.5*u);c.frustum.far=m/Math.tan(.5*p)+1e7,c.frustum.fov=p;var h=r.tweens.add({duration:t,easingFunction:n.QUARTIC_OUT,startObject:{time:0},stopObject:{time:1},update:function(e){c.frustum.fov=s.lerp(p,u,e.time),c.position.z=m/Math.tan(.5*c.frustum.fov)},complete:function(){i(e)}});e._currentTweens.push(h)}function ge(t,o,i,r){var s=t._scene,c=s.camera,a=e.clone(c.position,Q),u=e.clone(c.direction,Y),p=e.clone(c.up,k),m=e.clone(i.position2D,X),h=e.clone(i.direction2D,q),d=e.clone(i.up2D,J);var l=s.tweens.add({duration:o,easingFunction:n.QUARTIC_OUT,startObject:{time:0},stopObject:{time:1},update:function(t){K(a,m,t.time,c.position),K(u,h,t.time,c.direction),K(p,d,t.time,c.up),e.cross(c.direction,c.up,c.right),e.normalize(c.right,c.right),c._adjustOrthographicFrustum(!0)},complete:function(){we(t,s,1,0,o,r)}});t._currentTweens.push(l)}function we(e,t,o,r,s,c){var a={object:t,property:"morphTime",startValue:o,stopValue:r,duration:s,easingFunction:n.QUARTIC_OUT};i(c)&&(a.complete=function(){c(e)});var u=t.tweens.addProperty(a);e._currentTweens.push(u)}function Te(t){return function(o){var r=o._scene;r._mode=_.SCENE3D,r.morphTime=_.getMorphTime(_.SCENE3D),B(o);var n=r.camera;(o._previousMode!==_.MORPHING||o._morphCancelled)&&(o._morphCancelled=!1,e.clone(t.position,n.position),e.clone(t.direction,n.direction),e.clone(t.up,n.up),e.cross(n.direction,n.up,n.right),e.normalize(n.right,n.right),n.frustum=t.frustum.clone());var s=n.frustum;r.frameState.useLogDepth&&(s.near=.1,s.far=1e10);var c=i(o._completeMorph);o._completeMorph=void 0,r.camera.update(r.mode),o._scene.morphComplete.raiseEvent(o,o._previousMode,_.SCENE3D,c)}}function Me(t){return function(o){var r=o._scene;r._mode=_.SCENE2D,r.morphTime=_.getMorphTime(_.SCENE2D),B(o);var n=r.camera;e.clone(t.position,n.position),n.position.z=2*r.mapProjection.ellipsoid.maximumRadius,e.clone(t.direction,n.direction),e.clone(t.up,n.up),e.cross(n.direction,n.up,n.right),e.normalize(n.right,n.right),n.frustum=t.frustum.clone();var s=i(o._completeMorph);o._completeMorph=void 0,r.camera.update(r.mode),o._scene.morphComplete.raiseEvent(o,o._previousMode,_.SCENE2D,s)}}return v});