define(["../Core/ApproximateTerrainHeights","../Core/BoundingSphere","../Core/buildModuleUrl","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartographic","../Core/Check","../Core/ColorGeometryInstanceAttribute","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/GeographicTilingScheme","../Core/GeometryInstance","../Core/isArray","../Core/Math","../Core/OrientedBoundingBox","../Core/Rectangle","../Core/RectangleGeometry","../Core/Resource","../Renderer/DrawCommand","../Renderer/Pass","../ThirdParty/when","./ClassificationPrimitive","./ClassificationType","./PerInstanceColorAppearance","./SceneMode","./ShadowVolumeAppearance"],function(e,i,t,r,n,o,s,a,u,h,m,c,d,p,l,g,f,v,_,y,C,b,w,I,P,S,T,x,V){"use strict";var H={u_globeMinimumAltitude:function(){return 55e3}};function M(i){var t=(i=u(i,u.EMPTY_OBJECT)).appearance,r=i.geometryInstances;if(!h(t)&&h(r))for(var n=g(r)?r:[r],o=n.length,s=0;s<o;s++){var a=n[s].attributes;if(h(a)&&h(a.color)){t=new T({flat:!0});break}}this.appearance=t,this.geometryInstances=i.geometryInstances,this.show=u(i.show,!0),this.classificationType=u(i.classificationType,S.BOTH),this.debugShowBoundingVolume=u(i.debugShowBoundingVolume,!1),this.debugShowShadowVolume=u(i.debugShowShadowVolume,!1),this._boundingVolumes=[],this._boundingVolumes2D=[],this._ready=!1,this._readyPromise=I.defer(),this._primitive=void 0,this._maxHeight=void 0,this._minHeight=void 0,this._maxTerrainHeight=e._defaultMaxTerrainHeight,this._minTerrainHeight=e._defaultMinTerrainHeight,this._boundingSpheresKeys=[],this._boundingSpheres=[],this._useFragmentCulling=!1,this._zIndex=void 0;this._classificationPrimitiveOptions={geometryInstances:void 0,appearance:void 0,vertexCacheOptimize:u(i.vertexCacheOptimize,!1),interleave:u(i.interleave,!1),releaseGeometryInstances:u(i.releaseGeometryInstances,!0),allowPicking:u(i.allowPicking,!0),asynchronous:u(i.asynchronous,!0),compressVertices:u(i.compressVertices,!0),_createBoundingVolumeFunction:void 0,_updateAndQueueCommandsFunction:void 0,_pickPrimitive:this,_extruded:!0,_uniformMap:H}}function O(e){return function(i,t){var r=t.maximumRadius,n=r/Math.cos(.5*i)-r;return e._maxHeight+n}}function E(e){return function(i,t){return e._minHeight}}m(M.prototype,{vertexCacheOptimize:{get:function(){return this._classificationPrimitiveOptions.vertexCacheOptimize}},interleave:{get:function(){return this._classificationPrimitiveOptions.interleave}},releaseGeometryInstances:{get:function(){return this._classificationPrimitiveOptions.releaseGeometryInstances}},allowPicking:{get:function(){return this._classificationPrimitiveOptions.allowPicking}},asynchronous:{get:function(){return this._classificationPrimitiveOptions.asynchronous}},compressVertices:{get:function(){return this._classificationPrimitiveOptions.compressVertices}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}}}),M.isSupported=P.isSupported;var D=new n,G=new n,N=new n,A=new o,k=new _;function B(e,i){var t=e.mapProjection.ellipsoid;if(!h(i.attributes)||!h(i.attributes.position3DHigh))return h(i.rectangle)?i.rectangle:void 0;for(var r=i.attributes.position3DHigh.values,o=i.attributes.position3DLow.values,s=r.length,a=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,d=0;d<s;d+=3){var p=n.unpack(r,d,D),l=n.unpack(o,d,G),g=n.add(p,l,N),f=t.cartesianToCartographic(g,A),v=f.latitude,_=f.longitude;a=Math.min(a,v),u=Math.min(u,_),m=Math.max(m,v),c=Math.max(c,_)}var y=k;return y.north=m,y.south=a,y.east=c,y.west=u,y}function F(e,i){return Math.floor(e%i/3)}function R(e,i,t,r,n,o,s){var a=e._primitive;t.mode!==x.SCENE3D&&i.shaderProgram===a._spColor&&a._needs2DShader&&(i=i.derivedCommands.appearance2D),i.owner=e,i.modelMatrix=r,i.boundingVolume=o,i.cull=n,i.debugShowBoundingVolume=s,t.commandList.push(i)}function z(e,i,t,r,n,o){var s=e._primitive;t.mode!==x.SCENE3D&&i.shaderProgram===s._spPick&&s._needs2DShader&&(i=i.derivedCommands.pick2D),i.owner=e,i.modelMatrix=r,i.boundingVolume=o,i.cull=n,t.commandList.push(i)}return M.initializeTerrainHeights=function(){return e.initialize()},M.prototype.update=function(t){if(h(this._primitive)||h(this.geometryInstances))if(e.initialized){var r=this,o=this._classificationPrimitiveOptions;if(!h(this._primitive)){var s,a,u,m,c,p=t.mapProjection.ellipsoid,y=g(this.geometryInstances)?this.geometryInstances:[this.geometryInstances],C=y.length,b=new Array(C);for(m=0;m<C;++m){var w=B(t,a=(s=y[m]).geometry);h(c)?h(w)&&_.union(c,w,c):c=_.clone(w);var I=s.id;if(h(I)&&h(w)){var T=e.getBoundingSphere(w,p);this._boundingSpheresKeys.push(I),this._boundingSpheres.push(T)}if(u=a.constructor,!h(u)||!h(u.createShadowVolume))throw new d("Not all of the geometry instances have GroundPrimitive support.")}!function(i,t,r){var n=e.getMinimumMaximumHeights(t,r);i._minTerrainHeight=n.minimumTerrainHeight,i._maxTerrainHeight=n.maximumTerrainHeight}(this,c,p);var H=t.terrainExaggeration;this._minHeight=this._minTerrainHeight*H,this._maxHeight=this._maxTerrainHeight*H;var D=M._supportsMaterials(t.context);if(this._useFragmentCulling=D,D){var G,N=!0;for(m=0;m<C;++m)if(c=B(t,a=(s=y[m]).geometry),V.shouldUseSphericalCoordinates(c)){N=!1;break}for(m=0;m<C;++m){u=(a=(s=y[m]).geometry).constructor;var A=B(t,a),k=a.textureCoordinateRotationPoints;G=N?V.getPlanarTextureCoordinateAttributes(A,k,p,t.mapProjection,this._maxHeight):V.getSphericalExtentGeometryInstanceAttributes(A,k,p,t.mapProjection);var j=s.attributes;for(var L in j)j.hasOwnProperty(L)&&(G[L]=j[L]);b[m]=new l({geometry:u.createShadowVolume(a,E(this),O(this)),attributes:G,id:s.id})}}else for(m=0;m<C;++m)u=(a=(s=y[m]).geometry).constructor,b[m]=new l({geometry:u.createShadowVolume(a,E(this),O(this)),attributes:s.attributes,id:s.id});o.geometryInstances=b,o.appearance=this.appearance,o._createBoundingVolumeFunction=function(e,t){!function(e,t,r){var o=t.mapProjection.ellipsoid,s=B(t,r);if(s.width<f.PI){var a=v.fromRectangle(s,e._maxHeight,e._minHeight,o);e._boundingVolumes.push(a)}else{var u=r.attributes.position3DHigh.values,h=r.attributes.position3DLow.values;e._boundingVolumes.push(i.fromEncodedCartesianVertices(u,h))}if(!t.scene3DOnly){var m=t.mapProjection,c=i.fromRectangleWithHeights2D(s,m,e._maxHeight,e._minHeight);n.fromElements(c.center.z,c.center.x,c.center.y,c.center),e._boundingVolumes2D.push(c)}}(r,e,t)},o._updateAndQueueCommandsFunction=function(e,i,t,n,o,s,a,u){!function(e,i,t,r,n,o,s,a){var u;u=i.mode===x.SCENE3D?e._boundingVolumes:e._boundingVolumes2D;var h,m,c=e.classificationType,d=c!==S.PGEARTH_3D_TILE,p=c!==S.TERRAIN,l=i.passes,g=e._primitive;if(l.render){var f=t.length;for(h=0;h<f;++h)m=u[F(h,f)],d&&R(e,t[h],i,n,o,m,s),p&&R(e,t[h].derivedCommands.tileset,i,n,o,m,s);if(i.invertClassification){var v=g._commandsIgnoreShow,_=v.length;for(h=0;h<_;++h)m=u[Math.floor(h/2)],R(e,v[h],i,n,o,m,s)}}if(l.pick){var y,C=r.length;for(e._useFragmentCulling||(y=g._primitive._pickOffsets),h=0;h<C;++h)m=u[F(h,C)],e._useFragmentCulling||(m=u[y[F(h,C)].index]),d&&z(e,r[h],i,n,o,m),p&&z(e,r[h].derivedCommands.tileset,i,n,o,m)}}(r,i,t,n,o,s,a)},this._primitive=new P(o),this._primitive.readyPromise.then(function(e){r._ready=!0,r.releaseGeometryInstances&&(r.geometryInstances=void 0);var i=e._error;h(i)?r._readyPromise.reject(i):r._readyPromise.resolve(r)})}this._primitive.appearance=this.appearance,this._primitive.show=this.show,this._primitive.debugShowShadowVolume=this.debugShowShadowVolume,this._primitive.debugShowBoundingVolume=this.debugShowBoundingVolume,this._primitive.update(t)}else{if(!this.asynchronous)throw new d("For synchronous GroundPrimitives, you must call GroundPrimitive.initializeTerrainHeights() and wait for the returned promise to resolve.");M.initializeTerrainHeights()}},M.prototype.getBoundingSphere=function(e){var i=this._boundingSpheresKeys.indexOf(e);if(-1!==i)return this._boundingSpheres[i]},M.prototype.getGeometryInstanceAttributes=function(e){if(!h(this._primitive))throw new d("must call update before calling getGeometryInstanceAttributes");return this._primitive.getGeometryInstanceAttributes(e)},M.prototype.isDestroyed=function(){return!1},M.prototype.destroy=function(){return this._primitive=this._primitive&&this._primitive.destroy(),c(this)},M._supportsMaterials=function(e){return e.depthTexture},M.supportsMaterials=function(e){return s.typeOf.object("scene",e),M._supportsMaterials(e.frameState.context)},M});