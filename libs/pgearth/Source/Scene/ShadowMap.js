define(["../Core/BoundingRectangle","../Core/BoundingSphere","../Core/BoxOutlineGeometry","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/clone","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/combine","../Core/CullingVolume","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/FeatureDetection","../Core/GeometryInstance","../Core/Intersect","../Core/Math","../Core/Matrix4","../Core/OrthographicOffCenterFrustum","../Core/PerspectiveFrustum","../Core/PixelFormat","../Core/Quaternion","../Core/SphereOutlineGeometry","../Core/WebGLConstants","../Renderer/ClearCommand","../Renderer/ContextLimits","../Renderer/CubeMap","../Renderer/DrawCommand","../Renderer/Framebuffer","../Renderer/Pass","../Renderer/PassState","../Renderer/PixelDatatype","../Renderer/Renderbuffer","../Renderer/RenderbufferFormat","../Renderer/RenderState","../Renderer/Sampler","../Renderer/Texture","../Renderer/TextureMagnificationFilter","../Renderer/TextureMinificationFilter","../Renderer/TextureWrap","./Camera","./CullFace","./DebugCameraPrimitive","./PerInstanceColorAppearance","./Primitive","./ShadowMapShader"],function(e,t,r,a,i,s,n,o,u,d,h,m,c,f,p,_,l,w,g,C,v,x,S,b,y,M,O,P,E,L,F,V,A,T,D,z,R,W,B,U,N,I,j,X,G,k,Y,q,H,K){"use strict";function Q(e){var r=(e=c(e,c.EMPTY_OBJECT)).context;if(!f(r))throw new l("context is required.");if(!f(e.lightCamera))throw new l("lightCamera is required.");if(f(e.numberOfCascades)&&1!==e.numberOfCascades&&4!==e.numberOfCascades)throw new l("Only one or four cascades are supported.");this._enabled=c(e.enabled,!0),this._softShadows=c(e.softShadows,!1),this._normalOffset=c(e.normalOffset,!0),this.dirty=!0,this.fromLightSource=c(e.fromLightSource,!0),this.darkness=c(e.darkness,.3),this._darkness=this.darkness,this.maximumDistance=c(e.maximumDistance,5e3),this._outOfView=!1,this._outOfViewPrevious=!1,this._needsUpdate=!0;var n,o=!0;(w.isInternetExplorer()||w.isEdge()||(w.isChrome()||w.isFirefox())&&w.isWindows()&&!r.depthTexture)&&(o=!1),this._polygonOffsetSupported=o,this._terrainBias={polygonOffset:o,polygonOffsetFactor:1.1,polygonOffsetUnits:4,normalOffset:this._normalOffset,normalOffsetScale:.5,normalShading:!0,normalShadingSmooth:.3,depthBias:1e-4},this._primitiveBias={polygonOffset:o,polygonOffsetFactor:1.1,polygonOffsetUnits:4,normalOffset:this._normalOffset,normalOffsetScale:.1,normalShading:!0,normalShadingSmooth:.05,depthBias:2e-5},this._pointBias={polygonOffset:!1,polygonOffsetFactor:1.1,polygonOffsetUnits:4,normalOffset:this._normalOffset,normalOffsetScale:0,normalShading:!0,normalShadingSmooth:.1,depthBias:5e-4},this._depthAttachment=void 0,this._colorAttachment=void 0,this._shadowMapMatrix=new x,this._shadowMapTexture=void 0,this._lightDirectionEC=new i,this._lightPositionEC=new s,this._distance=0,this._lightCamera=e.lightCamera,this._shadowMapCamera=new pe,this._shadowMapCullingVolume=void 0,this._sceneCamera=void 0,this._boundingSphere=new t,this._isPointLight=c(e.isPointLight,!1),this._pointLightRadius=c(e.pointLightRadius,100),this._cascadesEnabled=!this._isPointLight&&c(e.cascadesEnabled,!0),this._numberOfCascades=this._cascadesEnabled?c(e.numberOfCascades,4):0,this._fitNearFar=!0,this._maximumCascadeDistances=[25,150,700,Number.MAX_VALUE],this._textureSize=new a,this._isSpotLight=!1,this._cascadesEnabled?this._shadowMapCamera.frustum=new S:f(this._lightCamera.frustum.fov)&&(this._isSpotLight=!0),this._cascadeSplits=[new s,new s],this._cascadeMatrices=[new x,new x,new x,new x],this._cascadeDistances=new s,n=this._isPointLight?6:this._cascadesEnabled?this._numberOfCascades:1,this._passes=new Array(n);for(var d=0;d<n;++d)this._passes[d]=new Z(r);this.debugShow=!1,this.debugFreezeFrame=!1,this._debugFreezeFrame=!1,this._debugCascadeColors=!1,this._debugLightFrustum=void 0,this._debugCameraFrustum=void 0,this._debugCascadeFrustums=new Array(this._numberOfCascades),this._debugShadowViewCommand=void 0,this._usesDepthTexture=r.depthTexture,this._isPointLight&&(this._usesDepthTexture=!1),this._primitiveRenderState=void 0,this._terrainRenderState=void 0,this._pointRenderState=void 0,$(this),this._clearCommand=new E({depth:1,color:new u}),this._clearPassState=new D(r),this._size=c(e.size,2048),this.size=this._size}function Z(e){this.camera=new pe,this.passState=new D(e),this.framebuffer=void 0,this.textureOffsets=void 0,this.commandList=[],this.cullingVolume=void 0}function J(e,t){return B.fromCache({cull:{enabled:!0,face:k.BACK},depthTest:{enabled:!0},colorMask:{red:e,green:e,blue:e,alpha:e},depthMask:!0,polygonOffset:{enabled:t.polygonOffset,factor:t.polygonOffsetFactor,units:t.polygonOffsetUnits}})}function $(e){var t=!e._usesDepthTexture;e._primitiveRenderState=J(t,e._primitiveBias),e._terrainRenderState=J(t,e._terrainBias),e._pointRenderState=J(t,e._pointBias)}function ee(e){for(var t=e._passes.length,r=0;r<t;++r){var a=e._passes[r],i=a.framebuffer;f(i)&&!i.isDestroyed()&&i.destroy(),a.framebuffer=void 0}e._depthAttachment=e._depthAttachment&&e._depthAttachment.destroy(),e._colorAttachment=e._colorAttachment&&e._colorAttachment.destroy()}function te(){return new U({wrapS:X.CLAMP_TO_EDGE,wrapT:X.CLAMP_TO_EDGE,minificationFilter:j.NEAREST,magnificationFilter:I.NEAREST})}function re(e,t){e._isPointLight?function(e,t){for(var r=new R({context:t,width:e._textureSize.x,height:e._textureSize.y,format:W.DEPTH_COMPONENT16}),a=new F({context:t,width:e._textureSize.x,height:e._textureSize.y,pixelFormat:y.RGBA,pixelDatatype:z.UNSIGNED_BYTE,sampler:te()}),i=[a.negativeX,a.negativeY,a.negativeZ,a.positiveX,a.positiveY,a.positiveZ],s=0;s<6;++s){var n=new A({context:t,depthRenderbuffer:r,colorTextures:[i[s]],destroyAttachments:!1}),o=e._passes[s];o.framebuffer=n,o.passState.framebuffer=n}e._shadowMapTexture=a,e._depthAttachment=r,e._colorAttachment=a}(e,t):e._usesDepthTexture?function(e,t){for(var r=new N({context:t,width:e._textureSize.x,height:e._textureSize.y,pixelFormat:y.DEPTH_STENCIL,pixelDatatype:z.UNSIGNED_INT_24_8,sampler:te()}),a=new A({context:t,depthStencilTexture:r,destroyAttachments:!1}),i=e._passes.length,s=0;s<i;++s){var n=e._passes[s];n.framebuffer=a,n.passState.framebuffer=a}e._shadowMapTexture=r,e._depthAttachment=r}(e,t):function(e,t){for(var r=new R({context:t,width:e._textureSize.x,height:e._textureSize.y,format:W.DEPTH_COMPONENT16}),a=new N({context:t,width:e._textureSize.x,height:e._textureSize.y,pixelFormat:y.RGBA,pixelDatatype:z.UNSIGNED_BYTE,sampler:te()}),i=new A({context:t,depthRenderbuffer:r,colorTextures:[a],destroyAttachments:!1}),s=e._passes.length,n=0;n<s;++n){var o=e._passes[n];o.framebuffer=i,o.passState.framebuffer=i}e._shadowMapTexture=a,e._depthAttachment=r,e._colorAttachment=a}(e,t)}function ae(e,t){f(e._passes[0].framebuffer)&&e._shadowMapTexture.width===e._textureSize.x||(ee(e),re(e,t),function(e,t){e._usesDepthTexture&&e._passes[0].framebuffer.status!==P.FRAMEBUFFER_COMPLETE&&(e._usesDepthTexture=!1,$(e),ee(e),re(e,t))}(e,t),ie(e,t))}function ie(e,t,r){r=c(r,0),(e._isPointLight||0===r)&&(e._clearCommand.framebuffer=e._passes[r].framebuffer,e._clearCommand.execute(t,e._clearPassState))}Q.MAXIMUM_DISTANCE=2e4,Q.prototype.debugCreateRenderStates=function(){$(this)},p(Q.prototype,{enabled:{get:function(){return this._enabled},set:function(e){this.dirty=this._enabled!==e,this._enabled=e}},normalOffset:{get:function(){return this._normalOffset},set:function(e){this.dirty=this._normalOffset!==e,this._normalOffset=e,this._terrainBias.normalOffset=e,this._primitiveBias.normalOffset=e,this._pointBias.normalOffset=e}},softShadows:{get:function(){return this._softShadows},set:function(e){this.dirty=this._softShadows!==e,this._softShadows=e}},size:{get:function(){return this._size},set:function(t){!function(t,r){t._size=r;var a=t._passes,i=a.length,s=t._textureSize;if(t._isPointLight){r=L.maximumCubeMapSize>=r?r:L.maximumCubeMapSize,s.x=r,s.y=r;var n=new e(0,0,r,r);a[0].passState.viewport=n,a[1].passState.viewport=n,a[2].passState.viewport=n,a[3].passState.viewport=n,a[4].passState.viewport=n,a[5].passState.viewport=n}else 1===i?(r=L.maximumTextureSize>=r?r:L.maximumTextureSize,s.x=r,s.y=r,a[0].passState.viewport=new e(0,0,r,r)):4===i&&(r=L.maximumTextureSize>=2*r?r:L.maximumTextureSize/2,s.x=2*r,s.y=2*r,a[0].passState.viewport=new e(0,0,r,r),a[1].passState.viewport=new e(r,0,r,r),a[2].passState.viewport=new e(0,r,r,r),a[3].passState.viewport=new e(r,r,r,r));t._clearPassState.viewport=new e(0,0,s.x,s.y);for(var o=0;o<i;++o){var u=a[o],d=u.passState.viewport,h=d.x/s.x,m=d.y/s.y,c=d.width/s.x,f=d.height/s.y;u.textureOffsets=new x(c,0,0,h,0,f,0,m,0,0,1,0,0,0,0,1)}}(this,t)}},outOfView:{get:function(){return this._outOfView}},shadowMapCullingVolume:{get:function(){return this._shadowMapCullingVolume}},passes:{get:function(){return this._passes}},isPointLight:{get:function(){return this._isPointLight}},debugCascadeColors:{get:function(){return this._debugCascadeColors},set:function(e){this.dirty=this._debugCascadeColors!==e,this._debugCascadeColors=e}}});var se=new e;function ne(t,r){var a=r.context,i=r.context.drawingBufferWidth,s=r.context.drawingBufferHeight,n=.3*Math.min(i,s),o=se;o.x=i-n,o.y=0,o.width=n,o.height=n;var u=t._debugShadowViewCommand;f(u)||(u=function(e,t){var r;r=e._isPointLight?"uniform samplerCube shadowMap_textureCube; \nvarying vec2 v_textureCoordinates; \nvoid main() \n{ \n    vec2 uv = v_textureCoordinates; \n    vec3 dir; \n \n    if (uv.y < 0.5) \n    { \n        if (uv.x < 0.333) \n        { \n            dir.x = -1.0; \n            dir.y = uv.x * 6.0 - 1.0; \n            dir.z = uv.y * 4.0 - 1.0; \n        } \n        else if (uv.x < 0.666) \n        { \n            dir.y = -1.0; \n            dir.x = uv.x * 6.0 - 3.0; \n            dir.z = uv.y * 4.0 - 1.0; \n        } \n        else \n        { \n            dir.z = -1.0; \n            dir.x = uv.x * 6.0 - 5.0; \n            dir.y = uv.y * 4.0 - 1.0; \n        } \n    } \n    else \n    { \n        if (uv.x < 0.333) \n        { \n            dir.x = 1.0; \n            dir.y = uv.x * 6.0 - 1.0; \n            dir.z = uv.y * 4.0 - 3.0; \n        } \n        else if (uv.x < 0.666) \n        { \n            dir.y = 1.0; \n            dir.x = uv.x * 6.0 - 3.0; \n            dir.z = uv.y * 4.0 - 3.0; \n        } \n        else \n        { \n            dir.z = 1.0; \n            dir.x = uv.x * 6.0 - 5.0; \n            dir.y = uv.y * 4.0 - 3.0; \n        } \n    } \n \n    float shadow = czm_unpackDepth(textureCube(shadowMap_textureCube, dir)); \n    gl_FragColor = vec4(vec3(shadow), 1.0); \n} \n":"uniform sampler2D shadowMap_texture; \nvarying vec2 v_textureCoordinates; \nvoid main() \n{ \n"+(e._usesDepthTexture?"    float shadow = texture2D(shadowMap_texture, v_textureCoordinates).r; \n":"    float shadow = czm_unpackDepth(texture2D(shadowMap_texture, v_textureCoordinates)); \n")+"    gl_FragColor = vec4(vec3(shadow), 1.0); \n} \n";var a=t.createViewportQuadCommand(r,{uniformMap:{shadowMap_texture:function(){return e._shadowMapTexture},shadowMap_textureCube:function(){return e._shadowMapTexture}}});return a.pass=T.OVERLAY,a}(t,a),t._debugShadowViewCommand=u),f(u.renderState)&&e.equals(u.renderState.viewport,o)||(u.renderState=B.fromCache({viewport:e.clone(o)})),r.commandList.push(t._debugShadowViewCommand)}var oe=new Array(8);oe[0]=new s(-1,-1,-1,1),oe[1]=new s(1,-1,-1,1),oe[2]=new s(1,1,-1,1),oe[3]=new s(-1,1,-1,1),oe[4]=new s(-1,-1,1,1),oe[5]=new s(1,-1,1,1),oe[6]=new s(1,1,1,1),oe[7]=new s(-1,1,1,1);for(var ue=new x,de=new Array(8),he=0;he<8;++he)de[he]=new s;var me=[u.RED,u.GREEN,u.BLUE,u.MAGENTA],ce=new i;function fe(e,t){ne(e,t);var a=e.debugFreezeFrame&&!e._debugFreezeFrame;if(e._debugFreezeFrame=e.debugFreezeFrame,e.debugFreezeFrame&&(a&&(e._debugCameraFrustum=e._debugCameraFrustum&&e._debugCameraFrustum.destroy(),e._debugCameraFrustum=new Y({camera:e._sceneCamera,color:u.CYAN,updateOnChange:!1})),e._debugCameraFrustum.update(t)),e._cascadesEnabled){if(e.debugFreezeFrame){a&&(e._debugLightFrustum=e._debugLightFrustum&&e._debugLightFrustum.destroy(),e._debugLightFrustum=new Y({camera:e._shadowMapCamera,color:u.YELLOW,updateOnChange:!1})),e._debugLightFrustum.update(t);for(var s=0;s<e._numberOfCascades;++s)a&&(e._debugCascadeFrustums[s]=e._debugCascadeFrustums[s]&&e._debugCascadeFrustums[s].destroy(),e._debugCascadeFrustums[s]=new Y({camera:e._passes[s].camera,color:me[s],updateOnChange:!1})),e._debugCascadeFrustums[s].update(t)}}else if(e._isPointLight){if(!f(e._debugLightFrustum)||e._needsUpdate){var n=e._shadowMapCamera.positionWC,o=M.IDENTITY,h=2*e._pointLightRadius,m=i.fromElements(h,h,h,ce),c=x.fromTranslationQuaternionRotationScale(n,o,m,ue);e._debugLightFrustum=e._debugLightFrustum&&e._debugLightFrustum.destroy(),e._debugLightFrustum=function(e,t){var a=new g({geometry:new r({minimum:new i(-.5,-.5,-.5),maximum:new i(.5,.5,.5)}),attributes:{color:d.fromColor(t)}}),s=new g({geometry:new O({radius:.5}),attributes:{color:d.fromColor(t)}});return new H({geometryInstances:[a,s],appearance:new q({translucent:!1,flat:!0}),asynchronous:!1,modelMatrix:e})}(c,u.YELLOW)}e._debugLightFrustum.update(t)}else f(e._debugLightFrustum)&&!e._needsUpdate||(e._debugLightFrustum=new Y({camera:e._shadowMapCamera,color:u.YELLOW,updateOnChange:!1})),e._debugLightFrustum.update(t)}function pe(){this.viewMatrix=new x,this.inverseViewMatrix=new x,this.frustum=void 0,this.positionCartographic=new n,this.positionWC=new i,this.directionWC=i.clone(i.UNIT_Z),this.upWC=i.clone(i.UNIT_Y),this.rightWC=i.clone(i.UNIT_X),this.viewProjectionMatrix=new x}pe.prototype.clone=function(e){x.clone(e.viewMatrix,this.viewMatrix),x.clone(e.inverseViewMatrix,this.inverseViewMatrix),this.frustum=e.frustum.clone(this.frustum),n.clone(e.positionCartographic,this.positionCartographic),i.clone(e.positionWC,this.positionWC),i.clone(e.directionWC,this.directionWC),i.clone(e.upWC,this.upWC),i.clone(e.rightWC,this.rightWC)};var _e=new x(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1);pe.prototype.getViewProjection=function(){var e=this.viewMatrix,t=this.frustum.projectionMatrix;return x.multiply(t,e,this.viewProjectionMatrix),x.multiply(_e,this.viewProjectionMatrix,this.viewProjectionMatrix),this.viewProjectionMatrix};var le=new Array(5),we=new b,ge=new Array(4),Ce=new i,ve=new i;var xe=new x,Se=new i,be=new i,ye=new i;var Me=[new i(-1,0,0),new i(0,-1,0),new i(0,0,-1),new i(1,0,0),new i(0,1,0),new i(0,0,1)],Oe=[new i(0,-1,0),new i(0,0,-1),new i(0,-1,0),new i(0,-1,0),new i(0,0,1),new i(0,-1,0)],Pe=[new i(0,0,1),new i(1,0,0),new i(-1,0,0),new i(0,0,-1),new i(1,0,0),new i(1,0,0)];var Ee=new i,Le=new i,Fe=new t,Ve=Fe.center;function Ae(e,r){var a=r.camera,s=e._lightCamera,n=e._sceneCamera,o=e._shadowMapCamera;e._cascadesEnabled?i.clone(s.directionWC,o.directionWC):e._isPointLight?i.clone(s.positionWC,o.positionWC):o.clone(s);var u,d,h=e._lightDirectionEC;x.multiplyByPointAsVector(a.viewMatrix,o.directionWC,h),i.normalize(h,h),i.negate(h,h),x.multiplyByPoint(a.viewMatrix,o.positionWC,e._lightPositionEC),e._lightPositionEC.w=e._pointLightRadius,e._fitNearFar?(u=Math.min(r.shadowState.nearPlane,e.maximumDistance),d=Math.min(r.shadowState.farPlane,e.maximumDistance+1)):(u=a.frustum.near,d=e.maximumDistance),e._sceneCamera=G.clone(a,n),a.frustum.clone(e._sceneCamera.frustum),e._sceneCamera.frustum.near=u,e._sceneCamera.frustum.far=d,e._distance=d-u,function(e,r){var a=e._sceneCamera,s=e._shadowMapCamera,n=Fe;if(e._cascadesEnabled){if(a.frustum.near>=e.maximumDistance)return e._outOfView=!0,void(e._needsUpdate=!1);var o=r.mapProjection.ellipsoid.geodeticSurfaceNormal(a.positionWC,Ee),u=i.negate(s.directionWC,Le),d=i.dot(o,u),h=v.clamp(d/.1,0,1);if(e._darkness=v.lerp(1,e.darkness,h),d<0)return e._outOfView=!0,void(e._needsUpdate=!1);e._needsUpdate=!0,e._outOfView=!1}else if(e._isPointLight)n.center=s.positionWC,n.radius=e._pointLightRadius,e._outOfView=r.cullingVolume.computeVisibility(n)===C.OUTSIDE,e._needsUpdate=!e._outOfView&&!e._boundingSphere.equals(n),t.clone(n,e._boundingSphere);else{var m=s.frustum.far/2,c=i.add(s.positionWC,i.multiplyByScalar(s.directionWC,m,Ve),Ve);n.center=c,n.radius=m,e._outOfView=r.cullingVolume.computeVisibility(n)===C.OUTSIDE,e._needsUpdate=!e._outOfView&&!e._boundingSphere.equals(n),t.clone(n,e._boundingSphere)}}(e,r),!e._outOfViewPrevious&&e._outOfView&&(e._needsUpdate=!0),e._outOfViewPrevious=e._outOfView}Q.prototype.update=function(e){if(Ae(this,e),this._needsUpdate)if(ae(this,e.context),this._isPointLight&&function(e,t){var r=new b;r.fov=v.PI_OVER_TWO,r.near=1,r.far=e._pointLightRadius,r.aspectRatio=1;for(var a=0;a<6;++a){var i=e._passes[a].camera;i.positionWC=e._shadowMapCamera.positionWC,i.positionCartographic=t.mapProjection.ellipsoid.cartesianToCartographic(i.positionWC,i.positionCartographic),i.directionWC=Me[a],i.upWC=Oe[a],i.rightWC=Pe[a],x.computeView(i.positionWC,i.directionWC,i.upWC,i.rightWC,i.viewMatrix),x.inverse(i.viewMatrix,i.inverseViewMatrix),i.frustum=r}}(this,e),this._cascadesEnabled&&(function(e,t){var r=e._shadowMapCamera,a=e._sceneCamera,n=x.multiply(a.frustum.projectionMatrix,a.viewMatrix,ue),o=x.inverse(n,ue),u=r.directionWC,d=a.directionWC,h=i.cross(u,d,Se);d=i.cross(h,u,be),i.normalize(d,d),i.normalize(h,h);for(var m=i.fromElements(0,0,0,ye),c=x.computeView(m,u,d,h,xe),f=x.multiply(c,o,ue),p=i.fromElements(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Ce),_=i.fromElements(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,ve),l=0;l<8;++l){var w=s.clone(oe[l],de[l]);x.multiplyByVector(f,w,w),i.divideByScalar(w,w.w,w),i.minimumByComponent(w,p,p),i.maximumByComponent(w,_,_)}_.z+=1e3,p.z-=10;var g=ye;g.x=-.5*(p.x+_.x),g.y=-.5*(p.y+_.y),g.z=-_.z;var C=x.fromTranslation(g,ue);c=x.multiply(C,c,c);var v=.5*(_.x-p.x),S=.5*(_.y-p.y),b=_.z-p.z,y=r.frustum;y.left=-v,y.right=v,y.bottom=-S,y.top=S,y.near=.01,y.far=b,x.clone(c,r.viewMatrix),x.inverse(c,r.inverseViewMatrix),x.getTranslation(r.inverseViewMatrix,r.positionWC),t.mapProjection.ellipsoid.cartesianToCartographic(r.positionWC,r.positionCartographic),i.clone(u,r.directionWC),i.clone(d,r.upWC),i.clone(h,r.rightWC)}(this,e),this._numberOfCascades>1&&function(e,t){var r,a=e._shadowMapCamera,n=e._sceneCamera,o=n.frustum.near,u=n.frustum.far,d=e._numberOfCascades,h=u-o,m=u/o,c=.9,f=!1;t.shadowState.closestObjectSize<200&&(f=!0,c=.9);var p=ge,_=le;for(_[0]=o,_[d]=u,r=0;r<d;++r){var l=(r+1)/d,w=o*Math.pow(m,l),g=o+h*l,C=v.lerp(g,w,c);_[r+1]=C,p[r]=C-_[r]}if(f){for(r=0;r<d;++r)p[r]=Math.min(p[r],e._maximumCascadeDistances[r]);var S=_[0];for(r=0;r<d-1;++r)S+=p[r],_[r+1]=S}s.unpack(_,0,e._cascadeSplits[0]),s.unpack(_,1,e._cascadeSplits[1]),s.unpack(p,0,e._cascadeDistances);var b=a.frustum,y=b.left,M=b.right,O=b.bottom,P=b.top,E=b.near,L=b.far,F=a.positionWC,V=a.directionWC,A=a.upWC,T=n.frustum.clone(we),D=a.getViewProjection();for(r=0;r<d;++r){T.near=_[r],T.far=_[r+1];for(var z=x.multiply(T.projectionMatrix,n.viewMatrix,ue),R=x.inverse(z,ue),W=x.multiply(D,R,ue),B=i.fromElements(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Ce),U=i.fromElements(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,ve),N=0;N<8;++N){var I=s.clone(oe[N],de[N]);x.multiplyByVector(W,I,I),i.divideByScalar(I,I.w,I),i.minimumByComponent(I,B,B),i.maximumByComponent(I,U,U)}B.x=Math.max(B.x,0),B.y=Math.max(B.y,0),B.z=0,U.x=Math.min(U.x,1),U.y=Math.min(U.y,1),U.z=Math.min(U.z,1);var j=e._passes[r],X=j.camera;X.clone(a);var G=X.frustum;G.left=y+B.x*(M-y),G.right=y+U.x*(M-y),G.bottom=O+B.y*(P-O),G.top=O+U.y*(P-O),G.near=E+B.z*(L-E),G.far=E+U.z*(L-E),j.cullingVolume=X.frustum.computeCullingVolume(F,V,A);var k=e._cascadeMatrices[r];x.multiply(X.getViewProjection(),n.inverseViewMatrix,k),x.multiply(j.textureOffsets,k,k)}}(this,e)),this._isPointLight)this._shadowMapCullingVolume=m.fromBoundingSphere(this._boundingSphere);else{var t=this._shadowMapCamera,r=t.positionWC,a=t.directionWC,n=t.upWC;this._shadowMapCullingVolume=t.frustum.computeCullingVolume(r,a,n),1===this._passes.length&&this._passes[0].camera.clone(t)}if(1===this._passes.length){var o=this._sceneCamera.inverseViewMatrix;x.multiply(this._shadowMapCamera.getViewProjection(),o,this._shadowMapMatrix)}this.debugShow&&fe(this,e)},Q.prototype.updatePass=function(e,t){ie(this,e,t)};var Te=new a;function De(e,t,r){var a=e._isPointLight?e._pointBias:r?e._terrainBias:e._primitiveBias,i={shadowMap_texture:function(){return e._shadowMapTexture},shadowMap_textureCube:function(){return e._shadowMapTexture},shadowMap_matrix:function(){return e._shadowMapMatrix},shadowMap_cascadeSplits:function(){return e._cascadeSplits},shadowMap_cascadeMatrices:function(){return e._cascadeMatrices},shadowMap_lightDirectionEC:function(){return e._lightDirectionEC},shadowMap_lightPositionEC:function(){return e._lightPositionEC},shadowMap_cascadeDistances:function(){return e._cascadeDistances},shadowMap_texelSizeDepthBiasAndNormalShadingSmooth:function(){var t=Te;return t.x=1/e._textureSize.x,t.y=1/e._textureSize.y,s.fromElements(t.x,t.y,a.depthBias,a.normalShadingSmooth,this.combinedUniforms1)},shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness:function(){return s.fromElements(a.normalOffsetScale,e._distance,e.maximumDistance,e._darkness,this.combinedUniforms2)},combinedUniforms1:new s,combinedUniforms2:new s};return h(t,i,!1)}function ze(e,t,r,a,i,s){var n,u,d;if(f(s)&&(n=s.shaderProgram,u=s.renderState,d=s.uniformMap),(s=V.shallowClone(r,s)).castShadows=!0,s.receiveShadows=!1,!f(n)||i!==r.shaderProgram.id||t){var h=r.shaderProgram,m=r.pass===T.GLOBE,c=r.pass!==T.TRANSLUCENT,p=e._isPointLight,_=e._usesDepthTexture,l=K.getShadowCastShaderKeyword(p,m,_,c);if(n=a.shaderCache.getDerivedShaderProgram(h,l),!f(n)){var w=h.vertexShaderSource,g=h.fragmentShaderSource,C=K.createShadowCastVertexShader(w,p,m),v=K.createShadowCastFragmentShader(g,p,_,c);n=a.shaderCache.createDerivedShaderProgram(h,l,{vertexShaderSource:C,fragmentShaderSource:v,attributeLocations:h._attributeLocations})}u=e._primitiveRenderState,p?u=e._pointRenderState:m&&(u=e._terrainRenderState),r.renderState.cull.enabled||((u=o(u,!1)).cull=o(u.cull,!1),u.cull.enabled=!1,u=B.fromCache(u)),d=De(e,r.uniformMap,m)}return s.shaderProgram=n,s.renderState=u,s.uniformMap=d,s}return Q.createReceiveDerivedCommand=function(e,t,r,a,i){f(i)||(i={});var s=e.length>0,n=t.shaderProgram,o=n.vertexShaderSource,u=n.fragmentShaderSource,d=t.pass===T.GLOBE,h=!1;if(d&&(h=t.owner.data.renderedMesh.encoding.hasVertexNormals),t.receiveShadows&&s){var m,c;f(i.receiveCommand)&&(m=i.receiveCommand.shaderProgram,c=i.receiveCommand.uniformMap),i.receiveCommand=V.shallowClone(t,i.receiveCommand),i.castShadows=!1,i.receiveShadows=!0;var p=i.receiveShaderCastShadows!==t.castShadows,_=i.receiveShaderProgramId!==t.shaderProgram.id;if(!f(m)||_||r||p){var l=K.getShadowReceiveShaderKeyword(e[0],t.castShadows,d,h);if(m=a.shaderCache.getDerivedShaderProgram(n,l),!f(m)){var w=K.createShadowReceiveVertexShader(o,d,h),g=K.createShadowReceiveFragmentShader(u,e[0],t.castShadows,d,h);m=a.shaderCache.createDerivedShaderProgram(n,l,{vertexShaderSource:w,fragmentShaderSource:g,attributeLocations:n._attributeLocations})}c=De(e[0],t.uniformMap,d)}i.receiveCommand.shaderProgram=m,i.receiveCommand.uniformMap=c,i.receiveShaderProgramId=t.shaderProgram.id,i.receiveShaderCastShadows=t.castShadows}return i},Q.createCastDerivedCommand=function(e,t,r,a,i){if(f(i)||(i={}),t.castShadows){var s=i.castCommands;f(s)||(s=i.castCommands=[]);var n=i.castShaderProgramId,o=e.length;s.length=o;for(var u=0;u<o;++u)s[u]=ze(e[u],r,t,a,n,s[u]);i.castShaderProgramId=t.shaderProgram.id}return i},Q.prototype.isDestroyed=function(){return!1},Q.prototype.destroy=function(){ee(this),this._debugLightFrustum=this._debugLightFrustum&&this._debugLightFrustum.destroy(),this._debugCameraFrustum=this._debugCameraFrustum&&this._debugCameraFrustum.destroy(),this._debugShadowViewCommand=this._debugShadowViewCommand&&this._debugShadowViewCommand.shaderProgram&&this._debugShadowViewCommand.shaderProgram.destroy();for(var e=0;e<this._numberOfCascades;++e)this._debugCascadeFrustums[e]=this._debugCascadeFrustums[e]&&this._debugCascadeFrustums[e].destroy();return _(this)},Q});