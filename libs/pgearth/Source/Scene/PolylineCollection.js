define(["../Core/BoundingSphere","../Core/Cartesian2","../Core/Cartesian3","../Core/Cartesian4","../Core/Cartographic","../Core/Color","../Core/combine","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/EncodedCartesian3","../Core/FeatureDetection","../Core/IndexDatatype","../Core/Intersect","../Core/Math","../Core/Matrix4","../Core/Plane","../Core/RuntimeError","../Renderer/Buffer","../Renderer/BufferUsage","../Renderer/ContextLimits","../Renderer/DrawCommand","../Renderer/Pass","../Renderer/RenderState","../Renderer/ShaderProgram","../Renderer/ShaderSource","../Renderer/Texture","../Renderer/VertexArray","../Shaders/PolylineCommon","../Shaders/PolylineFS","../Shaders/PolylineVS","./BatchTable","./BlendingState","./Material","./Polyline","./SceneMode"],function(e,t,o,n,r,i,a,s,l,h,u,d,p,c,f,_,m,y,g,v,b,x,T,A,E,C,B,D,P,I,S,w,L,N,R,O,V,M,U){"use strict";var F=M.SHOW_INDEX,k=M.WIDTH_INDEX,H=M.POSITION_INDEX,Y=M.MATERIAL_INDEX,W=M.POSITION_SIZE_INDEX,X=M.DISTANCE_DISPLAY_CONDITION,z=M.NUMBER_OF_PROPERTIES,q={texCoordExpandAndBatchIndex:0,position3DHigh:1,position3DLow:2,position2DHigh:3,position2DLow:4,prevPosition3DHigh:5,prevPosition3DLow:6,prevPosition2DHigh:7,prevPosition2DLow:8,nextPosition3DHigh:9,nextPosition3DLow:10,nextPosition2DHigh:11,nextPosition2DLow:12};function G(e){e=l(e,l.EMPTY_OBJECT),this.modelMatrix=g.clone(l(e.modelMatrix,g.IDENTITY)),this._modelMatrix=g.clone(g.IDENTITY),this.debugShowBoundingVolume=l(e.debugShowBoundingVolume,!1),this._opaqueRS=void 0,this._translucentRS=void 0,this._colorCommands=[],this._polylinesUpdated=!1,this._polylinesRemoved=!1,this._createVertexArray=!1,this._propertiesChanged=new Uint32Array(z),this._polylines=[],this._polylineBuckets={},this._positionBufferUsage={bufferUsage:T.STATIC_DRAW,frameCount:0},this._mode=void 0,this._polylinesToUpdate=[],this._vertexArrays=[],this._positionBuffer=void 0,this._texCoordExpandAndBatchIndexBuffer=void 0,this._batchTable=void 0,this._createBatchTable=!1,this._useHighlightColor=!1,this._highlightColor=i.clone(i.WHITE);var t=this;this._uniformMap={u_highlightColor:function(){return t._highlightColor}}}u(G.prototype,{length:{get:function(){return re(this),this._polylines.length}}}),G.prototype.add=function(e){var t=new M(e,this);return t._index=this._polylines.length,this._polylines.push(t),this._createVertexArray=!0,this._createBatchTable=!0,t},G.prototype.remove=function(e){if(this.contains(e)){this._polylines[e._index]=void 0;var t=this._polylinesToUpdate.indexOf(e);if(-1!==t&&this._polylinesToUpdate.splice(t,1),this._polylinesRemoved=!0,this._createVertexArray=!0,this._createBatchTable=!0,h(e._bucket)){var o=e._bucket;o.shaderProgram=o.shaderProgram&&o.shaderProgram.destroy()}return e._destroy(),!0}return!1},G.prototype.removeAll=function(){ie(this),se(this),this._polylineBuckets={},this._polylinesRemoved=!1,this._polylines.length=0,this._polylinesToUpdate.length=0,this._createVertexArray=!0},G.prototype.contains=function(e){return h(e)&&e._polylineCollection===this},G.prototype.get=function(e){if(!h(e))throw new p("index is required.");return re(this),this._polylines[e]};var K=new c,j=new n,J=new t;G.prototype.update=function(o){if(re(this),0!==this._polylines.length){!function(e,t){var o=t.mode;e._mode===o&&g.equals(e._modelMatrix,e.modelMatrix)||(e._mode=o,e._modelMatrix=g.clone(e.modelMatrix),e._createVertexArray=!0)}(this,o);var r,i=o.context,l=o.mapProjection,u=this._propertiesChanged;if(this._createBatchTable){if(0===A.maximumVertexTextureImageUnits)throw new b("Vertex texture fetch support is required to render polylines. The maximum number of vertex texture image units must be greater than zero.");!function(e,t){h(e._batchTable)&&e._batchTable.destroy();var o=[{functionName:"batchTable_getWidthAndShow",componentDatatype:s.UNSIGNED_BYTE,componentsPerAttribute:2},{functionName:"batchTable_getPickColor",componentDatatype:s.UNSIGNED_BYTE,componentsPerAttribute:4,normalize:!0},{functionName:"batchTable_getCenterHigh",componentDatatype:s.FLOAT,componentsPerAttribute:3},{functionName:"batchTable_getCenterLowAndRadius",componentDatatype:s.FLOAT,componentsPerAttribute:4},{functionName:"batchTable_getDistanceDisplayCondition",componentDatatype:s.FLOAT,componentsPerAttribute:2}];e._batchTable=new R(t,o,e._polylines.length)}(this,i),this._createBatchTable=!1}if(this._createVertexArray||function(e){var t=!1,o=e._propertiesChanged,n=e._positionBufferUsage;o[H]?n.bufferUsage!==T.STREAM_DRAW?(t=!0,n.bufferUsage=T.STREAM_DRAW,n.frameCount=100):n.frameCount=100:n.bufferUsage!==T.STATIC_DRAW&&(0===n.frameCount?(t=!0,n.bufferUsage=T.STATIC_DRAW):n.frameCount--);return t}(this))ee(this,i,l);else if(this._polylinesUpdated){var d=this._polylinesToUpdate;if(this._mode!==U.SCENE3D)for(var p=d.length,f=0;f<p;++f)(r=d[f]).update();if(u[W]||u[Y])ee(this,i,l);else for(var _=d.length,m=this._polylineBuckets,y=0;y<_;++y){u=(r=d[y])._propertiesChanged;var v=r._bucket,x=0;for(var D in m)if(m.hasOwnProperty(D)){if(m[D]===v){u[H]&&v.writeUpdate(x,r,this._positionBuffer,l);break}x+=m[D].lengthOfPositions}if((u[F]||u[k])&&this._batchTable.setBatchedAttribute(r._index,0,new t(r._width,r._show)),this._batchTable.attributes.length>2){if(u[H]||u[W]){var P=o.mode===U.SCENE2D?r._boundingVolume2D:r._boundingVolumeWC,I=c.fromCartesian(P.center,K),S=n.fromElements(I.low.x,I.low.y,I.low.z,P.radius,j);this._batchTable.setBatchedAttribute(r._index,2,I.high),this._batchTable.setBatchedAttribute(r._index,3,S)}if(u[X]){var w=J;w.x=0,w.y=Number.MAX_VALUE;var L=r.distanceDisplayCondition;h(L)&&(w.x=L.near,w.y=L.far),this._batchTable.setBatchedAttribute(r._index,4,w)}}r._clean()}d.length=0,this._polylinesUpdated=!1}u=this._propertiesChanged;for(var N=0;N<z;++N)u[N]=0;var V=g.IDENTITY;o.mode===U.SCENE3D&&(V=this.modelMatrix);var M=o.passes,q=0!==o.morphTime;if(h(this._opaqueRS)&&this._opaqueRS.depthTest.enabled===q||(this._opaqueRS=B.fromCache({depthMask:q,depthTest:{enabled:q}})),h(this._translucentRS)&&this._translucentRS.depthTest.enabled===q||(this._translucentRS=B.fromCache({blending:O.ALPHA_BLEND,depthMask:!q,depthTest:{enabled:q}})),this._batchTable.update(o),M.render||M.pick)!function(t,o,n,r){for(var i=o.context,s=o.commandList,l=n.length,u=0,d=!0,p=t._vertexArrays,c=t.debugShowBoundingVolume,f=t._batchTable.getUniformMapCallback(),_=p.length,m=0;m<_;++m)for(var y=p[m],g=y.buckets,v=g.length,b=0;b<v;++b){for(var x,T,A,B,D=g[b],P=D.offset,I=D.bucket.shaderProgram,S=D.bucket.polylines,w=S.length,L=0,N=0;N<w;++N){var R=S[N],O=ne(R._material);if(O!==x){if(h(x)&&L>0){var V=T.isTranslucent();u>=l?(A=new E({owner:t}),n.push(A)):A=n[u],++u,B=a(f(T._uniforms),t._uniformMap),A.boundingVolume=e.clone(Q,A.boundingVolume),A.modelMatrix=r,A.shaderProgram=I,A.vertexArray=y.va,A.renderState=V?t._translucentRS:t._opaqueRS,A.pass=V?C.TRANSLUCENT:C.OPAQUE,A.debugShowBoundingVolume=c,A.pickId="v_pickColor",A.uniformMap=B,A.count=L,A.offset=P,P+=L,L=0,d=!0,s.push(A)}(T=R._material).update(i),x=O}for(var M,F=R._locatorBuckets,k=F.length,H=0;H<k;++H){var Y=F[H];Y.locator===D&&(L+=Y.count)}o.mode===U.SCENE3D?M=R._boundingVolumeWC:o.mode===U.COLUMBUS_VIEW?M=R._boundingVolume2D:o.mode===U.SCENE2D?h(R._boundingVolume2D)&&((M=e.clone(R._boundingVolume2D,Z)).center.x=0):h(R._boundingVolumeWC)&&h(R._boundingVolume2D)&&(M=e.union(R._boundingVolumeWC,R._boundingVolume2D,Z)),d?(d=!1,e.clone(M,Q)):e.union(M,Q,Q)}h(x)&&L>0&&(u>=l?(A=new E({owner:t}),n.push(A)):A=n[u],++u,B=a(f(T._uniforms),t._uniformMap),A.boundingVolume=e.clone(Q,A.boundingVolume),A.modelMatrix=r,A.shaderProgram=I,A.vertexArray=y.va,A.renderState=T.isTranslucent()?t._translucentRS:t._opaqueRS,A.pass=T.isTranslucent()?C.TRANSLUCENT:C.OPAQUE,A.debugShowBoundingVolume=c,A.pickId="v_pickColor",A.uniformMap=B,A.count=L,A.offset=P,d=!0,s.push(A)),x=void 0}n.length=u}(this,o,this._colorCommands,V)}};var Q=new e,Z=new e;G.prototype.isDestroyed=function(){return!1},G.prototype.destroy=function(){return ae(this),ie(this),se(this),this._batchTable=this._batchTable&&this._batchTable.destroy(),d(this)};var $=[0,0,0];function ee(e,t,o){e._createVertexArray=!1,ie(e),ae(e),function(e){for(var t=e._mode,o=e._modelMatrix,n=e._polylineBuckets={},r=e._polylines,i=r.length,a=0;a<i;++a){var s=r[a];if(s._actualPositions.length>1){s.update();var l=s.material,u=n[l.type];h(u)||(u=n[l.type]=new he(l,t,o)),u.addPolyline(s)}}}(e);var n,r,i=[[]],a=i[0],l=e._batchTable,u=e._useHighlightColor,d=[0],p=0,c=[[]],f=0,m=e._polylineBuckets;for(n in m)m.hasOwnProperty(n)&&((r=m[n]).updateShader(t,l,u),f+=r.lengthOfPositions);if(f>0){var g,v=e._mode,b=new Float32Array(6*f*3),A=new Float32Array(4*f),E=0,C=0,B=0;for(n in m)if(m.hasOwnProperty(n)){(r=m[n]).write(b,A,E,C,B,l,t,o),v===U.MORPHING&&(h(g)||(g=new Float32Array(6*f*3)),r.writeForMorph(g,E));var D=r.lengthOfPositions;E+=6*D*3,C+=4*D,B+=4*D,p=r.updateIndices(i,d,c,p)}var P,I=e._positionBufferUsage.bufferUsage,w=T.STATIC_DRAW;e._positionBuffer=x.createVertexBuffer({context:t,typedArray:b,usage:I}),h(g)&&(P=x.createVertexBuffer({context:t,typedArray:g,usage:I})),e._texCoordExpandAndBatchIndexBuffer=x.createVertexBuffer({context:t,typedArray:A,usage:w});for(var L=3*Float32Array.BYTES_PER_ELEMENT,N=4*Float32Array.BYTES_PER_ELEMENT,R=0,O=i.length,V=0;V<O;++V)if((a=i[V]).length>0){var M=new Uint16Array(a),F=x.createIndexBuffer({context:t,typedArray:M,usage:T.STATIC_DRAW,indexDatatype:_.UNSIGNED_SHORT});R+=d[V];var k,H,Y,W,X=6*(V*(L*y.SIXTY_FOUR_KILOBYTES)-R*L),z=L+X,G=L+z,K=L+G,j=L+K,J=L+j,Q=V*(N*y.SIXTY_FOUR_KILOBYTES)-R*N,Z=[{index:q.position3DHigh,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:X,strideInBytes:6*L},{index:q.position3DLow,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:z,strideInBytes:6*L},{index:q.position2DHigh,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:X,strideInBytes:6*L},{index:q.position2DLow,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:z,strideInBytes:6*L},{index:q.prevPosition3DHigh,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:G,strideInBytes:6*L},{index:q.prevPosition3DLow,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:K,strideInBytes:6*L},{index:q.prevPosition2DHigh,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:G,strideInBytes:6*L},{index:q.prevPosition2DLow,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:K,strideInBytes:6*L},{index:q.nextPosition3DHigh,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:j,strideInBytes:6*L},{index:q.nextPosition3DLow,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:J,strideInBytes:6*L},{index:q.nextPosition2DHigh,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:j,strideInBytes:6*L},{index:q.nextPosition2DLow,componentsPerAttribute:3,componentDatatype:s.FLOAT,offsetInBytes:J,strideInBytes:6*L},{index:q.texCoordExpandAndBatchIndex,componentsPerAttribute:4,componentDatatype:s.FLOAT,vertexBuffer:e._texCoordExpandAndBatchIndexBuffer,offsetInBytes:Q}];v===U.SCENE3D?(k=e._positionBuffer,H="vertexBuffer",Y=$,W="value"):v===U.SCENE2D||v===U.COLUMBUS_VIEW?(k=$,H="value",Y=e._positionBuffer,W="vertexBuffer"):(k=P,H="vertexBuffer",Y=e._positionBuffer,W="vertexBuffer"),Z[0][H]=k,Z[1][H]=k,Z[2][W]=Y,Z[3][W]=Y,Z[4][H]=k,Z[5][H]=k,Z[6][W]=Y,Z[7][W]=Y,Z[8][H]=k,Z[9][H]=k,Z[10][W]=Y,Z[11][W]=Y;var ee=new S({context:t,attributes:Z,indexBuffer:F});e._vertexArrays.push({va:ee,buckets:c[V]})}}}function te(e,t){return t instanceof I?t.id:t}var oe=[];function ne(e){var t=V._uniformList[e.type],o=t.length;oe.length=2*o;for(var n=0,r=0;r<o;++r){var i=t[r];oe[n]=i,oe[n+1]=e._uniforms[i](),n+=2}return e.type+":"+JSON.stringify(oe,te)}function re(e){if(e._polylinesRemoved){e._polylinesRemoved=!1;for(var t=[],o=e._polylines.length,n=0,r=0;n<o;++n){var i=e._polylines[n];h(i)&&(i._index=r++,t.push(i))}e._polylines=t}}function ie(e){for(var t=e._polylines,o=t.length,n=0;n<o;++n)if(h(t[n])){var r=t[n]._bucket;h(r)&&(r.shaderProgram=r.shaderProgram&&r.shaderProgram.destroy())}}function ae(e){for(var t=e._vertexArrays.length,o=0;o<t;++o)e._vertexArrays[o].va.destroy();e._vertexArrays.length=0}function se(e){for(var t=e._polylines,o=t.length,n=0;n<o;++n)h(t[n])&&t[n]._destroy()}function le(e,t,o){this.count=e,this.offset=t,this.bucket=o}function he(e,t,o){this.polylines=[],this.lengthOfPositions=0,this.material=e,this.shaderProgram=void 0,this.mode=t,this.modelMatrix=o}function ue(e){return o.dot(o.UNIT_X,e._boundingVolume.center)<0||e._boundingVolume.intersectPlane(v.ORIGIN_ZX_PLANE)===m.INTERSECTING}G.prototype._updatePolyline=function(e,t){this._polylinesUpdated=!0,e._dirty||this._polylinesToUpdate.push(e),++this._propertiesChanged[t]},he.prototype.addPolyline=function(e){this.polylines.push(e),e._actualLength=this.getPolylinePositionsLength(e),this.lengthOfPositions+=e._actualLength,e._bucket=this},he.prototype.updateShader=function(e,t,o){if(!h(this.shaderProgram)){var n=["DISTANCE_DISPLAY_CONDITION"];o&&n.push("VECTOR_TILE"),-1!==this.material.shaderSource.search(/varying\s+float\s+v_polylineAngle;/g)&&n.push("POLYLINE_DASH"),f.isInternetExplorer()||n.push("CLIP_POLYLINE");var r=new P({defines:n,sources:["varying vec4 v_pickColor;\n",this.material.shaderSource,L]}),i=t.getVertexShaderCallback()(N),a=new P({defines:n,sources:[w,i]});this.shaderProgram=D.fromCache({context:e,vertexShaderSource:a,fragmentShaderSource:r,attributeLocations:q})}},he.prototype.getPolylinePositionsLength=function(e){var t;if(this.mode===U.SCENE3D||!ue(e))return 4*(t=e._actualPositions.length)-4;var o=0,n=e._segments.lengths;t=n.length;for(var r=0;r<t;++r)o+=4*n[r]-4;return o};var de=new o,pe=new o,ce=new o,fe=new o,_e=new n,me=new t;he.prototype.write=function(e,t,r,a,s,l,u,d){for(var p=this.mode,f=d.ellipsoid.maximumRadius*y.PI,_=this.polylines,m=_.length,g=0;g<m;++g){for(var v,b=_[g],x=b.width,T=b.show&&x>0,A=b._index,E=this.getSegments(b,d),C=E.positions,B=E.lengths,D=C.length,P=b.getPickId(u).color,I=0,S=0,w=0;w<D;++w){0===w?b._loop?v=C[D-2]:(v=fe,o.subtract(C[0],C[1],v),o.add(C[0],v,v)):v=C[w-1],o.clone(v,pe),o.clone(C[w],de),w===D-1?b._loop?v=C[1]:(v=fe,o.subtract(C[D-1],C[D-2],v),o.add(C[D-1],v,v)):v=C[w+1],o.clone(v,ce);var L=B[I];w===S+L&&(S+=L,++I);var N=w-S==0,R=w===S+B[I]-1;p===U.SCENE2D&&(pe.z=0,de.z=0,ce.z=0),p!==U.SCENE2D&&p!==U.MORPHING||(N||R)&&f-Math.abs(de.x)<1&&((de.x<0&&pe.x>0||de.x>0&&pe.x<0)&&o.clone(de,pe),(de.x<0&&ce.x>0||de.x>0&&ce.x<0)&&o.clone(de,ce));for(var O=R?2:4,V=N?2:0;V<O;++V){c.writeElements(de,e,r),c.writeElements(pe,e,r+6),c.writeElements(ce,e,r+12);var M=V-2<0?-1:1;t[s]=w/(D-1),t[s+1]=V%2*2-1,t[s+2]=M,t[s+3]=A,r+=18,s+=4}}var F=_e;F.x=i.floatToByte(P.red),F.y=i.floatToByte(P.green),F.z=i.floatToByte(P.blue),F.w=i.floatToByte(P.alpha);var k=me;k.x=x,k.y=T?1:0;var H=p===U.SCENE2D?b._boundingVolume2D:b._boundingVolumeWC,Y=c.fromCartesian(H.center,K),W=Y.high,X=n.fromElements(Y.low.x,Y.low.y,Y.low.z,H.radius,j),z=J;z.x=0,z.y=Number.MAX_VALUE;var q=b.distanceDisplayCondition;h(q)&&(z.x=q.near,z.y=q.far),l.setBatchedAttribute(A,0,k),l.setBatchedAttribute(A,1,F),l.attributes.length>2&&(l.setBatchedAttribute(A,2,W),l.setBatchedAttribute(A,3,X),l.setBatchedAttribute(A,4,z))}};var ye=new o,ge=new o,ve=new o,be=new o;he.prototype.writeForMorph=function(e,t){for(var n=this.modelMatrix,r=this.polylines,i=r.length,a=0;a<i;++a)for(var s=r[a],l=s._segments.positions,h=s._segments.lengths,u=l.length,d=0,p=0,f=0;f<u;++f){var _;0===f?s._loop?_=l[u-2]:(_=be,o.subtract(l[0],l[1],_),o.add(l[0],_,_)):_=l[f-1],_=g.multiplyByPoint(n,_,ge);var m,y=g.multiplyByPoint(n,l[f],ye);f===u-1?s._loop?m=l[1]:(m=be,o.subtract(l[u-1],l[u-2],m),o.add(l[u-1],m,m)):m=l[f+1],m=g.multiplyByPoint(n,m,ve);var v=h[d];f===p+v&&(p+=v,++d);for(var b=f-p==0,x=f===p+h[d]-1?2:4,T=b?2:0;T<x;++T)c.writeElements(y,e,t),c.writeElements(_,e,t+6),c.writeElements(m,e,t+12),t+=18}};var xe=new Array(1);he.prototype.updateIndices=function(e,t,o,n){var r=o.length-1,i=new le(0,n,this);o[r].push(i);var a=0,s=e[e.length-1],l=0;s.length>0&&(l=s[s.length-1]+1);for(var h=this.polylines,u=h.length,d=0;d<u;++d){var p,c=h[d];if(c._locatorBuckets=[],this.mode===U.SCENE3D){p=xe;var f=c._actualPositions.length;if(!(f>0))continue;p[0]=f}else p=c._segments.lengths;var _=p.length;if(_>0){for(var m=0,g=0;g<_;++g)for(var v=p[g]-1,b=0;b<v;++b)l+4>y.SIXTY_FOUR_KILOBYTES&&(c._locatorBuckets.push({locator:i,count:m}),m=0,t.push(4),s=[],e.push(s),l=0,i.count=a,a=0,n=0,i=new le(0,0,this),o[++r]=[i]),s.push(l,l+2,l+1),s.push(l+1,l+2,l+3),m+=6,a+=6,n+=6,l+=4;c._locatorBuckets.push({locator:i,count:m}),l+4>y.SIXTY_FOUR_KILOBYTES&&(t.push(0),s=[],e.push(s),l=0,i.count=a,n=0,a=0,i=new le(0,0,this),o[++r]=[i])}c._clean()}return i.count=a,n},he.prototype.getPolylineStartIndex=function(e){for(var t=this.polylines,o=0,n=t.length,r=0;r<n;++r){var i=t[r];if(i===e)break;o+=i._actualLength}return o};var Te,Ae={positions:void 0,lengths:void 0},Ee=new Array(1),Ce=new o,Be=new r;return he.prototype.getSegments=function(t,n){var r=t._actualPositions;if(this.mode===U.SCENE3D)return Ee[0]=r.length,Ae.positions=r,Ae.lengths=Ee,Ae;ue(t)&&(r=t._segments.positions);for(var i,a=n.ellipsoid,s=[],l=this.modelMatrix,h=r.length,u=Ce,d=0;d<h;++d)i=r[d],u=g.multiplyByPoint(l,i,u),s.push(n.project(a.cartesianToCartographic(u,Be)));if(s.length>0){t._boundingVolume2D=e.fromPoints(s,t._boundingVolume2D);var p=t._boundingVolume2D.center;t._boundingVolume2D.center=new o(p.z,p.x,p.y)}return Ae.positions=s,Ae.lengths=t._segments.lengths,Ae},he.prototype.writeUpdate=function(e,t,n,r){var i=this.mode,a=r.ellipsoid.maximumRadius*y.PI,s=t._actualLength;if(s){e+=this.getPolylineStartIndex(t);var l=Te,u=6*s*3;!h(l)||l.length<u?l=Te=new Float32Array(u):l.length>u&&(l=new Float32Array(l.buffer,0,u));var d,p=this.getSegments(t,r),f=p.positions,_=p.lengths,m=0,g=0,v=0;s=f.length;for(var b=0;b<s;++b){0===b?t._loop?d=f[s-2]:(d=fe,o.subtract(f[0],f[1],d),o.add(f[0],d,d)):d=f[b-1],o.clone(d,pe),o.clone(f[b],de),b===s-1?t._loop?d=f[1]:(d=fe,o.subtract(f[s-1],f[s-2],d),o.add(f[s-1],d,d)):d=f[b+1],o.clone(d,ce);var x=_[g];b===v+x&&(v+=x,++g);var T=b-v==0,A=b===v+_[g]-1;i===U.SCENE2D&&(pe.z=0,de.z=0,ce.z=0),i!==U.SCENE2D&&i!==U.MORPHING||(T||A)&&a-Math.abs(de.x)<1&&((de.x<0&&pe.x>0||de.x>0&&pe.x<0)&&o.clone(de,pe),(de.x<0&&ce.x>0||de.x>0&&ce.x<0)&&o.clone(de,ce));for(var E=A?2:4,C=T?2:0;C<E;++C)c.writeElements(de,l,m),c.writeElements(pe,l,m+6),c.writeElements(ce,l,m+12),m+=18}n.copyFromArrayView(l,18*Float32Array.BYTES_PER_ELEMENT*e)}},G});