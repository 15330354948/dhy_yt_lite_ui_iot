define(["./addExtensionsUsed","./addToArray","./findAccessorMinMax","./ForEach","./getAccessorByteStride","./numberOfComponentsForType","./moveTechniqueRenderStates","./moveTechniquesToExtension","./removeUnusedElements","./updateAccessorComponentTypes","../../Core/Cartesian3","../../Core/Cartesian4","../../Core/clone","../../Core/ComponentDatatype","../../Core/defaultValue","../../Core/defined","../../Core/isArray","../../Core/Matrix4","../../Core/Quaternion","../../Core/WebGLConstants"],function(e,n,t,r,i,s,a,o,f,u,c,m,l,v,d,h,p,b,y,O){"use strict";var g={.8:function(n){h(n.asset)||(n.asset={});var t=n.asset;if(t.version="1.0","string"==typeof t.profile){var r=t.profile.split(" ");t.profile={api:r[0],version:r[1]}}else t.profile={};h(n.version)&&delete n.version;w(n),function(e){var n=e.meshes;for(var t in n)if(n.hasOwnProperty(t)){var r=n[t],i=r.primitives;if(h(i))for(var s=i.length,a=0;a<s;++a){var o=i[a],f=d(o.primitive,O.TRIANGLES);o.mode=d(o.mode,f),delete o.primitive}}}(n),function(e){var n=e.nodes,t=new c,r=new y;for(var i in n)if(n.hasOwnProperty(i)){var s=n[i];if(h(s.rotation)){var a=s.rotation;c.fromArray(a,0,t),y.fromAxisAngle(t,a[3],r),s.rotation=[r.x,r.y,r.z,r.w]}var o=s.instanceSkin;h(o)&&(s.skeletons=o.skeletons,s.skin=o.skin,s.meshes=o.meshes,delete s.instanceSkin)}}(n),function(e){var n=e.animations,t=e.accessors,r=e.bufferViews,i=e.buffers,a={},o=new c,f=new y;for(var u in n)if(n.hasOwnProperty(u)){var m=n[u],l=m.channels,d=m.parameters,p=m.samplers;if(h(l))for(var b=l.length,O=0;O<b;++O){var g=l[O];if("rotation"===g.target.path){var w=d[p[g.sampler].output];if(h(a[w]))continue;a[w]=!0;for(var x=t[w],T=r[x.bufferView],R=i[T.buffer],_=R.extras._pipeline.source,C=_.byteOffset+T.byteOffset+x.byteOffset,V=x.componentType,P=x.count,S=s(x.type),k=x.count*S,q=v.createArrayBufferView(V,_.buffer,C,k),E=0;E<P;E++){var A=E*S;c.unpack(q,A,o);var N=q[A+3];y.fromAxisAngle(o,N,f),y.pack(f,q,A)}}}}}(n),function(e){var n=e.techniques;for(var t in n)if(n.hasOwnProperty(t)){var r=n[t],i=r.passes;if(h(i)){var s=d(r.pass,"defaultPass");if(i.hasOwnProperty(s)){var a=i[s],o=a.instanceProgram;r.attributes=d(r.attributes,o.attributes),r.program=d(r.program,o.program),r.uniforms=d(r.uniforms,o.uniforms),r.states=d(r.states,a.states)}delete r.passes,delete r.pass}}}(n),h(n.allExtensions)&&(n.extensionsUsed=n.allExtensions,delete n.allExtensions);if(h(n.lights)){var i=d(n.extensions,{});n.extensions=i;var a=d(i.KHR_materials_common,{});i.KHR_materials_common=a,a.lights=n.lights,delete n.lights,e(n,"KHR_materials_common")}},"1.0":function(e){e.asset=d(e.asset,{}),e.asset.version="2.0",w(e),function(e){var n=e.animations;for(var t in n)if(n.hasOwnProperty(t)){var r=n[t],i=r.parameters;if(h(i)){var s=r.samplers;for(var a in s)if(s.hasOwnProperty(a)){var o=s[a];o.input=i[o.input],o.output=i[o.output]}delete r.parameters}}}(e),function(e){r.node(e,function(n,t){V(n)&&function e(n,t){r.scene(n,function(e){var n=e.nodes;if(h(n))for(var r=n.length,i=r;i>=0;--i)if(n[i]===t)return void n.splice(i,1)}),r.node(n,function(r,i){if(h(r.children)){var s=r.children.indexOf(t);s>-1&&(r.children.splice(s,1),V(r)&&e(n,i))}}),delete n.nodes[t]}(e,t)})}(e),function(e){var t,i,s={accessors:{},animations:{},buffers:{},bufferViews:{},cameras:{},images:{},materials:{},meshes:{},nodes:{},programs:{},samplers:{},scenes:{},shaders:{},skins:{},textures:{},techniques:{}},a={},o=e.nodes;for(var f in o)o.hasOwnProperty(f)&&(i=o[f].jointName,h(i)&&(a[i]=f));for(var u in e)if(e.hasOwnProperty(u)&&h(s[u])){var c={},m=e[u];e[u]=x(m,c),s[u]=c}for(i in a)a.hasOwnProperty(i)&&(a[i]=s.nodes[a[i]]);h(e.scene)&&(e.scene=s.scenes[e.scene]);r.bufferView(e,function(e){h(e.buffer)&&(e.buffer=s.buffers[e.buffer])}),r.accessor(e,function(e){h(e.bufferView)&&(e.bufferView=s.bufferViews[e.bufferView])}),r.shader(e,function(e){var n=e.extensions;if(h(n)){var t=n.KHR_binary_glTF;h(t)&&(e.bufferView=s.bufferViews[t.bufferView],delete n.KHR_binary_glTF),0===Object.keys(n).length&&delete e.extensions}}),r.program(e,function(e){h(e.vertexShader)&&(e.vertexShader=s.shaders[e.vertexShader]),h(e.fragmentShader)&&(e.fragmentShader=s.shaders[e.fragmentShader])}),r.technique(e,function(e){h(e.program)&&(e.program=s.programs[e.program]),r.techniqueParameter(e,function(e){h(e.node)&&(e.node=s.nodes[e.node]);var n=e.value;"string"==typeof n&&(e.value={index:s.textures[n]})})}),r.mesh(e,function(e){r.meshPrimitive(e,function(e){h(e.indices)&&(e.indices=s.accessors[e.indices]),r.meshPrimitiveAttribute(e,function(n,t){e.attributes[t]=s.accessors[n]}),h(e.material)&&(e.material=s.materials[e.material])})}),r.node(e,function(r){var i=r.children;if(h(i)){var a=i.length;for(t=0;t<a;++t)i[t]=s.nodes[i[t]]}if(h(r.meshes)){var o=r.meshes,f=o.length;if(f>0)for(r.mesh=s.meshes[o[0]],t=1;t<f;++t){var u={mesh:s.meshes[o[t]]},c=n(e.nodes,u);h(i)||(i=[],r.children=i),i.push(c)}delete r.meshes}if(h(r.camera)&&(r.camera=s.cameras[r.camera]),h(r.skin)&&(r.skin=s.skins[r.skin]),h(r.skeletons)){var m=r.skeletons,l=m.length;if(l>0&&h(r.skin)){var v=e.skins[r.skin];v.skeleton=s.nodes[m[0]]}delete r.skeletons}h(r.jointName)&&delete r.jointName}),r.skin(e,function(e){h(e.inverseBindMatrices)&&(e.inverseBindMatrices=s.accessors[e.inverseBindMatrices]);var n=e.jointNames;if(h(n)){var r=[],i=n.length;for(t=0;t<i;++t)r[t]=a[n[t]];e.joints=r,delete e.jointNames}}),r.scene(e,function(e){var n=e.nodes;if(h(n)){var r=n.length;for(t=0;t<r;++t)n[t]=s.nodes[n[t]]}}),r.animation(e,function(e){var n={};e.samplers=x(e.samplers,n),r.animationSampler(e,function(e){e.input=s.accessors[e.input],e.output=s.accessors[e.output]}),r.animationChannel(e,function(e){e.sampler=n[e.sampler];var t=e.target;h(t)&&(t.node=s.nodes[t.id],delete t.id)})}),r.material(e,function(e){h(e.technique)&&(e.technique=s.techniques[e.technique]),r.materialValue(e,function(n,t){"string"==typeof n&&(e.values[t]={index:s.textures[n]})});var n=e.extensions;if(h(n)){var t=n.KHR_materials_common;h(t)&&r.materialValue(t,function(e,n){"string"==typeof e&&(t.values[n]={index:s.textures[e]})})}}),r.image(e,function(e){var n=e.extensions;if(h(n)){var t=n.KHR_binary_glTF;h(t)&&(e.bufferView=s.bufferViews[t.bufferView],e.mimeType=t.mimeType,delete n.KHR_binary_glTF),0===Object.keys(n).length&&delete e.extensions}r.compressedImage(e,function(e){var t=e.extensions;if(h(t)){var r=t.KHR_binary_glTF;h(r)&&(e.bufferView=s.bufferViews[r.bufferView],e.mimeType=r.mimeType,delete t.KHR_binary_glTF),0===Object.keys(n).length&&delete e.extensions}})}),r.texture(e,function(e){h(e.sampler)&&(e.sampler=s.samplers[e.sampler]),h(e.source)&&(e.source=s.images[e.source])})}(e),function(e){r.animation(e,function(e){r.animationSampler(e,function(e){delete e.name})})}(e),function(e){var n=e.asset;delete n.profile,delete n.premultipliedAlpha}(e),function(e){var n=e.extensionsUsed;if(e.extensionsRequired=d(e.extensionsRequired,[]),h(n))for(var t=n.length,r=0;r<t;++r){var i=n[r];h(T[i])&&e.extensionsRequired.push(i)}}(e),function(e){r.buffer(e,function(e){h(e.byteLength)||(e.byteLength=e.extras._pipeline.source.length)}),r.accessor(e,function(n){var t=n.bufferView;if(h(t)){var r=e.bufferViews[t],i=C(e,n),s=n.byteOffset+n.count*i;r.byteLength=Math.max(d(r.byteLength,0),s)}})}(e),function(e){var t,i,s,a=e.bufferViews,o={};r.accessorContainingVertexAttributeData(e,function(n){var t=e.accessors[n];h(t.bufferView)&&(o[t.bufferView]=!0)});var u={};for(var c in r.accessor(e,function(e){h(e.bufferView)&&(u[e.bufferView]=d(u[e.bufferView],[]),u[e.bufferView].push(e))}),u)if(u.hasOwnProperty(c)){s=a[c];var m=u[c];m.sort(function(e,n){return e.byteOffset-n.byteOffset});var v=0,p=0,b=m.length;for(t=0;t<b;++t){var y=m[t],O=C(e,y),g=y.byteOffset,w=y.count*O;delete y.byteStride;var x=t<b-1,T=x?C(e,m[t+1]):void 0;if(O!==T){var R=l(s,!0);o[c]&&(R.byteStride=O),R.byteOffset+=v,R.byteLength=g+w-v;var _=n(a,R);for(i=p;i<=t;++i)(y=m[i]).bufferView=_,y.byteOffset=y.byteOffset-v;v=x?m[t+1].byteOffset:void 0,p=t+1}}}f(e)}(e),function(e){r.accessorWithSemantic(e,"POSITION",function(n){var r=e.accessors[n];if(!h(r.min)||!h(r.max)){var i=t(e,r);r.min=i.min,r.max=i.max}})}(e),function(e){r.animation(e,function(n){r.animationSampler(n,function(n){var r=e.accessors[n.input];if(!h(r.min)||!h(r.max)){var i=t(e,r);r.min=i.min,r.max=i.max}})})}(e),function(e){r.buffer(e,function(e){delete e.type})}(e),function(e){r.texture(e,function(e){delete e.format,delete e.internalFormat,delete e.target,delete e.type})}(e),function(e){r.mesh(e,function(e){r.meshPrimitive(e,function(e){r.meshPrimitiveAttribute(e,function(n,t){"TEXCOORD"===t?e.attributes.TEXCOORD_0=n:"COLOR"===t&&(e.attributes.COLOR_0=n)}),delete e.attributes.TEXCOORD,delete e.attributes.COLOR})}),r.technique(e,function(e){r.techniqueParameter(e,function(e){var n=e.semantic;h(n)&&("TEXCOORD"===n?e.semantic="TEXCOORD_0":"COLOR"===n&&(e.semantic="COLOR_0"))})})}(e),function(e){var n={};r.mesh(e,function(e){r.meshPrimitive(e,function(e){for(var t in r.meshPrimitiveAttribute(e,function(e,t){if("_"!==t.charAt(0)){var r,i=t.search(/_[0-9]+/g),s=t,a="_0";i>=0&&(s=t.substring(0,i),a=t.substring(i));var o=_[s];h(o)?(r=o+a,n[t]=r):h(R[s])||(r="_"+t,n[t]=r)}}),n)if(n.hasOwnProperty(t)){var i=n[t],s=e.attributes[t];h(s)&&(delete e.attributes[t],e.attributes[i]=s)}})}),r.technique(e,function(e){r.techniqueParameter(e,function(e){var t=n[e.semantic];h(t)&&(e.semantic=t)})})}(e),u(e),function(e){r.camera(e,function(e){var n=e.perspective;if(h(n)){var t=n.aspectRatio;h(t)&&0===t&&delete n.aspectRatio;var r=n.yfov;h(r)&&0===r&&(n.yfov=1)}})}(e),a(e),o(e),function(e){for(var n in e)if(e.hasOwnProperty(n)){var t=e[n];p(t)&&0===t.length&&delete e[n]}r.node(e,function(e){h(e.children)&&0===e.children.length&&delete e.children})}(e)},"2.0":void 0};function w(e){var n=e.materials;for(var t in n)if(n.hasOwnProperty(t)){var r=n[t],i=r.instanceTechnique;h(i)&&(r.technique=i.technique,r.values=i.values,delete r.instanceTechnique)}}function x(e,n){var t=[];for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];n[r]=t.length,t.push(i),h(i.name)||(i.name=r)}return t}var T={PGEARTH_RTC:!0,KHR_materials_common:!0,WEB3D_quantized_attributes:!0};var R={POSITION:!0,NORMAL:!0,TANGENT:!0},_={COLOR:"COLOR",JOINT:"JOINTS",JOINTS:"JOINTS",TEXCOORD:"TEXCOORD",WEIGHT:"WEIGHTS",WEIGHTS:"WEIGHTS"};function C(e,n){return h(n.byteStride)&&0!==n.byteStride?n.byteStride:i(e,n)}function V(e){return(!h(e.children)||0===e.children.length)&&(!h(e.meshes)||0===e.meshes.length)&&!h(e.camera)&&!h(e.skin)&&!h(e.skeletons)&&!h(e.jointName)&&(!h(e.translation)||c.fromArray(e.translation).equals(c.ZERO))&&(!h(e.scale)||c.fromArray(e.scale).equals(new c(1,1,1)))&&(!h(e.rotation)||m.fromArray(e.rotation).equals(new m(0,0,0,1)))&&(!h(e.matrix)||b.fromColumnMajorArray(e.matrix).equals(b.IDENTITY))&&!h(e.extensions)&&!h(e.extras)}return function(e,n){var t=(n=d(n,d.EMPTY_OBJECT)).targetVersion,r=e.version;e.asset=d(e.asset,{version:"1.0"}),e.asset.version=d(e.asset.version,"1.0"),r=d(r,e.asset.version).toString(),g.hasOwnProperty(r)||(h(r)&&(r=r.substring(0,3)),g.hasOwnProperty(r)||(r="1.0"));for(var i=g[r];h(i)&&r!==t;)i(e,n),r=e.asset.version,i=g[r];return e}});