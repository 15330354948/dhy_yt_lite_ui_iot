define(["../Core/BoundingSphere","../Core/buildModuleUrl","../Core/Cartesian3","../Core/Cartographic","../Core/defaultValue","../Core/defined","../Core/defineProperties","../Core/destroyObject","../Core/DeveloperError","../Core/Ellipsoid","../Core/EllipsoidTerrainProvider","../Core/Event","../Core/IntersectionTests","../Core/Ray","../Core/Rectangle","../Core/Resource","../Renderer/ShaderSource","../Renderer/Texture","../Shaders/GlobeFS","../Shaders/GlobeVS","../Shaders/GroundAtmosphere","../ThirdParty/when","./GlobeSurfaceShaderSet","./GlobeSurfaceTileProvider","./ImageryLayerCollection","./QuadtreePrimitive","./SceneMode","./ShadowMode","./TileSelectionResult"],function(e,t,r,i,a,o,s,n,h,c,l,d,u,p,g,m,f,_,S,v,y,C,P,w,M,N,E,D,L){"use strict";function R(e){e=a(e,c.WGS84);var r=new l({ellipsoid:e}),i=new M;this._ellipsoid=e,this._imageryLayerCollection=i,this._surfaceShaderSet=new P,this._material=void 0,this._surface=new N({tileProvider:new w({terrainProvider:r,imageryLayers:i,surfaceShaderSet:this._surfaceShaderSet})}),this._terrainProvider=r,this._terrainProviderChanged=new d,b(this),this.show=!0,this._oceanNormalMapResourceDirty=!0,this._oceanNormalMapResource=new m({url:t("Assets/Textures/waterNormalsSmall.jpg")}),this.maximumScreenSpaceError=2,this.tileCacheSize=100,this.loadingDescendantLimit=20,this.preloadAncestors=!0,this.preloadSiblings=!1,this.fillHighlightColor=void 0,this.enableLighting=!1,this.showGroundAtmosphere=!0,this.lightingFadeOutDistance=1e7,this.lightingFadeInDistance=2e7,this.nightFadeOutDistance=1e7,this.nightFadeInDistance=5e7,this.showWaterEffect=!0,this.depthTestAgainstTerrain=!1,this.shadows=D.RECEIVE_ONLY,this.atmosphereHueShift=0,this.atmosphereSaturationShift=0,this.atmosphereBrightnessShift=0,this._oceanNormalMap=void 0,this._zoomedOutOceanSpecularIntensity=void 0}function b(e){var t=[],r=o(e._material)&&(e._material.shaderSource.match(/slope/)||e._material.shaderSource.match("normalEC")),i=[y];!o(e._material)||r&&!e._terrainProvider.requestVertexNormals?e._surface._tileProvider.uniformMap=void 0:(i.push(e._material.shaderSource),t.push("APPLY_MATERIAL"),e._surface._tileProvider.uniformMap=e._material._uniforms),i.push(S),e._surfaceShaderSet.baseVertexShaderSource=new f({sources:[y,v],defines:t}),e._surfaceShaderSet.baseFragmentShaderSource=new f({sources:i,defines:t}),e._surfaceShaderSet.material=e._material}s(R.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},imageryLayers:{get:function(){return this._imageryLayerCollection}},imageryLayersUpdatedEvent:{get:function(){return this._surface.tileProvider.imageryLayersUpdatedEvent}},tilesLoaded:{get:function(){return!o(this._surface)||this._surface.tileProvider.ready&&0===this._surface._tileLoadQueueHigh.length&&0===this._surface._tileLoadQueueMedium.length&&0===this._surface._tileLoadQueueLow.length}},baseColor:{get:function(){return this._surface.tileProvider.baseColor},set:function(e){this._surface.tileProvider.baseColor=e}},clippingPlanes:{get:function(){return this._surface.tileProvider.clippingPlanes},set:function(e){this._surface.tileProvider.clippingPlanes=e}},cartographicLimitRectangle:{get:function(){return this._surface.tileProvider.cartographicLimitRectangle},set:function(e){o(e)||(e=g.clone(g.MAX_VALUE)),this._surface.tileProvider.cartographicLimitRectangle=e}},oceanNormalMapUrl:{get:function(){return this._oceanNormalMapResource.url},set:function(e){this._oceanNormalMapResource.url=e,this._oceanNormalMapResourceDirty=!0}},terrainProvider:{get:function(){return this._terrainProvider},set:function(e){e!==this._terrainProvider&&(this._terrainProvider=e,this._terrainProviderChanged.raiseEvent(e),o(this._material)&&b(this))}},terrainProviderChanged:{get:function(){return this._terrainProviderChanged}},tileLoadProgressEvent:{get:function(){return this._surface.tileLoadProgressEvent}},material:{get:function(){return this._material},set:function(e){this._material!==e&&(this._material=e,b(this))}}});var F=[],I={start:0,stop:0};R.prototype.pickWorldCoordinates=function(t,i,a){if(!o(t))throw new h("ray is required");if(!o(i))throw new h("scene is required");var s=i.mode,n=i.mapProjection,c=F;c.length=0;var l,d,p,g,m=this._surface._tilesToRender,f=m.length;for(d=0;d<f;++d){var _=(l=m[d]).data;if(o(_)){var S=_.pickBoundingSphere;if(s!==E.SCENE3D)_.pickBoundingSphere=S=e.fromRectangleWithHeights2D(l.rectangle,n,_.tileBoundingRegion.minimumHeight,_.tileBoundingRegion.maximumHeight,S),r.fromElements(S.center.z,S.center.x,S.center.y,S.center);else{if(!o(_.renderedMesh))continue;e.clone(_.renderedMesh.boundingSphere3D,S)}var v=u.raySphere(t,S,I);o(v)&&c.push(_)}}for(c.sort((p=t.origin,function(t,r){return e.distanceSquaredTo(t.pickBoundingSphere,p)-e.distanceSquaredTo(r.pickBoundingSphere,p)})),f=c.length,d=0;d<f&&(g=c[d].pick(t,i.mode,i.mapProjection,!0,a),!o(g));++d);return g};var O=new i;R.prototype.pick=function(e,t,i){if(i=this.pickWorldCoordinates(e,t,i),o(i)&&t.mode!==E.SCENE3D){i=r.fromElements(i.y,i.z,i.x,i);var a=t.mapProjection.unproject(i,O);i=t.globe.ellipsoid.cartographicToCartesian(a,i)}return i};var A=new r,T=new r,x=new i,k=new p;function H(e,t){return g.contains(e.rectangle,t)?e:void 0}return R.prototype.getHeight=function(e){if(!o(e))throw new h("cartographic is required");var t=this._surface._levelZeroTiles;if(o(t)){var i,s,n=t.length;for(s=0;s<n&&(i=t[s],!g.contains(i.rectangle,e));++s);if(!(s>=n)){for(;i._lastSelectionResult===L.REFINED;)i=H(i.southwestChild,e)||H(i.southeastChild,e)||H(i.northwestChild,e)||i.northeastChild;if(o(i.data)&&o(i.data.renderedMesh)){var c=this._surface._tileProvider.tilingScheme.ellipsoid,l=r.fromRadians(e.longitude,e.latitude,0,c,A),d=k,u=c.geodeticSurfaceNormal(l,d.direction),p=c.getSurfaceNormalIntersectionWithZAxis(l,11500,d.origin);if(!o(p)){var m=Math.min(a(i.data.minimumHeight,0),-11500),f=r.multiplyByScalar(u,Math.abs(m)+1,T);r.subtract(l,f,d.origin)}var _=i.data.pick(d,void 0,void 0,!1,T);if(o(_))return c.cartesianToCartographic(_,x).height}}}},R.prototype.update=function(e){this.show&&e.passes.render&&this._surface.update(e)},R.prototype.beginFrame=function(e){var t=this._surface,r=t.tileProvider,i=this.terrainProvider,a=this.showWaterEffect&&i.ready&&i.hasWaterMask;if(a&&this._oceanNormalMapResourceDirty){this._oceanNormalMapResourceDirty=!1;var s=this._oceanNormalMapResource,n=s.url;if(o(n)){var h=this;C(s.fetchImage(),function(t){n===h._oceanNormalMapResource.url&&(h._oceanNormalMap=h._oceanNormalMap&&h._oceanNormalMap.destroy(),h._oceanNormalMap=new _({context:e.context,source:t}))})}else this._oceanNormalMap=this._oceanNormalMap&&this._oceanNormalMap.destroy()}var c=e.passes,l=e.mode;c.render&&(this.showGroundAtmosphere?this._zoomedOutOceanSpecularIntensity=.4:this._zoomedOutOceanSpecularIntensity=.5,t.maximumScreenSpaceError=this.maximumScreenSpaceError,t.tileCacheSize=this.tileCacheSize,t.loadingDescendantLimit=this.loadingDescendantLimit,t.preloadAncestors=this.preloadAncestors,t.preloadSiblings=this.preloadSiblings,r.terrainProvider=this.terrainProvider,r.lightingFadeOutDistance=this.lightingFadeOutDistance,r.lightingFadeInDistance=this.lightingFadeInDistance,r.nightFadeOutDistance=this.nightFadeOutDistance,r.nightFadeInDistance=this.nightFadeInDistance,r.zoomedOutOceanSpecularIntensity=l===E.SCENE3D?this._zoomedOutOceanSpecularIntensity:0,r.hasWaterMask=a,r.oceanNormalMap=this._oceanNormalMap,r.enableLighting=this.enableLighting,r.showGroundAtmosphere=this.showGroundAtmosphere,r.shadows=this.shadows,r.hueShift=this.atmosphereHueShift,r.saturationShift=this.atmosphereSaturationShift,r.brightnessShift=this.atmosphereBrightnessShift,r.fillHighlightColor=this.fillHighlightColor,t.beginFrame(e))},R.prototype.render=function(e){this.show&&(o(this._material)&&this._material.update(e.context),this._surface.render(e))},R.prototype.endFrame=function(e){this.show&&e.passes.render&&this._surface.endFrame(e)},R.prototype.isDestroyed=function(){return!1},R.prototype.destroy=function(){return this._surfaceShaderSet=this._surfaceShaderSet&&this._surfaceShaderSet.destroy(),this._surface=this._surface&&this._surface.destroy(),this._oceanNormalMap=this._oceanNormalMap&&this._oceanNormalMap.destroy(),n(this)},R});