define(["../Core/AssociativeArray","../Core/BoundingSphere","../Core/Cartesian2","../Core/Color","../Core/defined","../Core/destroyObject","../Core/DeveloperError","../Core/Matrix4","../Core/Resource","../Scene/ColorBlendMode","../Scene/HeightReference","../Scene/Model","../Scene/ModelAnimationLoop","../Scene/ShadowMode","./BoundingSphereState","./Property"],function(e,i,t,o,r,n,l,a,s,d,u,h,c,m,f,g){"use strict";var _=m.ENABLED,p=u.NONE,v=o.RED,C=o.WHITE,y=d.HIGHLIGHT,D=new t(1,1),O=new a,V=new a;function w(i,t){if(!r(i))throw new l("scene is required.");if(!r(t))throw new l("entityCollection is required.");t.collectionChanged.addEventListener(w.prototype._onCollectionChanged,this),this._scene=i,this._primitives=i.primitives,this._entityCollection=t,this._modelHash={},this._entitiesToVisualize=new e,this._onCollectionChanged(t,t.values,[],[])}function S(e,i,t,o){var n=t[i.id];r(n)&&(o.removeAndDestroy(n.modelPrimitive),delete t[i.id])}function A(e,i){var t=i[e.id];r(t)&&(t.nodeTransformationsScratch={})}function M(e,i,t){e.readyPromise.otherwise(function(e){console.error(e),t[i.id].loadFail=!0})}return w.prototype.update=function(e){if(!r(e))throw new l("time is required.");for(var i=this._entitiesToVisualize.values,t=this._modelHash,o=this._primitives,n=0,d=i.length;n<d;n++){var u,m,f=i[n],w=f._model,S=t[f.id],A=f.isShowing&&f.isAvailable(e)&&g.getValueOrDefault(w._show,e,!0);if(A&&(m=f.computeModelMatrix(e,O),u=s.createIfNeeded(g.getValueOrUndefined(w._uri,e)),A=r(m)&&r(u)),A){var E=r(S)?S.modelPrimitive:void 0;if(r(E)&&u.url===S.url||(r(E)&&(o.removeAndDestroy(E),delete t[f.id]),(E=h.fromGltf({url:u,incrementallyLoadTextures:g.getValueOrDefault(w._incrementallyLoadTextures,e,!0),scene:this._scene})).id=f,o.add(E),S={modelPrimitive:E,url:u.url,animationsRunning:!1,nodeTransformationsScratch:{},loadFail:!1},t[f.id]=S,M(E,f,t)),E.show=!0,E.scale=g.getValueOrDefault(w._scale,e,1),E.minimumPixelSize=g.getValueOrDefault(w._minimumPixelSize,e,0),E.maximumScale=g.getValueOrUndefined(w._maximumScale,e),E.modelMatrix=a.clone(m,E.modelMatrix),E.shadows=g.getValueOrDefault(w._shadows,e,_),E.heightReference=g.getValueOrDefault(w._heightReference,e,p),E.distanceDisplayCondition=g.getValueOrUndefined(w._distanceDisplayCondition,e),E.silhouetteColor=g.getValueOrDefault(w._silhouetteColor,e,v,E._silhouetteColor),E.silhouetteSize=g.getValueOrDefault(w._silhouetteSize,e,0),E.color=g.getValueOrDefault(w._color,e,C,E._color),E.colorBlendMode=g.getValueOrDefault(w._colorBlendMode,e,y),E.colorBlendAmount=g.getValueOrDefault(w._colorBlendAmount,e,.5),E.clippingPlanes=g.getValueOrUndefined(w._clippingPlanes,e),E.clampAnimations=g.getValueOrDefault(w._clampAnimations,e,!0),E.imageBasedLightingFactor=g.getValueOrDefault(w._imageBasedLightingFactor,e,D),E.lightColor=g.getValueOrUndefined(w._lightColor,e),E.ready){var x=g.getValueOrDefault(w._runAnimations,e,!0);S.animationsRunning!==x&&(x?E.activeAnimations.addAll({loop:c.REPEAT}):E.activeAnimations.removeAll(),S.animationsRunning=x);var P=g.getValueOrUndefined(w._nodeTransformations,e,S.nodeTransformationsScratch);if(r(P))for(var T=Object.keys(P),N=0,B=T.length;N<B;++N){var L=T[N],R=P[L];if(r(R)){var H=E.getNode(L);if(r(H)){var z=a.fromTranslationRotationScale(R,V);H.matrix=a.multiply(H.originalMatrix,z,z)}}}}}else r(S)&&(S.modelPrimitive.show=!1)}return!0},w.prototype.isDestroyed=function(){return!1},w.prototype.destroy=function(){this._entityCollection.collectionChanged.removeEventListener(w.prototype._onCollectionChanged,this);for(var e=this._entitiesToVisualize.values,i=this._modelHash,t=this._primitives,o=e.length-1;o>-1;o--)S(this,e[o],i,t);return n(this)},w.prototype.getBoundingSphere=function(e,t){if(!r(e))throw new l("entity is required.");if(!r(t))throw new l("result is required.");var o=this._modelHash[e.id];if(!r(o)||o.loadFail)return f.FAILED;var n=o.modelPrimitive;if(!r(n)||!n.show)return f.FAILED;if(!n.ready)return f.PENDING;if(n.heightReference===u.NONE)i.transform(n.boundingSphere,n.modelMatrix,t);else{if(!r(n._clampedModelMatrix))return f.PENDING;i.transform(n.boundingSphere,n._clampedModelMatrix,t)}return f.DONE},w.prototype._onCollectionChanged=function(e,i,t,o){var n,l,a=this._entitiesToVisualize,s=this._modelHash,d=this._primitives;for(n=i.length-1;n>-1;n--)l=i[n],r(l._model)&&r(l._position)&&a.set(l.id,l);for(n=o.length-1;n>-1;n--)l=o[n],r(l._model)&&r(l._position)?(A(l,s),a.set(l.id,l)):(S(this,l,s,d),a.remove(l.id));for(n=t.length-1;n>-1;n--)S(this,l=t[n],s,d),a.remove(l.id)},w});