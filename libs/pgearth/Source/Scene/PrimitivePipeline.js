define(["../Core/BoundingSphere","../Core/ComponentDatatype","../Core/defaultValue","../Core/defined","../Core/DeveloperError","../Core/Ellipsoid","../Core/FeatureDetection","../Core/GeographicProjection","../Core/Geometry","../Core/GeometryAttribute","../Core/GeometryAttributes","../Core/GeometryPipeline","../Core/IndexDatatype","../Core/Matrix4","../Core/OffsetGeometryInstanceAttribute","../Core/WebMercatorProjection"],function(e,t,r,n,o,i,a,s,c,p,u,f,m,h,d,l){"use strict";if(!a.supportsTypedArrays())return{};function g(e,r){var n=e.attributes,o=n.position,i=o.values.length/o.componentsPerAttribute;n.batchId=new p({componentDatatype:t.FLOAT,componentsPerAttribute:1,values:new Float32Array(i)});for(var a=n.batchId.values,s=0;s<i;++s)a[s]=r}function v(r){var i,a,s,c=r.instances,p=r.projection,u=r.elementIndexUintSupported,m=r.scene3DOnly,d=r.vertexCacheOptimize,l=r.compressVertices,v=r.modelMatrix,y=c.length;for(i=0;i<y;++i)if(n(c[i].geometry)){s=c[i].geometry.primitiveType;break}for(i=1;i<y;++i)if(n(c[i].geometry)&&c[i].geometry.primitiveType!==s)throw new o("All instance geometries must have the same primitiveType.");if(function(e,t,r){var o,i=!r,a=e.length;if(!i&&a>1){var s=e[0].modelMatrix;for(o=1;o<a;++o)if(!h.equals(s,e[o].modelMatrix)){i=!0;break}}if(i)for(o=0;o<a;++o)n(e[o].geometry)&&f.transformToWorldCoordinates(e[o]);else h.multiplyTransformation(t,e[0].modelMatrix,t)}(c,v,m),!m)for(i=0;i<y;++i)n(c[i].geometry)&&f.splitLongitude(c[i]);if(function(e){for(var t=e.length,r=0;r<t;++r){var o=e[r];n(o.geometry)?g(o.geometry,r):n(o.westHemisphereGeometry)&&n(o.eastHemisphereGeometry)&&(g(o.westHemisphereGeometry,r),g(o.eastHemisphereGeometry,r))}}(c),d)for(i=0;i<y;++i){var b=c[i];n(b.geometry)?(f.reorderForPostVertexCache(b.geometry),f.reorderForPreVertexCache(b.geometry)):n(b.westHemisphereGeometry)&&n(b.eastHemisphereGeometry)&&(f.reorderForPostVertexCache(b.westHemisphereGeometry),f.reorderForPreVertexCache(b.westHemisphereGeometry),f.reorderForPostVertexCache(b.eastHemisphereGeometry),f.reorderForPreVertexCache(b.eastHemisphereGeometry))}var C=f.combineInstances(c);for(y=C.length,i=0;i<y;++i){var k,x=(a=C[i]).attributes;if(m)for(k in x)x.hasOwnProperty(k)&&x[k].componentDatatype===t.DOUBLE&&f.encodeAttribute(a,k,k+"3DHigh",k+"3DLow");else for(k in x)if(x.hasOwnProperty(k)&&x[k].componentDatatype===t.DOUBLE){var S=k+"3D",w=k+"2D";f.projectTo2D(a,k,S,w,p),n(a.boundingSphere)&&"position"===k&&(a.boundingSphereCV=e.fromVertices(a.attributes.position2D.values)),f.encodeAttribute(a,S,S+"High",S+"Low"),f.encodeAttribute(a,w,w+"High",w+"Low")}l&&f.compressVertices(a)}if(!u){var G=[];for(y=C.length,i=0;i<y;++i)a=C[i],G=G.concat(f.fitToUnsignedShortIndices(a));C=G}return C}function y(e,t,r,o){var i,a,s,c=o.length-1;if(c>=0){var p=o[c];i=p.offset+p.count,a=r[s=p.index].indices.length}else i=0,a=r[s=0].indices.length;for(var u=e.length,f=0;f<u;++f){var m=e[f][t];if(n(m)){var h=m.indices.length;i+h>a&&(i=0,a=r[++s].indices.length),o.push({index:s,offset:i,count:h}),i+=h}}}var b={};function C(e,t){var r=e.attributes;for(var o in r)if(r.hasOwnProperty(o)){var i=r[o];n(i)&&n(i.values)&&t.push(i.values.buffer)}n(e.indices)&&t.push(e.indices.buffer)}function k(t){var r=t.length,o=1+(e.packedLength+1)*r,i=new Float32Array(o),a=0;i[a++]=r;for(var s=0;s<r;++s){var c=t[s];n(c)?(i[a++]=1,e.pack(t[s],i,a)):i[a++]=0,a+=e.packedLength}return i}function x(t){for(var r=new Array(t[0]),n=0,o=1;o<t.length;)1===t[o++]&&(r[n]=e.unpack(t,o)),++n,o+=e.packedLength;return r}return b.combineGeometry=function(t){var r,o,i,a,s=t.instances,c=s.length,p=!1;c>0&&((r=v(t)).length>0&&(o=f.createAttributeLocations(r[0]),t.createPickOffsets&&(i=function(e,t){var r=[];return y(e,"geometry",t,r),y(e,"westHemisphereGeometry",t,r),y(e,"eastHemisphereGeometry",t,r),r}(s,r))),n(s[0].attributes)&&n(s[0].attributes.offset)&&(a=new Array(c),p=!0));for(var u=new Array(c),m=new Array(c),h=0;h<c;++h){var d=s[h],l=d.geometry;n(l)&&(u[h]=l.boundingSphere,m[h]=l.boundingSphereCV,p&&(a[h]=d.geometry.offsetAttribute));var g=d.eastHemisphereGeometry,b=d.westHemisphereGeometry;n(g)&&n(b)&&(n(g.boundingSphere)&&n(b.boundingSphere)&&(u[h]=e.union(g.boundingSphere,b.boundingSphere)),n(g.boundingSphereCV)&&n(b.boundingSphereCV)&&(m[h]=e.union(g.boundingSphereCV,b.boundingSphereCV)))}return{geometries:r,modelMatrix:t.modelMatrix,attributeLocations:o,pickOffsets:i,offsetInstanceExtend:a,boundingSpheres:u,boundingSpheresCV:m}},b.packCreateGeometryResults=function(t,o){var i=new Float64Array(function(t){for(var r=1,o=t.length,i=0;i<o;i++){var a=t[i];if(++r,n(a)){var s=a.attributes;for(var c in r+=7+2*e.packedLength+(n(a.indices)?a.indices.length:0),s)s.hasOwnProperty(c)&&n(s[c])&&(r+=5+s[c].values.length)}}return r}(t)),a=[],s={},c=t.length,p=0;i[p++]=c;for(var u=0;u<c;u++){var f=t[u],m=n(f);if(i[p++]=m?1:0,m){i[p++]=f.primitiveType,i[p++]=f.geometryType,i[p++]=r(f.offsetAttribute,-1);var h=n(f.boundingSphere)?1:0;i[p++]=h,h&&e.pack(f.boundingSphere,i,p),p+=e.packedLength;var d=n(f.boundingSphereCV)?1:0;i[p++]=d,d&&e.pack(f.boundingSphereCV,i,p),p+=e.packedLength;var l=f.attributes,g=[];for(var v in l)l.hasOwnProperty(v)&&n(l[v])&&(g.push(v),n(s[v])||(s[v]=a.length,a.push(v)));i[p++]=g.length;for(var y=0;y<g.length;y++){var b=g[y],C=l[b];i[p++]=s[b],i[p++]=C.componentDatatype,i[p++]=C.componentsPerAttribute,i[p++]=C.normalize?1:0,i[p++]=C.values.length,i.set(C.values,p),p+=C.values.length}var k=n(f.indices)?f.indices.length:0;i[p++]=k,k>0&&(i.set(f.indices,p),p+=k)}}return o.push(i.buffer),{stringTable:a,packedData:i}},b.unpackCreateGeometryResults=function(r){for(var n,o=r.stringTable,i=r.packedData,a=new Array(i[0]),s=0,f=1;f<i.length;){if(1===i[f++]){var h,d,l,g,v,y=i[f++],b=i[f++],C=i[f++];-1===C&&(C=void 0),1===i[f++]&&(h=e.unpack(i,f)),f+=e.packedLength,1===i[f++]&&(d=e.unpack(i,f)),f+=e.packedLength;var k,x=new u,S=i[f++];for(n=0;n<S;n++){var w=o[i[f++]],G=i[f++];v=i[f++];var A=0!==i[f++];l=i[f++],g=t.createTypedArray(G,l);for(var O=0;O<l;O++)g[O]=i[f++];x[w]=new p({componentDatatype:G,componentsPerAttribute:v,normalize:A,values:g})}if((l=i[f++])>0){var V=g.length/v;for(k=m.createTypedArray(V,l),n=0;n<l;n++)k[n]=i[f++]}a[s++]=new c({primitiveType:y,geometryType:b,boundingSphere:h,boundingSphereCV:d,indices:k,attributes:x,offsetAttribute:C})}else a[s++]=void 0}return a},b.packCombineGeometryParameters=function(e,t){for(var r=e.createGeometryResults,o=r.length,i=0;i<o;i++)t.push(r[i].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:function(e,t){var r=e.length,o=new Float64Array(1+19*r),i=0;o[i++]=r;for(var a=0;a<r;a++){var s=e[a];if(h.pack(s.modelMatrix,o,i),i+=h.packedLength,n(s.attributes)&&n(s.attributes.offset)){var c=s.attributes.offset.value;o[i]=c[0],o[i+1]=c[1],o[i+2]=c[2]}i+=3}return t.push(o.buffer),o}(e.instances,t),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof s,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},b.unpackCombineGeometryParameters=function(e){for(var t=function(e){for(var t=e,r=new Array(t[0]),o=0,i=1;i<t.length;){var a,s=h.unpack(t,i);i+=h.packedLength,n(t[i])&&(a={offset:new d(t[i],t[i+1],t[i+2])}),i+=3,r[o++]={modelMatrix:s,attributes:a}}return r}(e.packedInstances),r=e.createGeometryResults,o=r.length,a=0,c=0;c<o;c++)for(var p=b.unpackCreateGeometryResults(r[c]),u=p.length,f=0;f<u;f++){var m=p[f];t[a].geometry=m,++a}var g=i.clone(e.ellipsoid);return{instances:t,ellipsoid:g,projection:e.isGeographic?new s(g):new l(g),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:h.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},b.packCombineGeometryResults=function(e,t){n(e.geometries)&&function(e,t){for(var r=e.length,n=0;n<r;++n)C(e[n],t)}(e.geometries,t);var r=k(e.boundingSpheres),o=k(e.boundingSpheresCV);return t.push(r.buffer,o.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r,boundingSpheresCV:o}},b.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:x(e.boundingSpheres),boundingSpheresCV:x(e.boundingSpheresCV)}},b});