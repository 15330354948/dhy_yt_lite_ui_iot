define(["../Core/AssociativeArray","../Core/Cartesian3","../Core/Color","../Core/ColorGeometryInstanceAttribute","../Core/defined","../Core/DistanceDisplayCondition","../Core/DistanceDisplayConditionGeometryInstanceAttribute","../Core/OffsetGeometryInstanceAttribute","../Core/ShowGeometryInstanceAttribute","../Scene/Primitive","./BoundingSphereState","./ColorMaterialProperty","./MaterialProperty","./Property"],function(t,e,i,r,s,a,o,n,h,l,p,d,u,v){"use strict";var c=new i,m=new a,y=new a,f=e.ZERO,g=new e;function C(e,i,r,a,o,n,h){var l;this.translucent=i,this.appearanceType=r,this.depthFailAppearanceType=a,this.depthFailMaterialProperty=o,this.depthFailMaterial=void 0,this.closed=n,this.shadows=h,this.primitives=e,this.createPrimitive=!1,this.waitingOnCreate=!1,this.primitive=void 0,this.oldPrimitive=void 0,this.geometry=new t,this.updaters=new t,this.updatersWithAttributes=new t,this.attributes=new t,this.subscriptions=new t,this.showsUpdated=new t,this.itemsToRemove=[],this.invalidated=!1,s(o)&&(l=o.definitionChanged.addEventListener(C.prototype.onMaterialChanged,this)),this.removeMaterialSubscription=l}function w(t,e,i,r,s){this._solidItems=[],this._translucentItems=[],this._primitives=t,this._appearanceType=e,this._depthFailAppearanceType=i,this._closed=r,this._shadows=s}function F(t,e){for(var i=t.length-1;i>=0;i--){var r=t[i];if(r.remove(e))return 0===r.updaters.length&&(t.splice(i,1),r.destroy()),!0}return!1}function P(t,e,i){for(var r=!1,s=e.length,a=0;a<s;++a){var o=e[a],n=o.itemsToRemove,h=n.length;if(h>0)for(a=0;a<h;a++){var l=n[a];o.remove(l),t.add(i,l),r=!0}}return r}function _(t,e,i,r){var s,a=e.length;for(s=a-1;s>=0;s--){var o=e[s];if(o.invalidated){e.splice(s,1);for(var n=o.updaters.values,h=n.length,l=0;l<h;l++)t.add(i,n[l]);o.destroy()}}for(a=e.length,s=0;s<a;++s)r=e[s].update(i)&&r;return r}function I(t,e,i){for(var r=t.length,s=0;s<r;s++){var a=t[s];if(a.contains(e))return a.getBoundingSphere(e,i)}return p.FAILED}function M(t){for(var e=t.length,i=0;i<e;i++)t[i].destroy();t.length=0}return C.prototype.onMaterialChanged=function(){this.invalidated=!0},C.prototype.isMaterial=function(t){var e=this.depthFailMaterialProperty,i=t.depthFailMaterialProperty;return i===e||!!s(e)&&e.equals(i)},C.prototype.add=function(t,e){var i=t.id;if(this.createPrimitive=!0,this.geometry.set(i,e),this.updaters.set(i,t),t.hasConstantFill&&t.fillMaterialProperty.isConstant&&v.isConstant(t.distanceDisplayConditionProperty)&&v.isConstant(t.terrainOffsetProperty)){var r=this;this.subscriptions.set(i,t.entity.definitionChanged.addEventListener(function(e,i,s,a){"isShowing"===i&&r.showsUpdated.set(t.id,t)}))}else this.updatersWithAttributes.set(i,t)},C.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);return s(i)&&(i(),this.subscriptions.remove(e),this.showsUpdated.remove(e)),!0}return!1},C.prototype.update=function(t){var p,C=!0,w=0,F=this.primitive,P=this.primitives;if(this.createPrimitive){var _=this.geometry.values;if(_.length>0){var I;s(F)&&(s(this.oldPrimitive)?P.remove(F):this.oldPrimitive=F),s(this.depthFailAppearanceType)&&(s(this.depthFailMaterialProperty)&&(this.depthFailMaterial=u.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial)),I=new this.depthFailAppearanceType({material:this.depthFailMaterial,translucent:this.translucent,closed:this.closed})),F=new l({show:!1,asynchronous:!0,geometryInstances:_,appearance:new this.appearanceType({translucent:this.translucent,closed:this.closed}),depthFailAppearance:I,shadows:this.shadows}),P.add(F),C=!1}else{s(F)&&(P.remove(F),F=void 0);var M=this.oldPrimitive;s(M)&&(P.remove(M),this.oldPrimitive=void 0)}this.attributes.removeAll(),this.primitive=F,this.createPrimitive=!1,this.waitingOnCreate=!0}else if(s(F)&&F.ready){F.show=!0,s(this.oldPrimitive)&&(P.remove(this.oldPrimitive),this.oldPrimitive=void 0),!s(this.depthFailAppearanceType)||this.depthFailMaterialProperty instanceof d||(this.depthFailMaterial=u.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial),this.primitive.depthFailAppearance.material=this.depthFailMaterial);var b=this.updatersWithAttributes.values,A=b.length,D=this.waitingOnCreate;for(p=0;p<A;p++){var S=b[p],T=this.geometry.get(S.id),O=this.attributes.get(T.id.id);if(s(O)||(O=F.getGeometryInstanceAttributes(T.id),this.attributes.set(T.id.id,O)),!S.fillMaterialProperty.isConstant||D){var V=S.fillMaterialProperty.color,E=v.getValueOrDefault(V,t,i.WHITE,c);i.equals(O._lastColor,E)||(O._lastColor=i.clone(E,O._lastColor),O.color=r.toValue(E,O.color),(this.translucent&&255===O.color[3]||!this.translucent&&255!==O.color[3])&&(this.itemsToRemove[w++]=S))}if(s(this.depthFailAppearanceType)&&S.depthFailMaterialProperty instanceof d&&(!S.depthFailMaterialProperty.isConstant||D)){var G=S.depthFailMaterialProperty.color,W=v.getValueOrDefault(G,t,i.WHITE,c);i.equals(O._lastDepthFailColor,W)||(O._lastDepthFailColor=i.clone(W,O._lastDepthFailColor),O.depthFailColor=r.toValue(W,O.depthFailColor))}var q=S.entity.isShowing&&(S.hasConstantFill||S.isFilled(t));q!==(1===O.show[0])&&(O.show=h.toValue(q,O.show));var L=S.distanceDisplayConditionProperty;if(!v.isConstant(L)){var R=v.getValueOrDefault(L,t,y,m);a.equals(R,O._lastDistanceDisplayCondition)||(O._lastDistanceDisplayCondition=a.clone(R,O._lastDistanceDisplayCondition),O.distanceDisplayCondition=o.toValue(R,O.distanceDisplayCondition))}var U=S.terrainOffsetProperty;if(!v.isConstant(U)){var B=v.getValueOrDefault(U,t,f,g);e.equals(B,O._lastOffset)||(O._lastOffset=e.clone(B,O._lastOffset),O.offset=n.toValue(B,O.offset))}}this.updateShows(F),this.waitingOnCreate=!1}else s(F)&&!F.ready&&(C=!1);return this.itemsToRemove.length=w,C},C.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,r=0;r<i;r++){var a=e[r],o=this.geometry.get(a.id),n=this.attributes.get(o.id.id);s(n)||(n=t.getGeometryInstanceAttributes(o.id),this.attributes.set(o.id.id,n));var l=a.entity.isShowing;l!==(1===n.show[0])&&(n.show=h.toValue(l,n.show),o.attributes.show.value[0]=n.show[0])}this.showsUpdated.removeAll()},C.prototype.contains=function(t){return this.updaters.contains(t.id)},C.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return p.PENDING;var r=i.getGeometryInstanceAttributes(t.entity);return!s(r)||!s(r.boundingSphere)||s(r.show)&&0===r.show[0]?p.FAILED:(r.boundingSphere.clone(e),p.DONE)},C.prototype.destroy=function(){var t=this.primitive,e=this.primitives;s(t)&&e.remove(t);var i=this.oldPrimitive;s(i)&&e.remove(i),s(this.removeMaterialSubscription)&&this.removeMaterialSubscription()},w.prototype.add=function(t,e){var i,r,s=e.createFillGeometryInstance(t);255===s.attributes.color.value[3]?(i=this._solidItems,r=!1):(i=this._translucentItems,r=!0);for(var a=i.length,o=0;o<a;o++){var n=i[o];if(n.isMaterial(e))return void n.add(e,s)}var h=new C(this._primitives,r,this._appearanceType,this._depthFailAppearanceType,e.depthFailMaterialProperty,this._closed,this._shadows);h.add(e,s),i.push(h)},w.prototype.remove=function(t){F(this._solidItems,t)||F(this._translucentItems,t)},w.prototype.update=function(t){var e=_(this,this._solidItems,t,!0);e=_(this,this._translucentItems,t,e)&&e;var i=P(this,this._solidItems,t),r=P(this,this._translucentItems,t);return(i||r)&&(e=_(this,this._solidItems,t,e)&&e,e=_(this,this._translucentItems,t,e)&&e),e},w.prototype.getBoundingSphere=function(t,e){var i=I(this._solidItems,t,e);return i===p.FAILED?I(this._translucentItems,t,e):i},w.prototype.removeAllPrimitives=function(){M(this._solidItems),M(this._translucentItems)},w});